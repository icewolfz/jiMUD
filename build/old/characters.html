<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>Character manager</title>
    <link rel="shortcut icon" href="../assets/icons/png/32x32.png" />
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="css/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link href="css/bootstrap-select.min.css" rel="stylesheet" type="text/css" />
    <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/form.css" rel="stylesheet" type="text/css" />
    <link href="css/characters.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            -webkit-user-select: none;
            user-select: none;
        }
    </style>
    <script>
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="../lib/jquery.min.js"></script>
    <script src="../lib/bootstrap.min.js"></script>
    <script src="../lib/bootstrap-select.min.js"></script>
    <script>
        //cSpell:ignore rgbcolor cmdfont selectpicker commandon prepend tablist tabpanel lagmeter hellip emoteto  ABCDEFGHIJKLMNOPQRSTUVWXYZ
        const { parseTemplate, templatePath, isFileSync, decrypt, encrypt } = require('./js/library');
        const Settings = require('./js/settings').Settings;
        const { shell, remote, ipcRenderer } = require('electron');
        const { dialog, Menu, MenuItem } = remote;
        const path = require('path');
        const fs = require('fs');
        const crypto = require('crypto');

        var characters, current = '';
        var charactersFile = parseTemplate(path.join("{data}", "characters.json"));
        var changed = 0;

        $(window).keydown((event) => {
            if (event.which === 27) {
                if ($("#get-name")[0].open)
                    $("#get-name")[0].close();
                else
                    window.close();
            }
        });
        $(window).on('unload', () => {
            saveCharacters();
        });

        $(document).ready(() => {
            $("#characters-list").contextmenu((event) => {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;
                var c = new Menu();
                var item = $(event.target).data('name');
                c.append(new MenuItem({
                    label: 'Add default', click: add
                }));
                c.append(new MenuItem({
                    label: 'Add empty', click: addEmpty
                }));
                if (item !== undefined) {
                    c.append(new MenuItem({ type: 'separator' }));
                    c.append(new MenuItem({
                        label: 'Rename', click: () => {
                            rename(item);
                        }
                    }));

                    c.append(new MenuItem({
                        label: 'Copy', click: () => {
                            copy(item);
                        }
                    }));
                    c.append(new MenuItem({
                        label: 'Delete', click: () => {
                            remove(item);
                        }
                    }));
                    c.append(new MenuItem({ type: 'separator' }));
                    c.append(new MenuItem({
                        label: 'Load', click: () => {
                            load(item);
                        }
                    }));
                }
                c.popup(remote.getCurrentWindow());
            });
            loadCharacters();

            $("#btn-add-dropdown").click(function () {
                $(this).addClass('open');
                var pos = $(this).offset();
                var x = Math.floor(pos.left);
                var y = Math.floor(pos.top + $(this).outerHeight() + 2);
                const addMenu = new Menu();
                addMenu.append(new MenuItem({
                    label: 'Add default', click() {
                        clearButton("#btn-add-dropdown");
                        add();
                    }
                }));
                addMenu.append(new MenuItem({
                    label: 'Add empty', click() {
                        clearButton("#btn-add-dropdown");
                        addEmpty();
                    }
                }));
                addMenu.popup(remote.getCurrentWindow(), { x: x, y: y });
            });

            $("#get-name-ok").click(function () {
                var p = $("#get-name-value").parent();
                if (!validName($('#get-name-value').val())) {
                    p.addClass("has-error");
                    p.addClass("has-feedback");
                    p.find(".form-error").html("<small class=\"aura-error\"><span class='sr-only'>Error:</span>Invalid, can only contain letters and numbers</small>");
                    $('#get-name-value').focus();
                    return;
                }
                if ($('#get-name').data('type') === 1 && $('#get-name-value').val().toLowerCase() === $('#get-name').data('name')) {
                    p.addClass("has-error");
                    p.addClass("has-feedback");
                    p.find(".form-error").html("<small class=\"aura-error\"><span class='sr-only'>Error:</span>Current name</small>");
                    $('#get-name-value').focus();
                    return;
                }
                if (characters.characters[$('#get-name-value').val().toLowerCase()]) {
                    p.addClass("has-error");
                    p.addClass("has-feedback");
                    p.find(".form-error").html("<small class=\"aura-error\"><span class='sr-only'>Error:</span>Name exists</small>");
                    $('#get-name-value').focus();
                    return;
                }

                $("#get-name").trigger('get-name-ok', [$('#get-name-value').val().toLowerCase(), $("#get-name").data("name")]);
                $("#get-name").off('get-name-ok');
                $('#get-name')[0].close();
            });

            $("#get-name-value").keypress(function (event) {
                if (event.which === 13)
                    $("#get-name-ok").click();
            });
        });

        function updateCurrent() {
            if (!current) return;
            var v = templatePath($("#settings").val());
            if (v != characters.characters[current].settings) {
                characters.characters[current].settings = v;
                changed++;
            }
            v = templatePath($("#map").val());
            if (v != characters.characters[current].map) {
                characters.characters[current].map = v;
                changed++;
            }
            if (current === characters.load) {
                if (!$("#auto-load").prop('checked')) {
                    characters.load = 0;
                    changed++;
                }
            }
            else if ($("#auto-load").prop('checked')) {
                changed++;
                characters.load = current;
            }
            v = $("#password").val() || '';
            if (v && v.length > 0) {
                var key, iv;
                if (characters.characters[current].password) {
                    key = characters.characters[current].password.split(':');
                    if (key.length === 3) {
                        iv = key[2];
                        key = key[1];
                    }
                    else {
                        key = crypto.randomBytes(16).toString('hex');
                        iv = crypto.randomBytes(16).toString('hex').slice(0, 16);
                    }
                }
                else {
                    key = crypto.randomBytes(16).toString('hex');
                    iv = crypto.randomBytes(16).toString('hex').slice(0, 16);
                }
                v = encrypt(v, key, iv) + ':' + key + ':' + iv;
            }

            if (v != characters.characters[current].password) {
                characters.characters[current].password = v;
                changed++;
            }
        }

        function saveCharacters() {
            updateCurrent();
            if (changed === 0) return;
            changed = 0;
            fs.writeFileSync(charactersFile, JSON.stringify(characters));
            ipcRenderer.send('reload-characters');
        }

        function refresh() {
            if (changed > 0) {
                dialog.showMessageBox(remote.getCurrentWindow(), {
                    type: 'warning',
                    title: 'Refresh characters',
                    message: 'All changes will be lost, refresh?',
                    buttons: ['Yes', 'No'],
                    defaultId: 1,
                }, (response) => {
                    if (response === 0)
                        loadCharacters();
                });
            }
            else
                loadCharacters();
        }

        function loadCharacters() {
            if (isFileSync(charactersFile))
                characters = fs.readFileSync(charactersFile, 'utf-8');

            if (characters && characters.length > 0) {
                try {
                    characters = JSON.parse(characters);
                    if (!characters)
                        characters = { load: 0, characters: {} };
                    if (!characters.characters)
                        characters.characters = {};
                }
                catch (e) {
                    console.log('Could not load: \'characters.json\'');
                    characters = { load: 0, characters: {} };
                }
            }
            else
                characters = { load: 0, characters: {} };
            var list = $("#characters-list");
            list.empty();
            clearEditor();
            var keys = Object.keys(characters.characters).sort();
            var key;
            for (key in keys)
                createItem(keys[key], list);
        }

        function createItem(name, list) {
            if (!list) list = $("#characters-list");
            var item = $('<li></li>', {
                id: 'character-' + name,
                class: 'list-group-item'
            }).text(name);
            item.data('name', name);
            item.on('click', function () {
                if (current === $(this).data('name')) return;
                updateCurrent();
                $('.list-group-item').removeClass('selected');
                $(this).addClass('selected');
                current = $(this).data('name');
                $("#btn-rename").prop('disabled', false);
                $("#btn-copy").prop('disabled', false);
                $("#btn-delete").prop('disabled', false);
                $("#btn-load").prop('disabled', false);
                $("#character-editor input").prop('disabled', false);
                $("#character-editor button").prop('disabled', false);
                $("#settings").val(characters.characters[current].settings);
                $("#map").val(characters.characters[current].map);
                $("#auto-load").prop('checked', current === characters.load);

                if (characters.characters[current].password && characters.characters[current].password.length > 0) {
                    var pass = characters.characters[current].password.split(':');
                    $("#password").val(decrypt(pass[0], pass[1], pass[2]));
                }
                else
                    $("#password").val('');

                $("#title").text(name);
            });
            item.on('dblclick', function () {
                $(this).click();
                load();
            });
            list.append(item);
        }


        function clearButton(id) {
            $(id).removeClass('open');
            $(id).blur();
        }

        function clearEditor() {
            current = 0;
            $("#btn-rename").prop('disabled', true);
            $("#btn-copy").prop('disabled', true);
            $("#btn-delete").prop('disabled', true);
            $("#btn-load").prop('disabled', true);
            $("#character-editor input").prop('disabled', true);
            $("#character-editor input[type=text]").val('');
            $("#character-editor input[type=checkbox]").prop('checked', false);
            $("#character-editor button").prop('disabled', true);
            $("#title").text('');
        }

        function validName(name) {
            if (!name || name.length === 0)
                return false;
            if (!name.match(/^[a-zA-Z0-9]+$/g))
                return false;
            return true;
        }

        function sortList() {
            var $list = $('#characters-list'),
                $listli = $list.children('li');

            $listli.sort(function (a, b) {
                var an = a.textContent,
                    bn = b.textContent;

                if (an > bn) {
                    return 1;
                }
                if (an < bn) {
                    return -1;
                }
                return 0;
            });

            $listli.detach().appendTo($list);
        }

        function openFile(field, ext, callback) {
            dialog.showOpenDialog(remote.getCurrentWindow(), {
                defaultPath: path.dirname(parseTemplate($(field).val())),
                filters: [
                    { name: ext[0].substr(0, 1).toUpperCase() + ext[0].substr(1) + ' (*.' + ext.join(', *.') + ')', extensions: ext },
                    { name: 'All files (*.*)', extensions: ['*'] },
                ],
                properties: ['promptToCreate']
            },
                function (fileNames) {
                    if (fileNames === undefined) {
                        return;
                    }
                    $(field).val(templatePath(fileNames[0]));
                    if (callback) callback();
                });
        }

        function add() {
            showGetName(function (event, name) {
                characters.characters[name] = { settings: path.join("{characters}", name + ".json"), map: path.join("{characters}", name + ".map") };
                var sf = parseTemplate(characters.characters[name].settings);
                var response, d;
                if (isFileSync(sf)) {
                    response = dialog.showMessageBox(remote.getCurrentWindow(), {
                        type: 'warning',
                        title: 'File exists',
                        message: 'Setting file for ' + name + ' exist, replace?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                    });
                    if (response === 0) {
                        d = Settings.load(parseTemplate(path.join("{data}", "settings.json")));
                        d.save(sf);
                    }
                }
                else {
                    d = Settings.load(parseTemplate(path.join("{data}", "settings.json")));
                    d.save(sf);
                }
                sf = parseTemplate(characters.characters[name].map);
                if (isFileSync(sf)) {
                    response = dialog.showMessageBox(remote.getCurrentWindow(), {
                        type: 'warning',
                        title: 'File exists',
                        message: 'Map file for ' + name + ' exist, replace?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                    });
                    if (response === 0) {
                        if (isFileSync(parseTemplate(path.join("{data}", "map.sqlite"))))
                            copyFile(parseTemplate(path.join("{data}", "map.sqlite")), sf);
                        else
                            fs.closeSync(fs.openSync(sf, 'w'));
                    }
                }
                else if (isFileSync(parseTemplate(path.join("{data}", "map.sqlite"))))
                    copyFile(parseTemplate(path.join("{data}", "map.sqlite")), sf);
                else
                    fs.closeSync(fs.openSync(sf, 'w'));
                changed++;
                createItem(name);
                saveCharacters();
                sortList();
            });
        }

        function addEmpty() {
            showGetName(function (event, name) {
                characters.characters[name] = { settings: path.join("{characters}", name + ".json"), map: path.join("{characters}", name + ".map") };
                var sf = parseTemplate(characters.characters[name].settings);
                var response, d;
                if (isFileSync(sf)) {
                    response = dialog.showMessageBox(remote.getCurrentWindow(), {
                        type: 'warning',
                        title: 'File exists',
                        message: 'Setting file for ' + name + ' exist, replace?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                    });
                    if (response === 0) {
                        d = new Settings();
                        d.save(sf);
                    }
                }
                else {
                    d = new Settings();
                    d.save(sf);
                }
                sf = parseTemplate(characters.characters[name].map);
                if (isFileSync(sf)) {
                    response = dialog.showMessageBox(remote.getCurrentWindow(), {
                        type: 'warning',
                        title: 'File exists',
                        message: 'Map file for ' + name + ' exist, replace?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                    });
                    if (response === 0) {
                        fs.closeSync(fs.openSync(sf, 'w'));
                    }
                }
                else
                    fs.closeSync(fs.openSync(sf, 'w'));
                changed++;
                createItem(name);
                saveCharacters();
                sortList();
            });
        }

        function rename(name) {
            if (name === undefined)
                name = current;
            showGetName(name, 0, 1, function (event, name, oldName) {
                characters.characters[name] = { settings: path.join("{characters}", name + ".json"), map: path.join("{characters}", name + ".map") };
                var f = parseTemplate(characters.characters[oldName].settings);
                var sf = parseTemplate(characters.characters[name].settings);
                var response;
                if (isFileSync(sf)) {
                    response = dialog.showMessageBox(remote.getCurrentWindow(), {
                        type: 'warning',
                        title: 'File exists',
                        message: 'Setting file for ' + name + ' exist, replace?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                    });
                    if (response === 0)
                        fs.renameSync(f, sf);
                }
                else
                    fs.renameSync(f, sf);
                f = parseTemplate(characters.characters[oldName].map);
                sf = parseTemplate(characters.characters[name].map);
                if (isFileSync(sf)) {
                    response = dialog.showMessageBox(remote.getCurrentWindow(), {
                        type: 'warning',
                        title: 'File exists',
                        message: 'Map file for ' + name + ' exist, replace?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                    });
                    if (response === 0) {
                        fs.renameSync(f, sf);
                    }
                }
                else
                    fs.renameSync(f, sf);
                changed++;
                delete characters.characters[oldName];
                $('#character-' + oldName).remove();
                createItem(name);
                if (current === oldName) {
                    clearEditor();
                    $('#character-' + name).click();
                }
                saveCharacters();
                sortList();
            });
        }

        function copyName(name) {
            var i = 0, n = name;
            while (characters.characters[n]) {
                if (i === 0)
                    n = name;
                else
                    n = name + i;
                i++;
            }
            return n;
        }

        function copy(name) {
            if (name === undefined)
                name = current;
            showGetName(name, copyName(name), function (event, name, oldName) {
                characters.characters[name] = { settings: path.join("{characters}", name + ".json"), map: path.join("{characters}", name + ".map") };
                var f = parseTemplate(characters.characters[oldName].settings);
                var sf = parseTemplate(characters.characters[name].settings);
                var response;
                if (isFileSync(sf)) {
                    response = dialog.showMessageBox(remote.getCurrentWindow(), {
                        type: 'warning',
                        title: 'File exists',
                        message: 'Setting file for ' + name + ' exist, replace?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                    });
                    if (response === 0)
                        copyFile(f, sf);
                }
                else
                    copyFile(f, sf);
                f = parseTemplate(characters.characters[oldName].map);
                sf = parseTemplate(characters.characters[name].map);
                if (isFileSync(sf)) {
                    response = dialog.showMessageBox(remote.getCurrentWindow(), {
                        type: 'warning',
                        title: 'File exists',
                        message: 'Map file for ' + name + ' exist, replace?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                    });
                    if (response === 0) {
                        if (isFileSync(f))
                            copyFile(f, sf);
                        else
                            fs.closeSync(fs.openSync(sf, 'w'));
                    }
                }
                else if (isFileSync(f))
                    copyFile(f, sf);
                else
                    fs.closeSync(fs.openSync(sf, 'w'));
                changed++;
                createItem(name);
                saveCharacters();
                sortList();
            });
        }

        function remove(name) {
            if (name === undefined)
                name = current;
            var response = dialog.showMessageBox(remote.getCurrentWindow(), {
                type: 'warning',
                title: 'Remove character',
                message: 'Remove ' + name + '?',
                buttons: ['Yes', 'No'],
                defaultId: 1,
            });

            if (response === 0) {
                var sf = parseTemplate(characters.characters[name].settings);
                if (isFileSync(sf))
                    shell.moveItemToTrash(sf);
                sf = parseTemplate(characters.characters[name].map);
                if (isFileSync(sf))
                    shell.moveItemToTrash(sf);
                if (characters.load === name)
                    characters.load = 0;
                delete characters.characters[name];
                $('#character-' + name).remove();
                if (current === name)
                    clearEditor();
                changed++;
                saveCharacters();
            }

        }

        function load(name) {
            if (name === undefined)
                name = current;
            var response = dialog.showMessageBox(remote.getCurrentWindow(), {
                type: 'warning',
                title: 'Load character',
                message: 'Load ' + name + "?",
                buttons: ['Yes', 'No'],
                defaultId: 1,
            });
            if (response === 0)
                ipcRenderer.send('load-char', name);
        }

        function loadDefault() {
            var response = dialog.showMessageBox(remote.getCurrentWindow(), {
                type: 'warning',
                title: 'Load defaults',
                message: 'Load defaults?',
                buttons: ['Yes', 'No'],
                defaultId: 1,
            });
            if (response === 0)
                ipcRenderer.send('load-default', name);
        }

        function showGetName(name, val, type, callback) {
            if (typeof name === "function") {
                callback = name;
                name = undefined;
            }
            else if (typeof val === "function") {
                callback = val;
                val = undefined;
            }
            else if (typeof type === "function") {
                callback = type;
                type = undefined;
            }

            var p = $("#get-name-value").parent();
            p.removeClass("has-error");
            p.removeClass("has-feedback");

            $("#get-name")[0].showModal();
            if (callback)
                $("#get-name").on('get-name-ok', callback);
            $('#get-name-value').val(val || '');
            $("#get-name").data('type', type);
            $("#get-name").data("name", name || current);
        }

        function copyFile(src, dest) {
            let readStream = fs.createReadStream(src);
            readStream.once('error', (err) => {
                console.log(err);
            });
            readStream.once('end', () => { });
            readStream.pipe(fs.createWriteStream(dest));
        }
    </script>
    <style>
        .form-control-feedback,
        .form-error {
            display: none;
        }

        .has-error .form-control-feedback {
            display: inline;
            top: 20px;
        }

        .has-error .form-error {
            display: block;
        }

        .aura-error,
        .form-error,
        .has-error a {
            color: #A94442;
        }
    </style>
</head>

<body>
    <div id="toolbar" class="btn-toolbar" role="toolbar">
        <div class="btn-group" role="group">
            <button id="btn-refresh" type="button" class="btn btn-default btn-xs" title="Refresh" onclick="refresh()">
                <i class="fa fa-refresh"></i>
            </button>
            <button id="btn-save" type="button" class="btn btn-default btn-xs" title="Save" onclick="saveCharacters()">
                <i class="fa fa-save"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default btn-xs" title="Add" onclick="add()">
                <i class="fa fa-plus"></i>
            </button>
            <button id="btn-add-dropdown" type="button" class="btn btn-default btn-xs" title="Add">
                <span class="caret"></span>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-rename" type="button" class="btn btn-default btn-xs" disabled="disabled" title="Rename" onclick="rename()">
                <i class="fa fa-i-cursor"></i>
            </button>
            <button id="btn-copy" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Copy" onclick="copy()">
                <i class="fa fa-copy"></i>
            </button>
            <button id="btn-delete" type="button" disabled="disabled" class="btn btn-danger btn-xs" title="Delete" onclick="remove()">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-load-default" type="button" class="btn btn-warning btn-xs" title="Load default" onclick="loadDefault()">
                <i class="fa fa-step-backward"></i>
            </button>
            <button id="btn-load" type="button" disabled="disabled" class="btn btn-warning btn-xs" title="Load" onclick="load()">
                <i class="fa fa-play"></i>
            </button>
        </div>
    </div>
    <div id="main">
        <div id="characters-container" class="panel panel-default" style="position: absolute;left: 2px;top: 2px;bottom:2px;width:200px;overflow: auto;margin:0">
            <ul id="characters-list" class="list-group">

            </ul>
        </div>
        <div id="content" class="panel panel-default" style="position: absolute;left:206px;right: 2px;top: 2px;bottom:2px;margin:0">
            <div class="panel-heading">
                Character:
                <span id="title"></span>
            </div>
            <div class="panel-body" id="character-editor">
                <label class="control-label" style="width: 100%"> Password
                    <input disabled="disabled" class="form-control" style="width:100%" type="password" id="password">
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Supply at own risk, the password is stored in basic encryption</span>
                </label>
                <label class="control-label"> Settings
                    <div class="input-group" style="width:100%;">
                        <input disabled="disabled" class="form-control" style="width:100%" type="text" id="settings">
                        <span class="input-group-btn">
                            <button disabled="disabled" class="btn btn-default" type="button" onclick="openFile('#settings', ['json'])">
                                &hellip;
                            </button>
                        </span>
                    </div>
                </label>
                <label class="control-label"> Map
                    <div class="input-group" style="width:100%;">
                        <input disabled="disabled" class="form-control" style="width:100%" type="text" id="map">
                        <span class="input-group-btn">
                            <button disabled="disabled" class="btn btn-default" type="button" onclick="openFile('#map', ['map', 'sqlite'])">
                                &hellip;
                            </button>
                        </span>
                    </div>
                </label>
                <label class="control-label">
                    <input disabled="disabled" type="checkbox" id="auto-load" /> Auto load
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Only one character can auto load, enabling this will disable previous auto loaded character</span>
                </label>
            </div>
        </div>
    </div>

    <dialog id="get-name" style="z-index:1000;">
        <div class="form-group">
            <label class="control-label">
                <span id="get-name-title">New character name</span>
                <input class="form-control" style="width:100%" type="text" id="get-name-value">
                <span class="glyphicon glyphicon-remove form-control-feedback" aria-hidden="true"></span>
                <div class="form-error"></div>
            </label>
        </div>
        <div style="text-align:right">
            <button id="get-name-ok">
                Ok
            </button>
            <button onclick="$('#get-name')[0].close()">
                Cancel
            </button>
        </div>
    </dialog>
</body>

</html>
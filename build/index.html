<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="UTF-8">
  <title>jiMUD</title>
  <link href="css/main.css" rel="stylesheet" type="text/css" />
  <link href="css/cm.css" rel="stylesheet" type="text/css" />
  <link href="css/ansi.css" rel="stylesheet" type="text/css" />
  <link href="css/monsters.css" rel="stylesheet" type="text/css" />
  <link href="../lib/font-awesome.min.css" rel="stylesheet" type="text/css" />
  <link href="css/theme.css" rel="stylesheet" type="text/css" />
  <link href="../lib/bootstrap.min.css" rel="stylesheet" type="text/css" />
  <link href="../lib/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
  <link id="theme" rel="stylesheet" href="themes/default.css" type="text/css">
  <script>
    if (typeof module === 'object') { window.module = module; module = undefined; }
  </script>
  <script src="../lib/jquery.min.js"></script>
  <script src="js/jquery.ext.js"></script>
  <script src="../lib/bootstrap.min.js" type="text/javascript"></script>
</head>

<body>
  <dialog id="Progress" style="z-index:1000;text-align:center">
    <div id="ProgressTitle"></div>
    <div id="Progressbar">
      <progress max="100"></progress>
    </div>
  </dialog>
  <dialog id="pasteSpecial" style="z-index:1000;height:285px;width:350px;">
    <div class="dialog-body">
      <div class="form-group">
        <label class="control-label" for="pasteSpecial-replace">Replace with</label>
        <div class="input-group">
          <input id="pasteSpecial-replace" class="form-control">
          <div class="input-group-addon">
            <input type="checkbox" id="pasteSpecial-replace-enable" checked="checked" onclick="$('#pasteSpecial-replace').prop('disabled', !$(this).prop('checked'));" />
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="control-label" for="pasteSpecial-prefix">Prefix</label>
        <div class="input-group">
          <input id="pasteSpecial-prefix" class="form-control">
          <div class="input-group-addon">
            <input type="checkbox" id="pasteSpecial-prefix-enable" checked="checked" onclick="$('#pasteSpecial-prefix').prop('disabled', !$(this).prop('checked'));" />
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="control-label" for="pasteSpecial-postfix">Postfix</label>
        <div class="input-group">
          <input id="pasteSpecial-postfix" class="form-control">
          <div class="input-group-addon">
            <input type="checkbox" id="pasteSpecial-postfix-enable" checked="checked" onclick="$('#pasteSpecial-postfix').prop('disabled', !$(this).prop('checked'));" />
          </div>
        </div>
      </div>
    </div>
    <div class="dialog-footer">
      <button style="float: left" type="button" class="btn btn-default" onclick="$('#pasteSpecial-replace').prop('disabled', false);$('#pasteSpecial-replace-enable').prop('checked', true);$('#pasteSpecial-replace').val('');$('#pasteSpecial-prefix').prop('disabled', false);$('#pasteSpecial-postfix').prop('disabled', false);$('#pasteSpecial-prefix').val('');$('#pasteSpecial-postfix').val('');$('#pasteSpecial-prefix-enable').prop('checked', true);$('#pasteSpecial-postfix-enable').prop('checked', true);">Reset</button>
      <button style="float: right" type="button" class="btn btn-default" onclick="$('#pasteSpecial')[0].close();">Cancel</button>
      <button style="float: right" type="button" class="btn btn-primary" onclick="pasteSpecialOk()">Ok</button>
    </div>
  </dialog>
</body>
<script>
  if (window.module) module.module;

  const { DockManager } = require('./js/dockmanager');
  const { Client, ClientOptions } = require('./js/client');
  const { Menubar } = require('./js/menubar');
  const { shell, clipboard, ipcRenderer, remote, webFrame } = require('electron');
  const { dialog, BrowserWindow, Menu, MenuItem } = remote;
  const { parseTemplate, isFileSync, isDirSync, setSelectionRange } = require("./js/library");
  const { Settings } = require('./js/settings');
  const { Characters } = require('./js/characters');

  const path = require('path');
  const fs = require('fs');
  const url = require('url');

  window.readClipboard = () => { return clipboard.readText('selection') || clipboard.readText() || ''; };
  window.writeClipboard = (txt) => { clipboard.writeText(txt || ''); clipboard.writeText(txt || '', 'selection'); };

  window.onerror = function (msg, url, line, col, error) {
    if (manager && manager.panels.length > 0) {
      if(error)
        manager.active.client.error(error);
      else if (msg.startsWith('Uncaught Error: '))
        manager.active.client.error(`${msg.substr(16)}`);
      else
        manager.active.client.error(`${msg}`);
      if (manager.active.client.options.enableDebug) {
        manager.active.client.error("Url: " + url);
        manager.active.client.error("Line: " + line);
        manager.active.client.error("Column: " + col);
        manager.active.client.error(error);
      }
    }
    else {
      console.log("Message: " + msg);
      console.log("Url: " + url);
      console.log("Line: " + line);
      console.log("Column: " + col);
      console.log(error);
    }    
    return true;
  };

  window.onbeforeunload = () => {
    $('.dropdown.open').removeClass('open');
    if (_profilesOpen) {
      dialog.showMessageBox({
        type: 'warning',
        title: 'Close profile manager',
        message: 'You must close the profile manager before you can exit.'
      });
      return 'no';
    }

    let tl = manager.panels.length;
    for (var t = 0; t < tl; t++) {
      if (manager.panels[t].client.options.askonclose && manager.panels[t].client.connected) {
        var choice = dialog.showMessageBox(remote.getCurrentWindow(),
          {
            type: 'warning',
            title: 'Connected',
            message: 'Closing will disconnect you from the mud, close anyway?',
            buttons: ['Yes', 'No', 'Never ask again'],
            defaultId: 1
          });
        if (choice === 2) {
          manager.panels[t].client.options.askonclose = false;
          manager.panels[t].client.saveOptions();
        }
        else if (choice !== 0)
          return 'no';
      }
      manager.panels[t].client.raise('closed');
      manager.panels[t].client.close();
      ipcRenderer.send('remove', manager.panels[t].id);
    }
  };

  window.onblur = () => {
    active = false;
    manager.active.client.raise('blur');
  };

  window.onfocus = () => {
    active = true;
    if (manager.active) {
      if (manager.active.client.connected)
        ipcRenderer.send('set-overlay', 1);
      else if (!manager.active.client.connecting)
        ipcRenderer.send('set-overlay', 0);
      manager.active.client.raise('focus');
      //manager.active.client.commandInput.focus();
    }

  };

  window.onresize = () => {
    let tl = manager.panels.length;
    for (var t = 0; t < tl; t++) {
      manager.panels[t].client.UpdateWindow();
    }
  };

  var menuTemp = [
    //File
    {
      label: '&File',
      id: 'file',
      submenu: [
        {
          label: "&New Connection",
          accelerator: "CmdOrCtrl+Shift+N",
          click: () => {
            createClient('telnet://www.shadowmud.com:1030', manager.addPanel("www.shadowmud.com:1030"));
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          label: "C&lose Connection",
          accelerator: "CmdOrCtrl+W",
          enabled: false,
          click: () => {
            manager.removePanel();
            $('.dropdown.open').removeClass('open');
          }
        },
        { type: 'separator' },
        {
          label: "&Connect",
          id: "connect",
          accelerator: "CmdOrCtrl+N",
          click: () => {
            $('.dropdown.open').removeClass('open');
            manager.active.client.connect();
          }
        },
        {
          label: "&Disconnect",
          id: "disconnect",
          accelerator: "CmdOrCtrl+D",
          enabled: false,
          click: () => {
            $('.dropdown.open').removeClass('open');
            manager.active.client.close();
          }
        },
        { type: 'separator' },
        {
          label: "Ch&aracters...",
          id: "characters",
          accelerator: "CmdOrCtrl+H",
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        { type: 'separator' },
        {
          label: '&Log',
          id: "log",
          type: 'checkbox',
          checked: false,
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          label: '&View logs...',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          type: 'separator'
        },
        {
          label: '&Preferences...',
          id: 'preferences',
          accelerator: "CmdOrCtrl+Comma",
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          type: 'separator'
        },
        {
          label: 'E&xit',
          role: 'quit'
        }
      ]
    },
    //Edit
    {
      label: '&Edit',
      id: 'edit',
      submenu: [
        {
          role: 'undo',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          role: 'redo',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          type: 'separator'
        },
        {
          role: 'cut',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          role: 'copy',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          label: 'Paste',
          accelerator: 'CmdOrCtrl+V',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          label: 'Paste special',
          accelerator: 'CmdOrCtrl+Shift+V',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          role: 'delete'
        },
        {
          label: 'Select All',
          accelerator: 'CmdOrCtrl+A',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          type: 'separator'
        },
        {
          label: 'Clear',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        { type: 'separator' },
        {
          label: 'Find',
          accelerator: 'CmdOrCtrl+F',
          click: () => {
            $('.dropdown.open').removeClass('open');
            manager.active.client.display.showFind();
          }
        },
      ]
    },
    //Profiles
    {
      label: '&Profiles',
      id: 'profiles',
      submenu: []
    },
    //View
    {
      label: '&View',
      id: 'view',
      submenu: [
        {
          label: '&Lock',
          id: "lock",
          type: 'checkbox',
          checked: false,
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          label: '&Who is on?',
          click: () => {
            shell.openExternal("http://www.shadowmud.com/who.php", '_blank');
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          type: 'separator'
        },
        {
          label: '&Status',
          id: 'status',
          submenu: [
            {
              label: '&Visible',
              id: "statusvisible",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Refresh',
              id: "refresh",
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            { type: 'separator' },
            {
              label: '&Weather',
              id: "weather",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Limbs',
              id: "limbsmenu",
              submenu: [
                {
                  label: '&Visible',
                  id: "limbs",
                  type: 'checkbox',
                  checked: true,
                  click: () => {
                    $('.dropdown.open').removeClass('open');
                  }
                },
                { type: 'separator' },
                {
                  label: '&Health',
                  id: "limbhealth",
                  type: 'checkbox',
                  checked: true,
                  click: () => {
                    $('.dropdown.open').removeClass('open');
                  }
                },
                {
                  label: '&Armor',
                  id: "limbarmor",
                  type: 'checkbox',
                  checked: true,
                  click: () => {
                    $('.dropdown.open').removeClass('open');
                  }
                },
              ]
            },
            {
              label: '&Health',
              id: "health",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Experience',
              id: "experience",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Party Health',
              id: "partyhealth",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Combat Health',
              id: "combathealth",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Lagmeter',
              id: "lagmeter",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            }
          ]
        },
        {
          label: '&Buttons',
          id: 'buttons',
          submenu: [
            {
              label: '&Visible',
              id: "buttonsvisible",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            { type: 'separator' },
            {
              label: '&Connect',
              id: "connectbutton",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Characters',
              id: "charactersbutton",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Preferences',
              id: "preferencesbutton",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Log',
              id: "logbutton",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Clear',
              id: "clearbutton",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Lock',
              id: "lockbutton",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Map',
              id: "mapbutton",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&User buttons',
              id: "userbutton",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
          ]
        },
        {
          type: 'separator'
        },
        {
          role: 'toggledevtools'
        },
        {
          type: 'separator'
        },
        {
          role: 'resetzoom'
        },
        {
          role: 'zoomin'
        },
        {
          role: 'zoomout'
        },
        {
          type: 'separator'
        },
        {
          role: 'togglefullscreen'
        }
      ]
    },
    //Window
    {
      role: 'window',
      id: 'window',
      submenu: [
        {
          label: '&Advanced editor...',
          id: 'editor',
          click: () => {
            $('.dropdown.open').removeClass('open');
          },
          accelerator: 'CmdOrCtrl+E'
        },
        {
          label: '&Chat...',
          id: 'chat',
          click: () => {
            $('.dropdown.open').removeClass('open');
          },
          accelerator: 'CmdOrCtrl+L'
        },
        {
          label: '&Immortal tools...',
          id: 'immortal',
          click: () => {
            $('.dropdown.open').removeClass('open');
          },
          visible: false,
          accelerator: 'CmdOrCtrl+I'
        },

        {
          label: '&Map...',
          click: () => {
            $('.dropdown.open').removeClass('open');
          },
          accelerator: 'CmdOrCtrl+T'
        },
        { type: 'separator' },
        {
          role: 'minimize'
        },
        {
          role: 'close'
        }
      ]
    },
    //Help
    {
      label: '&Help',
      role: 'help',
      submenu: [
        {
          label: '&ShadowMUD',
          click: () => {
            $('.dropdown.open').removeClass('open');
            shell.openExternal("http://www.shadowmud.com/help.php", '_blank');
          }
        },
        {
          label: '&jiMUD',
          click: () => {
            $('.dropdown.open').removeClass('open');
            shell.openExternal("https://github.com/icewolfz/jiMUD/tree/master/docs", '_blank');
          }
        },
        { type: 'separator' },
        {
          label: '&About...',
          click: () => {
            $('.dropdown.open').removeClass('open');
            var b = remote.getCurrentWindow().getBounds();

            let about = new BrowserWindow({
              parent: remote.getCurrentWindow(),
              modal: true,
              x: Math.floor(b.x + b.width / 2 - 225),
              y: Math.floor(b.y + b.height / 2 - 200),
              width: 450,
              height: 400,
              movable: false,
              minimizable: false,
              maximizable: false,
              skipTaskbar: true,
              resizable: false,
              title: 'About jiMUD',
              icon: path.join(__dirname, '../assets/icons/png/64x64.png')
            });
            about.webContents.on('crashed', (event, killed) => {
              //ipcRenderer.send('error', `About crashed, killed: ${killed}\n`, true);
            });

            about.setMenu(null);
            about.on('closed', () => {
              about = null;
            });

            // and load the index.html of the app.
            about.loadURL(url.format({
              pathname: path.join(__dirname, 'about.html'),
              protocol: 'file:',
              slashes: true
            }));

            about.once('ready-to-show', () => {
              about.show();
            });
          }
        }
      ]
    }
  ];

  if (process.platform === 'darwin') {
    menuTemp.unshift({
      label: 'jiMUD',
      submenu: [
        {
          label: 'about',
          click: () => {
            $('.dropdown.open').removeClass('open');
            var b = remote.getCurrentWindow().getBounds();

            let about = new BrowserWindow({
              parent: remote.getCurrentWindow(),
              modal: true,
              x: Math.floor(b.x + b.width / 2 - 225),
              y: Math.floor(b.y + b.height / 2 - 200),
              width: 450,
              height: 400,
              movable: false,
              minimizable: false,
              maximizable: false,
              skipTaskbar: true,
              resizable: false,
              title: 'About jiMUD',
              icon: path.join(__dirname, '../assets/icons/png/64x64.png')
            });
            about.webContents.on('crashed', (event, killed) => {
              //ipcRenderer.send('error', `About crashed, killed: ${killed}\n`, true);
            });

            about.setMenu(null);
            about.on('closed', () => {
              about = null;
            });

            // and load the index.html of the app.
            about.loadURL(url.format({
              pathname: path.join(__dirname, 'about.html'),
              protocol: 'file:',
              slashes: true
            }));

            about.once('ready-to-show', () => {
              about.show();
            });
          }
        },
        {
          type: 'separator'
        },
        {
          role: 'services',
          submenu: []
        },
        {
          type: 'separator'
        },
        {
          role: 'hide'
        },
        {
          role: 'hideothers'
        },
        {
          role: 'unhide'
        },
        {
          type: 'separator'
        },
        {
          role: 'quit'
        }
      ]
    });
    // Edit menu.
    menuTemp[2].submenu.push(
      {
        type: 'separator'
      },
      {
        label: 'Speech',
        submenu: [
          {
            role: 'startspeaking'
          },
          {
            role: 'stopspeaking'
          }
        ]
      }
    );
    // Window menu.
    menuTemp[5].submenu = [
      {
        label: 'Close',
        accelerator: 'CmdOrCtrl+W',
        role: 'close'
      },
      {
        label: 'Minimize',
        accelerator: 'CmdOrCtrl+M',
        role: 'minimize'
      },
      {
        label: 'Zoom',
        role: 'zoom'
      },
      {
        type: 'separator'
      },
      {
        label: 'Bring All to Front',
        role: 'front'
      }
    ];
  }

  function createMenu() {
    var profiles;
    for (var m = 0; m < menuTemp.length; m++) {
      if (menuTemp[m].id === "profiles") {
        profiles = menuTemp[m];
        break;
      }
    }
    profiles.submenu = [];
    profiles.submenu.push(
      {
        label: 'Default',
        type: 'checkbox',
        checked: false,
        id: 'default',
        click: () => {
          $('.dropdown.open').removeClass('open');
        }
      });

    var p = path.join(parseTemplate('{data}'), 'profiles');
    if (isDirSync(p)) {
      var files = fs.readdirSync(p);
      for (var i = 0; i < files.length; i++) {
        if (path.extname(files[i]) === ".json") {
          if (files[i].toLowerCase() === "default.json")
            continue;
          profiles.submenu.push(
            {
              label: path.basename(files[i], ".json"),
              type: 'checkbox',
              checked: false,
              id: path.basename(files[i], ".json").toLowerCase(),
              click: (menuItem, browserWindow, event) => {
                $('.dropdown.open').removeClass('open');
              }
            });
        }
      }
    }
    profiles.submenu.push(
      {
        type: 'separator'
      });
    profiles.submenu.push(
      {
        label: '&Manage...',
        click: () => {
          $('.dropdown.open').removeClass('open');
        },
        accelerator: 'CmdOrCtrl+P'
      });
    menubar = new Menubar(menuTemp);
  }

  createMenu();

  function createClient(host, panel, options) {
    panel.client = new Client(Object.assign({ id: panel.id, parent: panel.pane, host: host }, clientoptions, options));
    panel.client.on('update-menuitem', (menu, item) => {
      if (panel.id == manager.active.id)
        menubar.updateItem(menu, item);
    });
    panel.client.on('find-closing', (e) => {
      if (panel.client.id !== manager.active.id)
        e.preventDefault = true;
    });
    menubar.updateItem('file|connect', { enabled: !panel.client.connected });
    menubar.updateItem('file|disconnect', { enabled: panel.client.connected });
  }

  function childClosed(url, name, client) {
    if (name === "profiles")
      _profilesOpen = false;
    else {
      var basename = path.basename(url);
      if (basename === 'characters.html')
        _cLoading = false;
      else if (basename === 'profiles.html')
        _profilesOpen = false;
      else if (basename === 'prefs.html')
        _pLoading = false;
      else {
        var panel = manager.getPanel(client);
        if (!panel) return;
        panel.client.childClosed(url, name);
      }
    }
  }

  function loadTheme(theme) {
    theme = parseTemplate(theme) + ".css";
    if (!isFileSync(theme))
      theme = parseTemplate(path.join("{themes}", "default")) + ".css";
    var el = $("#theme");
    if (el.attr('href') != theme)
      el.attr('href', theme);
  }

  function loadSpellchecker() {
    try {
      spellchecker = require('spellchecker');
    }
    catch (ex) {
      if (!manager || manager.panels.length === 0)
        setTimeout(() => {
          if (!!manager || manager.panels.length === 0)
            console.log(ex);
          else
            manager.active.client.error(ex);
        }, 1000);
    }
  }

  function loadCharacters(characters) {
    if (!characters || characters.length === 0)
      return;
    var char = 0, cl = characters.length;
    for (; char < cl; char++) {
      var opts = {};
      opts.username = characters[c].Name;
      //TODO decode password
      opts.password = characters[c].password;
      opts.port = characters[c].port;
      if (characters[c].UseAddress)
        createClient(characters[c].address, manager.addPanel(characters[c].Name), opts);
      else
        createClient(characters[c].host, manager.addPanel(characters[c].Name), opts);
    }
  }

  function doLink(url) {
    if (confirm("Open '" + url + "'?") === true)
      shell.openExternal(url);
  }

  function doMXPLink(el, url) {
    if (url.startsWith("OoMUD://") || url.startsWith("jiMUD://") || url.startsWith("client://"))
      doMXPSend(0, el, url.substring(8));
    else if (confirm("Open '" + url + "'?") === true)
      shell.openExternal(url.replace("&text;", $(el).text()));
  }

  function doMXPSend(e, el, url, pmt, tt) {
    el = $(el);
    var im = el.find("img[ismap]");
    var extra = '';
    if (im.length > 0) {
      var offset = im.offset();
      var x = Math.floor(e.clientX - offset.left);
      var y = Math.floor(e.clientY - offset.top);
      extra = "?" + x + "," + y;
    }

    if (url.constructor === Array || url.__proto__.constructor === Array || Object.prototype.toString.call(url) === "[object Array]") {
      var menu = new Menu();
      var item;
      for (var i = 0, il = url.length; i < il; i++) {
        url[i] = url[i].replace("&text;", $(el).text());
        if (i < tt.length) {
          item = new MenuItem({
            label: tt[i], click(item) {
              MXPMenuHandler(item.cmd, pmt);
            }
          });
        }
        else {
          item = new MenuItem({
            label: url[i], click(item) {
              MXPMenuHandler(item.cmd, pmt);
            }
          });
        }
        item.cmd = url[i] + extra;
        menu.append(item);
      }
      menu.popup(remote.getCurrentWindow(), e.pageX, e.pageY);
    }
    else if (pmt) {
      url = url.replace("&text;", $(el).text()) + extra;
      manager.active.client.commandInput.val(url);
      setSelectionRange(manager.active.client.commandInput[0], url.length, url.length);
    }
    else
      manager.active.client.send(url.replace("&text;", $(el).text()) + extra + '\n', true);
  }

  function MXPMenuHandler(cmd, pmt) {
    if (pmt) {
      manager.active.client.commandInput.val(cmd);
      setSelectionRange(manager.active.client.commandInput[0], cmd.length, cmd.length);
    }
    else
      manager.active.client.send(cmd, true);
  }


  function doMXPTooltip(el) {
    el = $(el);
    el.prop("title", el.prop("title").replace("&text;", el.text()));
  }

  var spellchecker;
  var clientoptions = {};
  var _cLoading = false;
  var _pLoading = false;
  var _profilesOpen = false;
  var active = true;
  loadTheme(ipcRenderer.sendSync('get-setting', 'theme'));
  //var options = Settings.load(remote.getGlobal('settingsFile'));
  var manager = new DockManager();

  manager.on('add', (e) => {
    ipcRenderer.send('add', e.id);
    //e.panel.pane.innerHTML = `<h1 style="color:white;text-align:center;z-index:10000;position: relative;font-size:10em">${e.id}</h1>`;
    menubar.updateItem('file|close connection', { enabled: manager.panels.length > 1 });
  });

  manager.on('remove', (e) => {
    if (manager.panels.length === 1) {
      e.cancel = true;
      menubar.updateItem('file|close connection', { enabled: false });
      return;
    }
    menubar.updateItem('file|close connection', { enabled: (manager.panels.length - 1) > 1 });
    ipcRenderer.send('remove', e.id);
  });

  manager.on('activated', (e) => {
    if (!manager.active.client) return;
    menubar.updateItem('file|connect', { enabled: !manager.active.client.connected });
    menubar.updateItem('file|disconnect', { enabled: manager.active.client.connected });
    document.title = 'jiMUD - ' + manager.active.title.innerText;
    if (manager.active.client.connected)
      ipcRenderer.send('set-overlay', 1);
    else if (!manager.active.client.connecting)
      ipcRenderer.send('set-overlay', 0);
    manager.active.client.raise('focus');
    manager.active.client.commandInput.focus();
  });

  manager.on('deactivated', (e) => {
    e.panel.client.raise('blur');
  });

  manager.on('keyup', (e) => {
    if (manager.active)
      manager.active.client.emit('keyup', e);
  });
  manager.on('keydown', (e) => {
    if (manager.active)
      manager.active.client.emit('keydown', e);
  });

  var args = remote.process.argv;

  if (remote.process.defaultApp)
    args = args.splice(2);
  var chars = [];
  var conns = [];
  args.forEach((val, index) => {
    var set = val.split('=');
    switch (set[0]) {
      case '-d':
      case '-debug':
      case '--d':
      case '--debug':
      case '--disable-gpu':
        break;
      case '-c':
      case '-character':
      case '-characters':
      case '--c':
      case '--character':
      case '--characters':
        chars.push(set[1]);
        break;
      case '-s':
      case '-setting':
      case '--s':
      case '--setting':
        clientoptions.settings = set[1];
        break;
      case '-mf':
      case '-map':
      case '--mf':
      case '--map':
        clientoptions.map = set[1];
        break;
      case '-pf':
      case '-profiles':
      case '--pf':
      case '--profiles':
        clientoptions.profiles = set[1].split(',');
        break;
      default:
        if (!val.startsWith('telnet://'))
          conns.push('telnet://' + val);
        else
          conns.push(val);
        break;
    }
  });
  var c, cl = conns.length;
  for (c = 0; c < cl; c++)
    createClient(conns[c], manager.addPanel(conns[c]));

  c = new Characters();
  if (chars.lenth > 0)
    c.get(chars, (characters) => {
      if (!characters || characters.length === 0) {
        c.close();
        c = null;
        return;
      }
      loadCharacters(characters);
      c.close();
      c = null;
    });
  else
    c.getAutoloading((characters) => {
      if (!characters || characters.length === 0) {
        c.close();
        c = null;
        return;
      }
      loadCharacters(characters);
      c.close();
      c = null;
    });

  if (manager.panels.length === 0)

    createClient('telnet://www.shadowmud.com:1030', manager.addPanel("www.shadowmud.com:1030"));

</script>

</html>
<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="UTF-8">
  <title>jiMUD</title>
  <link href="css/main.css" rel="stylesheet" type="text/css" />
  <link href="css/cm.css" rel="stylesheet" type="text/css" />
  <link href="css/ansi.css" rel="stylesheet" type="text/css" />
  <link href="css/monsters.css" rel="stylesheet" type="text/css" />
  <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css" />
  <link href="css/theme.css" rel="stylesheet" type="text/css" />
  <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css" />
  <link href="css/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
  <link id="theme" rel="stylesheet" href="themes/default.css" type="text/css">
  <script>
    if (typeof module === 'object') { window.module = module; module = undefined; }
  </script>
  <script src="../lib/jquery.min.js"></script>
  <script src="js/jquery.ext.js"></script>
  <script src="../lib/bootstrap.min.js" type="text/javascript"></script>
</head>

<body></body>
<script>
  if (window.module) module.module;

  const { DockManager } = require('./js/dockmanager');
  const { Client } = require('./js/client');
  const { Menubar } = require('./js/menubar');
  const { shell, ipcRenderer, remote, webFrame } = require('electron');
  const { dialog, BrowserWindow } = remote;
  const { parseTemplate, isFileSync, isDirSync } = require("./js/library.js");
  const path = require('path');
  const fs = require('fs');
  const url = require('url');
  /*
  window.onerror = function (msg, url, line) {
    console.log("Message: " + msg);
    console.log("Url: " + url);
    console.log("Line: " + line);
    return true;
  };
  */

  var menuTemp = [
    //File
    {
      label: '&File',
      id: 'file',
      submenu: [
        {
          label: "&New Connection",
          accelerator: "CmdOrCtrl+Shift+N",
          click: () => {
            manager.addPanel("www.shadowmud.com:1030");
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          label: "C&lose Connection",
          accelerator: "CmdOrCtrl+W",
          enabled: false,
          click: () => {
            manager.removePanel();
            $('.dropdown.open').removeClass('open');
          }
        },
        { type: 'separator' },
        {
          label: "&Connect",
          id: "connect",
          accelerator: "CmdOrCtrl+N",
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          label: "&Disconnect",
          id: "disconnect",
          accelerator: "CmdOrCtrl+D",
          enabled: false,
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        { type: 'separator' },
        {
          label: "Ch&aracters...",
          id: "characters",
          accelerator: "CmdOrCtrl+H",
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        { type: 'separator' },
        {
          label: '&Log',
          id: "log",
          type: 'checkbox',
          checked: false,
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          label: '&View logs...',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          type: 'separator'
        },
        {
          label: '&Preferences...',
          id: 'preferences',
          accelerator: "CmdOrCtrl+Comma",
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          type: 'separator'
        },
        {
          label: 'E&xit',
          role: 'quit'
        }
      ]
    },
    //Edit
    {
      label: '&Edit',
      id: 'edit',
      submenu: [
        {
          role: 'undo',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          role: 'redo',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          type: 'separator'
        },
        {
          role: 'cut',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          role: 'copy',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          label: 'Paste',
          accelerator: 'CmdOrCtrl+V',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          label: 'Paste special',
          accelerator: 'CmdOrCtrl+Shift+V',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          role: 'delete'
        },
        {
          label: 'Select All',
          accelerator: 'CmdOrCtrl+A',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          type: 'separator'
        },
        {
          label: 'Clear',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        { type: 'separator' },
        {
          label: 'Find',
          accelerator: 'CmdOrCtrl+F',
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
      ]
    },
    //Profiles
    {
      label: '&Profiles',
      id: 'profiles',
      submenu: []
    },
    //View
    {
      label: '&View',
      id: 'view',
      submenu: [
        {
          label: '&Lock',
          id: "lock",
          type: 'checkbox',
          checked: false,
          click: () => {
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          label: '&Who is on?',
          click: () => {
            shell.openExternal("http://www.shadowmud.com/who.php", '_blank');
            $('.dropdown.open').removeClass('open');
          }
        },
        {
          type: 'separator'
        },
        {
          label: '&Status',
          id: 'status',
          submenu: [
            {
              label: '&Visible',
              id: "statusvisible",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Refresh',
              id: "refresh",
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            { type: 'separator' },
            {
              label: '&Weather',
              id: "weather",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Limbs',
              id: "limbsmenu",
              submenu: [
                {
                  label: '&Visible',
                  id: "limbs",
                  type: 'checkbox',
                  checked: true,
                  click: () => {
                    $('.dropdown.open').removeClass('open');
                  }
                },
                { type: 'separator' },
                {
                  label: '&Health',
                  id: "limbhealth",
                  type: 'checkbox',
                  checked: true,
                  click: () => {
                    $('.dropdown.open').removeClass('open');
                  }
                },
                {
                  label: '&Armor',
                  id: "limbarmor",
                  type: 'checkbox',
                  checked: true,
                  click: () => {
                    $('.dropdown.open').removeClass('open');
                  }
                },
              ]
            },
            {
              label: '&Health',
              id: "health",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Experience',
              id: "experience",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Party Health',
              id: "partyhealth",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Combat Health',
              id: "combathealth",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Lagmeter',
              id: "lagmeter",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            }
          ]
        },
        {
          label: '&Buttons',
          id: 'buttons',
          submenu: [
            {
              label: '&Visible',
              id: "buttonsvisible",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            { type: 'separator' },
            {
              label: '&Connect',
              id: "connectbutton",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Characters',
              id: "charactersbutton",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Preferences',
              id: "preferencesbutton",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Log',
              id: "logbutton",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Clear',
              id: "clearbutton",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Lock',
              id: "lockbutton",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&Map',
              id: "mapbutton",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
            {
              label: '&User buttons',
              id: "userbutton",
              type: 'checkbox',
              checked: true,
              click: () => {
                $('.dropdown.open').removeClass('open');
              }
            },
          ]
        },
        {
          type: 'separator'
        },
        {
          role: 'toggledevtools'
        },
        {
          type: 'separator'
        },
        {
          role: 'resetzoom'
        },
        {
          role: 'zoomin'
        },
        {
          role: 'zoomout'
        },
        {
          type: 'separator'
        },
        {
          role: 'togglefullscreen'
        }
      ]
    },
    //Window
    {
      role: 'window',
      id: 'window',
      submenu: [
        {
          label: '&Advanced editor...',
          id: 'editor',
          click: () => {
            $('.dropdown.open').removeClass('open');
          },
          accelerator: 'CmdOrCtrl+E'
        },
        {
          label: '&Chat...',
          id: 'chat',
          click: () => {
            $('.dropdown.open').removeClass('open');
          },
          accelerator: 'CmdOrCtrl+L'
        },
        {
          label: '&Immortal tools...',
          id: 'immortal',
          click: () => {
            $('.dropdown.open').removeClass('open');
          },
          visible: false,
          accelerator: 'CmdOrCtrl+I'
        },

        {
          label: '&Map...',
          click: () => {
            $('.dropdown.open').removeClass('open');
          },
          accelerator: 'CmdOrCtrl+T'
        },
        { type: 'separator' },
        {
          role: 'minimize'
        },
        {
          role: 'close'
        }
      ]
    },
    //Help
    {
      label: '&Help',
      role: 'help',
      submenu: [
        {
          label: '&ShadowMUD',
          click: () => {
            $('.dropdown.open').removeClass('open');
            shell.openExternal("http://www.shadowmud.com/help.php", '_blank');
          }
        },
        {
          label: '&jiMUD',
          click: () => {
            $('.dropdown.open').removeClass('open');
            shell.openExternal("https://github.com/icewolfz/jiMUD/tree/master/docs", '_blank');
          }
        },
        { type: 'separator' },
        {
          label: '&About...',
          click: () => {
            $('.dropdown.open').removeClass('open');
            var b = remote.getCurrentWindow().getBounds();

            let about = new BrowserWindow({
              parent: remote.getCurrentWindow(),
              modal: true,
              x: Math.floor(b.x + b.width / 2 - 225),
              y: Math.floor(b.y + b.height / 2 - 200),
              width: 450,
              height: 400,
              movable: false,
              minimizable: false,
              maximizable: false,
              skipTaskbar: true,
              resizable: false,
              title: 'About jiMUD',
              icon: path.join(__dirname, '../assets/icons/png/64x64.png')
            });
            about.webContents.on('crashed', (event, killed) => {
              //ipcRenderer.send('error', `About crashed, killed: ${killed}\n`, true);
            });

            about.setMenu(null);
            about.on('closed', () => {
              about = null;
            });

            // and load the index.html of the app.
            about.loadURL(url.format({
              pathname: path.join(__dirname, 'about.html'),
              protocol: 'file:',
              slashes: true
            }));

            about.once('ready-to-show', () => {
              about.show();
            });
          }
        }
      ]
    }
  ];

  if (process.platform === 'darwin') {
    menuTemp.unshift({
      label: 'jiMUD',
      submenu: [
        {
          label: 'about',
          click: () => {
            $('.dropdown.open').removeClass('open');
            var b = remote.getCurrentWindow().getBounds();

            let about = new BrowserWindow({
              parent: remote.getCurrentWindow(),
              modal: true,
              x: Math.floor(b.x + b.width / 2 - 225),
              y: Math.floor(b.y + b.height / 2 - 200),
              width: 450,
              height: 400,
              movable: false,
              minimizable: false,
              maximizable: false,
              skipTaskbar: true,
              resizable: false,
              title: 'About jiMUD',
              icon: path.join(__dirname, '../assets/icons/png/64x64.png')
            });
            about.webContents.on('crashed', (event, killed) => {
              //ipcRenderer.send('error', `About crashed, killed: ${killed}\n`, true);
            });

            about.setMenu(null);
            about.on('closed', () => {
              about = null;
            });

            // and load the index.html of the app.
            about.loadURL(url.format({
              pathname: path.join(__dirname, 'about.html'),
              protocol: 'file:',
              slashes: true
            }));

            about.once('ready-to-show', () => {
              about.show();
            });
          }
        },
        {
          type: 'separator'
        },
        {
          role: 'services',
          submenu: []
        },
        {
          type: 'separator'
        },
        {
          role: 'hide'
        },
        {
          role: 'hideothers'
        },
        {
          role: 'unhide'
        },
        {
          type: 'separator'
        },
        {
          role: 'quit'
        }
      ]
    });
    // Edit menu.
    menuTemp[2].submenu.push(
      {
        type: 'separator'
      },
      {
        label: 'Speech',
        submenu: [
          {
            role: 'startspeaking'
          },
          {
            role: 'stopspeaking'
          }
        ]
      }
    );
    // Window menu.
    menuTemp[5].submenu = [
      {
        label: 'Close',
        accelerator: 'CmdOrCtrl+W',
        role: 'close'
      },
      {
        label: 'Minimize',
        accelerator: 'CmdOrCtrl+M',
        role: 'minimize'
      },
      {
        label: 'Zoom',
        role: 'zoom'
      },
      {
        type: 'separator'
      },
      {
        label: 'Bring All to Front',
        role: 'front'
      }
    ];
  }

  function createMenu() {
    var profiles;
    for (var m = 0; m < menuTemp.length; m++) {
      if (menuTemp[m].id === "profiles") {
        profiles = menuTemp[m];
        break;
      }
    }
    profiles.submenu = [];
    profiles.submenu.push(
      {
        label: 'Default',
        type: 'checkbox',
        checked: false,
        id: 'default',
        click: () => {
          $('.dropdown.open').removeClass('open');
        }
      });

    var p = path.join(parseTemplate('{data}'), 'profiles');
    if (isDirSync(p)) {
      var files = fs.readdirSync(p);
      for (var i = 0; i < files.length; i++) {
        if (path.extname(files[i]) === ".json") {
          if (files[i].toLowerCase() === "default.json")
            continue;
          profiles.submenu.push(
            {
              label: path.basename(files[i], ".json"),
              type: 'checkbox',
              checked: false,
              id: path.basename(files[i], ".json").toLowerCase(),
              click: (menuItem, browserWindow, event) => {
                $('.dropdown.open').removeClass('open');
              }
            });
        }
      }
    }
    profiles.submenu.push(
      {
        type: 'separator'
      });
    profiles.submenu.push(
      {
        label: '&Manage...',
        click: () => {
          $('.dropdown.open').removeClass('open');
        },
        accelerator: 'CmdOrCtrl+P'
      });
    menubar = new Menubar(menuTemp);
  }

  createMenu();

  //remote.process.argv
  var manager = new DockManager();
  manager.on('add', (e) => {
    ipcRenderer.send('add', e.id);
    e.panel.pane.innerHTML = `<h1 style="color:white">${e.id}</h1>`;
    menubar.updateItem('file|close connection', { enabled: manager.panels.length > 1 });
  });

  manager.on('remove', (e) => {
    if (manager.panels.length === 1) {
      e.cancel = true;
      menubar.updateItem('file|close connection', { enabled: false });
      return;
    }
    menubar.updateItem('file|close connection', { enabled: (manager.panels.length - 1) > 1 });
    ipcRenderer.send('remove', e.id);
  });

  manager.on('keyup', (e) => {

  });
  manager.on('keydown', (e) => {

  });

  for (var x = 0; x < 10; x++) {
    manager.addPanel("www.shadowmud.com:1030");
  }
  console.log(remote.getGlobal('clients'));

  window.onbeforeunload = () => {
    let tl = manager.panels.length;
    for (var t = 0; t < tl; t++)
      ipcRenderer.send('remove', manager.tabs[t].id);
    $('.dropdown.open').removeClass('open');
  };

</script>

</html>
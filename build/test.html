<!DOCTYPE html>
<html lang="en-US">

<head>
    <link href="../lib/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript">
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script>
        const { ipcRenderer } = require('electron');
        let _id;
        let _close = true;
        let _capture = true;

        function updateContent(txt) {
            let body = document.getElementById('content')
            body.innerHTML = `ClientId: ${_id}<br>Closable: ${_close}<br>Capture Keyboard: ${_capture} ${txt ? '<br>' + txt : ''}`;
        }

        function setId(id) {
            _id = id;
            updateContent();
        }

        function getId() {
            return _id;
        }

        function close() {
            return _close;
        }

        function closeable() {
            if (!_close) {
                var choice = ipcRenderer.sendSync('show-dialog-sync', 'showMessageBox',
                    {
                        type: 'warning',
                        title: 'Unclosable',
                        message: 'Window is unclosable, close anyways?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1
                    });
                if (choice === 0) {
                    _close = true;
                    return true;
                }
            }
            return _close;
        }

        window.addEventListener('dragstart', (e) => {
            if (e.dataTransfer.types && e.dataTransfer.types.indexOf('jimud/tab') !== -1) {
                e.dataTransfer.dropEffect = 'move';
                console.log('Window start');
                console.log(e)
            }
        });
        window.addEventListener('dragleave', (e) => {
            if (e.dataTransfer.types && e.dataTransfer.types.indexOf('jimud/tab') !== -1) {
                e.dataTransfer.dropEffect = 'move';
                console.log('Window leave');
                console.log(e)
                e.preventDefault();
                e.stopPropagation();
            }
        });
        window.addEventListener('dragover', (e) => {
            if (e.dataTransfer.types && e.dataTransfer.types.indexOf('jimud/tab') !== -1) {
                e.dataTransfer.dropEffect = 'move';
                e.preventDefault();
                e.stopPropagation();
                console.log('Window over');
                console.log(e)
            }
        });
        window.addEventListener('dragenter', (e) => {
            if (e.dataTransfer.types && e.dataTransfer.types.indexOf('jimud/tab') !== -1) {
                e.dataTransfer.dropEffect = 'move';
                e.preventDefault();
                e.stopPropagation();
                console.log('Window eneter');
                console.log(e)
            }
        });
        window.addEventListener('dragend', (e) => {
            if (e.dataTransfer.types && e.dataTransfer.types.indexOf('jimud/tab') !== -1) {
                e.dataTransfer.dropEffect = 'move';
                console.log('Window end');
                console.log(e)
            }
        });
        window.addEventListener('drop', (e) => {
            if (e.dataTransfer.types && e.dataTransfer.types.indexOf('jimud/tab') !== -1) {
                e.dataTransfer.dropEffect = 'move';
                e.stopPropagation();
                e.preventDefault();
                console.log('Test Window drop');
                console.log(e)
                const tab = JSON.parse(e.dataTransfer.getData('jimud/tab'));
                console.log(tab);
                var x = e.screenX;
                var y = e.screenY;
                if (tab.offset) {
                    x -= tab.offset.x;
                    y -= tab.offset.y;
                }
                ipcRenderer.send('dock-client', tab.client, { x: x, y: y, clientX: e.clientX, clientY: e.clientY });
                //ipcRenderer.send('dock-client', tab.client, { x: e.screenX - e.clientX, y: e.screenY - e.clientY, clientX: e.clientX, clientY: e.clientY });
            }
        });
        window.addEventListener('blur', e=> {
            console.log('blur');
        });
        window.addEventListener('focus', e=> {
            console.log('focus');
        });        
        document.addEventListener('keydown', (e) => {
            console.log(e);
            if (e.key === 'Alt' && _capture) {
                document.getElementById('menubar').parentNode.focus();
                var menubarNavs = document.querySelectorAll('.menubar-navigation');
                menubarNavs[0].firstElementChild.firstElementChild.focus();
                //menubarNavs[0].firstElementChild.firstElementChild.click();
                e.preventDefault();
                e.stopPropagation();
            }
        });

        function showMenu(el) {
            const rect = el.getBoundingClientRect();
            var menuTemp = [
                //File
                {
                    label: '&File',
                    id: 'file',
                    submenu: [
                        {
                            label: '&New connection',
                            id: 'newConnect',
                            accelerator: 'CmdOrCtrl+Shift+N'
                        },
                        {
                            label: '&New window',
                            id: '',
                            accelerator: 'CmdOrCtrl+Alt+N'
                        },
                        {
                            type: 'separator'
                        },
                        {
                            label: '&Connect',
                            id: 'connect',
                            accelerator: 'CmdOrCtrl+N'
                        },
                        {
                            label: '&Disconnect',
                            id: 'disconnect',
                            accelerator: 'CmdOrCtrl+D',
                            enabled: false
                        },
                        {
                            type: 'separator'
                        },
                        {
                            label: '&Enable parsing',
                            id: 'enableParsing',
                            type: 'checkbox',
                            checked: true
                        },
                        {
                            label: 'E&nable triggers',
                            id: 'enableTriggers',
                            type: 'checkbox',
                            checked: true
                        },
                        {
                            type: 'separator'
                        },
                        {
                            label: 'Ch&aracters...',
                            id: 'characters',
                            accelerator: 'CmdOrCtrl+H'
                        },
                        { type: 'separator' },
                        {
                            label: '&Log',
                            id: 'log',
                            type: 'checkbox',
                            checked: false
                        },
                        {
                            label: '&View logs...'
                        },
                        {
                            type: 'separator'
                        },
                        {
                            label: 'Global &Preferences...',
                            id: 'globalPreferences',
                            accelerator: 'CmdOrCtrl+Comma'
                        },
                        {
                            label: 'Client &Preferences...',
                            id: 'preferences',
                            accelerator: 'CmdOrCtrl+Comma'
                        },
                        {
                            type: 'separator'
                        },
                        {
                            label: 'Clo&se Client',
                            id: 'close',
                            accelerator: 'CmdOrCtrl+W',
                            enabled: false,
                            visible: false
                        },
                        {
                            label: 'E&xit'
                        }
                    ]
                },
                //Edit
                {
                    label: '&Edit',
                    id: 'edit',
                    submenu: [
                        {
                            role: 'undo'
                        },
                        {
                            role: 'redo'
                        },
                        {
                            type: 'separator'
                        },
                        {
                            role: 'cut'
                        },
                        {
                            role: 'copy'
                        },
                        {
                            label: 'Copy as HTML',
                            accelerator: 'CmdOrCtrl+Alt+C',
                            id: 'copyHTML',
                            enabled: false
                        },
                        {
                            label: 'Paste',
                            accelerator: 'CmdOrCtrl+V'
                        },
                        {
                            label: 'Paste special',
                            accelerator: 'CmdOrCtrl+Shift+V'
                        },
                        {
                            role: 'delete'
                        },
                        {
                            label: 'Select All',
                            accelerator: 'CmdOrCtrl+A'
                        },
                        {
                            type: 'separator'
                        },
                        {
                            label: 'Clear'
                        },
                        { type: 'separator' },
                        {
                            label: 'Find',
                            accelerator: 'CmdOrCtrl+F'
                        },
                    ]
                },
                //Profiles
                {
                    label: '&Profiles',
                    id: 'profiles',
                    submenu: []
                },
                //View
                {
                    label: '&View',
                    id: 'view',
                    submenu: [
                        {
                            label: '&Lock',
                            id: 'lock',
                            type: 'checkbox',
                            checked: false
                        },
                        {
                            label: '&Who is on?...'
                        },
                        {
                            type: 'separator'
                        },
                        {
                            label: '&Status',
                            id: 'status',
                            submenu: [
                                {
                                    label: '&Visible',
                                    id: 'statusvisible',
                                    type: 'checkbox',
                                    checked: true
                                },
                                {
                                    label: '&Refresh',
                                    id: 'refresh'
                                },
                                { type: 'separator' },
                                {
                                    label: '&Weather',
                                    id: 'weather',
                                    type: 'checkbox',
                                    checked: true
                                },
                                {
                                    label: '&Limbs',
                                    id: 'limbsmenu',
                                    submenu: [
                                        {
                                            label: '&Visible',
                                            id: 'limbs',
                                            type: 'checkbox',
                                            checked: true
                                        },
                                        { type: 'separator' },
                                        {
                                            label: '&Health',
                                            id: 'limbhealth',
                                            type: 'checkbox',
                                            checked: true
                                        },
                                        {
                                            label: '&Armor',
                                            id: 'limbarmor',
                                            type: 'checkbox',
                                            checked: true
                                        },
                                    ]
                                },
                                {
                                    label: '&Health',
                                    id: 'health',
                                    type: 'checkbox',
                                    checked: true
                                },
                                {
                                    label: '&Experience',
                                    id: 'experience',
                                    type: 'checkbox',
                                    checked: true
                                },
                                {
                                    label: '&Party Health',
                                    id: 'partyhealth',
                                    type: 'checkbox',
                                    checked: true
                                },
                                {
                                    label: '&Combat Health',
                                    id: 'combathealth',
                                    type: 'checkbox',
                                    checked: true
                                },
                                {
                                    label: '&Lag meter',
                                    id: 'lagmeter',
                                    type: 'checkbox',
                                    checked: true
                                }
                            ]
                        },
                        {
                            label: '&Buttons',
                            id: 'buttons',
                            submenu: [
                                {
                                    label: '&Visible',
                                    id: 'buttonsvisible',
                                    type: 'checkbox',
                                    checked: true
                                },
                                { type: 'separator' },
                                {
                                    label: '&Connect',
                                    id: 'connectbutton',
                                    type: 'checkbox',
                                    checked: true
                                },
                                {
                                    label: '&Characters',
                                    id: 'charactersbutton',
                                    type: 'checkbox',
                                    checked: true
                                },
                                {
                                    label: 'Code &editor',
                                    id: 'codeEditorbutton',
                                    type: 'checkbox'
                                },
                                {
                                    label: '&Preferences',
                                    id: 'preferencesbutton',
                                    type: 'checkbox',
                                    checked: true
                                },
                                {
                                    label: '&Log',
                                    id: 'logbutton',
                                    type: 'checkbox',
                                    checked: true
                                },
                                {
                                    label: '&Clear',
                                    id: 'clearbutton',
                                    type: 'checkbox',
                                    checked: true
                                },
                                {
                                    label: '&Lock',
                                    id: 'lockbutton',
                                    type: 'checkbox',
                                    checked: true
                                },
                                {
                                    label: '&Map',
                                    id: 'mapbutton',
                                    type: 'checkbox',
                                    checked: true
                                },
                                {
                                    label: '&User buttons',
                                    id: 'userbutton',
                                    type: 'checkbox',
                                    checked: true
                                },
                            ]
                        },
                        {
                            type: 'separator'
                        },
                        {
                            label: '&Developer Tools',
                            id: 'devtools',
                            submenu: [
                                {
                                    label: '&Toggle Window '
                                },
                                {
                                    label: 'Toggle Active &Client'
                                },
                                {
                                    label: 'Toggle &Both'
                                }
                            ]
                        },
                        {
                            type: 'separator'
                        },
                        {
                            role: 'resetZoom'
                        },
                        {
                            role: 'zoomIn'
                        },
                        {
                            role: 'zoomOut'
                        },
                        {
                            type: 'separator'
                        },
                        {
                            role: 'togglefullscreen'
                        }
                    ]
                },
                //Window
                {
                    role: 'window',
                    id: 'window',
                    submenu: [
                        {
                            label: '&Advanced editor...',
                            id: 'editor',
                            accelerator: 'CmdOrCtrl+E'
                        },
                        {
                            label: '&Chat...',
                            id: 'chat',
                            accelerator: 'CmdOrCtrl+L'
                        },
                        {
                            label: '&Immortal tools...',
                            id: 'immortal',
                            visible: false,
                            accelerator: 'CmdOrCtrl+I'
                        },
                        {
                            label: '&Code editor...',
                            id: 'codeeditor'
                        },
                        {
                            label: '&Map...',
                            accelerator: 'CmdOrCtrl+T'
                        },
                        {
                            label: '&Skills...',
                            id: 'skills',
                            accelerator: 'CmdOrCtrl+S'
                        },
                        {
                            label: '&Command history...',
                            id: 'history',
                            accelerator: 'CmdOrCtrl+Shift+H'
                        },
                        { type: 'separator' }
                    ]
                },
                //Help
                {
                    label: '&Help',
                    role: 'help',
                    id: 'help',
                    submenu: [
                        {
                            label: '&ShadowMUD...'
                        },
                        {
                            label: '&jiMUD...'
                        },
                        {
                            label: '&jiMUD website...'
                        },
                        { type: 'separator' },
                        {
                            label: 'Check for updates...',
                            id: 'updater'
                        },
                        { type: 'separator' },
                        {
                            label: '&About...'
                        }
                    ]
                }
            ];
            ipcRenderer.invoke('show-context', menuTemp, { x: Math.ceil(rect.right) + window.scrollX, y: Math.ceil(rect.top) + window.scrollY });
        }
        /*
 *   This content is licensed according to the W3C Software License at
 *   https://www.w3.org/Consortium/Legal/2015/copyright-software-and-document
 *
 *   File:   menubar-navigation.js
 *
 *   Desc:   Creates a menubar of hierarchical set of links
 */
        class MenubarNavigation {
            constructor(domNode) {
                var linkURL, linkTitle;

                this.domNode = domNode;

                this.menuitems = [];
                this.popups = [];
                this.menuitemGroups = {};
                this.menuOrientation = {};
                this.isPopup = {};
                this.isPopout = {};
                this.openPopups = false;

                this.firstChars = {}; // see Menubar init method
                this.firstMenuitem = {}; // see Menubar init method
                this.lastMenuitem = {}; // see Menubar init method

                this.initMenu(domNode, 0);

                domNode.addEventListener('focusin', this.onMenubarFocusin.bind(this));
                domNode.addEventListener('focusout', this.onMenubarFocusout.bind(this));

                window.addEventListener(
                    'pointerdown',
                    this.onBackgroundPointerdown.bind(this),
                    true
                );

                domNode.querySelector('[role=menuitem]').tabIndex = 0;
            }

            getParentMenuitem(menuitem) {
                var node = menuitem.parentNode;
                if (node) {
                    node = node.parentNode;
                    if (node) {
                        node = node.previousElementSibling;
                        if (node) {
                            if (node.getAttribute('role') === 'menuitem') {
                                return node;
                            }
                        }
                    }
                }
                return false;
            }

            getMenuitems(domNode, depth) {
                var nodes = [];

                var initMenu = this.initMenu.bind(this);
                var popups = this.popups;

                function findMenuitems(node) {
                    var role, flag;

                    while (node) {
                        flag = true;
                        role = node.getAttribute('role');

                        if (role) {
                            role = role.trim().toLowerCase();
                        }

                        switch (role) {
                            case 'menu':
                                node.tabIndex = -1;
                                initMenu(node, depth + 1);
                                flag = false;
                                break;

                            case 'menuitem':
                                if (node.getAttribute('aria-haspopup') === 'true') {
                                    popups.push(node);
                                }
                                nodes.push(node);
                                break;

                            default:
                                break;
                        }

                        if (
                            flag &&
                            node.firstElementChild &&
                            node.firstElementChild.tagName !== 'svg'
                        ) {
                            findMenuitems(node.firstElementChild);
                        }
                        node = node.nextElementSibling;
                    }
                }
                findMenuitems(domNode.firstElementChild);
                return nodes;
            }

            initMenu(menu, depth) {
                var menuitems, menuitem, role;

                var menuId = this.getMenuId(menu);

                menuitems = this.getMenuitems(menu, depth);
                this.menuOrientation[menuId] = this.getMenuOrientation(menu);

                this.isPopup[menuId] = menu.getAttribute('role') === 'menu' && depth === 1;
                this.isPopout[menuId] = menu.getAttribute('role') === 'menu' && depth > 1;

                this.menuitemGroups[menuId] = [];
                this.firstChars[menuId] = [];
                this.firstMenuitem[menuId] = null;
                this.lastMenuitem[menuId] = null;

                for (var i = 0; i < menuitems.length; i++) {
                    menuitem = menuitems[i];
                    role = menuitem.getAttribute('role');

                    if (role.indexOf('menuitem') < 0) {
                        continue;
                    }

                    menuitem.tabIndex = -1;
                    this.menuitems.push(menuitem);
                    this.menuitemGroups[menuId].push(menuitem);
                    this.firstChars[menuId].push(
                        menuitem.textContent.trim().toLowerCase()[0]
                    );

                    menuitem.addEventListener('keydown', this.onKeydown.bind(this));
                    menuitem.addEventListener('click', this.onMenuitemClick.bind(this), {
                        capture: true,
                    });

                    menuitem.addEventListener(
                        'pointerover',
                        this.onMenuitemPointerover.bind(this)
                    );

                    if (!this.firstMenuitem[menuId]) {
                        if (this.hasPopup(menuitem)) {
                            menuitem.tabIndex = 0;
                        }
                        this.firstMenuitem[menuId] = menuitem;
                    }
                    this.lastMenuitem[menuId] = menuitem;
                }
            }

            setFocusToMenuitem(menuId, newMenuitem) {
                this.closePopupAll(newMenuitem);

                if (this.menuitemGroups[menuId]) {
                    this.menuitemGroups[menuId].forEach(function (item) {
                        if (item === newMenuitem) {
                            item.tabIndex = 0;
                            newMenuitem.focus();
                        } else {
                            item.tabIndex = -1;
                        }
                    });
                }
            }

            setFocusToFirstMenuitem(menuId) {
                this.setFocusToMenuitem(menuId, this.firstMenuitem[menuId]);
            }

            setFocusToLastMenuitem(menuId) {
                this.setFocusToMenuitem(menuId, this.lastMenuitem[menuId]);
            }

            setFocusToPreviousMenuitem(menuId, currentMenuitem) {
                var newMenuitem, index;
                const mgl = this.menuitemGroups[menuId].length;
                var mt = 0;
                var index = this.menuitemGroups[menuId].indexOf(currentMenuitem);
                for (var mi = index; mt <= 1 && mi >= 0; mi--) {
                    if (this.menuitemGroups[menuId][mi] === this.firstMenuitem[menuId]) {
                        newMenuitem = this.lastMenuitem[menuId];
                        if (newMenuitem.dataset.disabled) {
                            mi = mgl;
                            mt++;
                        }
                    } else {
                        newMenuitem = this.menuitemGroups[menuId][mi - 1];
                    }
                    if (!newMenuitem.dataset.disabled)
                        break;
                }

                this.setFocusToMenuitem(menuId, newMenuitem);

                return newMenuitem;
            }

            setFocusToNextMenuitem(menuId, currentMenuitem) {
                var newMenuitem, index;
                const mgl = this.menuitemGroups[menuId].length;
                var mt = -1;
                var index = this.menuitemGroups[menuId].indexOf(currentMenuitem);
                for (var mi = index; mt <= 1 && mi < mgl; mi++) {
                    if (this.menuitemGroups[menuId][mi] === this.lastMenuitem[menuId]) {
                        newMenuitem = this.firstMenuitem[menuId];
                        if (newMenuitem.dataset.disabled) {
                            mi = 0;
                            mt++;
                        }
                    } else {
                        newMenuitem = this.menuitemGroups[menuId][mi + 1];
                    }
                    if (!newMenuitem.dataset.disabled)
                        break;
                }
                this.setFocusToMenuitem(menuId, newMenuitem);

                return newMenuitem;
            }

            setFocusByFirstCharacter(menuId, currentMenuitem, char) {
                var start, index;

                char = char.toLowerCase();

                // Get start index for search based on position of currentItem
                start = this.menuitemGroups[menuId].indexOf(currentMenuitem) + 1;
                if (start >= this.menuitemGroups[menuId].length) {
                    start = 0;
                }

                // Check remaining slots in the menu
                index = this.getIndexFirstChars(menuId, start, char);

                // If not found in remaining slots, check from beginning
                if (index === -1) {
                    index = this.getIndexFirstChars(menuId, 0, char);
                }

                // If match was found...
                if (index > -1) {
                    this.setFocusToMenuitem(menuId, this.menuitemGroups[menuId][index]);
                }
            }

            // Utilities

            getIndexFirstChars(menuId, startIndex, char) {
                for (var i = startIndex; i < this.firstChars[menuId].length; i++) {
                    if (char === this.firstChars[menuId][i]) {
                        return i;
                    }
                }
                return -1;
            }

            isPrintableCharacter(str) {
                return str.length === 1 && str.match(/\S/);
            }

            getIdFromAriaLabel(node) {
                var id = node.getAttribute('aria-label');
                if (id) {
                    id = id.trim().toLowerCase().replace(' ', '-').replace('/', '-');
                }
                return id;
            }

            getMenuOrientation(node) {
                var orientation = node.getAttribute('aria-orientation');

                if (!orientation) {
                    var role = node.getAttribute('role');

                    switch (role) {
                        case 'menubar':
                            orientation = 'horizontal';
                            break;

                        case 'menu':
                            orientation = 'vertical';
                            break;

                        default:
                            break;
                    }
                }

                return orientation;
            }

            getMenuId(node) {
                var id = false;
                var role = node.getAttribute('role');

                while (node && role !== 'menu' && role !== 'menubar') {
                    node = node.parentNode;
                    if (node) {
                        role = node.getAttribute('role');
                    }
                }

                if (node) {
                    id = role + '-' + this.getIdFromAriaLabel(node);
                }

                return id;
            }

            getMenu(menuitem) {
                var menu = menuitem;
                var role = menuitem.getAttribute('role');

                while (menu && role !== 'menu' && role !== 'menubar') {
                    menu = menu.parentNode;
                    if (menu) {
                        role = menu.getAttribute('role');
                    }
                }

                return menu;
            }

            // Popup menu methods

            isAnyPopupOpen() {
                for (var i = 0; i < this.popups.length; i++) {
                    if (this.popups[i].getAttribute('aria-expanded') === 'true') {
                        return true;
                    }
                }
                return false;
            }

            setMenubarDataExpanded(value) {
                this.domNode.setAttribute('data-menubar-item-expanded', value);
            }

            isMenubarDataExpandedTrue() {
                return this.domNode.getAttribute('data-menubar-item-expanded') === 'true';
            }

            openPopup(menuId, menuitem) {
                // set aria-expanded attribute
                var popupMenu = menuitem.nextElementSibling;

                if (popupMenu) {
                    var rect = menuitem.getBoundingClientRect();

                    // Set CSS properties
                    if (this.isPopup[menuId]) {
                        popupMenu.parentNode.style.position = 'relative';
                        popupMenu.style.display = 'block';
                        popupMenu.style.position = 'absolute';
                        popupMenu.style.left = (rect.width - 4) + 'px';
                        popupMenu.style.top = '0px';
                        popupMenu.style.zIndex = 100;
                    } else {
                        popupMenu.style.display = 'block';
                        popupMenu.style.position = 'absolute';
                        popupMenu.style.left = '0px';
                        popupMenu.style.top = rect.height + 'px';
                        popupMenu.style.zIndex = 100;
                    }

                    menuitem.setAttribute('aria-expanded', 'true');
                    this.setMenubarDataExpanded('true');
                    return this.getMenuId(popupMenu);
                }

                return false;
            }

            closePopout(menuitem) {
                var menu,
                    menuId = this.getMenuId(menuitem),
                    cmi = menuitem;

                while (this.isPopup[menuId] || this.isPopout[menuId]) {
                    menu = this.getMenu(cmi);
                    cmi = menu.previousElementSibling;
                    menuId = this.getMenuId(cmi);
                    menu.style.display = 'none';
                }
                cmi.focus();
                return cmi;
            }

            closePopup(menuitem) {
                var menu,
                    menuId = this.getMenuId(menuitem),
                    cmi = menuitem;

                if (this.isMenubar(menuId)) {
                    if (this.isOpen(menuitem)) {
                        menuitem.setAttribute('aria-expanded', 'false');
                        menuitem.nextElementSibling.style.display = 'none';
                    }
                } else {
                    menu = this.getMenu(menuitem);
                    cmi = menu.previousElementSibling;
                    cmi.setAttribute('aria-expanded', 'false');
                    cmi.focus();
                    menu.style.display = 'none';
                }

                return cmi;
            }

            doesNotContain(popup, menuitem) {
                if (menuitem) {
                    return !popup.nextElementSibling.contains(menuitem);
                }
                return true;
            }

            closePopupAll(menuitem) {
                if (typeof menuitem !== 'object') {
                    menuitem = false;
                }
                for (var i = 0; i < this.popups.length; i++) {
                    var popup = this.popups[i];
                    if (this.doesNotContain(popup, menuitem) && this.isOpen(popup)) {
                        var cmi = popup.nextElementSibling;
                        if (cmi) {
                            popup.setAttribute('aria-expanded', 'false');
                            cmi.style.display = 'none';
                        }
                    }
                }
            }

            hasPopup(menuitem) {
                return menuitem.getAttribute('aria-haspopup') === 'true';
            }

            isOpen(menuitem) {
                return menuitem.getAttribute('aria-expanded') === 'true';
            }

            isMenubar(menuId) {
                return !this.isPopup[menuId] && !this.isPopout[menuId];
            }

            isMenuHorizontal(menuitem) {
                return this.menuOrientation[menuitem] === 'horizontal';
            }

            hasFocus() {
                return this.domNode.classList.contains('focus');
            }

            // Menu event handlers

            onMenubarFocusin() {
                // if the menubar or any of its menus has focus, add styling hook for hover
                this.domNode.classList.add('focus');
            }

            onMenubarFocusout() {
                // remove styling hook for hover on menubar item
                this.domNode.classList.remove('focus');
            }

            onKeydown(event) {
                var tgt = event.currentTarget,
                    key = event.key,
                    flag = false,
                    menuId = this.getMenuId(tgt),
                    id,
                    popupMenuId,
                    mi;

                switch (key) {
                    case ' ':
                    case 'Enter':
                        if (this.hasPopup(tgt)) {
                            this.openPopups = true;
                            popupMenuId = this.openPopup(menuId, tgt);
                            this.setFocusToFirstMenuitem(popupMenuId);
                        } else {
                            //@TODO better click code
                            if (!tgt.dataset.disabled && tgt.dataset.click) {
                                this.closePopupAll();
                                eval(tgt.dataset.click);
                                this.setMenubarDataExpanded('false');
                            }
                        }
                        flag = true;
                        break;

                    case 'Esc':
                    case 'Escape':
                        this.openPopups = false;
                        mi = this.closePopup(tgt);
                        id = this.getMenuId(mi);
                        this.setMenubarDataExpanded('false');
                        flag = true;
                        break;

                    case 'Up':
                    case 'ArrowUp':
                        if (this.isMenuHorizontal(menuId)) {
                            if (this.hasPopup(tgt)) {
                                this.openPopups = true;
                                popupMenuId = this.openPopup(menuId, tgt);
                                this.setFocusToLastMenuitem(popupMenuId);
                            }
                        } else {
                            this.setFocusToPreviousMenuitem(menuId, tgt);
                        }
                        flag = true;
                        break;

                    case 'ArrowDown':
                    case 'Down':
                        if (this.isMenuHorizontal(menuId)) {
                            if (this.hasPopup(tgt)) {
                                this.openPopups = true;
                                popupMenuId = this.openPopup(menuId, tgt);
                                this.setFocusToFirstMenuitem(popupMenuId);
                            }
                        } else {
                            this.setFocusToNextMenuitem(menuId, tgt);
                        }
                        flag = true;
                        break;

                    case 'Left':
                    case 'ArrowLeft':
                        if (this.isMenuHorizontal(menuId)) {
                            mi = this.setFocusToPreviousMenuitem(menuId, tgt);
                            if (this.isAnyPopupOpen() || this.isMenubarDataExpandedTrue()) {
                                this.openPopup(menuId, mi);
                            }
                        } else {
                            if (this.isPopout[menuId]) {
                                mi = this.closePopup(tgt);
                                id = this.getMenuId(mi);
                                mi = this.setFocusToMenuitem(id, mi);
                            } else {
                                mi = this.closePopup(tgt);
                                id = this.getMenuId(mi);
                                mi = this.setFocusToPreviousMenuitem(id, mi);
                                this.openPopup(id, mi);
                            }
                        }
                        flag = true;
                        break;

                    case 'Right':
                    case 'ArrowRight':
                        if (this.isMenuHorizontal(menuId)) {
                            mi = this.setFocusToNextMenuitem(menuId, tgt);
                            if (this.isAnyPopupOpen() || this.isMenubarDataExpandedTrue()) {
                                this.openPopup(menuId, mi);
                            }
                        } else {
                            if (this.hasPopup(tgt)) {
                                popupMenuId = this.openPopup(menuId, tgt);
                                this.setFocusToFirstMenuitem(popupMenuId);
                            } else {
                                mi = this.closePopout(tgt);
                                id = this.getMenuId(mi);
                                mi = this.setFocusToNextMenuitem(id, mi);
                                this.openPopup(id, mi);
                            }
                        }
                        flag = true;
                        break;

                    case 'Home':
                    case 'PageUp':
                        this.setFocusToFirstMenuitem(menuId, tgt);
                        flag = true;
                        break;

                    case 'End':
                    case 'PageDown':
                        this.setFocusToLastMenuitem(menuId, tgt);
                        flag = true;
                        break;

                    case 'Tab':
                        this.openPopups = false;
                        this.setMenubarDataExpanded('false');
                        this.closePopup(tgt);
                        break;

                    default:
                        if (this.isPrintableCharacter(key)) {
                            this.setFocusByFirstCharacter(menuId, tgt, key);
                            flag = true;
                        }
                        break;
                }

                if (flag) {
                    event.stopPropagation();
                    event.preventDefault();
                }
            }

            onMenuitemClick(event) {
                var tgt = event.currentTarget;
                var menuId = this.getMenuId(tgt);
                if (tgt.dataset.disabled)
                    return;
                if (this.hasPopup(tgt)) {
                    //if (this.isOpen(tgt)) {
                    //this.closePopup(tgt);
                    //} else {
                    this.closePopupAll(tgt);
                    this.openPopup(menuId, tgt);
                    //}
                } else {
                    //@TODO better click code
                    if (!tgt.dataset.disabled) {
                        if (tgt.dataset.click) {
                            this.closePopupAll();
                            eval(tgt.dataset.click);
                            this.setMenubarDataExpanded('false');
                        }
                        this.closePopupAll();
                    }
                }
                event.stopPropagation();
                event.preventDefault();
            }

            onMenuitemPointerover(event) {
                var tgt = event.currentTarget;
                var menuId = this.getMenuId(tgt);

                if (this.hasFocus()) {
                    this.setFocusToMenuitem(menuId, tgt);
                }

                if (!tgt.dataset.disabled && (this.isAnyPopupOpen() || this.hasFocus())) {
                    this.closePopupAll(tgt);
                    if (this.hasPopup(tgt)) {
                        this.openPopup(menuId, tgt);
                    }
                }
            }

            onBackgroundPointerdown(event) {
                if (!this.domNode.contains(event.target)) {
                    this.closePopupAll();
                }
            }
        }

        // Initialize menubar editor
        var menubar;
        window.addEventListener('load', function () {
            var menubarNavs = document.querySelectorAll('.menubar-navigation');
            for (var i = 0; i < menubarNavs.length; i++) {
                menubar = new MenubarNavigation(menubarNavs[i]);
            }
        });
    </script>
    <style>
        html {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            padding: 0;
            background-color: red;
            font-size: 2em;
            color: white;
            border: 5px solid green;
            height: 100%;
            width: 100%;
            margin: 0;
            box-sizing: border-box;
        }

        nav {
            margin: 0;
            padding: 0;
            font: menu;
            white-space: nowrap;
        }

        .menubar-navigation {
            margin: 0;
            padding: 0;
            list-style: none;
            background-color: menu;
        }

        .menubar-navigation li {
            margin: 0;
            padding: 0;
            border: 0 solid black;
            list-style: none;
        }

        .menubar-navigation>li {
            display: inline-block;
            position: relative;
        }

        .menubar-navigation>li li {
            display: block;
        }

        .menubar-navigation>li>[role="menuitem"] {
            display: inline-block;
            margin: 0px;
            padding: 4px;
            padding-left: 5px;
            padding-right: 5px;
            background-color: menu;
            border: 0 solid menu;
            color: black;
            cursor: default;
        }

        .menubar-navigation [role="separator"] {
            padding-top: 3px;
            background-image: url("data:image/svg+xml,%3C%3Fxml version='1.0' encoding='utf-8'%3F%3E%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cline x1='0' y1='6' x2='12' y2='6' style='stroke:rgb(218,220,224);stroke-width:1' /%3E%3C/svg%3E%0A");
            background-size: 10px 10px;
            background-position: center;
            background-repeat: repeat-x;
        }

        .menubar-navigation [role="menu"] [role="menuitem"],
        .menubar-navigation [role="menu"] [role="separator"] {
            display: inline-block;
            width: 12em;
            margin: 0px;
            padding: 4px;
            padding-left: 32px;
            background-color: menu;
            border: 0 solid menu;
            color: black;
            cursor: default;
        }

        .menubar-navigation [role="menu"][data-accelerators]>li>[role="menuitem"],
        .menubar-navigation [role="menu"][data-accelerators]>[role="separator"] {
            padding-right: 100px;
        }

        .menubar-navigation [role="menuitem"] div {
            display: inline-block;
            position: absolute;
            right: 20px;
        }

        .menubar-navigation [role="menuitem"] svg {
            fill: currentcolor;
            stroke: currentcolor;
        }

        .menubar-navigation [role="menuitem"] svg.down {
            padding-left: 0.125em;
        }

        .menubar-navigation [role="menuitem"] svg.right {
            position: absolute;
            padding-top: 0.35em;
            right: 0.75em;
        }

        .menubar-navigation [role="menuitem"] svg.icon {}

        .menubar-navigation [role="menuitem"] .icon {
            position: absolute;
            left: 8px;
            width: 16px;
            height: 16px;
        }

        .menubar-navigation [role="menuitem"][data-disabled="true"] .icon {
            opacity: 0.5;
        }

        .menubar-navigation [role="menu"] {
            display: none;
            position: absolute;
            margin: 0;
            padding: 0;
            padding: 3px 0px;
            border: 1px solid #ccc;
            background-color: menu;
        }

        .menubar-navigation [role="group"] {
            margin: 0;
            padding: 0;
        }

        /* aria-current styling */

        .menubar-navigation>li>[role="menuitem"][aria-current],
        .menubar-navigation>li>[role="menuitem"].aria-current-path {
            padding-bottom: 2px;
            border-bottom: 4px solid #034575;
        }

        .menubar-navigation [role="menu"] [role="menuitem"].aria-current-path,
        .menubar-navigation [role="menu"] [role="menuitem"][aria-current] {
            padding-left: 4px;
            border-left: 4px solid #034575;
        }

        /* focus styling */

        .menubar-navigation.focus {
            padding: 0;
        }

        .menubar-navigation>li>[aria-expanded="true"],
        .menubar-navigation>li>[role="menuitem"]:focus,
        .menubar-navigation>li>[role="menuitem"]:hover {
            outline: none;
            background-color: #E8E8E8;
        }

        .menubar-navigation>li>[role="menuitem"]:focus,
        .menubar-navigation>li>[role="menuitem"]:hover {}

        .menubar-navigation [role="menu"] [aria-expanded="true"],
        .menubar-navigation [role="menu"] [role="menuitem"]:focus,
        .menubar-navigation [role="menu"] [role="menuitem"]:hover {
            outline: none;
            background-color: #E8E8E8;
        }

        .menubar-navigation [role="menu"] [role="menuitem"]:focus,
        .menubar-navigation [role="menu"] [role="menuitem"]:hover {
            padding: 4px;
            padding-left: 32px;
        }

        .menubar-navigation [role="menu"][data-accelerators]>li>[role="menuitem"]:focus,
        .menubar-navigation [role="menu"][data-accelerators]>li>[role="menuitem"]:hover {
            padding: 4px;
            padding-left: 32px;
            padding-right: 100px;
        }

        .menubar-navigation [role="menu"] [role="menuitem"][data-disabled="true"] {
            color: #777;
        }

        .menubar-navigation [role="menu"] [role="menuitem"][data-disabled="true"]:focus,
        .menubar-navigation [role="menu"] [role="menuitem"][data-disabled="true"]:hover {
            background: menu;
        }

        .menubar-navigation>li>[aria-expanded="true"].aria-current-path,
        .menubar-navigation>li>[role="menuitem"].aria-current-path:focus,
        .menubar-navigation>li>[role="menuitem"].aria-current-path:hover,
        .menubar-navigation>li>[role="menuitem"][aria-current]:focus,
        .menubar-navigation>li>[role="menuitem"][aria-current]:hover {
            padding-bottom: 2px;
            border-bottom: 4px solid #034575;
        }

        .menubar-navigation [role="menu"] [aria-expanded="true"].aria-current-path,
        .menubar-navigation [role="menu"] [role="menuitem"].aria-current-path:focus,
        .menubar-navigation [role="menu"] [role="menuitem"].aria-current-path:hover,
        .menubar-navigation [role="menu"] [role="menuitem"][aria-current]:focus,
        .menubar-navigation [role="menu"] [role="menuitem"][aria-current]:hover {
            padding-left: 4px;
            border-left: 4px solid #034575;
        }
    </style>
</head>

<body>
    <nav aria-label="Main menu">
        <ul id="menubar" class="menubar-navigation" role="menubar" aria-label="Main menu">
            <li role="none">
                <div role="menuitem" aria-haspopup="true" aria-expanded="false">
                    File
                </div>
                <ul role="menu" aria-label="File" data-accelerators="true">
                    <li role="none">
                        <div role="menuitem" data-click="updateContent('Test item clicked')">Test item</div>
                    </li>
                    <li role="none">
                        <div role="menuitem" data-disabled="true">Test item disable</div>
                    </li>
                    <li role="none">
                        <div role="menuitem" data-accelerator="Ctrl+T">Test accelerator<div>Ctrl+T</div>
                        </div>
                    </li>
                    <li role="none">
                        <div role="menuitem" data-accelerator="Ctrl+T" data-disabled="true">Test accelerator disable<div>Ctrl+T</div>
                        </div>
                    </li>
                    <li role="separator"></li>
                    <li role="none">
                        <div role="menuitem" aria-haspopup="true" aria-expanded="false">Test sub menu
                            <svg xmlns="http://www.w3.org/2000/svg" class="right" width="6" height="7" viewBox="0 0 9 12">
                                <polygon points="0 1, 0 11, 8 6"></polygon>
                            </svg>
                        </div>
                        <ul role="menu" aria-label="Test sub menu">
                            <li role="none">
                                <div role="menuitem">1</div>
                            </li>
                            <li role="none">
                                <div role="menuitem" data-disabled="true">2</div>
                            </li>
                            <li role="none">
                                <div role="menuitem">3</div>
                            </li>
                        </ul>
                    </li>
                    <li role="none">
                        <div role="menuitem" aria-haspopup="true" aria-expanded="false" data-disabled="true">Test sub menu disabled
                            <svg xmlns="http://www.w3.org/2000/svg" class="right" width="6" height="7" viewBox="0 0 9 12">
                                <polygon points="0 1, 0 11, 8 6"></polygon>
                            </svg>
                        </div>
                        <ul role="menu" aria-label="Test sub menu disabled">
                            <li role="none">
                                <div role="menuitem">1</div>
                            </li>
                            <li role="none">
                                <div role="menuitem" data-disabled="true">2</div>
                            </li>
                            <li role="none">
                                <div role="menuitem">3</div>
                            </li>
                        </ul>
                    </li>
                    <li role="separator"></li>
                    <li role="none">
                        <div role="menuitem" data-checked="true">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 16 16" width="16px" height="16px">
                                <path style=" stroke:none;fill-rule:nonzero;fill-opacity:1;" d="M 12.855469 3.519531 L 6 10.375 L 3.144531 7.519531 L 2.1875 8.480469 L 5.519531 11.8125 L 6 12.269531 L 6.480469 11.8125 L 13.8125 4.480469 Z M 12.855469 3.519531 " />
                            </svg>
                            Test check
                        </div>
                    </li>
                    <li role="none">
                        <div role="menuitem" data-checked="true" data-disabled="true">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 16 16" width="16px" height="16px">
                                <path style=" stroke:none;fill-rule:nonzero;fill-opacity:1;" d="M 12.855469 3.519531 L 6 10.375 L 3.144531 7.519531 L 2.1875 8.480469 L 5.519531 11.8125 L 6 12.269531 L 6.480469 11.8125 L 13.8125 4.480469 Z M 12.855469 3.519531 " />
                            </svg>
                            Test check disabled
                        </div>
                    </li>
                    <li role="separator"></li>
                    <li role="none">
                        <div role="menuitem">
                            <img class="icon" src="../assets/icons/png/profiles.png">
                            Test icon
                        </div>
                    </li>
                    <li role="none">
                        <div role="menuitem" data-disabled="true">
                            <img class="icon" src="../assets/icons/png/profiles.png">
                            Test icon disabled
                        </div>
                    </li>
                </ul>
            </li>
            <li role="none">
                <div role="menuitem" role="menuitem" aria-haspopup="true" aria-expanded="false">
                    Edit
                </div>
                <ul role="menu" aria-label="Edit">
                    <li role="none">
                        <div role="menuitem">
                            Copy
                        </div>
                    </li>
                </ul>
            </li>
        </ul>
    </nav>
    <div id="content"></div>
    <button onclick="_close = !_close;updateContent();">Toggle closable</button>
    <button onclick="_capture = !_capture;updateContent();">Toggle keyboard capture</button>
    <br>
    OS Bg Colors:
    <span style="color:canvastext;background-color: canvas">canvas</span>
    <span style="color:menutext;background-color: menu">menu</span>
    <span style="color:windowtext;background-color: window">window</span>
    <span style="color:buttontext;background-color: buttonface">buttonface</span>
    <br>
    Menu from a button:
    <div tile="Menu" onclick="showMenu(this)" style="
    display:inline-block;
    background: white;
    color: black;
    width: 32px;
    height: 32px;
    text-align: center;
    border: 1px black solid;
    "><i class="fa fa-bars"></i></div>
    <br>
    Custom drag button:
    <div tile="Menu" draggable="true" id="customdrag" style="
    display:inline-block;
    background: white;
    color: black;
    width: 32px;
    height: 16px;
    text-align: center;
    border: 1px black solid;
    -webkit-app-region: drag;
    font-size: 0.72em;
    overflow: hidden;
    position: relative
    "><span style="transform: rotate(-90deg);display: inline-block;position: absolute;
    left: 7px;
    top: -7px;"></span></div>
<!--<i class="fa fa-ellipsis-h"></i>-->
    <script type="text/javascript">
        var drag = document.getElementById('customdrag');
        var _dragStart;
        drag.addEventListener("dragstart", (e) => {
            _dragStart = e;
            e.dataTransfer.dropEffect = 'move';
            e.dataTransfer.effectAllowed = 'move';
            var bounds = drag.getBoundingClientRect();
            e.dataTransfer.setData('jimud/tab', JSON.stringify({ client: _id, clientX: e.clientX, clientY: e.clientY, offset: { x: Math.ceil(bounds.left + (window.outerWidth - document.body.offsetWidth)), y: Math.ceil(bounds.top + (window.outerHeight - document.body.offsetHeight)) } }));
        });
        drag.addEventListener("dragend", (e) => {
            if (e.dataTransfer.dropEffect !== 'move' && (e.clientX < 0 || e.clientY < 0 || e.clientX >= document.body.clientHeight || e.clientY >= document.body.clientWidth)) {
                console.log('Custom drag end');
                console.log(e);
                console.log(_dragStart);
                e.stopPropagation();
                e.preventDefault();
                var x = e.screenX;
                var y = e.screenY;
                var bounds = drag.getBoundingClientRect();
                x -= Math.ceil(bounds.left + (window.outerWidth - document.body.offsetWidth));
                y -= Math.ceil(bounds.top + (window.outerHeight - document.body.offsetHeight));
                ipcRenderer.send('dock-client', _id, { x: x, y: y });
            }
        });

    </script>
</body>

</html>
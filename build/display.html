<!DOCTYPE html>
<html lang="en-US">

    <head>
        <meta charset="UTF-8">
        <title>jiMUD</title>
        <link href="css/main.css" rel="stylesheet" type="text/css" />
        <link href="css/ansi.css" rel="stylesheet" type="text/css" />
        <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css" />
        <link href="css/theme.css" rel="stylesheet" type="text/css" />
        <link id="theme" rel="stylesheet" href="themes/default.css" type="text/css">
        <style>
             ::selection {
                background-color: #3399ff;
                color: white;
            }

             ::selection:window-inactive {
                background-color: #3399ff;
                color: white;
            }
            /*
            #display,
            #display-split {
                -webkit-user-select: none;
                user-select: none;
            }

            .selection-highlight-line span {
                background-color: #3399ff !important;
                color: white !important;
                border-bottom: 1px solid #3399ff !important;
            }

            .selection-highlight {
                background-color: #3399ff !important;
                color: white !important;
                border-bottom: 1px solid #3399ff !important;
                border-top: 1px solid #3399ff !important;
            }
            */
            /*
            .selection-highlight-newline,
            .selection-highlight-line span:last-child {
                padding-right: 2px;
            }

            .selection-highlight-line span:last-child.find-highlight {
                padding-right: 0px !important;
            }

            .selection-highlight.sel-start-end {
                border-top-right-radius: 4px;
            }

            .selection-highlight.sel-end:after {
                content: '';
                width: 40px;
                height: 30px;
                position: absolute;
                bottom: -3px;
                border-top: 0;
            }

            .selection-highlight.sel-end:after {
                border-left: 0;
                -moz-border-radius: 0 0 5px 0;
                -webkit-border-radius: 0 0 5px 0;
                border-radius: 0 0 5px 0;
                left: -41px;
            }

            .selection-highlight.sel-start,
            .selection-highlight-line.sel-start span:first-child {
                border-top-left-radius: 4px;
            }

            .selection-highlight.sel-end-start {
                border-bottom-left-radius: 4px;
            }

            .selection-highlight.sel-end,
            .selection-highlight-line.sel-end span:last-child {
                border-bottom-right-radius: 4px;
            }
            */
        </style>
        <script src="../lib/jquery.min.js"></script>
        <script src="js/jquery.ext.js"></script>
        <script>
            function selectAll() {
                if (document.selection) {
                    var range = document.body.createTextRange();
                    range.moveToElementText(document.getElementById('display'));
                    range.select();
                }
                else if (window.getSelection) {
                    var range = document.createRange();
                    range.selectNode(document.getElementById('display'));
                    window.getSelection().removeAllRanges();
                    window.getSelection().addRange(range);
                }
            }
        </script>
    </head>

    <body>
        <div id="display"></div>
        <script>
            parent.init();
/*
            $(parent.window).on('mouseup', (e) => {
                console.log(e);
            })

            var sel = { s: null, e: null, drag: false, x: null, y: null, sLine: null, eLine: null };

            var selTimer;

            $("#display").on('mousedown', (e) => {
                sel.drag = true;
                var o = getLineOffset(e);
                sel.s = o.x;
                sel.e = sel.s;
                sel.sLine = o.y;
                sel.eLine = o.y;
                sel.x = e.pageX;
                sel.y = e.pageY;
                //updateSelection()
            })

            $("#display").on('mousemove', (e) => {
                if (!sel.drag) return;
                var o = getLineOffset(e);
                sel.e = o.x;
                sel.eLine = o.y;
                sel.x = e.pageX;
                sel.y = e.pageY;
                updateSelection();
            })

            $("#display").on('mouseup', (e) => {
                sel.drag = false;
                var o = getLineOffset(e);
                sel.e = o.x;
                sel.eLine = o.y;
                sel.x = e.pageX;
                sel.y = e.pageY;
                updateSelection();
                if (parent.client.displaySplit)
                    parent.client.displaySplit.fill();
            })

            $("#display").on('mouseleave', (e) => {
                console.log(e);
                console.log(e.buttons);
            });

            $("#display").on('mouseenter', (e) => {
                if (!e.buttons || e.button != 0)
                    sel.drag = false;
                console.log(e);
                console.log(e.buttons);
            });

            function getTextOffset(e) {
                var y = (e.pageY - parent.client.display.offset().top) + parent.client.display.scrollTop();
                y = Math.floor(y / parent.client.character.outerHeight());
                var line = $("#display").children().eq(y);
                if (line.length === 0) {
                    if (y >= $("#display").children().length) {
                        line = $(".line:last-child", $("#display"))
                        p = line.prevAll();
                        x = line.text().length + p.text().length + p.length + 1;
                        return { x: x, y: line.index() };
                    }
                    line = $("#display").children().eq(y);
                }
                var p = line.prevAll();
                var x = (e.pageX - parent.client.display.offset().left) + parent.client.display.scrollLeft();
                x = Math.floor(x / parseFloat(window.getComputedStyle(parent.client.character[0]).width));
                var l = line.text().length;
                if (x > l)
                    x = l + 1;
                x += p.text().length + p.length;
                return { x: x, y: y };
            }

            function getLineOffset(e) {
                var y = (e.pageY - parent.client.display.offset().top) + parent.client.display.scrollTop();
                y = Math.floor(y / parent.client.character.outerHeight());
                var line = $("#display").children().eq(y);
                if (line.length === 0) {
                    if (y >= $("#display").children().length) {
                        line = $(".line:last-child", $("#display"))
                        x = line.text().length + 1;
                        return { x: x, y: line.index() };
                    }
                    line = $("#display").children().eq(y);
                }
                var x = (e.pageX - parent.client.display.offset().left) + parent.client.display.scrollLeft();
                x = Math.floor(x / parseFloat(window.getComputedStyle(parent.client.character[0]).width));
                var l = line.text().length;
                if (x > l)
                    x = l + 1;
                return { x: x, y: y };
            }

            function updateSelection() {
                clearTimeout(selTimer);
                if (sel.sLine === -1 || sel.eLine === -1)
                    return;
                selTimer = setTimeout(function () {
                    clearSelection();
                    var c = $("#display").children();
                    var s, e, ts, lines;
                    var x, y;
                    if (sel.sLine > sel.eLine) {
                        s = $("#display").children().eq(sel.eLine)[0];
                        e = $("#display").children().eq(sel.sLine)[0];
                        ts = getLineSelection(s, e, sel.e, sel.s, $("#display")[0]);
                        lines = $(".line:nth-child(n+" + (sel.eLine + 1) + "):nth-child(-n+" + (sel.sLine + 1) + ")", $("#display")).toArray();
                        x = sel.e;
                        y = sel.s;
                    }
                    else if (sel.sLine < sel.eLine) {
                        s = $("#display").children().eq(sel.sLine)[0];
                        e = $("#display").children().eq(sel.eLine)[0];
                        ts = getLineSelection(s, e, sel.s, sel.e, $("#display")[0]);
                        lines = $(".line:nth-child(n+" + (sel.sLine + 1) + "):nth-child(-n+" + (sel.eLine + 1) + ")", $("#display")).toArray();
                        x = sel.s;
                        y = sel.e;
                    }
                    else {
                        y = 0;
                        x = 0;
                        s = $("#display").children().eq(sel.sLine)[0];
                        e = s;
                        ts = getLineSelection(s, s, Math.min(sel.s, sel.e), Math.max(sel.s, sel.e), $("#display")[0]);
                        lines = [s];
                    }
                    addAnnotationElement(ts, lines[0]);
                    var ll = lines.length - 1;
                    //var el = $(".selection-highlight", lines[0]);
                    //if (x >= y && ll === 1)
                    //$(el[0]).addClass('sel-start sel-end-start');
                    //else
                    //$(el[0]).addClass('sel-start');
                    //var dll = e.dataset ? parseInt(e.dataset.length, 10) : 0;
                    //if (sel.e < dll + 1) {
                    //if (ll === 1)
                    //$(el[el.length - 1]).addClass('sel-end-start sel-end');
                    //else
                    //$(el[el.length - 1]).addClass('sel-start-end');
                    if (ll > 0)
                        addAnnotationElement(ts, lines[ll]);
                    //el = $(".selection-highlight", lines[ll]);
                    //if (ll === 1)
                    //$(el[0]).addClass('sel-end-start sel-start');
                    //else
                    //$(el[0]).addClass('sel-end-start');
                    //if (x >= y && ll === 1)
                    //$(el[el.length - 1]).addClass('sel-end sel-start-end');
                    //else
                    //$(el[el.length - 1]).addClass('sel-end');

                    for (var l = 1; l < ll; l++) {
                        //if (l === 1 && sel.s != 0)
                        //$(lines[l]).addClass('selection-highlight-line sel-start sel-middle');
                        //else if (l === ll - 1 && sel.e < dll + 1)
                        //$(lines[l]).addClass('selection-highlight-line sel-end sel-middle');
                        //else
                        //$(lines[l]).addClass('selection-highlight-line sel-middle');
                        $(lines[l]).addClass('selection-highlight-line');
                    }
                }, 5);
            }

            function clearSelection() {
                $(".selection-highlight-line", $("#display")).removeClass('selection-highlight-line');
                //$(".sel-start", $("#display")).removeClass('sel-start');
                //$(".sel-middle", $("#display")).removeClass('sel-middle');
                //$(".sel-end", $("#display")).removeClass('sel-end');
                $(".selection-highlight", $("#display")).each(function () {
                    $(this).replaceWith(this.innerHTML);
                });
            }

            function getTextNodesIn(node) {
                var textNodes = [];
                if (Array.isArray(node)) {
                    for (var i = 0, len = node.length; i < len; ++i) {
                        //textNodes = textNodes.concat(this.getTextNodesIn(node[i]));
                        textNodes.push.apply(textNodes, this.getTextNodesIn(node[i]));
                    }
                }
                else if (node.nodeType === 3 || node.tagName === "BR") {
                    textNodes.push(node);
                }
                else {
                    var children = node.childNodes;
                    for (var i = 0, len = children.length; i < len; ++i) {
                        //textNodes = textNodes.concat(this.getTextNodesIn(children[i]));
                        textNodes.push.apply(textNodes, this.getTextNodesIn(children[i]));
                    }
                }
                return textNodes;
            }

            function validateTextRange(str, elem) {
                var textRange = document.createRange();

                textRange.selectNodeContents(elem);
                if (str.compareBoundaryPoints(Range.START_TO_END, textRange) <= 0) {
                    return 0;
                }
                else {
                    if (str.compareBoundaryPoints(Range.END_TO_START, textRange) >= 0) {
                        return 0;
                    }
                    else {
                        var startPoints = str.compareBoundaryPoints(Range.START_TO_START, textRange),
                            endPoints = str.compareBoundaryPoints(Range.END_TO_END, textRange);

                        if (startPoints < 0) {
                            if (endPoints < 0) {
                                return 1;
                            }
                            else {
                                return 2;
                            }
                        }
                        else {
                            if (endPoints > 0) {
                                return 3;
                            }
                            else {
                                if (startPoints === 0 && endPoints === 0) {
                                    return 2;
                                }
                                else {
                                    return 4;
                                }
                            }
                        }
                    }
                }
            }

            function getLineSelection(start, end, startO, endO, parent) {
                var range = document.createRange();
                range.selectNodeContents(parent);
                var textNodes = getTextNodesIn(start);
                var charCount = 0, endCharCount;

                for (var i = 0, textNode; textNode = textNodes[i++];) {
                    endCharCount = charCount + (textNode.length || 1);
                    if (startO >= charCount && (startO < endCharCount ||
                        (startO === endCharCount && i <= textNodes.length))) {
                        if (textNode.tagName === "BR")
                            range.setStart(textNode.parentNode, textNode.parentNode.childNodes.length - 1);
                        else
                            range.setStart(textNode, startO - charCount);
                        break;
                    }
                    charCount = endCharCount;
                }

                var textNodes = getTextNodesIn(end);
                var charCount = 0, endCharCount;

                for (var i = 0, textNode; textNode = textNodes[i++];) {
                    endCharCount = charCount + (textNode.length || 1);
                    if (endO <= endCharCount) {
                        if (textNode.tagName === "BR")
                            range.setEnd(textNode.parentNode, textNode.parentNode.childNodes.length - 1);
                        else
                            range.setEnd(textNode, endO - charCount);
                        break;
                    }
                    charCount = endCharCount;
                }
                return range;
            }

            function getTextSelection(el, start, end, parent, offset) {
                var range = document.createRange();
                range.selectNodeContents(parent || el);
                var textNodes = getTextNodesIn(el);
                var foundStart = false;
                var charCount = offset || 0, endCharCount;

                for (var i = 0, textNode; textNode = textNodes[i++];) {
                    endCharCount = charCount + (textNode.length || 1);
                    if (!foundStart && start >= charCount
                        && (start < endCharCount ||
                            (start === endCharCount && i <= textNodes.length))) {
                        if (textNode.tagName === "BR")
                            range.setStart(textNode.parentNode, textNode.parentNode.childNodes.length - 1);
                        else
                            range.setStart(textNode, start - charCount);
                        foundStart = true;
                    }
                    if (foundStart && end <= endCharCount) {
                        if (textNode.tagName === "BR")
                            range.setEnd(textNode.parentNode, textNode.parentNode.childNodes.length - 1);
                        else
                            range.setEnd(textNode, end - charCount);
                        break;
                    }
                    charCount = endCharCount;
                }

                return range;
            }

            function addAnnotationElement(str, elem, id, c) {
                var text, textParent, origText, prevText, nextText, childCount,
                    annotationTextRange,
                    span = document.createElement('span');

                if (elem.tagName === "BR") {
                    span.setAttribute('class', 'selection-highlight selection-highlight-newline');
                    span.innerHTML = "<br>";
                    annotationTextRange = validateTextRange(str, elem);
                    if (annotationTextRange === 1) {
                        text = origText.substring(0, str.endOffset);
                        nextText = origText.substring(str.endOffset);
                    } else if (annotationTextRange === 3) {
                        prevText = origText.substring(0, str.startOffset);
                        text = origText.substring(str.startOffset);
                    } else if (annotationTextRange === 2) {
                        text = origText
                    } else if (annotationTextRange === 4) {
                        prevText = origText.substring(0, str.startOffset);
                        text = origText.substring(str.startOffset, str.endOffset);
                        nextText = origText.substring(str.endOffset);
                    } else if (annotationTextRange === 0) {
                        return;
                    }
                    textParent = elem.parentElement;
                    textParent.replaceChild(span, elem);
                    if (prevText) {
                        var prevDOM = document.createTextNode(prevText);
                        textParent.insertBefore(prevDOM, span);
                    }
                    if (nextText) {
                        var nextDOM = document.createTextNode(nextText);
                        textParent.insertBefore(nextDOM, span.nextSibling);
                    }
                    return;
                }
                else if (elem.nodeType === 3) {
                    if (!id)
                        span.setAttribute('class', 'selection-highlight');
                    else if (c)
                        span.setAttribute('class', 'selection-highlight ' + id + '-child');
                    else
                        span.setAttribute('class', 'selection-highlight ' + id);
                    origText = elem.textContent;
                    annotationTextRange = validateTextRange(str, elem);
                    if (annotationTextRange === 1) {
                        text = origText.substring(0, str.endOffset);
                        nextText = origText.substring(str.endOffset);
                    } else if (annotationTextRange === 3) {
                        prevText = origText.substring(0, str.startOffset);
                        text = origText.substring(str.startOffset);
                    } else if (annotationTextRange === 2) {
                        text = origText
                    } else if (annotationTextRange === 4) {
                        prevText = origText.substring(0, str.startOffset);
                        text = origText.substring(str.startOffset, str.endOffset);
                        nextText = origText.substring(str.endOffset);
                    } else if (annotationTextRange === 0) {
                        return;
                    }
                    span.textContent = text;
                    textParent = elem.parentElement;
                    textParent.replaceChild(span, elem);
                    if (prevText) {
                        var prevDOM = document.createTextNode(prevText);
                        textParent.insertBefore(prevDOM, span);
                    }
                    if (nextText) {
                        var nextDOM = document.createTextNode(nextText);
                        textParent.insertBefore(nextDOM, span.nextSibling);
                    }
                    return;
                }
                childCount = elem.childNodes.length;
                for (var i = 0; i < childCount; i++) {
                    var elemChildNode = elem.childNodes[i];
                    if (!elemChildNode.tagName ||
                        !(elemChildNode.tagName === 'SPAN' &&
                            elemChildNode.classList.contains('selection-highlight'))) {
                        this.addAnnotationElement(str, elem.childNodes[i], id, true);
                    }
                    childCount = elem.childNodes.length;
                }
            }

            function getSelection() {
                if (!sel || sel.s === null) return "";
                return $("<div></div>").append(getTextSelection($("#display")[0], Math.min(sel.s, sel.e), Math.max(sel.s, sel.e), $("#display")[0]).cloneContents()).innerText();
            }
            */
        </script>
    </body>

</html>
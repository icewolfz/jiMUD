<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>Immortal Tools</title>
    <link rel="shortcut icon" href="../assets/icons/png/ied.png" />
    <link href="../lib/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/immortal.css" rel="stylesheet" type="text/css" />
    <link href="css/form.css" rel="stylesheet" type="text/css" />
    <link href="../lib/datatables.min.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript">
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="../lib/jquery.min.js" type="text/javascript"></script>
    <script src="../lib/bootstrap.min.js" type="text/javascript"></script>
    <script src="../lib/datatables.min.js" type="text/javascript"></script>
    <script src="../lib/datatables.scrollresize.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        if (window.module) module = window.module;
        //spell-checker:ignore hellip datatable, datatables, scrollresize, prefs, unref, toggledevtools, readdir, mountpoints, estart, showhidden, extname, prepend, mkdir
        //spell-checker:ignore keypress, haspopup, labelledby, tabindex, tablist, tabpanel
        const { IED, ItemState } = require('./js/ied');
        const { TempType, IEDCmdStatus, IEDError } = require('./js/types');
        const { ipcRenderer, shell, clipboard } = require('electron');
        const remote = require('@electron/remote');
        const { Menu, MenuItem } = remote;
        const { parseTemplate, existsSync, formatSize, walk } = require('./js/library');
        const { Settings } = require('./js/settings');
        const { Menubar } = require('./js/menubar');
        const fs = require('fs-extra');
        const path = require('path');
        const nodeDiskInfo = require('node-disk-info');
        const moment = require('moment');

        var chokidar = require('chokidar');

        //#region Variables
        var _ied, options;
        var _local = {}, _remote = {}, _downloads = {};
        var info = { localDirs: 0, localFiles: 0, remoteDirs: 0, remoteFiles: 0, uploads: 0, downloads: 0, active: 0 };
        var localTable, remoteTable, queueTable, key = '', keyClearID;
        var logView;
        var watcher;
        var dragging = false, btmDragging = false;
        var _localDrag, _remoteDrag, _progressCancel = false;
        var _updating = 0;
        var _remove, _removeID;
        var _qUpdate, _qUpdateID;
        var _qUpdateTracker;
        var _focusRemote, _focusLocal;
        var _prefs;
        var _queue = 0;
        //#endregion
        var menubar = new Menubar([
            {
                label: '&File',
                id: 'file',
                submenu: [
                    {
                        label: '&Upload',
                        accelerator: 'CmdOrCtrl+U',
                        enabled: false,
                        click: upload
                    },
                    {
                        label: '&Download',
                        accelerator: 'CmdOrCtrl+D',
                        enabled: false,
                        click: download
                    },
                    { type: 'separator' },
                    {
                        label: '&Preferences...',
                        accelerator: 'CmdOrCtrl+Comma',
                        click: () => {
                            _prefs = window.open('immortal.prefs.html', 'modal-immortal-' + window.opener.getId(), 'backgroundColor=#fff,height=320,width=600,icon=' + path.join(__dirname, '../assets/icons/png/preferences.png'));
                        }
                    },
                    { type: 'separator' },
                    {
                        label: '&Close',
                        click: () => { window.close(); }
                    }
                ]
            },
            {
                label: '&Queue',
                submenu: [
                    {
                        label: '&Start',
                        enabled: false,
                        click: queueStart
                    },
                    {
                        label: '&Pause',
                        enabled: false,
                        click: queuePause
                    },
                    {
                        label: '&Stop',
                        enabled: false,
                        click: queueStop
                    },
                    { type: 'separator' },
                    {
                        label: 'Select &all',
                        click: () => {
                            queueTable.rows().select();
                        }
                    },
                    {
                        label: '&Reset all',
                        accelerator: 'CmdOrCtrl+R',
                        click: () => { _ied.reset(); }
                    },
                ]
            },
            {
                label: '&Edit',
                submenu: [
                    {
                        label: '&Refresh all',
                        accelerator: 'F5',
                        click: () => {
                            updateLocal();
                            _ied.getDir((!options.remote || options.remote.length === 0) ? '.' : options.remote);
                        }
                    },
                    { type: 'separator' },
                    {
                        label: '&Local',
                        submenu: [
                            {
                                label: '&Refresh',
                                accelerator: 'CmdOrCtrl+F5',
                                click: () => {
                                    updateLocal();
                                }
                            },
                            { type: 'separator' },
                            {
                                label: '&Copy full path',
                                click: () => {
                                    var selected = localTable.rows({ selected: true }).data().pluck('path');
                                    clipboard.writeText(selected.join('\n'), 'selection');
                                    clipboard.writeText(selected.join('\n'));
                                }
                            },
                            { type: 'separator' },
                            {
                                label: '&Rename',
                                enabled: false,
                                accelerator: 'CmdOrCtrl+F2',
                                click: renameLocal
                            },
                            {
                                label: '&Delete',
                                enabled: false,
                                accelerator: 'CmdOrCtrl+Delete',
                                click: deleteLocal
                            },
                            { type: 'separator' },
                            {
                                label: '&New file',
                                accelerator: 'CmdOrCtrl+F',
                                click: newLocalFile
                            },
                            {
                                label: '&New directory',
                                accelerator: 'CmdOrCtrl+N',
                                click: newFolderLocal
                            },
                            { type: 'separator' },
                            {
                                label: '&Select all',
                                accelerator: 'CmdOrCtrl+Alt+A',
                                click: () => {
                                    localTable.rows().select();
                                }
                            },
                            { type: 'separator' },
                            {
                                label: '&Reveal in explorer...',
                                enabled: false,
                                accelerator: 'CmdOrCtrl+X',
                                click: () => {
                                    var data = localTable.rows({ selected: true }).data().pluck('path');
                                    for (var d = 0, dl = data.length; d < dl; d++)
                                        shell.showItemInFolder(data[d]);
                                }
                            },

                            { type: 'separator' },
                            {
                                label: '&Open...',
                                enabled: false,
                                accelerator: 'CmdOrCtrl+O',
                                click: () => {
                                    var data = localTable.rows({ selected: true }).data().pluck('path');
                                    for (var d = 0, dl = data.length; d < dl; d++)
                                        openItem(data[d]);
                                }
                            },
                            {
                                label: 'Open &with editor...',
                                enabled: false,
                                accelerator: 'CmdOrCtrl+Shift+E',
                                click: () => {
                                    var data = localTable.rows({ selected: true }).data().pluck('path');
                                    for (var d = 0, dl = data.length; d < dl; d++) {
                                        if (_remote[path.basename(data[d])])
                                            openEditor(data[d], options.remote + '/' + path.basename(data[d]));
                                        else
                                            openEditor(data[d]);
                                    }
                                }
                            },
                            {
                                label: 'Open &with external editor...',
                                enabled: false,
                                accelerator: 'CmdOrCtrl+Alt+E',
                                click: () => {
                                    var data = localTable.rows({ selected: true }).data().pluck('path');
                                    const child_process = require('child_process');
                                    for (var d = 0, dl = data.length; d < dl; d++) {
                                        var p = child_process.spawn(options.editor, [data[d]], { detached: true, stdio: ['ignore', 'ignore', 'ignore'] });
                                        p.unref();
                                    }
                                }
                            }
                        ]
                    },
                    {
                        label: '&Remote',
                        enabled: true,
                        submenu: [
                            {
                                label: '&Refresh',
                                accelerator: 'CmdOrCtrl+Shift+F5',
                                click: () => {
                                    if ($('#remote-list').hasClass('focused'))
                                        _ied.getDir((!options.remote || options.remote.length === 0) ? '.' : options.remote);
                                }
                            },
                            { type: 'separator' },
                            {
                                label: '&Goto',
                                enabled: false,
                                accelerator: 'CmdOrCtrl+G',
                                click: () => { doCommandFirst('goto'); }
                            },
                            {
                                label: '&Change to directory',
                                enabled: false,
                                click: () => {
                                    var selected = remoteTable.rows({ selected: true }).data();
                                    if (!selected.length) return;
                                    if (selected[0].size === -2)
                                        window.opener.client.sendCommand(`cd ${selected[0].path}`);
                                    else
                                        window.opener.client.sendCommand(`cd ${path.dirname(selected[0].path)}`);
                                }
                            },
                            { type: 'separator' },
                            {
                                label: '&Update',
                                enabled: false,
                                // accelerator: "CmdOrCtrl+U",
                                click: () => { doCommand('update'); }
                            },
                            {
                                label: '&Renew',
                                enabled: false,
                                //accelerator: "CmdOrCtrl+U",
                                click: () => { doCommand('renew'); }
                            },
                            {
                                label: '&Clone',
                                enabled: false,
                                //accelerator: "CmdOrCtrl+U",
                                click: () => { doCommand('clone'); }
                            },
                            //clone x...
                            {
                                label: '&Dest',
                                enabled: false,
                                //accelerator: "CmdOrCtrl+U",
                                click: () => { doCommand('dest', true); }
                            },
                            {
                                label: '&Backup',
                                enabled: false,
                                accelerator: 'CmdOrCtrl+B',
                                click: doBackup
                            },
                            {
                                label: '&Copy full path',
                                enabled: false,
                                click: () => {
                                    var selected = remoteTable.rows({ selected: true }).data().pluck('path');
                                    clipboard.writeText(selected.join('\n'), 'selection');
                                    clipboard.writeText(selected.join('\n'));
                                }
                            },
                            { type: 'separator' },
                            {
                                label: '&Rename',
                                enabled: false,
                                accelerator: 'CmdOrCtrl+ShiftF2',
                                click: renameRemote
                            },
                            {
                                label: '&Delete',
                                enabled: false,
                                accelerator: 'CmdOrCtrl+Shift+Delete',
                                click: deleteRemote
                            },
                            {
                                label: '&New directory',
                                accelerator: 'CmdOrCtrl+Shift+N',
                                click: newFolderRemote
                            },
                            { type: 'separator' },
                            {
                                label: '&Select all',
                                accelerator: 'CmdOrCtrl+Shift+A',
                                click: () => {
                                    remoteTable.rows().select();
                                }
                            },
                            { type: 'separator' },
                            {
                                label: '&Edit...',
                                accelerator: 'CmdOrCtrl+Shift+O',
                                click: openRemoteWithEditor
                            },
                        ]
                    },
                    { type: 'separator' },
                    {
                        label: '&Clear log',
                        click: () => {
                            logView.html('');
                        }
                    }
                ]
            },
            {
                label: '&View',
                submenu: [
                    {
                        label: '&Show queue and log',
                        type: 'checkbox',
                        accelerator: 'CmdOrCtrl+Q',
                        click: () => { toggleQueue(); }
                    },
                    {
                        label: 'Sync folders',
                        type: 'checkbox',
                        accelerator: 'CmdOrCtrl+Shift+S',
                        click: () => { toggleSync(); }
                    },
                    { type: 'separator' },
                    {
                        label: '&Editor',
                        accelerator: 'CmdOrCtrl+E',
                        click: () => {
                            openEditor();
                        }
                    },
                    {
                        label: 'E&xternal editor',
                        accelerator: 'CmdOrCtrl+Alt+E',
                        click: () => {
                            shell.openPath(options.editor);
                        }
                    },
                    { type: 'separator' },
                    {
                        label: '&Toggle Developer Tools',
                        click: () => {
                            window.toggleDevTools();
                        }
                    },
                    {
                        type: 'separator'
                    },
                    {
                        role: 'resetZoom'
                    },
                    {
                        role: 'zoomIn'
                    },
                    {
                        role: 'zoomOut'
                    },
                ]
            },

        ]);


        (function () {
            /*
                     * Natural Sort algorithm for Javascript - Version 0.7 - Released under MIT license
                     * Author: Jim Palmer (based on chunking idea from Dave Koelle)
                     * Contributors: Mike Grier (mgrier.com), Clint Priest, Kyle Adams, guillermo
                     * See: http://js-naturalsort.googlecode.com/svn/trunk/naturalSort.js
                     */
            function naturalSort(a, b, html) {
                var re = /(^-?[0-9]+(\.?[0-9]*)[df]?e?[0-9]?%?$|^0x[0-9a-f]+$|[0-9]+)/gi,
                    sre = /(^[ ]*|[ ]*$)/g,
                    dre = /(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[/-]\d{1,4}[/-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,
                    hre = /^0x[0-9a-f]+$/i,
                    ore = /^0/,
                    htmre = /(<([^>]+)>)/ig,
                    // convert all to strings and trim()
                    x = a.toString().replace(sre, '') || '',
                    y = b.toString().replace(sre, '') || '';
                // remove html from strings if desired
                if (!html) {
                    x = x.replace(htmre, '');
                    y = y.replace(htmre, '');
                }
                // chunk/tokenize
                var xN = x.replace(re, '\0$1\0').replace(/\0$/, '').replace(/^\0/, '').split('\0'),
                    yN = y.replace(re, '\0$1\0').replace(/\0$/, '').replace(/^\0/, '').split('\0'),
                    // numeric, hex or date detection
                    xD = parseInt(x.match(hre), 10) || (xN.length !== 1 && x.match(dre) && Date.parse(x)),
                    yD = parseInt(y.match(hre), 10) || xD && y.match(dre) && Date.parse(y) || null;

                // first try and sort Hex codes or Dates
                if (yD) {
                    if (xD < yD) {
                        return -1;
                    }
                    else if (xD > yD) {
                        return 1;
                    }
                }

                // natural sorting through split numeric strings and default strings
                for (var cLoc = 0, numS = Math.max(xN.length, yN.length); cLoc < numS; cLoc++) {
                    // find floats not starting with '0', string or 0 if not defined (Clint Priest)
                    var oFxNcL = !(xN[cLoc] || '').match(ore) && parseFloat(xN[cLoc], 10) || xN[cLoc] || 0;
                    var oFyNcL = !(yN[cLoc] || '').match(ore) && parseFloat(yN[cLoc], 10) || yN[cLoc] || 0;
                    // handle numeric vs string comparison - number < string - (Kyle Adams)
                    if (isNaN(oFxNcL) !== isNaN(oFyNcL)) {
                        return (isNaN(oFxNcL)) ? 1 : -1;
                    }
                    // rely on string comparison if different types - i.e. '02' < 2 != '02' < '2'
                    else if (typeof oFxNcL !== typeof oFyNcL) {
                        oFxNcL += '';
                        oFyNcL += '';
                    }
                    if (typeof oFxNcL === 'string') {
                        oFxNcL = oFxNcL.toLowerCase();
                        oFyNcL = oFyNcL.toLowerCase();
                    }
                    if (oFxNcL < oFyNcL) {
                        return -1;
                    }
                    if (oFxNcL > oFyNcL) {
                        return 1;
                    }
                }
                return 0;
            }

            function fileSort(a, b) {
                if (_local[a].size === -2 && _local[b].size != -2)
                    return -1;
                if (_local[a].size != -2 && _local[b].size === -2)
                    return 1;
                return naturalSort(a, b, false);
            }

            function rFileSort(a, b) {
                if (_remote[a].size === -2 && _remote[b].size != -2)
                    return -1;
                if (_remote[a].size != -2 && _remote[b].size === -2)
                    return 1;
                return naturalSort(a, b, false);
            }

            jQuery.extend(jQuery.fn.dataTableExt.oSort, {
                'file-asc': function (a, b) {
                    return fileSort(a, b);
                },

                'file-desc': function (a, b) {
                    return fileSort(a, b) * -1;
                },

                'rFile-asc': function (a, b) {
                    return rFileSort(a, b);
                },

                'rFile-desc': function (a, b) {
                    return rFileSort(a, b) * -1;
                },

                'moment-asc': function (a, b) {
                    if (moment(a).isBefore(b))
                        return -1;
                    if (moment(b).isBefore(a))
                        return 1;
                    return 0;
                },

                'moment-desc': function (a, b) {
                    if (moment(a).isBefore(b))
                        return 1;
                    if (moment(b).isBefore(a))
                        return -1;
                    return 0;
                },

            });

            jQuery.fn.dataTable.ext.type.order['file-size-pre'] = function (data) {
                var matches = data.match(/^(\d+(?:\.\d+)?)\s*([a-z]+)/i);
                var multipliers;

                if (process.platform === 'darwin')
                    multipliers = {
                        b: 1,
                        bytes: 1,
                        kb: 1000,
                        kib: 1024,
                        mb: 1000000,
                        mib: 1048576,
                        gb: 1000000000,
                        gib: 1073741824,
                        tb: 1000000000000,
                        tib: 1099511627776,
                        pb: 1000000000000000,
                        pib: 1125899906842624
                    };
                else
                    multipliers = {
                        b: 1,
                        bytes: 1,
                        kb: 1024,
                        kib: 1024,
                        mb: 1048576,
                        mib: 1048576,
                        gb: 1073741824,
                        gib: 1073741824,
                        tb: 1099511627776,
                        tib: 1099511627776,
                        pb: 1125899906842624,
                        pib: 1125899906842624
                    };

                if (matches) {
                    var multiplier = multipliers[matches[2].toLowerCase()];
                    return parseFloat(matches[1]) * multiplier;
                } else {
                    return -1;
                }
            };
        }());

        function loadOptions(data) {
            if (!data)
                options = window.opener.client.options.extensions.immortal;
            else
                options = data;
            if (!options) {
                options = {
                    'local': '',
                    'remote': '',
                    'editor': '',
                    'bufferSize': 0,
                    'openEditor': true,
                    'openExternalEditor': false,
                    'queueSize': 250,
                    'localSize': 400,
                    'syncFolders': true,
                    'showQueue': true,
                    'showHidden': false,
                    'uploadOnChange': false,
                    'debug': false,
                    'logErrors': false,
                    'showErrorsExtended': false,
                    'tempFile': TempType.extension,
                    'focusOnFinished': true,
                    'selectOnFinished': true,
                    'compress': true
                };
                saveOptions();
            }
            if (!Object.prototype.hasOwnProperty.call(options, 'compress'))
                options.compress = true;
            if (!Object.prototype.hasOwnProperty.call(options, 'focusOnFinished'))
                options.focusOnFinished = true;
            if (!Object.prototype.hasOwnProperty.call(options, 'selectOnFinished'))
                options.selectOnFinished = true;
            if (options.localSize < 202)
                options.localSize = 202;

            $('#local').css('width', options.localSize);
            $('#remote').css('left', options.localSize);


            $('#bottom').css('height', options.queueSize);
            $('#main').css('bottom', options.queueSize);

            menubar.updateItem('view|sync folders', { checked: options.syncFolders });
            if (options.syncFolders)
                $('#btn-sync').addClass('active');
            else
                $('#btn-sync').removeClass('active');
            menubar.updateItem('edit|external editor', { enabled: options.editor && options.editor.length > 0 });
            menubar.updateItem('view|show queue and log', { checked: options.showQueue });
            if (options.showQueue) {
                $('#btn-queue').addClass('active');
                $('#bottom').css('display', '');
                $('#main').css('bottom', (options.queueSize + 26) + 'px');
            }
            else {
                $('#btn-queue').removeClass('active');
                $('#bottom').css('display', 'none');
                $('#main').css('bottom', '28px');
            }
            if (options.openEditor)
                $('#btn-editor-remote').addClass('active');
            else
                $('#btn-editor-remote').removeClass('active');
            doUpdate(14);
        }

        function saveOptions() {
            if (_ied) {
                _ied.local = options.local;
                _ied.remote = options.remote;
                _ied.bufferSize = options.bufferSize;
                _ied.useTemp = options.tempFile;
                _ied.compressUpload = options.compress;
                _ied.compressDownload = options.compress;
                _ied.compressDir = options.compress;
            }
            window.opener.client.options.extensions.immortal = options;
            window.opener.client.saveOptions();
        }

        function updateLocal(p) {
            if (!p || p.length === 0)
                p = options.local || ipcRenderer.sendSync('get-app-sync', 'getPath', 'downloads');
            else if (!existsSync(p))
                p = ipcRenderer.sendSync('get-app-sync', 'getPath', 'downloads');
            options.local = p;
            createWatcher();
            saveOptions();
            var parts = p.split(path.sep);
            if (p.endsWith(path.sep))
                parts.pop();
            var dir = fs.readdirSync(p);
            var dirs = [];
            var all = [];
            _local = {};
            var file;
            for (var d = 0, dl = dir.length; d < dl; d++) {
                try {
                    file = IED.getFileInfo(path.join(p, dir[d]));
                }
                catch (error) {
                    logError(error);
                    continue;
                }
                if (file.hidden && !options.showHidden)
                    continue;
                if (file.size === -2)
                    dirs.push(file);
                all.push(file);
                _local[file.name] = file;
            }
            info.localDirs = dirs.length;
            info.localFiles = all.length - dirs.length;
            $('#local-path').val(p);
            $('#local-navigate').empty();
            nodeDiskInfo.getDiskInfo().then((drives) => {
                var paths = [];
                var found = false;
                var c = '', pt, d, dl, pl, cl;
                if (drives.length > 0) {
                    for (d = 0, dl = drives.length; d < dl; d++) {
                        if (drives[d].mounted.length === 0)
                            continue;
                        var sd = drives[d].mounted.split(path.sep);
                        c = '';
                        for (pt = 0, pl = sd.length; pt < pl; pt++) {
                            c = path.join(c, sd[pt], path.sep);
                            if (c.toLowerCase() === parts[0].toLowerCase() + path.sep) {
                                found = true;
                                if (pt === 0)
                                    paths.push({ drive: true, path: c, name: sd[pt], count: pt, open: parts.length === 1 });
                                else if (sd[pt].length > 0)
                                    paths.push({ path: c, name: sd[pt], count: pt, open: parts.length === 1 });
                            }
                            else if (pt === 0)
                                paths.push({ drive: true, path: c, name: sd[pt], count: pt });
                            else if (sd[pt].length > 0)
                                paths.push({ path: c, name: sd[pt], count: pt });
                        }
                    }
                }
                c = found ? c = path.join(parts[0], path.sep) : '';
                for (pt = found ? 1 : 0, pl = parts.length; pt < pl; pt++) {
                    c = path.join(c, parts[pt], path.sep);
                    if (pt === pl - 1)
                        paths.push({ path: c, name: parts[pt], count: pt, open: true });
                    else
                        paths.push({ path: c, name: parts[pt], count: pt });
                }
                for (d = 0, dl = dirs.length; d < dl; d++) {
                    paths.push({ path: dirs[d].path, name: dirs[d].name, count: pt });
                }

                paths.sort(function compare(a, b) {
                    if (a.path.toUpperCase() < b.path.toUpperCase())
                        return -1;
                    if (a.path.toUpperCase() > b.path.toUpperCase())
                        return 1;
                    return 0;
                });
                $('#local-navigate').empty();
                for (c = 0, cl = paths.length; c < cl; c++) {
                    if (paths[c].drive && paths[c].open)
                        $('#local-navigate').append(`<li><a href="#" class="active" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-server"></i> ${paths[c].name}</a></li>`);
                    else if (paths[c].drive)
                        $('#local-navigate').append(`<li><a href="#" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-server"></i> ${paths[c].name}</a></li>`);
                    else if (paths[c].open)
                        $('#local-navigate').append(`<li><a href="#" class="active" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-folder-open-o"></i> ${paths[c].name}</a></li>`);
                    else
                        $('#local-navigate').append(`<li><a href="#" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-folder-o"></i> ${paths[c].name}</a></li>`);
                }
            }).catch((error) => {
                if (error)
                    logMessage(error);
            });
            localTable.clear().rows.add(all);
            $('#btn-local-up').prop('disabled', path.dirname(p) === p || path.dirname === path.join(p, path.sep));
            $('#local-list_wrapper .dataTables_scrollBody')[0].scrollTop = 0;
            doUpdate(275);
        }

        function updateRemote(p, dir) {
            options.remote = p;
            saveOptions();
            var dirs = [];
            var all = [];
            var parts = p.split('/');
            if (p.endsWith('/'))
                parts.pop();
            _remote = {};
            info.remoteDirs = 0;
            info.remoteFiles = 0;
            var file;
            var paths = [];
            var c = [], d, dl, cl;
            var pre = (p === '/' ? '' : p) + '/';
            for (d = 0, dl = dir.length; d < dl; d++) {
                file = {
                    name: dir[d].file,
                    path: pre + dir[d].file,
                    size: dir[d].size,
                    type: path.extname(dir[d].file),
                    date: dir[d].date * 1000,
                    hidden: dir[d].file[0] === '.',
                    type2: 0
                };
                if (file.hidden && !options.showHidden)
                    continue;
                if (file.size === -2) {
                    file.type = 'Directory';
                    dirs.push(file);
                    info.remoteDirs++;
                    file.type2 = -2;
                }
                else
                    info.remoteFiles++;

                all.push(file);
                _remote[file.name] = file;
            }
            $('#remote-path').val(p);

            setTimeout(() => {
                for (var pt = 0, pl = parts.length; pt < pl; pt++) {
                    c.push(parts[pt]);
                    if (pt === 0)
                        paths.push({ path: '/', name: '/', count: pt, open: pt === pl - 1 });
                    else
                        paths.push({ path: c.join('/'), name: parts[pt], count: pt, open: pt === pl - 1 });
                }
                for (d = 0, dl = dirs.length; d < dl; d++) {
                    paths.push({ path: dirs[d].path, name: dirs[d].name, count: pt });
                }

                paths.sort(function compare(a, b) {
                    if (a.path.toUpperCase() < b.path.toUpperCase())
                        return -1;
                    if (a.path.toUpperCase() > b.path.toUpperCase())
                        return 1;
                    return 0;
                });
                $('#remote-navigate').empty();
                var str = '';
                for (c = 0, cl = paths.length; c < cl; c++) {
                    if (paths[c].drive && paths[c].open)
                        str += `<li><a href="#" class="active" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-server"></i> ${paths[c].name}</a></li>`;
                    else if (paths[c].drive)
                        str += `<li><a href="#" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-server"></i> ${paths[c].name}</a></li>`;
                    else if (paths[c].open)
                        str += `<li><a href="#" class="active" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-folder-open-o"></i> ${paths[c].name}</a></li>`;
                    else
                        str += `<li><a href="#" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-folder-o"></i> ${paths[c].name}</a></li>`;
                }
                $('#remote-navigate').append(str);
            });
            remoteTable.clear().rows.add(all);
            doUpdate(277);
            $('#remote-list_wrapper .dataTables_scrollBody')[0].scrollTop = 0;
            $('#btn-remote-up').prop('disabled', path.dirname(p) === p || path.dirname === path.join(p, path.sep));
        }

        function logMessage(msg) {
            if (!msg) return;
            logView.html(logView.html() + msg.toString() + '<br>');
            doUpdate(32);
        }

        function logError(error) {
            if (!error) return;
            var msg;
            if (error.stack && options.showErrorsExtended)
                msg = error.stack;
            else if (error instanceof TypeError)
                msg = error.name + ': ' + error.message;
            else if (error instanceof Error)
                msg = error.name + ': ' + error.message;
            else if (error.message)
                msg = error.message;
            else
                msg = error;
            if (options.debug)
                console.error(error);
            if (options.logErrors) {
                if (!options.showErrorsExtended) {
                    if (error.stack)
                        msg = error.stack;
                    else {
                        error = new Error(error || 'Unknown');
                        msg = error.stack;
                    }
                }
                else if (!err.stack) {
                    error = new Error(error || 'Unknown');
                    msg = error.stack;
                }
                fs.writeFileSync(parseTemplate(path.join('{data}', 'jimud.error.log')), 'Immortal Tools: ' + new Date().toLocaleString() + '\n', { flag: 'a' });
                fs.writeFileSync(parseTemplate(path.join('{data}', 'jimud.error.log')), msg + '\n', { flag: 'a' });
            }
        }

        var updatingMenu = false;

        async function updateMenu() {
            if (updatingMenu) return;
            updatingMenu = true;
            key = '';

            var localSelected = false;
            var remoteSelected = false;
            var queueSelected = false;

            var data = localTable.rows({ selected: true }).data().pluck('size');
            localSelected = data.length != 0;
            data = remoteTable.rows({ selected: true }).data().pluck('size');
            remoteSelected = data.length !== 0;

            data = queueTable.rows({ selected: true }).data();
            queueSelected = data.length != 0;

            menubar.updateItem('file|upload', { enabled: localSelected });
            menubar.updateItem('file|download', { enabled: remoteSelected });

            menubar.updateItem('queue|start', { enabled: queueSelected });
            menubar.updateItem('queue|pause', { enabled: queueSelected });
            menubar.updateItem('queue|stop', { enabled: queueSelected });

            menubar.updateItem('edit|local|rename', { enabled: localSelected });
            menubar.updateItem('edit|local|delete', { enabled: localSelected });

            menubar.updateItem('edit|local|reveal in explorer...', { enabled: localSelected });
            menubar.updateItem('edit|local|open...', { enabled: localSelected });
            menubar.updateItem('edit|local|open with editor...', { enabled: localSelected });
            menubar.updateItem('edit|local|open with external editor...', { enabled: localSelected && options.editor && options.editor.length > 0 });

            menubar.updateItem('edit|remote|goto', { enabled: remoteSelected });
            menubar.updateItem('edit|remote|change to directory', { enabled: remoteSelected });
            menubar.updateItem('edit|remote|update', { enabled: remoteSelected });
            menubar.updateItem('edit|remote|renew', { enabled: remoteSelected });
            menubar.updateItem('edit|remote|clone', { enabled: remoteSelected });
            menubar.updateItem('edit|remote|dest', { enabled: remoteSelected });
            menubar.updateItem('edit|remote|backup', { enabled: remoteSelected });
            menubar.updateItem('edit|remote|copy full path', { enabled: remoteSelected });
            menubar.updateItem('edit|remote|edit...', { enabled: remoteSelected });

            menubar.updateItem('edit|remote|rename', { enabled: remoteSelected });
            menubar.updateItem('edit|remote|delete', { enabled: remoteSelected });

            $('#btn-rename-local').prop('disabled', !localSelected);
            $('#btn-delete-local').prop('disabled', !localSelected);
            $('#btn-upload-local').prop('disabled', !localSelected);
            $('#btn-reveal-local').prop('disabled', !localSelected);
            $('#btn-open-local').prop('disabled', !localSelected);
            $('#btn-editor-local').prop('disabled', !localSelected);

            $('#btn-rename-remote').prop('disabled', !remoteSelected);
            $('#btn-delete-remote').prop('disabled', !remoteSelected);
            $('#btn-download-remote').prop('disabled', !remoteSelected);
            $('#btn-edit-remote').prop('disabled', !remoteSelected);

            $('#btn-start').prop('disabled', !queueSelected);
            $('#btn-pause').prop('disabled', !queueSelected);
            $('#btn-stop').prop('disabled', !queueSelected);
            doUpdate(1);
            updatingMenu = false;
        }

        function renderFile(data, type, full) {
            if (type === 'sort' || type === 'type')
                return data;
            if (full.size === -2) {
                return '<i class="fa fa-folder-o" style="margin-right: 2px"></i>' + data;
            }
            else {
                switch (full.type.toLowerCase()) {
                    case '.pdf':
                        return '<i class="fa fa-file-pdf-o" style="color: #cc3e44;margin-right: 2px"></i>' + data;
                    case '.xls':
                    case '.xlt':
                    case '.xlm':
                    case '.xlsx':
                    case '.xlsm':
                    case '.xltx':
                    case '.xltm':
                        return '<i class="fa fa-file-excel-o" style="color: #8dc149;margin-right: 2px"></i>' + data;
                    case '.doc':
                    case '.dot':
                    case '.wbk':
                    case '.docx':
                    case '.docm':
                    case '.dotx':
                    case '.dotm':
                    case '.docb':
                        return '<i class="fa fa-file-word-o" style="color:#519aba;margin-right: 2px"></i>' + data;
                    case '.ppt':
                    case '.pot':
                    case '.pps':
                    case '.pptx':
                    case '.pptm':
                    case '.potx':
                    case '.potm':
                    case '.ppam':
                    case '.ppsx':
                    case '.ppsm':
                    case '.sldx':
                    case '.sldm':
                        return '<i class="fa fa-file-powerpoint-o" style="margin-right: 2px"></i>' + data;
                    case '.png':
                    case '.gif':
                    case '.jpg':
                    case '.ico':
                    case '.svg':
                    case '.webp':
                        return '<i class="fa fa-file-image-o" style="color: #a074c4;margin-right: 2px"></i>' + data;
                    case '.m4a':
                    case '.wav':
                    case '.mp3':
                    case '.flac':
                        return '<i class="fa fa-file-audio-o" style="margin-right: 2px"></i>' + data;
                    case '.avi':
                    case '.mpg':
                    case '.mov':
                    case '.webm':
                    case '.oog':
                    case '.mkv':
                        return '<i class="fa fa-file-video-o" style="color: #f55385;margin-right: 2px"></i>' + data;
                    case '.7z':
                    case '.zip':
                    case '.rar':
                    case '.jar':
                        return '<i class="fa fa-file-archive-o" style="color: #6d8086;margin-right: 2px"></i>' + data;
                    case '.txt':
                        return '<i class="fa fa-file-text-o" style="margin-right: 2px"></i>' + data;
                    case '.o':
                    case '.csv':
                        return '<i class="fa fa-file-o" style="color: #8dc149;margin-right: 2px"></i>' + data;
                    case '.h':
                        return '<i class="fa fa-file-code-o" style="color:#a074c4;margin-right: 2px"></i>' + data;
                    case '.c':
                        return '<i class="fa fa-file-code-o" style="color:#519aba;margin-right: 2px"></i>' + data;
                }

            }
            return '<i class="fa fa-file-o" style="margin-right: 2px"></i>' + data;
        }

        $(document).ready(() => {
            $('#local-list').DataTable({
                keys: true,
                paging: false,
                select: {
                    style: 'os'
                },
                searching: false,
                info: false,
                scrollY: 300,
                scrollX: 300,
                fixedHeader: {
                    header: true,
                    footer: false
                },
                scrollResize: true,
                language: { zeroRecords: '', emptyTable: '' },
                autoWidth: false,
                columnDefs: [
                    {
                        type: 'file',
                        targets: 0,
                        render: renderFile
                    },
                    {
                        render: function (data) {
                            if (data === -2)
                                return '';
                            return formatSize(data);
                        },
                        type: 'file-size',
                        targets: 1,
                        orderData: [1, 0],
                    },
                    {
                        targets: 2,
                        orderData: [4, 2, 0],
                    },
                    {
                        type: 'moment',
                        targets: 3,
                        orderData: [4, 3, 0],
                        render: function (data) {
                            return new moment(data).format('MM/DD/YYYY hh:mm:ss A');
                        }
                    },
                    {
                        'targets': 4,
                        'visible': false

                    }
                ],
                columns: [
                    { data: 'name', width: '200px' },
                    { data: 'size', width: '200px' },
                    { data: 'type', width: '200px' },
                    { data: 'date', width: '200px' },
                    { data: 'type2', width: '200px' }
                ]
            });
            $('#remote-list').DataTable({
                keys: true,
                paging: false,
                select: {
                    style: 'os'
                },
                searching: false,
                info: false,
                scrollY: 300,
                scrollX: 300,
                fixedHeader: {
                    header: true,
                    footer: false
                },
                scrollResize: true,
                language: { zeroRecords: '', emptyTable: '' },
                autoWidth: false,
                columnDefs: [
                    {
                        type: 'rFile',
                        targets: 0,
                        render: renderFile,
                    },
                    {
                        render: function (data) {
                            if (data === -2)
                                return '';
                            return formatSize(data);
                        },
                        targets: 1,
                        orderData: [1, 0],
                        type: 'file-size',
                    },
                    {
                        targets: 2,
                        orderData: [4, 2, 0],
                    },
                    {
                        type: 'moment',
                        targets: 3,
                        orderData: [4, 3, 0],
                        render: function (data) {
                            return new moment(data).format('MM/DD/YYYY hh:mm:ss A');
                        }
                    },
                    {
                        'targets': 4,
                        'visible': false
                    }
                ],
                columns: [
                    { data: 'name', width: '200px' },
                    { data: 'size', width: '200px' },
                    { data: 'type', width: '200px' },
                    { data: 'date', width: '200px' },
                    { data: 'type2', width: '200px' }
                ]
            });
            $('#queue-list').DataTable({
                data: [],
                paging: false,
                select: true,
                searching: false,
                info: false,
                scrollY: 300,
                scrollX: '100vw',
                fixedHeader: {
                    header: true,
                    footer: false
                },
                scrollResize: true,
                ordering: false,
                language: { zeroRecords: '', emptyTable: '' },
                columnDefs: [
                    {
                        type: 'file',
                        targets: 0,
                        render: function (data, type, full) {
                            if (type === 'sort' || type === 'type')
                                return data;
                            var file = data;
                            if (file.startsWith(options.local)) {
                                file = file.substr(options.local.length);
                                file = '.' + file;
                            }
                            if (full.state === ItemState.paused)
                                return '<i class="fa fa-pause" style="width:12px; margin-right: 2px"></i>' + file;
                            if (full.state === ItemState.error)
                                return '<i class="fa fa-warning" style="width:12px; margin-right: 2px" title="' + IED.errorMessage(full.error) + '"></i>' + file;
                            return '<i class="fa fa-play" style="width:12px; margin-right: 2px"></i>' + file;
                        }
                    },
                    {
                        width: '30px',
                        targets: 1
                    },
                    {
                        targets: 2,
                        render: function (data, type) {
                            if (type === 'sort' || type === 'type')
                                return data;
                            var file = data;
                            if (file.startsWith(options.remote)) {
                                file = file.substr(options.remote.length);
                                file = '.' + file;
                            }
                            return file;
                        }
                    },
                    {
                        render: function (data, type) {
                            if (type === 'sort' || type === 'type')
                                return data;
                            return `<div class="progressbar"><div class="progressbar-text">${Math.round(100 * data)}%</div><div class="progressbar-value" style="width: ${100 - 100 * data}%"></div></div>`;
                        },
                        targets: 3,
                        width: '150px',
                    },
                    {
                        targets: 4,
                        render: function (data, type, full) {
                            if (type === 'sort' || type === 'type')
                                return data;
                            switch (full.state) {
                                case ItemState.paused:
                                    return 'Paused';
                                case ItemState.error:
                                    if (typeof full.error === 'number')
                                        return IED.errorMessage(full.error);
                                    return full.error;
                                case ItemState.done:
                                    return 'Success';
                                case ItemState.stopped:
                                    return 'Stopped';
                            }
                            return '';
                        }
                    }
                ],
                columns: [
                    { data: 'local' },
                    { data: 'direction', width: '30px' },
                    { data: 'remote' },
                    { data: 'progress', width: '150px' },
                    { data: 'error' }
                ]
            });
            loadOptions();
            window.opener.client.on('options-loaded', optionsLoaded);
            window.opener.client.on('received-GMCP', processGMCP);
            //#region IED set up
            _ied = new IED(options.local, options.remote);
            _ied.prefix = 'manager-';
            _ied.local = options.local;
            _ied.remote = options.remote;
            _ied.bufferSize = options.bufferSize;
            _ied.useTemp = options.tempFile;
            _ied.compressUpload = options.compress;
            _ied.compressDownload = options.compress;
            _ied.compressDir = options.compress;
            _ied.on('init', () => {
                if (!options.remote || options.remote.length === 0)
                    _ied.getDir('.');
                else
                    _ied.getDir(options.remote);
            });
            _ied.on('send-gmcp', (data) => {
                window.opener.client.sendGMCP(data);
            })
            _ied.on('error', (error) => {
                if (error && error.code) {
                    switch (error.code) {
                        case IEDError.USER_DENIED:
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Permission denied',
                                message: 'Permission denied'
                            });
                            break;
                        case IEDError.RESET:
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Reset',
                                message: 'Server reset: ' + error.msg
                            });
                            break;
                        case IEDError.USERRESET:
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Reset',
                                message: error.msg
                            });
                            break;
                        case IEDError.CMD_EXIST:
                            if (error && !error.tag.startsWith(_ied.prefix + 'mkdirIgnore') && !error.tag.startsWith(_ied.prefix + 'mkdirPIgnore')) {
                                if (error.path && error.file)
                                    dialog.showMessageBox({
                                        type: 'error',
                                        title: 'Already exist',
                                        message: `File or directory already exist: '${error.path}/${error.file}`
                                    });
                                else
                                    dialog.showMessageBox({
                                        type: 'error',
                                        title: 'Already exist',
                                        message: error.msg
                                    });
                            }
                            break;
                        case IEDError.CMD_DIRECTORY:
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Is a directory',
                                message: `File is a directory: '${error.path}/${error.file}`
                            });
                            break;
                        case IEDError.CMD_NOEXIST:
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Does not exist',
                                message: `File or directory does not exist: '${error.path}/${error.file}`
                            });
                            break;
                        case IEDError.CMD_FILE:
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Not a directory',
                                message: `File not a directory: '${error.path}/${error.file}`
                            });
                            break;
                        case IEDError.DIR_CANTREAD:
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Can not read',
                                message: 'Can not read or permission denied'
                            });
                            break;
                    }
                }
                var msg;
                if (error.stack)
                    msg = error.stack;
                else if (error instanceof TypeError)
                    msg = error.name + ': ' + error.message;
                else if (error instanceof Error)
                    msg = error.name + ': ' + error.message;
                else if (error.message)
                    msg = error.message;
                else if (error.msg)
                    msg = error.msg;
                else
                    msg = error;
                logMessage(msg);
                logError(msg);
            });
            _ied.on('reset', () => {
                info.downloads = 0;
                info.uploads = 0;
                info.active = 0;
                queueTable.rows().remove();
                doUpdate(9);
                window.setProgressBar(-1);
                window.opener.updateProgress(-1);
            });
            _ied.on('dir', async (dir, files, tag, local) => {
                var f, fl, file;
                if (tag.startsWith('manager-dir:browse'))
                    updateRemote(dir, files);
                else if (tag.startsWith('manager-dir:download')) {
                    if (_progressCancel) {
                        if (options.debug)
                            console.log('Download files canceled');
                        pTotal = 0;
                        if ($('#Progress')[0].open)
                            $('#Progress')[0].close();
                        return;
                    }
                    if (options.debug) {
                        console.log('Download files:');
                        console.log(files);
                        console.log('Download dir: ' + dir);
                    }
                    var s = options.remote.length;
                    if (options.remote.endsWith('/'))
                        s--;
                    var r = dir.substr(s).replace(/\//g, path.sep);

                    /*
                    if (local && !existsSync(path.join(local, path.basename(dir)))) {
                        fs.mkdirSync(path.join(local, path.basename(dir)));
                        logMessage("Creating directory: " + path.join(local, path.basename(dir)));
                    }
                    */
                    for (f = 0, fl = files.length; f < fl; f++) {
                        file = (dir === '/' ? '' : dir) + '/' + files[f].file;
                        if (files[f].size == -2) {
                            //create local
                            if (local && !existsSync(path.join(local, path.basename(file)))) {
                                fs.mkdirSync(path.join(local, path.basename(file)));
                                logMessage('Creating directory: ' + path.join(local, path.basename(file)));
                            }
                            pTotal++;
                            _ied.getDir(file, true, 'download:' + file, path.join(local, path.basename(file)));
                        }
                        else
                            if (!await downNext(file, path.join(options.local, r), files[f])) {
                                _progressCancel = true;
                                break;
                            }
                    }
                    pTotal--;
                    if (pTotal <= 0) {
                        pTotal = 0;
                        if ($('#Progress')[0].open)
                            $('#Progress')[0].close();
                        return;
                    }
                }
                else if (tag.startsWith('manager-dir:delete')) {
                    if (_progressCancel) {
                        pTotal = 0;
                        pFiles = 0;
                        if ($('#Progress')[0].open)
                            $('#Progress')[0].close();
                        return;
                    }
                    for (f = 0, fl = files.length; f < fl; f++) {
                        file = (dir === '/' ? '' : dir) + '/' + files[f].file;
                        if (files[f].size === -2)
                            deleteRemoteFolder(file);
                        else
                            _ied.deleteFile(file);
                    }
                    pTotal--;
                    if (pTotal <= 0) {
                        for (f = pFiles.length - 1; f >= 0; f--)
                            _ied.deleteDirectory(pFiles[f]);
                        pTotal = 0;
                        if ($('#Progress')[0].open)
                            $('#Progress')[0].close();
                        return;
                    }
                }
            });
            _ied.on('resolved', (dir, tag) => {
                if (tag && tag.startsWith('manager-'))
                    logMessage('Resolved: ' + dir);
            });
            _ied.on('message', (msg) => {
                logMessage(msg);
            });

            _ied.on('add', (item) => {
                if (Array.isArray(item)) {
                    item = item.map(function callback(val) {
                        if (val.download) {
                            _downloads[val.local] = true;
                            if (val.tmp === TempType.extension)
                                _downloads[val.local + '.tmp'] = true;
                            info.downloads++;
                        }
                        else
                            info.uploads++;
                        info.active++;
                        return {
                            'local': val.local,
                            'direction': val.download ? '<-' : '->',
                            'remote': val.remote,
                            'progress': val.percent,
                            'id': val.ID,
                            'state': val.state,
                            'error': val.error
                        };
                    });
                    queueTable.rows.add(item);
                }
                else {
                    if (item.download) {
                        _downloads[item.local] = true;
                        if (item.tmp === TempType.extension)
                            _downloads[item.local + '.tmp'] = true;
                        info.downloads++;
                    }
                    else
                        info.uploads++;
                    queueTable.row.add({
                        'local': item.local,
                        'direction': item.download ? '<-' : '->',
                        'remote': item.remote,
                        'progress': item.percent,
                        'id': item.ID,
                        'state': item.state,
                        'error': item.error
                    });
                    info.active++;
                }
                doUpdate(9);
            });

            _ied.on('remove', (item) => {
                if (!_removeID)
                    _removeID = setTimeout(bulkQueueRemove, 1000);
                if (!_remove) _remove = [];
                _remove.push(item);
            });

            _ied.on('update', (item) => {
                if (!item)
                    return;
                if (!_qUpdate) {
                    _qUpdate = [];
                    _qUpdateTracker = {};
                }
                if (Object.prototype.hasOwnProperty.call(_qUpdateTracker, item.ID))
                    _qUpdate[_qUpdateTracker[item.ID]] = item;
                else {
                    _qUpdateTracker[item.ID] = _qUpdate.length;
                    _qUpdate.push(item);
                }
                if (!_qUpdateID)
                    _qUpdateID = setTimeout(bulkQueueUpdate, 500);
                //doUpdate(128);
            });

            _ied.on('cmd', (obj) => {
                var row, name;
                if (obj.cmd === 'rm') {
                    if (obj.code === IEDCmdStatus.success) {
                        logMessage(`Deleted: ${obj.path}/${obj.file}`);
                        if (obj.path != options.remote)
                            return;
                        row = remoteTable.row(function (idx, data) {
                            return data.name === obj.file ?
                                true : false;
                        });
                        delete _remote[obj.file];
                        if (row && row.length === 1) {
                            row.remove();
                            doUpdate(4);
                        }
                        info.remoteFiles--;
                        doUpdate(1);
                    }
                    else {
                        logMessage(`Failed to delete: ${obj.path}/${obj.file}`);
                        dialog.showMessageBox({
                            type: 'error',
                            title: 'Could not delete',
                            message: 'Could not delete: ' + obj.path + '/' + obj.file,
                        });
                    }
                }
                else if (obj.cmd === 'mv') {
                    if (obj.code === IEDCmdStatus.success) {
                        logMessage(`Renamed ${obj.path}/${obj.file} to ${obj.path2}/${obj.file2}`);
                        if (obj.path != options.remote)
                            return;
                        row = remoteTable.row(function (idx, data) {
                            return data.name === obj.file ?
                                true : false;
                        });
                        _remote[obj.file2] = _remote[obj.file];
                        delete _remote[obj.file];
                        if (row && row.length === 1)
                            row.remove();

                        //update old data to new data
                        _remote[obj.file2].name = obj.file2;
                        _remote[obj.file2].path = obj.path2 + '/' + obj.file2;
                        _remote[obj.file2].hidden = IED.isHidden(_remote[obj.file2].path, true);

                        if (_remote[obj.file2].hidden && !options.showHidden) {
                            delete _remote[obj.file2];
                            info.remoteFiles--;
                            return;
                        }
                        remoteTable.row.add(_remote[obj.file2]);
                        doUpdate(5);
                    }
                    else {
                        logMessage(`Failed to rename: ${obj.path}/${obj.file}`);
                        dialog.showMessageBox({
                            type: 'error',
                            title: 'Could not rename',
                            message: 'Could not rename: ' + obj.file,
                        });
                    }
                }
                else if (obj.cmd === 'mkdir') {
                    if (obj.code === IEDCmdStatus.success) {
                        logMessage(`Created directory ${obj.path}`);
                        if (path.dirname(obj.path) != options.remote)
                            return;
                        name = path.basename(obj.path);
                        row = remoteTable.row(function (idx, data) {
                            return data.name === name ?
                                true : false;
                        });
                        _remote[name] = {
                            name: name,
                            path: obj.path,
                            size: -2,
                            type: 'Directory',
                            date: new Date().getTime(),
                            hidden: IED.isHidden(obj.path, true),
                            type2: -2
                        };
                        if (_remote[name].hidden && !options.showHidden) {
                            delete _remote[name];
                            return;
                        }
                        if (row && row.length === 1)
                            row.remove();
                        else
                            info.remoteDirs++;
                        remoteTable.row.add(_remote[name]);
                        doUpdate(5);
                    }
                    else {
                        logMessage(`Failed to create directory: ${obj.path}`);
                        dialog.showMessageBox({
                            type: 'error',
                            title: 'Could not create directory',
                            message: 'Could not create: ' + path.basename(obj.path),
                        });
                    }
                }
                else if (obj.cmd === 'rmdir') {
                    if (obj.code === IEDCmdStatus.success) {
                        logMessage(`Removed directory ${obj.path}`);
                        if (path.dirname(obj.path) != options.remote)
                            return;
                        name = path.basename(obj.path);
                        row = remoteTable.row(function (idx, data) {
                            return data.name === name ?
                                true : false;
                        });
                        if (row && row.length === 1) {
                            row.remove();
                            doUpdate(4);
                        }
                        delete _remote[name];
                        info.remoteDirs--;
                        doUpdate(1);
                    }
                    else {
                        logMessage(`Failed to remove directory: ${obj.path}`);
                        dialog.showMessageBox({
                            type: 'error',
                            title: 'Could not remove directory',
                            message: 'Could not remove: ' + path.basename(obj.path),
                        });
                    }
                }
            });
            //#endregion
            localTable = $('#local-list').DataTable();
            remoteTable = $('#remote-list').DataTable();
            queueTable = $('#queue-list').DataTable();
            logView = $('#log-view');

            localTable.on('user-select', function (e, dt, type, cell) {
                if ($(cell.node()).parent().hasClass('selected') && dt.rows('.selected').data().length === 1) {
                    e.preventDefault();
                }
            });

            remoteTable.on('user-select', function (e, dt, type, cell) {
                if ($(cell.node()).parent().hasClass('selected') && dt.rows('.selected').data().length === 1) {
                    e.preventDefault();
                }
            });

            queueTable.on('user-select', function (e, dt, type, cell) {
                if ($(cell.node()).parent().hasClass('selected') && dt.rows('.selected').data().length === 1) {
                    e.preventDefault();
                }
            });

            $('#local-list tbody').on('contextmenu', 'tr', function (event) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;

                if (!$(this).hasClass('selected')) {
                    localTable.rows().deselect();
                    localTable.row(this).select();
                }
                showLocalContextMenu();
            });

            $('#local-list-container').on('contextmenu', function (event) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;
                showLocalContextMenu();
            });

            $('#remote-list tbody').on('contextmenu', 'tr', function (event) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;

                if (!$(this).hasClass('selected')) {
                    remoteTable.rows().deselect();
                    remoteTable.row(this).select();
                }
                showRemoteContextMenu();
            });

            $('#remote-list-container').on('contextmenu', function (event) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;
                showRemoteContextMenu();
            });

            $('#queue-list tbody').on('contextmenu', 'tr', function (event) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;

                if (!$(this).hasClass('selected')) {
                    queueTable.rows().deselect();
                    queueTable.row(this).select();
                }
                showQueueContextMenu();
            });

            $('#queue-list-container').on('contextmenu', function (event) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;
                showQueueContextMenu();
            });

            logView.on('contextmenu', function (event) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;
                var c = new Menu();
                if (window.getSelection().type === 'Range') {
                    c.append(new MenuItem({ role: 'copy' }));
                    c.append(new MenuItem({ type: 'separator' }));
                }
                c.append(new MenuItem({
                    label: 'Clear log',
                    click: () => {
                        logView.html('');
                    }
                }));
                c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: 'Select all',
                    click: () => {
                        var selection = window.getSelection();
                        var range = document.createRange();
                        range.selectNodeContents(logView[0]);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                }));
                c.popup({ window: remote.getCurrentWindow() });
            });

            localTable.on('select', function (e, dt, type) {
                if (type === 'row')
                    doUpdate(16);
            });

            localTable.on('deselect', function (e, dt, type) {
                if (type === 'row')
                    doUpdate(16);
            });

            remoteTable.on('select', function (e, dt, type) {
                if (type === 'row')
                    doUpdate(16);
            });

            remoteTable.on('deselect', function (e, dt, type) {
                if (type === 'row')
                    doUpdate(16);
            });

            queueTable.on('select', function (e, dt, type) {
                if (type === 'row')
                    doUpdate(16);
            });

            queueTable.on('deselect', function (e, dt, type) {
                if (type === 'row')
                    doUpdate(16);
            });

            $('#local-list').on('keypress', function (e) {
                key += e.key.toLowerCase();
                var selected = localTable.rows({ selected: true });
                var f = -1;
                var row = localTable.row(function (idx, data) {
                    if (selected.length > 0) {
                        if (selected[selected.length - 1][0] == idx)
                            f = idx;
                        else if (f >= 0)
                            return data.name.toLowerCase().startsWith(key) ? true : false;
                    }
                    else
                        return data.name.toLowerCase().startsWith(key) ? true : false;
                }, { order: 'applied' });
                if (selected.length && row.length == 0) {
                    localTable.rows().deselect();
                    row = localTable.row(function (idx, data) {
                        if (selected.length > 0) {
                            if (selected[selected.length - 1][0] == idx)
                                f = idx;
                            else if (f >= 0)
                                return data.name.toLowerCase().startsWith(key) ? true : false;
                        }
                        else
                            return data.name.toLowerCase().startsWith(key) ? true : false;
                    }, { order: 'applied' });
                }
                //$("#local-list_wrapper .dataTables_scrollBody")[0].scrollTop = $("#local-list_wrapper .dataTables_scrollBody")[0].scrollHeight - (row.index() * $(row.node()).outerHeight());
                if (!row || row.length === 0) {
                    clearTimeout(keyClearID);
                    keyClearID = setTimeout(() => {
                        key = '';
                    }, 300);
                    return;
                }
                localTable.rows().deselect();
                var top = row.node().offsetTop;
                var sTop = $('#local-list_wrapper .dataTables_scrollBody')[0].scrollTop;
                var sHeight = $('#local-list_wrapper .dataTables_scrollBody')[0].clientHeight;
                if (top < sTop || top + 31 >= sTop + sHeight)
                    $('#local-list_wrapper .dataTables_scrollBody')[0].scrollTop = top;
                //$("#local-list_wrapper .dataTables_scrollBody")[0].scrollTop = row.node().offsetTop;
                //row.node().scrollIntoView();
                //$("body")[0].scrollTop = 0
                row.select();
                //hack, seems this gets set wrong and causes shift click selection to act wonky, setting to current item index seems to fix it
                if (localTable.context[0]._select_lastCell)
                    localTable.context[0]._select_lastCell.row = row.index();
                else
                    localTable.context[0]._select_lastCell = { row: row.index(), column: 0, columnVisible: 0 };
                clearTimeout(keyClearID);
                keyClearID = setTimeout(() => {
                    key = '';
                }, 300);
            });
            $('#remote-list').on('keypress', function (e) {
                key += e.key.toLowerCase();
                var selected = remoteTable.rows({ selected: true });
                var f = -1;
                var row = remoteTable.row(function (idx, data) {
                    if (selected.length > 0) {
                        if (selected[selected.length - 1][0] == idx)
                            f = idx;
                        else if (f >= 0)
                            return data.name.toLowerCase().startsWith(key) ? true : false;
                    }
                    else
                        return data.name.toLowerCase().startsWith(key) ? true : false;
                }, { order: 'applied' });
                if (selected.length && row.length == 0) {
                    remoteTable.rows().deselect();
                    row = remoteTable.row(function (idx, data) {
                        if (selected.length > 0) {
                            if (selected[selected.length - 1][0] == idx)
                                f = idx;
                            else if (f >= 0)
                                return data.name.toLowerCase().startsWith(key) ? true : false;
                        }
                        else
                            return data.name.toLowerCase().startsWith(key) ? true : false;
                    }, { order: 'applied' });
                }
                if (!row || row.length === 0) {
                    keyClearID = setTimeout(() => {
                        key = '';
                    }, 300);
                    return;
                }
                remoteTable.rows().deselect();
                var top = row.node().offsetTop;
                var sTop = $('#remote-list_wrapper .dataTables_scrollBody')[0].scrollTop;
                var sHeight = $('#remote-list_wrapper .dataTables_scrollBody')[0].clientHeight;
                if (top < sTop || top + 31 >= sTop + sHeight)
                    $('#remote-list_wrapper .dataTables_scrollBody')[0].scrollTop = top;
                //row.node().scrollIntoView();
                //$("body")[0].scrollTop = 0
                row.select();
                //hack, seems this gets set wrong and causes shift click selection to act wonky, setting to current item index seems to fix it
                if (remoteTable.context[0]._select_lastCell)
                    remoteTable.context[0]._select_lastCell.row = row.index();
                else
                    remoteTable.context[0]._select_lastCell = { row: row.index(), column: 0, columnVisible: 0 };
                clearTimeout(keyClearID);
                keyClearID = setTimeout(() => {
                    key = '';
                }, 300);
            });

            $('#local-list tbody').on('dblclick', 'tr', function () {
                var data = localTable.row(this).data();
                if (!data) return;
                if (data.size === -2) {
                    if (options.syncFolders && _remote[data.name]) {
                        if (options.remote === '/')
                            _ied.getDir('/' + data.name, true);
                        else
                            _ied.getDir(options.remote + '/' + data.name, true);
                    }
                    updateLocal(data.path);
                }
                else
                    uploadFile(data.path);
            });

            $('#remote-list tbody').on('dblclick', 'tr', function () {
                var data = remoteTable.row(this).data();
                if (!data) return;
                if (data.size === -2) {
                    if (options.syncFolders && _local[data.name]) {
                        //if (_local[data.name] && path.basename(options.remote) === path.basename(options.remote))
                        updateLocal(path.join(options.local, data.name));
                    }
                    _ied.getDir(data.path, true);
                }
                else
                    downloadFile(data.path);
            });

            $('#queue-list tbody').on('dblclick', 'tr', function () {
                var data = queueTable.row(this).data();
                if (!data) return;
                if (data.state === ItemState.paused)
                    _ied.startItem(data.id);
                else
                    _ied.pauseItem(data.id);
            });

            $('#local-list').on('focus', () => {
                $('#local-list').addClass('focused');
                $('#remote-list').removeClass('focused');
                $('#queue-list').removeClass('focused');
                doUpdate(16);

            });
            $('#remote-list').on('focus', () => {
                $('#local-list').removeClass('focused');
                $('#remote-list').addClass('focused');
                $('#queue-list').removeClass('focused');
                doUpdate(16);
            });
            $('#queue-list').on('focus', () => {
                $('#local-list').removeClass('focused');
                $('#remote-list').removeClass('focused');
                $('#queue-list').addClass('focused');
                doUpdate(16);
            });
            updateLocal(options.local);
            if (!options.remote || options.remote.length === 0)
                _ied.getDir('.');
            else
                _ied.getDir(options.remote);

            $('#btn-local-up').on('click', () => {
                if (options.syncFolders) {
                    if (path.basename(options.remote) === path.basename(options.local))
                        _ied.getDir(path.dirname(options.remote), true);
                }
                updateLocal(path.dirname($('#local-path').val()));
            });

            $('#local-navigate').on('click', (e) => {
                e.preventDefault();
                e.cancelBubble = true;
                var p = $(e.target).data('path');
                if (options.syncFolders) {
                    if (p.startsWith(options.local) && _remote[path.basename(p)] && (path.basename(options.remote) === path.basename(options.local) || options.remote === '/'))
                        _ied.getDir(options.remote + '/' + path.basename(p), true);
                    else if (path.basename(path.dirname(options.remote)).length === 0 && path.dirname(options.local) === p)
                        _ied.getDir(path.dirname(options.remote), true);
                    else if (path.basename(path.dirname(options.remote)) === path.basename(p))
                        _ied.getDir(path.dirname(options.remote), true);

                }
                updateLocal(p);
            });

            $('#local-path').change(function () {
                updateLocal($('#local-path').val());
            });
            $('#local-path').keyup(function (e) {
                if (e.which === 27)
                    $('#local-path').val(options.local);
            });
            $('#local-path').on('focus', () => {
                $('#local-path').select();
            });

            $('#btn-remote-up').on('click', () => {
                _ied.getDir(path.dirname($('#remote-path').val()), true);
                if (options.syncFolders) {
                    if (path.basename(options.remote) === path.basename(options.local))
                        updateLocal(path.dirname(options.local));
                }
            });

            $('#remote-navigate').on('click', (e) => {
                e.preventDefault();
                e.cancelBubble = true;
                var p = $(e.target).data('path');
                if (options.syncFolders) {
                    if (p.startsWith(options.remote) && [path.basename(p)] && path.basename(options.remote) === path.basename(options.remote))
                        updateLocal(path.join(options.local, path.basename(p)));
                    else if (path.basename(path.dirname(options.local)) === path.basename(p))
                        updateLocal(path.dirname(options.local));
                }
                _ied.getDir(p, true);
            });

            $('#remote-path').change(function () {
                _ied.getDir($('#remote-path').val());
            });
            $('#remote-path').keyup(function (e) {
                if (e.which === 27)
                    $('#remote-path').val(options.remote);
            });
            $('#remote-path').on('focus', () => {
                $('#remote-path').select();
            });

            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                var target = $(e.target).attr('href'); // activated tab
                if (target === '#log')
                    logView[0].scrollTop = logView[0].scrollHeight;
            });

            $(document).keydown((event) => {
                if ($('#newFolder')[0].open) {
                    if (event.which === 27)
                        $('#newFolder')[0].close();
                    else if (event.which === 13)
                        newFolderOk()
                    return;
                }
                if ($('#Progress')[0].open) {
                    if (event.which === 27)
                        progressCancel()
                    return;
                }

                //event.altKey, event.ctrlKey, event.shiftKey, event.metaKey

                switch (event.which) {
                    case 113: //f2
                        if (!event.altKey && !event.ctrlKey && !event.shiftKey && !event.metaKey) {
                            event.preventDefault();
                            if ($('#local-list').hasClass('focused'))
                                renameLocal();
                            else if ($('#remote-list').hasClass('focused'))
                                renameRemote();
                        }
                        break;
                    case 116: //f5
                        if (!event.altKey && !event.ctrlKey && !event.shiftKey && !event.metaKey) {
                            if ($('#local-list').hasClass('focused'))
                                updateLocal();
                            else if ($('#remote-list').hasClass('focused'))
                                _ied.getDir((!options.remote || options.remote.length === 0) ? '.' : options.remote);

                            event.preventDefault();
                        }
                        break;
                    case 46://delete
                        if (!event.altKey && !event.ctrlKey && !event.shiftKey && !event.metaKey) {
                            if ($('#local-list').hasClass('focused'))
                                deleteLocal();
                            else if ($('#remote-list').hasClass('focused'))
                                deleteRemote();
                            else if ($('#queue-list').hasClass('focused'))
                                queueStop();
                            event.preventDefault();
                        }
                        break;
                    case 65://select all, hack as menu accelerator doesn't work
                        if (!event.altKey && event.ctrlKey && !event.shiftKey && !event.metaKey) {
                            if ($('#local-list').hasClass('focused'))
                                localTable.rows().select();
                            else if ($('#remote-list').hasClass('focused'))
                                remoteTable.rows().select();
                            else if ($('#queue-list').hasClass('focused'))
                                queueTable.rows().select();
                            event.preventDefault();
                        }
                        break;
                    /*
                case 78:
                    if (!event.altKey && event.ctrlKey && !event.shiftKey && !event.metaKey) {
                        console.log("New folder");
                        event.preventDefault();
                    }
                    break;
                    */
                }
            });

            $('#drag-bar').mousedown(function (e) {
                e.preventDefault();
                dragging = true;
                var main = $('#remote');
                var ghostBar = $('<div>',
                    {
                        id: 'ghost-bar',
                        css: {
                            height: main.outerHeight(),
                            top: main.offset().top,
                            left: main.offset().left - 3
                        }
                    }).appendTo('body');

                $(document).mousemove(function (e) {
                    if (e.pageX < 199)
                        ghostBar.css('left', 199);
                    else if (e.pageX > document.body.clientWidth - 300)
                        ghostBar.css('left', document.body.clientWidth - 300);
                    else
                        ghostBar.css('left', e.pageX);
                });
            });

            $('#btm-drag-bar').mousedown(function (e) {
                e.preventDefault();
                btmDragging = true;
                var main = $('#bottom');
                var ghostBar = $('<div>',
                    {
                        id: 'btm-ghost-bar',
                        css: {
                            width: main.outerWidth(),
                            top: main.offset().top,
                            left: main.offset().left
                        }
                    }).appendTo('body');

                $(document).mousemove(function (e) {
                    if (e.pageY < 199)
                        ghostBar.css('top', 199);
                    else if (e.pageY > document.body.clientHeight - 200)
                        ghostBar.css('top', document.body.clientHeight - 200);
                    else
                        ghostBar.css('top', e.pageY);
                });
            });

            $(window).on('resize', () => {
                if ($('#remote').outerWidth() < 300 && $('#local').outerWidth() > 202) {
                    $('#local').css('width', document.body.clientWidth - 300);
                    $('#remote').css('left', document.body.clientWidth - 300);
                    options.localSize = document.body.clientWidth - 300;
                    saveOptions();
                }

                if ($('#bottom').outerHeight() < 200 && $('#main').outerHeight() > 202) {
                    options.queueSize = 200;
                    $('#bottom').css('height', options.queueSize);
                    $('#main').css('bottom', options.queueSize);
                    saveOptions();
                }

                var h = $('#main').outerHeight() - 40;
                if (options.showQueue)
                    h += $('#bottom').outerHeight();
                $('#local-navigate').css('max-height', h + 'px');
                $('#remote-navigate').css('max-height', h + 'px');
                doUpdate(14);
            });

            $(document).mouseup(function (e) {
                if (dragging) {
                    if (e.pageX < 200) {
                        $('#local').css('width', 202);
                        $('#remote').css('left', 202);
                        options.localSize = 202;
                    }
                    else if (e.pageX > document.body.clientWidth - 300) {
                        $('#local').css('width', document.body.clientWidth - 300);
                        $('#remote').css('left', document.body.clientWidth - 300);
                        options.localSize = document.body.clientWidth - 300;
                    }
                    else {
                        $('#local').css('width', e.pageX + 2);
                        $('#remote').css('left', e.pageX + 2);
                        options.localSize = e.pageX + 2;
                    }
                    doUpdate(6);
                    saveOptions();
                    $('#ghost-bar').remove();
                    $(document).unbind('mousemove');
                    dragging = false;
                }
                else if (btmDragging) {
                    if (e.pageY < 226)
                        options.queueSize = document.body.clientHeight - 202;
                    else if (e.pageY > document.body.clientHeight - 200)
                        options.queueSize = 200;
                    else
                        options.queueSize = document.body.clientHeight - e.pageY + 2;
                    options.queueSize -= 26;
                    $('#bottom').css('height', options.queueSize);
                    $('#main').css('bottom', options.queueSize);
                    doUpdate(14);
                    saveOptions();
                    $('#btm-ghost-bar').remove();
                    $(document).unbind('mousemove');
                    btmDragging = false;
                }
            });

            window.ondragover = window.ondragenter = window.ondrop = (e) => {
                e.dataTransfer.effectAllowed = 'none';
                e.dataTransfer.dropEffect = 'none';
                e.stopPropagation();
                e.preventDefault();
                return false;
            };

            $('#bottom')[0].ondragover = document.ondragover = document.ondrop = (ev) => {
                ev.preventDefault();
                ev.dataTransfer.effectAllowed = 'none';
                ev.dataTransfer.dropEffect = 'none';
                ev.cancelBubble = true;
                ev.stopPropagation();
                return false;
            };

            $('#bottom')[0].ondrop = document.ondrop = document.body.ondrop = (ev) => {
                ev.preventDefault();
                ev.dataTransfer.effectAllowed = 'none';
                ev.dataTransfer.dropEffect = 'none';
                ev.cancelBubble = true;
                ev.stopPropagation();
                return false;
            };

            window.onmouseout = () => {
                if (document.getElementById('FileExist').open) return;
                _localDrag = 0;
                _remoteDrag = 0;
            };

            //#region drag and drop support
            let element = document.getElementById('local');

            element.ondragenter = (event) => {
                event.preventDefault();
                event.cancelBubble = true;
                event.stopPropagation();
                if (!event.altKey && !event.ctrlKey && event.shiftKey && !event.metaKey) {
                    if (event.dataTransfer.files.length && (event.dataTransfer.files[0].path === options.local || path.dirname(event.dataTransfer.files[0].path) === options.local)) {
                        event.dataTransfer.dropEffect = 'none';
                        event.dataTransfer.effectAllowed = 'none';
                    }
                    else {
                        event.dataTransfer.dropEffect = 'move';
                        event.dataTransfer.effectAllowed = 'move';
                    }
                }
                else {
                    event.dataTransfer.dropEffect = 'copy';
                    event.dataTransfer.effectAllowed = 'copy';
                }

                return false;
            };

            element.ondragover = (event) => {
                event.preventDefault();
                event.cancelBubble = true;
                event.stopPropagation();
                if (!event.altKey && !event.ctrlKey && event.shiftKey && !event.metaKey) {
                    if (event.dataTransfer.files.length && (event.dataTransfer.files[0].path === options.local || path.dirname(event.dataTransfer.files[0].path) === options.local)) {
                        event.dataTransfer.dropEffect = 'none';
                        event.dataTransfer.effectAllowed = 'none';
                    }
                    else {
                        event.dataTransfer.dropEffect = 'move';
                        event.dataTransfer.effectAllowed = 'move';
                    }
                }
                else {
                    event.dataTransfer.dropEffect = 'copy';
                    event.dataTransfer.effectAllowed = 'copy';
                }

                return false;
            };

            element.ondrop = async (event) => {
                event.preventDefault();
                event.cancelBubble = true;
                event.stopPropagation();
                var type = 0, f, fl;
                if (!event.altKey && !event.ctrlKey && event.shiftKey && !event.metaKey) {
                    if (event.dataTransfer.files.length && (event.dataTransfer.files[0].path === options.local || path.dirname(event.dataTransfer.files[0].path) === options.local)) {
                        event.dataTransfer.dropEffect = 'none';
                        event.dataTransfer.effectAllowed = 'none';
                    }
                    else {
                        event.dataTransfer.dropEffect = 'move';
                        event.dataTransfer.effectAllowed = 'move';
                        type = 1;
                    }
                }
                else {
                    event.dataTransfer.dropEffect = 'copy';
                    event.dataTransfer.effectAllowed = 'copy';
                    type = 2;
                }
                if (_localDrag) {
                    for (f = 0, fl = _localDrag.length; f < fl; f++) {
                        if (type === 1) {
                            fs.moveSync(_localDrag[f], path.join(options.local, getNewName(path.basename(_localDrag[f]), _local)));
                        }
                        else if (type === 2) {
                            fs.copySync(_localDrag[f], path.join(options.local, getNewName(path.basename(_localDrag[f]), _local)));
                        }
                    }
                    _localDrag = 0;
                }
                else if (_remoteDrag) {
                    _ied.begin();
                    for (f = 0, fl = _remoteDrag.length; f < fl; f++) {
                        if (_remote[path.basename(_remoteDrag[f])].size === -2)
                            downloadPath(_remoteDrag[f], options.local);
                        else
                            if (!await downloadFile(_remoteDrag[f])) break;
                    }
                    _ied.end();
                    _remoteDrag = 0;
                    _queue = 0;
                }
                else {
                    _ied.begin();
                    for (f = 0, fl = event.dataTransfer.files.length; f < fl; f++) {
                        var p;
                        if (event.dataTransfer.files[f].path === options.local) continue;
                        if (event.dataTransfer.files[f].path.startsWith('jiMUDPath://')) {
                            p = event.dataTransfer.files[f].path.substring(12);
                            if (_remote[path.basename(p)].size === -2)
                                downloadPath(p, options.local);
                            else
                                if (!await downloadFile(p)) break;
                        }
                        else if (event.dataTransfer.files[f].path.startsWith('jiMUD://')) {
                            p = event.dataTransfer.files[f].path.substring(8);
                            if (_remote[path.basename(p)].size === -2)
                                downloadPath(p, options.local);
                            else
                                if (!await downloadFile(p)) break;
                        }
                        else if (event.dataTransfer.files[f].path.startsWith('/jiMUDPath:')) {
                            p = event.dataTransfer.files[f].path.substring(11);
                            if (_remote[path.basename(p)].size === -2)
                                downloadPath(p, options.local);
                            else
                                if (!await downloadFile(p)) break;
                        }
                        else if (event.dataTransfer.files[f].path.startsWith('/jiMUD:')) {
                            p = event.dataTransfer.files[f].path.substring(7);
                            if (_remote[path.basename(p)].size === -2)
                                downloadPath(p, options.local);
                            else
                                if (!await downloadFile(p)) break;
                        }
                        else if (type === 1) {
                            if (path.dirname(event.dataTransfer.files[f].path) === options.local) continue;
                            fs.moveSync(event.dataTransfer.files[f].path, path.join(options.local, getNewName(event.dataTransfer.files[f].name, _local)));
                        }
                        else if (type === 2) {
                            fs.copySync(event.dataTransfer.files[f].path, path.join(options.local, getNewName(event.dataTransfer.files[f].name, _local)));
                        }
                    }
                    _ied.end();
                    _queue = 0;
                }
            };

            element = document.getElementById('remote');

            element.ondragenter = (event) => {
                if (event.dataTransfer.files.length && (event.dataTransfer.files[0].path.startsWith('jiMUD://') || event.dataTransfer.files[0].path.startsWith('/jiMUD:') || event.dataTransfer.files[0].path.startsWith('jiMUDPath://') || event.dataTransfer.files[0].path.startsWith('/jiMUDPath:'))) {
                    event.dataTransfer.dropEffect = 'none';
                    event.dataTransfer.effectAllowed = 'none';
                }
                else {
                    event.dataTransfer.dropEffect = 'copy';
                    event.dataTransfer.effectAllowed = 'copy';
                }
                event.preventDefault();
                event.cancelBubble = true;
                event.stopPropagation();
                return false;
            };

            element.ondragover = (event) => {
                if (event.dataTransfer.files.length && (event.dataTransfer.files[0].path.startsWith('jiMUD://') || event.dataTransfer.files[0].path.startsWith('/jiMUD:') || event.dataTransfer.files[0].path.startsWith('jiMUDPath://') || event.dataTransfer.files[0].path.startsWith('/jiMUDPath:'))) {
                    event.dataTransfer.dropEffect = 'none';
                    event.dataTransfer.effectAllowed = 'none';
                }
                else {
                    event.dataTransfer.dropEffect = 'copy';
                    event.dataTransfer.effectAllowed = 'copy';
                }
                event.preventDefault();
                event.cancelBubble = true;
                event.stopPropagation();
                return false;
            };

            element.ondrop = async (event) => {
                event.preventDefault();
                if (_localDrag) {
                    _ied.begin();
                    for (var f = 0, fl = _localDrag.length; f < fl; f++) {
                        if (_local[path.basename(_localDrag[f])].size === -2)
                            uploadPath(_localDrag[f]);
                        else
                            if (!await uploadFile(_localDrag[f])) break;
                    }
                    _ied.end();
                    _localDrag = 0;
                    _queue = 0;
                }
                else if (_remoteDrag) {
                    _remoteDrag = 0;
                }
                else {
                    _ied.begin();
                    for (f = 0, fl = event.dataTransfer.files.length; f < fl; f++) {
                        if (event.dataTransfer.files[f].path.startsWith('jiMUD://')) continue;
                        if (event.dataTransfer.files[f].path.startsWith('jiMUDPath://')) continue;
                        if (event.dataTransfer.files[f].path.startsWith('/jiMUD:')) continue;
                        if (event.dataTransfer.files[f].path.startsWith('/jiMUDPath:')) continue;
                        if (event.dataTransfer.files[f].size < 1) {
                            var stat = fs.statSync(event.dataTransfer.files[f].path);
                            if (stat.isDirectory())
                                uploadPath(event.dataTransfer.files[f].path);
                            else
                                if (!await uploadFile(event.dataTransfer.files[f].path)) break;
                        }
                        else
                            if (!await uploadFile(event.dataTransfer.files[f].path)) break;
                    }
                    _ied.end();
                    _queue = 0;
                }
            };

            element = document.getElementById('local-list');

            element.ondragstart = (event) => {
                var row = $(document.elementFromPoint(event.pageX, event.pageY)).parent();
                if (!$(row).hasClass('selected')) {
                    localTable.rows().deselect();
                    localTable.row(row).select();
                }
                event.preventDefault();
                var selected = localTable.rows({ selected: true }).data().pluck('path');
                var files = [];
                for (var s = 0, sl = selected.length; s < sl; s++)
                    files.push(selected[s]);
                _localDrag = 0;
                _remoteDrag = 0;
                if (files.length > 0) {
                    _localDrag = files;
                    ipcRenderer.send('ondragstart', files);
                }
                return false;
            };

            element.ondragend = (event) => {
                event.preventDefault();
                _localDrag = 0;
                _remoteDrag = 0;
                return false;
            };

            element = document.getElementById('remote-list');

            element.ondragend = (event) => {
                event.preventDefault();
                _localDrag = 0;
                _remoteDrag = 0;
                return false;
            };

            element.ondragstart = (event) => {
                var row = $(document.elementFromPoint(event.pageX, event.pageY)).parent();
                if (!$(row).hasClass('selected')) {
                    remoteTable.rows().deselect();
                    remoteTable.row(row).select();
                }
                event.preventDefault();
                var selected = remoteTable.rows({ selected: true }).data();
                var files = [];
                _remoteDrag = [];
                for (var s = 0, sl = selected.length; s < sl; s++) {
                    if (selected[s].size === -2)
                        files.push('jiMUDPath://' + selected[s].path);
                    else
                        files.push('jiMUD://' + selected[s].path);
                    _remoteDrag.push(selected[s].path);
                }
                _localDrag = 0;
                if (files.length > 0)
                    ipcRenderer.send('ondragstart', files, path.join(__dirname, '../assets/icons/png/drag2.png'));
            };

            element = document.getElementById('queue-list-container');
            element.ondragenter = (event) => {
                event.dataTransfer.dropEffect = 'copy';
                event.dataTransfer.effectAllowed = 'copy';
                event.preventDefault();
                event.cancelBubble = true;
                event.stopPropagation();
                return false;
            };

            element.ondragover = (event) => {
                event.dataTransfer.dropEffect = 'copy';
                event.dataTransfer.effectAllowed = 'copy';
                event.preventDefault();
                event.cancelBubble = true;
                event.stopPropagation();
                return false;
            };

            element.ondrop = async (event) => {
                event.preventDefault();
                if (_localDrag) {
                    _ied.begin();
                    for (var f = 0, fl = _localDrag.length; f < fl; f++) {
                        if (_local[path.basename(_localDrag[f])].size === -2)
                            uploadPath(_localDrag[f]);
                        else
                            if (!await uploadFile(_localDrag[f])) break;
                    }
                    _ied.end();
                    _localDrag = 0;
                    _queue = 0;
                }
                else if (_remoteDrag) {
                    _ied.begin();
                    for (f = 0, fl = _remoteDrag.length; f < fl; f++) {
                        if (_remote[path.basename(_remoteDrag[f])].size === -2)
                            downloadPath(_remoteDrag[f], options.local);
                        else
                            if (!await downloadFile(_remoteDrag[f])) break;
                    }
                    _ied.end();
                    _remoteDrag = 0;
                    _queue = 0;
                }
                else {
                    _ied.begin();
                    for (f = 0, fl = event.dataTransfer.files.length; f < fl; f++) {
                        var p;
                        if (event.dataTransfer.files[f].path.startsWith('jiMUDPath://')) {
                            p = event.dataTransfer.files[f].path.substring(12);
                            if (_remote[path.basename(p)].size === -2)
                                downloadPath(p, options.local);
                            else
                                if (!await downloadFile(p)) break;
                        }
                        else if (event.dataTransfer.files[f].path.startsWith('jiMUD://')) {
                            p = event.dataTransfer.files[f].path.substring(8);
                            if (_remote[path.basename(p)].size === -2)
                                downloadPath(p, options.local);
                            else
                                if (!await downloadFile(p)) break;
                        }
                        else if (event.dataTransfer.files[f].path.startsWith('/jiMUDPath:')) {
                            p = event.dataTransfer.files[f].path.substring(11);
                            if (_remote[path.basename(p)].size === -2)
                                downloadPath(p, options.local);
                            else
                                if (!await downloadFile(p)) break;
                        }
                        else if (event.dataTransfer.files[f].path.startsWith('/jiMUD:')) {
                            p = event.dataTransfer.files[f].path.substring(7);
                            if (_remote[path.basename(p)].size === -2)
                                downloadPath(p, options.local);
                            else
                                if (!await downloadFile(p)) break;
                        }
                        else if (event.dataTransfer.files[f].size < 1) {
                            var stat = fs.statSync(event.dataTransfer.files[f].path);
                            if (stat.isDirectory())
                                uploadPath(event.dataTransfer.files[f].path);
                            else
                                if (!await uploadFile(event.dataTransfer.files[f].path)) break;
                        }
                        else
                            if (!await uploadFile(event.dataTransfer.files[f].path)) break;
                    }
                    _ied.end();
                    _queue = 0;
                }
            };
            //#endregion
            $(window).trigger('resize');
        });

        function optionsLoaded() {
            loadOptions();
        }

        function processGMCP(mod, obj) {
            if (options && options.debug)
                console.log({ mod: mod, obj: obj });
            if (_ied)
                _ied.processGMCP(mod, obj);
        }

        function showLocalContextMenu() {
            var selected = localTable.rows({ selected: true }).data().pluck('size');
            var dirs = 0;
            for (var d = 0; d < selected.length; d++) {
                if (selected[d] === -2) {
                    dirs++;
                }
            }
            dirs = dirs === selected.length;

            var c = new Menu();
            c.append(new MenuItem({
                label: 'Refresh',
                click: () => {
                    updateLocal();
                }
            }));
            if (selected.length) {
                c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: 'Upload',
                    click: upload
                }));
                c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: 'Copy full path',
                    click: () => {
                        var selected = localTable.rows({ selected: true }).data().pluck('path');
                        clipboard.writeText(selected.join('\n'), 'selection');
                        clipboard.writeText(selected.join('\n'));
                    }
                }));
                c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: 'Rename',
                    click: renameLocal
                }));
                c.append(new MenuItem({
                    label: 'Delete',
                    click: deleteLocal
                }));
            }
            c.append(new MenuItem({ type: 'separator' }));
            c.append(new MenuItem({
                label: 'New file',
                click: newLocalFile
            }));
            c.append(new MenuItem({
                label: 'New directory',
                click: newFolderLocal
            }));
            c.append(new MenuItem({ type: 'separator' }));
            c.append(new MenuItem({
                label: 'Select all',
                click: () => {
                    localTable.rows().select();
                }
            }));
            if (selected.length) {
                c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: 'Reveal in explorer...',
                    click: revealExplorer
                }));
                if (!dirs) {
                    c.append(new MenuItem({ type: 'separator' }));
                    c.append(new MenuItem({
                        label: 'Open...',
                        click: openItems
                    }));
                    c.append(new MenuItem({
                        label: 'Open with editor...',
                        click: openWithEditor
                    }));
                    if (options.editor && options.editor.length > 0)
                        c.append(new MenuItem({
                            label: 'Open with external editor...',
                            click: openWithExternalEditor
                        }));
                }
            }
            c.popup({ window: remote.getCurrentWindow() });
        }

        function showRemoteContextMenu() {
            var selected = remoteTable.rows({ selected: true }).data().pluck('size');
            var dirs = 0;
            for (var d = 0; d < selected.length; d++) {
                if (selected[d] === -2) {
                    dirs++;
                }
            }
            dirs = dirs === selected.length;

            var c = new Menu();
            c.append(new MenuItem({
                label: 'Refresh',
                click: () => {
                    _ied.getDir((!options.remote || options.remote.length === 0) ? '.' : options.remote);
                }
            }));
            if (selected.length > 0) {
                c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: 'Download',
                    click: download
                }));
                c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: 'Goto',
                    accelerator: 'CmdOrCtrl+G',
                    click: () => { doCommandFirst('goto'); }
                }));
                c.append(new MenuItem({
                    label: 'Change to directory',
                    click: () => {
                        var selected = remoteTable.rows({ selected: true }).data();
                        if (!selected.length) return;
                        if (selected[0].size === -2)
                            window.opener.client.sendCommand(`cd ${selected[0].path}`);
                        else
                            window.opener.client.sendCommand(`cd ${path.dirname(selected[0].path)}`);
                    }
                }));
                c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: 'Update',
                    click: () => { doCommand('update'); }
                }));
                c.append(new MenuItem({
                    label: 'Renew',
                    click: () => { doCommand('renew'); }
                }));
                c.append(new MenuItem({
                    label: 'Clone',
                    click: () => { doCommand('clone'); }
                }));
                c.append(new MenuItem({
                    label: 'Dest',
                    click: () => { doCommand('dest', true); }
                }));
                c.append(new MenuItem({
                    label: 'Backup',
                    click: () => { doBackup(); }
                }));
                c.append(new MenuItem({
                    label: 'Copy full path',
                    click: () => {
                        var selected = remoteTable.rows({ selected: true }).data().pluck('path');
                        clipboard.writeText(selected.join('\n'), 'selection');
                        clipboard.writeText(selected.join('\n'));
                    }
                }));
                c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: 'Rename',
                    click: renameRemote
                }));
                c.append(new MenuItem({
                    label: 'Delete',
                    click: deleteRemote
                }));
            }
            else {
                c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: 'Change to directory',
                    click: () => {
                        window.opener.client.sendCommand(`cd ${options.remote}`);
                    }
                }));
            }
            c.append(new MenuItem({
                label: 'New directory',
                click: newFolderRemote
            }));
            c.append(new MenuItem({ type: 'separator' }));
            c.append(new MenuItem({
                label: 'Select all',
                click: () => {
                    remoteTable.rows().select();
                }
            }));
            if (!dirs && selected.length > 0) {
                c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: '&Edit...',
                    accelerator: 'CmdOrCtrl+Shift+O',
                    click: openRemoteWithEditor
                }));
            }
            c.popup({ window: remote.getCurrentWindow() });
        }

        function showQueueContextMenu() {
            var selected = queueTable.rows({ selected: true }).data();
            var c = new Menu();
            if (selected.length > 0) {
                c.append(new MenuItem({
                    label: 'Start',
                    click: queueStart
                }));
                c.append(new MenuItem({
                    label: 'Pause',
                    click: queuePause
                }));
                c.append(new MenuItem({
                    label: 'Stop',
                    click: queueStop
                }));
                c.append(new MenuItem({ type: 'separator' }));
            }
            c.append(new MenuItem({
                label: 'Select all',
                click: () => {
                    queueTable.rows().select();
                }
            }));
            c.append(new MenuItem({
                label: 'Reset',
                click: () => {
                    _ied.reset();
                }
            }));
            c.popup({ window: remote.getCurrentWindow() });
        }

        function updateStatus() {
            var tmp = [];
            var d, dl;
            if (info.localFiles + info.localDirs === 1)
                tmp.push(`Local: ${info.localFiles + info.localDirs} item`);
            else
                tmp.push(`Local: ${info.localFiles + info.localDirs} items`);

            var size = 0;
            var data = localTable.rows({ selected: true }).data();
            dl = data.length;
            for (d = 0; d < dl; d++) {
                if (data[d].size > 0)
                    size += data[d].size;
            }
            if (dl === 1)
                tmp.push(`${dl} item selected ${formatSize(size)}`);
            else if (dl > 0)
                tmp.push(`${dl} items selected ${formatSize(size)}`);

            $('#localInfo').text(tmp.join(', '));

            tmp = [];
            if (info.remoteFiles + info.remoteDirs === 1)
                tmp.push('Remote: 1 item');
            else
                tmp.push(`Remote: ${info.remoteFiles + info.remoteDirs} items`);

            size = 0;
            data = remoteTable.rows({ selected: true }).data();
            dl = data.length;
            for (d = 0; d < dl; d++) {
                if (data[d].size > 0)
                    size += data[d].size;
            }
            if (dl === 1)
                tmp.push(`${dl} item selected ${formatSize(size)}`);
            else if (dl > 0)
                tmp.push(`${dl} items selected ${formatSize(size)}`);

            if (tmp.length > 0)
                $('#remoteInfo').text(tmp.join(', '));

            tmp = [];
            if (info.uploads)
                tmp.push(`Uploads: ${info.uploads}`);
            if (info.downloads)
                tmp.push(`Downloads: ${info.downloads}`);
            $('#queueInfo').text(tmp.join(', '));
        }

        function toggleSync() {
            options.syncFolders = !options.syncFolders;
            menubar.updateItem('view|sync folders', { checked: options.syncFolders });
            if (options.syncFolders)
                $('#btn-sync').addClass('active');
            else
                $('#btn-sync').removeClass('active');
            saveOptions();
        }

        function toggleQueue() {
            options.showQueue = !options.showQueue;
            menubar.updateItem('view|show queue and log', { checked: options.showQueue });
            if (options.showQueue) {
                $('#btn-queue').addClass('active');
                $('#bottom').css('display', '');
                $('#main').css('bottom', options.queueSize + 'px');
            }
            else {
                $('#btn-queue').removeClass('active');
                $('#bottom').css('display', 'none');
                $('#main').css('bottom', '28px');
            }
            saveOptions();
            $(window).trigger('resize');
        }

        function openItem(path) {
            if (!path || path.length === 0) return;
            shell.openPath(path);
        }

        function openEditor(file, remote, remoteEdit) {
            if (!window.opener._windows['code.editor.html']) {
                window.opener.openWindow('code.editor').then(() => {
                    //not opened for what ever reason
                    if (!window.opener._windows['code.editor.html']) return;
                    window.opener._windows['code.editor.html'].addEventListener('load', () => {
                        window.opener._windows['code.editor.html'].openEditor(file, remote, remoteEdit);
                        window.opener._windows['code.editor.html'].focus();
                    });
                });
            }
            else {
                window.opener._windows['code.editor.html'].openEditor(file, remote, remoteEdit);
                window.opener._windows['code.editor.html'].focus();
            }
        }

        async function download() {
            var data = remoteTable.rows({ selected: true }).data();
            _ied.begin();
            for (var d = 0, dl = data.length; d < dl; d++) {
                if (data[d].size === -2)
                    downloadPath(data[d].path, options.local);
                else
                    if (!await downloadFile(data[d].path)) break;
            }
            _ied.end();
            _queue = 0;
        }

        async function upload() {
            var data = localTable.rows({ selected: true }).data();
            _ied.begin();
            for (var d = 0, dl = data.length; d < dl; d++) {
                if (data[d].size === -2)
                    uploadPath(data[d].path);
                else
                    if (!await uploadFile(data[d].path)) break;
            }
            _ied.end();
            _queue = 0;
        }

        async function uploadFile(file) {
            if (_remote[path.basename(file)]) {
                //if not applied to queue or always ask
                if (_queue !== 4 && options.fileExistAlways !== 2) {
                    const result = await fileExist(_local[path.basename(file)], _remote[path.basename(file)]);
                    if (!result) return false;
                }

                if (options.fileExistOverwrite === 2 || options.fileExistOverwrite === 6) {
                    //source older so skip
                    if (_local[path.basename(file)].date <= _remote[path.basename(file)].date)
                        return true;
                }
                if (options.fileExistOverwrite === 4 || options.fileExistOverwrite === 6) {
                    //same size so skip
                    if (_local[path.basename(file)].size === _remote[path.basename(file)].size)
                        return true;
                }
                //rename
                if (options.fileExistOverwrite === 8) {
                    name = getNewName(path.basename(file), _remote);
                    _ied.uploadTo(file, options.remote + '/' + name, false, 0, true);
                }
                //skip
                if (options.fileExistOverwrite === 16)
                    return true;
            }
            _ied.upload(file);
            return true;
        }

        async function downloadFile(file) {
            if (_local[path.basename(file)]) {
                //if not applied to queue or always ask
                if (_queue !== 4 && options.fileExistAlways !== 2) {
                    const result = await fileExist(_remote[path.basename(file)], _local[path.basename(file)]);
                    if (!result) return false;
                }

                if (options.fileExistOverwrite === 2 || options.fileExistOverwrite === 6) {
                    //source older so skip
                    if (_remote[path.basename(file)].date <= _local[path.basename(file)].date)
                        return true;
                }
                if (options.fileExistOverwrite === 4 || options.fileExistOverwrite === 6) {
                    //same size so skip
                    if (_remote[path.basename(file)].size === _local[path.basename(file)].size)
                        return true;
                }
                //rename
                if (options.fileExistOverwrite === 8) {
                    name = getNewName(path.basename(file), _local);
                    _ied.downloadTo(file, path.join(options.local, name), false, 0, true);
                }
                //skip
                if (options.fileExistOverwrite === 16)
                    return true;
            }
            _ied.download(file);
            return true;
        }

        var pFiles;
        var pTotal = 0;

        async function uploadPath(p) {
            _progressCancel = false;
            if (!pTotal && !$('#Progress')[0].open) {
                $('#Progressbar').html('<progress max="100"></progress>');
                $('#ProgressTitle').html('Preparing upload');
                $('#Progress')[0].showModal();
            }
            if (options.debug)
                console.log(`Upload path: ${p}`);
            //make dir then start uploads
            _ied.makeDirectory(options.remote + '/' + path.basename(p), false, true, () => {
                walk(p, (files, dirs, empty) => {
                    if (options.debug) {
                        console.log('Upload files:');
                        console.log(files);
                    }
                    var s = options.local.length;
                    if (options.local.endsWith('/') || options.local.endsWith('\\'))
                        s--;
                    var r = options.remote;
                    if (r.endsWith('/'))
                        r = r.substr(0, r.length - 1);

                    for (var e = 0, el = empty.length; e < el; e++) {
                        _ied.makeDirectory(r + path.dirname(empty[e]).substr(s).replace(/\\/g, '/') + '/' + path.basename(empty[e]), false, true);
                    }
                    if (pTotal) {
                        pFiles.push.apply(pFiles, files);
                        pTotal += files.length;
                    }
                    else {
                        pFiles = files;
                        pTotal = files.length;
                    }
                    upNext();
                });
            });
        }

        function upNext() {
            if (!pFiles || pFiles.length === 0 || _progressCancel) {
                pFiles = null;
                pTotal = 0;
                if ($('#Progress')[0].open)
                    $('#Progress')[0].close();
                return;
            }
            var file = pFiles.shift();
            var s = options.local.length;
            if (options.local.endsWith('/') || options.local.endsWith('\\'))
                s--;
            var r = options.remote;
            if (r.endsWith('/'))
                r = r.substr(0, r.length - 1);
            var p = path.dirname(file);
            p = r + p.substr(s).replace(/\\/g, '/');
            //TODO figure out how to implement file exist, as right now no way to get remote file info easily, maybe some type of async await call
            _ied.uploadTo(file, p + '/' + path.basename(file), false, 0, true);
            $('#Progress progress').val(Math.ceil((pTotal - pFiles.length) * 100 / pTotal));
            setTimeout(upNext, 0);
        }

        // eslint-disable-next-line no-unused-vars
        function progressCancel() {
            _progressCancel = true;
            pTotal = 0;
            pFiles = 0;
            if ($('#Progress')[0].open)
                $('#Progress')[0].close();
        }

        async function downloadPath(p, local) {
            _progressCancel = false;
            if (!pTotal && !$('#Progress')[0].open) {
                $('#Progressbar').html('<progress max="100"></progress>');
                $('#ProgressTitle').html('Preparing download');
                $('#Progress')[0].showModal();
            }
            if (options.debug)
                console.log(`Download path: ${p}`);
            if (local && !existsSync(path.join(local, path.basename(p)))) {
                fs.mkdirSync(path.join(local, path.basename(p)));
                logMessage('Creating directory: ' + path.join(local, path.basename(p)));
            }
            pTotal = 1;
            _ied.getDir(p, true, 'download:' + p, path.join(local, path.basename(p)));
        }

        async function downNext(file, local, remoteData) {
            try {
                if (existsSync(local)) {
                    var localData = IED.getFileInfo(local);
                    //if not applied to queue or always ask
                    if (_queue !== 4 && options.fileExistAlways !== 2) {
                        const result = await fileExist(remoteData, localData);
                        if (!result) return false;
                    }

                    if (options.fileExistOverwrite === 2 || options.fileExistOverwrite === 6) {
                        //source older so skip
                        if (remoteData.date <= localData.date)
                            return true;
                    }
                    if (options.fileExistOverwrite === 4 || options.fileExistOverwrite === 6) {
                        //same size so skip
                        if (remoteData.size === localData.size)
                            return true;
                    }
                    //rename
                    if (options.fileExistOverwrite === 8) {
                        const localPath = path.dirname(local);
                        name = getNewNamePath(path.basename(file), localPath);
                        _ied.downloadTo(file, path.join(localPath, name), false, 0, true);
                    }
                    //skip
                    if (options.fileExistOverwrite === 16)
                        return true;
                }
            }
            catch (error) {
                logError(error);
            }
            setTimeout(async () => {
                _ied.downloadTo(file, local, false, 0, true);
            }, 0);
        }

        // eslint-disable-next-line no-unused-vars
        function closing() {
            clearWatcher();
        }

        // eslint-disable-next-line no-unused-vars
        function closeHidden(hidden) {
            if (hidden) return true;
            //if (!closeable()) return false;
        }

        $closeWindow = false;
        function closeable(all) {
            if (!$closeWindow) {
                if (_prefs && !_prefs.closed) {
                    dialog.showMessageBox({
                        type: 'error',
                        title: 'Preferences dialog open',
                        message: 'You must close the Preferences dialog before you can close immortal tools.',
                        defaultId: 1,
                        noLink: true
                    });
                    $closeWindow = false;
                }
                else
                    $closeWindow = true;
            }
            return $closeWindow;
        }

        window.onbeforeunload = () => {
            if (window.opener) {
                window.opener.client.off('options-loaded', optionsLoaded);
                window.opener.client.off('received-GMCP', processGMCP);
            }
            clearWatcher();
        };

        function clearWatcher() {
            if (watcher)
                watcher.close();
        }

        function createWatcher() {
            clearWatcher();
            watcher = chokidar.watch(options.local, {
                persistent: true,
                depth: 0,
                ignoreInitial: true
            });

            // Something to use when events are received.
            var log = console.log.bind(console);
            var ready = false;
            watcher
                .on('error', error => {
                    if (options.debug)
                        log(`%cWatcher error: ${error}`, 'color: red');
                    logMessage(`Watcher error: ${error}`);
                })
                .on('ready', () => {
                    if (options.debug)
                        log('Initial scan complete. Ready for changes');
                    ready = true;
                })
                .on('addDir', (path) => {
                    if (options.debug)
                        log(`Directory ${path} has been added`);
                    if (ready && path != options.local)
                        addLocalFile(path);
                })
                .on('unlinkDir', p => {
                    if (options.debug)
                        log(`Directory ${p} has been removed`);
                    if (ready) removeLocalFile(p);
                })
                .on('add', (path) => {
                    if (options.debug)
                        log(`File ${path} has been added`);
                    if (ready && path != options.local)
                        addLocalFile(path);
                })
                .on('change', (path) => {
                    if (options.debug)
                        log(`File ${path} has been changed`);
                    updateLocalFile(path);
                })
                .on('unlink', p => {
                    if (options.debug)
                        log(`File ${p} has been removed`);
                    if (ready)
                        removeLocalFile(p);
                })
                .on('raw', (event, path, details) => {
                    if (options.debug)
                        log('Raw event info:', event, path, details);
                });
        }

        async function updateLocalFile(p) {
            try {
                var file = IED.getFileInfo(p);
            }
            catch (error) {
                logError(error);
                return;
            }
            if (file.hidden && !options.showhidden) {
                if (_local[file.name]) {
                    removeLocalFile(file.path);
                    info.localFiles--;
                    doUpdate(1);
                }
                return;
            }

            var row = localTable.row(function (idx, data) {
                return data.name === path.basename(p) ?
                    true : false;
            });
            _local[file.name] = file;
            if (row && row.length === 1)
                row.data(_local[file.name]);
            else {
                localTable.row.add(_local[file.name]);
                row = localTable.row(function (idx, data) {
                    return data.name === path.basename(p) ?
                        true : false;
                });
            }
            doUpdate(2);
            if (options.debug)
                console.log(_downloads[p]);
            if (file.size === -2)
                uploadPath(p);
            else if (!_downloads[p] && options.uploadOnChange)
                await uploadFile(p);
            if (_downloads[p]) {
                if (options.focusOnFinished)
                    _focusLocal = row;
                if (options.selectOnFinished) {
                    localTable.rows().deselect();
                    row.select();
                }
                delete _downloads[p];
            }
        }

        function removeLocalFile(p) {
            var row = localTable.row(function (idx, data) {
                return data.name === path.basename(p) ?
                    true : false;
            });
            row.remove();
            if (_local[path.basename(p)]) {
                if (_local[path.basename(p)].size === -2)
                    info.localDirs--;
                else
                    info.localFiles--;
                delete _local[path.basename(p)];
            }
            doUpdate(3);
        }

        async function addLocalFile(p) {
            try {
                var file = IED.getFileInfo(p);
            }
            catch (error) {
                logError(error);
                return;
            }
            if (file.hidden && !options.showhidden)
                return;
            if (file.size === -2)
                info.localDirs++;
            else
                info.localFiles++;
            _local[file.name] = file;
            localTable.row.add(_local[file.name]);
            if (options.debug)
                console.log(_downloads[p]);
            if (file.size != -2 && !_downloads[p] && options.uploadOnChange)
                await uploadFile(p);

            if (_downloads[p]) {
                var row = localTable.row(function (idx, data) {
                    return data.name === path.basename(p) ?
                        true : false;
                });
                if (options.focusOnFinished)
                    _focusLocal = row;
                if (options.selectOnFinished) {
                    localTable.rows().deselect();
                    row.select();
                }
                delete _downloads[p];
            }

            doUpdate(3);
        }

        function deleteLocal() {
            var data = localTable.rows({ selected: true }).data().pluck('path');
            for (var d = 0, dl = data.length; d < dl; d++)
                ipcRenderer.send('trash-item', data[d]);
            //shell.moveItemToTrash(data[d]);
            //shell.trashItem(data[d]).catch(err=>console.log(err));
        }

        function deleteRemote() {
            var data = remoteTable.rows({ selected: true }).data();
            dialog.showMessageBox({
                type: 'warning',
                title: 'Delete?',
                message: data.length > 1 ? 'Delete remote?' : 'Delete remote: ' + data[0].name + '?',
                buttons: ['Yes', 'No'],
                defaultId: 1,
                noLink: true
            }).then((result) => {
                if (result.response === 0) {

                    for (var d = 0, dl = data.length; d < dl; d++) {
                        if (data[d].size === -2)
                            deleteRemoteFolder(data[d].path);
                        else
                            _ied.deleteFile(data[d].path);
                    }
                }
            });
        }

        function deleteRemoteFolder(dir) {
            if (!$('#Progress')[0].open) {
                $('#Progressbar').html('<progress max="100"></progress>');
                $('#ProgressTitle').html('Preparing delete');
                $('#Progress')[0].showModal();
            }
            if (!pFiles)
                pFiles = [];
            pFiles.push(dir);
            _ied.deleteDirectory(dir, false, true);
            pTotal++;
        }

        function newFolderLocal() {
            $('#newFolder').data('type', 'local');
            $('#newFolderLabel').text('New local folder');
            $('#newFolder-name').val(getNewName('New Folder', _local));
            $('#newFolder-name')[0].selectionStart = 0;
            $('#newFolder-name')[0].selectionEnd = $('#newFolder-name').val().length;
            $('#newFolder')[0].showModal();
        }

        function newFolderRemote() {
            $('#newFolder').data('type', 'remote');
            $('#newFolderLabel').text('New remote folder');
            $('#newFolder-name').val(getNewName('New Folder', _remote));
            $('#newFolder-name')[0].selectionStart = 0;
            $('#newFolder-name')[0].selectionEnd = $('#newFolder-name').val().length;
            $('#newFolder')[0].showModal();
        }

        // eslint-disable-next-line no-unused-vars
        function newFolderOk() {
            var n = $('#newFolder-name').val();
            if (!n || n.length === 0) {
                dialog.showMessageBox({
                    type: 'error',
                    title: 'Name required',
                    message: 'You must supply a valid name!'
                });
                return;
            }
            if (IED.invalidFile(n)) {
                dialog.showMessageBox({
                    type: 'error',
                    title: 'Invalid folder name',
                    message: 'The name you supplied contains invalid characters!'
                });
                return;
            }
            if ($('#newFolder').data('type') === 'local') {
                if (_local[n]) {
                    n = getNewName(n, _local);
                    if (dialog.showMessageBoxSync({
                        type: 'warning',
                        title: 'File or folder exist?',
                        message: `Do you want to rename to "${n}"?`,
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                        noLink: true,
                        detail: 'There is already a file or folder with the same name in this location.',
                    }) != 0) {
                        return;
                    }
                }
                fs.mkdirSync(path.join(options.local, n));
                logMessage('Creating directory: ' + path.join(options.local, n));
            }
            else if ($('#newFolder').data('type') === 'remote') {
                if (_remote[n]) {
                    n = getNewName(n, _remote);
                    if (dialog.showMessageBoxSync({
                        type: 'warning',
                        title: 'File or folder exist?',
                        message: `Do you want to rename to "${n}"?`,
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                        noLink: true,
                        detail: 'There is already a file or folder with the same name in this location.',
                    }) != 0) {
                        return;
                    }
                }
                _ied.makeDirectory(options.remote + '/' + n);
            }
            $('#newFolder')[0].close();
        }

        function renameLocal() {
            var selected = localTable.rows({ selected: true });
            if (!selected || selected.length === 0) return;
            rename(selected, _local, (o, n) => {
                fs.renameSync(o, path.join(path.dirname(o), n));
            });
        }

        function renameRemote() {
            var selected = remoteTable.rows({ selected: true });
            if (!selected || selected.length === 0) return;
            rename(selected, _remote, (o, n) => {
                _ied.rename(o, path.dirname(o) + '/' + n);
            });
        }

        function rename(rows, list, callback) {
            var el = $(rows.nodes()[0].children[0]);
            var list = $(el.closest('tbody'));
            el.css('position', 'relative');
            var editor = $('<input class="form-control" style="position: absolute;top:0;left:0;right:0;bottom:0;width:auto;margin:0;height: auto;"/>');
            editor.path = rows.data()[0].path;
            editor.original = rows.data()[0].name;
            editor.update = function () {
                if (!list[editor.val()]) {
                    if (callback) callback(editor.path, editor.val());
                }
                else if (editor.val() != editor.original) {
                    var n = getNewName(editor.val(), list);
                    if (dialog.showMessageBoxSync({
                        type: 'warning',
                        title: 'Rename file?',
                        message: `Do you want to rename "${editor.original}" to "${n}"?`,
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                        noLink: true,
                        detail: 'There is already a file with the same name in this location.',
                    }) === 0 && callback) {
                        callback(editor.path, n);
                    }
                }
                editor.close();
            };
            editor.close = function (e) {
                if (e && e.target === editor[0])
                    return;
                $(window).off('click', editor.update);
                list.off('contextmenu', 'tr', editor.context);
                editor.remove();
                editor = null;
            };
            editor.on('blur', editor.close);
            editor.on('click', function (event) {
                event.cancelable = true;
                event.stopPropagation();
            });
            editor.on('keypress', function (event) {
                event.cancelable = true;
                event.stopPropagation();
            });
            editor.on('keydown', (event) => {
                if (event.which === 27)
                    editor.close();
                else if (event.which === 13)
                    editor.update();
                event.cancelBubble = true;
                event.stopPropagation();
            });

            $(window).on('click', editor.update);
            editor.context = e => {
                if (e && e.target === editor[0]) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.cancelBubble = true;
                    return;
                }
                editor.close();
            };
            editor.on('contextmenu', e => {
                e.preventDefault();
                e.stopPropagation();
                e.cancelBubble = true;

                let menu = [
                    { role: 'undo' },
                    { role: 'redo' },
                    { type: 'separator' },
                    { role: 'cut' },
                    { role: 'copy' },
                    { role: 'paste' },
                    { type: 'separator' },
                    { role: 'selectAll' },
                ];
                if (window.getGlobal('debug')) {
                    menu.push({ type: 'separator' });
                    menu.push({ label: 'Inspect', click: `ipcRenderer.invoke('contents', 'inspectElement', ${e.pageX}, ${e.pageY})` });
                }
                window.showContext(menu);
            })
            list.on('contextmenu', 'tr', editor.context);
            el.append(editor);
            editor.val(editor.original);
            editor.focus();

            editor[0].selectionStart = 0;
            if (editor.val().lastIndexOf('.') === -1)
                editor[0].selectionEnd = editor.val().length;
            else
                editor[0].selectionEnd = editor.val().lastIndexOf('.');
        }

        function getNewName(name, list) {
            if (!list[name]) return name;
            var i = 1;
            var ext = path.extname(name);
            var o = path.basename(name, ext);
            if (!list) list = _local;
            var n = o + ` (${i})` + ext;
            while (list[n]) {
                i++;
                n = o + ` (${i})` + ext;
            }
            return n;
        }

        function getNewNamePath(name, p) {
            if (!existsSync(path.join(p, name))) return name;
            var i = 1;
            var ext = path.extname(name);
            var o = path.basename(name, ext);
            if (!p) p = options.local;
            var n = o + ` (${i})` + ext;
            while (existsSync(path.join(p, n))) {
                i++;
                n = o + ` (${i})` + ext;
            }
            return n;
        }

        function queueStart() {
            var selected = queueTable.rows({ selected: true }).data().pluck('id');
            for (var q = 0, ql = selected.length; q < ql; q++)
                _ied.startItem(selected[q]);
        }
        function queuePause() {
            var selected = queueTable.rows({ selected: true }).data().pluck('id');
            for (var q = 0, ql = selected.length; q < ql; q++)
                _ied.pauseItem(selected[q]);
        }
        function queueStop() {
            var selected = queueTable.rows({ selected: true }).data().pluck('id');
            for (var q = 0, ql = selected.length; q < ql; q++)
                _ied.removeItem(selected[q]);
        }

        function doCommand(cmd, noExt) {
            if (!cmd || cmd.length === 0) return;
            var selected = remoteTable.rows({ selected: true }).data();
            for (var s = 0, sl = selected.length; s < sl; s++) {
                if (selected[s].size === -2) continue;
                if (noExt) {
                    var name = path.basename(selected[s].name, selected[s].type);
                    window.opener.client.sendCommand(`${cmd} ${options.remote}/${name}`);
                }
                else
                    window.opener.client.sendCommand(`${cmd} ${selected[s].path}`);
            }
        }

        function doCommandFirst(cmd) {
            if (!cmd || cmd.length === 0) return;
            var selected = remoteTable.rows({ selected: true }).data();
            for (var s = 0, sl = selected.length; s < sl; s++) {
                if (selected[s].size === -2) continue;
                window.opener.client.sendCommand(`${cmd} ${selected[s].path}`);
                break;
            }
        }

        function doBackup() {
            doCommand('backup');
            if (!_remote['bak']) {
                _remote['bak'] = {
                    name: 'bak',
                    path: options.remote + '/bak',
                    size: -2,
                    type: 'Directory',
                    date: new Date().getTime(),
                    hidden: false,
                    type2: -2
                };
                info.remoteDirs++;
                remoteTable.row.add(_remote['bak']);
                doUpdate(4);
            }
        }

        function updateDraw(table, what) {
            if (!table) return;
            if (!what) what = table;
            var body = $('.dataTables_scrollBody', table.table().container())[0];
            var st = body.scrollTop;
            what.draw();
            body.scrollTop = st;
        }

        function focusRow(row) {
            if (!row || row.length === 0) return;
            var top = row.node().offsetTop;
            var body = $('.dataTables_scrollBody', row.table().container())[0];
            var sTop = body.scrollTop;
            var sHeight = body.clientHeight;
            if (top < sTop || top + 31 >= sTop + sHeight)
                body.scrollTop = top;
        }

        function newLocalFile() {
            var file = path.join(options.local, getNewName('newfile', _local));
            fs.closeSync(fs.openSync(file, 'w'));
            setTimeout(() => {
                var row = localTable.row(function (idx, data) {
                    return data.name === path.basename(file) ?
                        true : false;
                });
                if (row && row.length > 0) {
                    focusRow(row);
                    localTable.rows().deselect();
                    row.select();
                    var row = localTable.rows({ selected: true });
                    if (!row || row.length === 0) return;
                    rename(row, _local, (o, n) => {
                        fs.renameSync(o, path.join(path.dirname(o), n));
                    });
                }
            }, 500);
        }

        function bulkQueueRemove() {
            if (!_remove || _remove.length === 0) {
                _removeID = null;
                return;
            }
            var ids = _remove.map(function callback(val) {
                return val.ID;
            });
            queueTable.rows(function (idx, data) {
                return ids.indexOf(data.id) !== -1;
            }).remove();
            var rc = _remove.length;
            const child_process = require('child_process');
            for (var r = 0; r < rc; r++) {
                var item = _remove[r];
                if (item.download) {
                    //Update local list if file was uploaded to current local
                    if (item.state === ItemState.done && options.openEditor) {
                        if (options.openExternalEditor) {
                            if (!options.editor || options.editor.length === 0)
                                openItem(item.local);
                            else {
                                var p = child_process.spawn(options.editor, [item.local], { detached: true, stdio: ['ignore', 'ignore', 'ignore'] });
                                p.unref();
                            }
                        }
                        else
                            openEditor(item.local, item.remote);
                    }
                    info.downloads--;
                }
                //only update if current remote is the same path as file
                else if (item.state === ItemState.done && path.dirname(item.remote) === options.remote) {
                    var row = remoteTable.row(function (idx, data) {
                        return data.name === path.basename(item.remote) ?
                            true : false;
                    });
                    _remote[path.basename(item.remote)] = {
                        name: path.basename(item.remote),
                        path: item.remote,
                        size: item.originalSize || item.totalSize,
                        type: path.extname(item.remote),
                        date: new Date().getTime(),
                        hidden: IED.isHidden(item.remote, true),
                        type2: 0
                    };
                    if (_remote[path.basename(item.remote)].hidden && !options.showHidden) {
                        delete _remote[path.basename(item.remote)];
                        return;
                    }
                    if (row && row.length === 1)
                        row.data(_remote[path.basename(item.remote)]);
                    else {
                        info.remoteFiles++;
                        remoteTable.row.add(_remote[path.basename(item.remote)]);
                        row = remoteTable.row(function (idx, data) {
                            return data.name === path.basename(item.remote) ?
                                true : false;
                        });
                    }
                    if (options.focusOnFinished)
                        _focusRemote = row;
                    if (options.selectOnFinished) {
                        remoteTable.rows().deselect();
                        row.select();
                    }
                    doUpdate(4);
                    info.uploads--;
                }
                else
                    info.uploads--;
            }
            var rows;
            if (info.uploads < 0) {
                rows = queueTable.rows(function (idx, data) {
                    return data.direction === '<-';
                });
                if (rows)
                    info.uploads = rows.count();
                else
                    info.uploads = 0;
            }
            if (info.downloads < 0) {
                rows = queueTable.rows(function (idx, data) {
                    return data.direction === '->';
                });
                if (rows)
                    info.downloads = rows.count();
                else
                    info.downloads = 0;
            }
            /*
            rows = queueTable.rows(function (idx, data) {
                return data.state === ItemState.working;
            });
            info.active = rows.count();
            */
            doUpdate(25);
            updateQueueProgress();
            _remove = null;
            _removeID = null;
        }

        function bulkQueueUpdate() {
            if (!_qUpdate || _qUpdate.length === 0) {
                _qUpdate = null;
                _qUpdateTracker = null;
                _qUpdateID = null;
                window.setProgressBar(-1);
                window.opener.updateProgress(-1);
                return;
            }
            var uc = _qUpdate.length;
            for (var u = 0; u < uc; u++) {
                var item = _qUpdate[u];
                var row = queueTable.row(function (idx, data) {
                    return data.id === item.ID ?
                        true : false;
                });
                if (row && row.length === 1) {
                    row.data({
                        'local': item.local,
                        'direction': item.download ? '<-' : '->',
                        'remote': item.remote,
                        'progress': item.percent,
                        'id': item.ID,
                        'state': item.state,
                        'error': item.error
                    });
                    doUpdate(8);
                }
            }
            /*
            var rows = queueTable.rows(function (idx, data) {
                return data.state === ItemState.working;
            });
            info.active = rows.count();
            */
            updateQueueProgress();
            _qUpdate = null;
            _qUpdateTracker = null;
            _qUpdateID = null;
        }

        function updateQueueProgress() {
            //var rows = localTable.rows().data().pluck('progress');
            var progress = 0;
            var count = 0;
            queueTable.rows().every(function (rowIdx, tableLoop, rowLoop) {
                var data = this.data();
                if (!data.error || data.error.length === 0) {
                    progress += data.progress;
                    count++;
                }
            });

            if (count === 0) {
                window.setProgressBar(-1);
                window.opener.updateProgress(-1);
            }
            else {
                progress /= count;
                window.setProgressBar(progress);
                window.opener.updateProgress(progress);
            }
            /*
                if (info.downloads + info.uploads === 0)
                    info.active = 0;
                if (info.active > 0) {
                    window.setProgressBar(1.0 - (info.downloads + info.uploads) / info.active);
                    window.opener.updateProgress(1.0 - (info.downloads + info.uploads) / info.active);
                }
                else {
                    window.setProgressBar(-1);
                    window.opener.updateProgress(-1);
                }
                */
        }

        var _rTimeout = 0;
        function doUpdate(type) {
            if (!type) return;
            _updating |= type;
            if (_updating === 0 || _rTimeout)
                return;
            _rTimeout = window.requestAnimationFrame(() => {
                if ((this._updating & 1) === 1) {
                    updateStatus();
                    _updating &= ~1;
                }
                if ((this._updating & 2) === 2) {
                    if (localTable)
                        updateDraw(localTable);
                    setTimeout(() => {
                        focusRow(_focusLocal);
                        _focusLocal = 0;
                    });
                    _updating &= ~2;
                }
                if ((this._updating & 4) === 4) {
                    if (remoteTable)
                        updateDraw(remoteTable);
                    setTimeout(() => {
                        focusRow(_focusRemote);
                        _focusRemote = 0;
                    });
                    _updating &= ~4;
                }
                if ((this._updating & 8) === 8) {
                    if (queueTable)
                        updateDraw(queueTable);
                    _updating &= ~8;
                }
                if ((this._updating & 16) === 16) {
                    updateMenu();
                    _updating &= ~16;
                }
                if ((this._updating & 32) === 32) {
                    logView[0].scrollTop = logView[0].scrollHeight;
                    _updating &= ~32;
                }
                if ((this._updating & 64) === 64) {
                    bulkQueueRemove();
                    _updating &= ~64;
                }
                if ((this._updating & 128) === 128) {
                    bulkQueueUpdate();
                    _updating &= ~128;
                }
                if ((this._updating & 256) === 256) {
                    queueTable.rows().invalidate('data').draw();
                    _updating &= ~256;
                }
                _rTimeout = 0;
                doUpdate(_updating);
            });
        }

        // eslint-disable-next-line no-unused-vars
        function toggleEditor() {
            options.openEditor = !options.openEditor;
            if (options.openEditor)
                $('#btn-editor-remote').addClass('active');
            else
                $('#btn-editor-remote').removeClass('active');
            saveOptions();
        }

        function openItems() {
            var selected = localTable.rows({ selected: true }).data().pluck('path');
            for (var d = 0, dl = selected.length; d < dl; d++)
                openItem(selected[d]);
        }

        function openWithEditor() {
            var selected = localTable.rows({ selected: true }).data();
            for (var d = 0, dl = selected.length; d < dl; d++) {
                if (selected[d].size === -2) continue;
                if (_remote[path.basename(selected[d].path)])
                    openEditor(selected[d].path, options.remote + '/' + path.basename(selected[d].path));
                else
                    openEditor(selected[d].path);
            }
        }

        function openRemoteWithEditor() {
            var selected = remoteTable.rows({ selected: true }).data();
            for (var d = 0, dl = selected.length; d < dl; d++) {
                if (selected[d].size === -2) continue;
                openEditor(null, options.remote + '/' + path.basename(selected[d].path), true);
            }
        }

        function openWithExternalEditor() {
            var selected = localTable.rows({ selected: true }).data().pluck('path');
            const child_process = require('child_process');
            for (var d = 0, dl = selected.length; d < dl; d++) {
                var p = child_process.spawn(options.editor, [selected[d]], { detached: true, stdio: ['ignore', 'ignore', 'ignore'] });
                p.unref();
            }
        }

        function revealExplorer() {
            var selected = localTable.rows({ selected: true }).data().pluck('path');
            for (var d = 0, dl = selected.length; d < dl; d++)
                shell.showItemInFolder(selected[d]);
        }

        async function fileExist(source, target) {
            return new Promise((resolve, reject) => {
                const feDialog = document.getElementById('FileExist');
                const fnClose = () => {
                    menubar.enabled = true;
                    feDialog.close();
                    feDialog.replaceWith(feDialog.cloneNode(true));
                    resolve(null);
                }
                feDialog.addEventListener('close', fnClose);
                feDialog.addEventListener('cancel', fnClose);
                document.getElementById('FileExist-cancel').addEventListener('click', fnClose);
                document.getElementById('FileExist-ok').addEventListener('click', () => {
                    feDialog.close();
                    options.fileExistOverwrite = 1;
                    if (document.getElementById('action-Overwrite-2').checked)
                        options.fileExistOverwrite = 2;
                    else if (document.getElementById('action-Overwrite-4').checked)
                        options.fileExistOverwrite = 4;
                    else if (document.getElementById('action-Overwrite-6').checked)
                        options.fileExistOverwrite = 6;
                    else if (document.getElementById('action-Overwrite-8').checked)
                        options.fileExistOverwrite = 8;
                    else if (document.getElementById('action-Overwrite-16').checked)
                        options.fileExistOverwrite = 16;
                    options.fileExistAlways = 0;
                    if (document.getElementById('always-2').checked)
                        options.fileExistAlways = 2;
                    else if (document.getElementById('always-4').checked) {
                        options.fileExistAlways = 4;
                        _queue = 4;
                    }
                    resolve({
                        action: options.fileExistOverwrite,
                        always: options.fileExistAlways
                    });
                    saveOptions();
                    feDialog.replaceWith(feDialog.cloneNode(true));
                });
                document.getElementById('always-1').checked = !options.fileExistAlways || options.fileExistAlways === 0;
                document.getElementById('always-2').checked = options.fileExistAlways === 2;
                document.getElementById('always-4').checked = options.fileExistAlways === 4;
                document.getElementById('action-Overwrite-' + (options.fileExistOverwrite || 1)).checked = true;
                if (source) {
                    document.getElementById('FileExist-source').style.display = '';
                    document.getElementById('FileExist-source-name').textContent = source.name || '';
                    document.getElementById('FileExist-source-date').textContent = source.date ? new moment(source.date).format('MM/DD/YYYY hh:mm:ss A') : '';
                    document.getElementById('FileExist-source-size').textContent = formatSize(source.size || 0);
                }
                else
                    document.getElementById('FileExist-source').style.display = 'none';
                if (target) {
                    document.getElementById('FileExist-target').style.display = '';
                    document.getElementById('FileExist-target-name').textContent = source.name || '';
                    document.getElementById('FileExist-target-date').textContent = source.date ? new moment(source.date).format('MM/DD/YYYY hh:mm:ss A') : '';
                    document.getElementById('FileExist-target-size').textContent = formatSize(source.size || 0);
                }
                else
                    document.getElementById('FileExist-target').style.display = 'none';
                menubar.enabled = false;
                feDialog.showModal();
            });
        }
    </script>
</head>

<body>
    <div id="main">
        <div id="local">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <label class="control-label" for="local-path">
                        Local
                        <button id="btn-refresh-local" type="button" class="btn btn-default btn-xs" title="Refresh" onclick="updateLocal();">
                            <i class="fa fa-refresh"></i>
                        </button>
                        <button id="btn-upload-local" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Upload files" onclick="upload()">
                            <i class="fa fa-upload"></i>
                        </button>
                        <div class="btn-group" role="group">
                            <button id="btn-rename-local" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Rename" onclick="renameLocal()">
                                <i class="fa fa-i-cursor"></i>
                            </button>
                            <button id="btn-delete-local" disabled="disabled" type="button" class="btn btn-danger btn-xs" title="Delete" onclick="deleteLocal()">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        <div class="btn-group" role="group">
                            <button id="btn-newFile-local" type="button" class="btn btn-default btn-xs" title="New file" onclick="newLocalFile()">
                                <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                                    <i class="fa fa-file-o fa-stack-2x" style="font-size: 1em"></i>
                                    <i class="fa fa-plus fa-stack-1x" style="font-size: 0.8em;margin-top: -2px;left:5px;"></i>
                                </span>
                            </button>
                            <button id="btn-newFolder-local" type="button" class="btn btn-default btn-xs" title="New directory" onclick="newFolderLocal()">
                                <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                                    <i class="fa fa-folder-o fa-stack-2x" style="font-size: 1em"></i>
                                    <i class="fa fa-plus fa-stack-1x" style="font-size: 0.8em;margin-top: -2px;left:5px;"></i>
                                </span>
                            </button>
                        </div>

                        <div class="btn-group" role="group">
                            <button id="btn-reveal-local" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Reveal in explorer" onclick="revealExplorer()">
                                <i class="fa fa-folder"></i>
                            </button>
                            <button id="btn-open-local" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Open..." onclick="openItems()">
                                <i class="fa fa-external-link"></i>
                            </button>
                            <button id="btn-editor-local" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Open with editor..." onclick="openWithEditor()">
                                <i class="fa fa-edit"></i>
                            </button>
                        </div>
                    </label>

                    <span class="path-container">
                        <div class="input-group">
                            <input type="text" id="local-path" class="form-control" />
                            <span class="input-group-btn">
                                <button id="button-local" class="btn btn-default dropdown-toggle" style="width:17px;min-width:17px;border-radius: 0;padding-left:4px;padding-right:4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                    <span class="caret" style="margin-left: -1px;"></span>
                                </button>
                                <ul id="local-navigate" class="dropdown-menu" aria-labelledby="button-local" data-container="body"></ul>
                                <button id="btn-local-up" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Go up a directory">
                                    <span class="fa-stack" style="top: -5px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                                        <i class="fa fa-folder-o fa-stack-2x" style="font-size: 1.2em"></i>
                                        <i class="fa fa-caret-up fa-stack-1x" style="font-size: 1em;margin-top: 1px;"></i>
                                    </span>
                                </button>
                            </span>

                        </div>
                    </span>
                    <span class="path-buttons">
                        <button id="btn-sync" type="button" class="btn btn-default btn-xs" title="Sync folders" onclick="toggleSync();">
                            <i class="fa fa-exchange"></i>
                        </button>
                    </span>
                </div>
                <div id="local-list-container" class="panel-body" style="padding:0px;top:61px;bottom:1px;left:1px;right:5px;position: absolute;">
                    <table tabindex="0" id="local-list" draggable="true" class="table table-striped table-hover table-condensed" style="width: 100%;height: 100%;padding:0px;margin:0px !important;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Size</th>
                                <th>Type</th>
                                <th>Date Modified</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
            <div id="drag-bar"></div>
        </div>
        <div id="remote">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <label class="control-label" for="remote-path">
                        Remote
                        <button id="btn-refresh-remote" type="button" class="btn btn-default btn-xs" title="Refresh" onclick="_ied.getDir((!options.remote || options.remote.length === 0) ? '.' : options.remote);">
                            <i class="fa fa-refresh"></i>
                        </button>
                        <button id="btn-download-remote" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Download files" onclick="download()">
                            <i class="fa fa-download"></i>
                        </button>

                        <div class="btn-group" role="group">
                            <button id="btn-rename-remote" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Rename" onclick="renameRemote()">
                                <i class="fa fa-i-cursor"></i>
                            </button>
                            <button id="btn-delete-remote" disabled="disabled" type="button" class="btn btn-danger btn-xs" title="Delete" onclick="deleteRemote()">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        <button id="btn-newFolder-remote" type="button" class="btn btn-default btn-xs" title="New directory" onclick="newFolderRemote()">
                            <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                                <i class="fa fa-folder-o fa-stack-2x" style="font-size: 1em"></i>
                                <i class="fa fa-plus fa-stack-1x" style="font-size: 0.8em;margin-top: -2px;left:5px;"></i>
                            </span>
                        </button>
                        <button id="btn-editor-remote" type="button" class="btn btn-default btn-xs" title="Open in editor" onclick="toggleEditor()">
                            <i class="fa fa-pencil"></i>
                        </button>
                        <button id="btn-edit-remote" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Edit..." onclick="openRemoteWithEditor()">
                            <i class="fa fa-edit"></i>
                        </button>
                    </label>

                    <span class="path-container">
                        <div class="input-group">
                            <input type="text" id="remote-path" class="form-control" />
                            <span class="input-group-btn">
                                <button id="button-remote" class="btn btn-default" style="width: 17px;min-width:17px;border-radius:0;padding-left:4px;padding-right:4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                    <span class="caret" style="margin-left: -1px;"></span>
                                </button>
                                <ul id="remote-navigate" class="dropdown-menu pull-right" aria-labelledby="button-remote" data-container="body"></ul>
                                <button id="btn-remote-up" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Go up a directory">
                                    <span class="fa-stack" style="top: -5px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                                        <i class="fa fa-folder-o fa-stack-2x" style="font-size: 1.2em"></i>
                                        <i class="fa fa-caret-up fa-stack-1x" style="font-size: 1em;margin-top: 1px;"></i>
                                    </span>
                                </button>
                            </span>
                        </div>
                    </span>
                </div>
                <div id="remote-list-container" class="panel-body" style="padding:0px;top:61px;bottom:1px;left:1px;right:1px;position: absolute;">
                    <table tabindex="0" id="remote-list" draggable="true" class="table table-striped table-hover table-condensed" style="width: 100%;height: 100%;padding:0px;margin:0px !important;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Size</th>
                                <th>Type</th>
                                <th>Date Modified</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="bottom">
        <div id="btm-drag-bar"></div>
        <button type="button" class="close" style="padding: 10px;" onclick="toggleQueue();">&times;</button>
        <ul class="nav nav-tabs" role="tablist" style="background-color: #F5F5F5;box-shadow: inset 0 -1px 0 #fff;">
            <li role="presentation" class="active">
                <a href="#queue" aria-controls="queue" role="tab" data-toggle="tab">Queue</a>
            </li>
            <li role="presentation">
                <a href="#log" aria-controls="log" role="tab" data-toggle="tab">Log</a>
            </li>
        </ul>
        <div class="tab-content" style="padding: 4px;position: absolute;left: 0;right: 0;bottom: 0;top: 46px;">
            <div role="tabpanel" class="tab-pane fade in active" id="queue" style="margin:0 !important;padding:4px;height:100%;">
                <div id="toolbar" class="btn-toolbar" role="toolbar">
                    <div class="btn-group" role="group" id="queue-controls">
                        <button id="btn-start" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Start" onclick="queueStart()">
                            <i class="fa fa-play"></i>
                        </button>
                        <button id="btn-pause" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Pause" onclick="queuePause()" data-toggle="button">
                            <i class="fa fa-pause"></i>
                        </button>
                        <button id="btn-stop" disabled="disabled" type="button" class="btn btn-warning btn-xs" title="Stop" onclick="queueStop()">
                            <i class="fa fa-stop"></i>
                        </button>
                    </div>
                    <button id="btn-reset" type="button" class="btn btn-warning btn-xs" title="Reset all" onclick="_ied.reset();">
                        <i class="fa fa-eject"></i>
                    </button>
                </div>
                <div id="queue-list-container" style="padding:0px;top:28px;bottom:0px;left:2px;right:2px;position: absolute;">
                    <table tabindex="0" id="queue-list" class="table table-striped table-hover table-condensed" style="width: 100%;height: 100%;padding:0px;margin:0 !important;">
                        <thead>
                            <tr>
                                <th>Local</th>
                                <th>&lt;-&gt;</th>
                                <th>Remote</th>
                                <th>Progress</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="log" style="padding:4px;height:100%;">
                <div role="tabpanel" class="tab-pane fade in active" id="queue" style="margin:0 !important;padding:4px;height:100%;">
                    <div id="toolbar-log" class="btn-toolbar" role="toolbar">
                        <button id="btn-clear" type="button" class="btn btn-default btn-xs" title="Clear log" onclick="$('#log-view').html('');">
                            <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                                <i class="fa fa-file-o fa-stack-2x" style="font-size: 1em"></i>
                                <i class="fa fa-times fa-stack-1x" style="font-size: 0.5em;margin-top: 1px;"></i>
                            </span>
                        </button>
                    </div>
                    <pre id="log-view"></pre>
                </div>
            </div>
        </div>
    </div>
    <div id="status" class="btn-toolbar" role="toolbar">
        <div id="localInfo" style="float:left;display:block;"></div>
        <div id="queueInfo" style="float:left;display:block;"></div>
        <div id="remoteInfo" style="float:right;display:block;"></div>
    </div>
    <dialog id="newFolder" style="z-index:1000;height:150px;width:350px;">
        <div class="dialog-body">
            <div class="form-group">
                <label class="control-label" for="newFolder-name" id="newFolderLabel">New folder</label>
                <input id="newFolder-name" class="form-control">
            </div>
        </div>
        <div class="dialog-footer">
            <button style="float: right" type="button" class="btn btn-default" onclick="$('#newFolder')[0].close();">Cancel</button>
            <button style="float: right" type="button" class="btn btn-primary" onclick="newFolderOk()">Ok</button>
        </div>
    </dialog>
    <dialog id="Progress" style="z-index:1000;text-align:center">
        <div id="ProgressTitle"></div>
        <div id="Progressbar">
            <progress max="100"></progress>
        </div>
        <div>
            <button onclick="progressCancel()">
                Cancel
            </button>
        </div>
    </dialog>
    <dialog id="FileExist" style="z-index:1000;height:360px;width:600px;">
        <div class="dialog-body">
            <fieldset id="FileExist-source" class="col-sm-6 form-group">
                <legend style="margin:0">Source:</legend>
                <div id="FileExist-source-name"></div>
                <div id="FileExist-source-date"></div>
                <div id="FileExist-source-size"></div>
            </fieldset>
            <fieldset id="FileExist-target" class="col-sm-6 form-group">
                <legend style="margin:0">Target:</legend>
                <div id="FileExist-target-name"></div>
                <div id="FileExist-target-date"></div>
                <div id="FileExist-target-size"></div>
            </fieldset>
            <div class="col-sm-8 form-group">
                <fieldset>
                    <legend style="margin:0">Action</legend>
                    <ul style="list-style-type: none; margin: 0;padding: 0;">
                        <li>
                            <label>
                                <input type="radio" name="action-Overwrite" id="action-Overwrite-1"> Overwrite
                            </label>
                        </li>
                        <li>
                            <label>
                                <input type="radio" name="action-Overwrite" id="action-Overwrite-2"> Overwrite if source newer
                            </label>
                        </li>
                        <li>
                            <label>
                                <input type="radio" name="action-Overwrite" id="action-Overwrite-4"> Overwrite if different sizes
                            </label>
                        </li>
                        <li>
                            <label>
                                <input type="radio" name="action-Overwrite" id="action-Overwrite-6"> Overwrite if source newer or different sizes
                            </label>
                        </li>
                        <li>
                            <label>
                                <input type="radio" name="action-Overwrite" id="action-Overwrite-8"> Rename
                            </label>
                        </li>
                        <li>
                            <label>
                                <input type="radio" name="action-Overwrite" id="action-Overwrite-16"> Skip
                            </label>
                        </li>
                    </ul>
                </fieldset>
            </div>
            <div class="col-sm-4 form-group">
                <fieldset>
                    <legend style="margin:0">Apply</legend>
                    <ul style="list-style-type: none; margin: 0;padding: 0;">
                        <li>
                            <label>
                                <input type="radio" name="always" id="always-1"> Just this file
                            </label>
                        </li>
                        <li>
                            <label>
                                <input type="radio" name="always" id="always-2"> Always
                            </label>
                        </li>
                        <li>
                            <label>
                                <input type="radio" name="always" id="always-4"> Just for this queue
                            </label>
                        </li>
                    </ul>
                </fieldset>
            </div>
        </div>
        <div class="dialog-footer">
            <button id="FileExist-cancel" style="float: right" type="button" class="btn btn-default">Cancel</button>
            <button id="FileExist-ok" style="float: right" type="button" class="btn btn-primary">Ok</button>
        </div>
    </dialog>
</body>

</html>
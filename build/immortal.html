<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>Immortal Tools</title>
    <link rel="shortcut icon" href="../assets/icons/png/ied.png" />
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="css/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link href="css/bootstrap-select.min.css" rel="stylesheet" type="text/css" />
    <link href="css/bootstrap-treeview.min.css" rel="stylesheet" type="text/css" />
    <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/immortal.css" rel="stylesheet" type="text/css" />
    <link href="css/form.css" rel="stylesheet" type="text/css" />
    <link href="css/datatables.min.css" rel="stylesheet" type="text/css" />
    <script>
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="../lib/jquery.min.js" type="text/javascript"></script>
    <script src="../lib/bootstrap.min.js" type="text/javascript"></script>
    <script src="../lib/bootstrap-select.min.js" type="text/javascript"></script>
    <script src="../lib/datatables.min.js" type="text/javascript"></script>
    <script src="../lib/datatables.scrollresize.js" type="text/javascript"></script>
    <script>
        //cSpell:ignore hellip datatable, datatables, scrollresize, drivelist, prefs, unref, toggledevtools, readdir, mountpoints, estart, showhidden, extname, prepend, mkdir
        //cSpell:ignore keypress, haspopup, labelledby, tabindex, tablist, tabpanel
        const { IED, ItemState } = require('./js/ied');
        const { TempType, IEDCmdStatus } = require('./js/types');
        const { remote, ipcRenderer, shell, clipboard } = require('electron');
        const { app, dialog, Menu, MenuItem } = remote;
        const { parseTemplate, existsSync } = require('./js/library');
        const { Settings } = require('./js/settings');
        const fs = require('fs-extra');
        const child_process = require('child_process');
        const path = require('path');
        const drivelist = require('drivelist');
        const moment = require('moment');

        var chokidar = require('chokidar');

        var _ied, options;
        var _local = {}, _remote = {}, _downloads = {};
        var info = { localDirs: 0, localFiles: 0, remoteDirs: 0, remoteFiles: 0, uploads: 0, downloads: 0 };
        var localTable, remoteTable, queueTable, key = '', keyClearID;
        var watcher;
        var dragging = false, btmDragging = false;
        var _localDrag, _remoteDrag, _progressCancel = false;

        var menu = [
            {
                label: '&File',
                id: 'file',
                submenu: [
                    {
                        label: '&Upload',
                        accelerator: "CmdOrCtrl+U",
                        enabled: false,
                        click: upload
                    },
                    {
                        label: '&Download',
                        accelerator: "CmdOrCtrl+D",
                        enabled: false,
                        click: download
                    },
                    { type: 'separator' },
                    {
                        label: 'Preferences...',
                        click: () => {
                            window.open('immortal.prefs.html', 'modal', 'backgroundColor=#fff,height=300,width=600,icon=' + path.join(__dirname, '../assets/icons/png/preferences.png'));
                        }
                    },
                    { type: 'separator' },
                    {
                        label: '&Close',
                        click: () => { window.close(); }
                    }
                ]
            },
            {
                label: '&Queue',
                submenu: [
                    {
                        label: '&Start',
                        enabled: false,
                        click: queueStart
                    },
                    {
                        label: '&Pause',
                        enabled: false,
                        click: queuePause
                    },
                    {
                        label: '&Stop',
                        enabled: false,
                        click: queueStop
                    },
                    { type: 'separator' },
                    {
                        label: 'Select &all',
                        click: () => {
                            queueTable.rows().select();
                        }
                    },
                    {
                        label: '&Reset all',
                        accelerator: "CmdOrCtrl+R",
                        click: () => { _ied.reset(); }
                    },
                ]
            },
            {
                label: '&Edit',
                submenu: [
                    {
                        label: '&Refresh all',
                        accelerator: "F5",
                        click: () => {
                            updateLocal();
                            _ied.getDir((!options.remote || options.remote.length === 0) ? '.' : options.remote);
                        }
                    },
                    { type: 'separator' },
                    {
                        label: '&Local',
                        submenu: [
                            {
                                label: '&Refresh',
                                accelerator: "CmdOrCtrl+F5",
                                click: () => {
                                    updateLocal();
                                }
                            },
                            { type: 'separator' },
                            {
                                label: '&Copy full path',
                                click: () => {
                                    var selected = localTable.rows({ selected: true }).data().pluck('path');
                                    clipboard.writeText(selected.join('\n'), 'selection');
                                }
                            },
                            { type: 'separator' },
                            {
                                label: '&Rename',
                                enabled: false,
                                accelerator: "CmdOrCtrl+F2",
                                click: renameLocal
                            },
                            {
                                label: '&Delete',
                                enabled: false,
                                accelerator: "CmdOrCtrl+Delete",
                                click: deleteLocal
                            },
                            {
                                label: '&New directory',
                                accelerator: "CmdOrCtrl+N",
                                click: newFolderLocal
                            },
                            { type: 'separator' },
                            {
                                label: '&Select all',
                                accelerator: "CmdOrCtrl+Alt+A",
                                click: () => {
                                    localTable.rows().select();
                                }
                            },
                            { type: 'separator' },
                            {
                                label: '&Reveal in explorer...',
                                enabled: false,
                                accelerator: "CmdOrCtrl+X",
                                click: () => {
                                    var data = localTable.rows({ selected: true }).data().pluck('path');
                                    for (var d = 0, dl = data.length; d < dl; d++)
                                        shell.showItemInFolder(data[d]);
                                }
                            },

                            { type: 'separator' },
                            {
                                label: '&Open...',
                                enabled: false,
                                accelerator: "CmdOrCtrl+O",
                                click: () => {
                                    var data = localTable.rows({ selected: true }).data().pluck('path');
                                    for (var d = 0, dl = data.length; d < dl; d++)
                                        openItem(data[d]);
                                }
                            },
                            {
                                label: 'Open &with editor...',
                                enabled: false,
                                accelerator: "CmdOrCtrl++Shift+E",
                                click: () => {
                                    var data = localTable.rows({ selected: true }).data().pluck('path');
                                    for (var d = 0, dl = data.length; d < dl; d++) {
                                        var p = child_process.spawn(options.editor, [data[d]], { detached: true, stdio: ['ignore', 'ignore', 'ignore'] });
                                        p.unref();
                                    }
                                }
                            }
                        ]
                    },
                    {
                        label: '&Remote',
                        enabled: true,
                        submenu: [
                            {
                                label: '&Refresh',
                                accelerator: "CmdOrCtrl+Shift+F5",
                                click: () => {
                                    if ($("#remote-list").hasClass("focused"))
                                        _ied.getDir((!options.remote || options.remote.length === 0) ? '.' : options.remote);
                                }
                            },
                            { type: 'separator' },
                            {
                                label: '&Goto',
                                enabled: false,
                                accelerator: "CmdOrCtrl+G",
                                click: () => { doCommandFirst("goto"); }
                            },
                            {
                                label: '&Change to directory',
                                enabled: false,
                                click: () => {
                                    var selected = remoteTable.rows({ selected: true }).data();
                                    if (!selected.length) return;
                                    if (selected[0].size === -2)
                                        ipcRenderer.send('send-command', `cd ${selected[0].path}`);
                                    else
                                        ipcRenderer.send('send-command', `cd ${path.dirname(selected[0].path)}`);
                                }
                            },
                            { type: 'separator' },
                            {
                                label: '&Update',
                                enabled: false,
                                // accelerator: "CmdOrCtrl+U",
                                click: () => { doCommand("update"); }
                            },
                            {
                                label: '&Renew',
                                enabled: false,
                                //accelerator: "CmdOrCtrl+U",
                                click: () => { doCommand("renew"); }
                            },
                            {
                                label: '&Clone',
                                enabled: false,
                                //accelerator: "CmdOrCtrl+U",
                                click: () => { doCommand("clone"); }
                            },
                            //clone x...
                            {
                                label: '&Dest',
                                enabled: false,
                                //accelerator: "CmdOrCtrl+U",
                                click: () => { doCommand("dest", true); }
                            },
                            {
                                label: '&Backup',
                                enabled: false,
                                accelerator: "CmdOrCtrl+B",
                                click: doBackup
                            },
                            {
                                label: '&Copy full path',
                                enabled: false,
                                click: () => {
                                    var selected = remoteTable.rows({ selected: true }).data().pluck('path');
                                    clipboard.writeText(selected.join('\n'), 'selection');
                                }
                            },
                            { type: 'separator' },
                            {
                                label: '&Rename',
                                enabled: false,
                                accelerator: "CmdOrCtrl+ShiftF2",
                                click: renameRemote
                            },
                            {
                                label: '&Delete',
                                enabled: false,
                                accelerator: "CmdOrCtrl+Shift+Delete",
                                click: deleteRemote
                            },
                            {
                                label: '&New directory',
                                accelerator: "CmdOrCtrl+Shift+N",
                                click: newFolderRemote
                            },
                            { type: 'separator' },
                            {
                                label: '&Select all',
                                accelerator: "CmdOrCtrl+Shift+A",
                                click: () => {
                                    remoteTable.rows().select();
                                }
                            },
                        ]
                    },
                    { type: 'separator' },
                    {
                        label: '&Clear log',
                        click: () => {
                            $("#log-view").html('');
                        }
                    }
                ]
            },
            {
                label: '&View',
                submenu: [
                    {
                        label: '&Show queue and log',
                        type: 'checkbox',
                        accelerator: "CmdOrCtrl+Q",
                        click: () => { toggleQueue(); }
                    },
                    {
                        label: 'Sync folders',
                        type: 'checkbox',
                        accelerator: "CmdOrCtrl+Shift+S",
                        click: () => { toggleSync(); }
                    },
                    { type: 'separator' },
                    {
                        label: '&Editor',
                        accelerator: "CmdOrCtrl+E",
                        click: () => {
                            shell.openItem(options.editor);
                        }
                    },
                    { type: 'separator' },
                    {
                        role: 'toggledevtools'
                    }
                ]
            },

        ];
        var menubar = Menu.buildFromTemplate(menu);
        remote.getCurrentWindow().setMenu(menubar);

        function updateMenuItem(args) {
            var item, i = 0, items;
            var tItem, tItems;
            if (args == null || args.menu == null) return;

            if (!Array.isArray(args.menu))
                args.menu = args.menu.split('|');

            items = menubar.items;
            tItems = menu;
            for (i = 0; i < args.menu.length; i++) {
                if (!items || items.length === 0) break;
                for (var m = 0; m < items.length; m++) {
                    if (!items[m]) continue;
                    if (items[m].id === args.menu[i] || items[m].label.toLowerCase().replace(/&/g, '') === args.menu[i].toLowerCase()) {
                        item = items[m];
                        tItem = tItems[m];
                        if (item.submenu) {
                            items = item.submenu.items;
                            tItems = tItem.submenu;
                        }
                        else
                            items = null;
                        break;
                    }
                }
            }
            if (!item)
                return;
            if (args.enabled != null)
                item.enabled = args.enabled ? true : false;
            if (args.checked != null)
                item.checked = args.checked ? true : false;
            if (args.icon != null)
                item.icon = args.icon;
            if (args.visible != null)
                item.visible = args.visible ? true : false;
            if (args.position != null)
                item.position = args.position;

            tItem.enabled = item.enabled;
            tItem.checked = item.checked;
            tItem.icon = item.icon;
            tItem.visible = item.visible;
            tItem.position = item.position;
        }

        // List all files in a directory in Node.js recursively in a synchronous fashion
        var walkSync = function (dir, fileList, dirList, empty) {
            var path = path || require('path');
            var fs = fs || require('fs'),
                files = fs.readdirSync(dir);
            fileList = fileList || [];
            dirList = dirList || [];
            empty = empty || [];
            if (files.length == 0)
                empty.push(dir);
            files.forEach(function (file) {
                if (fs.statSync(path.join(dir, file)).isDirectory()) {
                    dirList.push(path.join(dir, file));
                    var t = walkSync(path.join(dir, file), fileList, dirList, empty);
                    fileList = t.files;
                    dirList = t.dirs;
                    empty = t.empty;
                }
                else {
                    fileList.push(path.join(dir, file));
                }
            });
            return { files: fileList, dirs: dirList, empty: empty };
        };

        var walk = function (dir, callback) {
            var path = path || require('path');
            var fs = fs || require('fs');
            fs.readdir(dir, (err, files) => {
                var fileList = [];
                var dirList = [];
                var empty = [];
                if (files.length == 0)
                    empty.push(dir);
                files.forEach(function (file) {
                    if (fs.statSync(path.join(dir, file)).isDirectory()) {
                        dirList.push(path.join(dir, file));
                        var t = walkSync(path.join(dir, file), fileList, dirList, empty);
                        fileList = t.files;
                        dirList = t.dirs;
                        empty = t.empty;
                    }
                    else {
                        fileList.push(path.join(dir, file));
                    }
                });
                if (callback)
                    callback(fileList, dirList, empty);

            });
        };

        (function () {
            function fileSort(a, b) {
                if (_local[a].size === -2 && _local[b].size != -2)
                    return -1;
                if (_local[a].size != -2 && _local[b].size === -2)
                    return 1;
                return a.localeCompare(b);
            }

            function rFileSort(a, b) {
                if (_remote[a].size === -2 && _remote[b].size != -2)
                    return -1;
                if (_remote[a].size != -2 && _remote[b].size === -2)
                    return 1;
                return a.localeCompare(b);
            }

            jQuery.extend(jQuery.fn.dataTableExt.oSort, {
                "file-asc": function (a, b) {
                    return fileSort(a, b);
                },

                "file-desc": function (a, b) {
                    return fileSort(a, b) * -1;
                },

                "rFile-asc": function (a, b) {
                    return rFileSort(a, b);
                },

                "rFile-desc": function (a, b) {
                    return rFileSort(a, b) * -1;
                },

                "moment-asc": function (a, b) {
                    if (moment(a).isBefore(b))
                        return -1;
                    if (moment(b).isBefore(a))
                        return 1;
                    return 0;
                },

                "moment-desc": function (a, b) {
                    if (moment(a).isBefore(b))
                        return 1;
                    if (moment(b).isBefore(a))
                        return -1;
                    return 0;
                },

            });

            jQuery.fn.dataTable.ext.type.order['file-size-pre'] = function (data) {
                var matches = data.match(/^(\d+(?:\.\d+)?)\s*([a-z]+)/i);
                var multipliers;

                if (process.platform === 'darwin')
                    multipliers = {
                        b: 1,
                        bytes: 1,
                        kb: 1000,
                        kib: 1024,
                        mb: 1000000,
                        mib: 1048576,
                        gb: 1000000000,
                        gib: 1073741824,
                        tb: 1000000000000,
                        tib: 1099511627776,
                        pb: 1000000000000000,
                        pib: 1125899906842624
                    };
                else
                    multipliers = {
                        b: 1,
                        bytes: 1,
                        kb: 1024,
                        kib: 1024,
                        mb: 1048576,
                        mib: 1048576,
                        gb: 1073741824,
                        gib: 1073741824,
                        tb: 1099511627776,
                        tib: 1099511627776,
                        pb: 1125899906842624,
                        pib: 1125899906842624
                    };

                if (matches) {
                    var multiplier = multipliers[matches[2].toLowerCase()];
                    return parseFloat(matches[1]) * multiplier;
                } else {
                    return -1;
                }
            };
        }());

        function formatSize(size) {
            if (size >= 1073741824)
                return Math.round(size / 1073741824).toLocaleString() + " GB";
            else if (size >= 1048576)
                return Math.round(size / 1048576).toLocaleString() + " MB";
            else if (size >= 1024)
                return Math.round(size / 1024).toLocaleString() + " KB";
            return size + " B";
        }

        function loadOptions(data) {
            if (!data) {
                var set = Settings.load(remote.getGlobal('settingsFile'));
                options = set.extensions["immortal"];
            }
            else
                options = data;
            if (!options) {
                options = {
                    'local': '',
                    'remote': '',
                    'editor': '',
                    'bufferSize': 0,
                    'openEditor': true,
                    'queueSize': 250,
                    'localSize': 400,
                    'syncFolders': true,
                    'showQueue': true,
                    'showHidden': false,
                    'uploadOnChange': false,
                    'debug': false,
                    'logErrors': false,
                    'tempFile': TempType.extension
                };
                saveOptions();
            }
            $('#local').css("width", options.localSize);
            $('#remote').css("left", options.localSize);

            $('#bottom').css("height", options.queueSize);
            $('#main').css("bottom", options.queueSize);

            updateMenuItem({ menu: 'view|sync folders', checked: options.syncFolders });
            if (options.syncFolders)
                $("#btn-sync").addClass("active");
            else
                $('#btn-sync').removeClass('active');
            updateMenuItem({ menu: 'edit|editor', enabled: options.editor && options.editor.length > 0 });
            updateMenuItem({ menu: 'view|show queue and log', checked: options.showQueue });
            if (options.showQueue) {
                $("#btn-queue").addClass("active");
                $("#bottom").css('display', '');
                $("#main").css('bottom', (options.queueSize + 26) + 'px');
            }
            else {
                $('#btn-queue').removeClass('active');
                $("#bottom").css('display', 'none');
                $("#main").css('bottom', '28px');
            }
            if (localTable)
                localTable.draw();
            if (remoteTable)
                remoteTable.draw();
            if (queueTable)
                queueTable.draw();
        }

        function saveOptions() {
            if (_ied) {
                _ied.local = options.local;
                _ied.remote = options.remote;
                _ied.bufferSize = options.bufferSize;
                _ied.useTemp = options.tempFile;
            }
            ipcRenderer.send('setting-changed', { type: 'extensions', name: 'immortal', value: options });
        }

        function updateLocal(p) {
            if (!p || p.length === 0)
                p = options.local || app.getPath('downloads');
            else if (!existsSync(p))
                p = app.getPath('downloads');
            options.local = p;
            createWatcher();
            saveOptions();
            var parts = p.split(path.sep);
            if (p.endsWith(path.sep))
                parts.pop();
            var dir = fs.readdirSync(p);
            var dirs = [];
            var all = [];
            _local = {};
            var file;
            for (var d = 0, dl = dir.length; d < dl; d++) {
                try {
                    file = IED.getFileInfo(path.join(p, dir[d]));
                }
                catch (error) {
                    logError(error);
                    continue;
                }
                if (file.hidden && !options.showhidden)
                    continue;
                if (file.size === -2)
                    dirs.push(file);
                all.push(file);
                _local[file.name] = file;
            }
            info.localDirs = dirs.length;
            info.localFiles = all.length - dirs.length;
            $("#local-path").val(p);
            $("#local-navigate").empty();
            drivelist.list((error, drives) => {
                if (error) {
                    logMessage(error);
                    return;
                }
                var paths = [];
                var found = false;
                var c = '', pt, d, dl, pl, cl;
                if (drives.length > 0) {
                    for (d = 0, dl = drives.length; d < dl; d++) {
                        if (drives[d].mountpoints.length === 0)
                            continue;
                        for (var m = 0, ml = drives[d].mountpoints.length; m < ml; m++) {
                            if (!drives[d].mountpoints[m].path) continue;
                            var sd = drives[d].mountpoints[m].path.split(path.sep);
                            c = '';
                            for (pt = 0, pl = sd.length; pt < pl; pt++) {
                                c = path.join(c, sd[pt], path.sep);
                                if (c.toLowerCase() === parts[0].toLowerCase() + path.sep) {
                                    found = true;
                                    if (pt === 0)
                                        paths.push({ drive: true, path: c, name: sd[pt], count: pt, open: parts.length === 1 });
                                    else
                                        paths.push({ path: c, name: sd[pt], count: pt, open: parts.length === 1 });
                                }
                                else if (pt === 0)
                                    paths.push({ drive: true, path: c, name: sd[pt], count: pt });
                                else
                                    paths.push({ path: c, name: sd[pt], count: pt });
                            }
                            //paths.push({ drive: true, count: 0, path: path.join(drives[d].mountpoints[m].path, path.sep), name: drives[d].mountpoints[m].path });

                        }
                    }
                }
                c = found ? c = path.join(parts[0], path.sep) : '';
                for (pt = found ? 1 : 0, pl = parts.length; pt < pl; pt++) {
                    c = path.join(c, parts[pt], path.sep);
                    if (pt === pl - 1)
                        paths.push({ path: c, name: parts[pt], count: pt, open: true });
                    else
                        paths.push({ path: c, name: parts[pt], count: pt });
                }
                for (d = 0, dl = dirs.length; d < dl; d++) {
                    paths.push({ path: dirs[d].path, name: dirs[d].name, count: pt });
                }

                paths.sort(function compare(a, b) {
                    if (a.path.toUpperCase() < b.path.toUpperCase())
                        return -1;
                    if (a.path.toUpperCase() > b.path.toUpperCase())
                        return 1;
                    return 0;
                });
                $("#local-navigate").empty();
                for (c = 0, cl = paths.length; c < cl; c++) {
                    if (paths[c].drive && paths[c].open)
                        $("#local-navigate").append(`<li><a href="#" class="active" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-server"></i> ${paths[c].name}</a></li>`);
                    else if (paths[c].drive)
                        $("#local-navigate").append(`<li><a href="#" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-server"></i> ${paths[c].name}</a></li>`);
                    else if (paths[c].open)
                        $("#local-navigate").append(`<li><a href="#" class="active" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-folder-open-o"></i> ${paths[c].name}</a></li>`);
                    else
                        $("#local-navigate").append(`<li><a href="#" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-folder-o"></i> ${paths[c].name}</a></li>`);
                }
            });

            localTable.rows().remove().draw();
            localTable.rows.add(all).draw();
            $("#btn-local-up").prop('disabled', path.dirname(p) === p || path.dirname === path.join(p, path.sep));
            updateStatus();
        }

        function updateRemote(p, dir) {
            options.remote = p;
            saveOptions();
            var dirs = [];
            var all = [];
            var parts = p.split('/');
            if (p.endsWith('/'))
                parts.pop();
            _remote = {};
            info.remoteDirs = 0;
            info.remoteFiles = 0;
            var file;
            var paths = [];
            var c = [], d, dl, cl;
            for (d = 0, dl = dir.length; d < dl; d++) {
                file = {
                    name: path.basename(dir[d].file),
                    path: (p === "/" ? '' : p) + "/" + dir[d].file,
                    size: dir[d].size,
                    type: path.extname(dir[d].file),
                    date: dir[d].date * 1000,
                    hidden: IED.isHidden((p === "/" ? '' : p) + "/" + dir[d].file, true)
                };
                if (file.hidden && !options.showhidden)
                    continue;
                if (file.size === -2) {
                    file.type = "Directory";
                    dirs.push(file);
                    info.remoteDirs++;
                }
                else
                    info.remoteFiles++;

                all.push(file);
                _remote[file.name] = file;
                updateStatus();
            }
            $("#remote-path").val(p);
            for (var pt = 0, pl = parts.length; pt < pl; pt++) {
                c.push(parts[pt]);
                if (pt === 0)
                    paths.push({ path: "/", name: "/", count: pt, open: pt === pl - 1 });
                else
                    paths.push({ path: c.join('/'), name: parts[pt], count: pt, open: pt === pl - 1 });
            }
            for (d = 0, dl = dirs.length; d < dl; d++) {
                paths.push({ path: dirs[d].path, name: dirs[d].name, count: pt });
            }

            paths.sort(function compare(a, b) {
                if (a.path.toUpperCase() < b.path.toUpperCase())
                    return -1;
                if (a.path.toUpperCase() > b.path.toUpperCase())
                    return 1;
                return 0;
            });
            $("#remote-navigate").empty();
            for (c = 0, cl = paths.length; c < cl; c++) {
                if (paths[c].drive && paths[c].open)
                    $("#remote-navigate").append(`<li><a href="#" class="active" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-server"></i> ${paths[c].name}</a></li>`);
                else if (paths[c].drive)
                    $("#remote-navigate").append(`<li><a href="#" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-server"></i> ${paths[c].name}</a></li>`);
                else if (paths[c].open)
                    $("#remote-navigate").append(`<li><a href="#" class="active" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-folder-open-o"></i> ${paths[c].name}</a></li>`);
                else
                    $("#remote-navigate").append(`<li><a href="#" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-folder-o"></i> ${paths[c].name}</a></li>`);
            }
            remoteTable.rows().remove().draw();
            remoteTable.rows.add(all).draw();
            $("#btn-remote-up").prop('disabled', path.dirname(p) === p || path.dirname === path.join(p, path.sep));
        }

        function logMessage(msg) {
            if (!msg) return;
            $("#log-view").html($("#log-view").html() + msg.toString() + "<br>");
            $("#log-view")[0].scrollTop = $("#log-view")[0].scrollHeight;
        }

        function logError(error) {
            if (!error) return;
            var msg;
            if (error.stack)
                msg = error.stack;
            else if (error instanceof TypeError)
                msg = error.name + " - " + error.message;
            else if (error instanceof Error)
                msg = error.name + " - " + error.message;
            else if (error.message)
                msg = error.message;
            else
                msg = error;
            if (options.debug)
                console.log(error);
            if (options.logErrors) {
                fs.writeFileSync(parseTemplate(path.join('{data}', "jimud.error.log")), "Immortal Tools: " + new Date().toLocaleString() + '\n', { flag: 'a' });
                fs.writeFileSync(parseTemplate(path.join('{data}', "jimud.error.log")), msg + '\n', { flag: 'a' });
            }
        }

        var updatingMenu = false;

        function updateMenu() {
            if (updatingMenu) return;
            updatingMenu = true;
            setTimeout(() => {
                //var remote = $("#remote-list").hasClass("focused");
                //var local = $("#local-list").hasClass("focused");
                //var queue = $("#queue-list").hasClass("focused");
                //var either = remote || local;
                //var localFilesOnly = false;
                //var localFoldersOnly = false;
                var localSelected = false;
                //var remoteFilesOnly = false;
                //var remoteFoldersOnly = false;
                var remoteSelected = false;
                var queueSelected = false;

                var data = localTable.rows({ selected: true }).data().pluck('size');
                localSelected = data.length != 0;
                /*
                var dirs = 0;
                var d, dl;
                for (d = 0, dl = data.length; d < data.length; d++) {
                    if (data[d] === -2) {
                        dirs++;
                    }
                }
                */
                //localFilesOnly = dirs != data.length;
                //localFoldersOnly = dirs === data.length;

                data = remoteTable.rows({ selected: true }).data().pluck('size');
                remoteSelected = data.length != 0;
                /*
                dirs = 0;
                for (d = 0; d < data.length; d++) {
                    if (data[d] === -2) {
                        dirs++;
                    }
                }
                */
                //remoteFilesOnly = dirs != data.length;
                //remoteFoldersOnly = dirs === data.length;

                data = queueTable.rows({ selected: true }).data();
                queueSelected = data.length != 0;

                updateMenuItem({ menu: 'file|upload', enabled: localSelected });
                updateMenuItem({ menu: 'file|download', enabled: remoteSelected });

                updateMenuItem({ menu: 'queue|start', enabled: queueSelected });
                updateMenuItem({ menu: 'queue|pause', enabled: queueSelected });
                updateMenuItem({ menu: 'queue|stop', enabled: queueSelected });

                updateMenuItem({ menu: 'edit|local|rename', enabled: localSelected });
                updateMenuItem({ menu: 'edit|local|delete', enabled: localSelected });

                updateMenuItem({ menu: 'edit|local|reveal in explorer...', enabled: localSelected });
                updateMenuItem({ menu: 'edit|local|open...', enabled: localSelected });
                updateMenuItem({ menu: 'edit|local|open with editor...', enabled: localSelected && options.editor && options.editor.length > 0 });

                updateMenuItem({ menu: 'edit|remote|goto', enabled: remoteSelected });
                updateMenuItem({ menu: 'edit|remote|change to directory', enabled: remoteSelected });
                updateMenuItem({ menu: 'edit|remote|update', enabled: remoteSelected });
                updateMenuItem({ menu: 'edit|remote|renew', enabled: remoteSelected });
                updateMenuItem({ menu: 'edit|remote|clone', enabled: remoteSelected });
                updateMenuItem({ menu: 'edit|remote|dest', enabled: remoteSelected });
                updateMenuItem({ menu: 'edit|remote|backup', enabled: remoteSelected });
                updateMenuItem({ menu: 'edit|remote|copy full path', enabled: remoteSelected });

                updateMenuItem({ menu: 'edit|remote|rename', enabled: remoteSelected });
                updateMenuItem({ menu: 'edit|remote|delete', enabled: remoteSelected });

                $("#btn-rename-local").prop('disabled', !localSelected);
                $("#btn-delete-local").prop('disabled', !localSelected);
                $("#btn-upload-local").prop('disabled', !localSelected);

                $("#btn-rename-remote").prop('disabled', !remoteSelected);
                $("#btn-delete-remote").prop('disabled', !remoteSelected);
                $("#btn-download-remote").prop('disabled', !remoteSelected);

                $("#btn-start").prop('disabled', !queueSelected);
                $("#btn-pause").prop('disabled', !queueSelected);
                $("#btn-stop").prop('disabled', !queueSelected);
                updateStatus();
                updatingMenu = false;
            }, 0);
        }

        $(document).ready(() => {

            $('#local-list').DataTable({
                keys: true,
                paging: false,
                select: {
                    style: 'os'
                },
                searching: false,
                info: false,
                scrollY: 300,
                scrollX: 300,
                fixedHeader: {
                    header: true,
                    footer: false
                },
                scrollResize: true,
                language: { zeroRecords: '', emptyTable: '' },
                autoWidth: false,
                columnDefs: [
                    {
                        type: 'file',
                        targets: 0,
                        createdCell: function (td, cellData, rowData, row, col) {
                            if (rowData.size === -2) {
                                $(td).prepend('<i class="fa fa-folder-o" style="margin-right: 2px"></i>');
                            }
                            else {
                                switch (rowData.type.toLowerCase()) {
                                    case ".7z":
                                    case ".zip":
                                    case ".rar":
                                        $(td).prepend('<i class="fa fa-file-archive-o" style="margin-right: 2px"></i>');
                                        break;
                                    case ".txt":
                                        $(td).prepend('<i class="fa fa-file-text-o" style="margin-right: 2px"></i>');
                                        break;
                                    case ".h":
                                    case ".c":
                                        $(td).prepend('<i class="fa fa-file-code-o" style="margin-right: 2px"></i>');
                                        break;
                                    default:
                                        $(td).prepend('<i class="fa fa-file-o" style="margin-right: 2px"></i>');
                                        break;
                                }
                            }
                        }
                    },
                    {
                        render: function (data, type, full, meta) {
                            if (data === -2)
                                return '';
                            return formatSize(data);
                        },
                        targets: 1
                    },
                    {
                        type: 'file-size',
                        targets: 1
                    },
                    {
                        type: "moment",
                        targets: 3,
                        render: function (data) {
                            return new moment(data).format('MM/DD/YYYY hh:mm:ss A');
                        }
                    }
                ],
                columns: [
                    { data: 'name', width: '200px' },
                    { data: 'size', width: '200px' },
                    { data: 'type', width: '200px' },
                    { data: 'date', width: '200px' }
                ]
            });
            $('#remote-list').DataTable({
                keys: true,
                paging: false,
                select: {
                    style: 'os'
                },
                searching: false,
                info: false,
                scrollY: 300,
                scrollX: 300,
                fixedHeader: {
                    header: true,
                    footer: false
                },
                scrollResize: true,
                language: { zeroRecords: '', emptyTable: '' },
                autoWidth: false,
                columnDefs: [
                    {
                        type: 'rFile',
                        targets: 0,
                        createdCell: function (td, cellData, rowData, row, col) {
                            if (rowData.size === -2) {
                                $(td).prepend('<i class="fa fa-folder-o" style="margin-right: 2px"></i>');
                            }
                            else {
                                switch (rowData.type.toLowerCase()) {
                                    case ".7z":
                                    case ".zip":
                                    case ".rar":
                                        $(td).prepend('<i class="fa fa-file-archive-o" style="margin-right: 2px"></i>');
                                        break;
                                    case ".txt":
                                        $(td).prepend('<i class="fa fa-file-text-o" style="margin-right: 2px"></i>');
                                        break;
                                    case ".h":
                                    case ".c":
                                        $(td).prepend('<i class="fa fa-file-code-o" style="margin-right: 2px"></i>');
                                        break;
                                    default:
                                        $(td).prepend('<i class="fa fa-file-o" style="margin-right: 2px"></i>');
                                        break;
                                }
                            }
                        }
                    },
                    {
                        render: function (data, type, full, meta) {
                            if (data === -2)
                                return '';
                            return formatSize(data);
                        },
                        targets: 1
                    },
                    {
                        type: 'file-size',
                        targets: 2
                    },
                    {
                        type: "moment",
                        targets: 3,
                        render: function (data) {
                            return new moment(data).format('MM/DD/YYYY hh:mm:ss A');
                        }
                    }
                ],
                columns: [
                    { data: 'name', width: '200px' },
                    { data: 'size', width: '200px' },
                    { data: 'type', width: '200px' },
                    { data: 'date', width: '200px' }
                ]
            });
            $('#queue-list').DataTable({
                data: [],
                paging: false,
                select: true,
                searching: false,
                info: false,
                scrollY: 300,
                scrollX: '100vw',
                fixedHeader: {
                    header: true,
                    footer: false
                },
                scrollResize: true,
                ordering: false,
                language: { zeroRecords: '', emptyTable: '' },
                columnDefs: [
                    {
                        type: 'file',
                        targets: 0,
                        render: function (data, type, full, meta) {
                            if (full.state === ItemState.paused)
                                return '<i class="fa fa-pause" style="width:12px; margin-right: 2px"></i>' + data;
                            if (full.state === ItemState.error)
                                return '<i class="fa fa-warning" style="width:12px; margin-right: 2px"></i>' + data;
                            return '<i class="fa fa-play" style="width:12px; margin-right: 2px"></i>' + data;
                        }
                    },
                    {
                        render: function (data, type, full, meta) {
                            return `<div class="progressbar"><div class="progressbar-text">${Math.round(100 * data)}%</div><div class="progressbar-value" style="width: ${100 - 100 * data}%"></div></div>`;
                        },
                        targets: 3
                    },
                    {
                        width: '30px',
                        targets: 1
                    },
                    {
                        width: '150px',
                        targets: 3
                    }
                ],
                columns: [
                    { data: 'local' },
                    { data: 'direction', width: '30px' },
                    { data: 'remote' },
                    { data: 'progress', width: '150px' }
                ]
            });
            loadOptions();
            _ied = new IED(options.local, options.remote);
            _ied.bufferSize = options.bufferSize;
            _ied.useTemp = options.tempFile;
            _ied.on('error', (error) => {
                var msg;
                if (error.stack)
                    msg = error.stack;
                else if (error instanceof TypeError)
                    msg = error.name + " - " + error.message;
                else if (error instanceof Error)
                    msg = error.name + " - " + error.message;
                else if (error.message)
                    msg = error.message;
                else if (error.msg)
                    msg = error.msg;
                else
                    msg = error;
                logMessage(msg);
                logError(msg);
            });
            _ied.on('reset', () => {
                queueTable.rows().remove().draw();
            });
            _ied.on('dir', (dir, files, tag) => {
                if (tag === 'dir:browse')
                    updateRemote(dir, files);
                else if (tag === 'dir:download') {
                    //TODO dl folder
                }
            });
            _ied.on('resolved', (dir, tag) => {
                logMessage("Resolved: " + dir);
            });
            _ied.on('message', (msg) => {
                logMessage(msg);
            });

            _ied.on('add', (item) => {
                if (item.download) {
                    _downloads[item.local] = true;
                    if (item.tmp === TempType.extension)
                        _downloads[item.local + ".tmp"] = true;
                    info.downloads++;
                }
                else
                    info.uploads++;
                updateStatus();
                queueTable.row.add({
                    "local": item.local,
                    "direction": item.download ? "<-" : "->",
                    "remote": item.remote,
                    "progress": item.percent,
                    "id": item.ID,
                    "state": item.state
                }).draw();
            });
            _ied.on('remove', (item) => {
                queueTable.rows(function (idx, data, node) {
                    return data.id === item.ID ?
                        true : false;
                }).remove().draw();
                updateMenu();
                if (item.download) {
                    //Update local list if file was uploaded to current local
                    if (item.state === ItemState.done && options.openEditor) {
                        if (!options.editor || options.editor.length === 0)
                            openItem(item.local);
                        else {
                            var p = child_process.spawn(options.editor, [item.local], { detached: true, stdio: ['ignore', 'ignore', 'ignore'] });
                            p.unref();
                        }
                    }
                    info.downloads--;
                }
                else {
                    //only update if current remote is the same path as file
                    if (item.state === ItemState.done && path.dirname(item.remote) === options.remote) {
                        var row = remoteTable.row(function (idx, data, node) {
                            return data.name === path.basename(item.remote) ?
                                true : false;
                        });
                        _remote[path.basename(item.remote)] = {
                            name: path.basename(item.remote),
                            path: item.remote,
                            size: item.totalSize,
                            type: path.extname(item.remote),
                            date: new Date().getTime(),
                            hidden: IED.isHidden(item.remote, true)
                        };
                        if (_remote[path.basename(item.remote)].hidden && !options.showHidden) {
                            delete _remote[path.basename(item.remote)];
                            return;
                        }
                        if (row && row.length === 1)
                            row.remove();
                        else
                            info.remoteFiles++;
                        remoteTable.row.add(_remote[path.basename(item.remote)]).draw();
                        info.uploads--;
                    }
                    else
                        info.uploads--;
                    updateStatus();
                }
                ipcRenderer.send('set-progress-window', 'immortal', { value: -1 });
                ipcRenderer.send('set-progress', { value: -1 });
            });
            _ied.on('update', (item) => {
                queueTable.row(function (idx, data, node) {
                    return data.id === item.ID ?
                        true : false;
                }).data({
                    "local": item.local,
                    "direction": item.download ? "<-" : "->",
                    "remote": item.remote,
                    "progress": item.percent,
                    "id": item.ID,
                    "state": item.state
                }).draw();
                ipcRenderer.send('set-progress-window', 'immortal', { value: item.percent });
                ipcRenderer.send('set-progress', { value: item.percent });
            });

            _ied.on('cmd', (obj) => {
                var row;
                if (obj.cmd === "rm") {
                    if (obj.code === IEDCmdStatus.success) {
                        logMessage(`Deleted: ${obj.path}/${obj.file}`);

                        row = remoteTable.row(function (idx, data, node) {
                            return data.name === obj.file ?
                                true : false;
                        });
                        delete _remote[obj.file];
                        if (row && row.length === 1)
                            row.remove().draw();
                        info.remoteFiles--;
                        updateStatus();
                    }
                    else {
                        logMessage(`Failed to delete: ${obj.path}/${obj.file}`);
                        dialog.showMessageBox(remote.getCurrentWindow(), {
                            type: 'error',
                            title: "Could not delete",
                            message: "Could not delete: " + obj.path + "/" + obj.file,
                        });
                    }
                }
                else if (obj.cmd === "mv") {
                    if (obj.code === IEDCmdStatus.success) {
                        logMessage(`Renamed ${obj.path}/${obj.file} to ${obj.path2}/${obj.file2}`);

                        row = remoteTable.row(function (idx, data, node) {
                            return data.name === obj.file ?
                                true : false;
                        });
                        _remote[obj.file2] = _remote[obj.file];
                        delete _remote[obj.file];
                        if (row && row.length === 1)
                            row.remove();

                        //update old data to new data
                        _remote[obj.file2].name = obj.file2;
                        _remote[obj.file2].path = obj.path2 + "/" + obj.file2;
                        _remote[obj.file2].hidden = IED.isHidden(_remote[obj.file2].path, true);

                        if (_remote[obj.file2].hidden && !options.showHidden) {
                            delete _remote[obj.file2];
                            info.remoteFiles--;
                            return;
                        }
                        remoteTable.row.add(_remote[obj.file2]).draw();
                        updateStatus();
                    }
                    else {
                        logMessage(`Failed to rename: ${obj.path}/${obj.file}`);
                        dialog.showMessageBox(remote.getCurrentWindow(), {
                            type: 'error',
                            title: "Could not rename",
                            message: "Could not rename: " + obj.file,
                        });
                    }
                }
                else if (obj.cmd === "mkdir") {
                    if (obj.code === IEDCmdStatus.success) {
                        logMessage(`Created directory ${obj.path}`);
                        var name = path.basename(obj.path);
                        row = remoteTable.row(function (idx, data, node) {
                            return data.name === name ?
                                true : false;
                        });
                        _remote[name] = {
                            name: name,
                            path: name,
                            size: -2,
                            type: "Directory",
                            date: new Date().getTime(),
                            hidden: IED.isHidden(obj.path, true)
                        };
                        if (_remote[name].hidden && !options.showHidden) {
                            delete _remote[name];
                            return;
                        }
                        if (row && row.length === 1)
                            row.remove();
                        else
                            info.remoteDirs++;
                        remoteTable.row.add(_remote[name]).draw();
                        updateStatus();
                    }
                    else {
                        logMessage(`Failed to create directory: ${obj.path}}`);
                        dialog.showMessageBox(remote.getCurrentWindow(), {
                            type: 'error',
                            title: "Could not create directory",
                            message: "Could not create: " + path.basename(obj.path),
                        });
                    }
                }
            });

            localTable = $('#local-list').DataTable();
            remoteTable = $('#remote-list').DataTable();
            queueTable = $('#queue-list').DataTable();

            localTable.on('user-select', function (e, dt, type, cell, originalEvent) {
                if ($(cell.node()).parent().hasClass('selected') && dt.rows('.selected').data().length === 1) {
                    e.preventDefault();
                }
            });

            remoteTable.on('user-select', function (e, dt, type, cell, originalEvent) {
                if ($(cell.node()).parent().hasClass('selected') && dt.rows('.selected').data().length === 1) {
                    e.preventDefault();
                }
            });

            queueTable.on('user-select', function (e, dt, type, cell, originalEvent) {
                if ($(cell.node()).parent().hasClass('selected') && dt.rows('.selected').data().length === 1) {
                    e.preventDefault();
                }
            });

            $('#local-list tbody').on('contextmenu', 'tr', function (e) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;

                if (!$(this).hasClass('selected')) {
                    localTable.rows().deselect();
                    localTable.row(this).select();
                }
                showLocalContextMenu();
            });

            $('#local-list-container').on('contextmenu', function (e) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;
                showLocalContextMenu();
            });

            $('#remote-list tbody').on('contextmenu', 'tr', function (e) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;

                if (!$(this).hasClass('selected')) {
                    remoteTable.rows().deselect();
                    remoteTable.row(this).select();
                }
                showRemoteContextMenu();
            });

            $('#remote-list-container').on('contextmenu', function (e) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;
                showRemoteContextMenu();
            });

            $('#queue-list tbody').on('contextmenu', 'tr', function (e) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;

                if (!$(this).hasClass('selected')) {
                    queueTable.rows().deselect();
                    queueTable.row(this).select();
                }
                showQueueContextMenu();
            });

            $('#queue-list-container').on('contextmenu', function (e) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;
                showQueueContextMenu();
            });

            $("#log-view").on('contextmenu', function (e) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;
                var c = new Menu();
                if (window.getSelection().type === "Range") {
                    c.append(new MenuItem({ role: 'copy' }));
                    c.append(new MenuItem({ type: 'separator' }));
                }
                c.append(new MenuItem({
                    label: 'Clear log',
                    click: () => {
                        $("#log-view").html('');
                    }
                }));
                c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: 'Select all',
                    click: () => {
                        var selection = window.getSelection();
                        var range = document.createRange();
                        range.selectNodeContents($("#log-view")[0]);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                }));
                c.popup(remote.getCurrentWindow(), { async: true });
            });

            localTable.on('select', function (e, dt, type, indexes) {
                if (type === 'row') {
                    updateMenu();
                }
            });

            localTable.on('deselect', function (e, dt, type, indexes) {
                if (type === 'row') {
                    updateMenu();
                }
            });

            remoteTable.on('select', function (e, dt, type, indexes) {
                if (type === 'row') {
                    updateMenu();
                }
            });

            remoteTable.on('deselect', function (e, dt, type, indexes) {
                if (type === 'row') {
                    updateMenu();
                }
            });

            queueTable.on('select', function (e, dt, type, indexes) {
                if (type === 'row') {
                    updateMenu();
                }
            });

            queueTable.on('deselect', function (e, dt, type, indexes) {
                if (type === 'row') {
                    updateMenu();
                }
            });

            $("#local-list").on('keypress', function (e) {
                key += e.key;
                var row = localTable.row(function (idx, data, node) { return data.name.startsWith(key) ? true : false; });
                //$("#local-list_wrapper .dataTables_scrollBody")[0].scrollTop = $("#local-list_wrapper .dataTables_scrollBody")[0].scrollHeight - (row.index() * $(row.node()).outerHeight());
                if (!row || row.length === 0) return;
                localTable.rows().deselect();
                var top = row.node().offsetTop;
                var sTop = $("#local-list_wrapper .dataTables_scrollBody")[0].scrollTop;
                var sHeight = $("#local-list_wrapper .dataTables_scrollBody")[0].clientHeight;
                if (top < sTop || top + 31 >= sTop + sHeight)
                    $("#local-list_wrapper .dataTables_scrollBody")[0].scrollTop = top;
                //$("#local-list_wrapper .dataTables_scrollBody")[0].scrollTop = row.node().offsetTop;
                //row.node().scrollIntoView();
                //$("body")[0].scrollTop = 0
                row.select();
                clearTimeout(keyClearID);
                keyClearID = setTimeout(() => {
                    key = '';
                }, 500);
            });
            $("#remote-list").on('keypress', function (e) {
                key += e.key;
                var row = remoteTable.row(function (idx, data, node) { return data.name.startsWith(key) ? true : false; });
                if (!row || row.length === 0) return;
                remoteTable.rows().deselect();
                var top = row.node().offsetTop;
                var sTop = $("#remote-list_wrapper .dataTables_scrollBody")[0].scrollTop;
                var sHeight = $("#remote-list_wrapper .dataTables_scrollBody")[0].clientHeight;
                if (top < sTop || top + 31 >= sTop + sHeight)
                    $("#remote-list_wrapper .dataTables_scrollBody")[0].scrollTop = top;
                //row.node().scrollIntoView();
                //$("body")[0].scrollTop = 0
                row.select();
                clearTimeout(keyClearID);
                keyClearID = setTimeout(() => {
                    key = '';
                }, 500);
            });

            $('#local-list tbody').on('dblclick', 'tr', function () {
                var data = localTable.row(this).data();
                if (data.size === -2) {
                    if (options.syncFolders) {
                        if (_remote[data.name] && path.basename(options.remote) === path.basename(options.local))
                            _ied.getDir(options.remote + "/" + data.name, true);
                    }
                    updateLocal(data.path);
                }
                else
                    _ied.upload(data.path);
            });

            $('#remote-list tbody').on('dblclick', 'tr', function () {
                var data = remoteTable.row(this).data();
                if (data.size === -2) {
                    if (options.syncFolders) {
                        if (_local[data.name] && path.basename(options.remote) === path.basename(options.remote))
                            updateLocal(path.join(options.local, data.name));
                    }
                    _ied.getDir(data.path, true);
                }
                else
                    _ied.download(data.path);
            });

            $('#queue-list tbody').on('dblclick', 'tr', function () {
                var data = queueTable.row(this).data();
                if (data.state === ItemState.paused)
                    _ied.startItem(data.id);
                else
                    _ied.pauseItem(data.id);
            });

            $("#local-list").on('focus', () => {
                $("#local-list").addClass('focused');
                $("#remote-list").removeClass('focused');
                $("#queue-list").removeClass('focused');
                updateMenu();

            });
            $("#remote-list").on('focus', () => {
                $("#local-list").removeClass('focused');
                $("#remote-list").addClass('focused');
                $("#queue-list").removeClass('focused');
                updateMenu();
            });
            $("#queue-list").on('focus', () => {
                $("#local-list").removeClass('focused');
                $("#remote-list").removeClass('focused');
                $("#queue-list").addClass('focused');
                updateMenu();
            });
            updateLocal(options.local);
            if (!options.remote || options.remote.length === 0)
                _ied.getDir(".");
            else
                _ied.getDir(options.remote);

            $("#btn-local-up").on('click', () => {
                if (options.syncFolders) {
                    if (path.basename(options.remote) === path.basename(options.local))
                        _ied.getDir(path.dirname(options.remote), true);
                }
                updateLocal(path.dirname($("#local-path").val()));
            });

            $("#local-navigate").on('click', (e) => {
                e.preventDefault();
                e.cancelBubble = true;
                updateLocal($(e.target).data('path'));
            });

            $('#local-path').change(function () {
                updateLocal($("#local-path").val());
            });
            $('#local-path').keyup(function (e) {
                if (e.which === 27)
                    $("#local-path").val(options.local);
            });

            $("#btn-remote-up").on('click', () => {
                _ied.getDir(path.dirname($("#remote-path").val()), true);
                if (options.syncFolders) {
                    if (path.basename(options.remote) === path.basename(options.local))
                        updateLocal(path.dirname(options.local));
                }
            });

            $("#remote-navigate").on('click', (e) => {
                e.preventDefault();
                e.cancelBubble = true;
                _ied.getDir($(e.target).data('path'), true);
            });

            $('#remote-path').change(function () {
                _ied.getDir($("#remote-path").val());
            });
            $('#remote-path').keyup(function (e) {
                if (e.which === 27)
                    $("#remote-path").val(options.remote);
            });

            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                var target = $(e.target).attr("href"); // activated tab
                if (target === "#log")
                    $("#log-view")[0].scrollTop = $("#log-view")[0].scrollHeight;
            });

            $(document).keydown((event) => {

                //event.altKey, event.ctrlKey, event.shiftKey, event.metaKey

                switch (event.which) {
                    case 113: //f2
                        if (!event.altKey && !event.ctrlKey && !event.shiftKey && !event.metaKey) {
                            event.preventDefault();
                            if ($("#local-list").hasClass("focused"))
                                renameLocal();
                            else if ($("#remote-list").hasClass("focused"))
                                renameRemote();
                        }
                        break;
                    case 116: //f5
                        if (!event.altKey && !event.ctrlKey && !event.shiftKey && !event.metaKey) {
                            if ($("#local-list").hasClass("focused"))
                                updateLocal();
                            else if ($("#remote-list").hasClass("focused"))
                                _ied.getDir((!options.remote || options.remote.length === 0) ? '.' : options.remote);

                            event.preventDefault();
                        }
                        break;
                    case 46://delete
                        if (!event.altKey && !event.ctrlKey && !event.shiftKey && !event.metaKey) {
                            if ($("#local-list").hasClass("focused"))
                                deleteLocal();
                            else if ($("#remote-list").hasClass("focused"))
                                deleteRemote();
                            else if ($("#queue-list").hasClass("focused"))
                                queueStop();
                            event.preventDefault();
                        }
                        break;
                    case 65://select all, hack as menu accelerator doesn't work
                        if (!event.altKey && event.ctrlKey && !event.shiftKey && !event.metaKey) {
                            if ($("#local-list").hasClass("focused"))
                                localTable.rows().select();
                            else if ($("#remote-list").hasClass("focused"))
                                remoteTable.rows().select();
                            else if ($("#queue-list").hasClass("focused"))
                                queueTable.rows().select();
                            event.preventDefault();
                        }
                        break;
                    /*
                case 78:
                    if (!event.altKey && event.ctrlKey && !event.shiftKey && !event.metaKey) {
                        console.log("New folder");
                        event.preventDefault();
                    }
                    break;
                    */
                }
            });

            $('#drag-bar').mousedown(function (e) {
                e.preventDefault();
                dragging = true;
                var main = $('#remote');
                var ghostBar = $('<div>',
                    {
                        id: 'ghost-bar',
                        css: {
                            height: main.outerHeight(),
                            top: main.offset().top,
                            left: main.offset().left - 3
                        }
                    }).appendTo('body');

                $(document).mousemove(function (e) {
                    if (e.pageX < 199)
                        ghostBar.css("left", 199);
                    else if (e.pageX > document.body.clientWidth - 300)
                        ghostBar.css("left", document.body.clientWidth - 300);
                    else
                        ghostBar.css("left", e.pageX);
                });
            });

            $('#btm-drag-bar').mousedown(function (e) {
                e.preventDefault();
                btmDragging = true;
                var main = $('#bottom');
                var ghostBar = $('<div>',
                    {
                        id: 'btm-ghost-bar',
                        css: {
                            width: main.outerWidth(),
                            top: main.offset().top,
                            left: main.offset().left
                        }
                    }).appendTo('body');

                $(document).mousemove(function (e) {
                    if (e.pageY < 199)
                        ghostBar.css("top", 199);
                    else if (e.pageY > document.body.clientHeight - 200)
                        ghostBar.css("top", document.body.clientHeight - 200);
                    else
                        ghostBar.css("top", e.pageY);
                });
            });

            $(window).on('resize', () => {
                if ($('#remote').outerWidth() < 300 && $("#local").outerWidth() > 202) {
                    $('#local').css("width", document.body.clientWidth - 300);
                    $('#remote').css("left", document.body.clientWidth - 300);
                    options.localSize = document.body.clientWidth - 300;
                    saveOptions();
                }

                if ($('#bottom').outerHeight() < 200 && $("#main").outerHeight() > 202) {
                    options.queueSize = 200;
                    $('#bottom').css("height", options.queueSize);
                    $('#main').css("bottom", options.queueSize);
                    saveOptions();
                }

                var h = $("#main").outerHeight() - 40;
                if (options.showQueue)
                    h += $("#bottom").outerHeight();
                $("#local-navigate").css("max-height", h + "px");
                $("#remote-navigate").css("max-height", h + "px");
                localTable.draw();
                remoteTable.draw();
                queueTable.draw();

            });

            $(document).mouseup(function (e) {
                if (dragging) {
                    if (e.pageX < 200) {
                        $('#local').css("width", 202);
                        $('#remote').css("left", 202);
                        options.localSize = 202;
                    }
                    else if (e.pageX > document.body.clientWidth - 300) {
                        $('#local').css("width", document.body.clientWidth - 300);
                        $('#remote').css("left", document.body.clientWidth - 300);
                        options.localSize = document.body.clientWidth - 300;
                    }
                    else {
                        $('#local').css("width", e.pageX + 2);
                        $('#remote').css("left", e.pageX + 2);
                        options.localSize = e.pageX + 2;
                    }
                    localTable.draw();
                    remoteTable.draw();
                    saveOptions();
                    $('#ghost-bar').remove();
                    $(document).unbind('mousemove');
                    dragging = false;
                }
                else if (btmDragging) {
                    if (e.pageY < 226)
                        options.queueSize = document.body.clientHeight - 202;
                    else if (e.pageY > document.body.clientHeight - 200)
                        options.queueSize = 200;
                    else
                        options.queueSize = document.body.clientHeight - e.pageY + 2;
                    options.queueSize -= 26;
                    $('#bottom').css("height", options.queueSize);
                    $('#main').css("bottom", options.queueSize);
                    localTable.draw();
                    remoteTable.draw();
                    queueTable.draw();
                    saveOptions();
                    $('#btm-ghost-bar').remove();
                    $(document).unbind('mousemove');
                    btmDragging = false;
                }
            });

            window.ondragover = window.ondragenter = window.ondrop = (e) => {
                e.dataTransfer.effectAllowed = "none";
                e.dataTransfer.dropEffect = "none";
                e.stopPropagation();
                e.preventDefault();
                return false;
            };

            $("#bottom")[0].ondragover = document.ondragover = document.ondrop = (ev) => {
                ev.preventDefault();
                ev.dataTransfer.effectAllowed = "none";
                ev.dataTransfer.dropEffect = "none";
                ev.cancelBubble = true;
                ev.stopPropagation();
                return false;
            };

            $("#bottom")[0].ondrop = document.ondrop = document.body.ondrop = (ev) => {
                ev.preventDefault();
                ev.dataTransfer.effectAllowed = "none";
                ev.dataTransfer.dropEffect = "none";
                ev.cancelBubble = true;
                ev.stopPropagation();
                return false;
            };

            window.onmouseout = (event) => {
                _localDrag = 0;
                _remoteDrag = 0;
            };

            $("#local")[0].ondragenter = (event) => {
                event.preventDefault();
                event.cancelBubble = true;
                event.stopPropagation();
                if (!event.altKey && !event.ctrlKey && event.shiftKey && !event.metaKey) {
                    if (event.dataTransfer.files.length && (event.dataTransfer.files[0].path === options.local || path.dirname(event.dataTransfer.files[0].path) === options.local)) {
                        event.dataTransfer.dropEffect = "none";
                        event.dataTransfer.effectAllowed = "none";
                    }
                    else {
                        event.dataTransfer.dropEffect = "move";
                        event.dataTransfer.effectAllowed = "move";
                    }
                }
                else {
                    event.dataTransfer.dropEffect = "copy";
                    event.dataTransfer.effectAllowed = "copy";
                }

                return false;
            };

            $("#local")[0].ondragover = (event) => {
                event.preventDefault();
                event.cancelBubble = true;
                event.stopPropagation();
                if (!event.altKey && !event.ctrlKey && event.shiftKey && !event.metaKey) {
                    if (event.dataTransfer.files.length && (event.dataTransfer.files[0].path === options.local || path.dirname(event.dataTransfer.files[0].path) === options.local)) {
                        event.dataTransfer.dropEffect = "none";
                        event.dataTransfer.effectAllowed = "none";
                    }
                    else {
                        event.dataTransfer.dropEffect = "move";
                        event.dataTransfer.effectAllowed = "move";
                    }
                }
                else {
                    event.dataTransfer.dropEffect = "copy";
                    event.dataTransfer.effectAllowed = "copy";
                }

                return false;
            };

            $("#local")[0].ondrop = (event) => {
                event.preventDefault();
                event.cancelBubble = true;
                event.stopPropagation();
                var type = 0, f, fl;
                if (!event.altKey && !event.ctrlKey && event.shiftKey && !event.metaKey) {
                    if (event.dataTransfer.files.length && (event.dataTransfer.files[0].path === options.local || path.dirname(event.dataTransfer.files[0].path) === options.local)) {
                        event.dataTransfer.dropEffect = "none";
                        event.dataTransfer.effectAllowed = "none";
                    }
                    else {
                        event.dataTransfer.dropEffect = "move";
                        event.dataTransfer.effectAllowed = "move";
                        type = 1;
                    }
                }
                else {
                    event.dataTransfer.dropEffect = "copy";
                    event.dataTransfer.effectAllowed = "copy";
                    type = 2;
                }
                if (_localDrag) {
                    for (f = 0, fl = _localDrag.length; f < fl; f++) {
                        if (type === 1) {
                            fs.moveSync(_localDrag[f], path.join(options.local, getNewName(path.basename(_localDrag[f]), _local)));
                        }
                        else if (type === 2) {
                            fs.copySync(_localDrag[f], path.join(options.local, getNewName(path.basename(_localDrag[f]), _local)));
                        }
                    }
                    _localDrag = 0;
                }
                else if (_remoteDrag) {
                    for (f = 0, fl = _remoteDrag.length; f < fl; f++) {
                        if (_remote[path.basename(_remoteDrag[f])].size === -2)
                            downloadPath(_remoteDrag[f]);
                        else
                            _ied.download(_remoteDrag[f]);
                    }
                    _remoteDrag = 0;
                }
                else
                    for (f = 0, fl = event.dataTransfer.files.length; f < fl; f++) {
                        if (event.dataTransfer.files[f].path === options.local) continue;
                        if (event.dataTransfer.files[f].path.startsWith("jiMUD://")) {
                            var p = event.dataTransfer.files[f].path.substring(8);
                            if (_remote[path.basename(p)].size === -2)
                                downloadPath(_remoteDrag[f]);
                            else
                                _ied.download(p);
                        }
                        else if (type === 1) {
                            if (path.dirname(event.dataTransfer.files[f].path) === options.local) continue;
                            fs.moveSync(event.dataTransfer.files[f].path, path.join(options.local, getNewName(event.dataTransfer.files[f].name, _local)));
                        }
                        else if (type === 2) {
                            fs.copySync(event.dataTransfer.files[f].path, path.join(options.local, getNewName(event.dataTransfer.files[f].name, _local)));
                        }
                    }
            };

            $("#remote")[0].ondragenter = (event) => {
                if (event.dataTransfer.files.length && event.dataTransfer.files[0].path.startsWith("jiMUD://")) {
                    event.dataTransfer.dropEffect = "none";
                    event.dataTransfer.effectAllowed = "none";
                }
                else {
                    event.dataTransfer.dropEffect = "copy";
                    event.dataTransfer.effectAllowed = "copy";
                }
                event.preventDefault();
                event.cancelBubble = true;
                event.stopPropagation();
                return false;
            };

            $("#remote")[0].ondragover = (event) => {
                if (event.dataTransfer.files.length && event.dataTransfer.files[0].path.startsWith("jiMUD://")) {
                    event.dataTransfer.dropEffect = "none";
                    event.dataTransfer.effectAllowed = "none";
                }
                else {
                    event.dataTransfer.dropEffect = "copy";
                    event.dataTransfer.effectAllowed = "copy";
                }
                event.preventDefault();
                event.cancelBubble = true;
                event.stopPropagation();
                return false;
            };

            $("#remote")[0].ondrop = (event) => {
                event.preventDefault();
                if (_localDrag) {
                    for (var f = 0, fl = _localDrag.length; f < fl; f++) {
                        if (_local[path.basename(_localDrag[f])].size === -2)
                            uploadPath(_localDrag[f]);
                        else
                            _ied.upload(_localDrag[f]);
                    }
                    _localDrag = 0;
                }
                else if (_remoteDrag) {
                    _remoteDrag = 0;
                }
                else
                    for (f = 0, fl = event.dataTransfer.files.length; f < fl; f++) {
                        if (event.dataTransfer.files[f].path.startsWith("jiMUD://")) continue;
                        if (event.dataTransfer.files[f].size < 1) {
                            try {
                                var stat = fs.statSync(info.path);
                            }
                            catch (error) {
                                throw error;
                            }
                            if (stat.isDirectory())
                                uploadPath(event.dataTransfer.files[f].path);
                            else
                                _ied.upload(event.dataTransfer.files[f].path);

                        }
                        else
                            _ied.upload(event.dataTransfer.files[f].path);
                    }
            };

            $("#local-list")[0].ondragstart = (event) => {
                var row = $(document.elementFromPoint(event.pageX, event.pageY)).parent();
                if (!$(row).hasClass('selected')) {
                    localTable.rows().deselect();
                    localTable.row(row).select();
                }
                event.preventDefault();
                var selected = localTable.rows({ selected: true }).data().pluck('path');
                var files = [];
                for (var s = 0, sl = selected.length; s < sl; s++)
                    files.push(selected[s]);
                _localDrag = 0;
                _remoteDrag = 0;
                if (files.length > 0) {
                    _localDrag = files;
                    ipcRenderer.send('ondragstart', files);
                }
                return false;
            };

            $("#local-list")[0].ondragend = (event) => {
                event.preventDefault();
                _localDrag = 0;
                _remoteDrag = 0;
                return false;
            };

            $("#remote-list")[0].ondragend = (event) => {
                event.preventDefault();
                _localDrag = 0;
                _remoteDrag = 0;
                return false;
            };

            $("#remote-list")[0].ondragstart = (event) => {
                event.preventDefault();
                var selected = remoteTable.rows({ selected: true }).data();
                var files = [];
                _remoteDrag = [];
                for (var s = 0, sl = selected.length; s < sl; s++) {
                    if (selected[s].size === -2) continue;
                    files.push("jiMUD://" + selected[s].path);
                    _remoteDrag.push(selected[s].path);
                }
                _localDrag = 0;
                if (files.length > 0) {
                    _remoteDrag = files;
                    ipcRenderer.send('ondragstart', files, path.join(__dirname, '../assets/icons/png/drag2.png'));
                }
            };

            $("#queue-list-container")[0].ondragenter = (event) => {
                event.dataTransfer.dropEffect = "copy";
                event.dataTransfer.effectAllowed = "copy";
                event.preventDefault();
                event.cancelBubble = true;
                event.stopPropagation();
                return false;
            };

            $("#queue-list-container")[0].ondragover = (event) => {
                event.dataTransfer.dropEffect = "copy";
                event.dataTransfer.effectAllowed = "copy";
                event.preventDefault();
                event.cancelBubble = true;
                event.stopPropagation();
                return false;
            };

            $("#queue-list-container")[0].ondrop = (event) => {
                event.preventDefault();
                if (_localDrag) {
                    for (var f = 0, fl = _localDrag.length; f < fl; f++) {
                        if (_local[path.basename(_localDrag[f])].size === -2)
                            uploadPath(_localDrag[f]);
                        else
                            _ied.upload(_localDrag[f]);
                    }
                    _localDrag = 0;
                }
                else if (_remoteDrag) {
                    for (f = 0, fl = _remoteDrag.length; f < fl; f++) {
                        if (_remote[path.basename(_remoteDrag[f])].size === -2)
                            downloadPath(_remoteDrag[f]);
                        else
                            _ied.download(_remoteDrag[f]);
                    }
                    _remoteDrag = 0;
                }
                else
                    for (f = 0, fl = event.dataTransfer.files.length; f < fl; f++) {
                        if (event.dataTransfer.files[f].path.startsWith("jiMUD://")) {
                            var p = event.dataTransfer.files[f].path.substring(8);
                            if (_remote[path.basename(p)].size === -2)
                                downloadPath(_remoteDrag[f]);
                            else
                                _ied.download(p);
                        }
                        else if (event.dataTransfer.files[f].size < 1) {
                            try {
                                var stat = fs.statSync(info.path);
                            }
                            catch (error) {
                                throw error;
                            }
                            if (stat.isDirectory())
                                uploadPath(event.dataTransfer.files[f].path);
                            else
                                _ied.upload(event.dataTransfer.files[f].path);
                        }
                        else
                            _ied.upload(event.dataTransfer.files[f].path);
                    }
            };

            $(window).trigger('resize');

            window.onbeforeunload = function () {
                if (watcher)
                    watcher.close();
            };
        });

        function showLocalContextMenu() {
            var selected = localTable.rows({ selected: true }).data().pluck('size');
            var dirs = 0;
            for (var d = 0; d < selected.length; d++) {
                if (selected[d] === -2) {
                    dirs++;
                }
            }
            dirs = dirs === selected.length;

            var c = new Menu();
            c.append(new MenuItem({
                label: 'Refresh',
                click: () => {
                    updateLocal();
                }
            }));
            if (selected.length) {
                c.append(new MenuItem({ type: 'separator' }));
                if (!dirs) {
                    c.append(new MenuItem({
                        label: 'Upload',
                        click: upload
                    }));
                    c.append(new MenuItem({ type: 'separator' }));
                }
                c.append(new MenuItem({
                    label: 'Copy full path',
                    click: () => {
                        var selected = localTable.rows({ selected: true }).data().pluck('path');
                        clipboard.writeText(selected.join('\n'), 'selection');
                    }
                }));
                c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: 'Rename',
                    click: renameLocal
                }));
                c.append(new MenuItem({
                    label: 'Delete',
                    click: deleteLocal
                }));
            }
            c.append(new MenuItem({
                label: 'New directory',
                click: newFolderLocal
            }));
            c.append(new MenuItem({ type: 'separator' }));
            c.append(new MenuItem({
                label: 'Select all',
                click: () => {
                    localTable.rows().select();
                }
            }));
            if (selected.length) {
                c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: 'Reveal in explorer...',
                    click: () => {
                        {
                            var selected = localTable.rows({ selected: true }).data().pluck('path');
                            for (var d = 0, dl = selected.length; d < dl; d++)
                                shell.showItemInFolder(selected[d]);
                        }
                    }
                }));
                if (!dirs) {
                    c.append(new MenuItem({ type: 'separator' }));
                    c.append(new MenuItem({
                        label: 'Open...',
                        click: () => {
                            var selected = localTable.rows({ selected: true }).data().pluck('path');
                            for (var d = 0, dl = selected.length; d < dl; d++)
                                openItem(selected[d]);
                        }
                    }));
                    if (options.editor && options.editor.length > 0)
                        c.append(new MenuItem({
                            label: 'Open with editor...',
                            click: () => {
                                var selected = localTable.rows({ selected: true }).data().pluck('path');
                                for (var d = 0, dl = selected.length; d < dl; d++) {
                                    var p = child_process.spawn(options.editor, [selected[d]], { detached: true, stdio: ['ignore', 'ignore', 'ignore'] });
                                    p.unref();
                                }
                            }
                        }));
                }
            }
            c.popup(remote.getCurrentWindow(), { async: true });
        }

        function showRemoteContextMenu() {
            var selected = remoteTable.rows({ selected: true }).data().pluck('size');
            var dirs = 0;
            for (var d = 0; d < selected.length; d++) {
                if (selected[d] === -2) {
                    dirs++;
                }
            }
            dirs = dirs === selected.length;

            var c = new Menu();
            c.append(new MenuItem({
                label: 'Refresh',
                click: () => {
                    _ied.getDir((!options.remote || options.remote.length === 0) ? '.' : options.remote);
                }
            }));
            if (selected.length > 0) {
                c.append(new MenuItem({ type: 'separator' }));
                if (!dirs) {
                    c.append(new MenuItem({
                        label: 'Download',
                        click: download
                    }));
                    c.append(new MenuItem({ type: 'separator' }));
                }
                c.append(new MenuItem({
                    label: 'Goto',
                    accelerator: "CmdOrCtrl+G",
                    click: () => { doCommandFirst("goto"); }
                }));
                c.append(new MenuItem({
                    label: 'Change to directory',
                    click: () => {
                        var selected = remoteTable.rows({ selected: true }).data();
                        if (!selected.length) return;
                        if (selected[0].size === -2)
                            ipcRenderer.send('send-command', `cd ${selected[0].path}`);
                        else
                            ipcRenderer.send('send-command', `cd ${path.dirname(selected[0].path)}`);
                    }
                }));
                c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: 'Update',
                    click: () => { doCommand("update"); }
                }));
                c.append(new MenuItem({
                    label: 'Renew',
                    click: () => { doCommand("renew"); }
                }));
                c.append(new MenuItem({
                    label: 'Clone',
                    click: () => { doCommand("clone"); }
                }));
                c.append(new MenuItem({
                    label: 'Dest',
                    click: () => { doCommand("dest", true); }
                }));
                c.append(new MenuItem({
                    label: 'Backup',
                    click: () => { doBackup(); }
                }));
                c.append(new MenuItem({
                    label: 'Copy full path',
                    click: () => {
                        var selected = remoteTable.rows({ selected: true }).data().pluck('path');
                        clipboard.writeText(selected.join('\n'), 'selection');
                    }
                }));
                c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: 'Rename',
                    click: renameRemote
                }));
                c.append(new MenuItem({
                    label: 'Delete',
                    click: deleteRemote
                }));
            }
            c.append(new MenuItem({
                label: 'New directory',
                click: newFolderRemote
            }));
            c.append(new MenuItem({ type: 'separator' }));
            c.append(new MenuItem({
                label: 'Select all',
                click: () => {
                    remoteTable.rows().select();
                }
            }));
            c.popup(remote.getCurrentWindow(), { async: true });
        }

        function showQueueContextMenu() {
            var selected = queueTable.rows({ selected: true }).data();
            var c = new Menu();
            if (selected.length > 0) {
                c.append(new MenuItem({
                    label: 'Start',
                    click: queueStart
                }));
                c.append(new MenuItem({
                    label: 'Pause',
                    click: queuePause
                }));
                c.append(new MenuItem({
                    label: 'Stop',
                    click: queueStop
                }));
                c.append(new MenuItem({ type: 'separator' }));
            }
            c.append(new MenuItem({
                label: 'Select all',
                click: () => {
                    queueTable.rows().select();
                }
            }));
            c.append(new MenuItem({
                label: 'Reset',
                click: () => {
                    _ied.reset();
                }
            }));
            c.popup(remote.getCurrentWindow(), { async: true });
        }

        function updateStatus() {
            var tmp = [];
            if (info.localFiles)
                tmp.push(`Local files: ${info.localFiles}`);
            if (info.localDirs)
                tmp.push(`Local folders: ${info.localDirs}`);
            var size = 0;
            var data = localTable.rows({ selected: true }).data();
            data.map(function (key, index) {
                if (data[index].size > 0)
                    size += data[index].size;
            });
            if (size)
                tmp.push(`Local selected: ${formatSize(size)}`);
            $("#localInfo").text(tmp.join(", "));

            tmp = [];
            if (info.remoteFiles)
                tmp.push(`Remote files: ${info.remoteFiles}`);
            if (info.remoteDirs)
                tmp.push(`Remote folders: ${info.remoteDirs}`);

            size = 0;
            data = remoteTable.rows({ selected: true }).data();
            data.map(function (key, index) {
                if (data[index].size > 0)
                    size += data[index].size;
            });
            if (size)
                tmp.push(`Remote selected: ${formatSize(size)}`);
            $("#remoteInfo").text(tmp.join(", "));


            tmp = [];
            if (info.uploads)
                tmp.push(`Uploads: ${info.uploads}`);
            if (info.downloads)
                tmp.push(`Downloads: ${info.downloads}`);
            $("#queueInfo").text(tmp.join(", "));
        }

        function toggleSync() {
            options.syncFolders = !options.syncFolders;
            updateMenuItem({ menu: 'view|sync folders', checked: options.syncFolders });
            if (options.syncFolders)
                $("#btn-sync").addClass("active");
            else
                $('#btn-sync').removeClass('active');
            saveOptions();
        }

        function toggleQueue() {
            options.showQueue = !options.showQueue;
            updateMenuItem({ menu: 'view|show queue and log', checked: options.showQueue });
            if (options.showQueue) {
                $("#btn-queue").addClass("active");
                $("#bottom").css('display', '');
                $("#main").css('bottom', options.queueSize + 'px');
            }
            else {
                $('#btn-queue').removeClass('active');
                $("#bottom").css('display', 'none');
                $("#main").css('bottom', '28px');
            }
            saveOptions();
            $(window).trigger('resize');
        }

        function openItem(path) {
            if (!path || path.length === 0) return;
            shell.openItem(path);
        }

        function download() {
            var data = remoteTable.rows({ selected: true }).data();
            for (var d = 0, dl = data.length; d < dl; d++) {
                if (data[d].size === -2)
                    downloadPath(data[d].path);
                else
                    _ied.download(data[d].path);
            }
        }

        function upload() {
            var data = localTable.rows({ selected: true }).data();
            for (var d = 0, dl = data.length; d < dl; d++) {
                if (data[d].size === -2)
                    uploadPath(data[d].path);
                else
                    _ied.upload(data[d].path);
            }
        }


        var pFiles;
        var pTotal;

        function uploadPath(p) {
            _progressCancel = false;
            if (!pTotal && !$("#Progress")[0].open) {
                $("#Progressbar").html('<progress max="100"></progress>');
                $("#ProgressTitle").html(`Preparing upload`);
                $("#Progress")[0].showModal();
            }
            //make dir then start uploads
            _ied.makeDirectory(options.remote + "/" + path.basename(p), false, true, () => {
                walk(p, (files, dirs, empty) => {
                    var s = options.local.length;
                    if (options.local.endsWith('/') || options.local.endsWith('\\'))
                        s--;
                    var r = options.remote;
                    if (r.endsWith('/'))
                        r = r.substr(0, r.length - 1);

                    for (var e = 0, el = empty.length; e < el; e++) {
                        _ied.makeDirectory(r + path.dirname(empty[e]).substr(s).replace(/\\/g, "/") + '/' + path.basename(empty[e]), false, true);
                    }
                    if (pTotal) {
                        pFiles.push.apply(pFiles, files);
                        pTotal += files.length;
                    }
                    else {
                        pFiles = files;
                        pTotal = files.length;
                    }
                    upNext();
                });
            });
        }

        function upNext() {
            if (!pFiles || pFiles.length === 0 || _progressCancel) {
                pFiles = null;
                pTotal = 0;
                if ($("#Progress")[0].open)
                    $("#Progress")[0].close();
                return;
            }
            var file = pFiles.shift();
            var s = options.local.length;
            if (options.local.endsWith('/') || options.local.endsWith('\\'))
                s--;
            var r = options.remote;
            if (r.endsWith('/'))
                r = r.substr(0, r.length - 1);
            var p = path.dirname(file);
            p = r + p.substr(s).replace(/\\/g, "/");
            _ied.uploadTo(file, p + '/' + path.basename(file), false, 0, true);
            $("#Progress progress").val(Math.ceil((pTotal - pFiles.length) * 100 / pTotal));
            setTimeout(upNext, 0);
        }

        function progressCancel() {
            _progressCancel = true;
            if ($("#Progress")[0].open)
                $("#Progress")[0].close();
        }

        function downloadPath(p) {
            _progressCancel = false;
            if (!pTotal && !$("#Progress")[0].open) {
                $("#Progressbar").html('<progress max="100"></progress>');
                $("#ProgressTitle").html(`Preparing upload`);
                $("#Progress")[0].showModal();
            }            
            if(!existsSync(path.join(options.local, path.basename(p))))
                fs.mkdirSync(path.join(options.local, path.basename(p)));
            _ied.getDir(p, true, "download");
        }

        function closing() {
            if (watcher)
                watcher.close();
        }

        function createWatcher() {
            if (watcher)
                watcher.close();
            watcher = chokidar.watch(options.local, {
                persistent: true,
                depth: 0,
                ignoreInitial: true
            });

            // Something to use when events are received.
            var log = console.log.bind(console);
            var ready = false;
            watcher
                .on('error', error => {
                    if (options.debug)
                        log(`Watcher error: ${error}`);
                    logMessage(`Watcher error: ${error}`);
                })
                .on('ready', () => {
                    if (options.debug)
                        log('Initial scan complete. Ready for changes');
                    ready = true;
                })
                .on('addDir', (path, stats) => {
                    if (options.debug)
                        log(`Directory ${path} has been added`);
                    if (ready && path != options.local)
                        addLocalFile(path);
                })
                .on('unlinkDir', p => {
                    if (options.debug)
                        log(`Directory ${p} has been removed`);
                    if (ready) removeLocalFile(p);
                })
                .on('add', (path, stats) => {
                    if (options.debug)
                        log(`File ${path} has been added`);
                    if (ready && path != options.local)
                        addLocalFile(path);
                })
                .on('change', (path, stats) => {
                    if (options.debug)
                        log(`File ${path} has been changed`);
                    updateLocalFile(path);
                })
                .on('unlink', p => {
                    if (options.debug)
                        log(`File ${p} has been removed`);
                    if (ready)
                        removeLocalFile(p);
                })
                .on('raw', (event, path, details) => {
                    if (options.debug)
                        log('Raw event info:', event, path, details);
                });
        }

        function updateLocalFile(p) {
            try {
                var file = IED.getFileInfo(p);
            }
            catch (error) {
                logError(error);
                return;
            }
            if (file.hidden && !options.showhidden) {
                if (_local[file.name]) {
                    removeLocalFile(file.path);
                    info.localFiles--;
                }
                return;
            }

            var row = localTable.row(function (idx, data, node) {
                return data.name === path.basename(p) ?
                    true : false;
            });
            _local[file.name] = file;
            if (row && row.length === 1)
                row.remove();
            localTable.row.add(_local[file.name]).draw();
            if (options.debug)
                console.log(_downloads[p]);
            if (file.size === -2)
                uploadPath(p);
            else if (!_downloads[p] && options.uploadOnChange)
                _ied.upload(p);
            if (_downloads[p])
                delete _downloads[p];
        }

        function removeLocalFile(p) {
            var row = localTable.row(function (idx, data, node) {
                return data.name === path.basename(p) ?
                    true : false;
            });
            row.remove().draw();
            if (_local[path.basename(p)].size === -2)
                info.localDirs--;
            else
                info.localFiles--;
            delete _local[path.basename(p)];
            updateStatus();
        }

        function addLocalFile(path) {
            try {
                var file = IED.getFileInfo(path);
            }
            catch (error) {
                logError(error);
                return;
            }
            if (file.hidden && !options.showhidden)
                return;
            if (file.size === -2)
                info.localDirs++;
            else
                info.localFiles++;
            _local[file.name] = file;
            localTable.row.add(_local[file.name]).draw();
            if (options.debug)
                console.log(_downloads[path]);
            if (file.size != -2 && !_downloads[path] && options.uploadOnChange)
                _ied.upload(path);
            if (_downloads[path])
                delete _downloads[path];
            updateStatus();
        }

        function deleteLocal() {
            var data = localTable.rows({ selected: true }).data().pluck('path');
            for (var d = 0, dl = data.length; d < dl; d++)
                shell.moveItemToTrash(data[d]);
        }

        function deleteRemote() {
            var data = remoteTable.rows({ selected: true }).data();
            dialog.showMessageBox(remote.getCurrentWindow(), {
                type: 'warning',
                title: "Delete?",
                message: data.length > 1 ? "Delete remote files?" : "Delete remote file: " + data[0].name + "?",
                buttons: ['Yes', 'No'],
                defaultId: 1,
            }, (response) => {
                if (response === 0) {
                    for (var d = 0, dl = data.length; d < dl; d++) {
                        if (data.size != -2)
                            _ied.deleteFile(data[d].path);
                    }
                }
            });
        }

        function newFolderLocal() {
            $("#newFolder").data("type", "local");
            $("#newFolderLabel").text("New local folder");
            $("#newFolder-name").val(getNewName("New Folder", _local));
            $("#newFolder-name")[0].selectionStart = 0;
            $("#newFolder-name")[0].selectionEnd = $("#newFolder-name").val().length;
            $("#newFolder")[0].showModal();
        }

        function newFolderRemote() {
            $("#newFolder").data("type", "remote");
            $("#newFolderLabel").text("New remote folder");
            $("#newFolder-name").val(getNewName("New Folder", _remote));
            $("#newFolder-name")[0].selectionStart = 0;
            $("#newFolder-name")[0].selectionEnd = $("#newFolder-name").val().length;
            $("#newFolder")[0].showModal();
        }

        function newFolderOk() {
            var n = $("#newFolder-name").val();
            if (!n || n.length === 0) {
                dialog.showMessageBox(remote.getCurrentWindow(), {
                    type: 'error',
                    title: "Name required",
                    message: "You must supply a valid name!"
                });
                return;
            }
            if (IED.invalidFile(n)) {
                dialog.showMessageBox(remote.getCurrentWindow(), {
                    type: 'error',
                    title: "Invalid folder name",
                    message: "The name you supplied contains invalid characters!"
                });
                return;
            }
            if ($("#newFolder").data("type") === "local") {
                if (_local[n]) {
                    n = getNewName(n, _local);
                    if (dialog.showMessageBox(remote.getCurrentWindow(), {
                        type: 'warning',
                        title: "File or folder exist?",
                        message: `Do you want to rename to "${n}"?`,
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                        detail: 'There is already a file or folder with the same name in this location.',
                    }) != 0) {
                        return;
                    }
                }
                fs.mkdirSync(path.join(options.local, n));
            }
            else if ($("#newFolder").data("type") === "remote") {
                if (_remote[n]) {
                    n = getNewName(n, _remote);
                    if (dialog.showMessageBox(remote.getCurrentWindow(), {
                        type: 'warning',
                        title: "File or folder exist?",
                        message: `Do you want to rename to "${n}"?`,
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                        detail: 'There is already a file or folder with the same name in this location.',
                    }) != 0) {
                        return;
                    }
                }
                _ied.makeDirectory(options.remote + "/" + n);
            }
            $("#newFolder")[0].close();
        }

        function renameLocal() {
            var selected = localTable.rows({ selected: true });
            if (!selected || selected.length === 0) return;
            rename(selected, _local, (o, n) => {
                fs.renameSync(o, path.join(path.dirname(o), n));
            });
        }

        function renameRemote() {
            var selected = remoteTable.rows({ selected: true });
            if (!selected || selected.length === 0) return;
            rename(selected, _remote, (o, n) => {
                _ied.rename(o, path.dirname(o) + "/" + n);
            });
        }

        function rename(rows, list, callback) {
            var el = $(rows.nodes()[0].children[0]);
            el.css('position', 'relative');
            var editor = $('<input class="form-control" style="position: absolute;top:0;left:0;right:0;bottom:0;width:auto;margin:0;height: auto;"/>');
            editor.path = rows.data()[0].path;
            editor.original = rows.data()[0].name;
            editor.update = function () {
                if (!list[editor.val()]) {
                    if (callback) callback(editor.path, editor.val());
                }
                else if (editor.val() != editor.original) {
                    var n = getNewName(editor.val(), list);
                    if (dialog.showMessageBox(remote.getCurrentWindow(), {
                        type: 'warning',
                        title: "Rename file?",
                        message: `Do you want to rename "${editor.original}" to "${n}"?`,
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                        detail: 'There is already a file with the same name in this location.',
                    }) === 0 && callback) {
                        callback(editor.path, n);
                    }
                }
                editor.close();
            };
            editor.close = function (e) {
                if (e && e.target === editor[0])
                    return;
                $(window).off('click', editor.update);
                editor.remove();
                editor = null;
            };
            editor.on('blur', editor.close);
            editor.on('click', function (e) {
                e.preventDefault();
                e.cancelBubble = true;
            });
            editor.on('keypress', function (event) {
                event.cancelable = true;
                event.stopPropagation();
            });
            editor.on('keydown', (event) => {
                if (event.which === 27)
                    editor.close();
                else if (event.which === 13)
                    editor.update();
                event.cancelBubble = true;
                event.stopPropagation();
            });

            $(window).on('click', editor.update);
            el.append(editor);
            editor.val(editor.original);
            editor.focus();

            editor[0].selectionStart = 0;
            if (editor.val().lastIndexOf(".") === -1)
                editor[0].selectionEnd = editor.val().length - 1;
            else
                editor[0].selectionEnd = editor.val().lastIndexOf(".");
        }

        function getNewName(name, list) {
            if (!list[name]) return name;
            var i = 1;
            var ext = path.extname(name);
            var o = path.basename(name, ext);
            if (!list) list = _local;
            var n = o + ` (${i})` + ext;
            while (list[n]) {
                i++;
                n = o + ` (${i})` + ext;
            }
            return n;
        }

        function queueStart() {
            var selected = queueTable.rows({ selected: true }).data().pluck("id");
            for (var q = 0, ql = selected.length; q < ql; q++)
                _ied.startItem(selected[q]);
        }
        function queuePause() {
            var selected = queueTable.rows({ selected: true }).data().pluck("id");
            for (var q = 0, ql = selected.length; q < ql; q++)
                _ied.pauseItem(selected[q]);
        }
        function queueStop() {
            var selected = queueTable.rows({ selected: true }).data().pluck("id");
            for (var q = 0, ql = selected.length; q < ql; q++)
                _ied.removeItem(selected[q]);
        }

        function doCommand(cmd, noExt) {
            if (!cmd || cmd.length === 0) return;
            var selected = remoteTable.rows({ selected: true }).data();
            for (var s = 0, sl = selected.length; s < sl; s++) {
                if (selected[s].size === -2) continue;
                if (noExt) {
                    var name = path.basename(selected[s].name, selected[s].type);
                    ipcRenderer.send('send-command', `${cmd} ${options.remote}/${name}`);
                }
                else
                    ipcRenderer.send('send-command', `${cmd} ${selected[s].path}`);
            }
        }

        function doCommandFirst(cmd) {
            if (!cmd || cmd.length === 0) return;
            var selected = remoteTable.rows({ selected: true }).data();
            for (var s = 0, sl = selected.length; s < sl; s++) {
                if (selected[s].size === -2) continue;
                ipcRenderer.send('send-command', `${cmd} ${selected[s].path}`);
                break;
            }
        }

        function doBackup() {
            doCommand("backup");
            if (!_remote["bak"]) {
                _remote["bak"] = {
                    name: "bak",
                    path: options.remote,
                    size: -2,
                    type: "Directory",
                    date: new Date().getTime(),
                    hidden: false
                };
                info.remoteDirs++;
                remoteTable.row.add(_remote["bak"]).draw();
            }
        }

        ipcRenderer.on('GMCP-received', (event, data) => {
            if (options && options.debug)
                console.log(data.mod);
            if (_ied)
                _ied.processGMCP(data.mod, data.obj);
        });

        ipcRenderer.on('reload-options', (event) => {
            loadOptions();
        });

        ipcRenderer.on('setting-changed', (event, data) => {
            if (data.type === "extensions" && data.name === "immortal")
                loadOptions(data.value);
        });
    </script>
</head>

<body>
    <div id="main">
        <div id="local">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <label class="control-label" for="local-path">
                        Local
                        <button id="btn-refresh-local" type="button" class="btn btn-default btn-xs" title="Refresh" onclick="updateLocal();">
                            <i class="fa fa-refresh"></i>
                        </button>
                        <button id="btn-upload-local" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Upload files" onclick="upload()">
                            <i class="fa fa-upload"></i>
                        </button>
                        <div class="btn-group" role="group">
                            <button id="btn-rename-local" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Rename" onclick="renameLocal()">
                                <i class="fa fa-i-cursor"></i>
                            </button>
                            <button id="btn-delete-local" disabled="disabled" type="button" class="btn btn-danger btn-xs" title="Delete" onclick="deleteLocal()">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        <button id="btn-newFolder-local" type="button" class="btn btn-default btn-xs" title="New directory" onclick="newFolderLocal()">
                            <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                                <i class="fa fa-folder-o fa-stack-2x" style="font-size: 1em"></i>
                                <i class="fa fa-plus fa-stack-1x" style="font-size: 0.8em;margin-top: -2px;left:5px;"></i>
                            </span>
                        </button>
                    </label>

                    <span class="path-container">
                        <div class="input-group">
                            <input type="text" id="local-path" class="form-control" />
                            <span class="input-group-btn">
                                <button id="button-local" class="btn btn-default dropdown-toggle" style="width:17px;min-width:17px;border-radius: 0;padding-left:4px;padding-right:4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                    <span class="caret" style="margin-left: -1px;"></span>
                                </button>
                                <ul id="local-navigate" class="dropdown-menu" aria-labelledby="button-local" data-container="body"></ul>
                                <button id="btn-local-up" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Go up a directory">
                                    <span class="fa-stack" style="top: -3px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                                        <i class="fa fa-folder-o fa-stack-2x" style="font-size: 1.2em"></i>
                                        <i class="fa fa-caret-up fa-stack-1x" style="font-size: 1em;margin-top: 1px;"></i>
                                    </span>
                                </button>
                            </span>

                        </div>
                    </span>
                    <span class="path-buttons">
                        <button id="btn-sync" type="button" class="btn btn-default btn-xs" title="Sync folders" onclick="toggleSync();">
                            <i class="fa fa-exchange"></i>
                        </button>
                    </span>
                </div>
                <div id="local-list-container" class="panel-body" style="padding:0px;top:61px;bottom:1px;left:1px;right:5px;position: absolute;">
                    <table tabindex="0" id="local-list" draggable="true" class="table table-striped table-hover table-condensed" style="width: 100%;height: 100%;padding:0px;margin:0px !important;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Size</th>
                                <th>Type</th>
                                <th>Date Modified</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
            <div id="drag-bar"></div>
        </div>
        <div id="remote">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <label class="control-label" for="remote-path">
                        Remote
                        <button id="btn-refresh-remote" type="button" class="btn btn-default btn-xs" title="Refresh" onclick="_ied.getDir((!options.remote || options.remote.length === 0) ? '.' : options.remote);">
                            <i class="fa fa-refresh"></i>
                        </button>
                        <button id="btn-download-remote" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Download files" onclick="download()">
                            <i class="fa fa-download"></i>
                        </button>

                        <div class="btn-group" role="group">
                            <button id="btn-rename-remote" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Rename" onclick="renameRemote()">
                                <i class="fa fa-i-cursor"></i>
                            </button>
                            <button id="btn-delete-remote" disabled="disabled" type="button" class="btn btn-danger btn-xs" title="Delete" onclick="deleteRemote()">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        <button id="btn-newFolder-remote" type="button" class="btn btn-default btn-xs" title="New directory" onclick="newFolderRemote()">
                            <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                                <i class="fa fa-folder-o fa-stack-2x" style="font-size: 1em"></i>
                                <i class="fa fa-plus fa-stack-1x" style="font-size: 0.8em;margin-top: -2px;left:5px;"></i>
                            </span>
                        </button>
                    </label>

                    <span class="path-container">
                        <div class="input-group">
                            <input type="text" id="remote-path" class="form-control" />
                            <span class="input-group-btn">
                                <button id="button-remote" class="btn btn-default" style="width: 17px;min-width:17px;border-radius:0;padding-left:4px;padding-right:4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                    <span class="caret" style="margin-left: -1px;"></span>
                                </button>
                                <ul id="remote-navigate" class="dropdown-menu pull-right" aria-labelledby="button-remote" data-container="body"></ul>
                                <button id="btn-remote-up" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Go up a directory">
                                    <span class="fa-stack" style="top: -3px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                                        <i class="fa fa-folder-o fa-stack-2x" style="font-size: 1.2em"></i>
                                        <i class="fa fa-caret-up fa-stack-1x" style="font-size: 1em;margin-top: 1px;"></i>
                                    </span>
                                </button>
                            </span>
                        </div>
                    </span>
                </div>
                <div id="remote-list-container" class="panel-body" style="padding:0px;top:61px;bottom:1px;left:1px;right:1px;position: absolute;">
                    <table tabindex="0" id="remote-list" draggable="true" class="table table-striped table-hover table-condensed" style="width: 100%;height: 100%;padding:0px;margin:0px !important;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Size</th>
                                <th>Type</th>
                                <th>Date Modified</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="bottom">
        <div id="btm-drag-bar"></div>
        <ul class="nav nav-tabs" role="tablist" style="background-color: #F5F5F5;box-shadow: inset 0 -1px 0 #fff;">
            <li role="presentation" class="active">
                <a href="#queue" aria-controls="queue" role="tab" data-toggle="tab">Queue</a>
            </li>
            <li role="presentation">
                <a href="#log" aria-controls="log" role="tab" data-toggle="tab">Log</a>
            </li>
        </ul>
        <div class="tab-content" style="padding: 4px;position: absolute;left: 0;right: 0;bottom: 0;top: 46px;">
            <div role="tabpanel" class="tab-pane fade in active" id="queue" style="margin:0 !important;padding:4px;height:100%;">
                <div id="toolbar" class="btn-toolbar" role="toolbar">
                    <div class="btn-group" role="group" id="queue-controls">
                        <button id="btn-start" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Start" onclick="queueStart()">
                            <i class="fa fa-play"></i>
                        </button>
                        <button id="btn-pause" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Pause" onclick="queuePause()" data-toggle="button">
                            <i class="fa fa-pause"></i>
                        </button>
                        <button id="btn-stop" disabled="disabled" type="button" class="btn btn-warning btn-xs" title="Stop" onclick="queueStop()">
                            <i class="fa fa-stop"></i>
                        </button>
                    </div>
                    <button id="btn-reset" type="button" class="btn btn-warning btn-xs" title="Reset all" onclick="_ied.reset();">
                        <i class="fa fa-eject"></i>
                    </button>
                </div>
                <div id="queue-list-container" style="padding:0px;top:28px;bottom:0px;left:2px;right:2px;position: absolute;">
                    <table tabindex="0" id="queue-list" class="table table-striped table-hover table-condensed" style="width: 100%;height: 100%;padding:0px;margin:0 !important;">
                        <thead>
                            <tr>
                                <th>Local</th>
                                <th>&lt;-&gt;</th>
                                <th>Remote</th>
                                <th>Progress</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="log" style="padding:4px;height:100%;">
                <div role="tabpanel" class="tab-pane fade in active" id="queue" style="margin:0 !important;padding:4px;height:100%;">
                    <div id="toolbar-log" class="btn-toolbar" role="toolbar">
                        <button id="btn-clear" type="button" class="btn btn-default btn-xs" title="Clear log" onclick="$('#log-view').html('');">
                            <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                                <i class="fa fa-file-o fa-stack-2x" style="font-size: 1em"></i>
                                <i class="fa fa-times fa-stack-1x" style="font-size: 0.5em;margin-top: 1px;"></i>
                            </span>
                        </button>
                    </div>
                    <pre id="log-view"></pre>
                </div>
            </div>
        </div>
    </div>
    <div id="status" class="btn-toolbar" role="toolbar">
        <div id="localInfo" style="width:33%;display:inline-block;"></div>
        <div id="queueInfo" style="width:33%;display:inline-block;"></div>
        <div id="remoteInfo" style="width:33%;display:inline-block;"></div>
    </div>
    <dialog id="newFolder" style="z-index:1000;height:150px;width:350px;">
        <div class="dialog-body">
            <div class="form-group">
                <label class="control-label" for="newFolder-name" id="newFolderLabel">New folder</label>
                <input id="newFolder-name" class="form-control">
            </div>
        </div>
        <div class="dialog-footer">
            <button style="float: right" type="button" class="btn btn-default" onclick="$('#newFolder')[0].close();">Cancel</button>
            <button style="float: right" type="button" class="btn btn-primary" onclick="newFolderOk()">Ok</button>
        </div>
    </dialog>
    <dialog id="Progress" style="z-index:1000;text-align:center">
        <div id="ProgressTitle"></div>
        <div id="Progressbar">
            <progress max="100"></progress>
        </div>
        <div>
            <button onclick="progressCancel()">
                Cancel
            </button>
        </div>
    </dialog>
</body>

</html>
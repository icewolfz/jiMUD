<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>Immortal Tools</title>
    <link rel="shortcut icon" href="../assets/icons/png/ied.png" />
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="css/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link href="css/bootstrap-select.min.css" rel="stylesheet" type="text/css" />
    <link href="css/bootstrap-treeview.min.css" rel="stylesheet" type="text/css" />
    <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/immortal.css" rel="stylesheet" type="text/css" />
    <link href="css/form.css" rel="stylesheet" type="text/css" />
    <link href="css/datatables.min.css" rel="stylesheet" type="text/css" />
    <script>
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="../lib/jquery.min.js" type="text/javascript"></script>
    <script src="../lib/bootstrap.min.js" type="text/javascript"></script>
    <script src="../lib/bootstrap-select.min.js" type="text/javascript"></script>
    <script src="../lib/datatables.min.js" type="text/javascript"></script>
    <script src="../lib/datatables.scrollResize.js" type="text/javascript"></script>
    <script>
        //cSpell:ignore hellip vscroll hscroll ungroup crosshairs haspopup tablist tabpanel labelledby
        const { IED, fileInfo, } = require('./js/ied');
        const { IEDError, TempType, IEDCmdStatus } = require('./js/types');
        const { remote, ipcRenderer, shell, clipboard } = require('electron');
        const { app, nativeImage, dialog, Menu, MenuItem } = remote;
        const { parseTemplate } = require('./js/library');
        const { Settings } = require('./js/settings');
        const fs = require('fs');
        const child_process = require('child_process');
        const path = require('path');
        const drivelist = require('drivelist');
        const moment = require('moment');

        var chokidar = require('chokidar');

        var _ied, options, dropdownMenu;
        var _local = {}, _remote = {}, _downloads = {};
        var info = { localdirs: 0, localfiles: 0, remotedirs: 0, remotefiles: 0, uploads: 0, downloads: 0 }
        var localTable, remoteTable, queueTable, key = '', keyclearID;
        var watcher;
        var dragging = false, btmDragging = false;

        var menu = [
            {
                label: '&File',
                id: 'file',
                submenu: [
                    {
                        label: '&Upload',
                        accelerator: "CmdOrCtrl+U",
                        enabled: false,
                        click: upload
                    },
                    {
                        label: '&Download',
                        accelerator: "CmdOrCtrl+D",
                        enabled: false,
                        click: download
                    },
                    { type: 'separator' },
                    /*
                    {
                        label: 'R&estart',
                        enabled: false,
                        click: () => {

                        }
                    },
                    {
                        label: '&Pause',
                        enabled: false,
                        click: () => {

                        }
                    },
                    {
                        label: '&Stop',
                        enabled: false,
                        click: () => {

                        }
                    },
                    { type: 'separator' },
                    */
                    {
                        label: '&Reset all',
                        accelerator: "CmdOrCtrl+R",
                        click: () => { _ied.reset(); }
                    },
                    { type: 'separator' },
                    {
                        label: 'Preferences...',
                        click: () => {
                            window.open('immortal.prefs.html', 'modal', 'backgroundColor=#fff,height=300,width=600,icon=' + path.join(__dirname, '../assets/icons/png/preferences.png'));
                        }
                    },
                    { type: 'separator' },
                    {
                        label: '&Close',
                        click: () => { window.close(); }
                    }
                ]
            },
            {
                label: '&Edit',
                submenu: [
                    {
                        label: '&Refresh all',
                        accelerator: "F5",
                        click: () => {
                            updateLocal();
                            _ied.getDir((!options.remote || options.remote.length === 0) ? '.' : options.remote);
                        }
                    },
                    { type: 'separator' },
                    {
                        label: '&Local',
                        submenu: [
                            {
                                label: '&Refresh',
                                accelerator: "CmdOrCtrl+F5",
                                click: () => {
                                    updateLocal();
                                }
                            },
                            { type: 'separator' },
                            {
                                label: '&Copy full path',
                                click: () => {
                                    var selected = localTable.rows({ selected: true }).data().pluck('path');
                                    clipboard.writeText(selected.join('\n'), 'selection');
                                }
                            },
                            /*
                            {
                                label: '&Rename',
                                enabled: false,
                                accelerator: "CmdOrCtrl+F2",
                            },
                            */
                            {
                                label: '&Delete',
                                enabled: false,
                                accelerator: "CmdOrCtrl+Delete",
                                click: deleteLocal
                            },
                            /*
                            {
                                label: '&Create directory',
                                accelerator: "CmdOrCtrl+N",
                            },
                            */
                            { type: 'separator' },
                            {
                                label: '&Select all',
                                accelerator: "CmdOrCtrl+A",
                                click: () => {
                                    localTable.rows().select();
                                }
                            },
                            { type: 'separator' },
                            {
                                label: '&Reveal in explorer...',
                                enabled: false,
                                accelerator: "CmdOrCtrl+X",
                                click: () => {
                                    var data = localTable.rows({ selected: true }).data().pluck('path');
                                    for (var d = 0, dl = data.length; d < dl; d++)
                                        shell.showItemInFolder(data[d]);
                                }
                            },

                            { type: 'separator' },
                            {
                                label: '&Open...',
                                enabled: false,
                                accelerator: "CmdOrCtrl+O",
                                click: () => {
                                    var data = localTable.rows({ selected: true }).data().pluck('path');
                                    for (var d = 0, dl = data.length; d < dl; d++)
                                        openItem(data[d]);
                                }
                            },
                            {
                                label: 'Open &with editor...',
                                enabled: false,
                                accelerator: "CmdOrCtrl++Shift+E",
                                click: () => {
                                    var data = localTable.rows({ selected: true }).data().pluck('path');
                                    for (var d = 0, dl = data.length; d < dl; d++) {
                                        p = child_process.spawn(options.editor, [data[d]], { detached: true, stdio: ['ignore', 'ignore', 'ignore'] });
                                        p.unref();
                                    }
                                }
                            }
                        ]
                    },
                    {
                        label: '&Remote',
                        enabled: true,
                        submenu: [
                            {
                                label: '&Refresh',
                                accelerator: "CmdOrCtrl+Shift+F5",
                                click: () => {
                                    if ($("#remote-list").hasClass("focused"))
                                        _ied.getDir((!options.remote || options.remote.length === 0) ? '.' : options.remote);
                                }
                            },
                            { type: 'separator' },
                            {
                                label: '&Copy full path',
                                click: () => {
                                    var selected = remoteTable.rows({ selected: true }).data().pluck('path');
                                    clipboard.writeText(selected.join('\n'), 'selection');
                                }
                            },
                            /*
                            {
                                label: '&Rename',
                                enabled: false,
                                accelerator: "CmdOrCtrl+ShiftF2",
                            },
                            */
                            {
                                label: '&Delete',
                                enabled: false,
                                accelerator: "CmdOrCtrl+Shift+Delete",
                                click: deleteRemote
                            },
                            /*
                            {
                                label: '&Create directory',
                                accelerator: "CmdOrCtrl+N",
                            },
                            */
                            { type: 'separator' },
                            {
                                label: '&Select all',
                                accelerator: "CmdOrCtrl+Shift+A",
                                click: () => {
                                    remoteTable.rows().select();
                                }
                            },
                            //{ type: 'separator' },
                            /*
                            {
                                label: '&Backup',
                                enabled: false,
                                accelerator: "CmdOrCtrl+B"
                            },
                            */
                        ]
                    },
                    { type: 'separator' },
                    {
                        label: '&Clear log',
                        click: () => {
                            $("#log-view").html('');
                        }
                    }
                ]
            },
            {
                label: '&View',
                submenu: [
                    {
                        label: '&Show queue and log',
                        type: 'checkbox',
                        accelerator: "CmdOrCtrl+Q",
                        click: () => { toggleQueue(); }
                    },
                    {
                        label: 'Sync folders',
                        type: 'checkbox',
                        accelerator: "CmdOrCtrl+Shift+S",
                        click: () => { toggleSync(); }
                    },
                    { type: 'separator' },
                    {
                        label: '&Editor',
                        accelerator: "CmdOrCtrl+E",
                        click: () => {
                            shell.openItem(options.editor);
                        }
                    },
                    { type: 'separator' },
                    {
                        role: 'toggledevtools'
                    }
                ]
            },

        ];
        var menubar = Menu.buildFromTemplate(menu);
        remote.getCurrentWindow().setMenu(menubar);

        function updateMenuItem(args) {
            var item, i = 0, ic, items;
            var tItem, tItems;
            if (args == null || args.menu == null) return;

            if (!Array.isArray(args.menu))
                args.menu = args.menu.split('|');

            items = menubar.items;
            tItems = menu;
            for (i = 0; i < args.menu.length; i++) {
                if (!items || items.length == 0) break;
                for (m = 0; m < items.length; m++) {
                    if (items[m].id == args.menu[i] || items[m].label.toLowerCase().replace(/&/g, '') == args.menu[i].toLowerCase()) {
                        item = items[m];
                        tItem = tItems[m];
                        if (item.submenu) {
                            items = item.submenu.items;
                            tItems = tItem.submenu;
                        }
                        else
                            items = null;
                        break;
                    }
                }
            }
            if (!item)
                return;
            if (args.enabled != null)
                item.enabled = args.enabled ? true : false;
            if (args.checked != null)
                item.checked = args.checked ? true : false;
            if (args.icon != null)
                item.icon = args.icon;
            if (args.visible != null)
                item.visible = args.visible ? true : false;
            if (args.position != null)
                item.position = args.position;

            tItem.enabled = item.enabled;
            tItem.checked = item.checked;
            tItem.icon = item.icon;
            tItem.visible = item.visible;
            tItem.position = item.position;
        }

        (function () {
            function fileSort(a, b) {
                if (_local[a].size == -2 && _local[b].size != -2)
                    return -1;
                if (_local[a].size != -2 && _local[b].size == -2)
                    return 1;
                return a.localeCompare(b);
            }

            function rfileSort(a, b) {
                if (_remote[a].size == -2 && _remote[b].size != -2)
                    return -1;
                if (_remote[a].size != -2 && _remote[b].size == -2)
                    return 1;
                return a.localeCompare(b);
            }

            jQuery.extend(jQuery.fn.dataTableExt.oSort, {
                "file-asc": function (a, b) {
                    return fileSort(a, b);
                },

                "file-desc": function (a, b) {
                    return fileSort(a, b) * -1;
                },

                "rfile-asc": function (a, b) {
                    return rfileSort(a, b);
                },

                "rfile-desc": function (a, b) {
                    return rfileSort(a, b) * -1;
                },

                "moment-asc": function (a, b) {
                    if (moment(a).isBefore(b))
                        return -1;
                    if (moment(b).isBefore(a))
                        return 1;
                    return 0;
                },

                "moment-desc": function (a, b) {
                    if (moment(a).isBefore(b))
                        return 1;
                    if (moment(b).isBefore(a))
                        return -1;
                    return 0;
                },

            });

            jQuery.fn.dataTable.ext.type.order['file-size-pre'] = function (data) {
                var matches = data.match(/^(\d+(?:\.\d+)?)\s*([a-z]+)/i);
                var multipliers;

                if (process.platform === 'darwin')
                    multipliers = {
                        b: 1,
                        bytes: 1,
                        kb: 1000,
                        kib: 1024,
                        mb: 1000000,
                        mib: 1048576,
                        gb: 1000000000,
                        gib: 1073741824,
                        tb: 1000000000000,
                        tib: 1099511627776,
                        pb: 1000000000000000,
                        pib: 1125899906842624
                    };
                else
                    multipliers = {
                        b: 1,
                        bytes: 1,
                        kb: 1024,
                        kib: 1024,
                        mb: 1048576,
                        mib: 1048576,
                        gb: 1073741824,
                        gib: 1073741824,
                        tb: 1099511627776,
                        tib: 1099511627776,
                        pb: 1125899906842624,
                        pib: 1125899906842624
                    };

                if (matches) {
                    var multiplier = multipliers[matches[2].toLowerCase()];
                    return parseFloat(matches[1]) * multiplier;
                } else {
                    return -1;
                };
            };
        }());

        function formatSize(size) {
            if (size >= 1073741824)
                return Math.round(size / 1073741824).toLocaleString() + " GB";
            else if (size >= 1048576)
                return Math.round(size / 1048576).toLocaleString() + " MB";
            else if (size >= 1024)
                return Math.round(size / 1024).toLocaleString() + " KB";
            return size + " B";
        }

        function loadOptions(data) {
            if (!data) {
                var set = Settings.load(remote.getGlobal('settingsFile'));
                options = set.extensions["immortal"];
            }
            else
                options = data;
            if (!options) {
                options = {
                    'local': '',
                    'remote': '',
                    'editor': '',
                    'bufferSize': 0,
                    'openEditor': true,
                    'queueSize': 250,
                    'localSize': 400,
                    'syncFolders': true,
                    'showQueue': true,
                    'showHidden': false,
                    'uploadOnChange': false,
                    'debug': false,
                    'logErrors': false,
                    'tempFile': TempType.extension
                };
                saveOptions();
            }
            $('#local').css("width", options.localSize);
            $('#remote').css("left", options.localSize);

            $('#bottom').css("height", options.queueSize);
            $('#main').css("bottom", options.queueSize);

            updateMenuItem({ menu: 'view|sync folders', checked: options.syncFolders });
            if (options.syncFolders)
                $("#btn-sync").addClass("active")
            else
                $('#btn-sync').removeClass('active');
            updateMenuItem({ menu: 'edit|editor', enabled: options.editor && options.editor.length > 0 });
            updateMenuItem({ menu: 'view|show queue and log', checked: options.showQueue });
            if (options.showQueue) {
                $("#btn-queue").addClass("active");
                $("#bottom").css('display', '');
                $("#main").css('bottom', (options.queueSize + 26) + 'px');
            }
            else {
                $('#btn-queue').removeClass('active');
                $("#bottom").css('display', 'none');
                $("#main").css('bottom', '28px');
            }
            if (localTable)
                localTable.draw();
            if (remoteTable)
                remoteTable.draw();
            if (queueTable)
                queueTable.draw();
        }

        function saveOptions() {
            if (_ied) {
                _ied.local = options.local;
                _ied.remote = options.remote;
                _ied.bufferSize = options.bufferSize;
                _ied.useTemp = options.tempFile;
            }
            ipcRenderer.send('setting-changed', { type: 'extensions', name: 'immortal', value: options });
        }

        function updateLocal(p) {
            if (!p || p.length == 0)
                p = options.local || app.getPath('downloads');
            else if (!fs.existsSync(p))
                p = app.getPath('downloads');
            options.local = p;
            createWatcher();
            saveOptions();
            var parts = p.split(path.sep);
            if (p.endsWith(path.sep))
                parts.pop();
            var dir = fs.readdirSync(p);
            var dirs = [];
            var all = [];
            _local = {};
            for (var d = 0, dl = dir.length; d < dl; d++) {
                try {
                    file = IED.getFileInfo(path.join(p, dir[d]));
                }
                catch (error) {
                    logError(error);
                    continue;
                }
                if (file.hidden && !options.showhidden)
                    continue;
                if (file.size == -2)
                    dirs.push(file);
                all.push(file);
                _local[file.name] = file;
            }
            info.localdirs = dirs.length;
            info.localfiles = all.length - dirs.length;
            $("#local-path").val(p);
            $("#local-navigate").empty();
            drivelist.list((error, drives) => {
                if (error) {
                    logMessage(error);
                    return;
                }
                var paths = [];
                var found = false;
                var c = "";
                if (drives.length > 0) {
                    for (var d = 0, dl = drives.length; d < dl; d++) {
                        if (drives[d].mountpoints.length === 0)
                            continue;
                        for (var m = 0, ml = drives[d].mountpoints.length; m < ml; m++) {
                            if (!drives[d].mountpoints[m].path) continue;
                            var sd = drives[d].mountpoints[m].path.split(path.sep);
                            c = "";
                            for (var pt = 0, pl = sd.length; pt < pl; pt++) {
                                c = path.join(c, sd[pt], path.sep);
                                if (c.toLowerCase() == parts[0].toLowerCase() + path.sep) {
                                    found = true;
                                    if (pt == 0)
                                        paths.push({ drive: true, path: c, name: sd[pt], count: pt, open: parts.length == 1 });
                                    else
                                        paths.push({ path: c, name: sd[pt], count: pt, open: parts.length == 1 });
                                }
                                else if (pt == 0)
                                    paths.push({ drive: true, path: c, name: sd[pt], count: pt });
                                else
                                    paths.push({ path: c, name: sd[pt], count: pt });
                            }
                            //paths.push({ drive: true, count: 0, path: path.join(drives[d].mountpoints[m].path, path.sep), name: drives[d].mountpoints[m].path });

                        }
                    }
                }
                c = found ? c = path.join(parts[0], path.sep) : "";
                for (var pt = found ? 1 : 0, pl = parts.length; pt < pl; pt++) {
                    c = path.join(c, parts[pt], path.sep);
                    if (pt == pl - 1)
                        paths.push({ path: c, name: parts[pt], count: pt, open: true });
                    else
                        paths.push({ path: c, name: parts[pt], count: pt });
                }
                for (var d = 0, dl = dirs.length; d < dl; d++) {
                    paths.push({ path: dirs[d].path, name: dirs[d].name, count: pt });
                }

                paths.sort(function compare(a, b) {
                    if (a.path.toUpperCase() < b.path.toUpperCase())
                        return -1;
                    if (a.path.toUpperCase() > b.path.toUpperCase())
                        return 1;
                    return 0;
                });
                $("#local-navigate").empty();
                for (var c = 0, cl = paths.length; c < cl; c++) {
                    if (paths[c].drive && paths[c].open)
                        $("#local-navigate").append(`<li><a href="#" class="active" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-server"></i> ${paths[c].name}</a></li>`)
                    else if (paths[c].drive)
                        $("#local-navigate").append(`<li><a href="#" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-server"></i> ${paths[c].name}</a></li>`)
                    else if (paths[c].open)
                        $("#local-navigate").append(`<li><a href="#" class="active" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-folder-open-o"></i> ${paths[c].name}</a></li>`)
                    else
                        $("#local-navigate").append(`<li><a href="#" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-folder-o"></i> ${paths[c].name}</a></li>`)
                }
            });

            localTable.rows().remove().draw();
            localTable.rows.add(all).draw();
            $("#btn-local-up").prop('disabled', path.dirname(p) == p || path.dirname == path.join(p, path.sep));
            updateStatus();
        }

        function updateRemote(p, dir) {
            options.remote = p;
            saveOptions();
            var dirs = [];
            var all = [];
            var parts = p.split('/');
            if (p.endsWith('/'))
                parts.pop();
            _remote = {};
            info.remotedirs = 0;
            info.remotefiles = 0;
            for (var d = 0, dl = dir.length; d < dl; d++) {
                file = {
                    name: path.basename(dir[d].file),
                    path: (p == "/" ? "" : p) + "/" + dir[d].file,
                    size: dir[d].size,
                    type: path.extname(dir[d].file),
                    date: dir[d].date * 1000,
                    hidden: IED.isHidden((p == "/" ? "" : p) + "/" + dir[d].file, true)
                }
                if (file.hidden && !options.showhidden)
                    continue;
                if (file.size == -2) {
                    file.type = "Directory";
                    dirs.push(file);
                    info.remotedirs++;
                }
                else
                    info.remotefiles++;

                all.push(file);
                _remote[file.name] = file;
                updateStatus();
            }
            $("#remote-path").val(p);
            var paths = [];
            var c = [];
            for (var pt = 0, pl = parts.length; pt < pl; pt++) {
                c.push(parts[pt]);
                if (pt == 0)
                    paths.push({ path: "/", name: "/", count: pt, open: pt == pl - 1 });
                else
                    paths.push({ path: c.join('/'), name: parts[pt], count: pt, open: pt == pl - 1 });
            }
            for (var d = 0, dl = dirs.length; d < dl; d++) {
                paths.push({ path: dirs[d].path, name: dirs[d].name, count: pt });
            }

            paths.sort(function compare(a, b) {
                if (a.path.toUpperCase() < b.path.toUpperCase())
                    return -1;
                if (a.path.toUpperCase() > b.path.toUpperCase())
                    return 1;
                return 0;
            });
            $("#remote-navigate").empty();
            for (var c = 0, cl = paths.length; c < cl; c++) {
                if (paths[c].drive && paths[c].open)
                    $("#remote-navigate").append(`<li><a href="#" class="active" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-server"></i> ${paths[c].name}</a></li>`)
                else if (paths[c].drive)
                    $("#remote-navigate").append(`<li><a href="#" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-server"></i> ${paths[c].name}</a></li>`)
                else if (paths[c].open)
                    $("#remote-navigate").append(`<li><a href="#" class="active" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-folder-open-o"></i> ${paths[c].name}</a></li>`)
                else
                    $("#remote-navigate").append(`<li><a href="#" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-folder-o"></i> ${paths[c].name}</a></li>`)
            }
            remoteTable.rows().remove().draw();
            remoteTable.rows.add(all).draw();
            $("#btn-remote-up").prop('disabled', path.dirname(p) == p || path.dirname == path.join(p, path.sep));
        }

        function logMessage(msg) {
            if (!msg) return;
            $("#log-view").html($("#log-view").html() + msg.toString() + "<br>");
            $("#log-view")[0].scrollTop = $("#log-view")[0].scrollHeight;
        }

        function logError(error) {
            if (!error) return;
            var msg;
            if (error.stack)
                msg = error.stack;
            else if (error instanceof TypeError)
                msg = error.name + " - " + error.message;
            else if (error instanceof Error)
                msg = error.name + " - " + error.message;
            else if (error.message)
                msg = error.message;
            else
                msg = error;
            if (options.debug)
                console.log(error);
            if (options.logErrors) {
                fs.writeFileSync(parseTemplate(path.join('{data}', "jimud.error.log")), "Immortal Tools: " + new Date().toLocaleString() + "\n", { flag: 'a' });
                fs.writeFileSync(parseTemplate(path.join('{data}', "jimud.error.log")), msg + "\n", { flag: 'a' });
            }
        }


        function updateMenu() {
            var remote = $("#remote-list").hasClass("focused");
            var local = $("#local-list").hasClass("focused");
            var queue = $("#queue-list").hasClass("focused");
            var either = remote || local;
            var localFilesOnly = false;
            var localFoldersOnly = false;
            var localSelected = false;
            var remoteFilesOnly = false;
            var remoteFoldersOnly = false;
            var remoteSelected = false;
            var queueSelected = false;

            var data = localTable.rows({ selected: true }).data().pluck('size');
            localSelected = data.length != 0;
            var dirs = 0;
            for (var d = 0; d < data.length; d++) {
                if (data[d] == -2) {
                    dirs++;
                }
            }
            localFilesOnly = dirs != data.length;
            localFoldersOnly = dirs == data.length;

            data = remoteTable.rows({ selected: true }).data().pluck('size');
            remoteSelected = data.length != 0;
            dirs = 0;
            for (var d = 0; d < data.length; d++) {
                if (data[d] == -2) {
                    dirs++;
                }
            }
            remoteFilesOnly = dirs != data.length;
            remoteFoldersOnly = dirs == data.length;

            data = remoteTable.rows({ selected: true }).data();
            var queueSelected = data.length != 0;

            updateMenuItem({ menu: 'file|upload', enabled: localSelected });
            updateMenuItem({ menu: 'file|download', enabled: remoteSelected });
            //updateMenuItem({ menu: 'edit|local|rename', enabled: localSelected });
            updateMenuItem({ menu: 'edit|local|delete', enabled: localSelected });

            updateMenuItem({ menu: 'edit|local|reveal in explorer...', enabled: localSelected });
            updateMenuItem({ menu: 'edit|local|open...', enabled: localSelected });
            updateMenuItem({ menu: 'edit|local|open with editor...', enabled: localSelected && options.editor && options.editor.length > 0 });

            //updateMenuItem({ menu: 'edit|remote|rename', enabled: remoteSelected });
            updateMenuItem({ menu: 'edit|remote|delete', enabled: remoteSelected });
            //updateMenuItem({ menu: 'edit|remote|backup', enabled: remoteSelected });



            $("#btn-rename-local").prop('disabled', !localSelected);
            $("#btn-delete-local").prop('disabled', !localSelected);
            $("#btn-upload-local").prop('disabled', !localSelected);

            $("#btn-rename-remote").prop('disabled', !remoteSelected);
            $("#btn-delete-remote").prop('disabled', !remoteSelected);
            $("#btn-download-remote").prop('disabled', !remoteSelected);
            updateStatus();
        }

        $(document).ready(() => {

            $('#local-list').DataTable({
                keys: true,
                paging: false,
                select: {
                    style: 'os',
                    //blurable: true
                },
                searching: false,
                info: false,
                scrollY: 300,
                scrollX: 300,
                fixedHeader: {
                    header: true,
                    footer: false
                },
                scrollResize: true,
                language: { zeroRecords: "", emptyTable: "" },
                autoWidth: false,
                columnDefs: [
                    {
                        type: 'file',
                        targets: 0,
                        createdCell: function (td, cellData, rowData, row, col) {
                            if (rowData.size == -2) {
                                $(td).prepend('<i class="fa fa-folder-o" style="margin-right: 2px"></i>');
                            }
                            else {
                                switch (rowData.type.toLowerCase()) {
                                    case ".7z":
                                    case ".zip":
                                    case ".rar":
                                        $(td).prepend('<i class="fa fa-file-archive-o" style="margin-right: 2px"></i>');
                                        break;
                                    case ".txt":
                                        $(td).prepend('<i class="fa fa-file-text-o" style="margin-right: 2px"></i>');
                                        break;
                                    case ".h":
                                    case ".c":
                                        $(td).prepend('<i class="fa fa-file-code-o" style="margin-right: 2px"></i>');
                                        break;
                                    default:
                                        $(td).prepend('<i class="fa fa-file-o" style="margin-right: 2px"></i>');
                                        break;
                                }
                            }
                        }
                    },
                    {
                        render: function (data, type, full, meta) {
                            if (data == -2)
                                return '';
                            return formatSize(data);
                        },
                        targets: 1
                    },
                    {
                        type: 'file-size',
                        targets: 1
                    },
                    {
                        type: "moment",
                        targets: 3,
                        render: function (data) {
                            return new moment(data).format('MM/DD/YYYY hh:mm:ss A');
                        }
                    }
                ],
                columns: [
                    { data: 'name', width: '200px' },
                    { data: 'size', width: '200px' },
                    { data: 'type', width: '200px' },
                    { data: 'date', width: '200px' }
                ]
            });
            $('#remote-list').DataTable({
                keys: true,
                paging: false,
                select: {
                    style: 'os',
                    //blurable: true
                },
                searching: false,
                info: false,
                scrollY: 300,
                scrollX: 300,
                fixedHeader: {
                    header: true,
                    footer: false
                },
                scrollResize: true,
                language: { zeroRecords: "", emptyTable: "" },
                autoWidth: false,
                columnDefs: [
                    {
                        type: 'rfile',
                        targets: 0,
                        createdCell: function (td, cellData, rowData, row, col) {
                            if (rowData.size == -2) {
                                $(td).prepend('<i class="fa fa-folder-o" style="margin-right: 2px"></i>');
                            }
                            else {
                                switch (rowData.type.toLowerCase()) {
                                    case ".7z":
                                    case ".zip":
                                    case ".rar":
                                        $(td).prepend('<i class="fa fa-file-archive-o" style="margin-right: 2px"></i>');
                                        break;
                                    case ".txt":
                                        $(td).prepend('<i class="fa fa-file-text-o" style="margin-right: 2px"></i>');
                                        break;
                                    case ".h":
                                    case ".c":
                                        $(td).prepend('<i class="fa fa-file-code-o" style="margin-right: 2px"></i>');
                                        break;
                                    default:
                                        $(td).prepend('<i class="fa fa-file-o" style="margin-right: 2px"></i>');
                                        break;
                                }
                            }
                        }
                    },
                    {
                        render: function (data, type, full, meta) {
                            if (data == -2)
                                return '';
                            return formatSize(data);
                        },
                        targets: 1
                    },
                    {
                        type: 'file-size',
                        targets: 2
                    },
                    {
                        type: "moment",
                        targets: 3,
                        render: function (data) {
                            return new moment(data).format('MM/DD/YYYY hh:mm:ss A');
                        }
                    }
                ],
                columns: [
                    { data: 'name', width: '200px' },
                    { data: 'size', width: '200px' },
                    { data: 'type', width: '200px' },
                    { data: 'date', width: '200px' }
                ]
            });
            $('#queue-list').DataTable({
                data: [],
                paging: false,
                select: true,
                searching: false,
                info: false,
                scrollY: 300,
                scrollX: '100vw',
                fixedHeader: {
                    header: true,
                    footer: false
                },
                scrollResize: true,
                ordering: false,
                language: { zeroRecords: "", emptyTable: "" },
                columnDefs: [
                    {
                        render: function (data, type, full, meta) {
                            return `<div class="progressbar"><div class="progressbar-text">${Math.round(100 * data)}%</div><div class="progressbar-value" style="width: ${100 - 100 * data}%"></div></div>`
                        },
                        targets: 3
                    },
                    {
                        width: '30px',
                        targets: 1
                    },
                    {
                        width: '150px',
                        targets: 3
                    }
                ],
                columns: [
                    { data: 'local' },
                    { data: 'direction', width: '30px' },
                    { data: 'remote' },
                    { data: 'progress', width: '150px' }
                ]
            });
            loadOptions();
            _ied = new IED(options.local, options.remote);
            _ied.bufferSize = options.bufferSize;
            _ied.useTemp = options.tempFile;
            _ied.on('error', (error) => {
                var msg;
                if (error.stack)
                    msg = error.stack;
                else if (error instanceof TypeError)
                    msg = error.name + " - " + error.message;
                else if (error instanceof Error)
                    msg = error.name + " - " + error.message;
                else if (error.message)
                    msg = error.message;
                else if (error.msg)
                    msg = error.msg;
                else
                    msg = error;
                logMessage(msg);
                logError(msg);
            })
            _ied.on('reset', () => {
                queueTable.rows().remove().draw();
            })
            _ied.on('dir', (dir, files) => {
                updateRemote(dir, files)
            });
            _ied.on('resolved', (dir, tag) => {
                logMessage("Resolved: " + dir);
            });
            _ied.on('message', (msg) => {
                logMessage(msg);
            });

            _ied.on('add', (item) => {
                if (item.download) {
                    _downloads[item.local] = true;
                    if (item.tmp == TempType.extension)
                        _downloads[item.local + ".tmp"] = true;
                    info.downloads++;
                }
                else
                    info.uploads++;
                updateStatus();
                queueTable.row.add({
                    "local": item.local,
                    "direction": item.download ? "<-" : "->",
                    "remote": item.remote,
                    "progress": item.percent,
                    "id": item.ID
                }).draw();
            });
            _ied.on('remove', (item) => {
                queueTable.rows(function (idx, data, node) {
                    return data.id == item.ID ?
                        true : false;
                }).remove().draw();
                if (item.download) {
                    //Update local list if file was uploaded to current local
                    if (options.openEditor) {
                        if (!options.editor || options.editor.length == 0)
                            openItem(item.local);
                        else {
                            p = child_process.spawn(options.editor, [item.local], { detached: true, stdio: ['ignore', 'ignore', 'ignore'] });
                            p.unref();
                        }
                    }
                    info.downloads--;
                }
                else {
                    //only update if current remote is the same path as file
                    if (path.dirname(item.remote) == options.remote) {
                        var row = remoteTable.row(function (idx, data, node) {
                            return data.name == path.basename(item.remote) ?
                                true : false;
                        });
                        _remote[path.basename(item.remote)] = {
                            name: path.basename(item.remote),
                            path: item.remote,
                            size: item.totalSize,
                            type: path.extname(item.remote),
                            date: new Date().getTime(),
                            hidden: IED.isHidden(item.remote, true)
                        };
                        if (_remote[path.basename(item.remote)].hidden && !options.showHidden)
                            return;
                        if (row && row.length == 1)
                            row.remove();
                        else
                            info.remotefiles++;
                        remoteTable.row.add(_remote[path.basename(item.remote)]).draw();
                        info.uploads--;
                    }
                    updateStatus();
                }
            });
            _ied.on('update', (item) => {
                queueTable.row(function (idx, data, node) {
                    return data.id == item.ID ?
                        true : false;
                }).data({
                    "local": item.local,
                    "direction": item.download ? "<-" : "->",
                    "remote": item.remote,
                    "progress": item.percent,
                    "id": item.ID
                }).draw();
            });

            _ied.on('cmd', (obj) => {
                if (obj.cmd == "rm") {
                    if (obj.code == IEDCmdStatus.success) {
                        logMessage(`Deleted: ${obj.path}/${obj.file}`);

                        var row = remoteTable.row(function (idx, data, node) {
                            return data.name == obj.file ?
                                true : false;
                        });
                        delete _remote[obj.file];
                        if (row && row.length == 1)
                            row.remove().draw();
                        info.remotefiles--;
                        updateStatus();
                    }
                    else {
                        logMessage(`Failed to delete: ${obj.path}/${obj.file}`);
                        dialog.showMessageBox(remote.getCurrentWindow(), {
                            type: 'error',
                            title: "Could not delete",
                            message: "Could not delete: " + obj.path + "/" + obj.file,
                        });
                    }
                }
            });

            localTable = $('#local-list').DataTable();
            remoteTable = $('#remote-list').DataTable();
            queueTable = $('#queue-list').DataTable();

            localTable.on('user-select', function (e, dt, type, cell, originalEvent) {
                if ($(cell.node()).parent().hasClass('selected') && dt.rows('.selected').data().length == 1) {
                    e.preventDefault();
                }
            });

            remoteTable.on('user-select', function (e, dt, type, cell, originalEvent) {
                if ($(cell.node()).parent().hasClass('selected') && dt.rows('.selected').data().length == 1) {
                    e.preventDefault();
                }
            });

            queueTable.on('user-select', function (e, dt, type, cell, originalEvent) {
                if ($(cell.node()).parent().hasClass('selected') && dt.rows('.selected').data().length == 1) {
                    e.preventDefault();
                }
            });

            $('#local-list tbody').on('contextmenu', 'tr', function (e) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;

                if (!$(this).hasClass('selected')) {
                    localTable.rows().deselect();
                    localTable.row(this).select();
                }
                showLocalContextMenu();
            });

            $('#local-list-container').on('contextmenu', function (e) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;
                showLocalContextMenu();
            });

            $('#remote-list tbody').on('contextmenu', 'tr', function (e) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;

                if (!$(this).hasClass('selected')) {
                    remoteTable.rows().deselect();
                    remoteTable.row(this).select();
                }
                showRemoteContextMenu();
            });

            $('#remote-list-container').on('contextmenu', function (e) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;
                showRemoteContextMenu();
            });

            $('#queue-list tbody').on('contextmenu', 'tr', function (e) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;

                if (!$(this).hasClass('selected')) {
                    remoteTable.rows().deselect();
                    remoteTable.row(this).select();
                }
                var c = new Menu();
                //pause,restart,stop
                //c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: 'Reset',
                    click: () => {
                        _ied.reset();
                    }
                }));
                c.popup(remote.getCurrentWindow(), { async: true });
            });

            $('#queue-list-container').on('contextmenu', function (e) {
                var c = new Menu();
                c.append(new MenuItem({
                    label: 'Reset',
                    click: () => {
                        _ied.reset();
                    }
                }));
                c.popup(remote.getCurrentWindow(), { async: true });
            });

            $("#log-view").on('contextmenu', function (e) {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;
                var c = new Menu();
                if (window.getSelection().type == "Range") {
                    c.append(new MenuItem({ role: 'copy' }));
                    c.append(new MenuItem({ type: 'separator' }));
                }
                c.append(new MenuItem({
                    label: 'Clear log',
                    click: () => {
                        $("#log-view").html('');
                    }
                }));
                c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: 'Select all',
                    click: () => {
                        selection = window.getSelection();
                        range = document.createRange();
                        range.selectNodeContents($("#log-view")[0]);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                }));
                c.popup(remote.getCurrentWindow(), { async: true });
            });

            localTable.on('select', function (e, dt, type, indexes) {
                if (type === 'row') {
                    updateMenu();
                }
            });

            localTable.on('deselect', function (e, dt, type, indexes) {
                if (type === 'row') {
                    updateMenu();
                }
            });

            remoteTable.on('select', function (e, dt, type, indexes) {
                if (type === 'row') {
                    updateMenu();
                }
            });

            remoteTable.on('deselect', function (e, dt, type, indexes) {
                if (type === 'row') {
                    updateMenu();
                }
            });

            $("#local-list").on('keypress', function (e) {
                key += e.key;
                var row = localTable.row(function (idx, data, node) { return data.name.startsWith(key) ? true : false; })
                //$("#local-list_wrapper .dataTables_scrollBody")[0].scrollTop = $("#local-list_wrapper .dataTables_scrollBody")[0].scrollHeight - (row.index() * $(row.node()).outerHeight());
                if (!row || row.length === 0) return;
                localTable.rows().deselect();
                var top = row.node().offsetTop;
                var sTop = $("#local-list_wrapper .dataTables_scrollBody")[0].scrollTop;
                var sHeight = $("#local-list_wrapper .dataTables_scrollBody")[0].clientHeight;
                if (top < sTop || top + 31 >= sTop + sHeight)
                    $("#local-list_wrapper .dataTables_scrollBody")[0].scrollTop = top;
                //$("#local-list_wrapper .dataTables_scrollBody")[0].scrollTop = row.node().offsetTop;
                //row.node().scrollIntoView();
                //$("body")[0].scrollTop = 0
                row.select();
                clearTimeout(keyclearID);
                keyclearID = setTimeout(() => {
                    key = "";
                }, 500);
            });
            $("#remote-list").on('keypress', function (e) {
                key += e.key;
                var row = remoteTable.row(function (idx, data, node) { return data.name.startsWith(key) ? true : false; })
                if (!row || row.length === 0) return;
                remoteTable.rows().deselect();
                var top = row.node().offsetTop;
                var sTop = $("#remote-list_wrapper .dataTables_scrollBody")[0].scrollTop;
                var sHeight = $("#remote-list_wrapper .dataTables_scrollBody")[0].clientHeight;
                if (top < sTop || top + 31 >= sTop + sHeight)
                    $("#remote-list_wrapper .dataTables_scrollBody")[0].scrollTop = top;
                //row.node().scrollIntoView();
                //$("body")[0].scrollTop = 0
                row.select();
                clearTimeout(keyclearID);
                keyclearID = setTimeout(() => {
                    key = "";
                }, 500);
            });

            $('#local-list tbody').on('dblclick', 'tr', function () {
                var data = localTable.row(this).data();
                if (data.size == -2) {
                    if (options.syncFolders) {
                        if (_remote[data.name] && path.basename(options.remote) == path.basename(options.local))
                            _ied.getDir(options.remote + "/" + data.name, true);
                    }
                    updateLocal(data.path);
                }
                else
                    _ied.upload(data.path);
            });

            $('#remote-list tbody').on('dblclick', 'tr', function () {
                var data = remoteTable.row(this).data();
                if (data.size == -2) {
                    if (options.syncFolders) {
                        if (_local[data.name] && path.basename(options.remote) == path.basename(options.remote))
                            updateLocal(path.join(options.local, data.name));
                    }
                    _ied.getDir(data.path, true);
                }
                else
                    _ied.download(data.path);
            });

            $("#local-list").on('focus', () => {
                $("#local-list").addClass('focused');
                $("#remote-list").removeClass('focused');
                $("#queue-list").removeClass('focused');
                updateMenu();

            });
            $("#remote-list").on('focus', () => {
                $("#local-list").removeClass('focused');
                $("#remote-list").addClass('focused');
                $("#queue-list").removeClass('focused');
                updateMenu();
            })
            $("#queue-list").on('focus', () => {
                $("#local-list").removeClass('focused');
                $("#remote-list").removeClass('focused');
                $("#queue-list").addClass('focused');
                updateMenu();
            })
            updateLocal(options.local);
            if (!options.remote || options.remote.length === 0)
                _ied.getDir(".");
            else
                _ied.getDir(options.remote);

            $("#btn-local-up").on('click', () => {
                if (options.syncFolders) {
                    if (path.basename(options.remote) == path.basename(options.local))
                        _ied.getDir(path.dirname(options.remote), true);
                }
                updateLocal(path.dirname($("#local-path").val()));
            })

            $("#local-navigate").on('click', (e) => {
                e.preventDefault();
                e.cancelBubble = true;
                updateLocal($(e.target).data('path'));
            })

            $('#local-path').change(function () {
                updateLocal($("#local-path").val());
            });
            $('#local-path').keyup(function (e) {
                if (e.which == 27)
                    $("#local-path").val(options.local);
            });

            $("#btn-remote-up").on('click', () => {
                _ied.getDir(path.dirname($("#remote-path").val()), true);
                if (options.syncFolders) {
                    if (path.basename(options.remote) == path.basename(options.local))
                        updateLocal(path.dirname(options.local));
                }
            })

            $("#remote-navigate").on('click', (e) => {
                e.preventDefault();
                e.cancelBubble = true;
                _ied.getDir($(e.target).data('path'), true);
            })

            $('#remote-path').change(function () {
                _ied.getDir($("#remote-path").val());
            });
            $('#remote-path').keyup(function (e) {
                if (e.which == 27)
                    $("#remote-path").val(options.remote);
            });

            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                var target = $(e.target).attr("href") // activated tab
                if (target == "#log")
                    $("#log-view")[0].scrollTop = $("#log-view")[0].scrollHeight;
            });

            $(document).keydown((event) => {

                //event.altKey, event.ctrlKey, event.shiftKey, event.metaKey

                switch (event.which) {
                    /*
                    case 113: //f2
                        if (!event.altKey && !event.ctrlKey && !event.shiftKey && !event.metaKey) {
                            console.log("Rename");
                            event.preventDefault();
                        }
                        break;
                        */
                    case 116: //f5
                        if (!event.altKey && !event.ctrlKey && !event.shiftKey && !event.metaKey) {
                            if ($("#local-list").hasClass("focused"))
                                updateLocal();
                            else if ($("#remote-list").hasClass("focused"))
                                _ied.getDir((!options.remote || options.remote.length === 0) ? '.' : options.remote);

                            event.preventDefault();
                        }
                        break;
                    case 46:
                        if (!event.altKey && !event.ctrlKey && !event.shiftKey && !event.metaKey) {
                            if ($("#local-list").hasClass("focused"))
                                deleteLocal()
                            else if ($("#remote-list").hasClass("focused"))
                                deleteRemote()
                            //else if ($("#queue-list").hasClass("focused"))
                            //queueTable.rows().select();                            
                            event.preventDefault();
                        }
                        break;
                    case 65://select all, hack as menu acceleartor doenst work
                        if (!event.altKey && event.ctrlKey && !event.shiftKey && !event.metaKey) {
                            //if ($("#local-list").hasClass("focused"))
                            localTable.rows().select();
                            //else if ($("#remote-list").hasClass("focused"))
                            //remoteTable.rows().select();
                            //else if ($("#queue-list").hasClass("focused"))
                            //queueTable.rows().select();
                            event.preventDefault();
                        }
                        break;
                    /*
                case 78:
                    if (!event.altKey && event.ctrlKey && !event.shiftKey && !event.metaKey) {
                        console.log("New folder");
                        event.preventDefault();
                    }
                    break;
                    */
                }
            });

            $('#drag-bar').mousedown(function (e) {
                e.preventDefault();
                dragging = true;
                var main = $('#remote');
                var ghostBar = $('<div>',
                    {
                        id: 'ghost-bar',
                        css: {
                            height: main.outerHeight(),
                            top: main.offset().top,
                            left: main.offset().left - 3
                        }
                    }).appendTo('body');

                $(document).mousemove(function (e) {
                    if (e.pageX < 199)
                        ghostBar.css("left", 199);
                    else if (e.pageX > document.body.clientWidth - 300)
                        ghostBar.css("left", document.body.clientWidth - 300);
                    else
                        ghostBar.css("left", e.pageX);
                });
            });

            $('#btm-drag-bar').mousedown(function (e) {
                e.preventDefault();
                btmDragging = true;
                var main = $('#bottom');
                var ghostBar = $('<div>',
                    {
                        id: 'btm-ghost-bar',
                        css: {
                            width: main.outerWidth(),
                            top: main.offset().top,
                            left: main.offset().left
                        }
                    }).appendTo('body');

                $(document).mousemove(function (e) {
                    console.log(`Drag y: ${e.pageY}`);
                    if (e.pageY < 199)
                        ghostBar.css("top", 199);
                    else if (e.pageY > document.body.clientHeight - 200)
                        ghostBar.css("top", document.body.clientHeight - 200);
                    else
                        ghostBar.css("top", e.pageY);
                });
            });

            $(window).on('resize', () => {
                if ($('#remote').outerWidth() < 300 && $("#local").outerWidth() > 202) {
                    $('#local').css("width", document.body.clientWidth - 300);
                    $('#remote').css("left", document.body.clientWidth - 300);
                    localTable.draw();
                    remoteTable.draw();
                    options.localSize = document.body.clientWidth - 300;
                    saveOptions();
                }

                if ($('#bottom').outerHeight() < 200 && $("#main").outerHeight() > 202) {
                    options.queueSize = 200;
                    $('#bottom').css("height", options.queueSize);
                    $('#main').css("bottom", options.queueSize);
                    localTable.draw();
                    remoteTable.draw();
                    queueTable.draw();
                    saveOptions();
                }

                var h = $("#main").outerHeight() - 40;
                if (options.showQueue)
                    h += $("#bottom").outerHeight();
                $("#local-navigate").css("max-height", h + "px");
                $("#remote-navigate").css("max-height", h + "px");

            });

            $(document).mouseup(function (e) {
                if (dragging) {
                    if (e.pageX < 200) {
                        $('#local').css("width", 202);
                        $('#remote').css("left", 202);
                        options.localSize = 202;
                    }
                    else if (e.pageX > document.body.clientWidth - 300) {
                        $('#local').css("width", document.body.clientWidth - 300);
                        $('#remote').css("left", document.body.clientWidth - 300);
                        options.localSize = document.body.clientWidth - 300;
                    }
                    else {
                        $('#local').css("width", e.pageX + 2);
                        $('#remote').css("left", e.pageX + 2);
                        options.localSize = e.pageX + 2;
                    }
                    localTable.draw();
                    remoteTable.draw();
                    saveOptions();
                    $('#ghost-bar').remove();
                    $(document).unbind('mousemove');
                    dragging = false;
                }
                else if (btmDragging) {
                    console.log(e.pageY);
                    if (e.pageY < 226)
                        options.queueSize = document.body.clientHeight - 202;
                    else if (e.pageY > document.body.clientHeight - 200)
                        options.queueSize = 200;
                    else
                        options.queueSize = document.body.clientHeight - e.pageY + 2;
                    options.queueSize -= 26;
                    $('#bottom').css("height", options.queueSize);
                    $('#main').css("bottom", options.queueSize);
                    localTable.draw();
                    remoteTable.draw();
                    queueTable.draw();
                    saveOptions();
                    $('#btm-ghost-bar').remove();
                    $(document).unbind('mousemove');
                    btmDragging = false;
                }
            });

            $(window).trigger('resize');

            window.onbeforeunload = function () {
                if (watcher)
                    watcher.close();
            };
        });

        function showLocalContextMenu() {
            var selected = localTable.rows({ selected: true }).data().pluck('size');
            var dirs = 0;
            for (var d = 0; d < selected.length; d++) {
                if (selected[d] == -2) {
                    dirs++;
                }
            }
            dirs = dirs == selected.length

            var c = new Menu();
            c.append(new MenuItem({
                label: 'Refresh',
                click: () => {
                    updateLocal();
                }
            }));
            if (selected.length) {
                c.append(new MenuItem({ type: 'separator' }));
                if (!dirs) {
                    c.append(new MenuItem({
                        label: 'Upload',
                        click: upload
                    }));
                    c.append(new MenuItem({ type: 'separator' }));
                }
                c.append(new MenuItem({
                    label: 'Copy full path',
                    click: () => {
                        var selected = localTable.rows({ selected: true }).data().pluck('path');
                        clipboard.writeText(selected.join('\n'), 'selection');
                    }
                }));
                /*
                c.append(new MenuItem({
                    label: 'Rename',
                }));
                */
                c.append(new MenuItem({
                    label: 'Delete',
                    click: deleteLocal
                }));
                /*
                c.append(new MenuItem({
                    label: 'Create directory',
                }));
                */
            }
            c.append(new MenuItem({ type: 'separator' }));
            c.append(new MenuItem({
                label: 'Select all',
                click: () => {
                    localTable.rows().select();
                }
            }));
            if (selected.length) {
                c.append(new MenuItem({ type: 'separator' }));
                c.append(new MenuItem({
                    label: 'Reveal in explorer...',
                    click: () => {
                        {
                            var selected = localTable.rows({ selected: true }).data().pluck('path');
                            for (var d = 0, dl = selected.length; d < dl; d++)
                                shell.showItemInFolder(selected[d]);
                        }
                    }
                }));
                if (!dirs) {
                    c.append(new MenuItem({ type: 'separator' }));
                    c.append(new MenuItem({
                        label: 'Open...',
                        click: () => {
                            var selected = localTable.rows({ selected: true }).data().pluck('path');
                            for (var d = 0, dl = selected.length; d < dl; d++)
                                openItem(selected[d]);
                        }
                    }));
                    if (options.editor && options.editor.length > 0)
                        c.append(new MenuItem({
                            label: 'Open with editor...',
                            click: () => {
                                var selected = localTable.rows({ selected: true }).data().pluck('path');
                                for (var d = 0, dl = selected.length; d < dl; d++) {
                                    p = child_process.spawn(options.editor, [selected[d]], { detached: true, stdio: ['ignore', 'ignore', 'ignore'] });
                                    p.unref();
                                }
                            }
                        }));
                }
            }
            c.popup(remote.getCurrentWindow(), { async: true });
        }

        function showRemoteContextMenu() {
            var selected = remoteTable.rows({ selected: true }).data().pluck('size');
            var dirs = 0;
            for (var d = 0; d < selected.length; d++) {
                if (selected[d] == -2) {
                    dirs++;
                }
            }
            dirs = dirs == selected.length

            var c = new Menu();
            c.append(new MenuItem({
                label: 'Refresh',
                click: () => {
                    _ied.getDir((!options.remote || options.remote.length === 0) ? '.' : options.remote);
                }
            }));
            if (selected.length > 0) {
                c.append(new MenuItem({ type: 'separator' }));
                if (!dirs) {
                    c.append(new MenuItem({
                        label: 'Download',
                        click: download
                    }));
                    c.append(new MenuItem({ type: 'separator' }));
                }
                c.append(new MenuItem({
                    label: 'Copy full path',
                    click: () => {
                        var selected = remoteTable.rows({ selected: true }).data().pluck('path');
                        clipboard.writeText(selected.join('\n'), 'selection');
                    }
                }));
                /*
                c.append(new MenuItem({
                    label: 'Rename',
                }));
                */
                c.append(new MenuItem({
                    label: 'Delete',
                    click: deleteRemote
                }));
                /*
                c.append(new MenuItem({
                    label: 'Create directory',
                }));
                */
            }
            c.append(new MenuItem({ type: 'separator' }));
            c.append(new MenuItem({
                label: 'Select all',
                click: () => {
                    remoteTable.rows().select();
                }
            }));
            c.popup(remote.getCurrentWindow(), { async: true });
        }

        function updateStatus() {
            var tmp = [];
            if (info.localfiles)
                tmp.push(`Local files: ${info.localfiles}`);
            if (info.localdirs)
                tmp.push(`Local folders: ${info.localdirs}`);
            var size = 0;
            var data = localTable.rows({ selected: true }).data();
            data.map(function (key, index) {
                if (data[index].size > 0)
                    size += data[index].size;
            });
            if (size)
                tmp.push(`Local selected: ${formatSize(size)}`);
            $("#localInfo").text(tmp.join(", "));

            tmp = [];
            if (info.remotefiles)
                tmp.push(`Remote files: ${info.remotefiles}`);
            if (info.remotedirs)
                tmp.push(`Remote folders: ${info.remotedirs}`);

            size = 0;
            data = remoteTable.rows({ selected: true }).data();
            data.map(function (key, index) {
                if (data[index].size > 0)
                    size += data[index].size;
            });
            if (size)
                tmp.push(`Remote selected: ${formatSize(size)}`);
            $("#remoteInfo").text(tmp.join(", "));


            tmp = [];
            if (info.uploads)
                tmp.push(`Uploads: ${info.uploads}`);
            if (info.downloads)
                tmp.push(`Downloads: ${info.downloads}`);
            $("#queueInfo").text(tmp.join(", "));
        }

        function toggleSync() {
            options.syncFolders = !options.syncFolders;
            updateMenuItem({ menu: 'view|sync folders', checked: options.syncFolders });
            if (options.syncFolders)
                $("#btn-sync").addClass("active")
            else
                $('#btn-sync').removeClass('active');
            saveOptions();
        }

        function toggleQueue() {
            options.showQueue = !options.showQueue;
            updateMenuItem({ menu: 'view|show queue and log', checked: options.showQueue });
            if (options.showQueue) {
                $("#btn-queue").addClass("active");
                $("#bottom").css('display', '');
                $("#main").css('bottom', options.queueSize + 'px');
            }
            else {
                $('#btn-queue').removeClass('active');
                $("#bottom").css('display', 'none');
                $("#main").css('bottom', '28px');
            }
            saveOptions();
            $(window).trigger('resize');
        }

        function openItem(path) {
            if (!path || path.length == 0) return;
            shell.openItem(path)
        }

        function download() {
            var data = remoteTable.rows({ selected: true }).data();
            for (var d = 0, dl = data.length; d < dl; d++) {
                if (data[d].size == -2)
                    continue;
                _ied.download(data[d].path);
            }
        }

        function upload() {
            var data = localTable.rows({ selected: true }).data();
            for (var d = 0, dl = data.length; d < dl; d++) {
                if (data[d].size == -2)
                    continue;
                _ied.upload(data[d].path);
            }
        }

        function closing() {
            if (watcher)
                watcher.close();
        }

        function createWatcher() {
            if (watcher)
                watcher.close();
            watcher = chokidar.watch(options.local, {
                persistent: true,
                depth: 0
            });

            // Something to use when events are received.
            var log = console.log.bind(console);
            var ready = false;
            watcher
                .on('error', error => {
                    if (options.debug)
                        log(`Watcher error: ${error}`)
                    logMessage(`Watcher error: ${error}`);
                })
                .on('ready', () => {
                    if (options.debug)
                        log('Initial scan complete. Ready for changes')
                    ready = true;
                })
                .on('addDir', (path, stats) => {
                    if (options.debug)
                        log(`Directory ${path} has been added`)
                    if (ready && path != options.local)
                        addLocalFile(path);
                })
                .on('unlinkDir', p => {
                    if (options.debug)
                        log(`Directory ${p} has been removed`)
                    if (ready) removeLocalFile(p);
                })
                .on('add', (path, stats) => {
                    if (options.debug)
                        log(`File ${path} has been added`)
                    if (ready && path != options.local)
                        addLocalFile(path);
                })
                .on('change', (path, stats) => {
                    if (options.debug)
                        log(`File ${path} has been changed`)
                    updateLocalFile(path);
                })
                .on('unlink', p => {
                    if (options.debug)
                        log(`File ${p} has been removed`)
                    if (ready)
                        removeLocalFile(p);
                })
                .on('raw', (event, path, details) => {
                    if (options.debug)
                        log('Raw event info:', event, path, details);
                });
        }

        function updateLocalFile(p) {
            try {
                file = IED.getFileInfo(p);
            }
            catch (error) {
                logError(error);
                return;
            }
            if (file.hidden && !options.showhidden) {
                if (_local[file.name]) {
                    removeLocalFile(file.path);
                    info.localfies--;
                }
                return;
            }

            var row = localTable.row(function (idx, data, node) {
                return data.name == path.basename(p) ?
                    true : false;
            });
            _local[file.name] = file;
            if (row && row.length == 1)
                row.remove();
            localTable.row.add(_local[file.name]).draw();
            if (options.debug)
                console.log(_downloads[p]);
            if (file.size != -2 && !_downloads[p] && options.uploadOnChange)
                _ied.upload(p);

            if (_downloads[p])
                delete _downloads[p];
        }

        function removeLocalFile(p) {
            var row = localTable.row(function (idx, data, node) {
                return data.name == path.basename(p) ?
                    true : false;
            });
            row.remove().draw();
            if (_local[path.basename(p)].size == -2)
                info.localdirs--;
            else
                info.localfiles--;
            delete _local[path.basename(p)];
            updateStatus();
        }

        function addLocalFile(path) {
            try {
                file = IED.getFileInfo(path);
            }
            catch (error) {
                logError(error);
                return;
            }
            if (file.hidden && !options.showhidden)
                return;
            if (file.size == -2)
                info.localdirs++;
            else
                info.localfiles++;
            _local[file.name] = file;
            localTable.row.add(_local[file.name]).draw();
            if (options.debug)
                console.log(_downloads[path]);
            if (file.size != -2 && !_downloads[path] && options.uploadOnChange)
                _ied.upload(path);
            if (_downloads[path])
                delete _downloads[path];
            updateStatus();
        }

        function deleteLocal() {
            var data = localTable.rows({ selected: true }).data().pluck('path');
            for (var d = 0, dl = data.length; d < dl; d++)
                shell.moveItemToTrash(data[d]);
        }

        function deleteRemote() {
            var data = remoteTable.rows({ selected: true }).data();
            dialog.showMessageBox(remote.getCurrentWindow(), {
                type: 'warning',
                title: "Delete?",
                message: data.length > 1 ? "Delete remote files?" : "Delete remote file: " + data[0].name + "?",
                buttons: ['Yes', 'No'],
                defaultId: 1,
            }, (response) => {
                if (response == 0) {
                    for (var d = 0, dl = data.length; d < dl; d++)
                        _ied.deleteFile(data[d].path);
                }
            })
        }

        ipcRenderer.on('GMCP-received', (event, data) => {
            if (options && options.debug)
                console.log(data.mod);
            if (_ied)
                _ied.processGMCP(data.mod, data.obj);
        });

        ipcRenderer.on('reload-options', (event) => {
            loadOptions()
        });

        ipcRenderer.on('setting-changed', (event, data) => {
            if (data.type == "extensions" && data.name == "immortal")
                loadOptions(data.value);
        })
    </script>
</head>

<body>
    <div id="main">
        <div id="local">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <label class="control-label" for="local-path">
                        Local
                        <button id="btn-refresh-local" type="button" class="btn btn-default btn-xs" title="Refresh" onclick="updateLocal();">
                            <i class="fa fa-refresh"></i>
                        </button>
                        <button id="btn-upload-local" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Upload files" onclick="upload()">
                            <i class="fa fa-upload"></i>
                        </button>
                        <div class="btn-group" role="group">
                            <!--
                            <button id="btn-rename-local" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Rename" onclick="">
                                <i class="fa fa-i-cursor"></i>
                            </button>                            
                            -->
                            <button id="btn-delete-local" disabled="disabled" type="button" class="btn btn-danger btn-xs" title="Delete" onclick="deleteLocal()">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>

                        <!--
                        <button id="btn-newfolder-local" type="button" class="btn btn-default btn-xs" title="Create directory" onclick="">
                            <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                                <i class="fa fa-folder-o fa-stack-2x" style="font-size: 1em"></i>
                                <i class="fa fa-plus fa-stack-1x" style="font-size: 0.8em;margin-top: -2px;left:5px;"></i>
                            </span>
                        </button>
                        -->
                    </label>

                    <span class="path-container">
                        <div class="input-group">
                            <input type="text" id="local-path" class="form-control" />
                            <span class="input-group-btn">
                                <button id="button-local" class="btn btn-default dropdown-toggle" style="width:17px;min-width:17px;border-radius: 0;padding-left:4px;padding-right:4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                    <span class="caret" style="margin-left: -1px;"></span>
                                </button>
                                <ul id="local-navigate" class="dropdown-menu" aria-labelledby="button-local" data-container="body"></ul>
                                <button id="btn-local-up" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Go up a directory" onclick="">
                                    <span class="fa-stack" style="top: -3px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                                        <i class="fa fa-folder-o fa-stack-2x" style="font-size: 1.2em"></i>
                                        <i class="fa fa-caret-up fa-stack-1x" style="font-size: 1em;margin-top: 1px;"></i>
                                    </span>
                                </button>
                            </span>

                        </div>
                    </span>
                    <span class="path-buttons">
                        <button id="btn-sync" type="button" class="btn btn-default btn-xs" title="Sync folders" onclick="toggleSync();">
                            <i class="fa fa-exchange"></i>
                        </button>
                    </span>
                </div>
                <div id="local-list-container" class="panel-body" style="padding:0px;top:61px;bottom:1px;left:1px;right:5px;position: absolute;">
                    <table tabindex="0" id="local-list" class="table table-striped table-hover table-condensed" style="width: 100%;height: 100%;padding:0px;margin:0px !important;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Size</th>
                                <th>Type</th>
                                <th>Date Modified</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
            <div id="drag-bar"></div>
        </div>
        <div id="remote">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <label class="control-label" for="remote-path">
                        Remote
                        <button id="btn-refresh-remote" type="button" class="btn btn-default btn-xs" title="Refresh" onclick="_ied.getDir((!options.remote || options.remote.length === 0) ? '.' : options.remote);">
                            <i class="fa fa-refresh"></i>
                        </button>
                        <button id="btn-download-remote" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Download files" onclick="download()">
                            <i class="fa fa-download"></i>
                        </button>

                        <div class="btn-group" role="group">
                            <!--    
                            <button id="btn-rename-remote" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Rename" onclick="">
                                <i class="fa fa-i-cursor"></i>
                            </button>
                            -->
                            <button id="btn-delete-remote" disabled="disabled" type="button" class="btn btn-danger btn-xs" title="Delete" onclick="deleteRemote()">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        <!--
                        <button id="btn-newfolder-remote" type="button" class="btn btn-default btn-xs" title="Create directory" onclick="">
                            <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                                <i class="fa fa-folder-o fa-stack-2x" style="font-size: 1em"></i>
                                <i class="fa fa-plus fa-stack-1x" style="font-size: 0.8em;margin-top: -2px;left:5px;"></i>
                            </span>
                        </button>
                        -->
                    </label>

                    <span class="path-container">
                        <div class="input-group">
                            <input type="text" id="remote-path" class="form-control" />
                            <span class="input-group-btn">
                                <button id="button-remote" class="btn btn-default" style="width: 17px;min-width:17px;border-radius:0;padding-left:4px;padding-right:4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                    <span class="caret" style="margin-left: -1px;"></span>
                                </button>
                                <ul id="remote-navigate" class="dropdown-menu pull-right" aria-labelledby="button-remote" data-container="body"></ul>
                                <button id="btn-remote-up" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Go up a directory" onclick="">
                                    <span class="fa-stack" style="top: -3px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                                        <i class="fa fa-folder-o fa-stack-2x" style="font-size: 1.2em"></i>
                                        <i class="fa fa-caret-up fa-stack-1x" style="font-size: 1em;margin-top: 1px;"></i>
                                    </span>
                                </button>
                            </span>
                        </div>
                    </span>
                </div>
                <div id="remote-list-container" class="panel-body" style="padding:0px;top:61px;bottom:1px;left:1px;right:1px;position: absolute;">
                    <table tabindex="0" id="remote-list" class="table table-striped table-hover table-condensed" style="width: 100%;height: 100%;padding:0px;margin:0px !important;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Size</th>
                                <th>Type</th>
                                <th>Date Modified</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="bottom">
        <div id="btm-drag-bar"></div>
        <ul class="nav nav-tabs" role="tablist" style="background-color: #F5F5F5;box-shadow: inset 0 -1px 0 #fff;">
            <li role="presentation" class="active">
                <a href="#queue" aria-controls="queue" role="tab" data-toggle="tab">Queue</a>
            </li>
            <li role="presentation">
                <a href="#log" aria-controls="log" role="tab" data-toggle="tab">Log</a>
            </li>
        </ul>
        <div class="tab-content" style="padding: 4px;position: absolute;left: 0;right: 0;bottom: 0;top: 46px;">
            <div role="tabpanel" class="tab-pane fade in active" id="queue" style="margin:0 !important;padding:4px;height:100%;">
                <div id="toolbar" class="btn-toolbar" role="toolbar">
                    <!--
        <div class="btn-group" role="group" id="queue-controls">
            <button id="btn-restart" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Restart" onclick=""><i class="fa fa-rotate-left"></i></button>
            <button id="btn-pause" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Pause" onclick="" data-toggle="button"><i class="fa fa-pause"></i></button>
            <button id="btn-stop" disabled="disabled" type="button" class="btn btn-warning btn-xs" title="Stop" onclick=""><i class="fa fa-stop"></i></button>
        </div>
        -->
                    <button id="btn-reset" type="button" class="btn btn-warning btn-xs" title="Reset all" onclick="_ied.reset();">
                        <i class="fa fa-eject"></i>
                    </button>
                </div>
                <div id="queue-list-container" style="padding:0px;top:28px;bottom:0px;left:2px;right:2px;position: absolute;">
                    <table tabindex="0" id="queue-list" class="table table-striped table-hover table-condensed" style="width: 100%;height: 100%;padding:0px;margin:0 !important;">
                        <thead>
                            <tr>
                                <th>Local</th>
                                <th>&lt;-&gt;</th>
                                <th>Remote</th>
                                <th>Progress</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="log" style="padding:4px;height:100%;">
                <div role="tabpanel" class="tab-pane fade in active" id="queue" style="margin:0 !important;padding:4px;height:100%;">
                    <div id="toolbar-log" class="btn-toolbar" role="toolbar">
                        <button id="btn-clear" type="button" class="btn btn-default btn-xs" title="Clear log" onclick="$('#log-view').html('');">
                            <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                                <i class="fa fa-file-o fa-stack-2x" style="font-size: 1em"></i>
                                <i class="fa fa-times fa-stack-1x" style="font-size: 0.5em;margin-top: 1px;"></i>
                            </span>
                        </button>
                    </div>
                    <pre id="log-view"></pre>
                </div>
            </div>
        </div>
    </div>
    <div id="status" class="btn-toolbar" role="toolbar">
        <div id="localInfo" style="width:33%;display:inline-block;"></div>
        <div id="queueInfo" style="width:33%;display:inline-block;"></div>
        <div id="remoteInfo" style="width:33%;display:inline-block;"></div>
    </div>
</body>

</html>
<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <link rel="shortcut icon" href="../assets/icons/png/chat.png" />
    <link href="../lib/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-select.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/main.css" rel="stylesheet" type="text/css" />
    <link href="css/ansi.css" rel="stylesheet" type="text/css" />
    <link href="css/chat.css" rel="stylesheet" type="text/css" />
    <link href="css/theme.css" rel="stylesheet" type="text/css" />
    <script>
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="../lib/jquery.min.js"></script>
    <script src="../lib/bootstrap.min.js"></script>
    <script src="../lib/bootstrap-select.min.js"></script>
    <script>
        const { clipboard, ipcRenderer, remote, webFrame } = require('electron');
        const { parseTemplate } = require("./js/library.js");
        const { Settings } = require('./js/settings');
        const { Display } = require('./js/display');
        const { AnsiColorCode } = require('./js/ansi');
        var options;

        var display, _logger, _zoom = 1.0;

        function loadOptions() {
            options = Settings.load(remote.getGlobal('settingsFile'));
            if (display) {
                display.updateFont(options.chat.font, options.chat.fontSize);
                display.maxLines = options.bufferSize;
            }
            if (_logger) {
                _logger.postMessage({
                    action: 'options', args: {
                        path: parseTemplate(options.logPath),
                        offline: options.logOffline,
                        gagged: options.logGagged,
                        enabled: options.chat.log,
                        unique: options.logUniqueOnConnect,
                        prepend: options.logPrepend,
                        what: options.logWhat,
                        debug: options.enableDebug,
                        postfix: '.chat',
                        format: options.logTimeFormat
                    }
                });
                _logger.postMessage({ action: 'start', args: { lines: display.lines, raw: display.rawLines, formats: display.lineFormats, fragment: display.EndOfLine } });
            }
            _zoom = options.chat.zoom;
            webFrame.setZoomFactor(_zoom);
        }

        function error(err) {
            echo("Error: " + err + ".", AnsiColorCode.ErrorText, AnsiColorCode.ErrorBackground, true, true);
        }

        function echo(str, fore, back, newline, forceLine) {
            if (str == null) str = '';
            if (newline == null) newline = false;
            if (forceLine == null) forceLine = false;
            if (fore == null) fore = AnsiColorCode.LocalEcho;
            if (back == null) back = AnsiColorCode.LocalEchoBack;
            var codes = display.CurrentAnsiCode() + '\n';
            if (str.endsWith('\n'))
                str = str.substr(0, str.length - 1);
            str = "\x1b[" + fore + ";" + back + "m" + str + codes;
            if (newline && display.textLength > 0 && !display.EndOfLine)
                str = '\n' + str;
            display.append(str, false);
        }

        $(document).ready(function () {
            display = new Display($("#display"));

            display.on('selection-done', () => {
                if (options.AutoCopySelectedToClipboard && display.hasSelection) {
                    clipboard.writeText(display.selection, 'selection');
                    clipboard.writeText(display.selection);
                    display.clearSelection();
                }
            });
            _logger = new Worker("./js/logging.js");
            _logger.onmessage = (e) => {
                switch (e.data.event) {
                    case 'started':
                        $("#btn-enable").button('toggle');
                        ipcRenderer.send('setting-changed', { chat: 'chat', name: 'log', value: e.data.args });
                        break;
                    case 'stopped':
                        $("#btn-enable").button('toggle');
                        ipcRenderer.send('setting-changed', { chat: 'chat', name: 'log', value: e.data.args });
                        break;
                    case 'logging':
                        break;
                    case 'error':
                        error(e.data.args);
                        break;
                    case 'debug':
                        if (options.enableDebug)
                            console.debug(e.data.args);
                        break;
                    case 'toggled':
                        options.chat.log = e.data.args;
                        ipcRenderer.send('setting-changed', { chat: 'chat', name: 'log', value: e.data.args });
                        break;
                    case 'startInternal':
                    case 'start':
                        _logger.postMessage({ action: e.data.event, args: { lines: display.lines, raw: display.rawLines, formats: display.lineFormats, fragment: display.EndOfLine } });
                        break;
                }
            };
            _logger.onerror = (e) => {
                error(e);
            };


            loadOptions();

            ['copy'].forEach(function (event) {
                document.addEventListener(event, function (e) {
                    if (display.hasSelection) {
                        clipboard.writeText(display.selection, 'selection');
                        clipboard.writeText(display.selection);
                    }
                });
            });
        });

        function doCopy() {
            if (display.hasSelection) {
                clipboard.writeText(display.selection, 'selection');
                clipboard.writeText(display.selection);
            }
        }

        function doFind() {
            display.showFind();
        }

        ipcRenderer.on('chat', (event, data) => {
            display.addParserLine(data);
            if (!options)
                loadOptions();
            _logger.postMessage({ action: 'add-line', args: data });
        });

        /*
        ipcRenderer.on('chat-done', (event, data) => {

        });
        */

        ipcRenderer.on('set-title', (event, title) => {
            if (!options)
                loadOptions();
            _logger.postMessage({ action: 'name', args: title });
        });

        ipcRenderer.on('load-char', (event, char) => {
            _logger.postMessage({ action: 'name', args: char });
        });

        ipcRenderer.on('load-default', (event) => {
            _logger.postMessage({ action: 'name', args: '' });
        });

        ipcRenderer.on('reload-options', (event) => {
            loadOptions();
        });

        ipcRenderer.on('connected', (event) => {
            if (!options)
                loadOptions();
            _logger.postMessage({ action: 'connected', args: true });
        });

        function toggle() {
            _logger.postMessage({ action: 'toggle' });
        }

        function clearDisplaySelection() {
            display.clear();
        }

        function updateZoom(z) {
            if (z < 0.5)
                z = 0.5;
            else if (z > 3.0)
                z = 3.0;
            _zoom = z;
            webFrame.setZoomFactor(z);
            ipcRenderer.send('setting-changed', { chat: 'chat', name: 'zoom', value: z });
        }
    </script>
</head>

<body>
    <div id="toolbar" class="btn-toolbar" role="toolbar">
        <button id="btn-find" type="button" class="btn btn-default btn-xs" title="Find" onclick="doFind()">
            <i class="fa fa-search"></i>
        </button>
        <div class="btn-group" role="group">
            <button id="btn-enable" type="button" class="btn btn-default btn-xs" title="Log to file" onclick="toggle()" data-toggle="button">
                <i class="fa fa-file-text-o"></i>
            </button>
            <button id="btn-clear" type="button" class="btn btn-default btn-xs" title="Clear display" onclick="$('#display').empty();" data-toggle="button">
                <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                    <i class="fa fa-file-o fa-stack-2x" style="font-size: 1em"></i>
                    <i class="fa fa-times fa-stack-1x" style="font-size: 0.5em;margin-top: 1px;"></i>
                </span>
            </button>
        </div>
        <button id="btn-copy" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Copy" onclick="doCopy()">
            <i class="fa fa-copy"></i>
        </button>
        <div class="btn-group" role="group">
            <button id="btn-zoom-in" type="button" class="btn btn-default btn-xs" title="Zoom out" onclick="_zoom -= 0.05; updateZoom(_zoom);">
                <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                    <i class="fa fa-television fa-stack-2x" style="font-size: 1em"></i>
                    <i class="fa fa-minus fa-stack-1x" style="font-size: 0.5em;margin-top: -1px;"></i>
                </span>
            </button>
            <button id="btn-zoom-reset" type="button" class="btn btn-default btn-xs" title="Zoom reset" onclick="_zoom = 1; webFrame.setZoomFactor(_zoom);">
                <i class="fa fa-television"></i>
            </button>
            <button id="btn-zoom-out" type="button" class="btn btn-default btn-xs" title="Zoom in" onclick="_zoom += 0.05; updateZoom(_zoom);">
                <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                    <i class="fa fa-television fa-stack-2x" style="font-size: 1em"></i>
                    <i class="fa fa-plus fa-stack-1x" style="font-size: 0.5em;margin-top: -1px;"></i>
                </span>
            </button>
        </div>
    </div>
    <div id="display"></div>
</body>

</html>
<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <link rel="shortcut icon" href="../assets/icons/png/chat.png" />
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="css/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link href="css/bootstrap-select.min.css" rel="stylesheet" type="text/css" />
    <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/main.css" rel="stylesheet" type="text/css" />
    <link href="css/ansi.css" rel="stylesheet" type="text/css" />
    <link href="css/chat.css" rel="stylesheet" type="text/css" />
    <link href="css/theme.css" rel="stylesheet" type="text/css" />
    <script>
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="../lib/jquery.min.js"></script>
    <script src="../lib/bootstrap.min.js"></script>
    <script src="../lib/bootstrap-select.min.js"></script>
    <script>
        const { shell, clipboard, ipcRenderer, remote } = require('electron');
        const { dialog, Menu, MenuItem, app } = remote;
        const { parseTemplate, setSelectionRange } = require("./js/library.js");
        const { Settings } = require('./js/settings');
        const { Log } = require('./js/types');
        const { Display } = require('./js/display');
        const { AnsiColorCode } = require('./js/ansi');
        const fs = require('fs');
        const path = require('path');
        const { version } = require("../package.json");
        var options, currentFile, _path, timeStamp = new Date().getTime(), _name;

        var display;

        function loadOptions() {
            options = Settings.load(remote.getGlobal('settingsFile'));
            _path = parseTemplate(options.logPath);
            if (display) {
                display.updateFont(options.font, options.fontSize);
                display.maxLines = options.bufferSize;
            }
        }

        function error(err) {
            echo("Error: " + err + ".", AnsiColorCode.ErrorText, AnsiColorCode.ErrorBackground, true, true);
        }

        function echo(str, fore, back, newline, forceLine) {
            if (str == null) str = "";
            if (newline == null) newline = false;
            if (forceLine == null) forceLine = false;
            if (fore == null) fore = AnsiColorCode.LocalEcho;
            if (back == null) back = AnsiColorCode.LocalEchoBack;
            var codes = display.CurrentAnsiCode() + "\n";
            if (str.endsWith("\n"))
                str = str.substr(0, str.length - 1);
            str = "\x1b[" + fore + ";" + back + "m" + str + codes;
            if (newline && display.textLength > 0 && !display.EndOfLine)
                str = "\n" + str;
            display.append(str, false);
        }

        $(document).ready(function () {
            display = new Display($("#display"));

            display.on('selection-done', () => {
                if (options.AutoCopySelectedToClipboard && display.hasSelection) {
                    clipboard.writeText(display.selection, 'selection');
                    display.clearSelection();
                }
            })

            loadOptions();
            if (options.chat.log)
                start();

            ['copy'].forEach(function (event) {
                document.addEventListener(event, function (e) {
                    if (display.hasSelection)
                        clipboard.writeText(client.display.selection, 'selection');
                });
            });
        });

        function doCopy() {
            if (display.hasSelection)
                clipboard.writeText(gclient.display.selection, 'selection');
        }

        function doFind() {
            display.showFind();
        }

        ipcRenderer.on('chat', (event, data) => {
            display.addParserLine(data);
            if (!options)
                loadOptions();
            if ((options.logWhat & Log.Html) === Log.Html) {
                //TODO build html from formats
                //writeHtml("");
            }
            if ((options.logWhat & Log.Text) === Log.Text || options.logWhat === Log.None)
                writeText(data.line + "\n");
            if ((options.logWhat & Log.Raw) === Log.Raw)
                writeRaw(data.raw);
        });

        ipcRenderer.on('chat-done', (event, data) => {

        });

        ipcRenderer.on('set-title', (event, title) => {
            if (!options)
                loadOptions();
            _name = title;
            buildFilename();
        });

        function writeText(data) {
            if (!options.chat.log) return;
            writeHeader();
            fs.appendFile(currentFile + ".txt", data, (err) => {
                error(err);
            });
        }

        function writeHtml(data) {
            if (!options.chat.log) return;
            writeHeader();
            fs.appendFile(currentFile + ".htm", data, (err) => {
                error(err);
            });
        }

        function writeRaw(data) {
            if (!options.chat.log) return;
            writeHeader();
            fs.appendFile(currentFile + ".raw.txt", data, (err) => {
                error(err);
            });
        }

        function writeHeader() {
            buildFilename();
            if (!fs.existsSync(currentFile + ".htm") && (options.logWhat & Log.Html) === Log.Html) {
                fs.appendFile(currentFile + ".htm", "<style>\nbody\n{\n	font-family: \'Courier New\', Courier, monospace;\n	text-align: left;\n	font-size: 1em;\n	white-space: pre;\n	background-color: black;	\n}\n/* --- Start CSS for ansi display --- */\n@-webkit-keyframes blinker { \n 	0% { opacity: 1.0; }\n  50% { opacity: 0.0; }\n  100% { opacity: 1.0; }\n} \n\n@keyframes blinker { \n 	0% { opacity: 1.0; }\n  50% { opacity: 0.0; }\n  100% { opacity: 1.0; }\n} \n\n.ansi-blink { \n	text-decoration:blink;\n	animation-name: blinker;\n	animation-iteration-count: infinite; \n	animation-timing-function: cubic-bezier(1.0,0,0,1.0); \n	animation-duration: 1s; \n	-webkit-animation-name: blinker;\n	-webkit-animation-iteration-count: infinite; \n	-webkit-animation-timing-function: cubic-bezier(1.0,0,0,1.0); \n	-webkit-animation-duration: 1s; \n}\n\n.ansi\n{\n	padding: 0px;\n	margin:0px;\n	\n}\n\n.line \n{\n	word-wrap:break-word;\n	word-break:break-all;\n	width: 100%;\n	display: block;\n	padding-bottom:1px;\n	clear:both;\n	line-height: normal;\n}	\n\n.line hr{ border: 0px; }\n/* --- End CSS for ansi display --- */\n\n.line a, .line a:link \n{\n	color: inherit;\n	font-weight: inherit;\n	text-decoration: underline;\n}\n\n.URLLink, .URLLink:link\n{\n	text-decoration: underline;\n	cursor: pointer;\n}\n</style>\n", (err) => {
                    error(err);
                });
            }
        }

        function buildFilename() {
            currentFile = timeStamp.toString();
            if (_name && _name.length > 0)
                currentFile += "." + _name;
            currentFile = path.join(_path, currentFile) + ".chat";
            if (options.enableDebug)
                console.log('Log file: "' + currentFile + '"');
        }

        ipcRenderer.on('reload-options', (event) => {
            loadOptions();
            buildFilename();
        });

        ipcRenderer.on('connected', (event) => {
            if (!options)
                loadOptions();
            if (options.logUniqueOnConnect || !timeStamp)
                timeStamp = new Date().getTime();
            buildFilename();
        });

        function start() {
            options.chat.log = true;
            $("#btn-enable").button('toggle');
            ipcRenderer.send('setting-changed', { chat: 'chat', name: 'log', value: true });
            if (!timeStamp)
                timeStamp = new Date().getTime();
            buildFilename();
            if (options.logPrepend) {
                if ((options.logWhat & Log.Html) === Log.Html) {
                    //TODO build html from formats
                    //writeHtml("");
                }
                if ((options.logWhat & Log.Text) === Log.Text || options.logWhat === Log.None)
                    writeText(display.text);
                if ((options.logWhat & Log.Raw) === Log.Raw)
                    writeRaw(display.raw);
            }

        }

        function stop() {
            options.chat.log = false;
            ipcRenderer.send('setting-changed', { chat: 'chat', name: 'log', value: false });
        }

        function toggle() {
            if (options.chat.log)
                stop();
            else
                start();
        }

        function clearDisplaySelection() {
            display.clear();
        }
    </script>
</head>

<body>
    <div id="toolbar" class="btn-toolbar" role="toolbar">
        <button id="btn-find" type="button" class="btn btn-default btn-xs" title="Find" onclick="doFind()"><i class="fa fa-search"></i></button>
        <div class="btn-group" role="group">
            <button id="btn-enable" type="button" class="btn btn-default btn-xs" title="Log to file" onclick="toggle()" data-toggle="button"><i class="fa fa-file-text-o"></i></button>
            <button id="btn-clear" type="button" class="btn btn-default btn-xs" title="Clear display" onclick="$('#display').empty();"
                data-toggle="button">
                    <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                        <i class="fa fa-file-o fa-stack-2x" style="font-size: 1em"></i>
                        <i class="fa fa-times fa-stack-1x" style="font-size: 0.5em;margin-top: 1px;"></i>
                    </span>                    
                </button>
        </div>
        <button id="btn-copy" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Copy" onclick="doCopy()"><i class="fa fa-copy"></i></button>
    </div>
    <div id="display"></div>
</body>

</html>
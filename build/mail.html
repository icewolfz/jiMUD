<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>Mail</title>
    <link rel="shortcut icon" href="../assets/icons/png/ied.png" />
    <link href="../lib/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-select.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-treeview.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/mail.css" rel="stylesheet" type="text/css" />
    <link href="css/form.css" rel="stylesheet" type="text/css" />
    <link href="css/ansi.css" rel="stylesheet" type="text/css" />
    <link href="css/theme.css" rel="stylesheet" type="text/css" />
    <link href="../lib/datatables.min.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript">
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="../lib/jquery.min.js" type="text/javascript"></script>
    <script src="../lib/bootstrap.min.js" type="text/javascript"></script>
    <script src="../lib/bootstrap-select.min.js" type="text/javascript"></script>
    <script src="../lib/datatables.min.js" type="text/javascript"></script>
    <script src="../lib/datatables.scrollresize.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        if (window.module) module = window.module;
        //spell-checker:ignore hellip datatable, datatables, scrollresize, prefs, unref, toggledevtools, readdir, mountpoints, estart, showhidden, extname, prepend, mkdir
        //spell-checker:ignore keypress, haspopup, labelledby, tabindex, tablist, tabpanel
        const { MailStatus, MailAction, MailFolders, MailReadFormat } = require('./js/types');
        const { ipcRenderer, shell, clipboard } = require('electron');
        const remote = require('@electron/remote');
        const { Menu, MenuItem } = remote;
        const { parseTemplate, existsSync } = require('./js/library');
        const { Settings } = require('./js/settings');
        const { Display } = require('./js/display');
        const { Mail } = require('./js/mail');
        const { Menubar } = require('./js/menubar');
        const fs = require('fs-extra');
        const child_process = require('child_process');
        const path = require('path');
        const moment = require('moment');

        var options;
        var logView;
        var display;
        var messageTable;
        var _updating;
        var dragging = false, btmDragging = false;
        var mail;
        var _checking;
        var _currentFolder = MailFolders.inbox;
        var _currentLetter;
        var _messageLoading;

        var menubar = new Menubar([
            {
                label: '&File',
                id: 'file',
                submenu: [
                    {
                        label: 'C&ompose',
                        accelerator: 'CmdOrCtrl+N',
                        enabled: true,
                        //click: download
                    },
                    { type: 'separator' },
                    {
                        label: '&Get new mail',
                        accelerator: 'CmdOrCtrl+S',
                        enabled: true,
                        click: checkMail
                    },
                    {
                        label: '&Sync to mud',
                        accelerator: 'CmdOrCtrl+S',
                        enabled: true,
                        //click: download
                    },
                    { type: 'separator' },
                    {
                        label: '&Preferences...',
                        accelerator: 'CmdOrCtrl+Comma',
                        click: () => {
                            window.open('mail.prefs.html', 'modal', 'backgroundColor=#fff,height=300,width=600,icon=' + path.join(__dirname, '../assets/icons/png/preferences.png'));
                        }
                    },
                    { type: 'separator' },
                    {
                        label: '&Close',
                        click: () => { window.close(); }
                    }
                ]
            },
            {
                label: '&Mail',
                submenu: [
                    {
                        label: 'Reply',
                        //accelerator: "CmdOrCtrl+N",
                        enabled: true,
                        //click: download
                    },
                    {
                        label: '&Reply all',
                        //accelerator: "CmdOrCtrl+S",
                        enabled: true,
                        //click: download
                    },
                    {
                        label: '&Forward',
                        //accelerator: "CmdOrCtrl+S",
                        enabled: true,
                        //click: download
                    },
                    { type: 'separator' },
                    {
                        label: '&Mark as Read',
                        //accelerator: "CmdOrCtrl+S",
                        enabled: true,
                        //click: download
                    },
                    {
                        label: 'Mark as &Unread',
                        //accelerator: "CmdOrCtrl+S",
                        enabled: true,
                        //click: download
                    },
                ]
            },
            {
                label: '&Edit',
                submenu: [
                    {
                        label: '&Refresh list',
                        accelerator: 'F5',
                        click: () => {

                        }
                    },
                    {
                        label: '&Refresh view',
                        accelerator: 'CmdOrCtrl+F5',
                        click: () => {

                        }
                    },

                    {
                        label: '&Refresh all',
                        accelerator: 'CmdOrCtrl+Shift+F5',
                        click: () => {

                        }
                    },
                    { type: 'separator' },
                    {
                        label: 'Cu&t',
                        accelerator: 'CmdOrCtrl+X',
                        click: () => {

                        }
                    },
                    {
                        label: '&Copy',
                        accelerator: 'CmdOrCtrl+C',
                        click: () => {

                        }
                    },
                    {
                        label: '&Paste',
                        accelerator: 'CmdOrCtrl+V',
                        click: () => {

                        }
                    },
                    {
                        label: '&Delete',
                        accelerator: 'Delete',
                        click: () => {

                        }
                    },
                    { type: 'separator' },
                    {
                        label: '&Select all',
                        click: () => {

                        }
                    },
                    { type: 'separator' },
                    {
                        label: '&Find',
                        click: () => {

                        }
                    },
                    { type: 'separator' },
                    {
                        label: '&Clear log',
                        click: () => {
                            logView.html('');
                        }
                    }
                ]
            },
            {
                label: '&View',
                submenu: [
                    {
                        label: '&Inbox',
                        type: 'checkbox',
                        checked: true,
                        accelerator: 'CmdOrCtrl+Shift+S',
                        click: () => { }
                    },

                    {
                        label: '&Drafts',
                        type: 'checkbox',
                        accelerator: 'CmdOrCtrl+Shift+S',
                        click: () => { }
                    },

                    {
                        label: '&Sent',
                        type: 'checkbox',
                        accelerator: 'CmdOrCtrl+Shift+S',
                        click: () => { }
                    },

                    {
                        label: '&Trash',
                        type: 'checkbox',
                        accelerator: 'CmdOrCtrl+Shift+S',
                        click: () => { }
                    },


                    { type: 'separator' },
                    {
                        label: '&Headers',
                        checked: true,
                        type: 'checkbox',
                        accelerator: 'CmdOrCtrl+Shift+S',
                        click: () => { headers(!options.showHeaders); }
                    },
                    { type: 'separator' },
                    {
                        label: '&Raw',
                        type: 'checkbox',
                        accelerator: 'CmdOrCtrl+Q',
                        click: () => { }
                    },
                    {
                        label: '&Formated',
                        type: 'checkbox',
                        checked: true,
                        accelerator: 'CmdOrCtrl+Shift+S',
                        click: () => { }
                    },
                    { type: 'separator' },
                    {
                        label: '&Toggle Developer Tools',
                        click: () => {
                            ipcRenderer.invoke('window', 'toggleDevtools');
                        }
                    },
                    {
                        type: 'separator'
                    },
                    {
                        role: 'resetZoom'
                    },
                    {
                        role: 'zoomIn'
                    },
                    {
                        role: 'zoomOut'
                    },
                ]
            },
        ]);

        (function () {
            /*
                     * Natural Sort algorithm for Javascript - Version 0.7 - Released under MIT license
                     * Author: Jim Palmer (based on chunking idea from Dave Koelle)
                     * Contributors: Mike Grier (mgrier.com), Clint Priest, Kyle Adams, guillermo
                     * See: http://js-naturalsort.googlecode.com/svn/trunk/naturalSort.js
                     */
            function naturalSort(a, b, html) {
                var re = /(^-?[0-9]+(\.?[0-9]*)[df]?e?[0-9]?%?$|^0x[0-9a-f]+$|[0-9]+)/gi,
                    sre = /(^[ ]*|[ ]*$)/g,
                    dre = /(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[/-]\d{1,4}[/-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,
                    hre = /^0x[0-9a-f]+$/i,
                    ore = /^0/,
                    htmre = /(<([^>]+)>)/ig,
                    // convert all to strings and trim()
                    x = a.toString().replace(sre, '') || '',
                    y = b.toString().replace(sre, '') || '';
                // remove html from strings if desired
                if (!html) {
                    x = x.replace(htmre, '');
                    y = y.replace(htmre, '');
                }
                // chunk/tokenize
                var xN = x.replace(re, '\0$1\0').replace(/\0$/, '').replace(/^\0/, '').split('\0'),
                    yN = y.replace(re, '\0$1\0').replace(/\0$/, '').replace(/^\0/, '').split('\0'),
                    // numeric, hex or date detection
                    xD = parseInt(x.match(hre), 10) || (xN.length !== 1 && x.match(dre) && Date.parse(x)),
                    yD = parseInt(y.match(hre), 10) || xD && y.match(dre) && Date.parse(y) || null;

                // first try and sort Hex codes or Dates
                if (yD) {
                    if (xD < yD) {
                        return -1;
                    }
                    else if (xD > yD) {
                        return 1;
                    }
                }

                // natural sorting through split numeric strings and default strings
                for (var cLoc = 0, numS = Math.max(xN.length, yN.length); cLoc < numS; cLoc++) {
                    // find floats not starting with '0', string or 0 if not defined (Clint Priest)
                    var oFxNcL = !(xN[cLoc] || '').match(ore) && parseFloat(xN[cLoc], 10) || xN[cLoc] || 0;
                    var oFyNcL = !(yN[cLoc] || '').match(ore) && parseFloat(yN[cLoc], 10) || yN[cLoc] || 0;
                    // handle numeric vs string comparison - number < string - (Kyle Adams)
                    if (isNaN(oFxNcL) !== isNaN(oFyNcL)) {
                        return (isNaN(oFxNcL)) ? 1 : -1;
                    }
                    // rely on string comparison if different types - i.e. '02' < 2 != '02' < '2'
                    else if (typeof oFxNcL !== typeof oFyNcL) {
                        oFxNcL += '';
                        oFyNcL += '';
                    }
                    if (typeof oFxNcL === 'string') {
                        oFxNcL = oFxNcL.toLowerCase();
                        oFyNcL = oFyNcL.toLowerCase();
                    }
                    if (oFxNcL < oFyNcL) {
                        return -1;
                    }
                    if (oFxNcL > oFyNcL) {
                        return 1;
                    }
                }
                return 0;
            }

            jQuery.extend(jQuery.fn.dataTableExt.oSort, {
                'moment-asc': function (a, b) {
                    if (moment(a).isBefore(b))
                        return -1;
                    if (moment(b).isBefore(a))
                        return 1;
                    return 0;
                },

                'moment-desc': function (a, b) {
                    if (moment(a).isBefore(b))
                        return 1;
                    if (moment(b).isBefore(a))
                        return -1;
                    return 0;
                },

            });

            jQuery.fn.dataTable.ext.type.order['file-size-pre'] = function (data) {
                var matches = data.match(/^(\d+(?:\.\d+)?)\s*([a-z]+)/i);
                var multipliers;

                if (process.platform === 'darwin')
                    multipliers = {
                        b: 1,
                        bytes: 1,
                        kb: 1000,
                        kib: 1024,
                        mb: 1000000,
                        mib: 1048576,
                        gb: 1000000000,
                        gib: 1073741824,
                        tb: 1000000000000,
                        tib: 1099511627776,
                        pb: 1000000000000000,
                        pib: 1125899906842624
                    };
                else
                    multipliers = {
                        b: 1,
                        bytes: 1,
                        kb: 1024,
                        kib: 1024,
                        mb: 1048576,
                        mib: 1048576,
                        gb: 1073741824,
                        gib: 1073741824,
                        tb: 1099511627776,
                        tib: 1099511627776,
                        pb: 1125899906842624,
                        pib: 1125899906842624
                    };

                if (matches) {
                    var multiplier = multipliers[matches[2].toLowerCase()];
                    return parseFloat(matches[1]) * multiplier;
                } else {
                    return -1;
                }
            };
        }());

        function loadOptions(data) {
            if (!data) {
                var set = Settings.load(ipcRenderer.sendSync('get-global', 'settingsFile'));
                options = set.extensions['mail'];
            }
            else
                options = data;
            if (!options) {
                options = {
                    'debug': false,
                    'logErrors': false,
                    'showErrorsExtended': false,
                    'folderSize': 202,
                    'viewSize': 250,
                    'showHeaders': true,
                    'showRaw': false,
                    'viewFont': '\'Courier New\', Courier, monospace',
                    'viewFontSize': '1em',
                    'lastCheck': 0,
                    'checkPeriod': 172800,
                    'format': MailReadFormat.ansi,
                    'markReadDelay': 2000,
                    'saveSent': true
                };
                saveOptions();
            }
            if (options.folderSize < 202)
                options.folderSize = 202;
            if (options.viewSize < 202)
                options.viewSize = 202;
            //min of 15 mins as don't want to check to fast, defaults to 48 hrs
            //if (options.checkPeriod < 900)
            //options.checkPeriod = 900;
            $('#folders').css('width', options.folderSize);
            $('#messages').css('left', options.folderSize);
            $('#bottom').css('height', options.viewSize);
            $('#bottom-loading').css('line-height', options.viewSize + 'px');

            $('#main').css('bottom', options.viewSize + 26);
            headers(options.showHeaders, true);
            display.updateFont(options.viewFont, options.viewFontSize);
            if (!options.lastCheck)
                checkMail();
            //if (options.checkPeriod > 0)
            //setInterval(() => { mail.getMail(); }, options.checkPeriod);
            doUpdate(2);
        }

        function saveOptions() {
            ipcRenderer.send('setting-changed', { type: 'extensions', name: 'mail', value: options });
        }

        function logMessage(msg) {
            if (!msg) return;
            logView.html(logView.html() + msg.toString() + '<br>');
        }

        function logError(error) {
            if (!error) return;
            var msg;
            if (error.stack && options.showErrorsExtended)
                msg = error.stack;
            else if (error instanceof TypeError)
                msg = error.name + ': ' + error.message;
            else if (error instanceof Error)
                msg = error.name + ': ' + error.message;
            else if (error.message)
                msg = error.message;
            else
                msg = error;
            if (options.debug)
                console.error(error);
            if (options.logErrors) {
                if (error.stack && !options.showErrorsExtended)
                    msg = error.stack;
                fs.writeFileSync(parseTemplate(path.join('{data}', 'jimud.error.log')), 'Immortal Tools: ' + new Date().toLocaleString() + '\n', { flag: 'a' });
                fs.writeFileSync(parseTemplate(path.join('{data}', 'jimud.error.log')), msg + '\n', { flag: 'a' });
            }
        }

        $(document).ready(() => {
            var file = ipcRenderer.sendSync('get-global', 'character');
            if (!file || file.length === 0)
                file = parseTemplate(path.join('{data}', 'mail.sqlite'));
            else
                file = parseTemplate(path.join('{characters}', file + '.mail'));
            mail = new Mail(file);
            mail.on('got-mail', (timeStamp, letters) => {
                if (options.debug)
                    console.log(letters);
                options.lastCheck = timeStamp;
                saveOptions();
                setTimeout(() => {
                    updateMessages(_currentFolder);
                    updateFolderBadges();
                }, 1000);
            });
            mail.on('mark-changed', (id) => {
                mail.getLetter(id, (letter) => {
                    var row = messageTable.row(function (idx, data) {
                        return data.id === id ? true : false;
                    });
                    if (row && row.length === 1) {
                        row.data(letter);
                        doUpdate(2);
                    }
                });
                updateFolderBadges();
                doUpdate(2);
            });
            mail.on('new', checkMail);
            mail.on('error', (err) => {
                logError(err);
            });
            mail.on('initialize', () => {
                if (!options.lastCheck)
                    checkMail();
            });

            $('#messages-list').DataTable({
                keys: true,
                paging: false,
                select: {
                    style: 'os'
                },
                searching: false,
                info: false,
                scrollY: 300,
                scrollX: 300,
                fixedHeader: {
                    header: true,
                    footer: false
                },
                scrollResize: true,
                language: { zeroRecords: '', emptyTable: '' },
                autoWidth: false,
                order: [[3, 'desc']],
                columnDefs: [
                    {
                        targets: 0,
                        render: function (data) {
                            return `<input type="checkbox" value="${data}"/>`;
                        },
                        'orderable': false
                    },
                    {
                        targets: 1,
                        render: function (data, type, full) {
                            if (!full.read)
                                return `<span class="mail_new">${data}</span>`;
                            return data;
                        }
                    },
                    {
                        type: 'moment',
                        targets: 3,
                        orderData: [3, 1, 0],
                        render: function (data) {
                            return new moment(data * 1000).format('MM/DD/YYYY hh:mm:ss A');
                        }
                    },
                    {
                        targets: 4,
                        visible: false
                    }
                ],
                columns: [
                    { data: 'id', width: '20px' },
                    { data: 'from', width: '200px' },
                    { data: 'subject' },
                    { data: 'date', width: '200px' },
                    { data: 'read' },
                ]
            });
            messageTable = $('#messages-list').DataTable();

            messageTable.on('user-select', function (e, dt, type, cell) {
                if ($(cell.node()).parent().hasClass('selected') && dt.rows('.selected').data().length === 1) {
                    e.preventDefault();
                }
            });

            messageTable.on('select', function (e, dt, type) {
                if (type === 'row')
                    doUpdate(4);
            });

            messageTable.on('deselect', function (e, dt, type) {
                if (type === 'row')
                    doUpdate(4);
            });

            $('#messages-list tbody').on('contextmenu', 'tr', function () {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;
                if (!$(this).hasClass('selected')) {
                    messageTable.rows().deselect();
                    messageTable.row(this).select();
                }
                //showLocalContextMenu();
            });

            $('#messages-list-container').on('contextmenu', function () {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;
                //showLocalContextMenu();
            });

            $('#messages-list tbody').on('click', 'tr', function () {
                if (!$(this).hasClass('selected')) {
                    messageTable.rows().deselect();
                    messageTable.row(this).select();
                }
                var selected = messageTable.rows({ selected: true }).data();
                if (selected.length > 0 && _currentLetter !== selected[0].id)
                    displayLetter(selected[0].id);

            });

            $('#messages-list tbody').on('dblclick', 'tr', function () {
                /*
                var data = localTable.row(this).data();
                if(!data) return;
                if (data.size === -2) {
                    if (options.syncFolders) {
                        if (_remote[data.name] && path.basename(options.remote) === path.basename(options.local))
                            _ied.getDir(options.remote + "/" + data.name, true);
                    }
                    updateLocal(data.path);
                }
                else
                    _ied.upload(data.path);
                    */
            });

            $('#messages-list').on('focus', () => {
                $('#messages-list').addClass('focused');
                doUpdate(4);
            });

            $('#drag-bar').mousedown(function (e) {
                e.preventDefault();
                dragging = true;
                var main = $('#messages');
                var ghostBar = $('<div>',
                    {
                        id: 'ghost-bar',
                        css: {
                            height: main.outerHeight(),
                            top: main.offset().top,
                            left: main.offset().left - 3
                        }
                    }).appendTo('body');

                $(document).mousemove(function (e) {
                    if (e.pageX < 199)
                        ghostBar.css('left', 199);
                    else if (e.pageX > document.body.clientWidth - 300)
                        ghostBar.css('left', document.body.clientWidth - 300);
                    else
                        ghostBar.css('left', e.pageX);
                });
            });

            $('#btm-drag-bar').mousedown(function (e) {
                e.preventDefault();
                btmDragging = true;
                var main = $('#bottom');
                var ghostBar = $('<div>',
                    {
                        id: 'btm-ghost-bar',
                        css: {
                            width: main.outerWidth(),
                            top: main.offset().top,
                            left: main.offset().left
                        }
                    }).appendTo('body');

                $(document).mousemove(function (e) {
                    if (e.pageY < 199)
                        ghostBar.css('top', 199);
                    else if (e.pageY > document.body.clientHeight - 200)
                        ghostBar.css('top', document.body.clientHeight - 200);
                    else
                        ghostBar.css('top', e.pageY);
                });
            });

            $(window).on('resize', () => {
                if ($('#messages').outerWidth() < 300 && $('#folders').outerWidth() > 202) {
                    $('#folders').css('width', document.body.clientWidth - 300);
                    $('#messages').css('left', document.body.clientWidth - 300);
                    options.folderSize = document.body.clientWidth - 300;
                    saveOptions();
                }

                if ($('#bottom').outerHeight() < 200 && $('#main').outerHeight() > 202) {
                    options.viewSize = 200;
                    $('#bottom').css('height', options.viewSize);
                    $('#bottom-loading').css('line-height', options.viewSize + 'px');
                    $('#main').css('bottom', options.viewSize + 26);
                    saveOptions();
                }

                /*
                var h = $("#main").outerHeight() - 40;
                if (options.showQueue)
                    h += $("#bottom").outerHeight();
                */
                doUpdate(2);
            });

            $(document).mouseup(function (e) {
                if (dragging) {
                    if (e.pageX < 200) {
                        $('#folders').css('width', 202);
                        $('#messages').css('left', 202);
                        options.folderSize = 202;
                    }
                    else if (e.pageX > document.body.clientWidth - 300) {
                        $('#folders').css('width', document.body.clientWidth - 300);
                        $('#messages').css('left', document.body.clientWidth - 300);
                        options.folderSize = document.body.clientWidth - 300;
                    }
                    else {
                        $('#folders').css('width', e.pageX + 2);
                        $('#messages').css('left', e.pageX + 2);
                        options.folderSize = e.pageX + 2;
                    }
                    doUpdate(2);
                    saveOptions();
                    $('#ghost-bar').remove();
                    $(document).unbind('mousemove');
                    dragging = false;
                }
                else if (btmDragging) {
                    if (e.pageY < 226)
                        options.viewSize = document.body.clientHeight - 202;
                    else if (e.pageY > document.body.clientHeight - 200)
                        options.viewSize = 200;
                    else
                        options.viewSize = document.body.clientHeight - e.pageY + 2;
                    options.viewSize -= 26;
                    $('#bottom').css('height', options.viewSize);
                    $('#bottom-loading').css('line-height', options.viewSize + 'px');
                    $('#main').css('bottom', options.viewSize + 26);
                    doUpdate(2);
                    saveOptions();
                    $('#btm-ghost-bar').remove();
                    $(document).unbind('mousemove');
                    btmDragging = false;
                }
            });
            display = new Display($('#display'));
            display.scrollToEnd = false;
            display.maxLines = -1;
            loadOptions();
            $(document).keydown((event) => {
                switch (event.which) {
                    case 116: //f5
                        if (!event.altKey && !event.ctrlKey && !event.shiftKey && !event.metaKey) {
                            if ($('#messages-list').hasClass('focused'))
                                updateMessages();
                            event.preventDefault();
                        }
                        break;
                    case 46://delete
                        if (!event.altKey && !event.ctrlKey && !event.shiftKey && !event.metaKey) {
                            //if ($("#messages-list").hasClass("focused"))
                            //deleteLocal();
                            event.preventDefault();
                        }
                        break;
                    case 65://select all, hack as menu accelerator doesn't work
                        if (!event.altKey && event.ctrlKey && !event.shiftKey && !event.metaKey) {
                            //if ($("#messages-list").hasClass("focused"))
                            //messageTable.rows().select();
                            event.preventDefault();
                        }
                        break;
                }
            });
            updateMessages();
            updateFolderBadges();
            $(window).trigger('resize');
        });

        function checkMail() {
            if (_checking)
                return;
            _checking = setTimeout(() => {
                mail.getMail(options.lastCheck); _checking = 0;
            }, 1000);
        }

        function updateMessages(folder) {
            mail.getLetterList(folder || MailFolders.inbox, (letters) => {
                messageTable.rows().remove();
                messageTable.rows.add(letters);
                doUpdate(7);
            });
            $('#messages-list_wrapper .dataTables_scrollBody')[0].scrollTop = 0;
        }

        var _rTimeout = 0;
        function doUpdate(type) {
            if (!type) return;
            _updating |= type;
            if (_updating === 0)
                return;
            _rTimeout = window.requestAnimationFrame(() => {
                if ((this._updating & 1) === 1) {
                    //updateStatus();
                    _updating &= ~1;
                }
                if ((this._updating & 2) === 2) {
                    if (messageTable)
                        updateDraw(messageTable);
                    _updating &= ~2;
                }
                if ((this._updating & 4) === 4) {
                    //updateMenu();
                    _updating &= ~4;
                }
                if ((this._updating & 32) === 32) {
                    logView[0].scrollTop = logView[0].scrollHeight;
                    _updating &= ~32;
                }
                _rTimeout = 0;
                doUpdate(_updating);
            });
        }

        function updateDraw(table, what) {
            if (!table) return;
            if (!what) what = table;
            var body = $('.dataTables_scrollBody', table.table().container())[0];
            var st = body.scrollTop;
            what.draw();
            body.scrollTop = st;
        }

        function focusRow(row) {
            if (!row || row.length === 0) return;
            var top = row.node().offsetTop;
            var body = $('.dataTables_scrollBody', row.table().container())[0];
            var sTop = body.scrollTop;
            var sHeight = body.clientHeight;
            if (top < sTop || top + 31 >= sTop + sHeight)
                body.scrollTop = top;
        }
        ipcRenderer.on('load-default', () => {
            mail.file = parseTemplate(path.join('{data}', 'mail.sqlite'));
        });

        ipcRenderer.on('load-char', (event, char) => {
            var file = char;
            if (!file || file.length === 0)
                file = parseTemplate(path.join('{data}', 'mail.sqlite'));
            else
                file = parseTemplate(path.join('{characters}', file + '.mail'));
            mail.file = file;
        });

        ipcRenderer.on('GMCP-received', (event, data) => {
            if (options && options.debug)
                console.log(data);
            if (mail)
                mail.processGMCP(data.mod, data.obj);
        });

        ipcRenderer.on('reload-mail', () => {
            mail.reload(() => {
                updateMessages(_currentFolder);
                updateFolderBadges();
            });
        });

        ipcRenderer.on('reload-options', () => {
            loadOptions();
        });

        function switchFolder(folder) {
            $('#folder-' + _currentFolder).removeClass('active');
            _currentFolder = folder;
            updateMessages(folder);
            display.clear();
            $('#folder-' + _currentFolder).addClass('active');
            $('#bottom-loading').css('display', '');
            _currentLetter = 0;
        }

        function displayLetter(id) {
            _messageLoading = setTimeout(() => {
                $('#bottom-loading').css('display', 'block');
            }, 500);
            _currentLetter = id;
            display.clear();
            if (options.showHeaders)
                $('#view-body').css('top', '');
            mail.read(id, MailReadFormat.none, (letter) => {
                if (options.format !== MailReadFormat.none) return;
                displayLetterLoad(letter);
            });
            mail.read(id, MailReadFormat.ansi, (letter) => {
                if (options.format !== MailReadFormat.ansi) return;
                displayLetterLoad(letter);

            });
        }

        function displayLetterLoad(letter) {
            if (_messageLoading)
                clearTimeout(_messageLoading);
            _messageLoading = 0;
            $('#bottom-loading').css('display', 'none');
            if (!_currentLetter) return;
            if (!letter) {
                ipcRenderer.invoke('show-dialog', 'showMessageBox', {
                    type: 'error',
                    title: 'Letter not found',
                    message: 'Letter could not be found.'
                });
                return;
            }
            if (letter.id != _currentLetter)
                return;
            $('#from').html(letter.from);
            $('#cc').html(letter.cc.join(', '));
            if (letter.cc.length) {
                $('#ccs').css('display', 'block');
                if (options.showHeaders)
                    $('#view-body').css('top', '95px');
            }
            else {
                $('#ccs').css('display', 'none');
                if (options.showHeaders)
                    $('#view-body').css('top', '75px');
            }
            $('#date').html(new moment(letter.date * 1000).format('MM/DD/YYYY hh:mm:ss A'));
            $('#subject').html(letter.subject);
            display.append(letter.message);
            if (!letter.read)
                setTimeout(() => {
                    mail.mark(letter.id, 1, _currentFolder === MailFolders.inbox);
                }, options.markReadDelay || 2000);
        }

        function updateFolderBadges() {
            for (let f = 0; f < 4; f++)
                mail.newCount(f, (cnt) => {
                    $('#folder-' + f + ' .badge').text(cnt);
                    $('#folder-' + f + ' .badge').css('display', cnt ? 'block' : 'none');
                });
        }

        function headers(state, noSave) {
            options.showHeaders = state;
            if (!noSave)
                saveOptions();
            if (options.showHeaders) {
                $('#view-headers').css('display', '');
                if ($('#ccs').css('display') === 'block')
                    $('#view-body').css('top', '95px');
                else
                    $('#view-body').css('top', '');
            }
            else {
                $('#view-headers').css('display', 'none');
                $('#view-body').css('top', '12px');
            }
            menubar.updateItem('view|headers', { checked: options.showHeaders });
            if (options.showHeaders) {
                $('#btn-show-headers i').removeClass('fa-chevron-down');
                $('#btn-show-headers i').addClass('fa-chevron-up');
            }
            else {
                $('#btn-show-headers i').addClass('fa-chevron-down');
                $('#btn-show-headers i').removeClass('fa-chevron-up');
            }
            display.updateScrollbars();
        }

        window.onbeforeunload = function () {
            if (mail) mail.close();
        };

        // eslint-disable-next-line no-unused-vars
        function closeHidden() {
            ipcRenderer.invoke('window', 'hide');
        }
    </script>
</head>

<body>
    <div id="toolbar" class="btn-toolbar" role="toolbar">
        <div class="btn-group" role="group">
            <button id="btn-get" type="button" class="btn btn-default btn-xs" title="Get new mail" onclick="checkMail()">
                <i class="fa fa-envelope-open"></i>
            </button>
            <button id="btn-sync" type="button" class="btn btn-default btn-xs" title="Sync to mud" onclick="">
                <i class="fa fa-exchange"></i>
            </button>
        </div>
        <button id="btn-compose" type="button" class="btn btn-default btn-xs" title="Compose" onclick="">
            <i class="fa fa-pencil"></i>
        </button>
        <button id="btn-delete" disabled="disabled" type="button" class="btn btn-danger btn-xs" title="Pause" onclick="" data-toggle="button">
            <i class="fa fa-remove"></i>
        </button>

        <div class="btn-group" role="group" id="reply-controls">
            <button id="btn-pause" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Reply" onclick="" data-toggle="button">
                <i class="fa fa-reply"></i>
            </button>
            <button id="btn-stop" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Reply all" onclick="">
                <i class="fa fa-reply-all"></i>
            </button>
            <button id="btn-pause" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Forward" onclick="" data-toggle="button">
                <i class="fa fa-mail-forward"></i>
            </button>

        </div>
        <div class="input-group" style="float: right; width: 150px">
            <input type="text" id="search" class="input-xs form-control" />
            <span class="input-group-btn">
                <button class="btn btn-default btn-xs" type="button" id="btn-search">
                    <i class="fa fa-search "></i>
                </button>
        </div>
    </div>

    <div id="main">
        <div id="folders">
            <div class="panel panel-default">
                <div id="folder-container" class="list-group" style="padding:0px;top:0px;bottom:1px;left:1px;right:5px;position: absolute;">
                    <a id="folder-0" class="list-group-item active" href="javascript:void(0)" onclick="switchFolder(0)">
                        <span class="badge" style="display: none">0</span>
                        <i class="fa fa-inbox"></i> Inbox</a>
                    <a id="folder-1" class="list-group-item" href="javascript:void(0)" onclick="switchFolder(1)">
                        <span class="badge" style="display: none">0</span>
                        <i class="fa fa-edit"></i> Drafts</a>
                    <a id="folder-2" class="list-group-item" href="javascript:void(0)" onclick="switchFolder(2)">
                        <span class="badge" style="display: none">0</span>
                        <i class="fa fa-envelope-o"></i> Sent</a>
                    <a id="folder-3" class="list-group-item" href="javascript:void(0)" onclick="switchFolder(3)">
                        <span class="badge" style="display: none">0</span>
                        <i class="fa fa-trash"></i> Trash</a>
                </div>
            </div>
            <div id="drag-bar"></div>
        </div>
        <div id="messages">
            <div class="panel panel-default">
                <div id="messages-list-container" class="panel-body" style="padding:0px;top:0px;bottom:1px;left:1px;right:1px;position: absolute;">
                    <table tabindex="0" id="messages-list" draggable="true" class="table table-striped table-hover table-condensed" style="width: 100%;height: 100%;padding:0px;margin:0px !important;">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" />
                                </th>
                                <th>From</th>
                                <th>Subject</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="bottom">
        <div id="btm-drag-bar"></div>
        <div class="panel panel-default" style="margin-bottom:0px;padding:0px;top:5px;bottom:0px;left:0px;right:0px;position: absolute;">
            <div id="view-headers" class="panel-heading">
                <div>From:
                    <span id="from"></span>
                </div>
                <div id="ccs" style="display: none">CC:
                    <span id="cc"></span>
                </div>
                <div>Date:
                    <span id="date"></span>
                </div>
                <div>Subject:
                    <span id="subject"></span>
                </div>
            </div>
            <div id="view-show-headers" class="panel-heading">
                <button id="btn-show-headers" class="btn btn-default btn-xs btn-adv" onclick="headers(!options.showHeaders);">
                    <i style="font-size: 8px;" class="fa fa-chevron-up"></i>
                </button>
            </div>
            <div id="view-body" class="panel-body">
                <div id="display"></div>
            </div>
        </div>
        <div id="bottom-loading">
            <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
        </div>
    </div>
    <div id="status" class="btn-toolbar" role="toolbar">
        <div id="messagesInfo" style="float:right;display:block;"></div>
    </div>
    <dialog id="Progress" style="z-index:1000;text-align:center">
        <div id="ProgressTitle"></div>
        <div id="Progressbar">
            <progress max="100"></progress>
        </div>
    </dialog>
</body>

</html>
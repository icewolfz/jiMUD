<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>Character manager</title>
    <link rel="shortcut icon" href="../assets/icons/png/32x32.png" />
    <link href="../lib/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-select.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/form.css" rel="stylesheet" type="text/css" />
    <link href="css/characters.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            -webkit-user-select: none;
            user-select: none;
        }
    </style>
    <script type="text/javascript">
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="../lib/jquery.min.js"></script>
    <script src="../lib/bootstrap.min.js"></script>
    <script src="../lib/bootstrap-select.min.js"></script>
    <script type="text/javascript">
        if (window.module) module = window.module;
        //spell-checker:ignore yazl askonload keypress rgbcolor cmdfont selectpicker commandon prepend tablist tabpanel hellip emoteto  ABCDEFGHIJKLMNOPQRSTUVWXYZ
        const { parseTemplate, templatePath, isFileSync, isDirSync, decrypt, encrypt, clone, walkSync } = require('./js/library');
        const Settings = require('./js/settings').Settings;
        const { shell, ipcRenderer } = require('electron');
        const path = require('path');
        const fs = require('fs');
        const crypto = require('crypto');
        var archiver, archive;

        var current = 0;
        var changed = 0;
        var askonloadCharacter = ipcRenderer.sendSync("get-setting", 'askonloadCharacter');

        $(window).keydown((event) => {
            if (document.getElementById('progress-dialog').open) {
                event.preventDefault();
                return false;
            }
            if (event.which === 27) {
                if ($('#get-name')[0].open)
                    $('#get-name')[0].close();
                else
                    window.close();
            }
        });
        $(window).on('unload', () => {
            saveCharacters();
        });

        $(document).ready(() => {
            if (process.platform === 'darwin')
                document.getElementById('btn-close').style.display = 'block';
            $('#characters-list').contextmenu((event) => {
                event.preventDefault();
                event.stopPropagation();
                event.cancelBubble = true;
                var c = [];
                var item = $(event.target).data('ID');
                c.push({ label: 'Add default', click: "add()" });
                c.push({ label: 'Add empty', click: "addEmpty()" });
                if (item !== undefined) {
                    c.push({ type: 'separator' });
                    c.push({ label: 'Rename', click: `rename(${item})` });
                    c.push({ label: 'Copy', click: `copy(${item})` });
                    c.push({ label: 'Delete', click: `remove(${item})` });
                    c.push({ type: 'separator' });
                    c.push({ label: 'Load', click: `load(${item})` });
                }
                ipcRenderer.invoke('show-context', c);
            });
            loadCharacters();

            $('#btn-add-dropdown').click(function () {
                $(this).addClass('open');
                var pos = $(this).offset();
                var x = Math.floor(pos.left);
                var y = Math.floor(pos.top + $(this).outerHeight() + 2);
                const addMenu = [{
                    label: 'Add default', click: "clearButton('#btn-add-dropdown');add();"
                },
                {
                    label: 'Add empty', click: "clearButton('#btn-add-dropdown');addEmpty();"
                }];
                ipcRenderer.invoke('show-context', addMenu, { x: x, y: y });
            });

            $('#get-name-ok').click(function () {
                var p = $('#get-name-value').parent();
                if (invalidFile($('#get-name-value').val())) {
                    p.addClass('has-error');
                    p.addClass('has-feedback');
                    p.find('.form-error').html('<small class="aura-error"><span class=\'sr-only\'>Error:</span>Invalid name</small>');
                    $('#get-name-value').focus();
                    return;
                }
                if ($('#get-name').data('type') === 1 && $('#get-name-value').val().toLowerCase() === $('#get-name').data('name')) {
                    p.addClass('has-error');
                    p.addClass('has-feedback');
                    p.find('.form-error').html('<small class="aura-error"><span class=\'sr-only\'>Error:</span>Current name</small>');
                    $('#get-name-value').focus();
                    return;
                }

                $('#get-name').trigger('get-name-ok', [$('#get-name-value').val().toLowerCase(), $('#get-name').data('name')]);
                $('#get-name').off('get-name-ok');
                $('#get-name')[0].close();
            });

            $('#get-name-value').keypress(function (event) {
                if (event.which === 13)
                    $('#get-name-ok').click();
            });

            $('#character-editor input').on('input', e => {
                if ($(e.target).type === 'checkbox') {
                    if ($(e.target).data('field') === 'Port') {
                        if (current && $(e.target).data('field') && ((current[$(e.target).data('field')] === 1035) !== $(e.target).prop('checked')))
                            changed++;
                    }
                    else if (current && $(e.target).data('field') && current[$(e.target).data('field')] !== $(e.target).prop('checked'))
                        changed++;
                }
                else if (current && $(e.target).data('field') && current[$(e.target).data('field')] !== $(e.target).val())
                    changed++;
            }).on('change', e => {
                if ($(e.target).type === 'checkbox') {
                    if ($(e.target).data('field') === 'Port') {
                        if (current && $(e.target).data('field') && ((current[$(e.target).data('field')] === 1035) !== $(e.target).prop('checked')))
                            changed++;
                    }
                    else if (current && $(e.target).data('field') && current[$(e.target).data('field')] !== $(e.target).prop('checked'))
                        changed++;
                }
                else if (current && $(e.target).data('field') && current[$(e.target).data('field')] !== $(e.target).val())
                    changed++;
            });
            $('#character-editor textarea').on('input', e => {
                changed++;
            }).on('change', e => {
                changed++;
            });
        });

        function invalidFile(file) {
            if (process.platform.indexOf('win') === 0)
                return file.match(/[^0-9a-zA-Z^&'@{}[\],$=!#()%.+~_\s.-]/g) ? true : false;
            return file.match(/[/\0]/g) ? true : false;
        }

        function updateCurrent() {
            if (!current) return;
            changed = 0;
            var v = templatePath($('#settings').val());
            var changes = { ID: current.ID };
            if (v != current.Preferences) {
                changes.Preferences = v;
                changed++;
            }
            v = templatePath($('#map').val());
            if (v != current.Map) {
                changes.Map = v;
                changed++;
            }
            v = $('#name').val();
            if (v != current.Name) {
                changes.Name = v;
                changed++;
            }

            if ($('#auto-load').prop('checked') != current.AutoLoad) {
                changed++;
                changes.AutoLoad = $('#auto-load').prop('checked');
            }

            if ($('#dev').prop('checked') != current.Port == 1035) {
                changed++;
                changes.Port = $('#dev').prop('checked') ? 1035 : 1030;
            }

            if ($('#disconnect').prop('checked') != current.Disconnect) {
                changed++;
                changes.Disconnect = $('#disconnect').prop('checked');
            }

            v = $('#password').val() || '';
            if (v && v.length > 0) {
                var key, iv;
                if (current.Password) {
                    key = current.Password.split(':');
                    if (key.length === 3) {
                        iv = key[2];
                        key = key[1];
                    }
                    else {
                        key = crypto.randomBytes(16).toString('hex');
                        iv = crypto.randomBytes(16).toString('hex').slice(0, 16);
                    }
                }
                else {
                    key = crypto.randomBytes(16).toString('hex');
                    iv = crypto.randomBytes(16).toString('hex').slice(0, 16);
                }
                v = encrypt(v, key, iv) + ':' + key + ':' + iv;
            }

            if (v != current.Password) {
                changes.Password = v;
                changed++;
            }
            v = $('#notes-path').val() || '';
            if (current.Notes != v) {
                fs.renameSync(f, sf);
                changes.notes = v;
                const old = parseTemplate(current.Notes);
                const newNotes = parseTemplate(v);
                fs.writeFileSync(old, $('#notes').val());
                if (isFileSync(newNotes)) {
                    response = ipcRenderer.sendSync('show-dialog-sync', 'showMessageBox', {
                        type: 'warning',
                        title: 'File exists',
                        message: 'Notes file `' + newNotes + '` exist, replace?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                    });
                    if (response === 0) {
                        fs.renameSync(old, newNotes);
                    }
                }
                else
                    fs.renameSync(old, newNotes);
            }
            if (changed) {
                ipcRenderer.send('update-character', changes, window.opener.getId());
                window.opener.updateCharacter(current.ID);
                changed = 0;
            }
        }

        function saveCharacters() {
            updateCurrent();
            //fs.writeFileSync(charactersFile, JSON.stringify(characters));
            //ipcRenderer.send('reload-characters');
        }

        // eslint-disable-next-line no-unused-vars
        function refresh() {
            updateCurrent();
            loadCharacters();
        }

        function loadCharacters() {
            const characters = ipcRenderer.sendSync('get-characters', { sort: 'Name' });
            var list = $('#characters-list');
            list.empty();
            clearEditor();
            const cl = characters.length;
            for (let c = 0; c < cl; c++)
                createItem(characters[c], list);
        }

        function createItem(character, list) {
            if (!list) list = $('#characters-list');
            var item = $('<li></li>', {
                id: 'character-' + character.ID,
                class: 'list-group-item'
            }).text(character.Title);
            item.data('ID', character.ID);
            item.on('click', function () {
                const ID = parseInt($(this).data('ID'), 10);
                if (current && current.ID === ID) return;
                updateCurrent();
                $('.list-group-item').removeClass('selected');
                $(this).addClass('selected');
                current = ipcRenderer.sendSync('get-character', ID);
                if (!current) {
                    clearEditor();
                    return;
                }
                $('#btn-rename').prop('disabled', false);
                $('#btn-copy').prop('disabled', false);
                $('#btn-delete').prop('disabled', false);
                $('#btn-load').prop('disabled', false);
                $('#btn-load-connection').prop('disabled', false);
                $('#btn-load-window').prop('disabled', false);
                $('#btn-load-close').prop('disabled', false);
                $('#character-editor input').prop('disabled', false);
                $('#character-editor button').prop('disabled', false);
                $('#character-editor textarea').prop('disabled', false);
                $('#settings').val(current.Preferences);
                $('#notes-path').val(current.Notes);
                $('#map').val(current.Map);
                $('#name').val(current.Name);
                $('#auto-load').prop('checked', current.AutoLoad);
                $('#dev').prop('checked', current.Port == 1035);
                $('#disconnect').prop('checked', current.Disconnect);

                if (current.Password && current.Password.length > 0) {
                    var pass = current.Password.split(':');
                    $('#password').val(decrypt(pass[0], pass[1], pass[2]));
                }
                else
                    $('#password').val('');

                $('#title').text(current.Title);
                $('#character-id').text(current.ID);
                let notes = parseTemplate(current.Notes);
                if (isFileSync(notes))
                    $('#notes').val(fs.readFileSync(notes, 'utf-8'));
                else
                    $('#notes').val('');
                $('.nav-tabs a[href="#tab-general"]').tab('show');
                changed = 0;
            });
            item.on('dblclick', function () {
                $(this).click();
                if (load() === 0)
                    doClose();
            });
            list.append(item);
        }

        function clearButton(id) {
            $(id).removeClass('open');
            $(id).blur();
        }

        function clearEditor() {
            current = 0;
            $('#btn-rename').prop('disabled', true);
            $('#btn-copy').prop('disabled', true);
            $('#btn-delete').prop('disabled', true);
            $('#btn-load').prop('disabled', true);
            $('#btn-load-connection').prop('disabled', true);
            $('#btn-load-window').prop('disabled', true);
            $('#btn-load-close').prop('disabled', true);
            $('#character-editor input').prop('disabled', true);
            $('#character-editor input[type=text]').val('');
            $('#character-editor input[type=password]').val('');
            $('#character-editor input[type=checkbox]').prop('checked', false);
            $('#character-editor button').prop('disabled', true);
            $('#character-editor textarea').prop('disabled', true);
            $('#title').text('');
        }

        /*
        function validName(name) {
            if (!name || name.length === 0)
                return false;
            if (!name.match(/^[a-zA-Z0-9]+$/g))
                return false;
            return true;
        }
        */

        function sanitizeID(id) {
            return id.replace(/\s/g, '_');
        }

        function sortList() {
            var $list = $('#characters-list'),
                $listLI = $list.children('li');

            $listLI.sort(function (a, b) {
                var an = a.textContent,
                    bn = b.textContent;

                if (an > bn) {
                    return 1;
                }
                if (an < bn) {
                    return -1;
                }
                return 0;
            });
            $listLI.detach().appendTo($list);
        }

        // eslint-disable-next-line no-unused-vars
        function openFile(field, ext, callback) {
            ipcRenderer.invoke('show-dialog', 'showOpenDialog', {
                defaultPath: path.dirname(parseTemplate($(field).val())),
                filters: [
                    { name: ext[0].substr(0, 1).toUpperCase() + ext[0].substr(1) + ' (*.' + ext.join(', *.') + ')', extensions: ext },
                    { name: 'All files (*.*)', extensions: ['*'] },
                ],
                properties: ['promptToCreate']
            }).then(result => {
                if (result.filePaths === undefined || result.filePaths.length === 0) {
                    return;
                }
                $(field).val(templatePath(result.filePaths[0]));
                if (callback) callback();
            });
        }

        function add(name) {
            showGetName(name, function (event, name) {
                const nextID = ipcRenderer.sendSync('get-character-next-id');
                const character = {
                    Title: name.replace(/[^a-zA-Z0-9]+/g, ''),
                    Preferences: path.join('{characters}', nextID + '.json'),
                    Map: path.join('{characters}', nextID + '.Map'),
                    Notes: path.join('{characters}', nextID + '.notes')
                };
                var sf = parseTemplate(character.Preferences);
                var response, d;
                if (isFileSync(sf)) {
                    response = ipcRenderer.sendSync('show-dialog-sync', 'showMessageBox', {
                        type: 'warning',
                        title: 'File exists',
                        message: 'Setting file  `' + sf + '` exist, replace?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                    });
                    if (response === 0) {
                        d = Settings.load(ipcRenderer.sendSync('get-global', 'settingsFile'));
                        d.save(sf);
                    }
                }
                else {
                    d = Settings.load(ipcRenderer.sendSync('get-global', 'settingsFile'));
                    d.save(sf);
                }
                sf = parseTemplate(character.Map);
                if (isFileSync(sf)) {
                    response = ipcRenderer.sendSync('show-dialog-sync', 'showMessageBox', {
                        type: 'warning',
                        title: 'File exists',
                        message: 'Map file `' + sf + '` exist, replace?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                    });
                    if (response === 0) {
                        if (isFileSync(parseTemplate(path.join('{data}', 'map.sqlite'))))
                            copyFile(parseTemplate(path.join('{data}', 'map.sqlite')), sf);
                        else
                            fs.closeSync(fs.openSync(sf, 'w'));
                    }
                }
                else if (isFileSync(parseTemplate(path.join('{data}', 'map.sqlite'))))
                    copyFile(parseTemplate(path.join('{data}', 'map.sqlite')), sf);
                else
                    fs.closeSync(fs.openSync(sf, 'w'));
                character.ID = ipcRenderer.sendSync('add-character', character);
                createItem(character);
                saveCharacters();
                sortList();
            });
        }

        function addEmpty() {
            showGetName(function (event, name) {
                const nextID = ipcRenderer.sendSync('get-character-next-id');
                const character = {
                    Title: name.replace(/[^a-zA-Z0-9]+/g, ''),
                    Preferences: path.join('{characters}', nextID + '.json'),
                    Map: path.join('{characters}', nextID + '.Map'),
                    Notes: path.join('{characters}', nextID + '.notes')
                };
                var sf = parseTemplate(character.Preferences);
                var response, d;
                if (isFileSync(sf)) {
                    response = ipcRenderer.sendSync('show-dialog-sync', 'showMessageBox', {
                        type: 'warning',
                        title: 'File exists',
                        message: 'Setting file `' + sf + '` exist, replace?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                    });
                    if (response === 0) {
                        d = new Settings();
                        d.save(sf);
                    }
                }
                else {
                    d = new Settings();
                    d.save(sf);
                }
                sf = parseTemplate(character.Map);
                if (isFileSync(sf)) {
                    response = ipcRenderer.sendSync('show-dialog-sync', 'showMessageBox', {
                        type: 'warning',
                        title: 'File exists',
                        message: 'Map file `' + sf + '` exist, replace?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                    });
                    if (response === 0) {
                        fs.closeSync(fs.openSync(sf, 'w'));
                    }
                }
                else
                    fs.closeSync(fs.openSync(sf, 'w'));
                character.ID = ipcRenderer.sendSync('add-character', character);
                createItem(character);
                saveCharacters();
                sortList();
            });
        }

        function rename(ID) {
            var character;
            if (ID === undefined)
                character = current;
            else
                character = ipcRenderer.sendSync('get-character', ID);
            showGetName(character.Title, 0, 1, function (event, name, oldName) {
                changes = { ID: ID, Title, name };
                const nameId = parseInt(oldName, 10) === character.ID;
                //only replace if it matches the name.json format
                if (!nameId && character.Preferences === path.join(parseTemplate('{characters}'), oldName + '.json')) {
                    var f = path.join(parseTemplate('{characters}'), oldName + '.notes');
                    var sf = parseTemplate(path.join(parseTemplate('{characters}'), name + '.json'));
                    changes.Preferences = path.join('{characters}', name + '.json');
                    var response;
                    if (isFileSync(sf)) {
                        response = ipcRenderer.sendSync('show-dialog-sync', 'showMessageBox', {
                            type: 'warning',
                            title: 'File exists',
                            message: 'Setting file for ' + name + ' exist, replace?',
                            buttons: ['Yes', 'No'],
                            defaultId: 1,
                        });
                        if (response === 0)
                            fs.renameSync(f, sf);
                    }
                    else
                        fs.renameSync(f, sf);
                }
                if (!nameId && character.Notes === path.join(parseTemplate('{characters}'), oldName + '.notes')) {
                    f = path.join(parseTemplate('{characters}'), oldName + '.notes');
                    sf = path.join(parseTemplate('{characters}'), name + '.notes');
                    changes.Notes = path.join('{characters}', name + '.notes');
                    if (isFileSync(sf)) {
                        response = ipcRenderer.sendSync('show-dialog-sync', 'showMessageBox', {
                            type: 'warning',
                            title: 'File exists',
                            message: 'Notes file for ' + name + ' exist, replace?',
                            buttons: ['Yes', 'No'],
                            defaultId: 1,
                        });
                        if (response === 0) {
                            fs.renameSync(f, sf);
                        }
                    }
                    else
                        fs.renameSync(f, sf);
                }
                if (!nameId && character.Map === path.join(parseTemplate('{characters}'), oldName + '.map')) {
                    f = path.join(parseTemplate('{characters}'), oldName + '.map');
                    sf = path.join(parseTemplate('{characters}'), name + '.map');
                    changes.Map = path.join('{characters}', name + '.map');
                    if (isFileSync(sf)) {
                        response = ipcRenderer.sendSync('show-dialog-sync', 'showMessageBox', {
                            type: 'warning',
                            title: 'File exists',
                            message: 'Map file for ' + name + ' exist, replace?',
                            buttons: ['Yes', 'No'],
                            defaultId: 1,
                        });
                        if (response === 0) {
                            fs.renameSync(f, sf);
                        }
                    }
                    else
                        fs.renameSync(f, sf);
                }
                $('#character-' + character).text(character.Title);
                saveCharacters();
                sortList();
                ipcRenderer.send('update-character', changes, window.opener.getId());
                if (current && character.ID == current.ID) {
                    current = 0;
                    $('#character-' + character.ID).click();
                }
            });
        }

        function copyName(name) {
            var i = 0, n = name;
            var characters = ipcRenderer.sendSync('get-characters', { fields: ['Title'], filter: { 'Title': n } });
            while (characters.length) {
                if (i === 0)
                    n = name;
                else
                    n = name + i;
                i++;
                characters = ipcRenderer.sendSync('get-characters', { fields: ['Title'], filter: { 'Title': n } });
            }
            return n;
        }

        function copy(ID) {
            var character;
            if (ID === undefined)
                character = current;
            else
                character = ipcRenderer.sendSync('get-character', ID);
            showGetName(character.Title, copyName(character.Title), function (event, name, oldName) {
                const nextID = ipcRenderer.sendSync('get-character-next-id');
                var newCharacter = clone(character);
                delete newCharacter.ID;
                newCharacter.Title = name;
                newCharacter.Preferences = path.join('{characters}', nextID + '.json');
                newCharacter.Map = path.join('{characters}', nextID + '.Map');
                newCharacter.Notes = path.join('{characters}', nextID + '.notes');
                var f = parseTemplate(character.Preferences);
                var sf = parseTemplate(newCharacter.Preferences);
                var response;
                if (isFileSync(sf)) {
                    response = ipcRenderer.sendSync('show-dialog-sync', 'showMessageBox', {
                        type: 'warning',
                        title: 'File exists',
                        message: 'Setting file `' + sf + '` exist, replace?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                    });
                    if (response === 0)
                        copyFile(f, sf);
                }
                else if (isFileSync(f))
                    copyFile(f, sf);

                f = path.join(parseTemplate(character.Notes));
                sf = path.join(parseTemplate(newCharacter.Notes));
                if (isFileSync(sf)) {
                    response = ipcRenderer.sendSync('show-dialog-sync', 'showMessageBox', {
                        type: 'warning',
                        title: 'File exists',
                        message: 'Notes file `' + sf + '` exist, replace?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                    });
                    if (response === 0) {
                        copyFile(f, sf);
                    }
                }
                else if (isFileSync(f))
                    copyFile(f, sf);

                f = parseTemplate(character.Map);
                sf = parseTemplate(newCharacter.Map);
                if (isFileSync(sf)) {
                    response = ipcRenderer.sendSync('show-dialog-sync', 'showMessageBox', {
                        type: 'warning',
                        title: 'File exists',
                        message: 'Map file `' + sf + '` exist, replace?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                    });
                    if (response === 0) {
                        if (isFileSync(f))
                            copyFile(f, sf);
                        else
                            fs.closeSync(fs.openSync(sf, 'w'));
                    }
                }
                else if (isFileSync(f))
                    copyFile(f, sf);
                else
                    fs.closeSync(fs.openSync(sf, 'w'));
                newCharacter.ID = ipcRenderer.sendSync('add-character', newCharacter);
                createItem(newCharacter);
                sortList();
            });
        }

        function remove(ID) {
            var character;
            if (ID === undefined)
                character = current;
            else
                character = ipcRenderer.sendSync('get-character', ID);
            var response = ipcRenderer.sendSync('show-dialog-sync', 'showMessageBox', {
                type: 'warning',
                title: 'Remove character',
                message: 'Remove ' + character.Title + '?',
                buttons: ['Yes', 'No'],
                defaultId: 1,
            });

            if (response === 0) {
                var sf = parseTemplate(character.Preferences);
                if (isFileSync(sf))
                    ipcRenderer.send('trash-item', sf);
                sf = parseTemplate(character.Map);
                if (isFileSync(sf))
                    ipcRenderer.send('trash-item', sf);
                sf = parseTemplate(character.Notes);
                if (isFileSync(sf))
                    ipcRenderer.send('trash-item', sf);
                $('#character-' + character.ID).remove();
                if (current && current.ID === character.ID)
                    clearEditor();
                ipcRenderer.send('remove-character', character.ID)
                saveCharacters();
            }
        }

        function load(ID) {
            var character;
            if (ID === undefined) {
                ID = current.ID;
                character = current;
            }
            else
                character = ipcRenderer.sendSync('get-character', ID);
            if (!askonloadCharacter) {
                saveCharacters();
                window.opener.loadCharacter(ID);
                return;
            }
            var response = ipcRenderer.sendSync('show-dialog-sync', 'showMessageBox', {
                type: 'warning',
                title: 'Load character',
                message: 'Load ' + character.Title + '?',
                buttons: ['Yes', 'No', 'Never ask again'],
                defaultId: 1,
            });
            if (response === 2) {
                saveCharacters();
                window.opener.loadCharacter(ID);
                ipcRenderer.send('set-setting', 'askonloadCharacter', false);
                askonloadCharacter = false;
            }
            else if (response === 0) {
                saveCharacters();
                window.opener.loadCharacter(ID);
            }
            return response;
        }


        // eslint-disable-next-line no-unused-vars
        function loadDefault() {
            if (!askonloadCharacter) {
                saveCharacters();
                window.opener.resetCharacter();
                return;
            }
            var response = ipcRenderer.sendSync('show-dialog-sync', 'showMessageBox', {
                type: 'warning',
                title: 'Load global',
                message: 'Load global?',
                buttons: ['Yes', 'No', 'Never ask again'],
                defaultId: 1,
            });
            if (response === 2) {
                saveCharacters();
                window.opener.resetCharacter();
                ipcRenderer.sendSync("set-setting", 'askonloadCharacter', false);
                askonloadCharacter = false;
            }
            else if (response === 0) {
                saveCharacters();
                window.opener.resetCharacter();
            }
            return response;
        }

        function showGetName(name, val, type, callback) {
            if (typeof name === 'function') {
                callback = name;
                name = undefined;
            }
            else if (typeof val === 'function') {
                callback = val;
                val = undefined;
            }
            else if (typeof type === 'function') {
                callback = type;
                type = undefined;
            }

            var p = $('#get-name-value').parent();
            p.removeClass('has-error');
            p.removeClass('has-feedback');

            $('#get-name')[0].showModal();
            $('#get-name').off('get-name-ok');
            if (callback)
                $('#get-name').on('get-name-ok', callback);
            $('#get-name-value').val(val || '');
            $('#get-name').data('type', type);
            $('#get-name').data('name', name || current.Title);
        }

        function copyFile(src, dest) {
            let readStream = fs.createReadStream(src);
            readStream.once('error', (err) => {
                if (!err) return;
                console.error(err);
            });
            readStream.once('end', () => { });
            readStream.pipe(fs.createWriteStream(dest));
        }

        // eslint-disable-next-line no-unused-vars
        function backup() {
            var file = ipcRenderer.sendSync('show-dialog-sync', 'showSaveDialog', {
                title: 'Save as...',
                defaultPath: path.join(parseTemplate('{documents}'), 'jiMUD-characters-data.zip'),
                filters: [
                    { name: 'Zip files (*.zip)', extensions: ['zip'] },
                    { name: 'All files (*.*)', extensions: ['*'] },
                ]
            });
            if (file === undefined || file.length === 0)
                return;

            showProgressDialog();
            archiver = archiver || require('yazl');
            var data = parseTemplate('{data}');
            archive = new archiver.ZipFile();

            if (isFileSync(path.join(data, 'characters.json.bak')))
                archive.addFile(path.join(data, 'characters.json.bak'), 'characters.json.bak');
            if (isFileSync(path.join(data, 'characters.sqlite')))
                archive.addFile(path.join(data, 'characters.sqlite'), 'characters.sqlite');
            if (isFileSync(path.join(data, 'map.sqlite')))
                archive.addFile(path.join(data, 'map.sqlite'), 'map.sqlite');
            if (isFileSync(path.join(data, 'mail.sqlite')))
                archive.addFile(path.join(data, 'mail.sqlite'), 'mail.sqlite');
            if (isFileSync(path.join(data, 'settings.json')))
                archive.addFile(path.join(data, 'settings.json'), 'settings.json');
            if (isFileSync(path.join(data, 'windows.layout')))
                archive.addFile(path.join(data, 'windows.layout'), 'windows.layout');

            var files;
            if (isDirSync(path.join(data, 'profiles'))) {
                files = walkSync(path.join(data, 'profiles'));
                files.files.forEach(file => {
                    archive.addFile(file, file.substring(data.length + 1).replace(/\\/g, '/'));
                });
            }
            if (isDirSync(path.join(data, 'characters'))) {
                files = walkSync(path.join(data, 'characters'));
                files.files.forEach(file => {
                    archive.addFile(file, file.substring(data.length + 1).replace(/\\/g, '/'));
                });
            }

            archive.outputStream.pipe(fs.createWriteStream(file)).on('close', function () {
                closeProgressDialog();
            });
            archive.end(() => {
                closeProgressDialog();
            });
        }

        function showProgressDialog() {
            var progress = document.getElementById('progress-dialog');
            if (progress.open) return;
            setProgressDialogValue(0);
            progress.showModal();
        }

        function setProgressDialogValue(value) {
            window.opener.updateProgress({ value: value });
            window.setProgressBar(value);
            document.getElementById('progress-dialog-progressbar').value = value * 100;
        }

        function closeProgressDialog() {
            var progress = document.getElementById('progress-dialog');
            if (progress.open)
                progress.close();
            setProgressDialogValue(-1);
            document.getElementById('progress-dialog-progressbar').removeAttribute('value');
            archive = null;
        }

        // eslint-disable-next-line no-unused-vars
        function cancelProgress() {
            if (archive)
                archive.abort();
            closeProgressDialog();
        }

        function characterAdded(character) {
            if (!character) return;
            if (typeof character === 'number')
                character = ipcRenderer.sendSync('get-character', character);
            if ($('#character-' + character.ID).length === 1) return;
            createItem(character);
            sortList();
        }

        function characterUpdated(character) {
            if (!character) returnl
            if (typeof character === 'number')
                character = ipcRenderer.sendSync('get-character', character);
            //already created so bail
            if ($('#character-' + character.ID).length !== 1) {
                createItem(character);
                sortList();
            }
            else if (current && character.ID === current.ID) {
                if (changed > 0) {
                    ipcRenderer.invoke('show-dialog', 'showMessageBox', {
                        type: 'warning',
                        title: 'Character updated',
                        message: 'Reload? Any current changes will be lost.',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                    }).then((result) => {
                        if (result.response === 0) {
                            current = 0;
                            $('#character-' + character.ID).click();
                        }
                    });
                }
                else {
                    current = 0;
                    $('#character-' + character.ID).click();
                }
            }
        }


        function newConnection(ID) {
            if (ID === undefined)
                character = current;
            else
                character = ipcRenderer.sendSync('get-character', ID);
            saveCharacters();
            window.opener.send('new-client', null, { characterId: character.ID, settings: parseTemplate(character.Preferences), dev: character.Port == 1035 });
        }

        function newWindow(index) {
            if (ID === undefined)
                character = current;
            else
                character = ipcRenderer.sendSync('get-character', ID);
            saveCharacters();
            window.opener.send('new-window', null, { characterId: character.ID, settings: parseTemplate(character.Preferences), dev: character.Port == 1035 });
        }

        function doClose() {
            //TODO an option to close window after load
            //window.close();
        }

        function getSettings() {
            if (!current) return ipcRenderer.sendSync('get-global', 'settingsFile');
            return parseTemplate(current.Preferences);
        }

        var prefs;
        function openPreferences() {
            prefs = window.open('prefs.html', 'modal', 'width=800,height=460,backgroundColor=#fff,icon=' + path.join(__dirname, '../assets/icons/png/preferences.png'));
            prefs.addEventListener('load', () => {
                prefs.document.title = 'Preferences for ' + current.Title;
            });
        }

        window.addEventListener('beforeunload', e => {
            if (!closeable()) {
                e.returnValue = true;
                return 'no';
            }
        })

        let closeWindow = false;
        function closeable(all) {
            if (!closeWindow) {
                if (prefs && !prefs.closed) {
                    ipcRenderer.invoke('show-dialog', 'showMessageBox', {
                        type: 'error',
                        title: 'Preferences dialog open',
                        message: 'You must close the preferences dialog before you can close character manager.',
                        defaultId: 1
                    });
                    closeWindow = false;
                }
                else
                    closeWindow = true;
            }
            return closeWindow;
        }        
    </script>
    <style type="text/css">
        .form-control-feedback,
        .form-error {
            display: none;
        }

        .has-error .form-control-feedback {
            display: inline;
            top: 30px;
        }

        .has-error .form-error {
            display: block;
        }

        .aura-error,
        .form-error,
        .has-error a {
            color: #A94442;
        }
    </style>
</head>

<body>
    <div id="toolbar" class="btn-toolbar" role="toolbar">
        <div class="btn-group" role="group">
            <button id="btn-refresh" type="button" class="btn btn-default btn-xs" title="Refresh" onclick="refresh()">
                <i class="fa fa-refresh"></i>
            </button>
            <button id="btn-save" type="button" class="btn btn-default btn-xs" title="Backup to zip" onclick="backup()">
                <i class="fa fa-upload"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default btn-xs" title="Add" onclick="add()">
                <i class="fa fa-plus"></i>
            </button>
            <button id="btn-add-dropdown" type="button" class="btn btn-default btn-xs" title="Add">
                <span class="caret"></span>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-rename" type="button" class="btn btn-default btn-xs" disabled="disabled" title="Rename" onclick="rename()">
                <i class="fa fa-i-cursor"></i>
            </button>
            <button id="btn-copy" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Copy" onclick="copy()">
                <i class="fa fa-copy"></i>
            </button>
            <button id="btn-delete" type="button" disabled="disabled" class="btn btn-danger btn-xs" title="Delete" onclick="remove()">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-load-default" type="button" class="btn btn-warning btn-xs" title="Load global in current" onclick="if(loadDefault() === 0) doClose()">
                <i class="fa fa-step-backward"></i>
            </button>
            <button id="btn-load" type="button" disabled="disabled" class="btn btn-warning btn-xs" title="Load in current" onclick="if(load() === 0) doClose()">
                <i class="fa fa-play"></i>
            </button>
            <button id="btn-load-connection" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Add as new connection" onclick="newConnection()">
                <i class="fa fa-plus"></i>
            </button>
            <button id="btn-load-window" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Load in new window" onclick="newWindow()">
                <i class="fa fa-window-restore"></i>
            </button>
        </div>
        <button id="btn-close" type="button" class="btn btn-default btn-xs" style="display: none;float: right" title="Close" onclick="doClose()">
            <i class="fa fa-window-close"></i>
        </button>
    </div>
    <div id="main">
        <div id="characters-container" class="panel panel-default" style="position: absolute;left: 2px;top: 2px;bottom:2px;width:200px;margin:0;overflow: auto;">
            <ul id="characters-list" class="list-group">

            </ul>
        </div>
        <div id="content" class="panel panel-default" style="position: absolute;left:206px;right: 2px;top: 2px;bottom:2px;margin:0">
            <div class="panel-heading" style="position: relative;">
                Character:
                <span id="title"></span>
                <div style="position: absolute; right: 0;right: 15px;top: 10px;">
                    Unique ID:
                    <span id="character-id"></span>
                </div>
            </div>
            <div class="panel-body" id="character-editor" style="padding: 0px;">
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active">
                        <a href="#tab-general" role="tab" data-toggle="tab">General</a>
                    </li>
                    <li role="presentation">
                        <a href="#tab-notes" role="tab" data-toggle="tab">Notes</a>
                    </li>
                </ul>
                <div class="tab-content" style="position: absolute;bottom: 0;top: 42px;overflow: auto;left: 0;right: 0;">
                    <div role="tabpanel" class="container tab-pane fade in active" id="tab-general" style="width: 100%;">
                        <label class="control-label" style="width: 100%"> Login
                            <input disabled="disabled" class="form-control" style="width:100%" type="text" id="name" data-field="Title">
                            <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Name to login as if different from character name</span>
                        </label>
                        <label class="control-label" style="width: 100%"> Password
                            <input disabled="disabled" class="form-control" style="width:100%" type="password" id="password" data-field="Password">
                            <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Supply at own risk, the password is stored in basic encryption</span>
                        </label>
                        <label class="control-label"> Settings
                            <div class="input-group" style="width:100%;">
                                <input disabled="disabled" class="form-control" style="width:100%" type="text" id="settings" data-field="Preferences">
                                <span class="input-group-btn">
                                    <button disabled="disabled" class="btn btn-default" title="Edit character preferences" type="button" onclick="openPreferences()">
                                        <i class="fa fa-gears"></i>
                                    </button>
                                    <button disabled="disabled" class="btn btn-default" title="Browse for preference file" type="button" onclick="openFile('#settings', ['json'])">
                                        &hellip;
                                    </button>
                                </span>
                            </div>
                        </label>
                        <label class="control-label"> Map
                            <div class="input-group" style="width:100%;">
                                <input disabled="disabled" class="form-control" style="width:100%" type="text" id="map" data-field="Map">
                                <span class="input-group-btn">
                                    <button disabled="disabled" class="btn btn-default" title="Browse for map database file" type="button" onclick="openFile('#map', ['map', 'sqlite'])">
                                        &hellip;
                                    </button>
                                </span>
                            </div>
                        </label>
                        <label class="control-label"> Notes
                            <div class="input-group" style="width:100%;">
                                <input disabled="disabled" class="form-control" style="width:100%" type="text" id="notes-path" data-field="Notes">
                                <span class="input-group-btn">
                                    <button disabled="disabled" class="btn btn-default" type="button" title="Browse for notes file" onclick="openFile('#notes-path', ['notes', 'txt'])">
                                        &hellip;
                                    </button>
                                </span>
                            </div>
                        </label>
                        <label class="control-label col-sm-6" style="padding-left: 0;">
                            <input disabled="disabled" type="checkbox" id="auto-load" data-field="AutoLoad" /> Auto load
                            <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Only one character can auto load, enabling this will disable previous auto loaded character</span>
                        </label>
                        <label class="control-label col-sm-6" style="padding-left: 0;">
                            <input disabled="disabled" type="checkbox" id="dev" data-field="Port" /> Development
                            <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Connect to development port</span>
                        </label>
                        <label class="control-label col-sm-6" style="padding-left: 0;">
                            <input disabled="disabled" type="checkbox" id="disconnect" data-field="Disconnect" /> Disconnect on load
                            <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Disconnect current connection</span>
                        </label>
                    </div>
                    <div role="tabpanel" class="container tab-pane fade in" id="tab-notes" style="width: auto;">
                        <textarea id="notes" wrap="off" spellcheck="true" cols="20" rows="20" class="form-control" disabled="disabled"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <dialog id="get-name" style="z-index:1000;">
        <div class="form-group">
            <label class="control-label">
                <span id="get-name-title">New character name</span>
                <input class="form-control" style="width:100%" type="text" id="get-name-value">
                <span class="fa fa-remove form-control-feedback" aria-hidden="true"></span>
                <div class="form-error"></div>
            </label>
        </div>
        <div style="text-align:right">
            <button id="get-name-ok">
                Ok
            </button>
            <button onclick="$('#get-name')[0].close()">
                Cancel
            </button>
        </div>
    </dialog>
    <dialog id="progress-dialog" style="z-index:1000;text-align:center">
        <div id="progress-dialog-title">Saving&hellip;</div>
        <div>
            <progress max="100" id="progress-dialog-progressbar"></progress>
        </div>
    </dialog>
</body>

</html>
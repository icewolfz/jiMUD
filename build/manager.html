<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>jiMUD</title>
    <link href="css/main.css" rel="stylesheet" type="text/css" />
    <link href="../lib/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/theme.css" rel="stylesheet" type="text/css" />
    <link href="css/cm.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link id="theme" rel="stylesheet" href="themes/default.css" type="text/css" />
    <script type="text/javascript">
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="../lib/jquery.min.js"></script>
    <script src="../lib/bootstrap.min.js"></script>
    <script type="text/javascript">
        const { ipcRenderer } = require('electron');
        const { parseTemplate, isFileSync } = require('./js/library.js');
        const { TabStrip } = require('./js/tabstrip.js');
        const { DockManager } = require('./js/dockmanager.js');
        const _clients = [];
        var _load = [];
        var _id;
        var tabStrip;
        var _current = 0;
        var useDockPanel = false;
        var _loading = 0;

        function loadTheme(theme, force) {
            theme = parseTemplate(theme) + '.css';
            if (!isFileSync(theme))
                theme = parseTemplate(path.join('{themes}', 'default')) + '.css';
            var el = document.getElementById('theme');
            if (el.getAttribute('href') !== theme || force)
                el.setAttribute('href', theme);
        }

        $(document).ready(() => {
            if (useDockPanel)
                tabstrip = new DockManager();
            else
                tabstrip = new TabStrip();
            //tabstrip.hideTabstrip = false;
            tabstrip.useNativeMenus = true;
            tabstrip.on('tab-strip-hidden', () => {
                ipcRenderer.send('update-client', _current, 0);
            });
            tabstrip.on('tab-strip-shown', () => {
                ipcRenderer.send('update-client', _current, useDockPanel ? tabstrip.activePane.tabstripHeight : tabstrip.height);
            });
            tabstrip.on('add', e => {
                if (_loading) return;
                const tabs = useDockPanel ? tabstrip.panels : tabstrip.tabs;
                if (tabs.length === 2) {
                    //force a refresh as will not update while hidden
                    tabstrip.refresh();
                    //resize previous tab just to ensure all are same size
                    ipcRenderer.send('update-client', tabs[0].client, useDockPanel ? tabstrip.activePane.tabstripHeight : tabstrip.height);
                    ipcRenderer.send('update-client', _current, useDockPanel ? tabstrip.activePane.tabstripHeight : tabstrip.height);
                }
            });
            tabstrip.on('tab-click', e => {
                if (useDockPanel) {
                    ipcRenderer.send('switch-client', e.panel.client, tabstrip.activePane.tabstripHeight);
                    _current = e.panel.client;
                }
                else {
                    ipcRenderer.send('switch-client', e.tab.client, tabstrip.height);
                    _current = e.tab.client;
                }
            });
            tabstrip.on('remove', e => {
                ipcRenderer.send('remove-client', useDockPanel ? e.panel.client : e.tab.client);
                //cancel the remove as we want to make sure it is called after browser view is cleaned up as it may cancel based on user input
                e.cancel = true;
            });
            tabstrip.on('removed', panel => {
                if (tabstrip.hideTabstrip && (useDockPanel ? tabstrip.panels.length === 1 : tabstrip.tabs.length === 1)) {
                    ipcRenderer.send('update-client', _current, 0);
                }
            });
            tabstrip.on('activated', e => {
                if (_loading) return;
                console.log('tab activated');
                if (useDockPanel) {
                    ipcRenderer.send('switch-client', e.panel.client, tabstrip.activePane.tabstripHeight);
                    _current = e.panel.client;
                }
                else {
                    ipcRenderer.send('switch-client', e.tab.client, tabstrip.height);
                    _current = e.tab.client;
                }
                document.title = 'jiMUD - ' + e.tab.title.innerText;
            })
            tabstrip.on('tab-moved', e => {
                ipcRenderer.send('reorder-client', useDockPanel ? e.panel.client : e.tab.client, e.index, e.oldIndex);
            });
            tabstrip.on('tab-drag', e => {
                console.log('tab drag');
                console.log(e)
            });
            tabstrip.on('tab-drag-over', e => {
                console.log('tab over');
                console.log(e)
            });
            tabstrip.on('tab-drag-end', e => {
                console.log('tab end');
                console.log(e)
                //dropped outside of client area so new window if more then 1 tab
                if (e.event.dataTransfer.dropEffect !== 'move' && (e.event.clientX < 0 || e.event.clientY < 0 || e.event.clientX >= document.body.clientHeight || e.event.clientY >= document.body.clientWidth)) {
                    e.event.stopPropagation();
                    e.event.preventDefault();
                    var x = e.screenX;
                    var y = e.screenY;
                    var bounds = e.tab.tab.getBoundingClientRect();
                    x -= Math.ceil(bounds.left + (window.outerWidth - document.body.offsetWidth));
                    y -= Math.ceil(bounds.top + (window.outerHeight - document.body.offsetHeight));
                    ipcRenderer.send('dock-client', useDockPanel ? tabstrip.dragPanel.client : tabstrip.dragTab.client, { x: x, y: y });
                    //ipcRenderer.send('dock-client', tabstrip.dragTab.client, { x: e.event.screenX - e.event.clientX, y: e.event.screenY - e.event.clientY });
                }
            });
            tabstrip.on('tab-drag-leave', e => {
                console.log('tab leave');
                console.log(e)
            });
            tabstrip.on('tab-drop', e => {
                console.log('tab drop');
                console.log(e)
                //if not dragging its from a different window so its a undock/dock
                if (e.tab === tabstrip.dragTab) {
                    e.event.preventDefault();
                    e.event.stopPropagation();
                }
                if (!tabstrip.dragPanel && !tabstrip.dragTab) {
                    e.preventDefault = true;
                    e.event.stopPropagation();
                    e.event.preventDefault();
                    console.log(e.event.dataTransfer.getData('jimud/tab'));
                    const tab = JSON.parse(e.event.dataTransfer.getData('jimud/tab'));
                    e.tab.tab.classList.remove('drop');
                    ipcRenderer.send('dock-client', tab.client, { index: tabstrip.getTabIndex(e.tab) });
                }
            });

            window.addEventListener('dragstart', (e) => {
                if (e.dataTransfer.types && e.dataTransfer.types.indexOf('jimud/tab') !== -1) {
                    e.dataTransfer.dropEffect = 'move';
                    console.log('Window start');
                    console.log(e)
                }
            });
            window.addEventListener('dragleave', (e) => {
                if (e.dataTransfer.types && e.dataTransfer.types.indexOf('jimud/tab') !== -1) {
                    e.dataTransfer.dropEffect = 'move';
                    console.log('Window leave');
                    console.log(e)
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
            window.addEventListener('dragover', (e) => {
                if (e.dataTransfer.types && e.dataTransfer.types.indexOf('jimud/tab') !== -1) {
                    e.dataTransfer.dropEffect = 'move';
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Window over');
                    console.log(e)
                }
            });
            window.addEventListener('dragenter', (e) => {
                if (e.dataTransfer.types && e.dataTransfer.types.indexOf('jimud/tab') !== -1) {
                    e.dataTransfer.dropEffect = 'move';
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Window eneter');
                    console.log(e)
                }
            });
            window.addEventListener('dragend', (e) => {
                if (e.dataTransfer.types && e.dataTransfer.types.indexOf('jimud/tab') !== -1) {
                    e.dataTransfer.dropEffect = 'move';
                    console.log('Window end');
                    console.log(e)
                }
            });
            window.addEventListener('drop', (e) => {
                if (e.dataTransfer.types && e.dataTransfer.types.indexOf('jimud/tab') !== -1) {
                    e.dataTransfer.dropEffect = 'move';
                    e.stopPropagation();
                    e.preventDefault();
                    console.log('Window drop');
                    console.log(e);
                    const tab = JSON.parse(e.dataTransfer.getData('jimud/tab'));
                    var x = e.screenX;
                    var y = e.screenY;
                    if (tab.offset) {
                        x -= tab.offset.x;
                        y -= tab.offset.y;
                    }
                    ipcRenderer.send('dock-client', tab.client, { x: x, y: y });
                    //ipcRenderer.send('dock-client', tab.client, { x: e.screenX - e.clientX, y: e.screenY - e.clientY });
                }
            });
            _loading++;
            if (_load.length) {
                console.log('load');
                setClients(_load);
                //for (var c = 0, cl = _load.length; c < cl; c++)
                //addClient(_load[c]);
                if (_current)
                    switchToClient(_current);
            }
            _loading--;
        });
        /*
                window.onbeforeunload = function (evt) {
                    const close = ipcRenderer.sendSync('can-close-all-client');
                    console.log(close);
                    if (!close) {
                        evt.returnValue = false;
                        return 'no';
                    }
                };
                */

        function getActiveClient() {
            return _current;
        }

        function setId(id) {
            _id = id;
        }

        function getId() {
            return _id;
        }

        function saveWindow() {
            return { data: 'custom data test' };
        }

        function restoreWindow(data) {
            console.log('restoreWindow');
            console.log(data);
        }

        ipcRenderer.on('new-client', (event, client) => {
            console.log('new: ' + client.id);
            console.log(client);
            if (typeof client.index !== 'undefined' && client.index !== -1 && client.index < _clients.length)
                _clients.splice(client.index, 0, client.id);
            else
                _clients.push(client.id);
            if (typeof tabstrip !== 'undefined')
                addClient(client);
            else
                _load.push(client);
        });

        ipcRenderer.on('set-clients', (event, clients, current) => {
            _loading++;
            console.log('set-clients');
            console.log(clients);
            console.log('current: ' + current);
            _clients.push(...clients.map(x => x.id));
            if (typeof tabstrip !== 'undefined')
                setClients(clients);
            else
                _load = clients;
            _current = current;
            _loading--;
            console.log('end');
        });

        ipcRenderer.on('switch-client', (event, id) => {
            console.log('switch: ' + id);
            _current = id;
            if (typeof tabstrip !== 'undefined')
                switchToClient(id);
        });

        ipcRenderer.on('removed-client', (event, id) => {
            const idx = _clients.indexOf(id);
            if (idx !== -1)
                _clients.splice(idx, 1);
            const tabs = useDockPanel ? tabstrip.panels : tabstrip.tabs;
            for (var t = 0, tl = tabs.length; t < tl; t++) {
                if (tabs[t].client === id) {
                    //remove the tab with out events or you get a loop
                    tabstrip.removeTab(t, true);
                    break;
                }
            }
        });

        ipcRenderer.on('update-title', (event, id, options) => {
            if (!options) return;
            const tabs = useDockPanel ? tabstrip.panels : tabstrip.tabs;
            for (var t = 0, tl = tabs.length; t < tl; t++) {
                if (tabs[t].client === id) {
                    if (options.title) {
                        tabstrip.setTabTitle(options.title, t);
                        if (!options.tooltip)
                            tabstrip.setTabTooltip(options.title, t);
                        if (tabstrip.active === tabs[t])
                            document.title = 'jiMUD - ' + options.title;
                    }
                    if (options.icon)
                        tabstrip.setTabIconClass(options.icon, t, true);
                    if (options.tooltip)
                        tabstrip.setTabTooltip(options.tooltip, t);
                    break;
                }
            }
        });

        function addClient(client) {
            let tab;
            console.log('addClient: ' + client.id);
            if (typeof client.index !== 'undefined' && client.index !== -1 && client.index < _clients.length)
                tab = useDockPanel ? tabstrip.insertPanel(client.index, '' + client.id, client.icon || 'disconnected-icon') : tabstrip.insertTab(client.index, '' + client.id, client.icon || 'disconnected-icon');
            else
                tab = useDockPanel ? tabstrip.addPanel('' + client.id, client.icon || 'disconnected-icon') : tabstrip.addTab({ title: '' + client.id, icon: client.icon || 'disconnected-icon', noActivate: true, silent: true });
            tab.client = client.id;
            if (client.current)
                _current = client.id;
            if (!client.noUpdate)
                ipcRenderer.send('update-client', client.id, useDockPanel ? tabstrip.activePane.tabstripHeight : tabstrip.height);
        }

        function setClients(clients) {
            console.log('setClients');
            console.log(clients);
            console.log('before current: ' + _current);
            const tabs = [];
            let current = 0;
            let cTab = 0;
            for (var c = 0, cl = clients.length; c < cl; c++) {
                const client = clients[c];
                _clients.push(client.id);
                let tab = useDockPanel ? tabstrip.createPanel('' + client.id, client.icon || 'disconnected-icon') : tabstrip.createTab({ title: '' + client.id, icon: client.icon || 'disconnected-icon', noActivate: true, silent: true });
                tab.client = client.id;
                tabs.push(tab);
                if (client.current) {
                    _current = client.id;
                    cTab = c;
                }
            }
            tabstrip.addTabs(tabs, cTab);
            tabstrip.refresh();
            for (var c = 0, cl = clients.length; c < cl; c++) {
                ipcRenderer.send('update-client', clients[c].id, useDockPanel ? tabstrip.activePane.tabstripHeight : tabstrip.height);
            }
            document.title = 'jiMUD - ' + tabstrip.active.title.innerText;
        }

        function switchToClient(id) {
            console.log('switchToClient: ' + id);
            const tabs = useDockPanel ? tabstrip.panels : tabstrip.tabs;
            for (var t = 0, tl = tabs.length; t < tl; t++) {
                if (tabs.client === id) {
                    if (useDockPanel)
                        tabstrip.switchToPanelByIndex(t);
                    else
                        tabstrip.switchToTabByIndex(t);
                    break;
                }
            }
        }

        function switchTab(index) {
            if (useDockPanel)
                tabstrip.switchToPanelByIndex(index);
            else
                tabstrip.switchToTabByIndex(index);
        }        
    </script>
    <style>
        body {
            /*@TODO temp fix until tabs support theming to prevent black to white flicking*/
            background-color: rgb(255, 255, 255);
        }

        /*use circle icons to see better, maybe add a setting to allow user choice*/
        .connected-icon {
            background-image: url(../assets/icons/png/connected.png);
        }

        .connectednonactive-icon {
            background-image: url(../assets/icons/png/connectednonactive.png);
        }

        .disconnected-icon {
            background-image: url(../assets/icons/png/disconnected.png);
        }

        .text-connected-icon {
            color: blue;
        }

        .text-connectednonactive-icon {
            color: lime;
        }

        .text-disconnected-icon {
            color: red;
            font-weight: bold;
        }
    </style>
</head>

<body id="client-container">
</body>

</html>
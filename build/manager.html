<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>jiMUD</title>
    <link href="css/main.css" rel="stylesheet" type="text/css" />
    <link href="../lib/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/theme.css" rel="stylesheet" type="text/css" />
    <link href="css/window.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link id="theme" rel="stylesheet" href="themes/default.css" type="text/css" />
    <script type="text/javascript">
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="../lib/jquery.min.js"></script>
    <script src="../lib/bootstrap.min.js"></script>
    <script type="text/javascript">
        const { ipcRenderer } = require('electron');
        const { parseTemplate, isFileSync } = require('./js/library.js');
        const { TabStrip } = require('./js/tabstrip.js');
        const _clients = [];
        var _load = [];
        var _id;
        var tabStrip;
        var _current = 0;
        var _loading = 0;

        function loadTheme(theme, force) {
            theme = parseTemplate(theme) + '.css';
            if (!isFileSync(theme))
                theme = parseTemplate(path.join('{themes}', 'default')) + '.css';
            var el = document.getElementById('theme');
            if (el.getAttribute('href') !== theme || force)
                el.setAttribute('href', theme);
        }

        $(document).ready(() => {
            tabstrip = new TabStrip();
            tabstrip.useNativeMenus = true;
            tabstrip.on('tab-strip-hidden', () => {
                ipcRenderer.send('update-client', _current, 0);
            });
            tabstrip.on('tab-strip-shown', () => {
                ipcRenderer.send('update-client', _current, tabstrip.height);
            });
            tabstrip.on('add', e => {
                if (_loading) return;
                const tabs = tabstrip.tabs;
                if (tabs.length === 2) {
                    //force a refresh as will not update while hidden
                    tabstrip.refresh();
                    //resize previous tab just to ensure all are same size
                    ipcRenderer.send('update-client', tabs[0].client, tabstrip.height);
                    ipcRenderer.send('update-client', _current, tabstrip.height);
                }
            });
            tabstrip.on('tab-click', e => {
                ipcRenderer.send('switch-client', e.tab.client, tabstrip.height);
                _current = e.tab.client;
            });
            tabstrip.on('remove', e => {
                ipcRenderer.send('remove-client', e.tab.client);
                //cancel the remove as we want to make sure it is called after browser view is cleaned up as it may cancel based on user input
                e.cancel = true;
            });
            tabstrip.on('removed', panel => {
                if (tabstrip.hideTabstrip && tabstrip.tabs.length === 1) {
                    ipcRenderer.send('update-client', _current, 0);
                }
            });
            tabstrip.on('activated', e => {
                if (_loading) return;
                ipcRenderer.send('switch-client', e.tab.client, tabstrip.height);
                _current = e.tab.client;
                setTitle(e.tab.title.innerText);
            })
            tabstrip.on('tab-moved', e => {
                ipcRenderer.send('reorder-client', e.tab.client, e.index, e.oldIndex);
            });
            tabstrip.on('tab-drag-end', e => {
                //dropped outside of client area so new window if more then 1 tab
                if (e.event.dataTransfer.items.length === 0 && (e.event.clientX < 0 || e.event.clientY < 0 || e.event.clientX >= document.body.clientHeight || e.event.clientY >= document.body.clientWidth)) {
                    e.event.stopPropagation();
                    e.event.preventDefault();
                    var x = e.event.screenX;
                    var y = e.event.screenY;
                    var bounds = e.tab.tab.getBoundingClientRect();
                    x -= Math.ceil(bounds.left + (window.outerWidth - document.body.offsetWidth));
                    y -= Math.ceil(bounds.top + (window.outerHeight - document.body.offsetHeight));
                    ipcRenderer.send('dock-client', tabstrip.dragTab.client, { x: x, y: y });
                }
            });
            tabstrip.on('tab-drop', e => {
                //if not dragging its from a different window so its a undock/dock
                if (e.tab === tabstrip.dragTab) {
                    e.event.preventDefault();
                    e.event.stopPropagation();
                }
                if (!tabstrip.dragPanel && !tabstrip.dragTab) {
                    e.preventDefault = true;
                    e.event.stopPropagation();
                    e.event.preventDefault();
                    const tab = JSON.parse(e.event.dataTransfer.getData('jimud/tab'));
                    e.tab.tab.classList.remove('drop');
                    ipcRenderer.send('dock-client', tab.client, { index: tabstrip.getTabIndex(e.tab) });
                }
            });

            window.addEventListener('dragstart', (e) => {
                if (e.dataTransfer.types && e.dataTransfer.types.indexOf('jimud/tab') !== -1) {
                    e.dataTransfer.dropEffect = 'move';
                }
            });
            window.addEventListener('dragleave', (e) => {
                if (e.dataTransfer.types && e.dataTransfer.types.indexOf('jimud/tab') !== -1) {
                    e.dataTransfer.dropEffect = 'move';
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
            window.addEventListener('dragover', (e) => {
                if (e.dataTransfer.types && e.dataTransfer.types.indexOf('jimud/tab') !== -1) {
                    e.dataTransfer.dropEffect = 'move';
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
            window.addEventListener('dragenter', (e) => {
                if (e.dataTransfer.types && e.dataTransfer.types.indexOf('jimud/tab') !== -1) {
                    e.dataTransfer.dropEffect = 'move';
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
            window.addEventListener('dragend', (e) => {
                if (e.dataTransfer.types && e.dataTransfer.types.indexOf('jimud/tab') !== -1) {
                    e.dataTransfer.dropEffect = 'move';
                }
            });
            window.addEventListener('drop', (e) => {
                if (e.dataTransfer.types && e.dataTransfer.types.indexOf('jimud/tab') !== -1) {
                    e.dataTransfer.dropEffect = 'move';
                    e.stopPropagation();
                    e.preventDefault();
                    const tab = JSON.parse(e.dataTransfer.getData('jimud/tab'));
                    var x = e.screenX;
                    var y = e.screenY;
                    if (tab.offset) {
                        x -= tab.offset.x;
                        y -= tab.offset.y;
                    }
                    ipcRenderer.send('dock-client', tab.client, { x: x, y: y });
                }
            });
            _loading++;
            if (_load.length) {
                setClients(_load);
                if (_current)
                    switchToClient(_current);
            }
            _loading--;
        });

        function getActiveClient() {
            return _current;
        }

        function setId(id) {
            _id = id;
        }

        function getId() {
            return _id;
        }

        /*
        function saveWindow() {
            return { data: 'custom data test' };
        }

        function restoreWindow(data) {
            console.log('restoreWindow');
            console.log(data);
        }
        */

        ipcRenderer.on('new-client', (event, client) => {
            if (typeof client.index !== 'undefined' && client.index !== -1 && client.index < _clients.length)
                _clients.splice(client.index, 0, client.id);
            else
                _clients.push(client.id);
            if (typeof tabstrip !== 'undefined')
                addClient(client);
            else
                _load.push(client);
        });

        ipcRenderer.on('set-clients', (event, clients, current) => {
            _loading++;
            _clients.push(...clients.map(x => x.id));
            if (typeof tabstrip !== 'undefined')
                setClients(clients);
            else
                _load = clients;
            _current = current;
            _loading--;
        });

        ipcRenderer.on('switch-client', (event, id) => {
            _current = id;
            if (typeof tabstrip !== 'undefined')
                switchToClient(id);
        });

        ipcRenderer.on('removed-client', (event, id) => {
            const idx = _clients.indexOf(id);
            if (idx !== -1)
                _clients.splice(idx, 1);
            const tabs = tabstrip.tabs;
            for (var t = 0, tl = tabs.length; t < tl; t++) {
                if (tabs[t].client === id) {
                    //remove the tab with out events or you get a loop
                    tabstrip.removeTab(t, true);
                    break;
                }
            }
        });

        ipcRenderer.on('update-title', (event, id, options) => {
            if (!options) return;
            const tabs = tabstrip.tabs;
            for (var t = 0, tl = tabs.length; t < tl; t++) {
                if (tabs[t].client === id) {
                    if (options.title) {
                        tabstrip.setTabTitle(options.title, t);
                        if (!options.tooltip)
                            tabstrip.setTabTooltip(options.title, t);
                        if (tabstrip.active === tabs[t])
                            setTitle(options.title);
                    }
                    if (options.icon)
                        tabstrip.setTabIconClass(options.icon, t, true);
                    if (options.tooltip)
                        tabstrip.setTabTooltip(options.tooltip, t);
                    break;
                }
            }
        });

        function addClient(client) {
            let tab;
            if (typeof client.index !== 'undefined' && client.index !== -1 && client.index < _clients.length)
                tab = tabstrip.insertTab(client.index, { title: '', icon: client.icon || 'disconnected-icon' });
            else
                tab = tabstrip.addTab({ title: '', icon: client.icon || 'disconnected-icon', noActivate: true, silent: true });
            tab.client = client.id;
            if (client.current)
                _current = client.id;
            if (!client.noUpdate)
                ipcRenderer.send('update-client', client.id, tabstrip.height);
        }

        function setClients(clients) {
            const tabs = [];
            let current = 0;
            let cTab = 0;
            for (var c = 0, cl = clients.length; c < cl; c++) {
                const client = clients[c];
                _clients.push(client.id);
                let tab = tabstrip.createTab({ title: '', icon: client.icon || 'disconnected-icon', noActivate: true, silent: true });
                tab.client = client.id;
                tabs.push(tab);
                if (client.current) {
                    _current = client.id;
                    cTab = c;
                }
            }
            tabstrip.addTabs(tabs, cTab);
            tabstrip.refresh();
            for (var c = 0, cl = clients.length; c < cl; c++) {
                ipcRenderer.send('update-client', clients[c].id, tabstrip.height);
            }
            setTitle(tabstrip.active.title.innerText);
        }

        function switchToClient(id) {
            const tabs = tabstrip.tabs;
            for (var t = 0, tl = tabs.length; t < tl; t++) {
                if (tabs.client === id) {
                    tabstrip.switchToTabByIndex(t);
                    break;
                }
            }
        }

        function switchTab(index) {
            tabstrip.switchToTabByIndex(index);
        }

        function setTitle(txt) {
            if (txt.trim().length !== 0)
                document.title = 'jiMUD - ' + txt.trim();
            else
                document.title = 'jiMUD';
        }
    </script>
</head>

<body id="client-container">
</body>

</html>
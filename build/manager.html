<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>jiMUD</title>
    <link href="css/main.css" rel="stylesheet" type="text/css" />
    <link href="../lib/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/theme.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link id="theme" rel="stylesheet" href="themes/default.css" type="text/css" />
    <script type="text/javascript">
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="../lib/jquery.min.js"></script>
    <script src="../lib/bootstrap.min.js"></script>
    <script type="text/javascript">
        const { ipcRenderer } = require('electron');
        const { parseTemplate, isFileSync } = require('./js/library.js');
        const clients = [];
        var _id;
        var tabStrip;
        var clientID = 0;
        var current = '0';

        function newClient() {
            ipcRenderer.send('update-client', current, tabStrip.childNodes.length === 0 ? 0 : 32);
            current = '' + clientID;
            ipcRenderer.send('new-client', current, true, tabStrip.childNodes.length === 0 ? 0 : 32);
            clients.push(current);
            tabStrip.appendChild(createTab(current));
            tabStrip.style.display = 'inline-block';
            clientID++;
        }

        function dockClient(id) {
            if (clients.indexOf(id) !== -1) return;
            ipcRenderer.send('dock-client', id, 32);
            current = id;
            ipcRenderer.send('switch-client', current, 32);
            tabStrip.appendChild(createTab(id));
            if (tabStrip.childNodes.length < 2)
                tabStrip.style.display = 'none';
            else
                tabStrip.style.display = 'inline-block';
            clients.push(id);
        }

        function undockClient(id) {
            var idx = clients.indexOf(id);
            if (clients.indexOf(id) === -1) return;
            ipcRenderer.send('undock-client', id);
            removeTab(id);
            clients.splice(idx, 1);
            if (tabStrip.childNodes.length < 2)
                tabStrip.style.display = 'none';
            else
                tabStrip.style.display = 'inline-block';
            if (id === current) {
                if (idx >= clients.length)
                    idx = clients.length - 1;
                current = clients[idx];
                ipcRenderer.send('switch-client', current, tabStrip.childNodes.length === 1 ? 0 : 32);
            }
            else
                ipcRenderer.send('update-client', current, tabStrip.childNodes.length === 1 ? 0 : 32);
        }

        function removeClient(id) {
            removeTab(id);
            ipcRenderer.send('remove-client', id);
            if (tabStrip.childNodes.length < 2)
                tabStrip.style.display = 'none';
            var idx = clients.indexOf(id);
            clients.splice(idx, 1);
            if (id === current) {
                if (idx > 0)
                    current = clients[idx - 1];
                else if (idx >= clients.length)
                    current = clients[clients.length - 1];
                else
                    current = clients[idx];
                ipcRenderer.send('switch-client', current, tabStrip.childNodes.length === 1 ? 0 : 32);
            }
            else
                ipcRenderer.send('update-client', current, tabStrip.childNodes.length === 1 ? 0 : 32);
        }

        function loadTheme(theme, force) {
            theme = parseTemplate(theme) + '.css';
            if (!isFileSync(theme))
                theme = parseTemplate(path.join('{themes}', 'default')) + '.css';
            var el = document.getElementById('theme');
            if (el.getAttribute('href') !== theme || force)
                el.setAttribute('href', theme);
        }

        function updateInterface() {
        }

        function createTab(id) {
            var tab = document.createElement('div');
            tab.id = 'client-' + id;
            tab.innerHTML = `${id}<i class="fa fa-window-maximize" onclick="undockClient('${id}');event.stopPropagation();event.cancelBubble = true;"></i>`;
            tab.classList.add('tab');
            tab.dataset.clientID = id;
            tab.addEventListener('click', (ev) => {
                if (current === ev.currentTarget.dataset.clientID) return;
                current = ev.currentTarget.dataset.clientID;
                ipcRenderer.send('switch-client', current, tabStrip.childNodes.length === 1 ? 0 : 32);
            });
            return tab;
        }

        function removeTab(id) {
            tabStrip.removeChild(document.getElementById('client-' + id));
        }

        $(document).ready(() => {
            tabStrip = document.getElementById('client-tabs');
            tabStrip.style.display = 'none';
        });

        function getActiveClient() {
            return current;
        }

        function setId(id) {
            _id = id;
        }

        function getId() {
            return _id;
        }

        ipcRenderer.on('new-client', (event, id) => {
            clients.push(current);
            createTab(id);
            current = id;
        });
    </script>
    <style>
        .tab {
            background-color: white;
            display: inline-block;
            width: 32px;
            height: 32px;
        }
    </style>
</head>

<body id="client-container">
    <div id="client-tabs" style="display: none"></div>
</body>

</html>
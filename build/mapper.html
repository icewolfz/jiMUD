<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>Mapper</title>
    <link rel="shortcut icon" href="../assets/icons/png/map.png" />
    <link href="../lib/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-select.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/form.css" rel="stylesheet" type="text/css" />
    <link href="css/propertygrid.css" rel="stylesheet" type="text/css" />
    <link href="css/datagrid.css" rel="stylesheet" type="text/css" />
    <link href="css/mapper.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript">
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="../lib/jquery.min.js"></script>
    <script src="../lib/bootstrap.min.js"></script>
    <script src="../lib/bootstrap-select.min.js"></script>
</head>

<body>
    <div id="mapper-toolbar" class="btn-toolbar" role="toolbar">
        <div class="btn-group" role="group">
            <button id="btn-enable" type="button" class="btn btn-default btn-xs" title="Enabled" onclick="toggleEnabled()">
                <i class="fa fa-map-o"></i>
            </button>
            <button id="btn-follow" type="button" class="btn btn-default btn-xs" title="Follow" onclick="toggleFollow()">
                <i class="fa fa-paw"></i>
            </button>
            <button id="btn-legend" type="button" class="btn btn-default btn-xs" title="Show legend" onclick="toggleLegend()">
                <i class="fa fa-map-marker"></i>
            </button>
            <button id="btn-room" type="button" class="btn btn-default btn-xs" title="Show room properties" onclick="toggleRooms();">
                <i class="fa fa-list-alt"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-refresh" type="button" class="btn btn-default btn-xs" title="Refresh map" onclick="refreshMap()">
                <i class="fa fa-refresh"></i>
            </button>
            <button id="btn-compact" type="button" class="btn btn-default btn-xs" title="Compact map" onclick="compact()">
                <i class="fa fa-compress"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-split" type="button" class="btn btn-default btn-xs" title="Split areas" onclick="toggleSplitArea()">
                <i class="fa fa-object-ungroup"></i>
            </button>
            <button id="btn-fill" type="button" class="btn btn-default btn-xs" title="Fill walls" onclick="toggleFillWalls()">
                <i class="fa fa-building-o"></i>
            </button>
        </div>
        <button id="btn-focus" type="button" class="btn btn-default btn-xs" title="Focus on current room" onclick="mapper.focusCurrentRoom()">
            <i class="fa fa-crosshairs"></i>
        </button>
        <select id="select-area" class="form-control" title="Select Area"></select>
        <div class="btn-group" style="float: left">
            <label for="MapLevel" style="float: left">Level:</label>
            <input id="MapLevel" class="form-control" type="number" title="Map Level">
        </div>
        <div class="btn-group" style="float: left">
            <label for="MapZone" style="float: left">Zone:</label>
            <input id="MapZone" class="form-control" type="number" title="Map Zone">
        </div>
        <div class="btn-group" role="group">
            <button id="remove" type="button" class="btn btn-default btn-xs" aria-haspopup="true" title="Remove area/room">
                <i class="fa fa-eraser"></i>&nbsp;
                <span class="caret"></span>
            </button>
            <button id="export" type="button" class="btn btn-default btn-xs" aria-haspopup="true" title="Export/Import data">
                <i class="fa fa-exchange"></i>&nbsp;
                <span class="caret"></span>
            </button>
        </div>

        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default btn-xs" title="Set selected as current" onclick="mapper.setCurrent()">
                <i class="fa fa-circle"></i>
            </button>
            <button id="btn-highlight" type="button" class="btn btn-default btn-xs" disabled="disabled" title="Highlight path" onclick="mapper.showPath()">
                <i class="fa fa-paint-brush"></i>
            </button>
            <button id="btn-clear" type="button" class="btn btn-default btn-xs" disabled="disabled" title="Clear path" onclick="mapper.clearPath()">
                <i class="fa fa-times"></i>
            </button>
            <button id="btn-walk" type="button" class="btn btn-default btn-xs" disabled="disabled" title="Walk path" onclick="mapper.walkPath()">
                <i class="fa fa-blind"></i>
            </button>
        </div>
        <div class="btn-group" style="float: left">
            <label for="MapZoom" style="float: left">Zoom:</label>
            <input id="MapZoom" type="range" min="25" max="200" step="5" oninput="zoomMap($('#MapZoom').val(), true)">

            <label id="MapZoomDisplay">100%</label>
        </div>

    </div>
    <div id="mapper-body">
        <div id="map" style="display: none">
            <div class="MapperNavButton" title="Scroll northwest" style="top:4px;left:4px;background-position: 0px 0px;" data-x="-1" data-y="-1"></div>
            <div class="MapperNavButton" title="Scroll north" style="top:4px;left:50%;background-position: -22px 0px;margin-left:-11px;" data-x="0" data-y="-1"></div>
            <div class="MapperNavButton" title="Scroll northeast" style="top:4px;left:100%;background-position: -44px 0px;margin-left:-26px;" data-x="1" data-y="-1"></div>
            <div class="MapperNavButton" title="Scroll west" style="top:50%;left:4px;background-position: 0px -22px;margin-top:-11px;" data-x="-1" data-y="0"></div>
            <div class="MapperNavButton" title="Scroll east" style="top:50%;left:100%;background-position: -44px -22px;margin-top:-11px;margin-left:-26px;" data-x="1" data-y="0"></div>
            <div class="MapperNavButton" title="Scroll southwest" style="bottom:4px;left:4px;background-position: 0px -44px;" data-x="-1" data-y="1"></div>
            <div class="MapperNavButton" title="Scroll south" style="bottom:4px;left:50%;background-position: -22px -44px;margin-left:-11px;" data-x="0" data-y="1"></div>
            <div class="MapperNavButton" title="Scroll southeast" style="bottom:4px;left:100%;background-position: -44px -44px;margin-left:-26px;" data-x="1" data-y="1"></div>
            <canvas id="MapperCanvas" class="map-canvas" tabindex="1"></canvas>
        </div>
    </div>
    <dialog id="mapProgress" style="z-index:1000;text-align:center" onclose="menubar.enabled = true;" oncancel="menubar.enabled = true;">
        <div id="mapProgressTitle">Importing data&hellip;</div>
        <div id="mapProgressbar">
            <progress max="100"></progress>
        </div>
        <div id="mapProgressCancel">
            <button onclick="mapper.cancelExport();">
                Cancel
            </button>
        </div>
    </dialog>

    <script type="text/javascript">
        if (window.module) module = window.module;
        //spell-checker:ignore hellip vscroll hscroll ungroup crosshairs haspopup tablist tabpanel labelledby propertygrid
        const { RoomDetails, Mapper, ImportType } = require('./js/mapper');
        const { nativeImage, ipcRenderer } = require('electron');
        const remote = require('@electron/remote');
        const { Menu, MenuItem } = remote;
        const { Settings } = require('./js/settings');
        const { Menubar } = require('./js/menubar');
        const { PropertyGrid } = require('./js/propertygrid');
        const { Splitter, Orientation } = require('./js/splitter');
        const { EditorType } = require('./js/value.editors');
        const fs = require('fs');

        var importType = ImportType.Replace;
        var _progress;
        var _enableDebug = false;
        var $splitterEditor;
        var $roomEditor;

        var menubar = new Menubar([
            {
                label: '&File',
                id: 'file',
                submenu: [
                    {
                        label: '&Enabled',
                        type: 'checkbox',
                        click: toggleEnabled
                    },
                    { type: 'separator' },
                    {
                        label: '&Export',
                        submenu: [
                            { label: 'Export as image', click: () => save(exportImage) },
                            { label: 'Export current view as image', click: exportCurrentImage },
                            { type: 'separator' },
                            { label: 'Export current area', click: exportCurrentArea },
                            { label: 'Export all', click: exportAll },
                        ]
                    },
                    {
                        label: '&Import',
                        submenu: [
                            { label: 'Import and replace', click: importMerge },
                            { label: 'Import and merge', click: importReplace },
                        ]
                    },
                    { type: 'separator' },
                    {
                        label: '&Close',
                        click: () => { window.close(); }
                    }
                ]
            },
            {
                label: '&Edit',
                submenu: [
                    { label: 'Remove selected room', enabled: false, click: removeSelectedRoom },
                    { label: 'Remove current room', enabled: false, click: removeCurrentRoom },
                    { type: 'separator' },
                    { label: 'Remove current area', click: removeCurrentArea },
                    { label: 'Remove all', click: removeAll },
                    { type: 'separator' },
                    { label: 'Compact map', click: compact },
                    { type: 'separator' },
                    { label: 'Reset map', click: resetMap },
                ]
            },
            {
                label: '&View',
                submenu: [
                    { label: 'Legend', type: 'checkbox', click: toggleLegend },
                    { label: 'Room Properties', type: 'checkbox', click: toggleRooms },
                    { type: 'separator' },
                    { label: 'Split areas', type: 'checkbox', click: toggleSplitArea },
                    { label: 'Fill walls', type: 'checkbox', click: toggleFillWalls },
                    { type: 'separator' },
                    { label: 'Refresh', click: refreshMap },
                    {
                        type: 'separator'
                    },
                    {
                        label: '&Toggle Developer Tools',
                        click: () => {
                            window.toggleDevTools();
                        }
                    },
                    {
                        type: 'separator'
                    },
                    {
                        label: 'Actual Size',
                        click: () => { zoomMap(100); },
                        accelerator: 'CmdOrCtrl+0'
                    },
                    {
                        label: 'Zoom In',
                        click: () => { zoomMap(mapper.scale + 5); },
                        accelerator: 'CmdOrCtrl+Shift+='
                    },
                    {
                        label: 'Zoom Out',
                        click: () => { zoomMap(mapper.scale - 5); },
                        accelerator: 'CmdOrCtrl+-'
                    },
                    {
                        type: 'separator'
                    },
                    {
                        role: 'togglefullscreen'
                    }
                ]
            },
            {
                label: '&Actions',
                submenu: [
                    { label: 'Follow', type: 'checkbox', click: toggleFollow },
                    { type: 'separator' },
                    { label: 'Focus on current room', click: () => { mapper.focusCurrentRoom(); } },
                    { label: 'Set selected as current', click: () => { mapper.setCurrent(); } },
                    { type: 'separator' },
                    { label: 'Highlight path', enabled: false, click: () => { mapper.showPath(); } },
                    { label: 'Clear path', enabled: false, click: () => { mapper.clearPath(); } },
                    { label: 'Walk path', enabled: false, click: () => { mapper.walkPath(); } },
                ]
            }
        ]);

        var mapper;
        var MapperNavDown = false;

        function MapperNavClicked(x, y) {
            if (!MapperNavDown) return;
            mapper.scrollBy(x, y);
            setTimeout(function () { MapperNavClicked(x, y); }, 100);
        }

        function clearButton(id) {
            document.getElementById(id).classList.remove('open');
            document.getElementById(id).blur();
        }

        function saveRoom() {
            $roomEditor.updateValue();
        }

        function save(callback) {
            saveRoom();
            mapper.save(callback);
        }

        let $closeWindow = false;

        // eslint-disable-next-line no-unused-vars
        function closeHidden(hidden) {
            if (mapper)
                save();
            if (hidden) return true;
        }

        // eslint-disable-next-line no-unused-vars
        function closing() {
            if (mapper)
                save();
        }

        function closeable(all) {
            if (!$closeWindow) {
                if (_progress && _progress.dialog) {
                    dialog.showMessageBox({
                        type: 'error',
                        title: 'Progress dialog open',
                        message: 'You must close the progress dialog before you can close mapper.',
                        defaultId: 1,
                        noLink: true
                    });
                    ipcRenderer.send('progress', 'focus');
                    $closeWindow = false;
                }
                else
                    $closeWindow = true;
            }
            return $closeWindow;
        }

        function skipSaveWindow() {
            if (window.opener.client.options.mapper.enabled || window.opener.client.options.mapper.persistent)
                return false;
            //if not visible do not save this window as it was probably preserved due to a setting change
            return !window.isVisible();
        }

        function removeEvents(e) {
            if (window.opener.client.options.mapper.enabled || window.opener.client.options.mapper.persistent) {
                window.hide();
                e.returnValue = false;
                return 'no';
            }
            window.opener.client.off('received-GMCP', processGMCP);
            window.opener.client.off('options-loaded', optionsLoaded);
            window.opener._status.off('set-title', setTitle);
            window.opener.removeEventListener('loadCharacter', updateCharacter);
            window.opener.removeEventListener('updateCharacter', updateCharacter);
            window.opener.removeEventListener('resetCharacter', updateCharacter);
        }

        window.onbeforeunload = removeEvents;

        $(document).ready(() => {
            try {
                const characterName = window.opener.getCharacterName();
                if (characterName && characterName.length > 0)
                    document.title = 'Mapper - ' + characterName;
                else
                    document.title = 'Mapper';
                const options = window.opener.client.options;
                mapper = new Mapper(document.getElementById('MapperCanvas'), options.mapper.memory, options.mapper.memorySavePeriod, window.opener.getMapFile());

                document.getElementById('MapperCanvas').addEventListener('wheel', (e) => {
                    if (e.deltaY >= 0)
                        zoomMap(mapper.scale - 5);
                    else
                        zoomMap(mapper.scale + f5);
                }, { passive: true });

                $splitterEditor = new Splitter({ parent: document.getElementById('mapper-body'), orientation: Orientation.vertical });
                $splitterEditor.on('splitter-moved', (e) => {
                    window.opener.client.options.mapper.roomWidth = e;
                    window.opener.client.saveOptions();
                    mapper._canvas.width = $splitterEditor.panel1.clientWidth - 60;
                    mapper._canvas.height = $splitterEditor.panel1.clientHeight - 60;
                    mapper.draw();

                });
                $splitterEditor.on('collapsed', (panel) => {
                    //this.setButtonState('show room editor', panel !== 2);
                });

                $splitterEditor.panel1.appendChild(document.getElementById('map'));
                document.getElementById('map').style.display = 'block';
                $roomEditor = new PropertyGrid({ parent: $splitterEditor.panel2 });
                $roomEditor.hideUnSetProperties = true;
                $roomEditor.setGroupOptions([
                    {
                        group: 'General',
                        sort: 1
                    },
                    {
                        group: 'Location',
                        sort: 3
                    },
                    {
                        group: 'Details',
                        sort: 2
                    }
                ]);
                $roomEditor.setPropertyOptions([
                    {
                        property: 'exits',
                        visible: false
                    },
                    {
                        property: 'ID',
                        visible: false
                    },
                    {
                        property: 'x',
                        group: 'Location'
                    },
                    {
                        property: 'y',
                        group: 'Location'
                    },
                    {
                        property: 'z',
                        group: 'Location'
                    },
                    {
                        property: 'zone',
                        group: 'Location'
                    },
                    {
                        property: 'indoors',
                        group: 'Details',
                        sort: 7
                    },
                    {
                        property: 'area',
                        group: 'Location',
                        editor: {
                            type: EditorType.select,
                            options: {
                                data: []
                            }
                        }
                    },
                    {
                        property: 'name',
                        group: 'General',
                        sort: 1,
                        editor: {
                            options: {
                                singleLine: true,
                                container: document.body
                            }
                        }
                    },
                    {
                        property: 'env',
                        group: 'Details',
                        label: 'Terrain',
                        editor: {
                            type: EditorType.dropdown,
                            options: {
                                data: [
                                    'beach',
                                    'bog',
                                    'city',
                                    'cliff',
                                    'cobble',
                                    'desert',
                                    'dirt',
                                    'dirtroad',
                                    'farmland',
                                    'forest',
                                    'grass',
                                    'grassland',
                                    'highmountain',
                                    'hills',
                                    'icesheet',
                                    'jungle',
                                    'lake',
                                    'mountain',
                                    'ocean',
                                    'pavedroad',
                                    'plains',
                                    'prairie',
                                    'river',
                                    'rockdesert',
                                    'rocky',
                                    'sand',
                                    'sanddesert',
                                    'savannah',
                                    'stone',
                                    'swamp',
                                    'tundra',
                                    'underwater',
                                    'water'
                                ],
                                container: document.body
                            }
                        },
                        sort: 3
                    },
                    {
                        property: 'background',
                        label: 'Background',
                        group: 'General',
                        sort: 2,
                        editor: {
                            options: {
                                singleLine: true,
                                container: document.body
                            }
                        }
                    },
                    {
                        label: 'Details',
                        sort: 2,
                        property: 'details',
                        group: 'Details',
                        editor: {
                            type: EditorType.flag,
                            options: {
                                enum: RoomDetails,
                                container: document.body
                            }
                        }
                    },
                    {
                        property: 'notes',
                        label: 'Notes',
                        group: 'General',
                        formatter: () => '',
                        visible: true,
                        align: 'center',
                        sort: 7,
                        editor: {
                            options: {
                                singleLine: true,
                                container: document.body
                            }
                        }
                    }
                ]);

                $roomEditor.on('group-expanded', group => {
                    switch (group) {
                        case 'General':
                            window.opener.client.options.mapper.roomGroups |= 1;
                            break;
                        case 'Location':
                            window.opener.client.options.mapper.roomGroups |= 2;
                            break;
                        case 'Details':
                            window.opener.client.options.mapper.roomGroups |= 4;
                            break;
                    }
                    window.opener.client.saveOptions();
                });
                $roomEditor.on('group-collapsed', group => {
                    switch (group) {
                        case 'General':
                            window.opener.client.options.mapper.roomGroups &= ~1;
                            break;
                        case 'Location':
                            window.opener.client.options.mapper.roomGroups &= ~2;
                            break;
                        case 'Details':
                            window.opener.client.options.mapper.roomGroups &= ~4;
                            break;
                    }
                    window.opener.client.saveOptions();
                });

                this.$roomEditor.on('value-changed', (prop, newValue, oldValue) => {
                    const selected = this.$roomEditor.objects.length ? this.$roomEditor.objects[0] : null;
                    if (!selected) return;
                    mapper.getRoom(selected.ID, (room) => {
                        room.x = selected.x;
                        room.y = selected.y;
                        room.z = selected.z;
                        room.zone = selected.zone;
                        room.area = selected.area;
                        room.background = selected.background;
                        room.env = selected.env;
                        room.indoors = selected.indoors;
                        room.details = selected.details;
                        room.notes = selected.notes;
                        mapper.addOrUpdateRoom(selected);
                    });
                });

                $('#mapper-body').css('top', $('#mapper-toolbar').outerHeight() + 'px');

                mapper.active = options.mapper.active;
                mapper.commandDelay = options.commandDelay;
                mapper.commandDelayCount = options.commandDelayCount;
                importType = options.mapper.importType;
                _enableDebug = options.enableDebug;

                $('#MapLevel').val(options.mapper.active.z);
                $('#MapZone').val(options.mapper.active.zone);
                $splitterEditor.panel2Collapsed = options.mapper.room;
                toggleRooms();
                $splitterEditor.SplitterDistance = options.mapper.roomWidth;
                if ((options.mapper.roomGroups & 1) === 0)
                    $roomEditor.collapseGroup('General');
                if ((options.mapper.roomGroups & 2) === 0)
                    $roomEditor.collapseGroup('Location');
                if ((options.mapper.roomGroups & 4) === 0)
                    $roomEditor.collapseGroup('Details');
                mapper.on('debug', msg => {
                    if (_enableDebug)
                        console.log(msg);
                });

                mapper.on('path-shown', () => {
                    $('#btn-clear').prop('disabled', false);
                    menubar.updateItem('actions|walk path', { enabled: false });
                    //$("#btn-walk").prop('disabled', false);
                });

                mapper.on('path-cleared', () => {
                    $('#btn-clear').prop('disabled', true);
                    menubar.updateItem('actions|walk path', { enabled: true });
                    //$("#btn-walk").prop('disabled', true);
                });

                mapper.on('room-before-selected', (room) => {
                    if ($splitterEditor.panel2Collapsed || !room || room.ID == null)
                        return;
                    saveRoom();
                });

                mapper.on('active-room-changed', (room) => {
                    if (!room.area || room.area.length === 0)
                        $('#select-area').val($('#select-area option:first').val());
                    else {
                        if (!($('#select-area option[value="' + room.area + '"]').length > 0)) {
                            $('#select-area').append($('<option></option>').val(room.area).html(room.area));
                            $('#reArea').append($('<option></option>').val(room.area).html(room.area));
                        }
                        $('#select-area').val(room.area);
                    }
                    $('#MapLevel').val(room.z);
                    $('#MapZone').val(room.zone);
                    $('#btn-walk').prop('disabled', !(mapper.selected.ID && room.ID && mapper.selected.ID != room.ID));
                    $('#btn-highlight').prop('disabled', !(mapper.selected.ID && room.ID && mapper.selected.ID != room.ID));

                    menubar.updateItem('edit|Remove current room', { enabled: mapper.current.ID && room.ID });
                    menubar.updateItem('actions|highlight path', { enabled: mapper.current.ID && room.ID && mapper.current.ID != room.ID });
                    menubar.updateItem('actions|walk path', { enabled: mapper.current.ID && room.ID && mapper.current.ID != room.ID });
                    window.opener.client.options.mapper.active = room;
                    window.opener.client.saveOptions();
                });

                mapper.on('current-room-changed', (room) => {
                    if ($roomEditor.objects && room.ID === $roomEditor.objects[0].ID) {
                        $roomEditor.objects = [room];
                    }
                    $('#btn-walk').prop('disabled', !(mapper.selected.ID && room.ID && mapper.selected.ID != room.ID));
                    $('#btn-highlight').prop('disabled', !(mapper.selected.ID && room.ID && mapper.selected.ID != room.ID));

                    menubar.updateItem('edit|Remove current room', { enabled: mapper.current.ID && room.ID });
                    menubar.updateItem('actions|highlight path', { enabled: mapper.selected.ID && room.ID && mapper.selected.ID != room.ID });
                    menubar.updateItem('actions|walk path', { enabled: mapper.selected.ID && room.ID && mapper.selected.ID != room.ID });
                });

                mapper.on('room-selected', (room) => {
                    $('#reDNone').prop('checked', true);
                    if (!room || room.ID == null) {
                        this.$roomEditor.objects = null;
                        $('#btn-walk').prop('disabled', true);
                        $('#btn-highlight').prop('disabled', true);
                        menubar.updateItem('edit|Remove selected room', { enabled: false });
                        menubar.updateItem('actions|highlight path', { enabled: false });
                        menubar.updateItem('actions|walk path', { enabled: false });
                    }
                    else {
                        room.indoors = room.indoors ? true : false;
                        this.$roomEditor.objects = [room];
                        $('#btn-walk').prop('disabled', !(mapper.current.ID && mapper.current.ID != room.ID));
                        $('#btn-highlight').prop('disabled', !(mapper.current.ID && mapper.current.ID != room.ID));
                        menubar.updateItem('edit|Remove selected room', { enabled: true });
                        menubar.updateItem('actions|highlight path', { enabled: mapper.current.ID && mapper.current.ID != room.ID });
                        menubar.updateItem('actions|walk path', { enabled: mapper.current.ID && mapper.current.ID != room.ID });
                    }
                });

                mapper.on('import-progress', (value) => {
                    if (value != -1) {
                        if (_progress.action === 1 || _progress.action === 2)
                            $('#mapProgressbar progress').val(value);
                        else if (_progress.dialog)
                            ipcRenderer.send('progress', 'update', { percent: value });
                        window.setProgressBar(value / 100.0);
                    }
                });

                mapper.on('import-complete', () => {
                    updateAreas();
                    if (_progress.action === 1 || _progress.action === 2)
                        closeProgress();
                    else if (_progress.dialog)
                        ipcRenderer.send('progress', 'close');
                    window.setProgressBar(-1);
                    window.opener.client.sendGMCP('Room.Info');
                });

                mapper.on('setting-changed', (setting, value) => {
                    if (setting === 'active') {
                        $('#select-area').val(value.area);
                        $('#MapLevel').val(value.z);
                        $('#MapZone').val(value.zone);
                    }
                    window.opener.client.options.mapper[setting] = value;
                    window.opener.client.saveOptions();
                });

                mapper.on('remove-done', () => {
                    updateAreas();
                });

                mapper.on('clear-area-done', (area) => {
                    $('#select-area option[value="' + area + '"]').remove();
                    $('#select-area').change();
                });

                mapper.on('clear-done', () => {
                    $('#select-area').find('option').remove().end();
                    updateAreas();
                });

                mapper.on('send-commands', (commands) => {
                    window.opener.client.sendRaw(commands);
                });

                mapper.on('context-menu', (room) => {
                    var menu = [];
                    if (room && room.ID) {
                        menu = menu.concat([
                            {
                                label: 'Set as current', Room: room, click: (item) => {
                                    mapper.setCurrent(item.Room);
                                }
                            },
                            {
                                label: 'Remove', Room: room, click: (item) => {
                                    mapper.removeRoom(item.Room);
                                }
                            },
                        ]);
                        if (!$('#btn-clear').prop('disabled') || (mapper.current.ID && room.ID && mapper.current.ID != room.ID))
                            menu.push({ type: 'separator' });
                        if (mapper.current.ID && room.ID && mapper.current.ID != room.ID) {
                            menu.push({
                                label: 'Highlight path to here', Room: room, click: (item) => {
                                    mapper.showPath(item.Room);
                                }
                            });
                            menu.push({
                                label: 'Walk to here', Room: room, click: (item) => {
                                    mapper.walkPath(item.Room);
                                }
                            });
                        }
                    }
                    if (!$('#btn-clear').prop('disabled'))
                        menu.push({
                            label: 'Clear path', Room: room, click: () => {
                                mapper.clearPath();
                            }
                        });
                    if (menu.length > 0)
                        menu.push({ type: 'separator' });
                    menu = menu.concat([
                        {
                            label: 'Refresh', Room: room, click: () => {
                                saveRoom();
                                mapper.refresh();
                            }
                        },
                        {
                            label: 'Compact', Room: room, click: () => {
                                compact();
                            }
                        }
                    ]);

                    var inputMenu = Menu.buildFromTemplate(menu);
                    inputMenu.popup({ window: remote.getCurrentWindow() });
                });

                mapper.on('error', (err) => {
                    if (typeof err === 'string')
                        window.opener.client.error(err);
                    else
                        window.opener.client.error(err.stack || err.message);
                });

                $(window).on('resize', () => {
                    $('#mapper-body').css('top', $('#mapper-toolbar').outerHeight() + 'px');
                    mapper._canvas.width = $splitterEditor.panel1.clientWidth - 60;
                    mapper._canvas.height = $splitterEditor.panel1.clientHeight - 60;
                    mapper.draw();
                });

                $('.MapperNavButton').mouseleave(function () {
                    MapperNavDown = false;
                }).mouseup(function () {
                    MapperNavDown = false;
                }).mousedown(function () {
                    MapperNavDown = true;
                    MapperNavClicked(parseInt($(this).data('x'), 10), parseInt($(this).data('y'), 10));
                });
                document.querySelectorAll('.MapperNavButton').forEach(e => e.addEventListener('wheel', (e) => {
                    MapperNavDown = true;
                    if (e.deltaY >= 0)
                        MapperNavClicked(-parseInt($(e.target).data('x'), 10), -parseInt($(e.target).data('y'), 10));
                    else
                        MapperNavClicked(parseInt($(e.target).data('x'), 10), parseInt($(e.target).data('y'), 10));
                    MapperNavDown = false;
                }, { passive: true }));

                $(window).trigger('resize');

                $('#export').on('show.bs.dropdown', () => {
                    if ($(window).width() < 675 && $('#export').parent().position().left > 400)
                        $('#export .dropdown-menu').addClass('dropdown-menu-right');
                    else
                        $('#export .dropdown-menu').removeClass('dropdown-menu-right');
                });

                if (options.mapper.enabled) {
                    mapper.enabled = false;
                    toggleEnabled();
                }
                if (options.mapper.legend) {
                    mapper.showLegend = false;
                    toggleLegend();
                }
                if (options.mapper.follow) {
                    mapper.follow = false;
                    toggleFollow();
                }
                if (options.mapper.split) {
                    mapper.splitArea = false;
                    toggleSplitArea();
                }
                if (options.mapper.fill) {
                    mapper.fillWalls = false;
                    toggleFillWalls();
                }
                if (mapper.follow)
                    mapper.focusCurrentRoom();

                $('#remove').click(function () {
                    $(this).addClass('open');
                    var pos = $(this).offset();
                    var x = Math.floor(pos.left);
                    var y = Math.floor(pos.top + $(this).outerHeight() + 2);
                    var removeMenu = new Menu();
                    removeMenu.append(new MenuItem({
                        label: 'Remove selected room', enabled: mapper.selected.ID != null, click: removeSelectedRoom
                    }));
                    removeMenu.append(new MenuItem({
                        label: 'Remove current room', enabled: mapper.current.ID != null, click: removeCurrentRoom
                    }));
                    removeMenu.append(new MenuItem({ type: 'separator' }));
                    removeMenu.append(new MenuItem({
                        label: 'Remove current area', click: removeCurrentArea
                    }));
                    removeMenu.append(new MenuItem({
                        label: 'Remove all', click: removeAll
                    }));
                    removeMenu.popup({ window: remote.getCurrentWindow(), x: x, y: y });
                });

                $('#export').click(function () {
                    $(this).addClass('open');
                    var pos = $(this).offset();
                    var x = Math.floor(pos.left);
                    var y = Math.floor(pos.top + $(this).outerHeight() + 2);
                    var exportMenu = new Menu();
                    exportMenu.append(new MenuItem({
                        label: 'Export as image', click: exportImage
                    }));
                    exportMenu.append(new MenuItem({
                        label: 'Export current view as image', click: exportCurrentImage
                    }));
                    exportMenu.append(new MenuItem({ type: 'separator' }));
                    exportMenu.append(new MenuItem({
                        label: 'Export current area', click: exportCurrentArea
                    }));
                    exportMenu.append(new MenuItem({
                        label: 'Export all', click: exportAll
                    }));
                    exportMenu.append(new MenuItem({ type: 'separator' }));
                    exportMenu.append(new MenuItem({
                        label: 'Import and merge', click: importMerge
                    }));
                    exportMenu.append(new MenuItem({
                        label: 'Import and replace', click: importReplace
                    }));

                    exportMenu.popup({ window: remote.getCurrentWindow(), x: x, y: y });
                });

                $('#select-area').change(() => {
                    mapper.setArea($('#select-area').find(':selected').text());
                });

                $('#MapLevel').change(() => {
                    mapper.setLevel(parseInt($('#MapLevel').val(), 10));
                });

                $('#MapZone').change(() => {
                    mapper.setZone(parseInt($('#MapZone').val(), 10));
                });


                updateAreas();
                zoomMap(options.mapper.scale);
                mapper.scrollTo(options.mapper.vscroll, options.mapper.hscroll);
                window.opener.client.sendGMCP('Room.Info');
                window.opener.client.on('received-GMCP', processGMCP);
                window.opener.client.on('options-loaded', optionsLoaded);
                window.opener._status.on('set-title', setTitle);
                window.opener.addEventListener('loadCharacter', updateCharacter);
                window.opener.addEventListener('updateCharacter', updateCharacter);
                window.opener.addEventListener('resetCharacter', updateCharacter);
            }
            catch (err) {
                if (typeof err === 'string')
                    window.opener.client.error(err);
                else
                    window.opener.client.error(err.stack || err.message);
            }
        });

        function setTitle(title, lag) {
            if (title && title.length > 0)
                document.title = 'Mapper - ' + title;
            else
                document.title = 'Mapper';
        }

        function optionsLoaded() {
            save(function () {
                try {
                    var options = window.opener.client.options;
                    mapper.memorySavePeriod = options.mapper.memorySavePeriod;
                    mapper.memory = options.mapper.memory;
                    mapper.mapFile = window.opener.getMapFile();
                    mapper.commandDelay = options.commandDelay;
                    mapper.commandDelayCount = options.commandDelayCount;
                    importType = options.mapper.importType;
                    _enableDebug = options.enableDebug;
                }
                catch (err) {
                    if (typeof err === 'string')
                        window.opener.client.error(err);
                    else
                        window.opener.client.error(err.stack || err.message);
                }
            });
        }

        function updateCharacter(e) {
            const char = window.opener.getCharacterName();
            if (char && char.length > 0)
                document.title = 'Mapper - ' + char;
            else
                document.title = 'Mapper';
            try {
                mapper.mapFile = window.opener.getMapFile();
            }
            catch (err) {
                if (typeof err === 'string')
                    window.opener.client.error(err);
                else
                    window.opener.client.error(err.stack || err.message);
            }
        }

        function progressCanceled() {
            if (_progress.action < 3) {
                mapper.cancelImport();
                if (_progress.dialog)
                    ipcRenderer.send('progress', 'close');
                window.setProgressBar(-1);
            }
        }

        function processGMCP(mod, obj) {
            if (!mapper || !mapper.ready)
                setTimeout(() => {
                    processGMCP(mod, obj);
                }, 100);
            else
                mapper.processGMCP(mod, obj);
        }

        function initProgressDialog(data) {
            if (!_progress.dialog) {
                ipcRenderer.send('show-window', 'progress', data.title, true);
                _progress.dialog = data || true;
            }
            else if (data)
                ipcRenderer.send('progress', 'update', data);
        }

        function importData(data) {
            window.show();
            window.setProgressBar(0);
            _progress = { action: 0, data: data, type: importType, room: true };
            initProgressDialog({ title: 'Importing map data&hellip;', percent: 0, noClose: true });
        }

        function updateAreas() {
            $('#select-area option').remove();
            if (!mapper.ready) {
                setTimeout(updateAreas, 10);
                return;
            }
            let rows = mapper._db.prepare('SELECT DISTINCT Area from Rooms order by Area').all();
            let data = [];
            if (rows && rows.length > 0) {
                for (var a = 0; a < rows.length; a++) {
                    $('#select-area').append($('<option></option>').val(rows[a].Area).html(rows[a].Area));
                    data.push(rows[a].Area);
                }
                if (mapper.active.area)
                    $('#select-area').val(mapper.active.area);
                else
                    mapper.active.area = $('#select-area option:first').val();
            }

            $roomEditor.setPropertyOptions({
                property: 'area',
                group: 'Location',
                editor: {
                    type: EditorType.select,
                    options: {
                        data: data
                    }
                }
            });
        }
        function compact() {
            showProgress('Compacting map data&hellip;');
            mapper.compact();
            closeProgress();
        }

        function toggleEnabled() {
            mapper.enabled = !mapper.enabled;
            if (mapper.enabled)
                $('#btn-enable').addClass('active');
            else
                $('#btn-enable').removeClass('active');
            $('#btn-enable').prop('aria-pressed', mapper.enabled);
            menubar.updateItem('file|enabled', { checked: mapper.enabled });
        }

        function toggleFollow() {
            mapper.follow = !mapper.follow;
            if (mapper.follow)
                $('#btn-follow').addClass('active');
            else
                $('#btn-follow').removeClass('active');
            $('#btn-follow').prop('aria-pressed', mapper.follow);
            menubar.updateItem('actions|follow', { checked: mapper.follow });
        }

        function toggleLegend() {
            mapper.showLegend = !mapper.showLegend;
            if (mapper.showLegend)
                $('#btn-legend').addClass('active');
            else
                $('#btn-legend').removeClass('active');
            $('#btn-legend').prop('aria-pressed', mapper.showLegend);
            menubar.updateItem('view|legend', { checked: mapper.showLegend });
        }

        function toggleRooms() {
            $splitterEditor.panel2Collapsed = !$splitterEditor.panel2Collapsed;
            if (!$splitterEditor.panel2Collapsed) {
                $('#btn-room').addClass('active');
            }
            else {
                $('#btn-room').removeClass('active');
            }
            $(window).trigger('resize');
            window.opener.client.options.mapper.room = !$splitterEditor.panel2Collapsed;
            window.opener.client.saveOptions();
            $('#btn-room').prop('aria-pressed', !$splitterEditor.panel2Collapsed);
            menubar.updateItem('view|room properties', { checked: !$splitterEditor.panel2Collapsed });
        }

        function refreshMap() {
            saveRoom();
            mapper.refresh();
        }

        function toggleSplitArea() {
            mapper.splitArea = !mapper.splitArea;
            if (mapper.splitArea)
                $('#btn-split').addClass('active');
            else
                $('#btn-split').removeClass('active');
            $('#btn-split').prop('aria-pressed', mapper.splitArea);
            menubar.updateItem('view|split areas', { checked: mapper.splitArea });
        }

        function toggleFillWalls() {
            mapper.fillWalls = !mapper.fillWalls;
            if (mapper.fillWalls)
                $('#btn-fill').addClass('active');
            else
                $('#btn-fill').removeClass('active');
            $('#btn-fill').prop('aria-pressed', mapper.fillWalls);
            menubar.updateItem('view|fill walls', { checked: mapper.fillWalls });
        }

        function exportImage() {
            clearButton('#export');
            dialog.showSaveDialog({
                title: 'Export image',
                defaultPath: 'jiMUD' + (!mapper.SplitArea ? '' : '.' + mapper.active.area) + '.png',
                filters: [

                    { name: 'Images (*.png)', extensions: ['png'] },
                    { name: 'All files (*.*)', extensions: ['*'] },
                ]
            }).then((results) => {
                if (results.filePath === undefined || results.filePath.length === 0) {
                    return;
                }
                window.show();
                window.setProgressBar(0);
                _progress = { action: 3, file: results.filePath };
                initProgressDialog({ title: 'Exporting image&hellip;', percent: -1, cancelable: false });
            });

        }

        function _exportImage(file) {
            mapper.getRooms(mapper.active.area, mapper.active.z, mapper.active.zone, (rooms) => {
                if (!rooms || rooms.length === 0) {
                    if (_progress.dialog)
                        ipcRenderer.send('progress', 'close');
                    window.setProgressBar(-1);
                    dialog.showMessageBox({
                        type: 'error',
                        title: 'Error generating',
                        message: 'Could not generate map'
                    });
                    return;
                }
                var x = null, y = 0, w = 0, h = 0, room, cx, cy, rms;
                var t = mapper.active.area == null ? '' : mapper.active.area;
                if (!mapper.SplitArea)
                    t = '';
                for (rms in rooms) {
                    if (!Object.prototype.hasOwnProperty.call(rooms, rms)) continue;
                    room = rooms[rms];
                    if (room == null) continue;
                    if (x == null) {
                        x = room.x;
                        w = room.x + 1;
                        y = room.y;
                        h = room.y + 1;
                        continue;
                    }
                    if (room.x < x) x = room.x; else if (room.x > w) w = room.x;
                    if (room.y < y) y = room.y; else if (room.y > h) h = room.y;
                }
                mapper._context.font = 'italic bold 16pt Georgia';
                var fx = mapper._context.measureText(t).width;
                var rw = 32 * mapper.scale / 100;
                var rectWidth = Math.sqrt(Math.pow(w - x, 2)) * rw + 60 + 32;
                var rectHeight = Math.sqrt(Math.pow(y - h, 2)) * rw + 60 + 32;
                if (rectWidth < fx) rectWidth = fx + 60;
                if (mapper.ShowLegend) {
                    rectWidth += 155;
                    if (rectHeight < 200) rectHeight = 200;
                }
                var canvas = document.createElement('canvas');
                canvas.width = rectWidth;
                canvas.height = rectHeight;

                var ctx;
                if (canvas && canvas.getContext)
                    ctx = canvas.getContext('2d');
                else {
                    dialog.showMessageBox({
                        type: 'error',
                        title: 'Error generating',
                        message: 'Could not generate map'
                    });
                    return;
                }
                ctx.strokeStyle = 'black';

                ctx.fillStyle = '#eae4d6';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.font = '8pt Arial';
                for (rms in rooms) {
                    if (!Object.prototype.hasOwnProperty.call(rooms, rms)) continue;
                    room = rooms[rms];
                    //no room
                    if (room == null) continue;
                    cx = (room.x - x) * rw + 30.5;
                    cy = (room.y - y) * rw + 30.5;
                    mapper.DrawNormalizedRoom(ctx, cx, cy, room, true);
                }
                ctx.save();
                ctx.strokeStyle = 'black';
                ctx.fillStyle = 'black';
                ctx.font = 'italic bold 16pt Georgia';
                fx = rectWidth / 2 - fx / 2;
                ctx.fillText(t, fx, 20);
                ctx.translate(rectWidth - 25, rectHeight - 25);
                ctx.font = 'italic bold 12pt Georgia';
                ctx.fillText('N', 3, -5);
                ctx.beginPath();
                ctx.moveTo(10, 0);
                ctx.lineTo(5, 15);
                ctx.lineTo(10, 20);
                ctx.lineTo(15, 15);
                ctx.lineTo(10, 0);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
                ctx.restore();
                mapper.DrawLegend(ctx, rectWidth - 185, -10, 1);
                fs.writeFile(file, nativeImage.createFromDataURL(canvas.toDataURL('image/png')).toPNG(), err => {
                    if (err)
                        dialog.showMessageBox({
                            type: 'error',
                            title: 'Error generating',
                            message: 'Could not save map'
                        });
                    if (_progress.dialog)
                        ipcRenderer.send('progress', 'close');
                    window.setProgressBar(-1);
                });
            });
        }

        function exportCurrentImage() {
            clearButton('#export');
            dialog.showSaveDialog({
                title: 'Export clipped view',
                defaultPath: 'jiMUD.clipped.png',
                filters: [

                    { name: 'Images (*.png)', extensions: ['png'] },
                    { name: 'All files (*.*)', extensions: ['*'] },
                ]
            }).then(results => {
                if (results.filePath === undefined || results.filePath.length === 0) {
                    return;
                }
                window.show();
                window.setProgressBar(0);
                _progress = { action: 4, file: results.filePath };
                initProgressDialog({ title: 'Exporting image&hellip;', percent: -1, cancelable: false });
            });
        }

        function _exportCurrentImage(file) {
            var oldCanvas = document.getElementById('MapperCanvas');
            var newCanvas = document.createElement('canvas');
            var context = newCanvas.getContext('2d');
            newCanvas.width = oldCanvas.width;
            newCanvas.height = oldCanvas.height;
            mapper.draw(newCanvas, context, true, () => {
                fs.writeFile(file, nativeImage.createFromDataURL(newCanvas.toDataURL('image/png')).toPNG(), err => {
                    if (err)
                        dialog.showMessageBox({
                            type: 'error',
                            title: 'Error generating',
                            message: 'Could not save map'
                        });
                    if (_progress.dialog)
                        ipcRenderer.send('progress', 'close');
                    window.setProgressBar(-1);
                });
            });
        }

        function exportCurrentArea() {
            clearButton('#export');
            dialog.showSaveDialog({
                title: 'Export current area',
                defaultPath: 'jiMUD.' + mapper.active.area + '.txt',
                filters: [
                    { name: 'Text files (*.txt)', extensions: ['txt'] },
                    { name: 'All files (*.*)', extensions: ['*'] },
                ]
            }).then(results => {
                if (results.filePath === undefined || results.filePath.length === 0) {
                    return;
                }
                window.opener.updateProgress(0);
                window.setProgressBar(0);
                _progress = { action: 1, file: results.filePath };
                showProgress('Exporting area data&hellip;', true);
                mapper.exportArea(_progress.file);
            });
        }

        function exportAll() {
            clearButton('#export');
            dialog.showSaveDialog({
                title: 'Export all',
                defaultPath: 'jiMUD.txt',
                filters: [
                    { name: 'Text files (*.txt)', extensions: ['txt'] },
                    { name: 'All files (*.*)', extensions: ['*'] },
                ]
            }).then(results => {
                if (results.filePath === undefined || results.filePath.length === 0) {
                    return;
                }
                window.opener.updateProgress(0);
                window.setProgressBar(0);
                _progress = { action: 2, file: results.filePath };
                showProgress('Exporting map data&hellip;', true);
                mapper.exportAll(_progress.file);
            });
        }

        function importMerge() {
            clearButton('#export');
            dialog.showOpenDialog({
                filters: [
                    { name: 'Text files (*.txt)', extensions: ['txt'] },
                    { name: 'All files (*.*)', extensions: ['*'] },
                ]
            }).then(result => {
                if (result.filePaths === undefined || result.filePaths.length === 0) {
                    return;
                }
                for (var f = 0, fl = result.filePaths.length; f < fl; f++)
                    fs.readFile(result.filePaths[f], (err, data) => {
                        if (err) throw err;
                        data = JSON.parse(data);
                        if (!data) {
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Invalid map data',
                                message: 'Invalid map data unable to process.'
                            });
                            return;
                        }
                        window.setProgressBar(0);
                        _progress = { action: 0, data: data, type: ImportType.Merge };
                        initProgressDialog({ title: 'Importing map data&hellip;', percent: 0, noClose: true });
                    });
            });
        }

        function importReplace() {
            clearButton('#export');
            dialog.showOpenDialog({
                filters: [
                    { name: 'Text files (*.txt)', extensions: ['txt'] },
                    { name: 'All files (*.*)', extensions: ['*'] },
                ]
            }).then(result => {
                if (result.filePaths === undefined || result.filePaths.length === 0) {
                    return;
                }
                for (var f = 0, fl = result.filePaths.length; f < fl; f++)
                    fs.readFile(result.filePaths[f], (err, data) => {
                        if (err) throw err;
                        data = JSON.parse(data);
                        if (!data) {
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Invalid map data',
                                message: 'Invalid map data unable to process.'
                            });
                            return;
                        }
                        window.setProgressBar(0);
                        _progress = { action: 0, data: data, type: ImportType.Replace };
                        initProgressDialog({ title: 'Importing map data&hellip;', percent: 0, noClose: true });
                    });
            });
        }

        function removeSelectedRoom() {
            clearButton('#remove');
            dialog.showMessageBox({
                type: 'question',
                title: 'Remove selected room',
                message: 'Are you sure you want to remove selected room?',
                buttons: ['Yes', 'No'],
                defaultId: 1,
                noLink: true
            }).then(result => {
                if (result.response === 0)
                    mapper.clearSelectedRoom();
            });
        }

        function removeCurrentRoom() {
            clearButton('#remove');
            dialog.showMessageBox({
                type: 'question',
                title: 'Remove current room',
                message: 'Are you sure you want to remove current room?',
                buttons: ['Yes', 'No'],
                defaultId: 1,
                noLink: true
            }).then(result => {
                if (result.response === 0)
                    mapper.clearRoom();
            });
        }

        function removeCurrentArea() {
            clearButton('#remove');
            dialog.showMessageBox({
                type: 'question',
                title: 'Remove ' + mapper.active.area,
                message: 'Are you sure you want to remove all rooms from ' + mapper.active.area + '?',
                buttons: ['Yes', 'No'],
                defaultId: 1,
                noLink: true
            }).then(result => {
                if (result.response === 0)
                    mapper.clearArea();
            });
        }

        function removeAll() {
            clearButton('#remove');
            dialog.showMessageBox({
                type: 'question',
                title: 'Remove all',
                message: 'Are you sure you want to remove all rooms?',
                buttons: ['Yes', 'No'],
                defaultId: 1,
                noLink: true
            }).then(result => {
                if (result.response === 0)
                    mapper.clearAll();
            });
        }

        function resetMap() {
            clearButton('#remove');
            dialog.showMessageBox({
                type: 'question',
                title: 'Reset map',
                message: 'This will delete your map data file and recreate a fresh new one, do you want do delete your file?',
                buttons: ['Yes', 'No'],
                defaultId: 1,
                noLink: true
            }).then(result => {
                if (result.response === 0)
                    mapper.resetMap();
            });
        }

        function showProgress(title, cancel) {
            menubar.enabled = false;
            window.opener.updateProgress(0);
            window.setProgressBar(0);
            $('#mapProgressbar').html('<progress max="100"></progress>');
            $('#mapProgressTitle').html(title);
            if (cancel)
                $('#mapProgressCancel').css('display', '');
            else
                $('#mapProgressCancel').css('display', 'none');
            $('#mapProgress')[0].showModal();
        }

        function closeProgress() {
            menubar.enabled = true;
            if ($('#mapProgress')[0].open)
                $('#mapProgress')[0].close();
            window.opener.updateProgress(-1);
            window.setProgressBar(-1);
        }

        function zoomMap(amt, rng) {
            if (amt < 25)
                amt = 25;
            else if (amt > 200)
                amt = 200;
            mapper.scale = parseInt(amt, 10);
            if (!rng)
                $('#MapZoom').val(amt);
            $('#MapZoomDisplay').text(amt + '%');
        }

        ipcRenderer.on('progress', (event, ...args) => {
            if (args[0] === 'canceled' || args[0] === 'closed') {
                if (_progress.action < 3)
                    mapper.cancelImport();
                delete _progress.dialog;
            }
            else if (args[0] === 'loaded') {
                ipcRenderer.send('progress', 'update', _progress.dialog);
                _progress.dialog = true;
                if (_progress.action === 0) {
                    mapper.import(_progress.data, _progress.type);
                    if (_progress.room)
                        window.opener.client.sendGMCP('Room.Info');
                }
                else if (_progress.action === 1)
                    mapper.exportArea(_progress.file);
                else if (_progress.action === 2)
                    mapper.exportAll(_progress.file);
                else if (_progress.action === 3)
                    _exportImage(_progress.file);
                else if (_progress.action === 4)
                    _exportCurrentImage(_progress.file);
            }
        });
    </script>
</body>

</html>
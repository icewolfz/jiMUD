<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>Immortal Tools</title>
    <link rel="shortcut icon" href="../assets/icons/png/ied.png" />
    <link href="../lib/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-select.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-treeview.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/immortal.css" rel="stylesheet" type="text/css" />
    <link href="css/form.css" rel="stylesheet" type="text/css" />
    <link href="../lib/datatables.min.css" rel="stylesheet" type="text/css" />
    <script>
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="../lib/jquery.min.js" type="text/javascript"></script>
    <script src="../lib/bootstrap.min.js" type="text/javascript"></script>
    <script src="../lib/bootstrap-select.min.js" type="text/javascript"></script>
    <script src="../lib/datatables.min.js" type="text/javascript"></script>
    <script src="../lib/datatables.scrollresize.js" type="text/javascript"></script>
    <script src="../lib/bootstrap-treeview.min.js"></script>
    <script src="../lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="../lib/ace/ext-statusbar.js" type="text/javascript"></script>
    <script src="../lib/ace/ext-language_tools.js" type="text/javascript"></script>
    <script src="../lib/ace/ext-settings_menu.js" type="text/javascript"></script>
    <script src="../lib/ace/ext-themelist.js" type="text/javascript"></script>
    <script src="../lib/ace/ext-modelist.js" type="text/javascript"></script>
    <script>
        const { remote, ipcRenderer, shell, clipboard } = require('electron');
        const { app, dialog, Menu, MenuItem } = remote;
        const { Menubar } = require('./js/menubar');
        const { parseTemplate, existsSync } = require('./js/library');
        const { Settings } = require('./js/settings');
        const fs = require('fs-extra');
        const child_process = require('child_process');
        const path = require('path');
        const drivelist = require('drivelist');
        const moment = require('moment');

        var chokidar = require('chokidar');

        var options, _updating;

        var menubar = new Menubar([
            {
                label: '&File',
                id: 'file',
                submenu: [
                    {
                        label: '&Upload',
                        accelerator: "CmdOrCtrl+U",
                        enabled: false,
                    },
                    { type: 'separator' },
                    {
                        label: '&Preferences...',
                        accelerator: "CmdOrCtrl+Comma",
                        click: () => {
                            window.open('immortal.prefs.html', 'modal', 'backgroundColor=#fff,height=300,width=600,icon=' + path.join(__dirname, '../assets/icons/png/preferences.png'));
                        }
                    },
                    { type: 'separator' },
                    {
                        label: '&Close',
                        click: () => { window.close(); }
                    }
                ]
            },
            {
                label: '&View',
                submenu: [
                    {
                        role: 'toggledevtools'
                    },
                    {
                        type: 'separator'
                    },
                    {
                        role: 'resetzoom'
                    },
                    {
                        role: 'zoomin'
                    },
                    {
                        role: 'zoomout'
                    },
                ]
            },

        ]);

        // List all files in a directory in Node.js recursively in a synchronous fashion
        var walkSync = function (dir, fileList, dirList, empty) {
            var path = path || require('path');
            var fs = fs || require('fs'),
                files = fs.readdirSync(dir);
            fileList = fileList || [];
            dirList = dirList || [];
            empty = empty || [];
            if (files.length == 0)
                empty.push(dir);
            files.forEach(function (file) {
                if (fs.statSync(path.join(dir, file)).isDirectory()) {
                    dirList.push(path.join(dir, file));
                    var t = walkSync(path.join(dir, file), fileList, dirList, empty);
                    fileList = t.files;
                    dirList = t.dirs;
                    empty = t.empty;
                }
                else {
                    fileList.push(path.join(dir, file));
                }
            });
            return { files: fileList, dirs: dirList, empty: empty };
        };

        var walk = function (dir, callback) {
            var path = path || require('path');
            var fs = fs || require('fs');
            fs.readdir(dir, (err, files) => {
                var fileList = [];
                var dirList = [];
                var empty = [];
                if (files.length == 0)
                    empty.push(dir);
                files.forEach(function (file) {
                    if (fs.statSync(path.join(dir, file)).isDirectory()) {
                        dirList.push(path.join(dir, file));
                        var t = walkSync(path.join(dir, file), fileList, dirList, empty);
                        fileList = t.files;
                        dirList = t.dirs;
                        empty = t.empty;
                    }
                    else {
                        fileList.push(path.join(dir, file));
                    }
                });
                if (callback)
                    callback(fileList, dirList, empty);

            });
        };

        (function () {
            /*
                     * Natural Sort algorithm for Javascript - Version 0.7 - Released under MIT license
                     * Author: Jim Palmer (based on chunking idea from Dave Koelle)
                     * Contributors: Mike Grier (mgrier.com), Clint Priest, Kyle Adams, guillermo
                     * See: http://js-naturalsort.googlecode.com/svn/trunk/naturalSort.js
                     */
            function naturalSort(a, b, html) {
                var re = /(^-?[0-9]+(\.?[0-9]*)[df]?e?[0-9]?%?$|^0x[0-9a-f]+$|[0-9]+)/gi,
                    sre = /(^[ ]*|[ ]*$)/g,
                    dre = /(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[/-]\d{1,4}[/-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,
                    hre = /^0x[0-9a-f]+$/i,
                    ore = /^0/,
                    htmre = /(<([^>]+)>)/ig,
                    // convert all to strings and trim()
                    x = a.toString().replace(sre, '') || '',
                    y = b.toString().replace(sre, '') || '';
                // remove html from strings if desired
                if (!html) {
                    x = x.replace(htmre, '');
                    y = y.replace(htmre, '');
                }
                // chunk/tokenize
                var xN = x.replace(re, '\0$1\0').replace(/\0$/, '').replace(/^\0/, '').split('\0'),
                    yN = y.replace(re, '\0$1\0').replace(/\0$/, '').replace(/^\0/, '').split('\0'),
                    // numeric, hex or date detection
                    xD = parseInt(x.match(hre), 10) || (xN.length !== 1 && x.match(dre) && Date.parse(x)),
                    yD = parseInt(y.match(hre), 10) || xD && y.match(dre) && Date.parse(y) || null;

                // first try and sort Hex codes or Dates
                if (yD) {
                    if (xD < yD) {
                        return -1;
                    }
                    else if (xD > yD) {
                        return 1;
                    }
                }

                // natural sorting through split numeric strings and default strings
                for (var cLoc = 0, numS = Math.max(xN.length, yN.length); cLoc < numS; cLoc++) {
                    // find floats not starting with '0', string or 0 if not defined (Clint Priest)
                    var oFxNcL = !(xN[cLoc] || '').match(ore) && parseFloat(xN[cLoc], 10) || xN[cLoc] || 0;
                    var oFyNcL = !(yN[cLoc] || '').match(ore) && parseFloat(yN[cLoc], 10) || yN[cLoc] || 0;
                    // handle numeric vs string comparison - number < string - (Kyle Adams)
                    if (isNaN(oFxNcL) !== isNaN(oFyNcL)) {
                        return (isNaN(oFxNcL)) ? 1 : -1;
                    }
                    // rely on string comparison if different types - i.e. '02' < 2 != '02' < '2'
                    else if (typeof oFxNcL !== typeof oFyNcL) {
                        oFxNcL += '';
                        oFyNcL += '';
                    }
                    if (typeof oFxNcL === 'string') {
                        oFxNcL = oFxNcL.toLowerCase();
                        oFyNcL = oFyNcL.toLowerCase();
                    }
                    if (oFxNcL < oFyNcL) {
                        return -1;
                    }
                    if (oFxNcL > oFyNcL) {
                        return 1;
                    }
                }
                return 0;
            }

            jQuery.extend(jQuery.fn.dataTableExt.oSort, {
                "moment-asc": function (a, b) {
                    if (moment(a).isBefore(b))
                        return -1;
                    if (moment(b).isBefore(a))
                        return 1;
                    return 0;
                },

                "moment-desc": function (a, b) {
                    if (moment(a).isBefore(b))
                        return 1;
                    if (moment(b).isBefore(a))
                        return -1;
                    return 0;
                },

            });

            jQuery.fn.dataTable.ext.type.order['file-size-pre'] = function (data) {
                var matches = data.match(/^(\d+(?:\.\d+)?)\s*([a-z]+)/i);
                var multipliers;

                if (process.platform === 'darwin')
                    multipliers = {
                        b: 1,
                        bytes: 1,
                        kb: 1000,
                        kib: 1024,
                        mb: 1000000,
                        mib: 1048576,
                        gb: 1000000000,
                        gib: 1073741824,
                        tb: 1000000000000,
                        tib: 1099511627776,
                        pb: 1000000000000000,
                        pib: 1125899906842624
                    };
                else
                    multipliers = {
                        b: 1,
                        bytes: 1,
                        kb: 1024,
                        kib: 1024,
                        mb: 1048576,
                        mib: 1048576,
                        gb: 1073741824,
                        gib: 1073741824,
                        tb: 1099511627776,
                        tib: 1099511627776,
                        pb: 1125899906842624,
                        pib: 1125899906842624
                    };

                if (matches) {
                    var multiplier = multipliers[matches[2].toLowerCase()];
                    return parseFloat(matches[1]) * multiplier;
                } else {
                    return -1;
                }
            };
        }());

        function formatSize(size) {
            if (size >= 1073741824)
                return Math.round(size / 1073741824).toLocaleString() + " GB";
            else if (size >= 1048576)
                return Math.round(size / 1048576).toLocaleString() + " MB";
            else if (size >= 1024)
                return Math.round(size / 1024).toLocaleString() + " KB";
            return size + " B";
        }

        function loadOptions(data) {
            if (!data) {
                var set = Settings.load(remote.getGlobal('settingsFile'));
                options = set.extensions["immortal-editor"];
            }
            else
                options = data;
            if (!options) {
                options = {
                };
                saveOptions();
            }
            doUpdate(14);
        }

        function saveOptions() {
            ipcRenderer.send('setting-changed', { type: 'extensions', name: 'immortal-editor', value: options });
        }

        $(document).ready(() => {
            loadOptions();

            $(document).keydown((event) => {

            });
            $(window).on('resize', () => {

                doUpdate(14);
            });

            $(window).trigger('resize');

            window.onbeforeunload = function () {

            };
        });

        ipcRenderer.on('GMCP-received', (event, data) => {
            if (options && options.debug)
                console.log(data);
            //if (_ied)
            //_ied.processGMCP(data.mod, data.obj);
        });

        ipcRenderer.on('reload-options', (event) => {
            loadOptions();
        });

        ipcRenderer.on('setting-changed', (event, data) => {
            if (data.type === "extensions" && data.name === "immortal") {
                loadOptions(data.value);
            }
        });

        function doUpdate(type) {
            if (!type) return;
            _updating |= type;
            if (_updating === 0)
                return;
            window.requestAnimationFrame(() => {
                if ((this._updating & 1) === 1) {

                    _updating &= ~1;
                }
                if ((this._updating & 2) === 2) {

                    _updating &= ~2;
                }
                if ((this._updating & 4) === 4) {

                    _updating &= ~4;
                }
                if ((this._updating & 8) === 8) {

                    _updating &= ~8;
                }
                if ((this._updating & 16) === 16) {

                    _updating &= ~16;
                }
                if ((this._updating & 32) === 32) {
                    _updating &= ~32;
                }
                if ((this._updating & 64) === 64) {
                    _updating &= ~64;
                }
                if ((this._updating & 128) === 128) {

                    _updating &= ~128;
                }
                if ((this._updating & 256) === 256) {
                    _updating &= ~256;
                }
                doUpdate(_updating);
            });
        }
    </script>
</head>

<body>

</body>

</html>
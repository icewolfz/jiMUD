"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const buzz=require("buzz"),path=require("path"),fs=require("fs"),EventEmitter=require("events"),library_1=require("./library");var ParseMode;(function(a){a[a["default"]=0]="default",a[a.inline=1]="inline",a[a.strict=2]="strict"})(ParseMode||(ParseMode={}));class SoundState extends EventEmitter{constructor(){super(...arguments),this._file="",this._repeats=1,this._volume=100,this._priority=50,this.current=0,this.sound=null,this.playing=!1,this.url="",this.continue=!0}set file(a){this.continue||this.close(),this._file=a}get file(){return this._file}set repeats(a){this._repeats=-1<=a?a:1,this.current=0}get repeats(){return this._repeats}set volume(a){this._volume=0<=a&&100>=a?a:1}get volume(){return this._volume}set priority(a){this._priority=0<=a&&100>=a?a:50}get priority(){return this._priority}play(){this.playing=!0,0<this._repeats&&this.current<this._repeats?(this.current++,this.close(),this.open(),this.sound.setVolume(this._volume).play(),this.current<this._repeats?this.sound.bind("ended abort",()=>{this.play()}):this.sound.bind("ended abort",()=>{this.playing=!1,this.emit("ended")}),this.sound.isEnded()&&(this.playing=!1)):-1===this._repeats?(this.close(),this.open(),this.sound.setVolume(this._volume).loop().play(),this.sound.isEnded()&&(this.playing=!1)):this.playing=!1}open(){this.close(),this.sound=new buzz.sound(this.url+this._file),this.sound.bind("play",()=>{this.emit("playing",{file:this._file,sound:this.sound,state:this,duration:buzz.toTimer(this.sound.getDuration())})}),this.emit("opened")}close(){this.sound&&(this.stop(),delete this.sound,this.sound=null),this.emit("closed")}stop(){this.sound&&this.sound.stop(),this.playing=!1,this.emit("stopped")}}class MSP extends EventEmitter{constructor(){super(),this.enabled=!0,this.server=!1,this.enableDebug=!1,this.savePath="",this.defaultSoundURL="",this.defaultMusicURL="",this.forcedDefaultMusicURL="http://"+window.location.hostname+"/sounds/",this.forcedDefaultSoundURL="http://"+window.location.hostname+"/sounds/",this.defaultSoundExt=".m4a",this.defaultMusicExt=".m4a",this.MusicState=new SoundState,this.SoundState=new SoundState,this.parseMode=ParseMode.default,this.MusicState.on("playing",(a)=>{a.type=1,this.emit("playing",a)}),this.SoundState.on("playing",(a)=>{a.type=0,this.emit("playing",a)})}getArguments(a,b){for(var k,l,m,d={off:!1,file:"",url:"",volume:100,repeat:1,priority:50,type:"",continue:!0},f=[],g=0,h=[],i=0,j=a.length;i<j;i++)switch(k=a.charAt(i),g){case 1:"\""==k?(g=0,h.push(k)):h.push(k);break;case 2:"'"==k?(g=0,h.push(k)):h.push(k);break;default:" "==k?(f.push(h.join("")),h=[]):"\""==k?(g=1,h.push(k)):"'"==k?(g=2,h.push(k)):h.push(k);}for(0<h.length&&(f.push(h.join("")),h=[]),i=0,j=f.length,this.enableDebug&&this.emit("debug","MSP arguments found: "+f),i=0;i<j;i++)if(l=f[i].split("="),1<l.length)switch(l[0].toUpperCase()){case"FNAME":d.file=library_1.stripQuotes(l[1]),"off"==d.file.toLowerCase()&&(d.off=!0,d.file="");break;case"V":m=parseInt(l[1],10),isNaN(m)&&(m=100),d.volume=m;break;case"L":m=parseInt(l[1],10),isNaN(m)&&(m=1),d.repeat=m;break;case"P":m=parseInt(l[1],10),isNaN(m)&&(m=1),d.priority=m;break;case"C":d.continue="0"!=l[1];break;case"T":0<l[1].length&&(d.type=l[1]);break;case"U":d.url=library_1.stripQuotes(l[1]),!d.url.endsWith("/")&&0<d.url.length&&(d.url+="/");}else 0==i?(d.file=library_1.stripQuotes(f[i]),"off"==d.file.toLowerCase()&&(d.off=!0,d.file="")):1==i?(m=parseInt(f[i],10),isNaN(m)&&(m=100),d.volume=m):2==i?(m=parseInt(f[i],10),isNaN(m)&&(m=1),d.repeat=m):3==i&&1===b?d.continue="0"!=f[i]:3==i?(m=parseInt(f[i],10),isNaN(m)&&(m=1),d.priority=m):4==i?0<f[i].length&&(d.type=f[i]):5==i&&(d.url=library_1.stripQuotes(f[i]),!d.url.endsWith("/")&&0<d.url.length&&(d.url+="/"));return this.enableDebug&&this.emit("debug",d),d}reset(){this.server=!1}music(a){if(!this.enabled)return!1;if(!a.file||0===a.file.length)return void(a.off&&a.url&&0<a.url.length?this.defaultMusicURL=a.url:a.off&&this.MusicState.stop());if(a.off)return void this.MusicState.stop();this.MusicState.volume=a.volume,this.MusicState.repeats=a.repeat,this.MusicState.continue=a.continue;var b=this.MusicState.file;this.MusicState.file=-1===a.file.lastIndexOf(".")?a.file+this.defaultMusicExt:a.file,a.url&&0<a.url.length?this.MusicState.url=a.url:this.forcedDefaultMusicURL&&0<this.forcedDefaultMusicURL.length?this.MusicState.url=this.forcedDefaultMusicURL:this.defaultMusicURL&&0<this.defaultMusicURL.length&&(this.MusicState.url=this.defaultMusicURL),0<this.MusicState.url.length&&!this.MusicState.url.endsWith("/")&&(this.MusicState.url+="/"),a.type&&0<a.type.length&&(this.MusicState.url+=a.type,0<this.MusicState.url.length&&!this.MusicState.url.endsWith("/")&&(this.MusicState.url+="/")),b===this.MusicState.file&&a.continue&&this.MusicState.playing||this.MusicState.play()}sound(a){if(!this.enabled)return!1;if(!a.file||0===a.file.length)return void(a.off&&a.url&&0<a.url.length?this.defaultSoundURL=a.url:a.off&&this.SoundState.stop());if(a.off)return void this.SoundState.stop();if(this.SoundState.playing&&a.priority<this.SoundState.priority)return!1;this.SoundState.volume=a.volume,this.SoundState.repeats=a.repeat,this.SoundState.priority=a.priority;this.SoundState.file;this.SoundState.file=-1===a.file.lastIndexOf(".")?a.file+this.defaultSoundExt:a.file,a.url&&0<a.url.length?this.SoundState.url=a.url:this.forcedDefaultSoundURL&&0<this.forcedDefaultSoundURL.length?this.SoundState.url=this.forcedDefaultSoundURL:this.defaultSoundURL&&0<this.defaultSoundURL.length&&(this.SoundState.url=this.defaultSoundURL),0<this.SoundState.url.length&&!this.SoundState.url.endsWith("/")&&(this.SoundState.url+="/"),a.type&&0<a.type.length&&(this.SoundState.url+=a.type,0<this.SoundState.url.length&&!this.SoundState.url.endsWith("/")&&(this.SoundState.url+="/")),this.SoundState.play()}processOption(a){90===a.option&&(this.enableDebug&&this.emit("Debug","<MSP>"),253===a.verb?(this.server=!0,this.enabled?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MSP>"),a.telnet.sendData([255,251,90],!0)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSP>"),a.telnet.sendData([255,254,90],!0))):254===a.verb?(this.server=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MSP>"),a.telnet.sendData([255,252,90],!0)):251===a.verb?(this.server=!0,this.enabled?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MSP>"),a.telnet.sendData([255,253,90],!0)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSP>"),a.telnet.sendData([255,254,90],!0))):252===a.verb&&(this.server=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSP>"),a.telnet.sendData([255,254,90],!0)),a.handled=!0)}}exports.MSP=MSP;
"use strict";var _Mathsqrt=Math.sqrt,_Mathpow=Math.pow,_MathPI=Math.PI,_Mathfloor=Math.floor;Object.defineProperty(exports,"__esModule",{value:!0});const EventEmitter=require("events"),library_1=require("./library"),fs=require("fs"),path=require("path"),sqlite3=require("sqlite3"),PF=require("./../../lib/pathfinding.js");var RoomDetails;(function(t){t[t.None=0]="None",t[t.Dock=1]="Dock",t[t.Pier=2]="Pier",t[t.Bank=4]="Bank",t[t.Shop=8]="Shop",t[t.Hospital=16]="Hospital",t[t.Bar=32]="Bar",t[t.Restaurant=64]="Restaurant",t[t.WaterSource=128]="WaterSource",t[t.Trainer=256]="Trainer"})(RoomDetails=exports.RoomDetails||(exports.RoomDetails={}));var RoomExits;(function(t){t[t.northwest=1]="northwest",t[t.north=128]="north",t[t.northeast=64]="northeast",t[t.west=2]="west",t[t.east=32]="east",t[t.southwest=4]="southwest",t[t.south=8]="south",t[t.southeast=16]="southeast",t[t.up=512]="up",t[t.down=256]="down"})(RoomExits=exports.RoomExits||(exports.RoomExits={}));var ImportType;(function(t){t[t.Merge=0]="Merge",t[t.Replace=1]="Replace"})(ImportType=exports.ImportType||(exports.ImportType={}));class Rectangle{get top(){return this.location?this.location.y:0}get left(){return this.location?this.location.x:0}get right(){return this.location&&this.size?this.location.x+this.size.width:0}get bottom(){return this.location&&this.size?this.location.y+this.size.height:0}constructor(t,o,l,a){this.location=new Point(t,o),this.size=new library_1.Size(l,a)}}class Point{constructor(t,o){this.x=0,this.y=0,this.x=t,this.y=o}}class Room{constructor(){this.ID=null,this.x=0,this.y=0,this.z=0,this.area=null,this.zone=0}}class Mapper extends EventEmitter{constructor(t){super(),this._redraw=!1,this.MouseDrag={x:0,y:0,button:0,state:!1},this.drag=!1,this.vscroll=0,this.hscroll=0,this.markers={},this._cancelImport=!1,this._showLegend=!1,this._splitArea=!1,this._fillWalls=!1,this._enabled=!0,this._follow=!0,this.commandDelay=500,this.commandDelayCount=5,this._canvas=t,this._context=t.getContext("2d"),this._db=new sqlite3.Database(path.join(library_1.parseTemplate("{data}"),"map.sqlite")),this._db.serialize(()=>{this._db.run("PRAGMA synchronous=OFF;PRAGMA temp_store=MEMORY;PRAGMA threads = 4;"),this._db.run("CREATE TABLE IF NOT EXISTS Rooms (ID TEXT PRIMARY KEY ASC, Area TEXT, Details INTEGER, Name TEXT, Env TEXT, X INTEGER, Y INTEGER, Z INTEGER, Zone INTEGER, Indoors INTEGER, Background TEXT, Notes TEXT)"),this._db.run("CREATE TABLE IF NOT EXISTS Exits (ID TEXT, Exit TEXT, DestID TEXT, IsDoor INTEGER, IsClosed INTEGER)"),this._db.run("CREATE UNIQUE INDEX IF NOT EXISTS index_id on Rooms (ID);"),this._db.run("CREATE INDEX IF NOT EXISTS exits_id on Exits (ID);")}),this._db.serialize(),$(this._canvas).mousemove((o)=>{if(this.MousePrev=this.Mouse,this.Mouse=this.getMapMousePos(o),this.drag){this.MouseDrag.x+=this.MousePrev.x-this.Mouse.x,this.MouseDrag.y+=this.MousePrev.y-this.Mouse.y;var l=_Mathfloor(this.MouseDrag.x/32),a=_Mathfloor(this.MouseDrag.y/32);(0<l||0>l||0>a||0<a)&&(this.MouseDrag.x-=32*l,this.MouseDrag.y-=32*a,this.scrollBy(l,a))}o.preventDefault()}),$(this._canvas).mousedown((o)=>{this.Mouse=this.getMapMousePos(o),this.MouseDown=this.getMapMousePos(o),this.MouseDrag.state=!0,this.drag=0==this.MouseDown.button,this.drag&&$(this._canvas).css("cursor","move")}),$(this._canvas).mouseup((o)=>{if(this.Mouse=this.getMapMousePos(o),this.MouseDown||(this.MouseDown=this.getMapMousePos(o)),0===this.Mouse.button&&_Mathfloor(this.Mouse.x/32)==_Mathfloor(this.MouseDown.x/32)&&_Mathfloor(this.Mouse.y/32)==_Mathfloor(this.MouseDown.y/32)){var l=this.Mouse.x,a=this.Mouse.y;this.findActiveRoomByCoords(l,a,(d)=>{this.selected&&d&&d.ID==this.selected.ID||(this.emit("room-before-selected",library_1.clone(this.selected)),this.selected=d,this.emit("room-selected",library_1.clone(d)),!this._redraw&&this.draw())})}this.MouseDrag.state=!1,this.drag=!1,$(this._canvas).css("cursor","default")}),$(this._canvas).mouseenter((o)=>{this.Mouse=this.getMapMousePos(o)}),$(this._canvas).mouseleave((o)=>{this.Mouse=this.getMapMousePos(o),this.drag&&(!this._redraw&&this.draw(),this.drag=!1,$(this._canvas).css("cursor","default"))}),$(this._canvas).bind("contextmenu",()=>{return!1}),$(this._canvas).click((o)=>{o.preventDefault()}),$(this._canvas).dblclick((o)=>{o.preventDefault()}),this._canvas.onselectstart=()=>{return!1},this.reset(),this.refresh()}set enabled(t){this._enabled!=t&&(this._enabled=t,this.emit("setting-changed","enabled",t))}get enabled(){return this._enabled}set follow(t){this._follow!=t&&(this._follow=t,this.emit("setting-changed","follow",t))}get follow(){return this._follow}set showLegend(t){this._showLegend!=t&&(this._showLegend=t,this.draw(),this.emit("setting-changed","legend",t))}get showLegend(){return this._showLegend}set splitArea(t){this._splitArea!=t&&(this._splitArea=t,this.draw(),this.emit("setting-changed","split",t))}get splitArea(){return this._splitArea}set fillWalls(t){this._fillWalls!=t&&(this._fillWalls=t,this.draw(),this.emit("setting-changed","fill",t))}get fillWalls(){return this._fillWalls}getMapMousePos(t){var o=this._canvas.getBoundingClientRect();return{x:t.clientX-o.left,y:t.clientY-o.top,button:t.button,state:!1}}scrollBy(t,o){this.vscroll+=t,this.hscroll+=o,this.draw(),this.emit("setting-changed","vscroll",this.vscroll),this.emit("setting-changed","hscroll",this.hscroll)}scrollTo(t,o){this.vscroll=t,this.hscroll=o,this.draw(),this.emit("setting-changed","vscroll",this.vscroll),this.emit("setting-changed","hscroll",this.hscroll)}findActiveRoomByCoords(t,o,l){var a=this.vscroll-this._canvas.width/32/2,n=this.hscroll-this._canvas.height/32/2,c=this.active.z,d=this.active.area,D=this.active.zone,u=15.5,m=15.5;0!=this._canvas.width%2&&(u=15),0!=this._canvas.height%2&&(m=15),a+=(t-u)/32,n+=(o-m)/32,a=_Mathfloor(a),n=_Mathfloor(n),this._splitArea?this._db.all("Select * FROM Rooms inner join exits on Exits.ID = Rooms.ID WHERE Area = $area AND Zone = $zone AND X = $x AND Y = $y AND Z = $z",{$area:d,$zone:D,$x:a,$y:n,$z:c},(I,R)=>{l&&(R&&0<R.length?l({ID:R[0].ID,x:R[0].X,y:R[0].Y,z:R[0].Z,area:R[0].Area,zone:R[0].Zone,background:R[0].Background,env:R[0].Env,indoors:R[0].Indoor,name:R[0].Name,details:R[0].Details,notes:R[0].Notes}):l(new Room))}):this._db.all("Select * FROM Rooms inner join exits on Exits.ID = Rooms.ID WHERE Zone = $zone AND X = $x AND Y = $y AND Z = $z",{$zone:D,$x:a,$y:n,$z:c},(I,R)=>{l&&(R&&0<R.length?l({ID:R[0].ID,x:R[0].X,y:R[0].Y,z:R[0].Z,area:R[0].Area,zone:R[0].Zone,background:R[0].Background,env:R[0].Env,indoors:R[0].Indoors,name:R[0].Name,details:R[0].Details,notes:R[0].Notes}):l(new Room))})}draw(t,o,l,a){if(t||(t=this._canvas),o||(o=this._context),l||(l=!1),t&&o){this._redraw=!0;var n=this.vscroll-t.width/32/2,c=this.hscroll-t.height/32/2,d=this.active.z||0,D=this.active.area||"",u=this.active.zone||0,m=15.5,I=15.5,E=t.width,p=t.height;0!=t.width%2&&(m=15),0!=t.height%2&&(I=15),o.font="8pt Arial",this._splitArea?this._db.all("Select * FROM Rooms inner join exits on Exits.ID = Rooms.ID WHERE Z = $z AND Area = $area AND Zone = $zone AND ((0 <= ((X - $x) * 32 + $ox) AND ((X - $x) * 32 + $ox) <= $w) AND (0 <= ((Y - $y) * 32 + $oy) AND ((Y - $y) * 32 + $oy) <= $h) OR (0 <= ((X - $x) * 32 + $ox) AND ((X - $x) * 32 + $ox) <= $w) AND (0 <= ((Y - $y) * 32 + $oy + 32) AND ((Y - $y) * 32 + $oy + 32) <= $h) OR (0 <= ((X - $x) * 32 + $ox + 32) AND ((X - $x) * 32 + $ox + 32) <= $w) AND (0 <= ((Y - $y) * 32 + $oy + 32) AND ((Y - $y) * 32 + $oy + 32) <= $h) OR (0 <= ((X - $x) * 32 + $ox + 32) AND ((X - $x) * 32 + $ox + 32) <= $w) AND (0 <= ((Y - $y) * 32 + $oy) AND ((Y - $y) * 32 + $oy) <= $h))",{$area:D,$zone:u,$x:n,$y:c,$z:d,$ox:m,$oy:I,$w:t.width,$h:t.height},(_,S)=>{o.save(),l?(o.fillStyle="#eae4d6",o.fillRect(0,0,t.width,t.height)):o.clearRect(0,0,t.width,t.height);var P={};if(S){for(var N=S.length,k=0;k<N;k++)P[S[k].ID]?P[S[k].ID].exits[S[k].Exit]={num:S[k].DestID,isdoor:S[k].IsDoor,isclosed:S[k].IsClosed}:(P[S[k].ID]=library_1.clone(S[k]),P[S[k].ID].exits={},P[S[k].ID].exits[S[k].Exit]={num:S[k].DestID,isdoor:S[k].IsDoor,isclosed:S[k].IsClosed});for(var M in P){var X=P[M];this.DrawRoom(o,32*(X.X-n)+m,32*(X.Y-c)+I,X,!1)}}o.restore(),this.DrawLegend(o,1,-4,0),this._redraw=!1,a&&a()}):this._db.all("Select * FROM Rooms inner join exits on Exits.ID = Rooms.ID WHERE Z = $z AND Zone = $zone AND ((0 <= ((X - $x) * 32 + $ox) AND ((X - $x) * 32 + $ox) <= $w) AND (0 <= ((Y - $y) * 32 + $oy) AND ((Y - $y) * 32 + $oy) <= $h) OR (0 <= ((X - $x) * 32 + $ox) AND ((X - $x) * 32 + $ox) <= $w) AND (0 <= ((Y - $y) * 32 + $oy + 32) AND ((Y - $y) * 32 + $oy + 32) <= $h) OR (0 <= ((X - $x) * 32 + $ox + 32) AND ((X - $x) * 32 + $ox + 32) <= $w) AND (0 <= ((Y - $y) * 32 + $oy + 32) AND ((Y - $y) * 32 + $oy + 32) <= $h) OR (0 <= ((X - $x) * 32 + $ox + 32) AND ((X - $x) * 32 + $ox + 32) <= $w) AND (0 <= ((Y - $y) * 32 + $oy) AND ((Y - $y) * 32 + $oy) <= $h))",{$zone:u,$x:n,$y:c,$z:d,$ox:m,$oy:I,$w:t.width,$h:t.height},(_,S)=>{o.save(),l?(o.fillStyle="#eae4d6",o.fillRect(0,0,t.width,t.height)):o.clearRect(0,0,t.width,t.height);var P={};if(S){for(var N=S.length,k=0;k<N;k++)P[S[k].ID]?P[S[k].ID].exits[S[k].Exit]={num:S[k].DestID,isdoor:S[k].IsDoor,isclosed:S[k].IsClosed}:(P[S[k].ID]=library_1.clone(S[k]),P[S[k].ID].exits={},P[S[k].ID].exits[S[k].Exit]={num:S[k].DestID,isdoor:S[k].IsDoor,isclosed:S[k].IsClosed});for(var M in P){var X=P[M];this.DrawRoom(o,32*(X.X-n)+m,32*(X.Y-c)+I,X,l)}}o.restore(),this.DrawLegend(o,1,-4,0),this._redraw=!1,a&&a()})}}reset(t){t&&1!=t||(this.current=new Room),t||(this.active=new Room,this.selected=new Room)}refresh(){this._redraw||this.draw(),this.emit("refresh")}focusCurrentRoom(){this.current.ID&&(this.active=library_1.clone(this.current)),this.focusActiveRoom()}focusActiveRoom(){this.scrollTo(this.active.x+2,this.active.y+2)}setCurrent(){this.emit("path-cleared"),this.current=this.sanatizeRoom(library_1.clone(this.selected)),this.markers={},this.draw()}setArea(t){this.active.area=t,null!==this.current.ID&&this.current.area==this.active.area?(this.active=this.sanatizeRoom(library_1.clone(this.current)),this.focusActiveRoom(),this.emit("setting-changed","active",this.active)):this._db.get("SELECT * from Rooms WHERE Area = ? ORDER BY X, Y, Z",[t],(o,l)=>{l&&(this.active.ID=l.ID,this.active.x=l.X,this.active.y=l.Y,this.active.z=l.Z,this.active.zone=l.Zone,this.active=this.sanatizeRoom(this.active),this.focusActiveRoom(),this.emit("setting-changed","active",this.active))})}setLevel(t){t!=this.active.z&&(this.active.z=t,this.draw(),this.emit("setting-changed","active",this.active))}setZone(t){t!=this.active.zone&&(this.active.zone=t,this.draw(),this.emit("setting-changed","active",this.active))}removeRoom(t){this._db.run("DELETE FROM Rooms WHERE ID = ?",[t.ID],()=>{this._db.run("Delete From Exits WHERE ID = ?",[t.ID],()=>{this.emit("remove-done",t),this.reset(1),this.refresh()})})}clearSelectedRoom(){this.removeRoom(this.selected)}clearRoom(){this.removeRoom(this.current)}clearArea(){this._db.run("DELETE FROM Exits WHERE ID in (Select ID from Rooms WHERE Area = ?)",[this.active.area],()=>{this._db.run("DELETE FROM Rooms WHERE Area = ?",[this.active.area],()=>{this.emit("clear-area-done",this.active.area),this.reset(),this.refresh()})})}clearAll(){this._db.run("DELETE FROM Exits",()=>{this._db.run("DELETE FROM Rooms",()=>{this.emit("clear-done"),this.reset(),this.refresh(),this.focusActiveRoom()})})}processData(t){try{this._db.all("Select * FROM Rooms where ID = '"+t.num+"'",(o,l)=>{var a;if(!l||0==l.length){if(a={area:"",details:0,exits:{},name:"",num:0,env:"",x:0,y:0,z:0,zone:0},null!==this.current.ID){switch(t.prevroom.dir){case"west":a.x--;break;case"east":a.x++;break;case"north":a.y--;break;case"south":a.y++;break;case"northeast":a.y--,a.x++;break;case"northwest":a.y--,a.x--;break;case"southeast":a.y++,a.x++;break;case"southwest":a.y++,a.x--;break;case"up":a.z++;break;case"down":a.z--;break;case"out":a.zone=this.current.zone-1;break;default:a.zone=this.current.zone+1;}a.x+=this.current.x,a.y+=this.current.y,a.z+=this.current.z}a.zone+=t.area==this.current.area?this.current.zone:this.getFreeZone(a.x,a.y,a.z,this.current.zone),this._db.run("INSERT INTO Rooms (ID) values ('"+t.num+"')")}else a={area:l[0].Area,details:l[0].Details,exits:{},name:l[0].Name,num:l[0].ID,env:l[0].Env,x:l[0].X,y:l[0].Y,z:l[0].Z,zone:l[0].Zone};for(var n in a.ID=t.num,a.area=t.area,a.name=t.name,a.env=t.environment,a.indoors=t.indoors,t.exits)a.exits[n]=t.exits[n];a.details=RoomDetails.None;for(var c=0;c<t.details.length;c++)switch(t.details[c]){case"dock":a.details|=RoomDetails.Dock;break;case"pier":a.details|=RoomDetails.Pier;break;case"bank":a.details|=RoomDetails.Bank;break;case"shop":a.details|=RoomDetails.Shop;break;case"hospital":a.details|=RoomDetails.Hospital;break;case"bar":a.details|=RoomDetails.Bar;break;case"restaurant":a.details|=RoomDetails.Restaurant;break;case"watersource":a.details|=RoomDetails.WaterSource;break;case"trainer":a.details|=RoomDetails.Trainer;}a=this.sanatizeRoom(a),this.addOrUpdateRoom(a),this.current.ID=a.ID,this.current.area=a.area,this.current.x=a.x,this.current.y=a.y,this.current.z=a.z,this.current.zone=a.zone,this.selected&&this.selected.ID==a.ID&&this.emit("room-selected",library_1.clone(a)),this.follow?this.focusCurrentRoom():this.active=library_1.clone(this.current),this.refresh()})}catch(o){this.emit("error",o)}}getFreeZone(t,o,l,a){return a||(a=0),this._db.serialize(()=>{this._db.get("SELECT Zone FROM Rooms WHERE X = "+t+" AND Y = "+o+" AND Z ="+l+" ORDER BY Zone DESC LIMIT 1",function(n,c){return c?c.Zone+1:0})}),a}updateRoom(t){this._db.run("Update Rooms SET Area = ?, Details = ?, Name = ?, Env = ?, X = ?, Y = ?, Z = ?, Zone = ?, Indoors = ? WHERE ID = ?",[t.Area||t.area,t.Details||t.details||RoomDetails.None,t.Name||t.name,t.Env||t.env,t.X||t.x||0,t.Y||t.y||0,t.Z||t.z||0,t.Zone||t.zone||0,t.Indoors||t.indoors,t.ID||t.num],(a)=>{a&&this.emit("error",a)}),this._db.run("Delete From Exits WHERE ID = ?",[t.ID||t.num]);var o=this._db.prepare("INSERT INTO Exits VALUES (?, ?, ?, ?, ?)");for(var l in t.exits)o.run(t.ID,l,t.exits[l].num,t.exits[l].isdoor,t.exits[l].isclosed);o.finalize()}addOrUpdateRoom(t){this._db.run("INSERT OR REPLACE INTO Rooms (ID, Area, Details, Name, Env, X, Y, Z, Zone, Indoors, Background, Notes) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) ",[t.ID||t.num,t.Area||t.area,t.Details||t.details||RoomDetails.None,t.Name||t.name,t.Env||t.env,t.X||t.x||0,t.Y||t.y||0,t.Z||t.z||0,t.Zone||t.zone||0,t.Indoors||t.indoors,t.Background||t.background,t.Notes||t.notes],(a)=>{a&&this.emit("error",a),this.refresh()});var o=this._db.prepare("INSERT OR REPLACE INTO Exits VALUES (?, ?, ?, ?, ?)");for(var l in t.exits)o.run(t.ID||t.num,l,t.exits[l].num,t.exits[l].isdoor,t.exits[l].isclosed);o.finalize(),this.refresh()}processGMCP(t,o){if(this.enabled){var l=t.split(".");if(!(2>l.length||"Room"!=l[0]))switch(l[1]){case"Info":this.processData(o);break;case"WrongDir":}}}sanatizeRoom(t){return t.x=parseInt(t.x,10),t.y=parseInt(t.y,10),t.z=parseInt(t.z,10),t.zone=parseInt(t.zone,10),t}DrawLegend(t,o,l,a){this._showLegend&&(t.strokeStyle="black",!a&&(t.fillStyle="#eae4d6",t.fillRect(o+30,l+35,130,160)),t.fillStyle="black",t.strokeRect(o+30,l+35,130,160),t.font="italic bold 8pt Georgia",t.fillText("Dock",o+50,l+50),t.fillStyle="chocolate",t.beginPath(),t.arc(o+40,l+45,2,0,2*_MathPI),t.fill(),t.closePath(),t.fillStyle="black",t.fillText("Pier",o+50,l+65),t.fillStyle="gray",t.beginPath(),t.arc(o+40,l+60,2,0,2*_MathPI),t.fill(),t.closePath(),t.fillStyle="black",t.fillText("Water Source",o+50,l+80),t.fillStyle="aqua",t.beginPath(),t.arc(o+40,l+75,2,0,2*_MathPI),t.fill(),t.closePath(),t.fillStyle="black",t.fillText("Bank",o+50,l+95),t.font="8pt Arial",t.fillStyle="goldenrod",t.beginPath(),t.fillText("$",o+38,l+95),t.closePath(),t.font="italic bold 8pt Georgia",t.fillStyle="black",t.fillText("Shop",o+50,l+110),t.font="8pt Arial",t.fillStyle="purple",t.beginPath(),t.fillText("\u23CF",o+38,l+110),t.closePath(),t.font="italic bold 8pt Georgia",t.fillStyle="black",t.fillText("Hospital",o+50,l+125),t.font="8pt Arial",t.fillStyle="blue",t.beginPath(),t.fillText("\u2665",o+38,l+125),t.closePath(),t.font="italic bold 8pt Georgia",t.fillStyle="black",t.fillText("Bar & Restaurant",o+50,l+140),t.font="8pt Arial",t.fillStyle="green",t.beginPath(),t.fillText("\u2617",o+38,l+140),t.closePath(),t.font="italic bold 8pt Georgia",t.fillStyle="black",t.fillText("Bar",o+50,l+155),t.font="8pt Arial",t.fillStyle="green",t.beginPath(),t.fillText("\u266A",o+38,l+155),t.closePath(),t.font="italic bold 8pt Georgia",t.fillStyle="black",t.fillText("Restaurant",o+50,l+170),t.font="8pt Arial",t.fillStyle="green",t.beginPath(),t.fillText("\u2616",o+38,l+170),t.closePath(),t.font="italic bold 8pt Georgia",t.fillStyle="black",t.fillText("Trainer",o+50,l+185),t.font="8pt Arial",t.fillStyle="red",t.beginPath(),t.fillText("\u260D",o+38,l+185),t.closePath())}DrawRoom(t,o,l,a,n){t.beginPath();var c=!1;if(a.Background)t.fillStyle=a.Background,c=!0;else if(a.Env)switch(a.Env){case"wood":t.fillStyle="#966F33",c=!0;break;case"jungle":t.fillStyle="#347C2C",c=!0;break;case"forest":t.fillStyle="#4E9258",c=!0;break;case"grass":case"grassland":case"plains":case"prairie":case"savannah":t.fillStyle="#4AA02C",c=!0;break;case"desert":case"dirt":case"dirtroad":case"beach":case"sand":case"sanddesert":t.fillStyle="#C2B280",c=!0;break;case"snow":t.fillStyle="#F0F8FF",c=!0;break;case"tundra":case"icesheet":t.fillStyle="#368BC1",c=!0;break;case"underwater":case"water":case"lake":case"river":t.fillStyle="#EBF4FA",c=!0;break;case"ocean":t.fillStyle="#C2DFFF",c=!0;break;case"bog":case"city":case"cliff":case"cobble":case"farmland":case"highmountain":case"hills":case"mountain":case"pavedroad":case"rockdesert":case"rocky":case"stone":case"swamp":c=!1;break;default:c=!1;}else c=!1;t.strokeStyle="black",t.lineWidth=0.6,a.Indoors?(c&&t.fillRect(o+8,l+8,16,16),t.strokeRect(o+8,l+8,16,16)):(t.arc(o+16,l+16,8.5,0,2*_MathPI,!1),c&&t.fill(),t.stroke()),t.closePath(),t.beginPath(),t.fillStyle="#cccccc",a.exits.north?(t.moveTo(o+16,l),t.lineTo(o+16,l+8)):this._fillWalls&&t.fillRect(o+9,l,14.5,4.5),a.exits.northwest?a.Indoors?(t.moveTo(o,l),t.lineTo(o+8,l+8)):(t.moveTo(o,l),t.lineTo(o+10,l+10)):this._fillWalls&&(t.fillRect(o+2,l,2.5,2.5),t.fillRect(o,l+2,4.5,2.5),!a.exits.north&&t.fillRect(o+4,l,5.5,4.5),!a.exits.west&&t.fillRect(o,l+4,4.5,5.5)),a.exits.northeast?a.Indoors?(t.moveTo(o+32,l),t.lineTo(o+24,l+8)):(t.moveTo(o+32,l),t.lineTo(o+22,l+10)):this._fillWalls&&(t.fillRect(o+28,l,2.5,2.5),t.fillRect(o+28,l+2,4.5,2.5),t.clearRect(o+30,l,2,2),!a.exits.north&&t.fillRect(o+23,l,5.5,4.5),!a.exits.east&&t.fillRect(o+28,l+4,4.5,5.5)),a.exits.east?(t.moveTo(o+24,l+16),t.lineTo(o+32,l+16)):this._fillWalls&&t.fillRect(o+28,l+9,4.5,14.5),a.exits.west?(t.moveTo(o,l+16),t.lineTo(o+8,l+16)):this._fillWalls&&t.fillRect(o,l+9,4.5,14.5),a.exits.south?(t.moveTo(o+16,l+24),t.lineTo(o+16,l+32)):this._fillWalls&&t.fillRect(o+9,l+28,14.5,4.5),a.exits.southeast?a.Indoors?(t.moveTo(o+32,l+32),t.lineTo(o+24,l+24)):(t.moveTo(o+32,l+32),t.lineTo(o+22,l+22)):this._fillWalls&&(t.fillRect(o+28,l+28,4.5,2.5),t.fillRect(o+28,l+30,2.5,2.5),!a.exits.south&&t.fillRect(o+23,l+28,5.5,4.5),!a.exits.east&&t.fillRect(o+28,l+23,4.5,5.5)),a.exits.southwest?a.Indoors?(t.moveTo(o,l+32),t.lineTo(o+8,l+24)):(t.moveTo(o,l+32),t.lineTo(o+10,l+22)):this._fillWalls&&(t.fillRect(o,l+28,4.5,2.5),t.fillRect(o+2,l+30,2.5,2.5),!a.exits.south&&t.fillRect(o+4,l+28,5.5,4.5),!a.exits.west&&t.fillRect(o,l+23,4.5,5.5)),t.closePath(),t.stroke(),t.fillStyle="black",t.strokeStyle="black",a.exits.up&&(t.beginPath(),t.moveTo(o+1,l+11),t.lineTo(o+7,l+11),t.lineTo(o+4,l+8),t.closePath(),t.fill()),a.exits.down&&(t.beginPath(),t.moveTo(o+1,l+21),t.lineTo(o+7,l+21),t.lineTo(o+4,l+24),t.closePath(),t.fill()),a.exits.out&&(t.beginPath(),t.moveTo(o+26,l+8),t.lineTo(o+29,l+11),t.lineTo(o+26,l+14),t.closePath(),t.fill()),a.exits.enter&&(t.beginPath(),t.moveTo(o+29,l+19),t.lineTo(o+26,l+22),t.lineTo(o+29,l+25),t.closePath(),t.fill()),this.DrawDoor(t,o+12,l-2,8,3,a.exits.north),this.DrawDoor(t,o+31,l+12,3,8,a.exits.east),this.DrawDoor(t,o-1,l+12,3,8,a.exits.west),this.DrawDoor(t,o+12,l+30,8,3,a.exits.south),this.DrawDDoor(t,o,l,5,5,a.exits.northwest),this.DrawDDoor(t,o+32,l,-5,5,a.exits.northeast),this.DrawDDoor(t,o+32,l+32,-5,-5,a.exits.southeast),this.DrawDDoor(t,o,l+32,5,-5,a.exits.southwest),(a.Details&RoomDetails.Dock)==RoomDetails.Dock?(t.fillStyle="chocolate",t.beginPath(),t.arc(o+20,l+5,2,0,2*_MathPI),t.fill(),t.closePath()):(a.Details&RoomDetails.Pier)==RoomDetails.Pier&&(t.fillStyle="gray",t.beginPath(),t.arc(o+12,l+5,2,0,2*_MathPI),t.fill(),t.closePath()),(a.Details&RoomDetails.WaterSource)==RoomDetails.WaterSource&&(t.fillStyle="aqua",t.beginPath(),t.arc(o+12,l+5,2,0,2*_MathPI),t.fill(),t.closePath()),(a.Details&RoomDetails.Bank)==RoomDetails.Bank&&(t.fillStyle="goldenrod",t.beginPath(),t.fillText("$",o+9,l+17),t.closePath()),(a.Details&RoomDetails.Shop)==RoomDetails.Shop&&(t.fillStyle="purple",t.beginPath(),t.fillText("\u23CF",o+15,l+17),t.closePath()),(a.Details&RoomDetails.Hospital)==RoomDetails.Hospital&&(t.fillStyle="blue",t.beginPath(),t.fillText("\u2665",o+15,l+17),t.closePath()),(a.Details&RoomDetails.Trainer)==RoomDetails.Trainer&&(t.fillStyle="red",t.beginPath(),t.fillText("\u260D",o+15,l+17),t.closePath()),(a.Details&RoomDetails.Restaurant)==RoomDetails.Restaurant&&(a.Details&RoomDetails.Bar)==RoomDetails.Bar?(t.fillStyle="green",t.beginPath(),t.fillText("\u2617",o+15,l+17),t.closePath()):(a.Details&RoomDetails.Bar)==RoomDetails.Bar?(t.fillStyle="green",t.beginPath(),t.fillText("\u266A",o+15,l+17),t.closePath()):(a.Details&RoomDetails.Restaurant)==RoomDetails.Restaurant&&(t.fillStyle="green",t.beginPath(),t.fillText("\u2616",o+15,l+17),t.closePath()),n||this.selected.ID!=a.ID||(t.fillStyle="rgba(135, 206, 250, 0.5)",t.strokeStyle="LightSkyBlue",t.fillRoundedRect(o,l,32,32,8),t.strokeRoundedRect(o,l,32,32,8)),2==this.markers[a.ID]?this.drawMarker(t,o,l,"green"):3==this.markers[a.ID]?this.drawMarker(t,o,l,"blue"):this.markers[a.ID]&&this.drawMarker(t,o,l,"yellow"),n||a.ID!=this.current.ID||this.drawMarker(t,o,l,"red")}drawMarker(t,o,l,a){a||(a="yellow"),t.beginPath(),t.fillStyle=a,t.strokeStyle="black",t.arc(o+16,l+16,4,0,2*_MathPI),t.fill(),t.closePath()}DrawDoor(t,o,l,a,n,c){c&&c.isdoor&&(t.beginPath(),t.clearRect(o,l,a,n),t.fillStyle="black",t.strokeStyle="black",c.islocked?(t.fillStyle="red",t.fillRect(o,l,a,n),t.strokeRect(o,l,a,n)):c.isclosed?t.fillRect(o,l,a,n):t.strokeRect(o,l,a,n),t.closePath())}DrawDDoor(t,o,l,a,n,c){c&&c.isdoor&&(t.beginPath(),t.fillStyle="black",t.strokeStyle="black",t.moveTo(o,l),t.lineTo(o+a,l),t.lineTo(o,l+n),t.lineTo(o,l),c.islocked?(t.fillStyle="red",t.fill(),t.stroke()):c.isclosed?t.fill():t.stroke(),t.closePath())}PointInRect(t,o,l,a,n,c){return l<=t&&t<=a&&n<=o&&o<=c}getRoom(t,o){this._db.all("Select * FROM Rooms inner join exits on Exits.ID = Rooms.ID WHERE Rooms.ID = $id",{$id:t},(l,a)=>{var n={};if(a){for(var c=a.length,d=0;d<c;d++)n[a[d].ID]?n[a[d].ID].exits[a[d].Exit]={num:a[d].DestID,isdoor:a[d].IsDoor,isclosed:a[d].IsClosed}:(n[a[d].ID]=library_1.clone(a[d]),n[a[d].ID].exits={},n[a[d].ID].exits[a[d].Exit]={num:a[d].DestID,isdoor:a[d].IsDoor,isclosed:a[d].IsClosed});o&&o(n[a[0].ID])}})}getRooms(t,o,l,a){this._splitArea?this._db.all("Select * FROM Rooms inner join exits on Exits.ID = Rooms.ID WHERE Z = $z AND Area = $area AND Zone = $zone",{$area:t,$zone:l,$z:o},(n,c)=>{var d={};if(c){for(var D=c.length,u=0;u<D;u++)d[c[u].ID]?d[c[u].ID].exits[c[u].Exit]={num:c[u].DestID,isdoor:c[u].IsDoor,isclosed:c[u].IsClosed}:(d[c[u].ID]=library_1.clone(c[u]),d[c[u].ID].exits={},d[c[u].ID].exits[c[u].Exit]={num:c[u].DestID,isdoor:c[u].IsDoor,isclosed:c[u].IsClosed});a&&a(d)}}):this._db.all("Select * FROM Rooms inner join exits on Exits.ID = Rooms.ID WHERE Z = $z AND Zone = $zone",{$zone:l,$z:o},(n,c)=>{var d={};if(c){for(var D=c.length,u=0;u<D;u++)d[c[u].ID]?d[c[u].ID].exits[c[u].Exit]={num:c[u].DestID,isdoor:c[u].IsDoor,isclosed:c[u].IsClosed}:(d[c[u].ID]=library_1.clone(c[u]),d[c[u].ID].exits={},d[c[u].ID].exits[c[u].Exit]={num:c[u].DestID,isdoor:c[u].IsDoor,isclosed:c[u].IsClosed});a&&a(d)}})}showPath(){null==this.current.ID||null==this.selected.ID||this._splitArea&&this.current.area!=this.selected.area||this.current.zone!=this.selected.zone||this.current.z!=this.selected.z||this.getRooms(this.current.area,this.current.z,this.current.zone,(t)=>{var o,l,a=[],n=null,c=0,d=0,D=0,u,m=t.length,I,R,g,E;for(l in t){if(o=t[l],null==n){n=o.X,d=o.X+1,c=o.Y,D=o.Y+1;continue}o.X<n?n=o.X:o.X>d&&(d=o.X),o.Y<c?c=o.Y:o.Y>D&&(D=o.Y)}for(l in t)o=t[l],null===o||(!a[o.Y-c]&&(a[o.Y-c]=[]),a[o.Y-c][o.X-n]=o);d=_Mathsqrt(_Mathpow(d-n,2))+1,D=_Mathsqrt(_Mathpow(c-D,2))+1;var p=[];for(R=0;R<D;R++)for(p[R]=[],I=0;I<d;I++)p[R][I]=0;for(l in t)o=t[l],I=o.X-n,R=o.Y-c,o.exits.northwest&&(p[R][I]|=1),o.exits.north&&(p[R][I]|=128),o.exits.northeast&&(p[R][I]|=64),o.exits.west&&(p[R][I]|=2),o.exits.east&&(p[R][I]|=32),o.exits.southwest&&(p[R][I]|=4),o.exits.south&&(p[R][I]|=8),o.exits.southeast&&(p[R][I]|=16);var T=new PF.Grid(d,D,p),v=new PF.AStarFinder({allowDiagonal:!0,dontCrossCorners:!1});I=this.current.x-n,R=this.current.y-c,g=this.selected.x-n,E=this.selected.y-c;var b=v.findPath(I,R,g,E,T);for(m=b.length,this.markers={},u=0;u<m;u++)I=_Mathfloor(b[u][0]),R=_Mathfloor(b[u][1]),a[R]&&a[R][I]&&(a[R][I].ID==this.current.ID?this.markers[a[R][I].ID]=2:a[R][I].ID==this.selected.ID?this.markers[a[R][I].ID]=3:this.markers[a[R][I].ID]=1);this.emit("path-shown"),this.draw()})}clearPath(){this.emit("path-cleared"),this.markers={},this.draw()}walkPath(){null==this.current.ID||null==this.selected.ID||this._splitArea&&this.current.area!=this.selected.area||this.current.zone!=this.selected.zone||this.current.z!=this.selected.z||this.getRooms(this.current.area,this.current.z,this.current.zone,(t)=>{var o,l,a=[],n=null,c=0,d=0,D=0,u,m=t.length,I,R,g,E,p,T;for(l in t){if(o=t[l],null==n){n=o.X,d=o.X+1,c=o.Y,D=o.Y+1;continue}o.X<n?n=o.X:o.X>d&&(d=o.X),o.Y<c?c=o.Y:o.Y>D&&(D=o.Y)}for(l in t)o=t[l],null===o||(!a[o.Y-c]&&(a[o.Y-c]=[]),a[o.Y-c][o.X-n]=o);d=_Mathsqrt(_Mathpow(d-n,2))+1,D=_Mathsqrt(_Mathpow(c-D,2))+1;var b=[];for(R=0;R<D;R++)for(b[R]=[],I=0;I<d;I++)b[R][I]=0;for(l in t)o=t[l],I=o.X-n,R=o.Y-c,o.exits.northwest&&(b[R][I]|=1),o.exits.north&&(b[R][I]|=128),o.exits.northeast&&(b[R][I]|=64),o.exits.west&&(b[R][I]|=2),o.exits.east&&(b[R][I]|=32),o.exits.southwest&&(b[R][I]|=4),o.exits.south&&(b[R][I]|=8),o.exits.southeast&&(b[R][I]|=16);var A=new PF.Grid(d,D,b),_=new PF.AStarFinder({allowDiagonal:!0,dontCrossCorners:!1});I=this.current.x-n,R=this.current.y-c,g=this.selected.x-n,E=this.selected.y-c;var S=_.findPath(I,R,g,E,A);m=S.length;var P=[];for(u=0;u<m-1;u++)I=_Mathfloor(S[u][0]),R=_Mathfloor(S[u][1]),p=_Mathfloor(S[u+1][0]),T=_Mathfloor(S[u+1][1]),I-1==p&&R-1==T?P.push("northwest"):I==p&&R-1==T?P.push("north"):I+1==p&&R-1==T?P.push("northeast"):I-1==p&&R+1==T?P.push("southwest"):I==p&&R+1==T?P.push("south"):I+1==p&&R+1==T?P.push("southeast"):I-1==p&&R==T?P.push("west"):P.push("east");this.SendCommands(P)})}SendCommands(t){var o,l=this.commandDelayCount;t.length>l&&(o=t.slice(l),t=t.slice(0,l),setTimeout(()=>{this.SendCommands(o)},this.commandDelay)),this.emit("send-commands",t.join("\n")+"\n")}import(t,o){if(t)if(o==ImportType.Replace)this._db.run("DELETE FROM Exits",()=>{this._db.run("DELETE FROM Rooms",()=>{this.emit("clear-done"),this.reset(),this.import(t,ImportType.Merge)})});else{this._cancelImport=!1;var l,a,n;this._db.serialize(()=>{if(Array.isArray(t)){n=t.length,this.emit("import-progress",0);var c=this._db.prepare("INSERT OR REPLACE INTO Rooms (ID, Area, Details, Name, Env, X, Y, Z, Zone, Indoors, Background) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) ");for(l=1,a=0;a<n;a++){if(this._cancelImport)return void c.finalize();if(t[a]){n+=Object.keys(t[a].exits).length,c.run([t[a].ID||t[a].num,t[a].Area||t[a].area,t[a].Details||t[a].details,t[a].Name||t[a].name,t[a].Env||t[a].env,t[a].X||t[a].x,t[a].Y||t[a].y,t[a].Z||t[a].z,t[a].Zone||t[a].zone,t[a].Indoors||t[a].indoors,t[a].Background||t[a].background],()=>{return this._cancelImport?(this.refresh(),void this.focusActiveRoom()):void(this.emit("import-progress",_Mathfloor(100*(a/n))),a>=n&&(this.refresh(),this.focusActiveRoom()))});var d=this._db.prepare("INSERT OR REPLACE INTO Exits VALUES (?, ?, ?, ?, ?)");for(var D in t[a].exits)d.run(t[a].ID||t[a].num,D,t[a].exits[D].num,t[a].exits[D].isdoor,t[a].exits[D].isclosed,()=>{return this._cancelImport?(this.refresh(),void this.focusActiveRoom()):void(this.emit("import-progress",_Mathfloor(100*(l/n))),l++,l>=n&&(this.refresh(),this.focusActiveRoom()))});d.finalize()}}c.finalize()}else{this.emit("import-progress",0);var c=this._db.prepare("INSERT OR REPLACE INTO Rooms (ID, Area, Details, Name, Env, X, Y, Z, Zone, Indoors, Background) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) ");for(a in n=Object.keys(t).length,l=1,t){if(this._cancelImport)return void c.finalize();if(t.hasOwnProperty(a)&&t[a]){if(n+=Object.keys(t[a].exits).length,this._cancelImport)return void c.finalize();if(t[a]){c.run([t[a].ID||t[a].num,t[a].Area||t[a].area,t[a].Details||t[a].details,t[a].Name||t[a].name,t[a].Env||t[a].env,t[a].X||t[a].x,t[a].Y||t[a].y,t[a].Z||t[a].z,t[a].Zone||t[a].zone,t[a].Indoors||t[a].indoors,t[a].Background||t[a].background],()=>{return this._cancelImport?(this.refresh(),void this.focusActiveRoom()):void(this.emit("import-progress",_Mathfloor(100*(l/n))),l++,l>=n&&(this.refresh(),this.focusActiveRoom()))});var d=this._db.prepare("INSERT OR REPLACE INTO Exits VALUES (?, ?, ?, ?, ?)");for(var D in t[a].exits)d.run([t[a].ID||t[a].num,D,t[a].exits[D].num,t[a].exits[D].isdoor,t[a].exits[D].isclosed],()=>{return this._cancelImport?(this.refresh(),void this.focusActiveRoom()):void(this.emit("import-progress",_Mathfloor(100*(l/n))),l++,l>=n&&(this.refresh(),this.focusActiveRoom()))});d.finalize()}}}c.finalize()}})}}exportArea(t){this._db.all("Select * FROM Rooms inner join exits on Exits.ID = Rooms.ID WHERE Area = $area",{$area:this.active.area||""},(o,l)=>{var a={};if(l){var n=l.length;this.emit("import-progress",0);for(var c=0;c<n;c++){if(a[l[c].ID])a[l[c].ID].exits[l[c].Exit]={num:l[c].DestID,isdoor:l[c].IsDoor,isclosed:l[c].IsClosed};else{for(var d in a[l[c].ID]={num:l[c].ID},l[c])if("ID"!=d){if(!l[c].hasOwnProperty(d))continue;a[l[c].ID][d.toLowerCase()]=l[c][d]}a[l[c].ID].exits={},a[l[c].ID].exits[l[c].Exit]={num:l[c].DestID,isdoor:l[c].IsDoor,isclosed:l[c].IsClosed}}this.emit("import-progress",_Mathfloor(100*(c/n)))}this.exportRooms(t,a)}})}exportAll(t){this._db.all("Select * FROM Rooms inner join exits on Exits.ID = Rooms.ID",(o,l)=>{var a={};if(l){var n=l.length;this.emit("import-progress",0);for(var c=0;c<n;c++){if(a[l[c].ID])a[l[c].ID].exits[l[c].Exit]={num:l[c].DestID,isdoor:l[c].IsDoor,isclosed:l[c].IsClosed};else{for(var d in a[l[c].ID]={num:l[c].ID},l[c])if("ID"!=d){if(!l[c].hasOwnProperty(d))continue;a[l[c].ID][d.toLowerCase()]=l[c][d]}a[l[c].ID].exits={},a[l[c].ID].exits[l[c].Exit]={num:l[c].DestID,isdoor:l[c].IsDoor,isclosed:l[c].IsClosed}}this.emit("import-progress",_Mathfloor(100*(c/n)))}this.exportRooms(t,a)}})}exportRooms(t,o){return o?void(fs.writeFileSync(t,JSON.stringify(o)),this.emit("import-progress",100)):void this.emit("import-progress",100)}cancelImport(){this._cancelImport=!0}}exports.Mapper=Mapper;
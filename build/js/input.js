"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const EventEmitter=require("events"),profile_1=require("./profile"),library_1=require("./library"),test_1=require("./test"),profile_2=require("./profile");class input extends EventEmitter{constructor(b){if(super(),this._historyIdx=-1,this._locked=0,this._TriggerCache=null,this._TriggerFunctionCache={},this._scrollLock=!1,this.client=null,!b)throw"Invalid client!";this.client=b,this._tests=new test_1.Tests(b),this._commandHistory=[],$(document).keydown((d)=>{!this.isLocked&&this.ProcessMacros(d.which,d.altKey,d.ctrlKey,d.shiftKey,d.metaKey)?(d.preventDefault(),d.stopPropagation()):145==d.which&&this.toggleScrollLock()}),this.client.on("parseCommand",(d)=>{this.client.options.parseCommands&&(d.value=this.parseOutgoing(d.value))}),this.client.on("addLine",(d)=>{this.ExecuteTriggers(0,d.raw,d.fragment,!1)}),this.client.commandInput.keyup((d)=>{27!=d.which&&38!=d.which&&40!=d.which&&(this._historyIdx=this._commandHistory.length)}),this.client.commandInput.keydown((d)=>{switch(d.which){case 27:b.commandInput.blur(),b.commandInput.val(""),b.commandInput.select(),this._historyIdx=this._commandHistory.length;break;case 38:this._historyIdx==this._commandHistory.length&&0<this.client.commandInput.val().length&&(this.AddCommandToHistory(this.client.commandInput.val()),this.client.commandInput.val()==this._commandHistory[this._historyIdx-1]&&this._historyIdx--),this._historyIdx--,0>this._historyIdx&&(this._historyIdx=0),0>this._commandHistory.length?(this._historyIdx=-1,this.client.commandInput.val(""),this.client.commandInput.select()):(0<this._commandHistory.length&&this._historyIdx<this._commandHistory.length&&0<=this._historyIdx&&this.client.commandInput.val(this._commandHistory[this._historyIdx]),this.client.commandInput.select());break;case 40:this._historyIdx==this._commandHistory.length&&0<this.client.commandInput.val().length&&this.AddCommandToHistory(this.client.commandInput.val()),this._historyIdx++,this._historyIdx>=this._commandHistory.length||1>this._commandHistory.length?(this._historyIdx=this._commandHistory.length,this.client.commandInput.val(""),this.client.commandInput.select()):(0<this._commandHistory.length&&this._historyIdx<this._commandHistory.length&&0<=this._historyIdx&&this.client.commandInput.val(this._commandHistory[this._historyIdx]),this.client.commandInput.select());break;case 13:this.client.sendCommand();}})}get scrollLock(){return this._scrollLock}set scrollLock(b){b!=this._scrollLock&&(this._scrollLock=b,this.emit("scrolllock",this.scrollLock))}get isLocked(){return 0!==this._locked}addLock(){this._locked++}removeLock(){this._locked--}AddCommandToHistory(b){(1>this._commandHistory.length||this._commandHistory[this._commandHistory.length-1]!=b)&&0<b.length&&(this._commandHistory.length>=this.client.options.commandHistorySize&&this._commandHistory.shift(),this._commandHistory.push(b))}executeScript(b){if(null==b)return b;var d=b.trim();if(this._tests.TestFunctions[d]&&this._tests.TestFunctions[d])return this._tests.TestFunctions[d].apply(this._tests,[]),null;for(var k,w,g=this.client.options.commandStackingChar,h=0,j=0,o=b.length,q="",u=[],v="",x=this.client.options.parseDoubleQuotes,y=this.client.options.parseSingleQuotes;j<o;j++)switch(k=b.charAt(j),h){case 1:" "===k?(h=2,w+=k):(q+=k,w+=k);break;case 2:" "===k?(u.push(v),v=""):("\""===k&&x?h=3:"'"===k&&y&&(h=4),v+=k),w+=k;break;case 3:"\""===k&&(h=2),v+=k,w+=k;break;case 4:"'"===k&&(h=2),v+=k,w+=k;break;default:if(0==j&&"#"===k)h=1,q="",u=[],v="",w=k;else return b;}return 0<q.length?(3==h?v+="\"":4==h&&(v+="'"),0<v.length&&u.push(v),this.executeFunction(q,u,w)):b}executeFunction(b,d,g){var h,j=!1,k,l,o,q;switch(b.toLowerCase()){case"notify":case"not":if(h=d[0],l=d.length,!h.startsWith("'"))o=1;else if(h=h.substring(1),h.endsWith("'")&&!h.endsWith("\\'"))o=1;else for(o=1;o<l;o++)if(h+=" "+d[o],d[o].endsWith("'")){if(d[o].endsWith("\\'"))continue;h=h.substring(0,h.length-1),o++;break}return d=o<l?d.slice(o).join(" "):"",h=h.replace(/\\\'/g,"'"),d=d.replace(/\\\'/g,"'"),(null!==/^"(.*)"$/.exec(h)||null!==/^'(.*)'$/.exec(h))&&(h=h.substring(1,h.length-1)),(null!==/^"(.*)"$/.exec(d)||null!==/^'(.*)'$/.exec(d))&&(d=d.substring(1,d.length-1)),this.client.notify(h,d),null;case"idle":case"idletime":return this.client.lastSendTime?this.client.echo("You have been idle: "+library_1.getTimeSpan(Date.now()-this.client.lastSendTime),-7,-8,!0,!0):this.client.echo("Not connected",-7,-8,!0,!0),null;case"connect":case"connecttime":return this.client.connectTime?this.client.echo("You have been connected: "+library_1.getTimeSpan(Date.now()-this.client.connectTime),-7,-8,!0,!0):this.client.echo("Not connected",-7,-8,!0,!0),null;case"version":case"ve":return this.client.echo(this.client.telnet.terminal+" v"+this.client.version,-7,-8,!0,!0),null;case"soundinfo":return null;case"musicinfo":return null;case"playmusic":case"playm":return null;case"playsound":case"plays":return null;case"stopmusic":case"stopm":return null;case"stopsound":case"stops":return null;case"stopallsound":case"stopa":return null;case"showprompt":case"showp":return d=d.join(" "),this.client.telnet.receivedData(d),this.client.telnet.prompt=!0,null;case"show":case"sh":return d=d.join(" ")+"\n",this.client.telnet.receivedData(d),null;case"sayprompt":case"sayp":case"echoprompt":case"echop":return d=d.join(" "),this.client.print("\x1B[-7;-8m"+d+"\x1B[0m",!1),null;case"say":case"sa":case"echo":case"ec":return d=d.join(" "),this.client.telnet.prompt?this.client.print("\n\x1B[-7;-8m"+d+"\x1B[0m\n",!1):this.client.print("\x1B[-7;-8m"+d+"\x1B[0m\n",!1),this.client.telnet.prompt=!1,null;case"alias":case"al":if(0===d.length)this.client.error("Invalid syntax use #alias name value");else if(1===d.length)this.client.error("Must supply an alias value");else if(k=this.client.activeProfile.aliases,h=d[0],d=d.slice(1).join(" "),(null!==/^"(.*)"$/.exec(d)||null!==/^'(.*)'$/.exec(d))&&(d=d.substring(1,d.length-1)),/^\d+$/.exec(h))h=parseInt(h,10),0>h||h>=k.length?this.client.error("Alias index must be >= 0 and < "+k.length):(k[h].value=d,this.client.echo("Alias '"+k[h].pattern+"' updated.",-7,-8,!0,!0),this.client.activeProfile.aliases=k,this.client.saveProfile(this.client.activeProfile.name));else{for((null!==/^"(.*)"$/.exec(h)||null!==/^'(.*)'$/.exec(h))&&(h=h.substring(1,h.length-1)),o=0,l=k.length;o<l;o++)if(k[o].pattern==h){k[o].value=d,this.client.echo("Alias '"+h+"' updated.",-7,-8,!0,!0),j=!0;break}j||(q=new profile_2.Alias(h,d),k.push(j),this.client.echo("Alias '"+h+"' added.",-7,-8,!0,!0)),this.client.activeProfile.aliases=k,this.client.saveProfile(this.client.activeProfile.name)}return null;case"unalias":case"una":if(0===d.length)this.client.error("Invalid syntax use #unalias name");else{if(k=this.client.activeProfile.aliases,h=d.join(" "),/^\d+$/.exec(h))q=h,h=parseInt(h,10),0>h||h>=k.length?this.client.error("Alias index must be >= 0 and < "+k.length):j=!0;else for((null!==/^"(.*)"$/.exec(h)||null!==/^'(.*)'$/.exec(h))&&(h=h.substring(1,h.length-1)),q=h,(o=0,l=k.length);o<l;o++)if(k[o].pattern==h){h=o,j=!0;break}j?(this.client.echo("Alias '"+k[h].pattern+"' removed.",-7,-8,!0,!0),k.splice(h,1),this.client.activeProfile.aliases=k,this.client.saveProfile(this.client.activeProfile.name)):this.client.echo("Alias '"+q+"' not found.",-7,-8,!0,!0)}return null;case"setsetting":case"sets":return null;case"getsetting":case"gets":return null;case"profilelist":for(o=0,l=this.client.profiles.length,this.client.echo("\x1B[4mProfiles:\x1B[0m",-7,-8,!0,!0);o<l;o++)this.client.profiles.items[this.client.profiles.items[o]].enabled?this.client.echo("   "+this.client.profiles.items[o]+" is enabled",-7,-8,!0,!0):this.client.echo("   "+this.client.profiles.items[o]+" is disabled",-7,-8,!0,!0);return null;case"profile":case"pro":if(0===d.length)this.client.error("Invalid syntax use #profile name or #profile name enable/disable");else if(1===d.length){if(!this.client.profiles.toggle(d[0]))return this.client.profiles.contains(d[0])?(this.client.error(d[0]+" can not be disabled as it is the only one enabled"),null):(this.client.error("Profile not found"),null);this.client.saveProfile(d[0]),d=this.client.profiles[d[0]].enabled?d[0]+" is enabled":d[0]+" is disabled"}else switch(this.client.profiles[d[0]]||this.client.error("Profile not found"),d[1]||this.client.error("Invalid syntax use #profile name or #profile name enable/disable"),d[1].toLowerCase()){case"enable":case"on":case"yes":if(this.client.profiles[d[0]].enabled)d=d[0]+" is already enabled";else{if(!this.client.profiles.toggle(d[0])){if(!this.client.profiles.contains(d[0]))return this.client.error("Profile not found"),null;d=d[0]+" remains disabled"}else d=d[0]+" is enabled";this.client.saveProfile(d[0])}break;case"disable":case"off":case"no":if(!this.client.profiles[d[0]].enabled)d=d[0]+" is already disabled";else{if(!this.client.profiles.toggle(d[0]))return this.client.profiles.contains(d[0])?(this.client.error(d[0]+" can not be disabled as it is the only one enabled"),null):(this.client.error("Profile not found"),null);this.client.saveProfile(d[0]),d=d[0]+" is disabled"}break;default:return this.client.error("Invalid syntax use #profile name or #profile name enable/disable"),null;}return this.client.telnet.prompt?this.client.print("\n\x1B[-7;-8m"+d+"\x1B[0m\n",!1):this.client.print("\x1B[-7;-8m"+d+"\x1B[0m\n",!1),this.client.telnet.prompt=!1,null;}return g}parseOutgoing(b,d,g){var h=b.length;if(null===b||0===h)return b;var l,B,C,D,j="",k="",o=0,q=this.client.aliases,u=this.client.options.commandStackingChar,v=this.client.options.speedpathsChar,w=this.client.options.enableSpeedpaths,x=[],y="",z=!0,A="",E=0,F=!0,G=this.client.options.parseDoubleQuotes,H=this.client.options.parseSingleQuotes;for(d=null==d?0<q.length:d&&0<q.length,g=0!==u.length&&(null==g?this.client.options.commandStacking:g&&this.client.options.commandStacking),E=0;E<h;E++)switch(C=b.charAt(E),o){case 1:"\""===C&&G&&(o=0),d&&z?k+=C:j+=C,F=!1;break;case 2:"'"===C&&H&&(o=0),d&&z?k+=C:j+=C,F=!1;break;case 3:if("\""===C&&G)y+=C,o=4,F=!1;else if("'"===C&&H)y+=C,o=5,F=!1;else if(E==h-1||"\n"===C||g&&C===u){for(0<y.length&&x.push(y),D=l.length,B=0;B<D&&(j=this.executeScript(this.ExecuteAlias(l[B],x)),null!==j&&(A+=j),j="",!!B.multi);B++);k="",o=0,l=null,F=!0}else" "===C?(x.push(y),y="",F=!1):(y+=C,F=!1);break;case 4:"\""===C&&(o=3),y+=C,F=!1;break;case 5:"'"===C&&(o=3),y+=C,F=!1;break;case 6:"\n"===C||g&&C===u?(o=0,j=this.ProcessPath(j),null!==j&&(A+=j),j="",F=!0):1==E&&C===v?(o=0,E--,F=!1):(j+=C,F=!1);break;default:if(w&&F&&C===v)o=6,F=!1;else if("\""===C&&G)d&&z?k+=C:j+=C,o=1,F=!1;else if("'"===C&&H)d&&z?k+=C:j+=C,o=2,F=!1;else if(d&&z&&" "==C)l=library_1.FilterArrayByKeyValue(q,"pattern",k),0<l.length?(o=3,x.length=0,y="",x.push(k)):(j+=k+" ",k="",l=null),z=!1,F=!1;else if("\n"===C||g&&C===u){if(!(d&&z&&0<k.length))j=this.executeScript(this.ExecuteTriggers(1,j,!1,!0)),null!==j&&(A+=j+"\n"),j="";else if(l=library_1.FilterArrayByKeyValue(q,"pattern",k),0<l.length){for(x.push(k),D=l.length,B=0;B<D&&(j=this.executeScript(this.ExecuteAlias(l[B],x)),null!==j&&(A+=j),!!B.multi);B++);j="",x.length=0,y=""}else j=this.executeScript(this.ExecuteTriggers(1,k,!1,!0)),null!==j&&(A+=j+"\n"),j="",l=null;k="",z=!0,F=!0}else d&&z?(k+=C,F=!1):(j+=C,F=!1);}if(0<k.length&&d&&z){if(0<j.length&&(k+=j),l=library_1.FilterArrayByKeyValue(q,"pattern",k),0<l.length)for(x.push(k),D=l.length,B=0;B<D;B++){if(j=this.executeScript(this.ExecuteAlias(l[B],x)),null!==j)A+=j;else if(0===A.length)return null;if(!B.multi)break}else if(j=this.executeScript(this.ExecuteTriggers(1,k,!1,!0)),null!==j)A+=j;else if(0===A.length)return null;l=null}else if(0<k.length){if(0<j.length&&(k+=j),j=this.executeScript(this.ExecuteTriggers(1,k,!1,!0)),null!==j)A+=j;else if(0===A.length)return null;}else if(0<j.length)if(j=this.executeScript(this.ExecuteTriggers(1,j,!1,!0)),null!==j)A+=j;else if(0===A.length)return null;return x.length=0,x=null,y=null,k=null,A}ParseString(b,d,g,h){if(null==b)return"";var j=b.length;if(0===j)return"";var w,k="",l=0,o="",q=0,u=!1,v=0;for(null==h&&(h=!0);v<j;v++)switch(w=b.charAt(v),l){case 1:"%"===w?(k+="%",l=0):"*"===w?(k+=d.slice(1).join(" "),l=0,q=d.length):"-"===w?u=!0:"0"===w||"1"===w||"2"===w||"3"===w||"4"===w||"5"===w||"6"===w||"7"===w||"8"===w||"9"===w?o+=w:(0<o.length?(o=parseInt(o,10),u&&o<d.length?k+=d.slice(o).join(" "):o<d.length&&(k+=d[o]),u?q=d.length:o>q&&(q=o)):k+="%"+w,l=0);break;case 2:if(w.match(/[^a-zA-Z_$]/g)){l=0,k+="$"+w;break}else o=w,l=3;break;case 3:if(w.match(/[^a-zA-Z0-9_]/g)){g[o]&&(k+=g[o]),v--,l=0;break}else o+=w;break;default:"$"===w?(l=2,o=""):"%"===w?(l=1,o="",u=!1):k+=w;}if(3==l&&0<o.length?g[o]&&(k+=g[o]):1==l&&0<o.length&&(o=parseInt(o,10),o<d.length&&(k+=d[o])),0<d.length-1&&h&&q+1<d.length){var x=!1;k.endsWith("\n")&&(k=k.substring(0,k.length-1),x=!0),k.endsWith(" ")||(k+=" "),k+=1>q?d.slice(1).join(" "):d.slice(q+1).join(" "),x&&(k+="\n")}return k}GetNamedArguments(b,d,g){if("*"==b)return d;if(null==g&&(g=!1),null===b||0===b.length)return g?d:[];var h=b.split(","),j=h.length,k=d.length;if(0===j)return g?d:[];var l=g?d.slice():[];for(var o=0;o<j;o++)h[o]=$.trim(h[o]),!(1>h[o].length)&&h[o].match(/[^a-zA-Z0-9_]/g)&&(h[o].startsWith("$")&&(h[o]=h[o].substring(1)),!l[h[o]]&&(l[h[o]]=o+1<k?d[o+1]:""));return l}ExecuteAlias(b,d){if(b.enabled){var g;switch(b.style){case 1:g=this.parseOutgoing(this.ParseString(b.value,d,this.GetNamedArguments(b.params,d),b.append));break;case 2:var h=new Function("try { "+b.value+"} catch (e) { if(this.options.showScriptErrors) this.error(e);}");g=h.apply(this.client,this.GetNamedArguments(b.params,d,b.append));break;default:g=b.value;}return null===g?null:(g=this.ExecuteTriggers(1,g,!1,!0),g.endsWith("\n")?g:g+"\n")}}ProcessMacros(b,d,g,h,j){for(var k=library_1.FilterArrayByKeyValue(this.client.macros,"key",b),l=0,o=k.length;l<o;l++)if(k[l].enabled&&d!==((k[l].modifiers&profile_1.MacroModifiers.Alt)!=profile_1.MacroModifiers.Alt)&&g!==((k[l].modifiers&profile_1.MacroModifiers.Ctrl)!=profile_1.MacroModifiers.Ctrl)&&h!==((k[l].modifiers&profile_1.MacroModifiers.Shift)!=profile_1.MacroModifiers.Shift)&&j!==((k[l].modifiers&profile_1.MacroModifiers.Meta)!=profile_1.MacroModifiers.Meta)&&this.ExecuteMacro(k[l]))return!0;return!1}ExecuteMacro(b){if(!b.enabled)return!1;var d;switch(b.style){case 1:d=this.parseOutgoing(b.value);break;case 2:var g=new Function("try { "+b.value+"} catch (e) { if(this.options.showScriptErrors) this.error(e);}");d=g.apply(this.client);break;default:d=b.value;}if(null==d)return!0;if(b.send){if(d.endsWith("\n")||(d+="\n"),b.chain&&this.client.commandInput.val().endsWith(" "))return this.client.commandInput.val(this.client.commandInput.val()+d),this.client.sendCommand(),!0;this.client.connected&&this.client.send(d),this.client.telnet.echo&&this.client.options.commandEcho&&this.client.echo(d)}else b.append&&this.client.commandInput.val(this.client.commandInput.val()+d);return!0}ProcessPath(b){if(0===b.length)return"";for(var o,q,u,v,d=this.client.options.parseSpeedpaths,g="",h=0,j="",k="",l=0,w=b.length;l<w;l++)switch(o=b.charAt(l),q=b.charCodeAt(l),h){case 1:47<q&&58>q?k+=o:"\\"===o?h=2:(h=0,j=o);break;case 2:47<q&&58>q?j+=o:(j+="\\",l--),h=0;break;default:if(47<q&&58>q){if(0<j.length){for(u=0===k.length?1:parseInt(k,10),v=0;v<u;v++)d?(k=this.parseOutgoing(j),k&&0<k.length&&(g+=k+"\n")):g+=j+"\n";j=""}h=1,k=o}else"\\"===o?h=2:j+=o;}if(0<j.length)for(u=0===k.length?1:parseInt(k,10),v=0;v<u;v++)d?(k=this.parseOutgoing(j),k&&0<k.length&&(g+=k+"\n")):g+=j+"\n";return g}toggleScrollLock(){this.scrollLock=!this.scrollLock}ExecuteTriggers(b,d,g,h){if(null==d)return d;null==h&&(h=!1),null==g&&(g=!1),null===this._TriggerCache&&(this._TriggerCache=$.grep(this.client.triggers,function(q){return q.enabled}),this._TriggerCache.sort(library_1.SortArrayByPrioity));for(var j=0,k=this._TriggerCache.length;j<k;j++)if(("undefined"==typeof this._TriggerCache[j].type||this._TriggerCache[j].type==b)&&(!g||this._TriggerCache[j].triggerprompt)&&(g||this._TriggerCache[j].triggernewline||"undefined"==typeof this._TriggerCache[j].triggernewline))if(this._TriggerCache[j].verbatim||"undefined"!=typeof this._TriggerCache[j].regex&&!this._TriggerCache[j].regex){if(d!=this._TriggerCache[j].pattern)continue;if(h)return this.ExcuteTrigger(this._TriggerCache[j],[d],!0,j);this.ExcuteTrigger(this._TriggerCache[j],[d],!1,j)}else try{var l=new RegExp(this._TriggerCache[j].pattern,"g"),o=l.exec(d);if(!o||!o.length)continue;if(h)return this.ExcuteTrigger(this._TriggerCache[j],o,!0,j);this.ExcuteTrigger(this._TriggerCache[j],o,!1,j)}catch(q){this.client.options.showScriptErrors?this.client.error(q):this.client.debug(q)}return d}ExcuteTrigger(b,d,g,h){if(null==g&&(g=!1),!b.enabled)return"";var j;switch(b.style){case 1:j=this.parseOutgoing(this.ParseString(b.value,d,[],!1));break;case 2:this._TriggerFunctionCache[h]||(this._TriggerFunctionCache[h]=new Function("try { "+b.value+"} catch (e) { if(this.options.showScriptErrors) this.error(e);}")),j=this._TriggerFunctionCache[h].apply(this.client,d);break;default:j=b.value;}if(null===j||"undefined"==typeof j)return null;if(g)return j;if(j.endsWith("\n")||(j+="\n"),this.client.connected&&this.client.telnet.sendData(j),this.client.telnet.echo&&this.client.options.commandEcho){var k=function(){this.client.echo(j)};setTimeout(k,1)}}clearTriggerCache(){this._TriggerCache=null,this._TriggerFunctionCache={}}}exports.input=input;
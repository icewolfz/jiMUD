"use strict";var _Mathceil=Math.ceil;Object.defineProperty(exports,"__esModule",{value:!0});const EventEmitter=require("events"),RGBColor=require("rgbcolor"),library_1=require("./library"),buzz=require("buzz");var MXPTag;(function(t){t[t.None=0]="None",t[t.B=1]="B",t[t.BOLD=2]="BOLD",t[t.STRONG=3]="STRONG",t[t.I=4]="I",t[t.ITALIC=5]="ITALIC",t[t.EM=6]="EM",t[t.U=7]="U",t[t.UNDERLINE=8]="UNDERLINE",t[t.S=9]="S",t[t.STRIKEOUT=10]="STRIKEOUT",t[t.STRIKE=11]="STRIKE",t[t.C=12]="C",t[t.COLOR=13]="COLOR",t[t.H=14]="H",t[t.HIGH=15]="HIGH",t[t.FONT=16]="FONT",t[t.HR=17]="HR",t[t.NOBR=18]="NOBR",t[t.P=19]="P",t[t.BR=20]="BR",t[t.SBR=21]="SBR",t[t.A=22]="A",t[t.SEND=23]="SEND",t[t.EXPIRE=24]="EXPIRE",t[t.VERSION=25]="VERSION",t[t.SUPPORT=26]="SUPPORT",t[t.RESET=27]="RESET",t[t.H1=28]="H1",t[t.H2=29]="H2",t[t.H3=30]="H3",t[t.H4=31]="H4",t[t.H5=32]="H5",t[t.H6=33]="H6",t[t.V=34]="V",t[t.VAR=35]="VAR",t[t.USER=36]="USER",t[t.PASSWORD=37]="PASSWORD",t[t.Custom=38]="Custom",t[t.GAUGE=39]="GAUGE",t[t.STAT=40]="STAT"})(MXPTag||(MXPTag={}));var lineType;(function(t){t[t.None=-1]="None",t[t.Open=0]="Open",t[t.Secure=1]="Secure",t[t.Locked=2]="Locked",t[t.Reset=3]="Reset",t[t.TempSecure=4]="TempSecure",t[t.LockOpen=5]="LockOpen",t[t.LockSecure=6]="LockSecure",t[t.LockLocked=7]="LockLocked",t[t.RoonName=10]="RoonName",t[t.RoomDescription=11]="RoomDescription",t[t.RoomExits=12]="RoomExits",t[t.WelcomeText=19]="WelcomeText"})(lineType||(lineType={}));var FontStyle;(function(t){t[t.None=0]="None",t[t.Bold=1]="Bold",t[t.Faint=2]="Faint",t[t.Italic=4]="Italic",t[t.Underline=8]="Underline",t[t.Slow=16]="Slow",t[t.Rapid=32]="Rapid",t[t.Inverse=64]="Inverse",t[t.Hidden=128]="Hidden",t[t.Strikeout=256]="Strikeout",t[t.DoubleUnderline=512]="DoubleUnderline",t[t.Overline=1024]="Overline"})(FontStyle||(FontStyle={}));var ParserState;(function(t){t[t.None=0]="None",t[t.Ansi=1]="Ansi",t[t.AnsiParams=2]="AnsiParams",t[t.XTermTitle=3]="XTermTitle",t[t.MXPTag=4]="MXPTag",t[t.MXPTagQuoted=5]="MXPTagQuoted",t[t.MXPTagDblQuoted=6]="MXPTagDblQuoted",t[t.MXPEntity=7]="MXPEntity",t[t.MXPComment=8]="MXPComment",t[t.MXPTagArg=9]="MXPTagArg",t[t.URL=10]="URL",t[t.URLFound=11]="URLFound",t[t.MSPSound=12]="MSPSound",t[t.MSPMusic=13]="MSPMusic"})(ParserState||(ParserState={}));class MXPState{constructor(){this.on=!1,this.lineType=0,this.locked=!1,this.paragraph=!1,this.noBreak=!1,this.expanded=!1,this.lineExpanded=!1,this.capture=0,this.captured=[],this.gagged=!1}}class Entity{constructor(t){this.name="",this.value="",this.description="",this.publish=!1,this.remote=!1,this.remote=null!=t&&t}}class Element{constructor(t){this.name="",this.definition="",this.closeDefinition="",this.attributes={},this.attributeIndexes=[],this.tag=lineType.None,this.flag="",this.open=!1,this.empty=!1,this.remote=!1,this.gagged=!1,this.remote=null!=t&&t}}class Tag{constructor(t,a,o,m){this.index=lineType.None,this.window="",this.gag=!1,this.fore="",this.back="",this.enabled=!0,this.remote=!1,this.element="",this.definition="",this.closeDefinition="",null!=t&&(this.index=t),null!=a&&(this.fore=a),null!=o&&(this.back=o),null!=m&&(this.remote=m)}}class MXPStyle{constructor(t,a,o,m){this.tag=MXPTag.None,this.custom="",this.font="",this.fontSize="",this.style=FontStyle.None,this.fore="",this.back="",this.high=!1,this.obj=null,this.gagged=!1,null!=t&&(this.style=t),null!=a&&(this.fore=a),null!=o&&(this.back=o),null!=m&&(this.high=m)}}class Parser extends EventEmitter{constructor(t){super(),this.parsing=[],this.protocols=[["m","a","i","l","t","o"],["s","k","y","p","e"],["a","i","m"],["c","a","l","l","t","o"],["g","t","a","l","k"],["i","m"],["i","t","m","s"],["m","s","n","i","m"],["t","e","l"],["y","m","s","g","r"]],this._ColorTable=null,this._CurrentForeColor=37,this._CurrentBackColor=40,this._CurrentAttributes=FontStyle.None,this._SplitBuffer="",this.mxpState=new MXPState,this.mxpStyles=[],this.mxpEntities={},this.mxpElements={},this.mxpLines=[],this.iMXPDefaultMode=lineType.Open,this.displayControlCodes=!1,this.emulateControlCodes=!0,this.StyleVersion="",this.EndofLine=!1,this.TextLength=0,this.enableMXP=!0,this.DefaultImgUrl="themes/general",this.enableDebug=!1,this.enableLinks=!0,this.enableMSP=!0,this.enableURLDetection=!0,this.window=new library_1.Size(0,0),this.enableFlashing=!1,this.emulateTerminal=!1,this.bell="./../assets/sounds/bell.m4a",this.enableBell=!0,this.display=null,null!=t&&(t.DefaultImageURL&&(this.DefaultImgUrl=t.DefaultImageURL),null!=t.enableMXP&&(this.enableMXP=t.MXP),null!=t.enableDebug&&(this.enableDebug=t.enableDebug),null!=t.MSP&&(this.enableMSP=t.MSP),null!=t.URLDetection&&(this.enableURLDetection=t.enableURLDetection),null!=t.window&&(this.window=t.window),null!=t.flashing&&(this.enableFlashing=t.flashing),null!=t.terminal&&(this.emulateTerminal=t.terminal),null!=t.bell&&(this.bell=t.bell),null!=t.enableBell&&(this.enableBell=t.enableBell),null!=t.display&&(this.display=t.display),t.enableLinks&&(this.enableLinks=t.enableLinks))}getColors(t){"undefined"==typeof t&&(t=this.GetCurrentStyle());var a,o,m=-1,h=-1;return 0<t.fore.length?(this._CurrentAttributes&FontStyle.Bold)==FontStyle.Bold?a=this.IncreaseColor(t.fore,0.5):(this._CurrentAttributes&FontStyle.Faint)==FontStyle.Faint?a=this.DecreaseColor(t.fore,0.5):a=t.fore:"string"==typeof this._CurrentForeColor?a="rgb("+this._CurrentForeColor.replace(/;/g,",")+")":(a=this._CurrentForeColor,(this._CurrentAttributes&FontStyle.Bold)==FontStyle.Bold?(999<a&&(a/=1e3),0<=a&&99>a&&(a*=10),m=a,a=-16>=a?this.IncreaseColor(this.GetColor(a),0.5):this.GetColor(a)):(this._CurrentAttributes&FontStyle.Faint)==FontStyle.Faint?(99<a&&999>a&&(a/=10),0<=a&&999>a&&(a*=100),m=a,a=-16>=a?this.DecreaseColor(this.GetColor(a),0.15):this.GetColor(a)):(m=a,a=this.GetColor(a))),t.high&&(a=this.IncreaseColor(a,0.25)),0<t.back.length?o=t.back:"string"==typeof this._CurrentBackColor?o="rgb("+this._CurrentBackColor.replace(/;/g,",")+")":(h=this._CurrentBackColor,o=this.GetColor(this._CurrentBackColor)),(this._CurrentAttributes&FontStyle.Inverse)==FontStyle.Inverse||(t.style&FontStyle.Inverse)==FontStyle.Inverse?{fore:o,back:a,fcode:h,bcode:m}:{fore:a,back:o,fcode:m,bcode:h}}StartDisplayBlock(){var t=this.GetCurrentStyle(),a=this.getColors(t),o="",m="",h=["<span style=\"","color: ",a.fore,";","background-color: ",a.back,";"];return 0<t.font.length&&h.push("font-family: ",t.font,";"),0<t.fontSize.length&&h.push("font-size: ",t.fontSize,";"),(t.style&FontStyle.Bold)==FontStyle.Bold&&h.push("font-weight: bold;"),t.style|=this._CurrentAttributes,0<t.style?((t.style&FontStyle.Italic)==FontStyle.Italic&&h.push("font-style: italic;border-top: 1px solid ",a.back,";"),(t.style&FontStyle.Overline)==FontStyle.Overline&&(m+="overline "),((t.style&FontStyle.DoubleUnderline)==FontStyle.DoubleUnderline||(t.style&FontStyle.Underline)==FontStyle.Underline)&&(m+="underline "),(t.style&FontStyle.DoubleUnderline)==FontStyle.DoubleUnderline?h.push("border-bottom: 1px solid ",a.fore,";"):h.push("border-bottom: 1px solid ",a.back,";"),((t.style&FontStyle.Rapid)==FontStyle.Rapid||(t.style&FontStyle.Slow)==FontStyle.Slow)&&(this.enableFlashing?o+=" ansi-blink":(t.style&FontStyle.DoubleUnderline)!=FontStyle.DoubleUnderline&&(t.style&FontStyle.Underline)!=FontStyle.Underline&&(m+="underline ")),(t.style&FontStyle.Strikeout)==FontStyle.Strikeout&&(m+="line-through "),0<m.length&&h.push("text-decoration:",m,";")):h.push("border-bottom: 1px solid ",a.back,";"),h.push("\" class=\"ansi",o," ansifore",a.fcode," ansiback",a.bcode,"\">"),h.join("")}EndDisplayBlock(){return"</span>"}ResetColors(){this._CurrentForeColor=37,this._CurrentBackColor=40,this._CurrentAttributes=FontStyle.None}ProcessAnsiColorParams(t){for(var m,h,a=0,o=t.length;a<o;a++)switch(m=parseInt(t[a],10),m){case 0:this.ResetColors();break;case 1:this._CurrentAttributes|=FontStyle.Bold,this._CurrentAttributes&=~FontStyle.Faint;break;case 2:this._CurrentAttributes|=FontStyle.Faint,this._CurrentAttributes&=~FontStyle.Bold;break;case 3:this._CurrentAttributes|=FontStyle.Italic;break;case 4:this._CurrentAttributes|=FontStyle.Underline;break;case 5:this._CurrentAttributes|=FontStyle.Slow;break;case 6:this._CurrentAttributes|=FontStyle.Rapid;break;case 7:this._CurrentAttributes|=FontStyle.Inverse;break;case 8:this._CurrentAttributes|=FontStyle.Hidden;break;case 9:this._CurrentAttributes|=FontStyle.Strikeout;break;case 21:this._CurrentAttributes|=FontStyle.DoubleUnderline;break;case 22:this._CurrentAttributes&=~FontStyle.Bold,this._CurrentAttributes&=~FontStyle.Faint;break;case 23:this._CurrentAttributes&=~FontStyle.Italic;break;case 24:this._CurrentAttributes&=~FontStyle.Underline,this._CurrentAttributes&=~FontStyle.DoubleUnderline;break;case 25:this._CurrentAttributes&=~FontStyle.Slow;break;case 26:this._CurrentAttributes&=~FontStyle.Rapid;break;case 27:this._CurrentAttributes&=~FontStyle.Inverse;break;case 28:this._CurrentAttributes&=~FontStyle.Hidden;break;case 29:this._CurrentAttributes&=~FontStyle.Strikeout;break;case-11:case-7:case-3:case 30:case 31:case 32:case 33:case 34:case 35:case 36:case 37:this._CurrentForeColor=m;break;case 38:if(a+2<o&&"5"==t[a+1])this._CurrentForeColor=parseInt(t[a+2],10),isNaN(this._CurrentForeColor)?this._CurrentForeColor=37:(this._CurrentForeColor+=16,this._CurrentForeColor*=-1),a+=2;else if(a+4<o&&"2"==t[a+1]){if(m=parseInt(t[a+2],10),0>m||255<m)continue;if(h=m+";",m=parseInt(t[a+3],10),0>m||255<m)continue;if(h+=m+";",m=parseInt(t[a+4],10),0>m||255<m)continue;h+=m,this._CurrentForeColor=h,a+=4}break;case 39:this._CurrentForeColor=-1;break;case-12:case-8:case-4:case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:this._CurrentBackColor=m;break;case 48:if(a+2<o&&"5"==t[a+1])this._CurrentBackColor=parseInt(t[a+2],10),isNaN(this._CurrentBackColor)?this._CurrentBackColor=40:(this._CurrentBackColor+=16,this._CurrentBackColor*=-1),a+=2;else if(a+4<o&&"2"==t[a+1]){if(m=parseInt(t[a+2],10),0>m||255<m)continue;if(h=m+";",m=parseInt(t[a+3],10),0>m||255<m)continue;if(h+=m+";",m=parseInt(t[a+4],10),0>m||255<m)continue;h+=m,this._CurrentBackColor=h,a+=4}break;case 49:this._CurrentBackColor=-2;break;case 53:this._CurrentAttributes|=FontStyle.Overline;break;case 55:this._CurrentAttributes&=~FontStyle.Overline;break;case 50:case 51:case 52:case 54:case 56:case 57:case 58:case 59:this._CurrentForeColor=m-20,this._CurrentAttributes|=FontStyle.Bold;break;case 90:case 91:case 92:case 93:case 94:case 95:case 96:case 97:this._CurrentForeColor=m;break;case 100:case 101:case 102:case 103:case 104:case 105:case 106:case 107:this._CurrentBackColor=m;}}buildColorTable(){var t=[],a,o,m,h;for(a=0;6>a;a++)for(o=0;6>o;o++)for(m=0;6>m;m++)h=16+36*a+6*o+m,t[h]="rgb(",t[h]+=0<a?40*a+55:"0",t[h]+=",",t[h]+=0<o?40*o+55:"0",t[h]+=",",t[h]+=0<m?40*m+55:"0",t[h]+=")";for(a=232;255>=a;a++)o=10*(a-232)+8,t[a]=["rgb(",o,",",o,",",o,")"].join("");t[0]="rgb(0,0,0)",t[1]="rgb(128, 0, 0)",t[2]="rgb(0, 128, 0)",t[3]="rgb(128, 128, 0)",t[4]="rgb(0, 0, 238)",t[5]="rgb(128, 0, 128)",t[6]="rgb(0, 128, 128)",t[7]="rgb(187, 187, 187)",t[8]="rgb(128, 128, 128)",t[9]="rgb(255, 0, 0)",t[10]="rgb(0, 255, 0)",t[11]="rgb(255, 255, 0)",t[12]="rgb(92, 92, 255)",t[13]="rgb(255, 0, 255)",t[14]="rgb(0, 255, 255)",t[15]="rgb(255, 255, 255)",t[256]="rgb(0, 0, 0)",t[257]="rgb(118, 0, 0)",t[258]="rgb(0, 108, 0)",t[259]="rgb(145, 136, 0)",t[260]="rgb(0, 0, 167)",t[261]="rgb(108, 0, 108)",t[262]="rgb(0, 108, 108)",t[263]="rgb(161, 161, 161)",t[264]="rgb(0, 0, 0)",t[265]="rgb(128, 0, 0)",t[266]="rgb(0, 128, 0)",t[267]="rgb(128, 128, 0)",t[268]="rgb(0, 0, 238)",t[269]="rgb(128, 0, 128)",t[270]="rgb(0, 128, 128)",t[271]="rgb(187, 187, 187)",t[272]="rgb(0,0,0)",t[273]="rgb(0, 255, 255)",t[274]="rgb(0,0,0)",t[275]="rgb(255, 255, 0)",t[276]="rgb(0, 0, 0)",t[277]="rgb(229, 229, 229)",t[278]="rgb(205, 0, 0)",t[279]="rgb(229, 229, 229)",t[280]="rgb(255,255,255)",this._ColorTable=t}GetColor(t){return null==this._ColorTable&&this.buildColorTable(),-12===t?this._ColorTable[279]:-11===t?this._ColorTable[278]:-10===t?this._ColorTable[280]:-8===t?this._ColorTable[272]:-7===t?this._ColorTable[273]:-4===t?this._ColorTable[274]:-3===t?this._ColorTable[275]:49===t||-2===t?this._ColorTable[276]:39===t||-1===t?this._ColorTable[277]:0===t||30===t?this._ColorTable[0]:1===t||31===t?this._ColorTable[1]:2===t||32===t?this._ColorTable[2]:3===t||33===t?this._ColorTable[3]:4===t||34===t?this._ColorTable[4]:5===t||35===t?this._ColorTable[5]:6===t||36===t?this._ColorTable[6]:7===t||37===t?this._ColorTable[7]:40===t?this._ColorTable[264]:41===t?this._ColorTable[265]:42===t?this._ColorTable[266]:43===t?this._ColorTable[267]:44===t?this._ColorTable[268]:45===t?this._ColorTable[269]:46===t?this._ColorTable[270]:47===t?this._ColorTable[271]:8===t||90===t||100===t||300===t||400===t?this._ColorTable[8]:9===t||91===t||101===t||310===t||410===t?this._ColorTable[9]:10===t||92===t||102===t||320===t||420===t?this._ColorTable[10]:11===t||93===t||103===t||330===t||430===t?this._ColorTable[11]:12===t||94===t||104===t||340===t||440===t?this._ColorTable[12]:13===t||95===t||105===t||350===t||450===t?this._ColorTable[13]:14===t||96===t||106===t||360===t||460===t?this._ColorTable[14]:15===t||97===t||107===t||370===t||470===t?this._ColorTable[15]:4e3===t||3e3===t?this._ColorTable[256]:4100===t||3100===t?this._ColorTable[257]:4200===t||3200===t?this._ColorTable[258]:4300===t||3300===t?this._ColorTable[259]:4400===t||3400===t?this._ColorTable[260]:4500===t||3500===t?this._ColorTable[261]:4600===t||3600===t?this._ColorTable[262]:4700===t||3700===t?this._ColorTable[263]:(-16>=t&&(t+=16,t*=-1),0<=t&&281>t?this._ColorTable[t]:this._ColorTable[277])}SetColor(t,a){(null===this._ColorTable&&this.buildColorTable(),!(0>t||t>=this._ColorTable.length))&&(a=new RGBColor(a),a.ok&&(this._ColorTable[t]=a.toRGB()))}AddLine(t,a,o){this.emit("addLine",{line:t,fragment:a,gagged:o}),this.EndofLine=!a}GetEntity(t){return"text"==t?t:this.mxpEntities[t]?(this.mxpState.expanded=!0,this.mxpEntities[t].value):t}ClearMXPToTag(t,a){null==a&&(a="");var o=new MXPStyle;o.tag=MXPTag.None;for(var m=this.mxpStyles.length-1;0<=m&&this.mxpStyles[m].tag!=t&&this.mxpStyles[m].custom!=a;m--)o=this.mxpStyles.pop();return 0<this.mxpStyles.length?o=this.mxpStyles.pop():0===this.mxpStyles.length&&this.ResetMXP(),o}ParseMXPTag(t,a,o){var m,h,S,C,T,E,L,k,B,y=a.length,P="",_="",R="",M=!1;switch(t=t.toUpperCase(),this.enableDebug&&(this.emit("debug","MXP Tag: "+t),this.emit("debug","MXP Tag Args: "+a)),t){case"C":case"COLOR":if(m=this.GetCurrentStyle(),m.tag=MXPTag[t],0<y)if(h=a[0].split("="),1<h.length){if(T=new RGBColor(library_1.stripQuotes(h[1])),!T.ok)return null;"BACK"==h[0].toUpperCase()?m.back=T.toRGB():m.fore=T.toRGB()}else T=new RGBColor(library_1.stripQuotes(h[0])),T.ok&&(m.fore=T.toRGB());if(1<y)if(h=a[1].split("="),1<h.length){if(T=new RGBColor(library_1.stripQuotes(h[1])),!T.ok)return null;"FORE"==h[0].toUpperCase()?m.fore=T.toRGB():m.back=T.toRGB()}else T=new RGBColor(library_1.stripQuotes(h[0])),T.ok&&(m.back=T.toRGB());return m.custom="",this.mxpStyles.push(m),null;case"B":case"BOLD":case"STRONG":return m=this.GetCurrentStyle(),m.tag=MXPTag[t],m.style|=FontStyle.Bold,m.custom="",this.mxpStyles.push(m),null;case"FONT":for(m=this.GetCurrentStyle(),m.tag=MXPTag[t],E=0;E<y;E++)if(h=a[E].split("="),1<h.length)switch(h[0].toUpperCase()){case"SIZE":m.fontSize=this.isNumber(h[1])?h[1]+"pt":h[1];break;case"COLOR":for(C=h[1].split(","),T=new RGBColor(library_1.stripQuotes(C[0])),T.ok&&(m.fore=T.toRGB()),(B=1,k=C.length);B<k;B++)switch(C[B].toLowerCase()){case"bold":m.style|=FontStyle.Bold;break;case"italic":m.style|=FontStyle.Italic;break;case"underline":m.style|=FontStyle.Underline;break;case"blink":m.style|=FontStyle.Slow;break;case"inverse":m.style|=FontStyle.Inverse;}break;case"BACK":T=new RGBColor(library_1.stripQuotes(h[1])),T.ok&&(m.back=T.toRGB());break;case"FACE":m.font=library_1.stripQuotes(h[1]);break;default:this.enableDebug&&this.emit("debug","Invalid Argument for "+t+": "+h[0]);}else 0===E?m.font=library_1.stripQuotes(a[E]):1==E?m.fontSize=this.isNumber(a[E])?a[E]+"pt":a[E]:2==E?(T=new RGBColor(library_1.stripQuotes(a[E])),T.ok&&(m.fore=T.toRGB())):3==E&&(T=new RGBColor(library_1.stripQuotes(a[E])),T.ok&&(m.back=T.toRGB()));return m.custom="",this.mxpStyles.push(m),null;case"H":case"HIGH":return m=this.GetCurrentStyle(),m.tag=MXPTag[t],m.high=!0,m.custom="",this.mxpStyles.push(m),null;case"I":case"ITALIC":case"EM":return m=this.GetCurrentStyle(),m.tag=MXPTag[t],m.style|=FontStyle.Italic,m.custom="",this.mxpStyles.push(m),null;case"U":case"UNDERLINE":return m=this.GetCurrentStyle(),m.tag=MXPTag[t],m.style|=FontStyle.Underline,m.custom="",this.mxpStyles.push(m),null;case"S":case"STRIKEOUT":return m=this.GetCurrentStyle(),m.tag=MXPTag[t],m.style|=FontStyle.Strikeout,m.custom="",this.mxpStyles.push(m),null;case"/B":case"/BOLD":case"/STRONG":case"/H":case"/HIGH":case"/I":case"/ITALIC":case"/EM":case"/U":case"/UNDERLINE":case"/S":case"/STRIKEOUT":case"/C":case"/COLOR":case"/FONT":return this.ClearMXPToTag(MXPTag[t.substring(1)]),null;}if(this.mxpState.lineType==lineType.Secure||this.mxpState.lineType==lineType.LockSecure||this.mxpState.lineType==lineType.TempSecure)switch(t){case"IMAGE":for(L={name:"",url:this.DefaultImgUrl,t:"",h:"",w:"",hspace:"",vspace:"",align:"bottom",ismap:!1},E=0;E<y;E++)switch(h=a[E].split("="),h[0].toUpperCase()){case"FNAME":L.name=library_1.stripQuotes(h[1]);break;case"URL":L.url=library_1.stripQuotes(h[1]);break;case"T":0<h[1].length&&(L.type=h[1]);break;case"H":L.h=library_1.stripQuotes(h[1]);break;case"W":L.w=library_1.stripQuotes(h[1]);break;case"HSPACE":L.hspace=h[1];break;case"VSPACE":L.vspace=h[1];break;case"ALIGN":L.align=h[1];break;case"ISMAP":L.ismap=!0;break;default:0===E?L.name=library_1.stripQuotes(a[E]):1===E?L.url=library_1.stripQuotes(a[E]):2===E&&0<a[E].length?L.type=a[E]:3===E?L.h=library_1.stripQuotes(a[E]):4===E?L.w=library_1.stripQuotes(a[E]):5===E?L.hspace=a[E]:6===E?L.vspace=a[E]:7===E&&(L.align=a[E]);}switch(m="",B=["<img src=\""],0<L.url.length&&(B.push(L.url),m+=L.url,!L.url.endsWith("/")&&(B.push("/"),m+="/")),0<L.t.length&&(B.push(L.t),m+=L.t,!L.t.endsWith("/")&&(B.push("/"),m+="/")),m+=L.name,B.push(L.name),B.push("\""),B.push(" style=\""),0<L.w.length&&(B.push("width:"),B.push(L.w),B.push(";")),0<L.h.length&&(B.push("height:"),B.push(L.h),B.push(";")),L.align.toLowerCase()){case"left":B.push("float:left;");break;case"right":B.push("float:right;");break;case"top":case"middle":case"bottom":B.push("vertical-align:"),B.push(L.align),B.push(";");}0<L.hspace.length&&0<L.vspace.length?(B.push("margin:"),this.isNumber(L.vspace)&&(L.vspace=parseInt(L.vspace,10)+"px"),B.push(L.vspace," "),this.isNumber(L.hspace)&&(L.hspace=parseInt(L.hspace,10)+"px"),B.push(L.hspace,";")):0<L.hspace.length?(B.push("margin:"),this.isNumber(L.hspace)&&(L.hspace=parseInt(L.hspace,10)+"px"),B.push("0px ",L.hspace,";")):0<L.vspace.length&&(B.push("margin:"),this.isNumber(L.vspace)&&(L.vspace=parseInt(L.vspace,10)+"px"),B.push(L.vspace," 0px;")),B.push("\""),L.ismap&&B.push(" ismap onclick=\"return false;\""),B.push("/>");var A=new Image;return A.src=m,B.join("");case"!AT":case"!ATTLIST":if(0===a.length)return null;if(L=a[0],!this.mxpElements[L]||this.mxpEntities[L].remote!=L.remote&&!this.mxpEntities[L].open)return null;for(this.mxpElements[L].attributes={},this.mxpElements[L].attributeIndexes=[],E=1;E<y;E++)C=a[E].split("="),this.mxpElements[L].attributes[C[0].toLowerCase()]=1<C.length?C[1]:"",this.mxpElements[L].attributeIndexes.push(C[0].toLowerCase());break;case"!TAG":for(L=new Tag,L.remote=o,E=0;E<y;E++)switch(h=a[E].split("="),h[0].toUpperCase()){case"WINDOWNAME":L.window=library_1.stripQuotes(h[1]);break;case"FORE":T=new RGBColor(library_1.stripQuotes(h[1])),T.ok&&(L.fore=T.toRGB());break;case"BACK":T=new RGBColor(library_1.stripQuotes(h[1])),T.ok&&(L.back=T.toRGB());break;case"GAG":L.gag=!0;break;case"ENABLE":L.enabled=!0;break;case"DISABLE":L.enabled=!1;break;default:0===E?(m=parseInt(a[E],10),!isNaN(m)&&(L.index=m)):1===E?L.window=library_1.stripQuotes(a[E]):2===E?(T=new RGBColor(library_1.stripQuotes(a[E])),T.ok&&(L.fore=T.toRGB())):3===E&&(T=new RGBColor(library_1.stripQuotes(a[E])),T.ok&&(L.back=T.toRGB()));}0<L.fore.length&&0<L.back.length?L.definition="<C \""+L.fore+"\" \""+L.back+"\">":0<L.fore.length?L.definition="<C \""+L.fore+"\">":0<L.back.length&&(L.definition="<C BACK=\""+L.back+"\">"),0<L.definition.length&&(L.closeDefinition="</C>"),this.mxpLines[L.index]?(L.remote||this.mxpLines[L.index].remote==L.remote)&&(this.mxpLines[L.index]=L):this.mxpLines[L.index]=L;break;case"!EL":case"!ELEMENT":for(L=new Element(o),E=0;E<y;E++){if(a[E].toUpperCase().startsWith("ATT=")){for(h=library_1.stripQuotes(a[E]).substring(4).split(" "),B=0,k=h.length;B<k;B++)C=library_1.stripQuotes(h[B]).split("="),L.attributes[C[0].toLowerCase()]=1<C.length?library_1.stripQuotes(C[1]):"",L.attributeIndexes.push(C[0].toLowerCase());continue}switch(h=a[E].split("="),h[0].toUpperCase()){case"TAG":m=parseInt(h[1],10),isNaN(m)||(L.tag=m);break;case"FLAG":L.flag=library_1.stripQuotes(h[1]);break;case"OPEN":L.open=!0;break;case"DELETE":return this.mxpElements[L.name]&&(this.mxpEntities[L.name].remote==L.remote||this.mxpEntities[L.name].open)&&delete this.mxpEntities[L.name],null;case"EMPTY":L.empty=!0;break;case"SECURE":L.open=!1;break;default:if(0===E)L.name=library_1.stripQuotes(a[E]).toUpperCase();else if(1===E)L.definition=library_1.stripQuotes(a[E]),L.closeDefinition=this.GetCloseTags(L.definition),this.enableDebug&&this.emit("debug","MXP close defintion: "+L.closeDefinition);else if(2===E)for(h=a[E].substring(4).split(" "),B=0,k=h.length;B<k;B++)C=h[B].split("="),L.attributes[C[0]]=1<C.length?C[1]:"",L.attributeIndexes.push(C[0]);else 3===E?(m=parseInt(a[E],10),isNaN(m)||(L.tag=m)):4===E&&(L.flag=library_1.stripQuotes(a[E]));}}19<L.tag&&100>L.tag&&(m=new Tag(L.tag),m.element=L.name,this.mxpLines[m.index]?(L.remote||this.mxpLines[m.index].remote==L.remote)&&(this.mxpLines[m.index]=m):this.mxpLines[m.index]=m),this.mxpElements[L.name]?(this.mxpElements[L.name].remote==L.remote||this.mxpEntities[L.name].open)&&(this.mxpElements[L.name]=L):this.mxpElements[L.name]=L;break;case"!EN":case"!ENTITY":for(L=new Entity(o),E=0;E<y;E++)switch(h=a[E].split("="),h[0].toUpperCase()){case"DESC":L.description=library_1.stripQuotes(h[1]);break;case"PRIVATE":L.publish=!1;break;case"PUBLISH":L.publish=!0;break;case"DELETE":return this.mxpEntities[L.name]&&this.mxpEntities[L.name].remote==L.remote&&delete this.mxpEntities[L.name],null;case"ADD":if(this.mxpEntities[L.name]&&this.mxpEntities[L.name].remote==L.remote)return this.mxpEntities[L.name].value?this.mxpEntities[L.name].value+="|"+L.value:this.mxpEntities[L.name].value=L.value,null;break;case"REMOVE":if(this.mxpEntities[L.name]&&this.mxpEntities[L.name].remote==L.remote&&this.mxpEntities[L.name].value){for(C=this.mxpEntities[L.name].value.split("|"),S=[],(B=0,k=C.length);B<k;B++)C[B]!=L.value&&S.push(C[B]);this.mxpEntities[L.name].value=S.join("|")}return null;default:0===E?L.name=library_1.stripQuotes(a[E]):1===E?L.value=library_1.stripQuotes(a[E]):2===E&&(L.description=library_1.stripQuotes(a[E]));}this.mxpEntities[L.name]?this.mxpEntities[L.name].remote==L.remote&&(this.mxpEntities[L.name]=L):this.mxpEntities[L.name]=L;break;case"/V":case"/VAR":for(m=this.ClearMXPToTag(MXPTag[t.substring(1)]),L=new Entity(o),L.value=this.mxpState.captured.pop().join(""),this.mxpState.capture--,this.enableDebug&&this.emit("debug","MXP captured: "+L.value),a=m.obj,y=a.length,E=0;E<y;E++)switch(h=a[E].split("="),h[0].toUpperCase()){case"DESC":L.description=library_1.stripQuotes(h[1]);break;case"PRIVATE":L.publish=!1;break;case"PUBLISH":L.publish=!0;break;case"DELETE":return this.mxpEntities[L.name]&&this.mxpEntities[L.name].remote==L.remote&&delete this.mxpEntities[L.name],null;case"ADD":if(this.mxpEntities[L.name]&&this.mxpEntities[L.name].remote==L.remote)return this.mxpEntities[L.name].value?this.mxpEntities[L.name].value+="|"+L.value:this.mxpEntities[L.name].value=L.value,null;break;case"REMOVE":if(this.mxpEntities[L.name]&&this.mxpEntities[L.name].remote==L.remote&&this.mxpEntities[L.name].value){for(C=this.mxpEntities[L.name].value.split("|"),S=[],(B=0,k=C.length);B<k;B++)C[B]!=L.value&&S.push(C[B]);this.mxpEntities[L.name].value=S.join("|")}return null;default:0===E?L.name=library_1.stripQuotes(a[E]):1===E&&(L.description=library_1.stripQuotes(a[E]));}this.mxpEntities[L.name]?this.mxpEntities[L.name].remote==L.remote&&(this.mxpEntities[L.name]=L):this.mxpEntities[L.name]=L;break;case"V":case"VAR":return this.mxpState.captured.push([]),this.mxpState.capture++,m=this.GetCurrentStyle(),m.tag=MXPTag[t],m.obj=a,m.custom="",this.mxpStyles.push(m),null;case"GAUGE":for(L={value:0,max:1,caption:"",color:""},E=0;E<y;E++)if(h=a[E].split("="),1<h.length)switch(h[0].toUpperCase()){case"VALUE":m=parseFloat(this.GetEntity(a[E])),isNaN(m)&&(m=this.GetEntity(a[E])),L.value=m;break;case"MAX":m=parseFloat(this.GetEntity(a[E])),isNaN(m)&&(m=this.GetEntity(a[E])),L.max=m;break;case"CAPTION":0<h[E].length&&(L.caption=library_1.stripQuotes(a[E]));break;case"COLOR":T=new RGBColor(library_1.stripQuotes(h[1])),T.ok&&(L.color=T.toRGB());}else 0===E?(m=parseFloat(this.GetEntity(a[E])),isNaN(m)&&(m=this.GetEntity(a[E])),L.value=m):1===E?(m=parseFloat(this.GetEntity(a[E])),isNaN(m)&&(m=this.GetEntity(a[E])),L.max=m):2===E&&0<a[E].length?L.caption=library_1.stripQuotes(a[E]):3===E&&0<a[E].length&&(T=new RGBColor(library_1.stripQuotes(h[1])),T.ok&&(L.color=T.toRGB()));this.mxpState.expanded=!1,this.emit("gauge",L);break;case"STAT":for(L={value:0,max:1,caption:""},E=0;E<y;E++)if(h=a[E].split("="),1<h.length)switch(h[0].toUpperCase()){case"VALUE":m=parseFloat(this.GetEntity(a[E])),isNaN(m)&&(m=this.GetEntity(a[E])),L.value=m;break;case"MAX":m=parseFloat(this.GetEntity(a[E])),isNaN(m)&&(m=this.GetEntity(a[E])),L.max=m;break;case"CAPTION":0<h[E].length&&(L.caption=library_1.stripQuotes(a[E]));}else 0===E?(m=parseFloat(this.GetEntity(a[E])),isNaN(m)&&(m=this.GetEntity(a[E])),L.value=m):1===E?(m=parseFloat(this.GetEntity(a[E])),isNaN(m)&&(m=this.GetEntity(a[E])),L.max=m):2===E&&0<a[E].length&&(L.caption=library_1.stripQuotes(a[E]));this.mxpState.expanded=!1,this.emit("stat",L);break;case"MUSIC":for(L={off:!1,file:"",url:"",volume:100,repeat:1,prioirty:50,type:"",continue:!0},E=0;E<y;E++)if(h=a[E].split("="),1<h.length)switch(h[0].toUpperCase()){case"FNAME":L.file=library_1.stripQuotes(h[E]),"off"==L.file.toLowerCase()&&(L.off=!0,L.file="");break;case"V":m=parseInt(h[E],10),isNaN(m)&&(m=100),L.volume=m;break;case"L":m=parseInt(h[E],10),isNaN(m)&&(m=1),L.repeat=m;break;case"C":L.continue="0"!=h[E];break;case"T":0<h[1].length&&(L.type=h[E]);break;case"U":L.url=library_1.stripQuotes(h[E]),!L.url.endsWith("/")&&0<L.url.length&&(L.Url+="/");}else 0===E?(L.file=library_1.stripQuotes(a[E]),"off"==L.file.toLowerCase()&&(L.off=!0,L.file="")):1===E?(m=parseInt(a[E],10),isNaN(m)&&(m=100),L.volume=m):2===E?(m=parseInt(a[E],10),isNaN(m)&&(m=1),L.repeat=m):3===E?L.continue="0"!=a[E]:4===E?0<a[E].length&&(L.type=a[E]):5===E&&(L.url=library_1.stripQuotes(a[E]),!L.url.endsWith("/")&&0<L.url.length&&(L.Url+="/"));this.emit("music",L);break;case"SOUND":for(L={off:!1,file:"",url:"",volume:100,repeat:1,prioirty:50,type:"",continue:!0},E=0;E<y;E++)if(h=a[E].split("="),1<h.length)switch(h[0].toUpperCase()){case"FNAME":L.file=library_1.stripQuotes(h[E]),"off"==L.file.toLowerCase()&&(L.off=!0,L.file="");break;case"V":m=parseInt(h[E],10),isNaN(m)&&(m=100),L.volume=m;break;case"L":m=parseInt(h[E],10),isNaN(m)&&(m=1),L.repeat=m;break;case"P":m=parseInt(h[E],10),isNaN(m)&&(m=1),L.prioirty=m;break;case"T":0<h[E].length&&(L.type=h[E]);break;case"U":L.url=library_1.stripQuotes(h[E]),!L.url.endsWith("/")&&0<L.url.length&&(L.Url+="/");}else 0===E?(L.file=library_1.stripQuotes(a[E]),"off"==L.file.toLowerCase()&&(L.off=!0,L.file="")):1===E?(m=parseInt(a[E],10),isNaN(m)&&(m=100),L.volume=m):2===E?(m=parseInt(a[E],10),isNaN(m)&&(m=1),L.repeat=m):3===E?(m=parseInt(a[E],10),isNaN(m)&&(m=1),L.prioirty=m):4===E?0<a[E].length&&(L.type=a[E]):5===E&&(L.url=library_1.stripQuotes(a[E]),!L.url.endsWith("/")&&0<L.url.length&&(L.Url+="/"));this.emit("sound",L);break;case"EXPIRE":var U=this;setTimeout(function(){U.emit("expireLinks",a)},1);break;case"VERSION":0<y?this.StyleVersion=a[0]:this.emit("MXPTagReply",t,[]);break;case"USER":case"PASSWORD":this.emit("MXPTagReply",t,a);break;case"SUPPORT":if(C=[],0<y){for(E=0;E<y;E++)if(h=library_1.stripQuotes(a[E]),-1==h.indexOf("."))switch(h=h.toUpperCase(),h){case"HR":case"A":case"SEND":case"B":case"I":case"COLOR":case"C":case"EM":case"ITALIC":case"STRONG":case"BOLD":case"UNDERLINE":case"U":case"S":case"STRIKEOUT":case"STRIKE":case"H":case"HIGH":case"FONT":case"EXPIRE":case"VERSION":case"SUPPORT":case"NOBR":case"P":case"BR":case"SBR":case"SOUND":case"MUSIC":case"VAR":case"USER":case"PASSWORD":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"IMAGE":case"RESET":case"GAUGE":case"STAT":C.push("+"+name);break;default:C.push("-"+name);}else switch(h=a[E].split("."),h[0]=h[0].toUpperCase(),h[0]){case"IMAGE":"*"==h[1]?(C.push("+image.fname"),C.push("+image.url"),C.push("+image.t"),C.push("+image.h"),C.push("+image.w"),C.push("+image.hspace"),C.push("+image.vspace"),C.push("+image.align"),C.push("+image.ismap")):C.push("+"+h[0]+"."+h[1]);break;case"SOUND":"*"==h[1]?(C.push("+sound.v"),C.push("+sound.l"),C.push("+sound.p"),C.push("+sound.t"),C.push("+sound.u")):C.push("+"+h[0]+"."+h[1]);break;case"MUSIC":"*"==h[1]?(C.push("+music.v"),C.push("+music.l"),C.push("+music.c"),C.push("+music.t"),C.push("+music.u")):C.push("+"+h[0]+"."+h[1]);break;case"A":"*"==h[1]?(C.push("+a.href"),C.push("+a.hint"),C.push("+a.expire")):C.push("+"+h[0]+"."+h[1]);break;case"SEND":"*"==h[1]?(C.push("+send.href"),C.push("+send.hint"),C.push("+send.prompt"),C.push("+send.expire")):C.push("+"+h[0]+"."+h[1]);break;case"COLOR":"*"==h[1]?(C.push("+color.fore"),C.push("+color.back")):C.push("+"+h[0]+"."+h[1]);break;case"C":"*"==h[1]?(C.push("+c.fore"),C.push("+c.back")):C.push("+"+h[0]+"."+h[1]);break;case"FONT":"*"==h[1]?(C.push("+font.face"),C.push("+font.size"),C.push("+font.color"),C.push("+font.back")):C.push("+"+h[0]+"."+h[1]);break;case"EXPIRE":"*"==h[1]?C.push("+expire.Name"):C.push("+"+h[0]+"."+h[1]);break;case"GAUGE":"*"==h[1]?(C.push("+gauge.max"),C.push("+gauge.caption"),C.push("+gauge.color")):C.push("+"+h[0]+"."+h[1]);break;case"STAT":"*"==h[1]?(C.push("+stat.max"),C.push("+stat.caption")):C.push("+"+h[0]+"."+h[1]);break;default:"*"==h[1]?C.push("-"+h[0]):C.push("-"+h[0]+"."+h[1]);}}else this.emit("MXPTagReply",t,["+A","+SEND","+B","+I","+COLOR","+C","+EM","+ITALIC","+STRONG","+BOLD","+UNDERLINE","+U","+S","+STRIKEOUT","+H","+HIGH","+FONT","+EXPIRE","+VERSION","+SUPPORT","+NOBR","+P","+BR","+SBR","+VAR","+SOUND","+MUSIC","+USER","+PASSWORD","+RESET","+STRIKE","+H1","+H2","+H3","+H4","+H5","+H6","+IMAGE","+STAT","+GAUGE"]);break;case"A":for(m=this.GetCurrentStyle(),m.tag=MXPTag[t],E=0;E<y;E++)if(h=a[E].split("="),1<h.length)switch(h[0].toUpperCase()){case"HREF":P=library_1.stripQuotes(h[1]);break;case"HINT":_=library_1.stripQuotes(h[1]);break;case"EXPIRE":R=library_1.stripQuotes(h[1]);break;default:this.enableDebug&&this.emit("debug","Invalid Argument for "+t+": "+h[0]);}else 0===E?P=library_1.stripQuotes(a[E]):1===E?_=library_1.stripQuotes(a[E]):2===E&&(R=library_1.stripQuotes(a[E]));return m.custom="",this.mxpStyles.push(m),0===_.length&&(_=P),0<R.length?"<a class=\"MXPLink\" href=\"javascript:void(0);\" title=\""+_+"\" expire=\""+R+"\" onclick=\""+this.mxpLinkFunction+"(this, '"+P+"');return false;\">":"<a class=\"MXPLink\" href=\"javascript:void(0);\" title=\""+_+"\" onclick=\""+this.mxpLinkFunction+"(this, '"+P+"');return false;\">";case"SEND":for(m=this.GetCurrentStyle(),m.tag=MXPTag[t],E=0;E<y;E++)if(h=a[E].split("="),"PROMPT"==h[0])M=!0;else if(1<h.length)switch(h[0].toUpperCase()){case"HREF":P=library_1.stripQuotes(h[1]);break;case"HINT":_=library_1.stripQuotes(h[1]);break;case"EXPIRE":R=library_1.stripQuotes(h[1]);break;case"PROMPT":M=!0;break;default:this.enableDebug&&this.emit("debug","Invalid Argument for "+t+": "+h[0]);}else 0===E?P=library_1.stripQuotes(a[E]):1===E?_=library_1.stripQuotes(a[E]):2===E?M=!0:3===E&&(R=library_1.stripQuotes(a[E]));m.custom="",this.mxpStyles.push(m),0===P.length&&(P="&text;"),0===_.length&&(_=P);var D=P.split("|"),X=0;if(1<D.length){var I=_.split("|");I.length==D.length+1&&(_=I[0],I.shift(),X="['"+I.join("','")+"']"),P="['"+D.join("','")+"']"}else P="'"+P+"'";var N=["<a class=\"MXPLink\" href=\"javascript:void(0);\" onclick=\""+this.mxpSendFunction+"(event||window.event, this, ",P,", ",M?1:0,", ",X,");return false;\" title=\"",_,"\" onmouseover=\""+this.mxpTooltipFunction+"(this)\""];return 0<R.length&&N.push(" expire=\"",R,"\""),N.push(">"),N.join("");case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":return m=this.GetCurrentStyle(),m.tag=MXPTag[t],m.style|=FontStyle.Bold,m.custom="",this.mxpStyles.push(m),null;case"/A":case"/SEND":return this.ClearMXPToTag(MXPTag[t.substring(1)]),"</a>";case"/H1":case"/H2":case"/H3":case"/H4":case"/H5":case"/H6":return this.ClearMXPToTag(MXPTag[t.substring(1)]),null;case"NOBR":return this.mxpState.noBreak=!0,null;case"/P":return this.ClearMXPToTag(MXPTag[t.substring(1)]),this.mxpState.paragraph=!1,null;case"P":return m=this.GetCurrentStyle(),m.tag=MXPTag[t],m.custom="",this.mxpStyles.push(m),this.mxpState.paragraph=!0,null;case"SBR":return"<wbr> ";case"RESET":return this.ResetMXP(),null;case"HR":var O=this.getColors();return"<div class=\"line ansiback"+O.bcode+"\" style=\"position:relative;background-color:"+O.back+"\"> <div style=\"position:absolute;top: 49%;height:4px;width:100%;background-color:"+O.fore+"\" class=\" ansifore"+O.fcode+"\"><hr/></div></div>";}if(this.mxpElements[t]){if(L=this.mxpElements[t],!L.open&&this.mxpState.lineType!=lineType.Secure&&this.mxpState.lineType!=lineType.LockSecure&&this.mxpState.lineType!=lineType.TempSecure)return null;for(m=this.GetCurrentStyle(),m.tag=MXPTag.Custom,m.custom=L.name,h=L.definition,C={},(B=0,k=L.attributeIndexes.length);B<k;B++)C[L.attributeIndexes[B]]=L.attributes[L.attributeIndexes[B]];for(E=0;E<y;E++)S=a[E].split("="),S[0]=S[0].toLowerCase(),L.attributes[S[0]]?C[S[0]]=S[1]:E<L.attributeIndexes.length&&(C[L.attributeIndexes[E]]=S[0]);for(S in C)C.hasOwnProperty(S)&&(h=h.replace("&"+S+";",C[S]));return L.empty||(this.mxpState.captured.push([]),this.mxpState.capture++),19<L.tag&&100>L.tag&&this.mxpLines[L.tag].enabled&&0<this.mxpLines[L.tag].definition.length&&(h=this.mxpLines[L.tag].definition+h,m.gagged=this.mxpLines[L.tag].gag),this.mxpState.gagged=m.gagged,this.mxpState.expanded=!0,this.mxpStyles.push(m),h}return t.startsWith("/")&&this.mxpElements[t.substring(1)]&&!this.mxpElements[t.substring(1)].empty?(t=t.substring(1),L=this.mxpElements[t],!L.open&&this.mxpState.lineType!=lineType.Secure&&this.mxpState.lineType!=lineType.LockSecure&&this.mxpState.lineType!=lineType.TempSecure)?null:(!L.empty&&0<this.mxpState.capture&&(S=this.mxpState.captured.pop().join(""),this.mxpState.capture--),h=L.closeDefinition,0<L.flag.length&&(4<L.flag.length&&L.flag.toLowerCase().startsWith("set ")&&this.emit("setVariable",L.flag.substring(4),S),this.emit("MXPFlag",L.flag,S)),19<L.tag&&100>L.tag&&this.mxpLines[L.tag].enabled&&0<this.mxpLines[L.tag].closeDefinition.length&&(h+=this.mxpLines[L.tag].closeDefinition),this.mxpState.gagged=!L.gagged,L.empty)?null:(this.mxpState.expanded=!0,h):null}GetCloseTags(t){if("undefined"==typeof t||0===t.length)return"";for(var S,a=0,o=t.length,m=[],h=[],T=0;a<o;a++)switch(S=t.charAt(a),T){case 1:" "==S?(m.push(h.join("")),h=[],T=2):">"==S?(m.push(h.join("")),h=[],T=0):h.push(S);break;case 2:">"==S&&(T=0);break;default:"<"==S&&(T=1);}return 1==T&&m.push(h.join("")),0===m.length?"":"</"+m.reverse().join("></")+">"}GetCurrentStyle(){var t;return 0===this.mxpStyles.length&&this.mxpStyles.push(new MXPStyle(FontStyle.None,"","",!1)),t=this.mxpStyles[this.mxpStyles.length-1],this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(t.gagged=this.mxpLines[this.mxpState.lineType].gag),library_1.clone(t)}DecreaseColor(t,a){var o=new RGBColor(t);return o.ok?(o.b-=_Mathceil(o.b*a),0>o.b&&(o.b=0),o.g-=_Mathceil(o.g*a),0>o.g&&(o.g=0),o.r-=_Mathceil(o.r*a),0>o.r&&(o.r=0),o.toRGB()):t}IncreaseColor(t,a){var o=new RGBColor(t);return o.ok?(o.b+=_Mathceil(o.b*a),255<o.b&&(o.b=255),o.g+=_Mathceil(o.g*a),255<o.g&&(o.g=255),o.r+=_Mathceil(o.r*a),255<o.r&&(o.r=255),o.toRGB()):t}MXPCapture(t){if(!(1>this.mxpState.capture))for(var a=0,o=this.mxpState.captured.length;a<o;a++)this.mxpState.captured[a].push(t)}MXPDeCapture(t){if(!(1>this.mxpState.capture))for(var a=0,o=this.mxpState.captured.length;a<o;a++)for(var m=0;m<t;m++)this.mxpState.captured[a].pop()}isNumber(t){return /^\d+$/.test(t)}CurrentAnsiCode(){var t="\x1B[";return t+="string"==typeof this._CurrentForeColor?"38;2;"+this._CurrentForeColor:-16>=this._CurrentForeColor?"38;5;"+(-1*this._CurrentForeColor-16)+";":this._CurrentForeColor+";",t+="string"==typeof this._CurrentBackColor?"48;2;"+this._CurrentBackColor:-16>=this._CurrentBackColor?"38;5;"+(-1*this._CurrentBackColor-16)+";":this._CurrentBackColor+";",0<this._CurrentAttributes&&((this._CurrentAttributes&FontStyle.Inverse)==FontStyle.Inverse&&(t+="7;"),(this._CurrentAttributes&FontStyle.Bold)==FontStyle.Bold&&(t+="1;"),(this._CurrentAttributes&FontStyle.Italic)==FontStyle.Italic&&(t+="3;"),(this._CurrentAttributes&FontStyle.Underline)==FontStyle.Underline&&(t+="4;"),(this._CurrentAttributes&FontStyle.Slow)==FontStyle.Slow&&(t+="5;"),(this._CurrentAttributes&FontStyle.Rapid)==FontStyle.Rapid&&(t+="6;"),(this._CurrentAttributes&FontStyle.Strikeout)==FontStyle.Strikeout&&(t+="9;"),(this._CurrentAttributes&FontStyle.Faint)==FontStyle.Faint&&(t+="2;"),(this._CurrentAttributes&FontStyle.DoubleUnderline)==FontStyle.DoubleUnderline&&(t+="21;"),(this._CurrentAttributes&FontStyle.Overline)==FontStyle.Overline&&(t+="53;")),t+"m"}parse(t,a,o){if(null===t||0===t.length)return t;null==a&&(a=!1);var L,k,B,P,_,m="",h=null,S=null,C=["<span class=\"line\">"],T=ParserState.None,E=ParserState.None,y=0,R=!1;if(0<this.parsing.length&&!o)return void this.parsing.push([t,a]);if(this.parsing.unshift([t,a]),!this.EndofLine&&0<this.TextLength){var M=this.display&&null!==this.display?this.display.children(".line"):$("#display .line");var A=M[M.length-1];C.push($(A).html()),$(A).remove(),A=null,M=null}C.push(this.StartDisplayBlock()),0<this._SplitBuffer.length&&(t=this._SplitBuffer+t,this._SplitBuffer="");var X,I,V,U=0,D=t.length,N=this.emulateControlCodes,O=this.displayControlCodes,v=this.emulateTerminal,G=this.enableURLDetection,Q=this.enableMSP,H=0,F=0,w=null,W=this.protocols.length;try{for(U=0;U<D;U++)switch(X=t.charAt(U),I=t.charCodeAt(U),T){case ParserState.AnsiParams:if("C"===X||"K"===X||"s"===X||"u"===X||"l"===X||"h"===X||"A"===X||"B"===X||"D"===X||"E"===X||"F"===X||"f"===X||"G"===X||"H"===X||"n"===X||"S"===X||"T"===X||"r"===X)this.ResetMXP(),this._SplitBuffer="",S=null,T=ParserState.None;else if("z"===X){k=S.split(";"),S=0;for(var K=k.length-1;0<=K;K--)if(0<k[K].length){S=k[0];break}switch(L=parseInt(S,10),isNaN(L)&&(L=0),this.mxpState.on=!0,this.mxpState.noBreak=!1,this.mxpState.paragraph=!1,this.mxpState.lineType===lineType.Open&&this.ResetMXP(),L){case 2:this.mxpState.on=!1,this.mxpState.locked=!1,this.mxpState.lineType=lineType.Locked;break;case 3:this.ResetMXP();break;case 4:if(this.mxpState.lineType=lineType.TempSecure,U+1>=D){this._SplitBuffer+=X;break}var z=t.charAt(U+1);"<"!=z&&(this.mxpState.lineType=lineType.Open,this.mxpState.on=!1),this.mxpState.locked=!1;break;case 5:this.iMXPDefaultMode=lineType.Open,this.mxpState.locked=!0,this.mxpState.lineType=lineType.LockOpen;break;case 6:this.iMXPDefaultMode=lineType.Secure,this.mxpState.lineType=lineType.LockSecure,this.mxpState.locked=!0;break;case 7:this.iMXPDefaultMode=lineType.Locked,this.mxpState.lineType=lineType.LockLocked,this.mxpState.locked=!0;break;default:0>L||99<L?this.ResetMXP():(this.mxpState.lineType=L,this.mxpState.locked=!1,this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(L="",0<this.mxpLines[this.mxpState.lineType].element.length&&(L+="<"+this.mxpLines[this.mxpState.lineType].element+">"),0<this.mxpLines[this.mxpState.lineType].definition.length&&(L+=this.mxpLines[this.mxpState.lineType].definition),0<L.length&&(t=t.splice(U+1,L),D=t.length)));}this._SplitBuffer="",S=null,T=ParserState.None}else if("J"===X){if(this.ResetMXP(),0<S.length&&2==parseInt(S,10)){y=0,L=this.window.height;for(var q=0;q<L;q++)C.push("<br/>"),this.MXPCapture("\n");C.push("</div>"),this.AddLine(C.join(""),!1,!1),C=["<div class=\"line\">"],this.TextLength+=L,this.mxpState.noBreak=!1}this._SplitBuffer="",S=null,T=ParserState.None}else"m"===X?(C.push(this.EndDisplayBlock()),this.ProcessAnsiColorParams(S.split(";")),C.push(this.StartDisplayBlock()),this._SplitBuffer="",S=null,T=ParserState.None):(this._SplitBuffer+=X,S+=X);break;case ParserState.XTermTitle:7==I?(this._SplitBuffer="",this.emit("setTitle",m,null==h?0:h),m="",h=null,T=ParserState.None):";"===X&&null==h?(h=parseInt(m,10),isNaN(h)&&(h=0),m="",this._SplitBuffer+=X):"\x1B"===X?"\n"===this._SplitBuffer.charAt(this._SplitBuffer.length-1)&&(this._SplitBuffer=""):(this._SplitBuffer+=X,m+=X);break;case ParserState.Ansi:"["===X?(this._SplitBuffer+=X,S="",T=ParserState.AnsiParams):"]"===X?(this._SplitBuffer+=X,m="",T=ParserState.XTermTitle):("D"===X||"E"===X||"M"===X||"1"===X||"2"===X||"7"===X||"8"===X||">"===X||"="===X||"#"===X)&&(O&&(16>I?(C.push("&#x240",I.toString(16),";"),this.MXPCapture("&#x240"+I.toString(16)+";")):(C.push("&#x241B&#x24",I.toString(16),";"),this.MXPCapture("&#x241B&#x24"+I.toString(16)+";")),y+=2,this.TextLength+=2,this.mxpState.noBreak=!1),T=ParserState.None,this._SplitBuffer="");break;case ParserState.MXPTag:if("!--"===k)U--,E=ParserState.None,T=ParserState.MXPComment,P="<!--",k="",_=[];else if(k.endsWith("<!--"))U--,E=T,T=ParserState.MXPComment,P="<!--",k=k.substring(0,k.length-4),_=[];else if("\""===X)T=ParserState.MXPTagDblQuoted,_[_.length-1]+=X,this._SplitBuffer+=X;else if("'"===X)T=ParserState.MXPTagQuoted,_[_.length-1]+=X,this._SplitBuffer+=X;else if("&"===X)B="",E=T,T=ParserState.MXPEntity,this._SplitBuffer="";else if("\n"===X||"\x1B"===X)U--,T=ParserState.None,this._SplitBuffer="";else if(" "===X)T=ParserState.MXPTagArg,_.push(""),this._SplitBuffer+=X;else if(">"===X){if("HR"===k.toUpperCase()&&(this.mxpState.lineType===lineType.Secure||this.mxpState.lineType===lineType.LockSecure||this.mxpState.lineType===lineType.TempSecure))C.push(this.EndDisplayBlock()),0<y&&(y=0,C.push("<br></span>"),this.MXPCapture("\n"),this.AddLine(C.join(""),!1,!1)),C=[this.ParseMXPTag(k,[],a)],this.AddLine(C.join(""),!1,!1),this.TextLength++,C=["<span class=\"line\">",this.StartDisplayBlock()];else if("BR"===k.toUpperCase()&&(this.mxpState.lineType===lineType.Secure||this.mxpState.lineType===lineType.LockSecure||this.mxpState.lineType===lineType.TempSecure))y=0,C.push(this.EndDisplayBlock(),"<br></span>"),this.MXPCapture("\n"),this.AddLine(C.join(""),!1,!1),R=!1,C=["<span class=\"line\">",this.StartDisplayBlock()],this.TextLength++;else if("IMAGE"===k.toUpperCase()&&(this.mxpState.lineType===lineType.Secure||this.mxpState.lineType===lineType.LockSecure||this.mxpState.lineType===lineType.TempSecure))C.push(this.EndDisplayBlock()),k=this.ParseMXPTag(k,_,a),null!==k&&0<k.length&&(C.push(k),y+=k.length,this.TextLength+=k.length),C.push(this.StartDisplayBlock());else{if(k=this.ParseMXPTag(k,[],a),this.mxpState.expanded){null!==k&&(t=t.splice(U+1,k)),D=t.length,this.mxpState.expanded=!1,T=ParserState.None,k="";continue}"</a>"!=k&&(C.push(this.EndDisplayBlock()),C.push(this.StartDisplayBlock())),null!==k&&0<k.length&&(C.push(k),y+=k.length,this.TextLength+=k.length)}T=ParserState.None,this._SplitBuffer=""}else this._SplitBuffer+=X,k+=X;break;case ParserState.MXPTagQuoted:"'"===X?(T=ParserState.MXPTagArg,this._SplitBuffer+=X,_[_.length-1]+=X):(this._SplitBuffer+=X,_[_.length-1]+=X);break;case ParserState.MXPTagDblQuoted:"\""===X?(T=ParserState.MXPTagArg,this._SplitBuffer+=X,_[_.length-1]+=X):(this._SplitBuffer+=X,_[_.length-1]+=X);break;case ParserState.MXPTagArg:if("'"===X)T=ParserState.MXPTagQuoted,_[_.length-1]+=X,this._SplitBuffer+=X;else if("\""===X)T=ParserState.MXPTagDblQuoted,_[_.length-1]+=X,this._SplitBuffer+=X;else if("\n"===X||"\x1B"===X)U--,T=ParserState.None,this._SplitBuffer="";else if(" "===X)T=ParserState.MXPTagArg,_.push(""),this._SplitBuffer+=X;else if(">"===X){if("IMAGE"===k.toUpperCase()&&(this.mxpState.lineType===lineType.Secure||this.mxpState.lineType===lineType.LockSecure||this.mxpState.lineType===lineType.TempSecure))C.push(this.EndDisplayBlock()),k=this.ParseMXPTag(k,_,a),null!==k&&0<k.length&&(C.push(k),y+=k.length,this.TextLength+=k.length),C.push(this.StartDisplayBlock());else{if(C.push(this.EndDisplayBlock()),k=this.ParseMXPTag(k,_,a),this.mxpState.expanded){null!==k&&(t=t.splice(U+1,k)),D=t.length,this.mxpState.expanded=!1,T=ParserState.None;continue}C.push(this.StartDisplayBlock()),null!==k&&0<k.length&&(C.push(k),y+=k.length,this.TextLength+=k.length)}T=ParserState.None,this._SplitBuffer=""}else this._SplitBuffer+=X,_[_.length-1]+=X;break;case ParserState.MXPEntity:if("\n"===X||"\x1B"===X){if(U--,this.enableDebug&&this.emit("debug","MXP Entity: "+B),E==ParserState.MXPTag)k+="&"+B,T=E;else{if(B=this.GetEntity(B),this.mxpState.expanded){null!==k&&(t=t.splice(U+1,B)),D=t.length,this.mxpState.expanded=!1,T=ParserState.None;continue}C.push("&"),C.push(B),this.MXPCapture("&"+B),y++,this.TextLength++,this.mxpState.noBreak=!1,T=ParserState.None,this._SplitBuffer=""}}else if(";"===X){if(this.enableDebug&&this.emit("debug","MXP Entity: "+B),E!=ParserState.MXPTag){if(B=this.GetEntity(B),this.mxpState.expanded){t=t.splice(U+1,B),D=t.length,this.mxpState.expanded=!1,T=E;continue}C.push("&",B,";"),this.MXPCapture("&"),this.MXPCapture(B),this.MXPCapture(";"),y++,this.TextLength++,this.mxpState.noBreak=!1,this._SplitBuffer=""}else k+="&"+B+";";T=E}else this._SplitBuffer+=X,B+=X;break;case ParserState.MXPComment:P.endsWith("-->")?(this.enableDebug&&this.emit("debug","MXP Comment: "+P),U--,T=E,T===ParserState.None&&(this._SplitBuffer=""),P=""):"\n"===X||"\x1B"===X?(this.enableDebug&&this.emit("debug","MXP Comment: "+P),U--,T=E,P=""):P+=X;break;case ParserState.URL:if(U>H+2)C.pop(),C.pop(),y-=2,this.TextLength-=2,this.MXPDeCapture(2),U=H,T=ParserState.None;else if("/"!==X)U>H+1?(C.pop(),y--,this.TextLength--,this.MXPDeCapture(1),U=H,T=ParserState.None):(U=H,T=ParserState.None);else if(C.push(X),this.MXPCapture(X),y++,this.TextLength++,U==H+2){for(T=ParserState.URLFound,H=C.length-4,F=C.length-1;0<H&&library_1.CharAllowedInURL(C[H],!0);)H--;library_1.CharAllowedInURL(C[H],!0)||H++,w=[],0<H&&"("===C[H-1]&&w.push(")"),0<H&&"["===C[H-1]&&w.push("]")}break;case ParserState.URLFound:if(!library_1.CharAllowedInURL(X,!1))F!=C.length-1&&(P+=C.slice(H).join(""),this.enableDebug&&this.emit("debug","URL Found: "+P),this.enableLinks?(C.splice(H,0,"<a class=\"URLLink\" href=\"javascript:void(0);\" title=\""+P+"\" onclick=\""+this.linkFunction+"('"+P+"');return false;\">"),C.push("</a>")):(C.splice(H,0,"<span class=\"URLLink\" title=\""+P+"\">"),C.push("</span>"))),T=ParserState.None,U--;else{C.length-1;1<w.length&&w[w.length-1]==X?(w.pop(),C.push(X),this.MXPCapture(X),y++,this.TextLength++):0<w.length&&"("==X?(w.push(")"),C.push(X),this.MXPCapture(X),y++,this.TextLength++):0<w.length&&"["==X?(w.push("]"),C.push(X),this.MXPCapture(X),y++,this.TextLength++):1==w.length&&w[w.length-1]==X?(F!=C.length-1&&(P+=C.slice(H).join(""),this.enableDebug&&this.emit("debug","URL Found: "+P),this.enableLinks?(C.splice(H,0,"<a class=\"URLLink\" href=\"javascript:void(0);\" title=\""+P+"\" onclick=\""+this.linkFunction+"('"+P+"');return false;\">"),C.push("</a>")):(C.splice(H,0,"<span class=\"URLLink\" title=\""+P+"\">"),C.push("</span>"))),T=ParserState.None,U--):(C.push(X),this.MXPCapture(X),y++,this.TextLength++)}break;case ParserState.MSPSound:")"===X?(H=this.mxpState.lineType,this.mxpState.lineType=lineType.TempSecure,k=this.ParseMXPTag("SOUND",_,a),this.mxpState.lineType=H,T=ParserState.None,U+1<D&&"\n"===t.charAt(U+1)?(U++,R=!1,C=["<span class=\"line\">",this.StartDisplayBlock()],this.mxpState.noBreak=!1,y=0):U+2<D&&"\r"===t[U+1]&&"\n"==t[U+2]&&(U+=2,R=!1,C=["<span class=\"line\">",this.StartDisplayBlock()],this.mxpState.noBreak=!1,y=0)):" "===X?_.push(""):_[_.length-1]+=X;break;case ParserState.MSPMusic:")"===X?(H=this.mxpState.lineType,this.mxpState.lineType=lineType.TempSecure,k=this.ParseMXPTag("MUSIC",_,a),this.mxpState.lineType=H,T=ParserState.None,U+1<D&&"\n"===t.charAt(U+1)?(U++,R=!1,C=["<span class=\"line\">",this.StartDisplayBlock()],this.mxpState.noBreak=!1,y=0):U+2<D&&"\r"===t[U+1]&&"\n"==t[U+2]&&(U+=2,R=!1,C=["<span class=\"line\">",this.StartDisplayBlock()],this.mxpState.noBreak=!1,y=0)):" "===X?_.push(""):_[_.length-1]+=X;break;default:if(N&&7===I)v?(X="\u2022",C.push(X),this.MXPCapture(X),y++,this.TextLength++,this.mxpState.noBreak=!1):O&&(C.push("&#x2407;"),this.MXPCapture("&#x2407;"),y++,this.TextLength++,this.mxpState.noBreak=!1),this.emit("bell"),this.playBell();else if(N&&"\t"===X){var J=8-y%8;0<J&&(C.push(Array(J+1).join(" ")),this.MXPCapture(Array(J+1).join(" ")),y+=J,this.TextLength+=J,this.mxpState.noBreak=!1)}else if("\n"===X){if(this.mxpState.noBreak||this.mxpState.paragraph)continue;if(!this.mxpState.locked){if(this.mxpState.lineType!==lineType.Open&&this.emit("MXPTagEnd",this.mxpState.lineType,C.join("")),!this.mxpState.lineExpanded&&this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&(L="",0<this.mxpLines[this.mxpState.lineType].element.length&&(L+="</"+this.mxpLines[this.mxpState.lineType].element+">"),0<this.mxpLines[this.mxpState.lineType].closeDefinition.length&&(L+=this.mxpLines[this.mxpState.lineType].closeDefinition),0<L.length)){t=t.splice(U,L),D=t.length,U--,this.mxpState.lineExpanded=!0;continue}this.mxpState.lineExpanded=!1,this.mxpState.on=!1,this.mxpLines[this.mxpState.lineType]&&this.mxpLines[this.mxpState.lineType].enabled&&this.mxpLines[this.mxpState.lineType].gag&&(R=!0),this.mxpState.lineType=this.iMXPDefaultMode,2==this.mxpState.lineType||this.enableMXP||this.ResetMXP()}y=0,R||(C.push(this.EndDisplayBlock(),"<br></span>"),this.MXPCapture("\n")),this.AddLine(C.join(""),!1,R),R=!1,C=["<span class=\"line\">",this.StartDisplayBlock()],this.TextLength++,this.mxpState.noBreak=!1}else if(N&&"\r"===X){if(this.mxpState.noBreak||this.mxpState.paragraph)continue;this.mxpState.locked||(this.mxpState.on=!1,this.mxpState.lineType=lineType.Open);continue}else if(N&&"\x1B"===X)this._SplitBuffer+=X,T=ParserState.Ansi;else if(32>I||127===I){if(v)1===I?X="\u263A":2===I?X="\u263B":3===I?X="\u2665":4===I?X="\u2666":5===I?X="\u2663":6===I?X="\u2660":7===I?X="\u2022":8===I?X="\u25D8":9===I?X="\u25CB":10===I?X="\u25D9":11===I?X="\u2642":12===I?X="\u2640":13===I?X="\u266A":14===I?X="\u266B":15===I?X="\u263C":16===I?X="\u25BA":17===I?X="\u25C4":18===I?X="\u2195":19===I?X="\u203C":20===I?X="\xB6":21===I?X="\xA7":22===I?X="\u25AC":23===I?X="\u21A8":24===I?X="\u2191":25===I?X="\u2193":26===I?X="\u2192":27===I?X="\u2190":28===I?X="\u221F":29===I?X="\u2194":30===I?X="\u25B2":31===I?X="\u25BC":127===I&&(X="\u2302"),C.push(X),this.MXPCapture(X),y++,this.TextLength++,this.mxpState.noBreak=!1;else if(O)I=9215+I,C.push("&#",I.toString(),";"),this.MXPCapture("&#"),this.MXPCapture(I.toString()),this.MXPCapture(";"),y++,this.TextLength++,this.mxpState.noBreak=!1;else continue;}else if(" "===X||0<this._CurrentAttributes&&(this._CurrentAttributes&FontStyle.Hidden)===FontStyle.Hidden)C.push(" "),this.MXPCapture(" "),y++,this.TextLength++,this.mxpState.noBreak=!1;else if("<"===X)this.enableMXP&&this.mxpState.on?(k="",_=[],this._SplitBuffer+=X,T=ParserState.MXPTag):(C.push("&lt;"),this.MXPCapture("&lt;"),y++,this.TextLength++);else if(">"===X)C.push("&gt;"),this.MXPCapture("&gt;"),y++,this.TextLength++,this.mxpState.noBreak=!1;else if("&"===X)this.enableMXP&&this.mxpState.on?(B="",this._SplitBuffer+=X,E=T,T=ParserState.MXPEntity):(C.push("&amp;"),y++,this.TextLength++,this.mxpState.noBreak=!1);else if("\""===X)C.push("&quot;"),this.MXPCapture("&quot;"),y++,this.TextLength++,this.mxpState.noBreak=!1;else if("'"===X)C.push("&apos;"),this.MXPCapture("&apos;"),y++,this.TextLength++,this.mxpState.noBreak=!1;else if(":"==X){if(C.push(X),this.MXPCapture(X),y++,this.TextLength++,this.mxpState.noBreak=!1,G){P="";var Z,ee=!1;for(V=0;V<W;V++)if(!(0>U-this.protocols[V].length)){Z=!1;for(var te=this.protocols[V].length,ne=0;ne<te;ne++)if(t[U-(te-ne)]!==this.protocols[V][ne]){Z=!0;break}if(!Z&&(H=C.length,!(H>1+te&&1===C[H-(2+te)].length&&/\S/.test(C[H-(2+te)])&&"("!==C[H-(2+te)]&&"["!==C[H-(2+te)])&&(w=[],H=C.length-(1+te),F=C.length-1,0<H&&"("===C[H-1]&&w.push(")"),0<H&&"["===C[H-1]&&w.push("]"),T=ParserState.URLFound,ee=!0,ee)))break}ee||(T=ParserState.URL,H=U)}}else if("."!=X)Q&&0===y&&"!!MUSIC("==t.substring(U,U+8)?(_=[""],T=ParserState.MSPMusic,U+=7,this.mxpState.noBreak=!1):Q&&0===y&&"!!SOUND("==t.substring(U,U+8)?(_=[""],T=ParserState.MSPSound,U+=7,this.mxpState.noBreak=!1):(v&&127<I&&255>I&&(128===I?X="\xC7":129===I?X="\xFC":130===I?X="\xE9":131===I?X="\xE2":132===I?X="\xE4":133===I?X="\xE0":134===I?X="\xE5":135===I?X="\xE7":136===I?X="\xEA":137===I?X="\xEB":138===I?X="\xE8":139===I?X="\xEF":140===I?X="\xEE":141===I?X="\xEC":142===I?X="\xC4":143===I?X="\xC5":144===I?X="\xC9":145===I?X="\xE6":146===I?X="\xC6":147===I?X="\xF4":148===I?X="\xF6":149===I?X="\xF2":150===I?X="\xFB":151===I?X="\xF9":152===I?X="\xFF":153===I?X="\xD6":154===I?X="\xDC":155===I?X="\xA2":156===I?X="\xA3":157===I?X="\xA5":158===I?X="\u20A7":159===I?X="\u0192":160===I?X="\xE1":161===I?X="\xED":162===I?X="\xF3":163===I?X="\xFA":164===I?X="\xF1":165===I?X="\xD1":166===I?X="\xAA":167===I?X="\xBA":168===I?X="\xBF":169===I?X="\u2310":170===I?X="\xAC":171===I?X="\xBD":172===I?X="\xBC":173===I?X="\xA1":174===I?X="\xAB":175===I?X="\xBB":176===I?X="\u2591":177===I?X="\u2592":178===I?X="\u2593":179===I?X="\u2502":180===I?X="\u2524":181===I?X="\u2561":182===I?X="\u2562":183===I?X="\u2556":184===I?X="\u2555":185===I?X="\u2563":186===I?X="\u2551":187===I?X="\u2557":188===I?X="\u255D":189===I?X="\u255C":190===I?X="\u255B":191===I?X="\u2510":192===I?X="\u2514":193===I?X="\u2534":194===I?X="\u252C":195===I?X="\u251C":196===I?X="\u2500":197===I?X="\u253C":198===I?X="\u255E":199===I?X="\u255F":200===I?X="\u255A":201===I?X="\u2554":202===I?X="\u2569":203===I?X="\u2566":204===I?X="\u2560":205===I?X="\u2550":206===I?X="\u256C":207===I?X="\u2567":208===I?X="\u2568":209===I?X="\u2564":210===I?X="\u2565":211===I?X="\u2559":212===I?X="\u2558":213===I?X="\u2552":214===I?X="\u2553":215===I?X="\u256B":216===I?X="\u256A":217===I?X="\u2518":218===I?X="\u250C":219===I?X="\u2588":220===I?X="\u2584":221===I?X="\u258C":222===I?X="\u2590":223===I?X="\u2580":224===I?X="\u03B1":225===I?X="\u03B2":226===I?X="\u0393":227===I?X="\u03C0":228===I?X="\u03A3":229===I?X="\u03C3":230===I?X="\xB5":231===I?X="\u03C4":232===I?X="\u03A6":233===I?X="\u0398":234===I?X="\u03A9":235===I?X="\u03B4":236===I?X="\u221E":237===I?X="\u2205":238===I?X="\u2208":239===I?X="\u2229":240===I?X="\u2261":241===I?X="\xB1":242===I?X="\u2265":243===I?X="\u2264":244===I?X="\u2320":245===I?X="\u2321":246===I?X="\xF7":247===I?X="\u2248":248===I?X="\xB0":249===I?X="\u2219":250===I?X="\xB7":251===I?X="\u221A":252===I?X="\u207F":253===I?X="\xB2":254===I&&(X="\u25A0")),C.push(X),this.MXPCapture(X),y++,this.TextLength++,this.mxpState.noBreak=!1);else if(C.push(X),this.MXPCapture(X),y++,this.TextLength++,this.mxpState.noBreak=!1,G&&0<=U-3&&(P="http://",("w"===t[U-1]||"W"===U[H-1])&&("w"===t[U-2]||"W"===U[H-2])&&("w"===t[U-3]||"W"===U[H-3]))){if(H=C.length,4<H&&1===C[H-5].length&&/\S/.test(C[H-5])&&"("!==C[H-5]&&"["!==C[H-5])continue;w=[],H=C.length-4,F=C.length-1,0<H&&"("===C[H-1]&&w.push(")"),0<H&&"["===C[H-1]&&w.push("]"),T=ParserState.URLFound}}0<y&&(C.push(this.EndDisplayBlock()),C.push("</span>"),this.AddLine(C.join(""),!0,!1))}catch(le){this.enableDebug&&this.emit("debug",le)}this.emit("parseDone"),this.parsing.shift(),0<this.parsing.length&&setTimeout(this.parseNext(),0)}parseNext(){var t=this.parsing.shift(),a=this;return function(){a.parse(t[0],t[1],!0)}}updateWindow(t,a){this.window={width:t,height:a}}Clear(){this.ResetColors(),this.TextLength=0}ClearMXP(){this.mxpEntities={},this.ResetMXP(),this.mxpElements={},this.mxpState=new MXPState}ResetMXP(){this.mxpStyles=[],this.mxpStyles.push(new MXPStyle(FontStyle.None,"","",!1))}ResetMXPLine(){this.iMXPDefaultMode=lineType.Open,this.mxpState.lineType=lineType.Open}GetPublicEntity(t){return this.mxpEntities[t]&&this.mxpEntities[t].publish?this.mxpEntities[t].value:t}playBell(){if(this.enableBell){var t=new buzz.sound(this.bell);t.play()}}get linkFunction(){return this._linkFunction||"doLink"}set linkFunction(t){this._linkFunction=t}get mxpLinkFunction(){return this._mxpLinkFunction||"doMXPLink"}set mxpLinkFunction(t){this._mxpLinkFunction=t}get mxpSendFunction(){return this._mxpSendFunction||"doMXPSend"}set mxpSendFunction(t){this._mxpSendFunction=t}get mxpTooltipFunction(){return this._mxpTooltipFunction||"doMXPTooltip"}set mxpTooltipFunction(t){this._mxpTooltipFunction=t}}exports.Parser=Parser;
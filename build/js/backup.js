"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const EventEmitter=require("events"),library_1=require("./library"),fs=require("fs"),path=require("path"),sqlite3=require("sqlite3"),LZString=require("lz-string"),{ProfileCollection,Profile,Alias,Macro,Button,Trigger,MacroDisplay,MacroModifiers,ItemStyle}=require("./profile");class Backup extends EventEmitter{constructor(a){if(super(),this.client=null,this._url="http://shadowmud.com:",this._abort=!1,!a)throw"Invalid client!";this.client=a,this._url+=1035==this.client.port?"1132/client":"1130/client",this.client.telnet.GMCPSupports.push("Client 1"),this.client.on("connected",()=>{this.reset()}),this.client.on("closed",()=>{this.reset()}),this.client.on("receivedGMCP",(b,c)=>{if("client"==b.toLowerCase())switch(c.action){case"save":if(this._abort)return;this._user=c.user,this._action=c.action,this.emit("progress-start","Saving data"),this._abort=!1,this.save(2);break;case"load":this._abort=!1,this._user=c.user,this._action=c.action,this.emit("progress-start","Loading data"),this._save=[c.chunks,c.chunk,c.size,""],this.getChunk();break;case"error":this.emit("error",c.error),this.abort();}})}save(a){var b=new sqlite3.Database(path.join(library_1.parseTemplate("{data}"),"map.sqlite"));b.all("Select * FROM Rooms inner join exits on Exits.ID = Rooms.ID",(c,d)=>{var e={version:a,profiles:this.client.profiles.clone(2),settings:{mapEnabled:this.client.options.mapper.enabled,mapFollow:this.client.options.mapper.follow,legend:this.client.options.mapper.legend,MapperSplitArea:this.client.options.mapper.split,MapperFillWalls:this.client.options.mapper.fill,vscroll:this.client.options.mapper.vscroll,hscroll:this.client.options.mapper.hscroll,showScriptErrors:this.client.options.showScriptErrors,title:this.client.options.title,flashing:this.client.options.flashing,lagMeter:this.client.options.lagMeter,enablePing:this.client.options.enablePing,parseSingleQuotes:this.client.options.parseSingleQuotes,logEnabled:this.client.options.logEnabled,logOffline:this.client.options.logOffline,logPrepend:this.client.options.logPrepend,notifyMSPPlay:this.client.options.notifyMSPPlay,bufferSize:this.client.options.bufferSize,commandHistorySize:this.client.options.commandHistorySize,enableEcho:this.client.options.enableEcho,autoConnect:this.client.options.autoConnect,commandEcho:this.client.options.commandEcho,enableAliases:this.client.options.enableAliases,enableTriggers:this.client.options.enableTriggers,enableMacros:this.client.options.enableMacros,commandStacking:this.client.options.commandStacking,htmlLog:this.client.options.htmlLog,keepLastCommand:this.client.options.keepLastCommand,enableMXP:this.client.options.enableMXP,enableMSP:this.client.options.enableMSP,enableMCCP:this.client.options.enableMCCP,enableUTF8:this.client.options.enableUTF8,enableDebug:this.client.options.enableDebug,parseCommands:this.client.options.parseCommands,enableSpeedpaths:this.client.options.enableSpeedpaths,parseSpeedpaths:this.client.options.parseSpeedpaths,parseDoubleQuotes:this.client.options.parseDoubleQuotes,logUniqueOnConnect:this.client.options.logUniqueOnConnect,enableURLDetection:this.client.options.enableURLDetection,CommandonClick:this.client.options.CommandonClick,cmdfontSize:this.client.options.cmdfontSize,fontSize:this.client.options.fontSize,cmdfont:this.client.options.cmdfont,font:this.client.options.font,commandStackingChar:this.client.options.commandStackingChar,speedpathsChar:this.client.options.speedpathsChar,commandDelay:this.client.options.commandDelay,commandDelayCount:this.client.options.commandDelayCount,soundPath:this.client.options.soundPath,logPath:this.client.options.logPath,scrollLocked:this.client.options.scrollLocked,showStatus:this.client.options.showStatus,MapperOpen:this.client.options.showMapper},map:{}},f={};if(d)for(var g=d.length,h=0;h<g;h++)if(f[d[h].ID])f[d[h].ID].exits[d[h].Exit]={num:d[h].DestID,isdoor:d[h].IsDoor,isclosed:d[h].IsClosed};else{for(var i in f[d[h].ID]={num:d[h].ID},d[h])if("ID"!=i){if(!d[h].hasOwnProperty(i))continue;f[d[h].ID][i.toLowerCase()]=d[h][i]}f[d[h].ID].exits={},f[d[h].ID].exits[d[h].Exit]={num:d[h].DestID,isdoor:d[h].IsDoor,isclosed:d[h].IsClosed}}e.map=f;var j=JSON.stringify(e);j=LZString.compressToEncodedURIComponent(j),this._save=[j.match(/((\S|\s|.){1,20000})/g),0,0],this._save[3]=this._save[0].length,this.saveChunk()})}abort(a){this.emit("abort",a),this._save=0,this._abort=!0,$.ajax({type:"POST",url:this._url,data:{user:this._user,a:"abort"}})}close(){this.emit("close"),this._save=0,this._abort=!1,$.ajax({type:"POST",url:this._url,data:{user:this._user,a:"done"}})}getChunk(){$.ajax({type:"POST",url:this._url,data:{user:this._user,a:"get",c:++this._save[1]},dataType:"json",success:(a)=>{this._abort||(a?a.error?this.abort(a.error):(this._save[1]=a.chunk,this._save[3]+=a.data,this.emit("progress",100*((this._save[1]+1)/this._save[0])),this._save[1]>=this._save[0]-1?this.finishLoad():this.getChunk()):this.abort(a.error))},error:function(a,b){this.abort(b)}})}saveChunk(){$.ajax({type:"POST",url:this._url,data:{user:this._user,a:"save",data:this._save[0].shift(),append:0<this._save[1]?1:0},dataType:"json",success:(a)=>{a?"Successfully saved"===a.msg?0<this._save[0].length?(this.emit("progress",100*(this._save[1]/this._save[3])),this._save[1]++,this.saveChunk()):("function"==typeof this._save[2]&&this._save[2](),this.close()):this.abort(a.msg||"Error"):this.abort()},error:function(a,b){this.abort(b)}})}reset(){}finishLoad(){var a=LZString.decompressFromEncodedURIComponent(this._save[3]);if(a=JSON.parse(a),2==a.version){if(this.emit("import-map",a.map),a.profiles){for(var d,b=new ProfileCollection,c=Object.keys(a.profiles),e=0,f=c.length;e<f;e++){d=c[e];var g=new Profile(d);g.priority=a.profiles[c[e]].priority,g.enabled=a.profiles[c[e]].enabled,g.enableMacros=a.profiles[c[e]].enableMacros,g.enableTriggers=a.profiles[c[e]].enableTriggers,g.enableAliases=a.profiles[c[e]].enableAliases,g.macros=[];var h=a.profiles[c[e]].macros.length;if(0<h)for(var j,i=0;i<h;i++)j=new Macro,j.key=a.profiles[c[e]].macros[i].key,j.value=a.profiles[c[e]].macros[i].value,j.style=a.profiles[c[e]].macros[i].style,j.append=a.profiles[c[e]].macros[i].append,j.send=a.profiles[c[e]].macros[i].send,j.name=a.profiles[c[e]].macros[i].name,j.group=a.profiles[c[e]].macros[i].group,j.enabled=a.profiles[c[e]].macros[i].enabled,j.modifiers=a.profiles[c[e]].macros[i].modifiers,j.chain=a.profiles[c[e]].macros[i].chain,j.notes=a.profiles[c[e]].macros[i].notes||"",g.macros.push(j);if(h=a.profiles[c[e]].aliases.length,0<h)for(var j,i=0;i<h;i++)j=new Alias,j.pattern=a.profiles[c[e]].aliases[i].pattern,j.value=a.profiles[c[e]].aliases[i].value,j.style=a.profiles[c[e]].aliases[i].style,j.multi=a.profiles[c[e]].aliases[i].multi,j.append=a.profiles[c[e]].aliases[i].append,j.name=a.profiles[c[e]].aliases[i].name,j.group=a.profiles[c[e]].aliases[i].group,j.enabled=a.profiles[c[e]].aliases[i].enabled,j.params=a.profiles[c[e]].aliases[i].params,j.regexp=a.profiles[c[e]].aliases[i].regexp,j.priority=a.profiles[c[e]].aliases[i].priority,j.notes=a.profiles[c[e]].aliases[i].notes||"",g.aliases.push(j);if(h=a.profiles[c[e]].triggers.length,0<h)for(var j,i=0;i<h;i++)j=new Trigger,j.pattern=a.profiles[c[e]].triggers[i].pattern,j.value=a.profiles[c[e]].triggers[i].value,j.style=a.profiles[c[e]].triggers[i].style,j.verbatim=a.profiles[c[e]].triggers[i].verbatim,j.name=a.profiles[c[e]].triggers[i].name,j.group=a.profiles[c[e]].triggers[i].group,j.enabled=a.profiles[c[e]].triggers[i].enabled,j.priority=a.profiles[c[e]].triggers[i].priority,j.triggerNewline=a.profiles[c[e]].triggers[i].triggernewline,j.triggerPrompt=a.profiles[c[e]].triggers[i].triggerprompt,j.type=a.profiles[c[e]].triggers[i].type,j.notes=a.profiles[c[e]].triggers[i].notes||"",g.triggers.push(j);if(a.profiles[c[e]].buttons&&(h=a.profiles[c[e]].buttons.length,0<h))for(var j,i=0;i<h;i++)j=new Button(a.profiles[c[e]].buttons[i]),g.triggers.push(j);b.add(g)}var g=path.join(library_1.parseTemplate("{data}"),"profiles");fs.existsSync(g)||fs.mkdirSync(g),b.save(g),this.emit("imported-profiles")}this.client.options.mapper.enabled=a.settings.mapEnabled,this.client.options.mapper.follow=a.settings.mapFollow,this.client.options.mapper.legend=a.settings.legend,this.client.options.mapper.split=a.settings.MapperSplitArea,this.client.options.mapper.fill=a.settings.MapperFillWalls,this.client.options.mapper.vscroll=a.settings.vscroll,this.client.options.mapper.hscroll=a.settings.hscroll,this.client.options.showScriptErrors=a.settings.showScriptErrors,a.settings.title&&(this.client.options.title=a.settings.title),this.client.options.flashing=a.settings.flashing,this.client.options.lagMeter=a.settings.lagMeter,this.client.options.enablePing=a.settings.enablePing,this.client.options.parseSingleQuotes=a.settings.parseSingleQuotes,this.client.options.logEnabled=a.settings.logEnabled,this.client.options.logOffline=a.settings.logOffline,this.client.options.logPrepend=a.settings.logPrepend,this.client.options.notifyMSPPlay=a.settings.notifyMSPPlay,this.client.options.bufferSize=a.settings.bufferSize,this.client.options.commandHistorySize=a.settings.commandHistorySize,this.client.options.enableEcho=a.settings.enableEcho,this.client.options.autoConnect=a.settings.autoConnect,this.client.options.commandEcho=a.settings.commandEcho,this.client.options.enableAliases=a.settings.enableAliases,this.client.options.enableTriggers=a.settings.enableTriggers,this.client.options.enableMacros=a.settings.enableMacros,this.client.options.commandStacking=a.settings.commandStacking,this.client.options.htmlLog=a.settings.htmlLog,this.client.options.keepLastCommand=a.settings.keepLastCommand,this.client.options.enableMXP=a.settings.enableMXP,this.client.options.enableMSP=a.settings.enableMSP,this.client.options.enableMCCP=a.settings.enableMCCP,this.client.options.enableUTF8=a.settings.enableUTF8,this.client.options.enableDebug=a.settings.enableDebug,this.client.options.parseCommands=a.settings.parseCommands,this.client.options.enableSpeedpaths=a.settings.enableSpeedpaths,this.client.options.parseSpeedpaths=a.settings.parseSpeedpaths,this.client.options.parseDoubleQuotes=a.settings.parseDoubleQuotes,this.client.options.logUniqueOnConnect=a.settings.logUniqueOnConnect,this.client.options.enableURLDetection=a.settings.enableURLDetection,this.client.options.CommandonClick=a.settings.CommandonClick,this.client.options.cmdfontSize=a.settings.cmdfontSize,this.client.options.fontSize=a.settings.fontSize,this.client.options.cmdfont=a.settings.cmdfont,this.client.options.font=a.settings.font,this.client.options.commandStackingChar=a.settings.commandStackingChar,this.client.options.speedpathsChar=a.settings.speedpathsChar,this.client.options.commandDelay=a.settings.commandDelay,this.client.options.commandDelayCount=a.settings.commandDelayCount,a.settings.soundPath&&(this.client.options.soundPath=a.settings.soundPath),a.settings.logPath&&(this.client.options.logPath=a.settings.logPath),this.client.options.scrollLocked=a.settings.scrollLocked,this.client.options.showStatus=a.settings.showStatus,this.client.options.showMapper=a.settings.MapperOpen,this.client.clearTriggerCache(),this.client.saveOptions(),this.client.loadOptions(),this.emit("imported-settings")}this.emit("finish-load"),this.close()}}exports.Backup=Backup;
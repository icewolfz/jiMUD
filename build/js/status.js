"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const EventEmitter=require("events");class Status extends EventEmitter{constructor(c){super(),this.info=[],this.infoAC=[],this.infoLimb=[],this._ac=!1,this.client=c,this.lagMeter=$("#lagMeter"),this.client.telnet.on("latency-changed",(d)=>{this.updateLagMeter(d)}),this.client.on("closed",()=>{this.updateLagMeter(0,!0)}),this.client.telnet.GMCPSupports.push("oMUD 1"),this.client.telnet.GMCPSupports.push("Char.Skills 1"),this.client.on("addLine",(d)=>{"Connected..."==d.raw&&this.init()}),this.client.on("receivedGMCP",(d,e)=>{switch(d.toLowerCase()){case"char.base":this.init(),this.info.name=e.name,this.setTitle(e.name);break;case"char.vitals":this.updateBar("#hpbar",e.hp,e.hpmax),this.updateBar("#spbar",e.sp,e.spmax),this.updateBar("#mpbar",e.mp,e.mpmax),this.info.hp=e.hp,this.info.hpmax=e.hpmax,this.info.sp=e.sp,this.info.spmax=e.spmax,this.info.mp=e.mp,this.info.mpmax=e.mpmax,this.updateOverall();break;case"char.experience":this.info.EXPERIENCE=e.current,this.info.EXPERIENCE_NEED=e.need-e.current,this.info.EXPERIENCE_EARNED=e.earned,this.info.EXPERIENCE_BANKED=e.banked,this.updateXP();break;case"omud.ac":for(var f in e)e.hasOwnProperty(f)&&(this.setLimbAC(f,e[f]),this.updateLimb(f));break;case"omud.limb":for(var f in e)e.hasOwnProperty(f)&&(this.setLimbHealth(f,e[f]),this.updateLimb(f));break;case"omud.weapons":for(var f in e)e.hasOwnProperty(f)&&this.setWeapon(f,e[f]);break;case"omud.environment":e.weather&&(this.info.WEATHER=e.weather,this.info.WEATHER_INTENSITY=e.weather_intensity,$("#environment").removeClass(function(g,h){return(h.match(/(^|\s)(weather-|intensity-)\S+/g)||[]).join(" ")}),"0"!=e.weather&&"none"!=e.weather&&$("#environment").addClass("weather-"+e.weather),6<e.weather_intensity&&$("#environment").addClass("intensity-hard")),e.tod&&($("#environment").removeClass("day night twilight dawn").addClass(e.tod),$("#environment").removeClass(function(g,h){return(h.match(/(^|\s)moon\d-\S+/g)||[]).join(" ")}),e.moons&&($("#environment").addClass("moon1-"+e.moons[0]),$("#environment").addClass("moon2-"+e.moons[1]),$("#environment").addClass("moon3-"+e.moons[2])));break;case"omud.combat":"leave"==e.action?$("#combat").empty():"add"==e.action?this.createBar("#combat",this.sanatizeID(e.name),e.name,e.hp,100,this.livingClass(e,"monster-"),e.order):"update"==e.action?0==e.hp?this.removeBar("#"+this.sanatizeID(e.name)):this.createBar("#combat",this.sanatizeID(e.name),e.name,e.hp,100,this.livingClass(e,"monster-"),e.order):"remove"==e.action&&this.removeBar("#"+this.sanatizeID(e.name));break;case"omud.party":"leave"==e.action?$("#party").empty():"add"==e.action?this.createBar("#party",this.sanatizeID(e.name),e.name,e.hp,100,this.livingClass(e,"party-"),e.name.replace("\"","")):"update"==e.action?0==e.hp?this.removeBar("#"+this.sanatizeID(e.name)):this.createBar("#party",this.sanatizeID(e.name),e.name,e.hp,100,this.livingClass(e,"party-"),e.name.replace("\"","")):"remove"==e.action&&this.removeBar("#"+this.sanatizeID(e.name)),0<$("#party").children().length?$("#party").addClass("hasmembers"):$("#party").removeClass("hasmembers");}}),this.updateInterface(),this.init()}get ac(){return this._ac}set ac(c){this._ac!=c&&(this._ac=c,this.updateStatus(),this.emit("display-changed"))}sanatizeID(c){return c.replace(/[^a-zA-Z0-9_-]/gi,"")}livingClass(c,d){var e=[];return d||(d=""),c.class&&0<c.class.length&&e.push(d+this.sanatizeID(c.class)),c.gender&&0<c.gender.length&&e.push(d+this.sanatizeID(c.gender)),c.race&&0<c.race.length&&e.push(d+this.sanatizeID(c.race)),c.guild&&0<c.guild.length&&e.push(d+this.sanatizeID(c.guild)),c.name&&0<c.name.length&&e.push(d+this.sanatizeID(c.name)),e.join(" ")}setWeapon(c,d){c=c.replace(/\s/g,""),c=c.toLowerCase();var e=$(document.getElementById(c+"weapon"));e&&0!=e.length&&(e.removeClass(function(f,g){return(g.match(/(^|\s)weapon-\S+/g)||[]).join(" ")}),d&&(d.quality&&0<d.quality.length&&e.addClass("weapon-"+this.sanatizeID(d.quality)),d.material&&0<d.material.length&&e.addClass("weapon-"+this.sanatizeID(d.material)),d.type&&0<d.type.length&&e.addClass("weapon-"+this.sanatizeID(d.type)),d.subtype&&0<d.subtype.length&&e.addClass("weapon-"+this.sanatizeID(d.subtype)),d.name&&0<d.name.length&&e.addClass("weapon-"+this.sanatizeID(d.name))))}setLimbAC(c,d){c=c.replace(/\s/g,""),c=c.toLowerCase(),"righthoof"==c?c="rightfoot":"lefthoof"==c&&(c="leftfoot"),this.infoAC[c]=d}setLimbHealth(c,d){c=c.replace(/\s/g,""),c=c.toLowerCase(),"righthoof"==c?c="rightfoot":"lefthoof"==c&&(c="leftfoot"),this.infoLimb[c]=d}setTitle(c){c&&0!=c.length?(window.document.title="jiMUD - "+c,$("#charactername").text(c)):(window.document.title="jiMUD",$("#charactername").html("&nbsp;")),this.emit("set-title",c||"")}updateOverall(){if($("#overall").removeClass(function(d,e){return(e.match(/(^|\s)(health-|armor-)\S+/g)||[]).join(" ")}),this._ac)6.5==this.infoAC.overall?($("#overall").html("Extensively"),$("#overall").addClass("armor-extensively")):6==this.infoAC.overall?($("#overall").html("Completely"),$("#overall").addClass("armor-completely")):5.5==this.infoAC.overall?($("#overall").html("Significantly"),$("#overall").addClass("armor-significantly")):5==this.infoAC.overall?($("#overall").html("Considerably"),$("#overall").addClass("armor-considerably")):4.5==this.infoAC.overall?($("#overall").html("Well"),$("#overall").addClass("armor-well")):4==this.infoAC.overall?($("#overall").html("Adequately"),$("#overall").addClass("armor-adequately")):3.5==this.infoAC.overall?($("#overall").html("Fairly"),$("#overall").addClass("armor-fairly")):3==this.infoAC.overall?($("#overall").html("Moderately"),$("#overall").addClass("armor-moderately")):2.5==this.infoAC.overall?($("#overall").html("Somewhat"),$("#overall").addClass("armor-somewhat")):2==this.infoAC.overall?($("#overall").html("Slightly"),$("#overall").addClass("armor-slightly")):1==this.infoAC.overall?($("#overall").html("Barely"),$("#overall").addClass("armor-barely")):($("#overall").html("UNARMORED"),$("#overall").addClass("armor-unarmored"));else{var c=100;0===this.info.hpmax||isNaN(this.info.hpmax)||(c*=this.info.hp/this.info.hpmax),90<c?($("#overall").html("Top shape"),$("#overall").addClass("health-full")):75<c?($("#overall").html("Decent shape"),$("#overall").addClass("health-1-19")):60<c?($("#overall").html("Slightly injured"),$("#overall").addClass("health-20-39")):45<c?($("#overall").html("Hurting"),$("#overall").addClass("health-40-59")):30<c?($("#overall").html("Badly injured"),$("#overall").addClass("health-60-79")):15<c?($("#overall").html("Terribly injured"),$("#overall").addClass("health-80-99")):($("#overall").html("Near death"),$("#overall").addClass("health-100"))}}updateXP(){$("#xpvalue").text(this.info.EXPERIENCE),$("#xpbanked").text(this.info.EXPERIENCE_BANKED),$("#needvalue").text(this.info.EXPERIENCE_NEED),$("#earnvalue").text(this.info.EXPERIENCE_EARNED)}updateLimb(c){if(c=c.replace(/\s/g,""),c=c.toLowerCase(),"overall"==c)return void this.updateOverall();"righthoof"==c?c="rightfoot":"lefthoof"==c&&(c="leftfoot");var d=$(document.getElementById(c));d&&0!=d.length&&(d.removeClass(function(e,f){return(f.match(/(^|\s)(health-|armor-)\S+/g)||[]).join(" ")}),d.css("display","block"),d.css("visibility","visible"),this._ac?6.5==this.infoAC[c]?d.addClass("armor-extensively"):6==this.infoAC[c]?d.addClass("armor-completely"):5.5==this.infoAC[c]?d.addClass("armor-significantly"):5==this.infoAC[c]?d.addClass("armor-considerably"):4.5==this.infoAC[c]?d.addClass("armor-well"):4==this.infoAC[c]?d.addClass("armor-adequately"):3.5==this.infoAC[c]?d.addClass("armor-fairly"):3==this.infoAC[c]?d.addClass("armor-moderately"):2.5==this.infoAC[c]?d.addClass("armor-somewhat"):2==this.infoAC[c]?d.addClass("armor-slightly"):1==this.infoAC[c]?d.addClass("armor-barely"):d.addClass("armor-unarmored"):100==this.infoLimb[c]?d.addClass("health-100"):80<=this.infoLimb[c]?d.addClass("health-80-99"):60<=this.infoLimb[c]?d.addClass("health-60-79"):40<=this.infoLimb[c]?d.addClass("health-40-59"):20<=this.infoLimb[c]?d.addClass("health-20-39"):1<=this.infoLimb[c]?d.addClass("health-1-19"):d.addClass("health-full"))}updateStatus(){if(this._ac)for(var c in this.infoAC)this.updateLimb(c);else for(c in this.infoLimb)this.updateLimb(c);this.updateOverall(),this.updateXP()}init(){this.setTitle(""),this.info=[],this.info.WEATHER="none",this.info.WEATHER_INTENSITY=0,this.info.EXPERIENCE=0,this.info.EXPERIENCE_NEED=0,this.info.EXPERIENCE_EARNED=0,this.info.EXPERIENCE_BANKED=0,this.infoAC=[],this.infoAC.head=0,this.infoAC.leftarm=0,this.infoAC.leftfoot=0,this.infoAC.lefthand=0,this.infoAC.leftleg=0,this.infoAC.rightarm=0,this.infoAC.rightfoot=0,this.infoAC.righthand=0,this.infoAC.rightleg=0,this.infoAC.torso=0,this.infoAC.overall=0,this.infoLimb=[],this.infoLimb.head=0,this.infoLimb.leftarm=0,this.infoLimb.leftfoot=0,this.infoLimb.lefthand=0,this.infoLimb.leftleg=0,this.infoLimb.rightarm=0,this.infoLimb.rightfoot=0,this.infoLimb.righthand=0,this.infoLimb.rightleg=0,this.infoLimb.torso=0,$("#leftwing").css("display","none"),$("#rightwing").css("display","none"),$("#tail").css("display","none"),this.updateBar("#hpbar",0,0),this.updateBar("#spbar",0,0),this.updateBar("#mpbar",0,0),$("#xpvalue").text("0"),$("#xpbanked").text("0"),$("#needvalue").text("0"),$("#earnvalue").text("0"),$("#combat").empty(),$("#party").empty(),$("#party").removeClass("hasmembers"),this.updateOverall(),this.updateStatus()}updateBar(c,d,e){var f=$(c);if(0!=f.length){var g=100;0!==e&&(g=100*(d/e)),$(c+" .progressbar-value").css("width",100-g),$(c+" .progressbar-text").text(d+"/"+e)}}createBar(c,d,e,f,g,h,i){var j=100;0!==g&&(j=100*(f/g)),j=Math.floor(j),d=d.replace(" ","");var k=$("#"+d);0==k.length?(!h&&(h=e.replace(/\d+$/,"").trim().replace(" ","-")),k="<div class=\"combatbar\" id=\""+d+"\" data-value=\""+20*((100-j)/20)+"\" data-order=\""+i+"\">",k+="<div class=\"combaticon "+h+"\"></div>",k+="<div class=\"combatname\"> "+e+"</div>",k+="<div class=\"progressbar\"><div class=\"progressbar-text\">"+j+"%</div>",k+="<div class=\"progressbar-value\" style=\"width: "+(100-j)+"%\"></div>",k+="</div></div>",$(c).append(k),this.sortBars($(c))):(i!=k.data("order")&&(k.data("order",i),this.sortBars($(c))),k.data("value",20*((100-j)/20)),k.find(".combatname").text(e),k.find(".progressbar-text").text(j+"%"),k.find(".progressbar-value").css("width",100-j))}removeBar(c){var d=$(c).parent();$(c).remove(),this.sortBars(d)}sortBars(c){var d=c.children("div").get();d.sort(function(e,f){var g=$(e).data("order"),h=$(f).data("order");return g<h?-1:g>h?1:0}),$.each(d,function(e,f){c.append(f)})}updateLagMeter(c,d){if(this.lagMeter&&0!=this.lagMeter.length&&(this.client.options.lagMeter||d)){var e=100;e=100*(c/200),100<e&&(e=100),this.lagMeter.find(".progressbar-value").css("width",100-e+"%"),this.lagMeter.find(".progressbar-text").text(c/1e3+"s")}}updateInterface(){this.client.options.showStatus?($("#status").css("visibility",""),$("#status").css("display",""),$("#statusborder").css("visibility",""),$("#statusborder").css("display",""),$("#displaycontainer").css("right",""),$("#displayborder").css("right",""),$("#command").css("right","")):($("#status").css("visibility","hidden"),$("#status").css("display","none"),$("#statusborder").css("visibility","hidden"),$("#statusborder").css("display","none"),$("#displaycontainer").css("right","7px"),$("#displayborder").css("right","0px"),$("#command").css("right","0px")),this.lagMeter&&0<this.lagMeter.length?this.client.options.lagMeter?(this.lagMeter.css("visibility",""),this.lagMeter.css("display",""),$("#bars").css("bottom","22px"),this.updateLagMeter(0,!0)):(this.lagMeter.css("visibility","hidden"),this.lagMeter.css("display","none"),$("#bars").css("bottom","5px")):$("#bars").css("bottom","5px")}}exports.Status=Status;
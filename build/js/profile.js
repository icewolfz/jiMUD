"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const library_1=require("./library"),path=require("path"),fs=require("fs");var MacroModifiers;(function(f){f[f.None=0]="None",f[f.Alt=2]="Alt",f[f.Ctrl=4]="Ctrl",f[f.Shift=8]="Shift",f[f.Meta=16]="Meta",f[f.All=30]="All"})(MacroModifiers=exports.MacroModifiers||(exports.MacroModifiers={}));var ItemDisplayType;(function(f){f[f.Text=0]="Text",f[f.Function=1]="Function"})(ItemDisplayType=exports.ItemDisplayType||(exports.ItemDisplayType={}));var ItemStyle;(function(f){f[f.Text=0]="Text",f[f.Parse=1]="Parse",f[f.Script=2]="Script"})(ItemStyle=exports.ItemStyle||(exports.ItemStyle={}));var TriggerType;(function(f){f[f.Regular=0]="Regular",f[f.CommandInputRegular=1]="CommandInputRegular"})(TriggerType=exports.TriggerType||(exports.TriggerType={}));function MacroDisplay(f){if(0===f.key)return f.name&&0<f.name.length?"None - "+f.name:"None";var g=[];if((f.modifiers&MacroModifiers.Ctrl)==MacroModifiers.Ctrl&&g.push("Ctrl"),(f.modifiers&MacroModifiers.Alt)==MacroModifiers.Alt&&g.push("Alt"),(f.modifiers&MacroModifiers.Shift)==MacroModifiers.Shift&&g.push("Shift"),(f.modifiers&MacroModifiers.Meta)==MacroModifiers.Meta&&("darwin"==process.platform?g.push("Cmd"):g.push("Win")),library_1.keyCodeToChar[f.key])g.push(library_1.keyCodeToChar[f.key]);else return f.name&&0<f.name.length?"None - "+f.name:"None";return f.name&&0<f.name.length?g.join("+")+" - "+f.name:g.join("+")}exports.MacroDisplay=MacroDisplay;class Item{constructor(f){if(this.name="",this.priority=0,this.display="name",this.displaytype=ItemDisplayType.Text,this.value="",this.style=ItemStyle.Parse,this.group="",this.enabled=!0,this.notes="","object"==typeof f)for(var g in f)f.hasOwnProperty(g)&&(this[g]=f[g])}clone(){return new Item(this)}}exports.Item=Item;class Button extends Item{constructor(f){if(super(f),this.caption="",this.icon="",this.append=!1,this.send=!0,this.chain=!1,this.stretch=!1,this.caption="NewButton",this.display="caption","object"==typeof f)for(var g in f)f.hasOwnProperty(g)&&(this[g]=f[g])}clone(){return new Button(this)}}exports.Button=Button;class Macro extends Item{constructor(f){if(super(),this.key=0,this.append=!1,this.send=!0,this.modifiers=MacroModifiers.None,this.chain=!1,this.display="return MacroDisplay(item)",this.displaytype=ItemDisplayType.Function,"object"==typeof f)for(var g in f)f.hasOwnProperty(g)&&(this[g]=f[g])}clone(){return new Macro(this)}}exports.Macro=Macro;class Alias extends Item{constructor(f,g){if(super(),this.pattern="NewAlias",this.regexp=!1,this.multi=!1,this.append=!0,this.params="","string"==typeof f&&(this.pattern=f),null!=g&&(this.value=g),this.display="pattern","object"==typeof f)for(var h in f)f.hasOwnProperty(h)&&(this[h]=f[h])}clone(){return new Alias(this)}}exports.Alias=Alias;class Trigger extends Item{constructor(f){if(super(f),this.pattern="NewTrigger",this.verbatim=!1,this.triggerNewline=!0,this.triggerPrompt=!1,this.type=TriggerType.Regular,this.display="pattern","object"==typeof f)for(var g in f)f.hasOwnProperty(g)&&(this[g]=f[g])}clone(){return new Trigger(this)}}exports.Trigger=Trigger;class Context extends Item{constructor(f){if(super(f),this.caption="",this.icon="",this.append=!1,this.send=!0,this.chain=!1,this.submenu="",this.caption="NewContext",this.display="caption","object"==typeof f)for(var g in f)f.hasOwnProperty(g)&&(this[g]=f[g])}clone(){return new Button(this)}}exports.Context=Context;class Profile{constructor(f,g){this.name="",this.file="",this.priority=0,this.enabled=!0,this.aliases=[],this.triggers=[],this.macros=[],this.buttons=[],this.contexts=[],this.enableMacros=!0,this.enableTriggers=!0,this.enableAliases=!0,this.enableButtons=!0,this.enableContext=!0,this.enableDefaultContext=!0,"string"==typeof f?(this.name=f,this.file=f.toLowerCase(),(null==g||g)&&(this.macros=Profile.DefaultMacros)):"boolean"==typeof f?f&&(this.macros=Profile.DefaultMacros):(null==g||g)&&(this.macros=Profile.DefaultMacros)}static get Default(){return new Profile("Default")}static get DefaultMacros(){for(var f=[{key:97,display:"return MacroDisplay(item)",displaytype:ItemDisplayType.Function,value:"sw",style:ItemStyle.Parse,append:!1,send:!0,name:"SouthWest",group:"",enabled:!0,modifiers:MacroModifiers.None,chain:!0,priority:0,notes:""},{key:98,display:"return MacroDisplay(item)",displaytype:ItemDisplayType.Function,value:"s",style:ItemStyle.Parse,append:!1,send:!0,name:"South",group:"",enabled:!0,modifiers:MacroModifiers.None,chain:!0,priority:0,notes:""},{key:99,display:"return MacroDisplay(item)",displaytype:ItemDisplayType.Function,value:"se",style:ItemStyle.Parse,append:!1,send:!0,name:"SouthEast",group:"",enabled:!0,modifiers:MacroModifiers.None,chain:!0,priority:0,notes:""},{key:100,display:"return MacroDisplay(item)",displaytype:ItemDisplayType.Function,value:"w",style:ItemStyle.Parse,append:!1,send:!0,name:"West",group:"",enabled:!0,modifiers:MacroModifiers.None,chain:!0,priority:0,notes:""},{key:101,display:"return MacroDisplay(item)",displaytype:ItemDisplayType.Function,value:"l",style:ItemStyle.Parse,append:!1,send:!0,name:"Look",group:"",enabled:!0,modifiers:MacroModifiers.None,chain:!0,priority:0,notes:""},{key:102,display:"return MacroDisplay(item)",displaytype:ItemDisplayType.Function,value:"e",style:ItemStyle.Parse,append:!1,send:!0,name:"East",group:"",enabled:!0,modifiers:MacroModifiers.None,chain:!0,priority:0,notes:""},{key:103,display:"return MacroDisplay(item)",displaytype:ItemDisplayType.Function,value:"nw",style:ItemStyle.Parse,append:!1,send:!0,name:"NorthWest",group:"",enabled:!0,modifiers:MacroModifiers.None,chain:!0,priority:0,notes:""},{key:104,display:"return MacroDisplay(item)",displaytype:ItemDisplayType.Function,value:"n",style:ItemStyle.Parse,append:!1,send:!0,name:"North",group:"",enabled:!0,modifiers:MacroModifiers.None,chain:!0,priority:0,notes:""},{key:105,display:"return MacroDisplay(item)",displaytype:ItemDisplayType.Function,value:"ne",style:ItemStyle.Parse,append:!1,send:!0,name:"NorthEast",group:"",enabled:!0,modifiers:MacroModifiers.None,chain:!0,priority:0,notes:""}],g=[],h=0,j=f.length;h<j;h++)g.push(new Macro(f[h]));return g}static load(f){if(!fs.existsSync(f))return null;var g,h=fs.readFileSync(f,"utf-8");if(0==h.length)return new Profile(path.basename(f,".json"));try{h=JSON.parse(h)}catch(o){return new Profile(path.basename(f,".json"))}g=new Profile;for(var j in h)h.hasOwnProperty(j)&&("aliases"==j||"triggers"==j||"macros"==j||"buttons"==j||"contexts"==j||(g[j]=h[j]));var l,n;if(h.aliases&&0<h.aliases.length)for(n=h.aliases.length,l=0;l<n;l++)g.aliases.push(new Alias(h.aliases[l]));if(h.triggers&&0<h.triggers.length)for(n=h.triggers.length,l=0;l<n;l++)g.triggers.push(new Trigger(h.triggers[l]));if(h.macros&&0<h.macros.length)for(n=h.macros.length,g.macros=[],l=0;l<n;l++)g.macros.push(new Macro(h.macros[l]));if(h.buttons&&0<h.buttons.length)for(n=h.buttons.length,l=0;l<n;l++)g.buttons.push(new Button(h.buttons[l]));if(h.contexts&&0<h.contexts.length)for(n=h.contexts.length,l=0;l<n;l++)g.contexts.push(new Context(h.contexts[l]));return g.file=g.name,g}save(f){this.file!=this.name.toLowerCase()&&(fs.existsSync(path.join(f,this.file+".json"))&&fs.unlinkSync(path.join(f,this.file+".json")),this.file=this.name.toLowerCase()),fs.writeFileSync(path.join(f,this.file+".json"),JSON.stringify(this))}clone(f){var g,h,j;if(2==f){if(g={name:this.name,priority:this.priority,enabled:this.enabled,aliases:[],triggers:[],macros:[],buttons:[],contexts:[],enableMacros:this.enableMacros,enableTriggers:this.enableTriggers,enableAliases:this.enableAliases,enableButtons:this.enableButtons,enableContext:this.enableContext,enableDefaultContext:this.enableDefaultContext},0<this.aliases.length)for(j=this.aliases.length,h=0;h<j;h++)g.aliases.push({pattern:this.aliases[h].pattern,value:this.aliases[h].value,priority:this.aliases[h].priority,regexp:this.aliases[h].regexp,style:this.aliases[h].style,multi:this.aliases[h].multi,append:this.aliases[h].append,name:this.aliases[h].name,group:this.aliases[h].group,enabled:this.aliases[h].enabled,params:this.aliases[h].params,display:this.aliases[h].display,notes:this.aliases[h].notes||""});if(0<this.triggers.length)for(j=this.triggers.length,h=0;h<j;h++)g.triggers.push({pattern:this.triggers[h].pattern,value:this.triggers[h].value,priority:this.triggers[h].priority,verbatim:this.triggers[h].verbatim,style:this.triggers[h].style,name:this.triggers[h].name,group:this.triggers[h].group,enabled:this.triggers[h].enabled,display:this.triggers[h].display,triggernewline:this.triggers[h].triggerNewline,triggerprompt:this.triggers[h].triggerPrompt,type:this.triggers[h].type,notes:this.triggers[h].notes||""});if(0<this.macros.length)for(j=this.macros.length,h=0;h<j;h++)g.macros.push({key:this.macros[h].key,value:this.macros[h].value,style:this.macros[h].style,append:this.macros[h].append,send:this.macros[h].send,name:this.macros[h].name,group:this.macros[h].group,enabled:this.macros[h].enabled,display:"if(item.key : : :  0) return \"None\", return keyCodeToChar[item.key]",displaytype:1,modifiers:this.macros[h].modifiers,chain:this.macros[h].chain,notes:this.macros[h].notes||""});if(0<this.buttons.length)for(j=this.buttons.length,h=0;h<j;h++)g.buttons.push(library_1.clone(this.buttons[h]));if(0<this.contexts.length)for(j=this.contexts.length,h=0;h<j;h++)g.contexts.push(library_1.clone(this.contexts[h]));return g}g=library_1.clone(this);var l=new Profile(!1),n;for(n in g)g.hasOwnProperty(n)&&("aliases"==n||"triggers"==n||"macros"==n||"buttons"==n||"contexts"==n||(l[n]=g[n]));if(g.aliases&&0<g.aliases.length)for(j=g.aliases.length,h=0;h<j;h++)l.aliases.push(new Alias(g.aliases[h]));if(g.triggers&&0<g.triggers.length)for(j=g.triggers.length,h=0;h<j;h++)l.triggers.push(new Trigger(g.triggers[h]));if(g.macros&&0<g.macros.length)for(j=g.macros.length,l.macros=[],h=0;h<j;h++)l.macros.push(new Macro(g.macros[h]));if(g.buttons&&0<g.buttons.length)for(j=g.buttons.length,h=0;h<j;h++)l.buttons.push(new Button(g.buttons[h]));if(g.contexts&&0<g.contexts.length)for(j=g.mencontextsus.length,h=0;h<j;h++)l.contexts.push(g.contexts[h].clone());return l}}exports.Profile=Profile;class ProfileCollection{constructor(f){this.items={},this.keys=[],this.add(null==f?Profile.Default:f)}SortByPrioity(){this.keys.sort((f)=>{var h=this.items[f].priority,j=this.items[f].priority;return h>j?-1:h<j?1:(h=this.items[f].name,j=this.items[f].name,h>j?-1:h<j?1:0)})}enabled(f){return f&&0!=this.keys.length&&("string"==typeof f?!!this.items[f.toLowerCase()]&&this.items[f.toLowerCase()].enabled:!!this.items[f.name.toLowerCase()]&&this.items[f.name.toLowerCase()].enabled)}contains(f){return f&&0!=this.keys.length&&("string"==typeof f?!!this.items[f.toLowerCase()]:!!this.items[f.name.toLowerCase()])}canDisable(f){if(!f||0==this.keys.length)return!1;var g;if("Profile"==typeof f)g=f.name.toLowerCase();else if("number"==typeof f){if(0>f)return!1;if(f>=this.keys.length)return!1;g=this.keys[f]}else if("object"==typeof f)g=f.name.toLowerCase();else if("string"==typeof f)g=f.toLowerCase();else return!1;if(!this.items[g])return!1;var h=!this.items[g].enabled;if(!h){var j=!1;for(var l in this.items)if(l!=g){this.items[l].enabled&&(j=!0);break}if(!j)return!1}return!0}toggle(f){if(!f||0==this.keys.length)return!1;var g;if("Profile"==typeof f)g=f.name.toLowerCase();else if("number"==typeof f){if(0>f)return!1;if(f>=this.keys.length)return!1;g=this.keys[f]}else if("object"==typeof f)g=f.name.toLowerCase();else if("string"==typeof f)g=f.toLowerCase();else return!1;if(!this.items[g])return!1;var h=!this.items[g].enabled;if(!h){var j=!1;for(var l in this.items)if(l!=g){this.items[l].enabled&&(j=!0);break}if(!j)return!1}return this.items[g].enabled=h,!0}update(){this.keys=Object.keys(this.items),this.SortByPrioity()}add(f){f&&(this.items[f.name.toLowerCase()]=f,this.update())}remove(f){if(f&&0!=this.keys.length){if("string"==typeof f)delete this.items[f.toLowerCase()];else if("number"==typeof f){if(0>f||f>=this.keys.length)return;delete this.items[this.keys[f]]}else delete this.items[f.name.toLowerCase()];this.update()}}copy(f){return f?0==this.keys.length?null:"string"==typeof f?this.items[f.toLowerCase()]?this.items[f.toLowerCase()].clone():null:"number"==typeof f?0>f||f>=this.keys.length?null:this.items[this.keys[f]].clone():f.clone():library_1.clone(this.items)}clone(f){if(2==f){var g={};for(var h in this.items)g[this.items[h].name]=this.items[h].clone(2);return g}var j=new ProfileCollection;for(var h in this.items)j.items[this.items[h].name]=this.items[h].clone();return j.update(),j}load(f){for(var g=fs.readdirSync(f),h=0;h<g.length;h++)".json"===path.extname(g[h])&&this.add(Profile.load(path.join(f,g[h])))}save(f){for(var g in this.items)this.items[g].save(f)}get length(){return this.keys.length}count(){return this.keys.length}get active(){var f=this.keys;if(0==f.length)return this.add(Profile.Default),this.items["default"];if(1==f.length)return this.items[f[0]].enabled?this.items[f[0]]:"Default"==this.items[f[0]].name?(this.items[f[0]].enable=!0,this.items["default"]):(this.add(Profile.Default),this.items["default"]);for(var g in f)if(this.items[g].enabled)return this.items[g];return this.items["default"]?(this.items["default"].enabled=!0,this.items["default"]):(this.add(Profile.Default),this.items["default"])}get aliases(){var f=this.keys,g=[],h=0,j=f.length;if(0===j)return[];if(1===j)return this.items[f[0]].enabled&&this.items[f[0]].enableAliases?this.items[f[0]].aliases:[];for(;h<j;h++)this.items[f[h]].enabled&&this.items[f[h]].enableAliases&&0!==this.items[f[h]].aliases.length&&(g=g.concat(this.items[f[h]].aliases));return g}get triggers(){var f=this.keys,g=[],h=0,j=f.length;if(0===j)return[];if(1===j)return this.items[f[0]].enabled&&this.items[f[0]].enableTriggers?this.items[f[0]].triggers:[];for(;h<j;h++)this.items[f[h]].enabled&&this.items[f[h]].enableTriggers&&0!==this.items[f[h]].triggers.length&&(g=g.concat(this.items[f[h]].triggers));return g}get macros(){var f=this.keys,g=[],h=0,j=f.length;if(0===j)return[];if(1===j)return this.items[f[0]].enabled&&this.items[f[0]].enableMacros?this.items[f[0]].macros:[];for(;h<j;h++)this.items[f[h]].enabled&&this.items[f[h]].enableMacros&&0!==this.items[f[h]].macros.length&&(g=g.concat(this.items[f[h]].macros));return g}get buttons(){var f=this.keys,g=[],h=0,j=f.length;if(0===j)return[];if(1===j)return this.items[f[0]].enabled&&this.items[f[0]].enableButtons?this.items[f[0]].buttons:[];for(;h<j;h++)this.items[f[h]].enabled&&this.items[f[h]].enableButtons&&0!==this.items[f[h]].buttons.length&&(g=g.concat(this.items[f[h]].buttons));return g}get contexts(){var f=this.keys,g=[],h=0,j=f.length;if(0===j)return[];if(1===j)return this.items[f[0]].enabled&&this.items[f[0]].enableContext?this.items[f[0]].contexts:[];for(;h<j;h++)this.items[f[h]].enabled&&this.items[f[h]].enableContext&&0!==this.items[f[h]].contexts.length&&(g=g.concat(this.items[f[h]].contexts));return g}}exports.ProfileCollection=ProfileCollection;
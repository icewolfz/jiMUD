"use strict";var _Mathfloor=Math.floor;Object.defineProperty(exports,"__esModule",{value:!0});const EventEmitter=require("events"),telnet_1=require("./telnet"),parser_1=require("./parser"),ansi_1=require("./ansi"),library_1=require("./library"),settings_1=require("./settings"),input_1=require("./input"),profile_1=require("./profile"),msp_1=require("./msp"),{version}=require("../../package.json"),path=require("path"),fs=require("fs");class Client extends EventEmitter{constructor(a,b){if(super(),this.lineCache=[],this._enableDebug=!1,this._auto=null,this._autoerror=!1,this.version=version,this.display=null,this.commandInput=null,this.character=null,this.commandCharacter=null,this.connecting=!1,this.profiles=new profile_1.ProfileCollection,this.connectTime=0,this.lastSendTime=0,this.defaultTitle="jiMUD",process.on("uncaughtException",(d)=>{"ECONNREFUSED"==d.code&&(this._autoerror=!0),this.error(d)}),null===b||"undefined"==typeof b)throw"Missing command input";if(null===a||"undefined"==typeof a)throw"Missing display";"string"==typeof a?(this.display=$(a),this.lineID=a+" .line"):(this.display=a,this.lineID="#"+this.display.attr("id")+" .line"),this.display.click(()=>{this.options.CommandonClick&&this.commandInput.focus()}),this.commandInput="string"==typeof b?$(b):b,this._MSP=new msp_1.MSP,this._MSP.on("playing",(d)=>{this.enableDebug&&this.emit("MSP "+(d.type?"Music":"Sound")+" Playing "+d.file+" for "+d.duration),this.options.notifyMSPPlay&&this.echo((d.type?"Music":"Sound")+" Playing "+d.file+" for "+d.duration,ansi_1.AnsiColorCode.InfoText,ansi_1.AnsiColorCode.InfoBackground,!0,!0)}),this._MSP.on("error",(d)=>{this.error(d)}),this._input=new input_1.input(this),this._input.on("scrolllock",(d)=>{this.emit("scrolllock",d)}),this.character=$("<div id='Character' class='ansi' style='border-bottom: 1px solid black'>W</div>"),this.character.appendTo("body"),this.commandCharacter=$("<div id='CmdCharacter'>W</div>"),this.commandCharacter.appendTo("body"),this.commandInput.val(""),this.commandInput.focus(),this.telnet=new telnet_1.Telnet,this.telnet.terminal="jiMUD",this.telnet.version=version,this.telnet.on("error",(d)=>{if(this.enableDebug&&this.debug(d),d){if("close"==d.type&&1006==d.code)return;var f=[];d.type&&f.push(d.type),d.text&&f.push(d.text),d.message&&f.push(d.message),d.reason&&f.push(d.reason),"ECONNREFUSED"==d.code&&(this._autoerror=!0),d.code?this.error(d.code+" - "+f.join(", ")):this.error(f.join(", ")),"ECONNREFUSED"==d.code&&this.close()}else this.error("Unknown telnet error.")}),this.telnet.on("connecting",()=>{this.connecting=!0,this.echo("Trying to connect to "+this.host+":"+this.port+".",ansi_1.AnsiColorCode.InfoText,ansi_1.AnsiColorCode.InfoBackground,!0,!0)}),this.telnet.on("connect",()=>{this.connecting=!1,this.echo("Connected...",ansi_1.AnsiColorCode.InfoText,ansi_1.AnsiColorCode.InfoBackground,!0,!0),this.connectTime=Date.now(),this.lastSendTime=Date.now(),this.emit("connected")}),this.telnet.on("debug",(d)=>{this.debug(d)}),this.telnet.on("receiveOption",(d)=>{this._MSP.processOption(d),this.emit("receivedOption",d)}),this.telnet.on("close",()=>{this.connecting=!1,this.echo("Connection closed to "+this.host+":"+this.port+".",ansi_1.AnsiColorCode.InfoText,ansi_1.AnsiColorCode.InfoBackground,!0,!0),this.connectTime=0,this.lastSendTime=0,this._MSP.reset(),this.emit("closed")}),this.telnet.on("receivedData",(d)=>{d={value:d},this.emit("receivedData",d),null===d||"undefined"==typeof d||null===d.value||"undefined"==typeof d.value||(this.printInternal(d.value,!1,!0),this.debug("Latency: "+this.telnet.latency+"ms"),this.debug("Latency: "+this.telnet.latency/1e3+"s"))}),this.telnet.on("receivedMSDP",(d)=>{this.emit("receivedMSDP",d)}),this.telnet.on("receivedGMCP",(d)=>{var g,j,f=d.value,h=0,i=f.length;if(0!==i){for(h=0;h<i&&(j=f.charAt(h)," "!==j&&"{"!==j&&"["!==j);h++);g=f.substr(0,h).trim(),f=f.substr(h).trim(),this.debug("GMCP Module: "+g),this.debug("GMCP Data: "+f);var k;try{0<f.length&&(k=JSON.parse(f))}catch(m){}this.emit("receivedGMCP",g,k)}}),this.telnet.on("windowSize",()=>{this.UpdateWindow()}),this.parser=new parser_1.Parser,this.parser.on("debug",(d)=>{this.debug(d)}),this.parser.on("addLine",(d)=>{d.raw=library_1.stripHTML(d.line),this.emit("addLine",d),null===d||"undefined"==typeof d||null===d.line||"undefined"==typeof d.line||0===d.line.length||d.gagged||this.lineCache.push(d.line)}),this.parser.on("MXPTagReply",()=>{}),this.parser.on("expireLinks",(d)=>{var f;f=0<d.length?this.display.find("a[expire='"+d[0]+"']"):this.display.find("a[expire]"),f.wrapInner("<span/>"),f=0<d.length?this.display.find("a[expire='"+d[0]+"'] span"):this.display.find("a[expire] span"),f.unwrap()}),this.parser.on("parseDone",()=>{if(0<this.lineCache.length){this.emit("parseDone",this.lineCache);var d=this.display.hasHorizontalScrollBar();this.display.append(this.lineCache.join("")),d!=this.display.hasHorizontalScrollBar()&&this.UpdateWindow(),this.scrollDisplay(),this.lineCache=[]}var f=$(this.lineID);if(f.length>this.options.bufferSize)for(var g=0,h=f.length-this.options.bufferSize;g<h;g++)$(f[g]).remove();f=null}),this.parser.on("setTitle",(d,f)=>{"undefined"==typeof d||null===d||0===d.length?window.document.title=this.defaultTitle:1!==f&&(window.document.title=this.options.title.replace("$t",d))}),this.parser.on("music",(d)=>{this._MSP.music(d),this.emit("music",d)}),this.parser.on("sound",(d)=>{this._MSP.sound(d),this.emit("sound",d)}),this.loadOptions(),this.loadProfiles(),this.emit("initialized")}get aliases(){return this.profiles.aliases}get macros(){return this.profiles.macros}get triggers(){return this.profiles.triggers}get buttons(){return this.profiles.buttons}get activeProfile(){return this.profiles.active}loadProfiles(){var a=path.join(library_1.parseTemplate("{data}"),"profiles");return fs.existsSync(a)?void(this.profiles.load(a),!this.profiles.contains("Default")&&this.profiles.add(profile_1.Profile.Default),this.emit("profiles-loaded")):void this.profiles.add(profile_1.Profile.Default)}saveProfiles(){var a=path.join(library_1.parseTemplate("{data}"),"profiles");fs.existsSync(a)||fs.mkdirSync(a),this.profiles.save(a),this.emit("profiles-updated")}saveProfile(a){var b=path.join(library_1.parseTemplate("{data}"),"profiles");fs.existsSync(b)||fs.mkdirSync(b),this.profiles.items[a].save(b),this.emit("profile-updated",a)}toggleProfile(a){this.profiles.toggle(a),this.saveProfile(a)}get enableDebug(){return this._enableDebug}set enableDebug(a){this._enableDebug=a,this.telnet.enableDebug=a,this.parser.enableDebug=a,this._MSP.enableDebug=a}get host(){return this.telnet.host}set host(a){this.telnet.host=a}get port(){return this.telnet.port}set port(a){this.telnet.port=a}get connected(){return this.telnet.connected}loadOptions(){if(this.options=settings_1.Settings.load(path.join(library_1.parseTemplate("{data}"),"settings.json")),this.enableDebug=this.options.enableDebug,this.parser.enableFlashing=this.options.flashing,this.parser.enableMXP=this.options.enableMXP,this.parser.enableURLDetection=this.options.enableURLDetection,this.parser.enableMSP=this.options.enableMSP,0<this.options.colors.length)for(var a=this.options.colors,b=0,d=a.length;b<d;b++)a[b]&&0!==a[b].length&&this.parser.SetColor(b,a[b]);this.telnet.options.MCCP=this.options.enableMCCP,this.telnet.options.MXP=this.options.enableMXP,this.telnet.UTF8=this.options.enableUTF8,this.telnet.options.ECHO=this.options.enableEcho,this.telnet.enableLatency=this.options.lagMeter,this.telnet.enablePing=this.options.enablePing,this._MSP.enabled=this.options.enableMSP,this._MSP.savePath=library_1.parseTemplate(this.options.soundPath),this._input.scrollLock=this.options.scrollLocked,this.UpdateFonts(),this.scrollDisplay(),this.emit("optionsLoaded")}saveOptions(){this.options.save(path.join(library_1.parseTemplate("{data}"),"settings.json"))}UpdateFonts(){this.display&&(this.display.css("font-size",this.options.fontSize),this.display.css("font-family",this.options.font+", monospace"),this.commandInput.css("font-size",this.options.cmdfontSize),this.commandInput.css("font-family",this.options.cmdfont+", monospace"),this.character.css("font-size",this.options.fontSize),this.character.css("font-family",this.options.font+", monospace"),this.commandCharacter.css("font-size",this.options.cmdfontSize),this.commandCharacter.css("font-family",this.options.cmdfont+", monospace"))}parse(a){this.parseInternal(a,!1)}parseInternal(a,b,d){this.parser.parse(a,b,d)}error(a){a={error:a,handled:!1};null===a||"undefined"==typeof a||a.handled||(null===a.error||"undefined"==typeof a.error?this.echo("Error: Unknown.",ansi_1.AnsiColorCode.ErrorText,ansi_1.AnsiColorCode.ErrorBackground,!0,!0):"string"==typeof a.error&&0===a.error.length?this.echo("Error: Unknown.",ansi_1.AnsiColorCode.ErrorText,ansi_1.AnsiColorCode.ErrorBackground,!0,!0):a.error instanceof ReferenceError?a.error.lineNumber?this.echo("Error: File: "+a.error.fileName+", Line: "+a.error.lineNumber+", "+a.error.message+".",ansi_1.AnsiColorCode.ErrorText,ansi_1.AnsiColorCode.ErrorBackground,!0,!0):this.echo("Error: "+a.error+".",ansi_1.AnsiColorCode.ErrorText,ansi_1.AnsiColorCode.ErrorBackground,!0,!0):a.error instanceof Error?this.echo("Error: "+a.error.name+" - "+a.error.message+".",ansi_1.AnsiColorCode.ErrorText,ansi_1.AnsiColorCode.ErrorBackground,!0,!0):a.error.message?this.echo("Error: "+a.error.message+".",ansi_1.AnsiColorCode.ErrorText,ansi_1.AnsiColorCode.ErrorBackground,!0,!0):this.echo("Error: "+a.error+".",ansi_1.AnsiColorCode.ErrorText,ansi_1.AnsiColorCode.ErrorBackground,!0,!0),this.options.autoConnect&&!this.telnet.connected&&!this._autoerror&&(this._auto&&clearTimeout(this._auto),this._auto=setTimeout(()=>{this.connect()},600)))}echo(a,b,d,f,g){null==a&&(a=""),null==f&&(f=!1),null==g&&(g=!1),null==b&&(b=ansi_1.AnsiColorCode.LocalEcho),null==d&&(d=ansi_1.AnsiColorCode.LocalEchoBack);var h=this.parser.CurrentAnsiCode()+"\n";a.endsWith("\n")&&(a=a.substr(0,a.length-1)),this.telnet.prompt&&g?this.print("\n\x1B["+b+";"+d+"m"+a+h,f):this.print("\x1B["+b+";"+d+"m"+a+h,f)}print(a,b){this.printInternal(a,b,!1)}printInternal(a,b,d){null===a||"undefined"==typeof a||(null==b&&(b=!1),null==d&&(d=!1),b&&0<this.parser.TextLength&&!this.parser.EndofLine&&!this.telnet.prompt&&(a="\n"+a),this.parseInternal(a,d))}send(a){this.telnet.sendData(a),this.lastSendTime=Date.now()}sendRaw(a){this.telnet.sendData(a,!0),this.lastSendTime=Date.now()}sendGMCP(a){this.telnet.sendGMCP(a),this.lastSendTime=Date.now()}debug(a){var b={value:a};this.emit("debug",b);!this._enableDebug||null===b||"undefined"==typeof b||null===b.value||"undefined"==typeof b.value||0===b.value.length||window.console&&console.log(b.value)}sendCommand(a){null==a&&(a=this.commandInput.val(),this.telnet.echo?this._input.AddCommandToHistory(a):this.commandInput.val("")),a.endsWith("\n")||(a+="\n");var b={value:a,handled:!1};this.emit("parseCommand",b);null===b||"undefined"==typeof b||b.handled||null===b.value||"undefined"==typeof b.value||(0<b.value.length&&(this.connected&&this.send(b.value),this.telnet.echo&&this.options.commandEcho?this.echo(b.value):this.echo("\n")),this.options.keepLastCommand?this.commandInput.select():this.commandInput.val(""))}sendBackground(a){null==a&&(a=this.commandInput.val(),this.telnet.echo?this._input.AddCommandToHistory(a):this.commandInput.val("")),a.endsWith("\n")||(a+="\n");var b={value:a,handled:!1};this.emit("parseCommand",b);null===b||"undefined"==typeof b||null===b.value||"undefined"==typeof b.value||!b.handled&&0<b.value.length&&(this.connected&&this.send(b.value),this.telnet.echo&&this.options.commandEcho?this.echo(b.value):this.echo("\n"))}get WindowSize(){return new library_1.Size(this.WindowWidth,this.WindowHeight)}get WindowWidth(){return _Mathfloor((this.display.innerWidth()-12)/parseFloat(window.getComputedStyle(this.character[0]).width))-1}get WindowHeight(){return this.display.hasHorizontalScrollBar()?_Mathfloor((this.display.innerHeight()-12-4)/(this.character.innerHeight()+0.5))-1:_Mathfloor((this.display.innerHeight()-4)/(this.character.innerHeight()+0.5))-1}get scrollLock(){return this._input.scrollLock}set scrollLock(a){this._input.scrollLock=a}toggleScrollLock(){this._input.toggleScrollLock()}UpdateWindow(){var a=this.WindowSize;this.parser.updateWindow(a.width,a.height),this.telnet.updateWindow(a.width,a.height)}scrollDisplay(){!this._input.scrollLock&&this.display&&(this.display[0].scrollTop=this.display[0].scrollHeight)}close(){this.telnet.close(),this._auto&&clearTimeout(this._auto)}connect(){this._autoerror=!1,this.emit("connecting"),this._MSP.reset(),this.parser.ClearMXP(),this.parser.ResetMXPLine(),this.telnet.connect(),this.emit("connect"),this.commandInput.focus()}receivedData(a){this.telnet.receivedData(a)}notify(a,b){this.enableDebug&&(this.emit("debug","notify title: "+a),this.emit("debug","notify msg: "+b)),this.emit("notify",a,b)}clear(){this.display.empty(),this.parser.Clear()}parseOutgoing(a,b,d){return this._input.parseOutgoing(a,b,d)}clearTriggerCache(){this._input.clearTriggerCache()}}exports.Client=Client;
"use strict";var _StringfromCharCode=String.fromCharCode;Object.defineProperty(exports,"__esModule",{value:!0});const EventEmitter=require("events"),net=require("net"),ZLIB=require("./../../lib/inflate_stream.min.js").Zlib,Socket=net.Socket;class Telnet extends EventEmitter{constructor(t){super(),this._splitBuffer=[],this._connected=!1,this._MTTS=0,this.zstream=0,this._latencyTime=null,this._doPing=!1,this._closed=!0,this._zlib=!1,this.options={MCCP:!0,MXP:!0,NAWS:!0,MSDP:!0,GMCP:!0,MSSP:!1,ECHO:!0,TTYPE:!0,EOR:!0,NEWENVIRON:!1,ZMP:!1,ATCP:!1,CHARSET:!0},this.host="",this.port=23,this.prompt=!1,this.echo=!0,this.firstSent=!0,this.firstReceived=!0,this.server={NAWS:!1,MSDP:!1,GMCP:!1,MXP:!1,MCCP1:!1,MCCP2:!1,MSSP:!1,NEWENVIRON:!1,ZMP:!1,EOR:!1,ATCP:!1,CHARSET:!1},this.version="2.0",this.terminal="ansi",this.UTF8=!0,this.MSSP={},this.socket=null,this.latency=0,this.latencyAvg=null,this.enableLatency=!1,this.enablePing=!1,this.GMCPSupports=["Core 1","Char 1","Char.Vitals 1","Char.Experience 1"],this.enableDebug=!1,t&&(t.host&&(this.host=t.host,delete t.host),t.port&&(this.port=t.port,delete t.port)),this.options=Object.assign(this.options,t||{})}get connected(){return this.socket&&null!==typeof this.socket&&this._connected}reset(){this._MTTS=0,this.firstSent=!0,this.firstReceived=!0,this.prompt=!1,this.echo=!0,this.server={NAWS:!1,MSDP:!1,GMCP:!1,MXP:!1,MCCP1:!1,MCCP2:!1,MSSP:!1,EOR:!1,NEWENVIRON:!1,ATCP:!1,CHARSET:!1,ZMP:!1},this._splitBuffer=[],this._endMCCP(),this._connected=!1,this._closed=!1,this.enableDebug&&this.emit("debug","Reset")}connect(){this._destroySocket(),this.reset(),this.emit("connecting"),this.socket=this._createSocket(),this.socket.connect(this.port,this.host),this.enableDebug&&this.emit("debug","Connecting to "+this.host+":"+this.port)}close(){this._closed||(this._destroySocket(),this.reset(),this.emit("close"),this._closed=!0,this.enableDebug&&this.emit("debug","Closed"))}receivedData(t){this.enableLatency&&(null===this._latencyTime?!this._doPing&&this.enablePing?this._doPing=!0:(this._latencyTime=null,this._doPing=!1):(this.latency=new Date().getTime()-this._latencyTime.getTime(),this.latencyAvg=null===this.latencyAvg?this.latency:(this.latency+this.latencyAvg)/2,this._latencyTime=null,this._doPing=!1,this.emit("latency-changed",this.latency,this.latencyAvg))),this.enableDebug&&this.emit("debug","PreProccess:"+t,1),t=this.processData(t),this.enableDebug&&this.emit("debug","PostProccess:"+t,1),this.emit("receivedData",t),this.enableLatency&&(0<this._splitBuffer.length?(this.enablePing&&(this._doPing=!0),this._latencyTime=null):this._doPing&&this.enablePing?setTimeout(()=>{this._latencyTime=new Date,this.sendGMCP("Core.Ping "+this.latencyAvg)}):this._doPing=!1)}sendTerminal(){this.enableDebug&&(0===this._MTTS?this.emit("debug","REPLY: <IAC><SB><TERMINALTYPE><IS>"+this.terminal+"<IAC><SE>"):1===this._MTTS?this.emit("debug","REPLY: <IAC><SB><TERMINALTYPE><IS>ANSI-256COLOR<IAC><SE>"):2<=this._MTTS&&this.emit("debug","REPLY: <IAC><SB><TERMINALTYPE><IS>MTTS 9<IAC><SE>")),0===this._MTTS?(this.sendData([255,250,24,0],!0),this.sendData(Buffer.from(this.terminal,"ascii"),!0),this.sendData([255,240],!0)):1===this._MTTS?this.sendData([255,250,24,0,65,78,83,73,45,50,53,54,67,79,76,79,82,255,240],!0):2<=this._MTTS&&this.sendData([255,250,24,0,77,84,84,83,32,57,255,240],!0)}sendData(t,n){if(null!==t&&"undefined"!=typeof t&&0!==t.length){if(this.connected)try{n||(this.prompt=!1,t=this._escapeData(t),this.enableLatency&&(this._latencyTime=new Date)),null!==this.socket&&(!Buffer.isBuffer(t)&&(t=Buffer.from(t,"binary")),this.enableDebug&&this.emit("debug","sendData:"+t.toString("binary"),2),this.socket.write(t,"binary"),!n&&(this.firstSent=!1))}catch(r){this.emit("error",r)}else this.enableLatency&&(this._latencyTime=null);this.emit("dataSent",t)}}processData(t){var n,r;if(null===t)return t;if(t=this._decompressData(t),n=t.length,0===n)return t;r=this._splitBuffer,0<r.length&&(this.enableDebug&&this.emit("debug","Split buffer length: "+r.length,1),t=Buffer.concat([Buffer.from(r,"binary"),t]),r=[],n=t.length);var D,P,u=0,a=0,o=[],l=this.prompt,s=0,g=0,p="",C="",d=0,m=0,E="";this.prompt=!1;var T="";try{for(;m<n;m++)switch(d=t[m],u){case 0:255===d?(this.enableDebug&&(T="TELOP: <IAC>"),r.push(d),u=1):o.push(d);break;case 1:255===d?(this.enableDebug&&(this.emit("debug",T+"<IAC>"),T=""),o.push(d),r=[],u=0):this.options.EOR&&this.server.EOR||239!==d?241===d||130===d?(this.enableDebug&&(this.emit("debug",T+"<NOP>"),T=""),r=[],u=0):249===d||239===d?(this.enableDebug&&(239===d?this.emit("debug",T+"<EOR>"):this.emit("debug",T+"<GA>"),T=""),m+1<n&&2<n-m?(o.push(10),this.prompt=!1):this.prompt=!0,r=[],u=0):253===d||254===d||251===d||252===d?(this.enableDebug&&(253==d?T+="<DO>":254==d?T+="<DONT>":251==d?T+="<WILL>":252==d?T+="<WONT>":void 0),r.push(d),s=d,u=2):250===d?(this.enableDebug&&(T+="<SB>"),r.push(d),u=3):(this.enableDebug&&(T+=this._formatByte(d)),r=[],u=0):(this.enableDebug&&(this.emit("debug",T+"<NOP>"),T=""),r=[],u=0);break;case 2:1===d?(this.enableDebug&&(this.emit("debug",T+"<ECHO>"),T=""),253==s?this.options.ECHO?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><ECHO>"),this.replyToOption(d,251,s),this.echo=!1):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ECHO>"),this.echo=!0,this.replyToOption(d,254,s)):254==s?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><ECHO>"),this.replyToOption(d,252,s),this.echo=!0):251==s?this.options.ECHO?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><ECHO>"),this.replyToOption(d,253,s),this.echo=!1):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ECHO>"),this.echo=!0,this.replyToOption(d,254,s)):252==s&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ECHO>"),this.echo=!0,this.replyToOption(d,254,s)),u=0,r=[]):24===d?(this.enableDebug&&(this.emit("debug",T+"<TERMINALTYPE>"),T=""),253==s?this.options.TTYPE?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><TERMINALTYPE>"),this.replyToOption(d,251,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><TERMINALTYPE>"),this.replyToOption(d,254,s)):254==s?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><TERMINALTYPE>"),this.replyToOption(d,252,s)):251==s?this.options.TTYPE?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><TERMINALTYPE>"),this.replyToOption(d,253,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><TERMINALTYPE>"),this.replyToOption(d,254,s)):252==s&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><TERMINALTYPE>"),this.replyToOption(d,254,s)),u=0,r=[]):25===d?(this.enableDebug&&(this.emit("debug",T+"<ENDOFRECORD>"),T=""),253==s?(this.server.EOR=!0,this.options.EOR?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><ENDOFRECORD>"),this.replyToOption(d,251,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ENDOFRECORD>"),this.replyToOption(d,254,s))):254==s?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><ENDOFRECORD>"),this.replyToOption(d,252,s)):251==s?(this.server.EOR=!0,this.options.EOR?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><ENDOFRECORD>"),this.replyToOption(d,253,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ENDOFRECORD>"),this.replyToOption(d,254,s))):252==s&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><ENDOFRECORD>"),this.replyToOption(d,254,s)),u=0,r=[]):31===d?(this.enableDebug&&(this.emit("debug",T+"<NAWS>"),T=""),253==s?(this.server.NAWS=!0,this.options.NAWS?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><NAWS>"),this.replyToOption(d,251,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NAWS>"),this.replyToOption(d,254,s))):254==s?(this.server.NAWS=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><NAWS>"),this.replyToOption(d,252,s)):251==s?(this.server.NAWS=!0,this.options.NAWS?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><NAWS>"),this.replyToOption(d,253,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NAWS>"),this.replyToOption(d,254,s))):252==s&&(this.server.NAWS=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NAWS>"),this.replyToOption(d,254,s)),this.emit("windowSize"),u=0,r=[]):36===d||39===d?(this.enableDebug&&(this.emit("debug",T+"<NEWENVIRON>"),T=""),253==s?(this.server.NEWENVIRON=!0,this.options.NEWENVIRON?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><NEWENVIRON>"),this.replyToOption(d,251,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NEWENVIRON>"),this.replyToOption(d,254,s))):254==s?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><NEWENVIRON>"),this.replyToOption(d,252,s)):251==s?(this.server.NEWENVIRON=!0,this.options.NEWENVIRON?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><NEWENVIRON>"),this.replyToOption(d,253,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NEWENVIRON>"),this.replyToOption(d,254,s))):252==s&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><NEWENVIRON>"),this.replyToOption(d,254,s)),u=0,r=[]):69===d?(this.enableDebug&&(this.emit("debug",T+"<MSDP>"),T=""),253==s?(this.server.MSDP=!0,this.options.MSDP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MSDP>"),this.replyToOption(d,251,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSDP>"),this.replyToOption(d,254,s))):254==s?(this.server.MSDP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MSDP>"),this.replyToOption(d,252,s)):251==s?(this.server.MSDP=!0,this.options.MSDP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MSDP>"),this.replyToOption(d,253,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSDP>"),this.replyToOption(d,254,s))):252==s&&(this.server.MSDP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSDP>"),this.replyToOption(d,254,s)),u=0,r=[]):70===d?(this.enableDebug&&(this.emit("debug",T+"<MSSP>"),T=""),253==s?(this.server.MSSP=!0,this.options.MSSP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MSSP>"),this.replyToOption(d,251,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSSP>"),this.replyToOption(d,254,s))):254==s?(this.server.MSSP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MSSP>"),this.replyToOption(d,252,s)):251==s?(this.server.MSSP=!0,this.options.MSSP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MSSP>"),this.replyToOption(d,253,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSSP>"),this.replyToOption(d,254,s))):252==s&&(this.server.MSSP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MSSP>"),this.replyToOption(d,254,s)),u=0,r=[]):85===d?(this.enableDebug&&(this.emit("debug",T+"<MCCP1>"),T=""),253==s?(this.server.MCCP1=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MCCP1>"),this.replyToOption(d,251,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP1>"),this.replyToOption(d,254,s))):254==s?(this.server.MCCP1=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MCCP1>"),this.replyToOption(d,252,s)):251==s?(this.server.MCCP1=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MCCP1>"),this.replyToOption(d,253,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP1>"),this.replyToOption(d,254,s))):252==s&&(this.server.MCCP1=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP1>"),this.replyToOption(d,254,s)),u=0,r=[]):86===d?(this.enableDebug&&(this.emit("debug",T+"<MCCP2>"),T=""),253==s?(this.server.MCCP2=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MCCP2>"),this.replyToOption(d,251,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP2>"),this.replyToOption(d,254,s))):254==s?(this.server.MCCP2=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MCCP2>"),this.replyToOption(d,252,s)):251==s?(this.server.MCCP2=!0,this.options.MCCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MCCP2>"),this.replyToOption(d,253,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP2>"),this.replyToOption(d,254,s))):252==s&&(this.server.MCCP2=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MCCP2>"),this.replyToOption(d,254,s)),u=0,r=[]):91===d?(this.enableDebug&&(this.emit("debug",T+"<MXP>"),T=""),253==s?(this.server.MXP=!0,this.options.MXP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><MXP>"),this.replyToOption(d,251,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MXP>"),this.replyToOption(d,254,s))):254==s?(this.server.MXP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><MXP>"),this.replyToOption(d,252,s)):251==s?(this.server.MXP=!0,this.options.MXP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><MXP>"),this.replyToOption(d,253,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MXP>"),this.replyToOption(d,254,s))):252==s&&(this.server.MXP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><MXP>"),this.replyToOption(d,254,s)),u=0,r=[]):130===d||241===d?(this.enableDebug&&(this.emit("debug",T+"<NOP>"),T=""),this._fireReceiveOption(d,s,""),r=[],u=0):201===d?(this.enableDebug&&(this.emit("debug",T+"<GMCP>"),T=""),253==s?(this.server.GMCP=!0,this.options.GMCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><GMCP>"),this.replyToOption(d,251,s),this._startGMCP()):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><GMCP>"),this.replyToOption(d,254,s))):254==s?(this.server.GMCP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><GMCP>"),this.replyToOption(d,252,s)):251==s?(this.server.GMCP=!0,this.options.GMCP?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><GMCP>"),this.replyToOption(d,253,s),this._startGMCP()):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><GMCP>"),this.replyToOption(d,254,s))):252==s&&(this.server.GMCP=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><GMCP>"),this.replyToOption(d,254,s)),u=0,r=[]):42===d?(this.enableDebug&&(this.emit("debug",T+"<CHARSET>"),T=""),253==s?(this.server.CHARSET=!0,this.options.CHARSET?(this.enableDebug&&this.emit("debug","REPLY: <IAC><WILL><CHARSET>"),this.replyToOption(d,251,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><CHARSET>"),this.replyToOption(d,254,s))):254==s?(this.server.CHARSET=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><CHARSET>"),this.replyToOption(d,252,s)):251==s?(this.server.CHARSET=!0,this.options.CHARSET?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DO><CHARSET>"),this.replyToOption(d,253,s)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><CHARSET>"),this.replyToOption(d,254,s))):252==s&&(this.server.CHARSET=!1,this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><CHARSET>"),this.replyToOption(d,254,s)),u=0,r=[]):(this.enableDebug&&(this.emit("debug",T+this._formatByte(d)),T=""),251==s||252==s?(this.enableDebug&&this.emit("debug","REPLY: <IAC><DONT><"+d+">"),this.replyToOption(d,254,s)):(254==s||253==s)&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><WONT><"+d+">"),this.replyToOption(d,252,s)),u=0,r=[]);break;case 3:g=d,24===d?(this.enableDebug&&(T+="<TERMINALTYPE>"),r.push(d),g=d,u=4):36===d||39===d?(this.enableDebug&&(T+="<NEWENVIRON>"),r.push(d),g=d,u=12,P=-1):69===d?(this.enableDebug&&(T+="<MSDP>"),r.push(d),g=d,u=4):70===d?(this.enableDebug&&(T+="<MSSP>"),r.push(d),g=d,u=8,D={}):85===d||86===d?(this.enableDebug&&(T+=85===d?"<MCCP1>":"<MCCP2>"),r.push(d),g=d,u=11):201===d?(this.enableDebug&&(T+="<GMCP>"),r.push(d),g=d,u=7):240===d?(this.enableDebug&&(this.emit("debug",T+"<SE>"),T=""),this._fireReceiveOption(g,250,Buffer.from(r.slice(1,r.length-4)).toString("ascii")),u=0,r=[]):42===d?(this.enableDebug&&(T+="<CHARSET>"),r.push(d),g=d,u=17,p=""):(this.enableDebug&&(T+=this._formatByte(d)),r.push(d));break;case 4:24===g&&1===d?(this.enableDebug&&(T+="<SEND>"),r.push(d),s=1):240===d?(this.enableDebug&&(this.emit("debug",T+"<SE>"),T=""),24===g&&1==s&&(E=!1,this._fireReceiveOption(g,250,""),!E&&(this.sendTerminal(),this.sendTerminal(),this._MTTS++)),u=0,r=[]):69===g&&1===d?(this.enableDebug&&(T+="<MSDP_VAR>"),r.push(d),C="",u=5):(this.enableDebug&&(T+=this._formatByte(d)),r.push(d));break;case 5:2===d?(this.enableDebug&&(T+="<MSDP_VAL>"),r.push(d),p="",u=6):(this.enableDebug&&(T+=this._formatByte(d)),C+=_StringfromCharCode(d),r.push(d));break;case 6:255===d?(this.enableDebug&&(T+="<IAC>"),r.push(d)):1===d?(this.enableDebug&&(T+="<MSDP_VAR>"),this._fireReceiveMSDP(C,p),p="",C="",r.push(d),u=5):240===d?(this.enableDebug&&(this.emit("debug",T+"<SE>"),T=""),this._fireReceiveOption(g,250,Buffer.from(r.slice(1,r.length-4)).toString("ascii")),this._fireReceiveMSDP(C,p),p="",C="",u=0,r=[]):(this.enableDebug&&(T+=this._formatByte(d)),p+=_StringfromCharCode(d),r.push(d));break;case 7:255===d?(this.enableDebug&&(T+="<IAC>"),r.push(d)):240===d?(this.enableDebug&&(this.emit("debug",T+"<SE>"),T=""),this._fireReceiveOption(g,250,Buffer.from(r.slice(1,r.length-4)).toString("ascii")),this._fireReceiveGMCP(p),u=0,p="",r=[]):(this.enableDebug&&(T+=this._formatByte(d)),p+=_StringfromCharCode(d),r.push(d));break;case 8:255===d?(this.enableDebug&&(T+="<IAC>"),r.push(d)):240===d?(this.enableDebug&&(this.emit("debug",T+"<SE>"),this.emit("debug",this.MSSP),T=""),this._fireReceiveOption(g,250,Buffer.from(r.slice(1,r.length-4)).toString("ascii")),this.emit("receiveMSSP",D),p="",C="",D=0,u=0,r=[]):1===d?(this.enableDebug&&(T+="<MSSP_VAR>"),r.push(d),C="",u=9):(this.enableDebug&&(T+=this._formatByte(d)),r.push(d));break;case 9:255===d?(this.enableDebug&&(T+="<IAC>"),r.push(d),u=8):1===d?(this.enableDebug&&(T+="<MSSP_VAR>"),r.push(d),C=""):2===d?(this.enableDebug&&(T+="<MSSP_VAL>"),r.push(d),this.MSSP[C]="",D[C]="",u=10):(this.enableDebug&&(T+=this._formatByte(d)),C+=_StringfromCharCode(d),r.push(d));break;case 10:255===d?(this.enableDebug&&(T+="<IAC>"),r.push(d),u=8):1===d?(this.enableDebug&&(T+="<MSSP_VAR>"),r.push(d),C="",u=9):2===d?(this.enableDebug&&(T+="<MSSP_VAL>"),r.push(d),this.MSSP[C]="",D[C]=""):(this.enableDebug&&(T+=this._formatByte(d)),this.MSSP[C]+=_StringfromCharCode(d),D[C]+=_StringfromCharCode(d),r.push(d));break;case 11:255===d?(this.enableDebug&&(T+="<IAC>"),r.push(d)):240===d&&(this.enableDebug&&(this.emit("debug",T+"<SE>"),T=""),this._fireReceiveOption(g,86,""),this._startMCCP(),u=0,r=[],m<n-1&&(o=o.concat(this.processData(t.slice(m+1)).slice())),m=n);break;case 12:255===d?(this.enableDebug&&(T+="<IAC>"),r.push(d)):240===d?(this.enableDebug&&(this.emit("debug",T+"<SE>"),T=""),this._fireReceiveOption(g,250,Buffer.from(r.slice(1,r.length-4)).toString("ascii")),this._fireReceiveGMCP(p),u=0,p="",r=[]):0===d?(this.enableDebug&&(T+="<IS>"),r.push(d),u=13,s=d):1===d?(this.enableDebug&&(T+="<SEND>"),r.push(d),u=13,s=d):2===d?(this.enableDebug&&(T+="<SEND>"),r.push(d),u=13,s=d):(this.enableDebug&&(T+=this._formatByte(d)),p+=_StringfromCharCode(d),r.push(d));break;case 13:0===d?(this.enableDebug&&(T+="<VAR>"),r.push(d),u=14,s=d,C="",-1==P&&(P=0)):1===d?(this.enableDebug&&(T+="<VALUE>"),r.push(d),u=13,s=d,-1==P&&(P=1)):3===d?(this.enableDebug&&(T+="<USERVAR>"),r.push(d),u=13,s=d):255===d?(this.enableDebug&&(T+="<IAC>"),r.push(d)):240===d?(this.enableDebug&&(this.emit("debug",T+"<SE>"),T=""),E=this._fireReceiveOption(g,250,Buffer.from(r.slice(1,r.length-4)).toString("ascii")),this.emit("receiveNEWEVIRON",p),!E&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><NEWENVIRON><IS><IAC><SE>"),this.sendData([255,250,g,0,255,40],!0)),u=0,p="",r=[]):(this.enableDebug&&(T+=this._formatByte(d)),p+=_StringfromCharCode(d),r.push(d));break;case 14:2===d?(this.enableDebug&&(T+=this._formatByte(d)),r.push(d),u=15,a=14):255==d||3>=d?(m--,u=13):(this.enableDebug&&(T+=this._formatByte(d)),C+=_StringfromCharCode(d),r.push(d));break;case 15:this.enableDebug&&(T+=this._formatByte(d)),16==a?p+=_StringfromCharCode(d):C+=_StringfromCharCode(d),u=a,r.push(d);break;case 16:break;case 17:1===d?(this.enableDebug&&(T+="<REQUEST>"),r.push(d),u=18,p=""):255===d?(this.enableDebug&&(T+="<IAC>"),r.push(d)):240===d?(this.enableDebug&&(this.emit("debug",T+"<SE>"),T=""),E=this._fireReceiveOption(g,250,p),this.emit("receiveCHARSET",p),!E&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><CHARSET><REJECTED><IAC><SE>"),this.sendData([255,250,42,3,255,240],!0)),u=0,p="",r=[]):(this.enableDebug&&(T+=this._formatByte(d)),p+=_StringfromCharCode(d),r.push(d));break;case 18:255===d?(this.enableDebug&&(T+="<IAC>"),r.push(d)):240===d?(this.enableDebug&&(this.emit("debug",T+"<SE>"),T=""),E=this._fireReceiveOption(g,250,p),this.emit("receiveCHARSET",p.slice(1)),!E&&(this.options.CHARSET&&"utf-8"==p.slice(1).toLowerCase()?(this.server.CHARSET=!0,this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><ACCEPTED>UTF-8<IAC><SE>"),this.sendData([255,250,42,2],!0),this.sendData("UTF-8",!0),this.sendData([255,240],!0)):(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><CHARSET><REJECTED><IAC><SE>"),this.sendData([255,250,42,3,255,240],!0))),u=0,p="",r=[]):(this.enableDebug&&(T+=this._formatByte(d)),p+=_StringfromCharCode(d),r.push(d));}}catch(S){this.emit("error",S)}return this.enableDebug&&(0<T.length&&this.emit("debug",T),this.emit("debug","Post Split buffer length: "+r.length,1),this.emit("debug","Post Split buffer  "+Buffer.from(r),1)),l&&0<o.length?o.unshift(10):l&&(this.prompt=!0),0<o.length&&(this.firstReceived=!1),this._splitBuffer=r,o=Buffer.from(o),this.UTF8||this.options.CHARSET?o.toString("UTF8"):o}replyToOption(t,n,r,u){return("undefined"==typeof u&&(u=""),!this._fireReceiveOption(t,r,u))&&(this.sendData([255,n,t],!0),!0)}updateWindow(t,n){if(!(1>n)&&!(1>t)&&this.connected&&this.server.NAWS)try{var r,u,a,o,l=Math.floor;r=l(t/256),256<r&&(r=255),u=t%256,a=l(n/256),256<a&&(a=255),o=n%256,this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><NAWS><"+r+"><"+u+"><"+a+"><"+o+"><IAC><SE>"),this.sendData([255,250,31,r,u,a,o,255,240],!0)}catch(s){this.emit("error",{message:"UpdateWindow Error: "+s,err:s})}}sendGMCP(t){this.connected&&this.server.GMCP&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><GMCP>"+this._escapeData(t).toString("binary")+"<IAC><SE>"),this.sendData([255,250,201],!0),this.sendData(this._escapeData(t),!0),this.sendData([255,240],!0))}_startGMCP(){this.server.GMCP&&(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><GMCP>Core.Hello { \"client\": \""+this.terminal+"\", \"version\": \""+this.version+"\" }<IAC><SE>"),this.sendData([255,250,201],!0),this.sendData("Core.Hello { \"client\": \""+this.terminal+"\", \"version\": \""+this.version+"\" }",!0),this.sendData([255,240],!0),this.sendData([255,250,201],!0),0<this.GMCPSupports.length?(-1==this.GMCPSupports.indexOf("Core 1")&&this.GMCPSupports.unshift("Core 1"),this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><GMCP>"+JSON.stringify(this.GMCPSupports)+"<IAC><SE>"),this.sendData("Core.Supports.Set "+JSON.stringify(this.GMCPSupports))):(this.enableDebug&&this.emit("debug","REPLY: <IAC><SB><GMCP>Core.Supports.Set [ \"Core 1\" ]<IAC><SE>"),this.sendData("Core.Supports.Set [ \"Core 1\" ]",!0)),this.sendData([255,240],!0))}_startMCCP(){this._zlib=!0}_endMCCP(){this._zlib=!1,this.zstream=0}_decompressData(t){return this._zlib?(this.zstream||(this.zstream=new ZLIB.InflateStream),this.enableDebug&&this.emit("debug","Pre decompress:"+t.toString("binary"),1),t=this.zstream.decompress(t),this.enableDebug&&this.emit("debug","Post decompress:"+t.toString("binary"),1),new Buffer(t,"binary")):t}_escapeData(t){if(null===t||"undefined"==typeof t)return t;var n,r,u=0;for(Buffer.isBuffer(t)||Array.isArray(t)||(t=Buffer.from(t)),n=t.length,r=[];u<n;u++)r.push(t[u]),255===t[u]?r.push(255):13===t[u]&&1==n?r.push(10):10===t[u]&&1==n&&(r.push(13),r.push(0));return Buffer.from(r,"binary")}_createSocket(){var t;try{return t=new Socket({allowHalfOpen:!0,readable:!0,writable:!0}),t.on("close",(n)=>{n?this.emit("error",{message:"Closed due to transmission error",err:n}):this.close()}),t.on("connect",()=>{this.emit("connect"),this._connected=!0}),t.on("data",(n)=>{this.enableDebug&&this.emit("debug","Data received: "+n,1),this.receivedData(n)}),t.on("end",()=>{this.close()}),t.on("timeout",()=>{this.emit("error","Connection timed out.")}),t.on("error",(n)=>{this.emit("error",n)}),t}catch(n){this.emit("error",n)}return null}_destroySocket(){if(this.socket&&null!==this.socket){try{this.socket.removeAllListeners(),this.connected&&this.socket.end(),delete this.socket}catch(t){this.emit("error",t)}this.socket=null}}_fireReceiveOption(t,n,r){var u={telnet:this,option:t,verb:250,value:r,handled:!1};return this.emit("receivedOption",u),u.handled}_fireReceiveMSDP(t,n){var r={telnet:this,variable:t,value:n,handled:!1};return this.emit("receivedMSDP",r),r.handled}_fireReceiveGMCP(t){var n={telnet:this,value:t,handled:!1};return this.emit("receivedGMCP",n),n.handled}_formatByte(t){return 32>t||127<=t?"<"+t+">":_StringfromCharCode(t)}}exports.Telnet=Telnet;
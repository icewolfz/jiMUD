<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>Code editor</title>
    <link rel="shortcut icon" href="../assets/icons/win/code.ico" />
    <link href="../lib/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-select.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/form.css" rel="stylesheet" type="text/css" />
    <link href="css/cm.css" rel="stylesheet" type="text/css" />
    <link href="css/code.editor.css" rel="stylesheet" type="text/css" />
    <link href="css/propertygrid.css" rel="stylesheet" type="text/css" />
    <link href="css/datagrid.css" rel="stylesheet" type="text/css" />
    <link href="css/editorcontent.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript">
        // eslint-disable-next-line no-unused-vars
        /* global _loading, ipcRenderer, _ready, doUpdate, manager, inverse, capitalize, options, monaco, initEditor, shell, setViewState, findEditor, fs, openFile */
        // eslint-disable-next-line no-unused-vars
        var _ready = false;
        var _loading = 1;
        var manager;
        const { SetupEditor } = require('./js/editor/code.editor');
        const { ReplaceCommandThatPreservesSelection, setIncludePaths, formatCode } = require('./js/editor/monaco');

        function windowType() { return 'codeEditor'; }

        window.onerror = function (msg, url, line, col, error) {
            ipcRenderer.send('log-error', error, true);
            if (options && options.debug) {
                console.error('Message: ' + msg);
                console.error('Url: ' + url);
                console.error('Line: ' + line);
                console.error('Column: ' + col);
                console.error(error);
            }
            if (_loading && menubar)
                menubar.enabled = true;
            return true;
        };

        function initEditor(editor, diff) {
            if (diff) {
                editorOverrides(editor.getModifiedEditor());
                editorOverrides(editor.getOriginalEditor());
                editorAddActions(editor.getOriginalEditor());
                editorAddActions(editor.getModifiedEditor());
            }
            else {
                editorOverrides(editor);
                editorAddActions(editor);
            }

            if (editor.getEditorType() === 'vs.editor.ICodeEditor') {
                editor.onContextMenu((e) => {
                    let idx = window.$editors.indexOf(editor);
                    if (idx !== -1 && manager.activePane === manager.panes[idx])
                        manager.active.editor.emit('contextmenu', e, editor);
                });
                editor.onDidChangeCursorSelection(() => {
                    doUpdate(32);
                });
                editor.onDidChangeCursorPosition(() => {
                    doUpdate(64);
                });
                editor.onDidFocusEditorWidget(() => {
                    doUpdate(32);
                });
                editor.onDidChangeModelDecorations(() => {
                    if (manager.active && manager.active.editor)
                        setViewState(manager.active.editor, editor);
                });
                editor.onDidScrollChange(() => {
                    if (manager.active && manager.active.editor)
                        setViewState(manager.active.editor, editor);
                });
            }
            else {
                let m = monaco.editor.createModel('', 'lpc');
                editor.setModel({
                    original: m,
                    modified: m
                });
                editor.setModel(null);
                m.dispose();
                editor.getOriginalEditor().onContextMenu((e) => {
                    let idx = window.$dEditors.indexOf(editor);
                    if (manager.activePane === manager.panes[idx])
                        manager.active.editor.emit('contextmenu-diff', e, editor.getOriginalEditor());
                });
                editor.getOriginalEditor().onDidChangeCursorSelection(() => {
                    doUpdate(32);
                });
                editor.getOriginalEditor().onDidChangeCursorPosition(() => {
                    doUpdate(64);
                });
                editor.getOriginalEditor().onDidFocusEditorWidget(() => {
                    doUpdate(32);
                });
                editor.getModifiedEditor().onContextMenu((e) => {
                    let idx = window.$dEditors.indexOf(editor);
                    if (manager.activePane === manager.panes[idx])
                        manager.active.editor.emit('contextmenu', e, editor.getModifiedEditor());
                });
                editor.getModifiedEditor().onDidChangeCursorSelection(() => {
                    doUpdate(32);
                });
                editor.getModifiedEditor().onDidChangeCursorPosition(() => {
                    doUpdate(64);
                });
                editor.getModifiedEditor().onDidFocusEditorWidget(() => {
                    doUpdate(32);
                });
                editor.getModifiedEditor().onDidChangeModelDecorations(() => {

                });
            }

            if (options && options.editorOptions)
                editor.updateOptions(options.editorOptions);
        }

        function editorOverrides(editor) {
            var ld = editor.getContribution('editor.linkDetector');
            //have to search as newer monaco editors minify property names
            //find openerService to support custom url opening
            var found = Object.keys(ld).filter(i => ld[i] && ld[i].open);
            if (found.length)
                ld[found[0]].open = (url) => {
                    shell.openExternal(url.toString());
                };
            //find _codeEditorService to do custom code editor opening
            if (!editor._oldOpenCodeEditor) {
                found = Object.keys(editor).filter(i => editor[i] && editor[i].openCodeEditor);
                if (found.length) {
                    editor._oldOpenCodeEditor = editor[found[0]].openCodeEditor;
                    editor[found[0]].openCodeEditor = (input, source, sideBySide) => {
                        if (!input || !input.resource)
                            return editor._oldOpenCodeEditor(input, source, sideBySide);
                        openFile(input.resource.fsPath);
                        if (input.options) {
                            let idx = manager.panes.indexOf(manager.activePane);
                            if (idx !== -1) {
                                var ed;
                                if (window.$editors[idx].getContainerDomNode().style.display !== 'block')
                                    ed = window.$dEditors[idx];
                                else
                                    ed = window.$editors[idx];
                                ed.setPosition({ column: input.options.selection.startColumn, lineNumber: input.options.selection.startLineNumber });
                                ed.revealPositionInCenterIfOutsideViewport({ column: input.options.selection.startColumn, lineNumber: input.options.selection.startLineNumber });
                            }
                        }
                        return Promise.resolve();
                    };
                }
            }
            //find _standaloneKeybindingService to remove some keybindings to avoid internal vs external
            found = Object.keys(editor).filter(i => editor[i] && editor[i].addDynamicKeybinding);
            if (found.length) {
                editor[found[0]].addDynamicKeybinding(`-actions.findWithSelection`, 0, () => { });
                editor[found[0]].addDynamicKeybinding(`-actions.find`, 0, () => { });
                editor[found[0]].addDynamicKeybinding(`-editor.action.startFindReplaceAction`, 0, () => { });
            }
        }

        function editorAddActions(editor) {
            editor.addAction({
                id: 'jimud.action.transformToInverse',
                label: 'Transform to Inverse',
                run: function (editor) {
                    let selections = editor.getSelections();
                    let model = editor.getModel();
                    let commands = [];

                    for (let i = 0, len = selections.length; i < len; i++) {
                        let selection = selections[i];
                        if (selection.isEmpty()) {
                            let cursor = selection.getStartPosition();
                            let word = model.getWordAtPosition(cursor);
                            if (!word) {
                                continue;
                            }

                            let wordRange = new monaco.Range(cursor.lineNumber, word.startColumn, cursor.lineNumber, word.endColumn);
                            let text = model.getValueInRange(wordRange);
                            commands.push(new ReplaceCommandThatPreservesSelection(wordRange, inverse(text), new monaco.Selection(cursor.lineNumber, cursor.column, cursor.lineNumber, cursor.column)));

                        } else {
                            let text = model.getValueInRange(selection);
                            commands.push(new ReplaceCommandThatPreservesSelection(selection, inverse(text), selection));
                        }
                    }
                    editor.pushUndoStop();
                    editor.executeCommands(this.id, commands);
                    editor.pushUndoStop();
                }
            });

            editor.addAction({
                id: 'jimud.action.transformToCapitalize',
                label: 'Transform to Capitalize',
                run: function (editor) {
                    let selections = editor.getSelections();
                    let model = editor.getModel();
                    let commands = [];

                    for (let i = 0, len = selections.length; i < len; i++) {
                        let selection = selections[i];
                        if (selection.isEmpty()) {
                            let cursor = selection.getStartPosition();
                            let word = model.getWordAtPosition(cursor);
                            if (!word) {
                                continue;
                            }

                            let wordRange = new monaco.Range(cursor.lineNumber, word.startColumn, cursor.lineNumber, word.endColumn);
                            let text = model.getValueInRange(wordRange);
                            commands.push(new ReplaceCommandThatPreservesSelection(wordRange, capitalize(text), new monaco.Selection(cursor.lineNumber, cursor.column, cursor.lineNumber, cursor.column)));

                        } else {
                            let text = model.getValueInRange(selection);
                            commands.push(new ReplaceCommandThatPreservesSelection(selection, capitalize(text), selection));
                        }
                    }
                    editor.pushUndoStop();
                    editor.executeCommands(this.id, commands);
                    editor.pushUndoStop();
                }
            });

            editor.addAction({
                id: "jimud.addDictionary",
                label: 'Add to Dictionary',
                run: (editor) => {
                    let word = editor.getModel().getWordAtPosition(e.target.position);
                    if (!word || !word.word.length) return;
                    if (!isWordMisspelled(word, editor)) return;
                    //let words = word.word.split('_');
                    let words = word.word.split(/(_)|(?=[A-Z])|(\d+)/g);
                    ///_|(?=[A-Z])|(?<=[a-z])(?=\d)/g
                    let sCol = word.startColumn;
                    for (let w = 0, wl = words.length; w < wl; w++) {
                        if (!words[w]) continue;
                        if (sCol + words[w].length >= e.target.position.column) {
                            word = words[w];
                            break;
                        }
                        //sCol += words[w].length + 1;
                        sCol += words[w].length;
                    }
                    if (!options.dictionary)
                        options.dictionary = [];
                    options.dictionary.push(word.toLowerCase());
                    saveOptions();
                    var keys = Object.keys(_editors);
                    var k = keys.length;
                    while (k--) {
                        ((p) => {
                            if (_editors[p].editor.type === 1)
                                setTimeout(() => _editors[p].editor.spellcheckDocument(), 0);
                        })(keys[k]);
                    }
                }
            });
            editor.addAction({
                id: "jimud.addSystemDictionary",
                label: 'Add to System Dictionary',
                run: (editor) => {
                    let word = editor.getModel().getWordAtPosition(e.target.position);
                    if (!word || !word.word.length) return;
                    if (!isWordMisspelled(word, editor)) return;
                    //let words = word.word.split('_');
                    let words = word.word.split(/(_)|(?=[A-Z])|(\d+)/g);
                    ///_|(?=[A-Z])|(?<=[a-z])(?=\d)/g
                    let sCol = word.startColumn;
                    for (let w = 0, wl = words.length; w < wl; w++) {
                        if (!words[w]) continue;
                        if (sCol + words[w].length >= e.target.position.column) {
                            word = words[w];
                            break;
                        }
                        //sCol += words[w].length + 1;
                        sCol += words[w].length;
                    }
                    ipcRenderer.send('addWordToSpellCheckerDictionary', word.toLowerCase());
                    var keys = Object.keys(_editors);
                    var k = keys.length;
                    while (k--) {
                        ((p) => {
                            if (_editors[p].editor.type === 1)
                                setTimeout(() => _editors[p].editor.spellcheckDocument(), 0);
                        })(keys[k]);
                    }
                }
            });
            /*
            editor.addAction({
                id: "jimud.ignoreWord",
                label: ' Ignore word',
                run: (editor) => {
                    let word = editor.getModel().getWordAtPosition(e.target.position);
                    if (!word || !word.word.length) return;
                    if (!isWordMisspelled(word, editor)) return;
                    //let words = word.word.split('_');
                    let words = word.word.split(/(_)|(?=[A-Z])|(\d+)/g);
                    ///_|(?=[A-Z])|(?<=[a-z])(?=\d)/g
                    let sCol = word.startColumn;
                    for (let w = 0, wl = words.length; w < wl; w++) {
                        if (!words[w]) continue;
                        if (sCol + words[w].length >= e.target.position.column) {
                            word = words[w];
                            break;
                        }
                        //sCol += words[w].length + 1;
                        sCol += words[w].length;
                    }
                    //TODO make work have to lookup and find the jimud editor object that is inked to editor
                    //p.editor.addIgnoredWord(item.word);
                    //p.editor.spellcheckDocument();
                }
            });
            */
            editor.addAction({
                id: "jimud.ignoreWordAll",
                label: ' Ignore word',
                run: (editor) => {
                    let word = editor.getModel().getWordAtPosition(e.target.position);
                    if (!word || !word.word.length) return;
                    if (!isWordMisspelled(word, editor)) return;
                    //let words = word.word.split('_');
                    let words = word.word.split(/(_)|(?=[A-Z])|(\d+)/g);
                    ///_|(?=[A-Z])|(?<=[a-z])(?=\d)/g
                    let sCol = word.startColumn;
                    for (let w = 0, wl = words.length; w < wl; w++) {
                        if (!words[w]) continue;
                        if (sCol + words[w].length >= e.target.position.column) {
                            word = words[w];
                            break;
                        }
                        //sCol += words[w].length + 1;
                        sCol += words[w].length;
                    }
                    dictionaryIgnore.push(item.word.toLowerCase());
                    var keys = Object.keys(_editors);
                    var k = keys.length;
                    while (k--) {
                        ((p) => {
                            if (_editors[p].editor.type === 1)
                                setTimeout(() => _editors[p].editor.spellcheckDocument(), 0);
                        })(keys[k]);
                    }
                }
            });
            //if actions do not exist create custom replacements
            if (!editor.getAction('undo'))
                editor.addAction({
                    id: 'undo',
                    label: 'Undo',
                    run: () => {
                        editor?.focus()
                        if (!document.execCommand('undo')) {
                            editor.getModel()?.undo()
                        }
                    },
                });
            if (!editor.getAction('redo'))
                editor.addAction({
                    id: 'redo',
                    label: 'Redo',
                    run: () => {
                        editor?.focus()
                        if (!document.execCommand('redo')) {
                            editor.getModel()?.redo()
                        }
                    },
                });
            if (!editor.getAction('editor.action.clipboardCutAction'))
                editor.addAction({
                    id: 'editor.action.clipboardCutAction',
                    label: 'Cut',
                    run: () => {
                        editor?.focus()
                        document.execCommand('cut')
                    },
                });
            if (!editor.getAction('editor.action.clipboardCopyAction'))
                editor.addAction({
                    id: 'editor.action.clipboardCopyAction',
                    label: 'Copy',
                    run: () => {
                        editor?.focus()
                        document.execCommand('copy')
                    },
                });
            if (!editor.getAction('editor.action.clipboardPasteAction'))
                editor.addAction({
                    id: 'editor.action.clipboardPasteAction',
                    label: 'Paste',
                    run: () => {
                        doPaste();
                    },
                    keybindings: [
                        monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyV
                    ],                    
                });

        }

        function createCodeEditor(el) {
            var editor = monaco.editor.create(el, {
                language: 'lpc',
                autoIndent: true,
                rulers: [80],
                contextmenu: false,
                theme: (options ? (options.theme ? 'lpcThemeDark' : 'lpcTheme') : 'lpcTheme'),
                model: null,
            }, {
                /*
                codeEditorService: {
                        addCodeEditor: (editor) => {
                            console.log('addCodeEditor');
                        },
                        openCodeEditor: function (input, source, sideBySide) {
                            console.log('openCodeEditor');
                            // this actually sets the opened source
                            //actions.set({ opened: input.resource.path })
                            // this just returns the editor itself
                            //return Promise.resolve({ getControl: () => getEditor(e) })
                            return Promise.resolve({});
                        },
                        resolveEditor: function () {
                            return Promise.resolve({});
                        }
                    },
                    */
                textModelService: {
                    createModelReference: resource => {
                        var model = monaco.editor.getModel(resource);
                        var d = false;
                        if (!model) {
                            var e = findEditor(resource.fsPath);
                            if (e && e.editor && e.editor.model)
                                model = e.editor.model;
                            else {
                                model = monaco.editor.createModel(fs.readFileSync(resource.fsPath, 'utf8'), 'lpc');
                                d = true;
                            }
                        }
                        var model2 = {
                            load() {
                                return Promise.resolve(model);
                            },
                            // in my case, I have nothing to dispose as I just re-use existing resources
                            dispose() { if (d && !model.isDisposed()) model.dispose(); },
                            textEditorModel: model
                        };
                        return Promise.resolve({
                            object: model2,
                            dispose: () => { if (d && !model.isDisposed()) model.dispose(); }
                        });

                        /*
                        const simpleModel = resourceModel
                            ? new SimpleModel(resourceModel)
                            : null;

                        return window.monaco.Promise.as({
                            object: simpleModel,
                            dispose: () => { }
                        });
                        */
                    },
                    registerTextModelContentProvider: () => ({ dispose: () => { } })
                }
            });
            return editor;
        }

        function createDiffEditor(el) {
            var editor = monaco.editor.createDiffEditor(el, {
                language: 'lpc',
                autoIndent: true,
                rulers: [80],
                contextmenu: false,
                theme: (options ? (options.theme ? 'lpcThemeDark' : 'lpcTheme') : 'lpcTheme'),
                model: null
            });
            return editor;
        }

        SetupEditor().then(SetupEditorFinish);

        function SetupEditorFinish(monaco) {
            //var pane = document.getElementById('cm-tabpane');
            if (!manager || !manager.activePane || !manager.activePane.pane) {
                setTimeout(() => {
                    SetupEditorFinish(monaco);
                }, 500);
                return;
            }
            var pane = manager.activePane.pane;
            var el = document.createElement('div');
            el.classList.add('editor-container');
            pane.appendChild(el);
            window.$editors = [createCodeEditor(el)];
            initEditor(window.$editors[0]);
            el = document.createElement('div');
            el.classList.add('diff-container');
            pane.appendChild(el);
            window.$dEditors = [createDiffEditor(el)];
            initEditor(window.$dEditors[0], 1);
            monaco.editor.addCommand({
                id: "jimud.addDictionary",
                run: (...args) => {
                    if (args[1] === 0) {
                        if (!options.dictionary)
                            options.dictionary = [];
                        options.dictionary.push(args[2].toLowerCase());
                        saveOptions();
                        var keys = Object.keys(_editors);
                        var k = keys.length;
                        while (k--) {
                            ((p) => {
                                if (_editors[p].editor.type === 1)
                                    setTimeout(() => _editors[p].editor.spellcheckDocument(), 0);
                            })(keys[k]);
                        }
                    }
                    else if (args[1] === 1) {
                        ipcRenderer.send('addWordToSpellCheckerDictionary', args[2].toLowerCase());
                        var keys = Object.keys(_editors);
                        var k = keys.length;
                        while (k--) {
                            ((p) => {
                                if (_editors[p].editor.type === 1)
                                    setTimeout(() => _editors[p].editor.spellcheckDocument(), 1);
                            })(keys[k]);
                        }
                    }
                }
            });
            monaco.editor.addCommand({
                id: "jimud.ignoreWord",
                run: (...args) => {
                    if (args[1] === 0) {
                        if (manager.active && manager.active.editor) {
                            manager.active.editor.addIgnoredWord(args[2]);
                            manager.active.editor.spellcheckDocument();
                        }
                    }
                    else if (args[1] === 1) {
                        dictionaryIgnore.push(args[2].toLowerCase());
                        var keys = Object.keys(_editors);
                        var k = keys.length;
                        while (k--) {
                            ((p) => {
                                if (_editors[p].editor.type === 1)
                                    setTimeout(() => _editors[p].editor.spellcheckDocument(), 0);
                            })(keys[k]);
                        }
                    }
                }
            });
            monaco.editor.onDidChangeMarkers(buildProblems);
            _ready = true;
        }
    </script>
</head>

<body>
    <div id="splashScreenMask" class="splash-mask"></div>
    <div id="splashLayout" class="splash-layout">
        <div id="SplashScreen" class="splash-screen">
            <h1 id="splashTitle">jiMUD - Code editor</h1>
            <h3>
                <!--span class="fa fa-circle-o-notch fa-spin" title="Loading..."></span-->
                <span id="splashMessage">Loading...</span>
            </h3>
        </div>
    </div>
    <div id="toolbar" class="btn-toolbar" role="toolbar">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default btn-xs" title="New File" onclick="newFile()">
                <i class="fa fa-plus"></i>
            </button>
            <button id="btn-add-dropdown" type="button" class="btn btn-default btn-xs" title="New...">
                <span class="caret"></span>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-open" type="button" class="btn btn-default btn-xs" title="Open..." onclick="openFile()">
                <i class="fa fa-folder-open-o"></i>
            </button>
            <button id="btn-close" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Close" onclick="closeFile()">
                <i class="fa fa-window-close"></i>
            </button>
            <button id="btn-close-all" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Close All" onclick="closeAllFiles()">
                <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                    <i class="fa fa-window-close fa-stack-2x" style="font-size: 1em;margin-top: -2px;margin-left: 2px;"></i>
                    <i class="fa fa-window-close fa-stack-2x" style="font-size: 1em;margin-top: 2px;margin-left: -2px;"></i>
                </span>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-save" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Save" onclick="saveFile()">
                <i class="fa fa-save"></i>
            </button>
            <button id="btn-save-all" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Save All" onclick="saveAllFiles()">
                <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                    <i class="fa fa-save fa-stack-2x" style="font-size: 1em;margin-top: -2px;margin-left: 2px;"></i>
                    <i class="fa fa-save fa-stack-2x" style="font-size: 1em;margin-top: 2px;margin-left: -2px;"></i>
                </span>
            </button>
        </div>
        <div class="btn-group" role="group" id="btn-grp-remote">
            <button id="btn-open-remote" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Open Remote..." onclick="openRemote()">
                <i class="fa fa-cloud-download"></i>
            </button>
            <button id="btn-upload" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Upload" onclick="uploadFile()">
                <i class="fa fa-upload"></i>
            </button>
            <button id="btn-upload-as" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Upload as..." onclick="uploadFileAs()">
                <i class="fa fa-cloud-upload"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-undo" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Undo" onclick="doUndo()">
                <i class="fa fa-undo"></i>
            </button>
            <button id="btn-redo" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Redo" onclick="doRedo()">
                <i class="fa fa-repeat"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-cut" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Cut" onclick="doCut()">
                <i class="fa fa-cut"></i>
            </button>
            <button id="btn-copy" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Copy" onclick="doCopy()">
                <i class="fa fa-copy"></i>
            </button>
            <button id="btn-paste" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Paste" onclick="doPaste()">
                <i class="fa fa-paste"></i>
            </button>
            <button id="btn-editor" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Paste to advanced editor" onclick="doEditor()">
                <i class="fa fa-edit"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-find" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Find" onclick="doFind()">
                <i class="fa fa-search"></i>
            </button>
            <button id="btn-replace" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Replace" onclick="doReplace()">
                <i class="fa fa-exchange"></i>
            </button>
        </div>
        <button id="btn-refresh" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Refresh" onclick="doRefresh()">
            <i class="fa fa-refresh"></i>
        </button>
        <div id="btn-group-diff-nav" class="btn-group" role="group">
            <button id="btn-diff-nav-prev" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Previous change" onclick="gotoPrevChange()">
                <i class="fa fa-arrow-up"></i>
            </button>
            <button id="btn-diff-nav-next" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Next change" onclick="gotoNextChange()">
                <i class="fa fa-arrow-down"></i>
            </button>
        </div>
        <div id="editor-buttons"></div>
    </div>
    <div id="output" class="output">
        <div id="btm-drag-bar"></div>
        <div id="output-toolbar" class="btn-toolbar" role="toolbar">
            <a href="javascript:void(0)" title="Close panel" onclick="closeOutput()" class="close">
                <i class="fa fa-times"></i>
            </a>
            <a id="btn-clear-output" href="javascript:void(0)" title="Clear output" onclick="doClearOutput()" class="close">
                <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                    <i class="fa fa-align-justify fa-stack-2x" style="font-size: 1em"></i>
                    <i class="btn-clear fa fa-times fa-stack-1x" style="font-size: 0.6em;margin-top: 3px;margin-left: 5px;"></i>
                </span>
            </a>
            <a id="output-tab" class="output-tab active" href="javascript:void(0)" onclick="showOutput()">Output</a>
            <a id="problem-tab" class="output-tab" href="javascript:void(0)" onclick="showProblems()">Problems</a>
        </div>
        <div id="problem-display" class="problem-display" style="display: none"></div>
        <div id="output-display" class="output-display" contenteditable="true" readonly="readonly"></div>
    </div>
    <div id="statusbar" class="statusbar">
        <span id="statusbar-file" class="left"></span>
        <span id="statusbar-message" class="center"></span>
        <span id="statusbar-location" class="right"></span>
        <span id="statusbar-size" class="right"></span>
    </div>
    <dialog id="map-resize" class="resize-dialog" data-title="Resize map" style="width:280px;height:353px;padding:5px;" onclose="menubar.enabled = true;" oncancel="menubar.enabled = true;">
        <div class="dialog-header" style="font-weight: bold">
            <button type="button" class="close" data-dismiss="modal" onclick="document.getElementById('map-resize').close();">&times;</button>
            <div style="padding-top: 2px;">Resize map...</div>
        </div>
        <div class="dialog-body" style="padding-top:38px">
            <div class="form-group col-sm-4">
                <label class="control-label">
                    Width
                    <input type="number" id="map-resize-width" class="input-sm form-control" value="2" min="2" max="100" style="width: 100%" />
                </label>
            </div>
            <div class="form-group col-sm-4">
                <label class="control-label">
                    Height
                    <input type="number" id="map-resize-height" class="input-sm form-control" value="2" min="2" max="100" style="width: 100%" />
                </label>
            </div>
            <div class="form-group col-sm-4">
                <label class="control-label">
                    Depth
                    <input type="number" id="map-resize-depth" class="input-sm form-control" value="1" min="1" max="100" style="width: 100%" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%;">Horizontal anchor
                    <select id="map-resize-horizontal-anchor" class="form-control selectpicker" data-style="btn-default btn-sm" data-width="100%">
                        <option value='1'>Top</option>
                        <option value='0'>Center</option>
                        <option value='16'>Bottom</option>
                    </select>
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%;">Vertical anchor
                    <select id="map-resize-vertical-anchor" class="form-control selectpicker" data-style="btn-default btn-sm" data-width="100%">
                        <option value='2'>Left</option>
                        <option value='0'>Center</option>
                        <option value='8'>Right</option>
                    </select>
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%;">Depth anchor
                    <select id="map-resize-depth-anchor" class="form-control selectpicker dropup" data-dropup-auto="false" data-style="btn-default btn-sm" data-width="100%">
                        <option value='32'>Up</option>
                        <option value='0'>Center</option>
                        <option value='64'>Down</option>
                    </select>
                </label>
            </div>
        </div>
        <div class="dialog-footer">
            <button style="float: right" type="button" class="btn btn-default" onclick="document.getElementById('map-resize').close();">Cancel</button>
            <button style="float: right" type="button" class="btn btn-primary" onclick="resizeMap()">Ok</button>
        </div>
    </dialog>
    <dialog id="new-design" class="resize-dialog" data-title="Resize map" style="width:280px;height:158px;padding:5px;" onclose="menubar.enabled = true;" oncancel="menubar.enabled = true;">
        <div class="dialog-header" style="font-weight: bold">
            <button type="button" class="close" data-dismiss="modal" onclick="document.getElementById('new-design').close();">&times;</button>
            <div style="padding-top: 2px;">New area design...</div>
        </div>
        <div class="dialog-body" style="padding-top:38px">
            <div class="form-group col-sm-4">
                <label class="control-label">
                    Width
                    <input type="number" id="new-design-width" class="input-sm form-control" value="2" min="2" max="100" style="width: 100%" />
                </label>
            </div>
            <div class="form-group col-sm-4">
                <label class="control-label">
                    Height
                    <input type="number" id="new-design-height" class="input-sm form-control" value="2" min="2" max="100" style="width: 100%" />
                </label>
            </div>
            <div class="form-group col-sm-4">
                <label class="control-label">
                    Depth
                    <input type="number" id="new-design-depth" class="input-sm form-control" value="1" min="1" max="100" style="width: 100%" />
                </label>
            </div>
        </div>
        <div class="dialog-footer">
            <button style="float: right" type="button" class="btn btn-default" onclick="document.getElementById('new-design').close();">Cancel</button>
            <button style="float: right" type="button" class="btn btn-primary" onclick="createAreaDesign()">Ok</button>
        </div>
    </dialog>

    <dialog id="new-area" data-title="Create new area" style="width:400px;height:368px;padding:5px;" onclose="menubar.enabled = true;" oncancel="menubar.enabled = true;">
        <div class="dialog-header" style="font-weight: bold">
            <button type="button" class="close" data-dismiss="modal" onclick="document.getElementById('new-area').close();">&times;</button>
            <div style="padding-top: 2px;" id="new-area-title">Create new area...</div>
        </div>
        <div class="dialog-body" style="padding-top:40px">
            <div class="form-group">
                <label class="control-label" style="width:100%">
                    Save path
                    <div class="input-group">
                        <input type="text" id="new-area-path" style="width:100%" class="input-sm form-control" />
                        <span class="input-group-btn">
                            <button class="btn btn-default btn-sm" type="button" id="btn-new-area-path">
                                &hellip;
                            </button>
                        </span>
                    </div>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Local path where files will be generated</span>
                    <div class="form-error"></div>
                </label>
            </div>
            <div class="form-group">
                <label class="control-label" style="width: 100%">Remote path
                    <div class="input-group">
                        <input type="text" id="new-area-remote-path" style="width:100%" class="input-sm form-control" />
                        <span class="input-group-btn">
                            <button class="btn btn-default btn-sm" type="button" id="btn-new-area-remote-path" disabled="disabled">
                                &hellip;
                            </button>
                        </span>
                    </div>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Remote path for area, if blank will default to <span id="help-new-area-remote-path">/realms/{character}/{area name}</span></span>
                </label>
            </div>
            <div class="form-group">
                <label class="control-label" style="width:100%">
                    Name
                    <input class="form-control" style="width:100%" type="text" id="new-area-name" style="width:100%">
                    <span class="fa fa-remove form-control-feedback" aria-hidden="true"></span>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Area name, appended to local path, remote if remote blank</span>
                    <div class="form-error"></div>
                </label>
            </div>
        </div>
        <div class="dialog-footer">
            <button style="float: right" type="button" class="btn btn-default" onclick="document.getElementById('new-area').close();">Cancel</button>
            <button style="float: right" type="button" class="btn btn-primary" onclick="createArea()">Ok</button>
        </div>
    </dialog>

    <dialog id="new-virtual-area" data-title="Create new virtual area" style="width:400px;height:450px;padding:0px;" onclose="menubar.enabled = true;" oncancel="menubar.enabled = true;">
        <div class="dialog-header" style="font-weight: bold">
            <button type="button" class="close" data-dismiss="modal" onclick="document.getElementById('new-virtual-area').close();">&times;</button>
            <div style="padding-top: 2px;">Create new virtual area...</div>
        </div>
        <div class="dialog-body" style="padding-top:33px">
            <ul class="nav nav-tabs" role="tablist" style="background-color: #F5F5F5;box-shadow: inset 0 -1px 0 #fff;">
                <li role="presentation" class="active">
                    <a href="#general" aria-controls="general" role="tab" data-toggle="tab">General</a>
                </li>
                <li role="presentation">
                    <a href="#advanced" aria-controls="advanced" role="tab" data-toggle="tab">Advanced</a>
                </li>
            </ul>
            <div class="tab-content" style="overflow: auto;height: 324px;">
                <div role="tabpanel" class="container tab-pane fade in active" id="general" style="width: auto;">
                    <div class="form-group">
                        <label class="control-label" style="width:100%">
                            Save path
                            <div class="input-group">
                                <input type="text" id="new-virtual-area-path" style="width:100%" class="input-sm form-control" />
                                <span class="input-group-btn">
                                    <button class="btn btn-default btn-sm" type="button" id="btn-new-virtual-area-path">
                                        &hellip;
                                    </button>
                                </span>
                            </div>
                            <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Local path where files will be generated</span>
                            <div class="form-error"></div>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="control-label" style="width: 100%">Remote path
                            <div class="input-group">
                                <input type="text" id="new-virtual-area-remote-path" style="width:100%" class="input-sm form-control" />
                                <span class="input-group-btn">
                                    <button class="btn btn-default btn-sm" type="button" id="btn-new-virtual-area-remote-path" disabled="disabled">
                                        &hellip;
                                    </button>
                                </span>
                            </div>
                            <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Remote path for area, if blank will default to <span id="help-new-virtual-area-remote-path">/realms/{character}/{area name}</span></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="control-label" style="width:100%">
                            Area
                            <div class="input-group" style="width:100%">
                                <input type="text" id="new-virtual-area-area" disabled="disabled" class="input-sm form-control" style="width:100%" />
                                <div class="input-group-addon">
                                    <label>
                                        <input type="checkbox" id="new-virtual-area-area-enabled" onchange="$('#new-virtual-area-area').attr('disabled', !this.checked);" /> Create
                                    </label>
                                </div>
                            </div>
                            <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Area name, appended to local path, remote if remote blank</span>
                            <div class="form-error"></div>
                        </label>
                    </div>
                    <div class="col-sm-4 form-group">
                        <label class="control-label">
                            Width
                            <input type="number" id="new-virtual-area-width" class="input-sm form-control" value="2" min="2" max="100" style="width: 100%" />
                        </label>
                    </div>
                    <div class="col-sm-4 form-group">
                        <label class="control-label">
                            Height
                            <input type="number" id="new-virtual-area-height" class="input-sm form-control" value="2" min="2" max="100" style="width: 100%" />
                        </label>
                    </div>
                    <div class="col-sm-4 form-group">
                        <label class="control-label">
                            Depth
                            <input type="number" id="new-virtual-area-depth" class="input-sm form-control" value="1" min="1" max="100" style="width: 100%" />
                        </label>
                    </div>
                </div>
                <div role="tabpanel" class="container tab-pane fade" id="advanced" style="width: auto;overflow:auto">
                    <div class="col-sm-6 form-group">
                        <label class="control-label">
                            <input type="checkbox" id="new-virtual-area-coordinates" /> Coordinates
                        </label>
                    </div>
                    <div class="col-sm-6 form-group">
                        <label class="control-label">
                            Room cache
                            <input type="number" id="new-virtual-area-cache" class="input-sm form-control" value="200" min="1" max="500" style="width: 100%" />
                        </label>
                    </div>
                    <div class="col-sm-12 form-group">
                        <label class="control-label">Default Exits</label>
                        <div id="new-virtual-area-default-exits">
                            <div class="btn-group" data-toggle="buttons">
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="512" id="deUp" disabled="disabled">Up
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="256" id="deDown" disabled="disabled">Down
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="128" id="deNorth" checked="checked">North
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="64" id="deNorthEast">NorthEast
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="32" id="deEast" checked="checked">East
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="16" id="deSouthEast">SouthEast
                                </label>
                            </div>
                            <div class="btn-group" data-toggle="buttons">
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="8" id="deSouth" checked="checked">South
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="4" id="deSouthWest">SouthWest
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="2" id="deWest" checked="checked">West
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="1" id="deNorthWest">NorthWest
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="0" id="eNone">None
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12 form-group">
                        <label class="control-label">Default States</label>
                        <div id="new-virtual-area-default-states">
                            <div class="btn-group" data-toggle="buttons">
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="512" id="dsNoAttack">No attack
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="256" id="dsNoMagic">No magic
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="128" id="dsCouncil">Council
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="64" id="dsOutdoors">Outdoor
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="32" id="dsIndoors">Indoor
                                </label>
                            </div>
                            <div class="btn-group" data-toggle="buttons">
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="16" id="dsWater">Water
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="8" id="dsHot">Hot
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="4" id="dsCold">Cold
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="2" id="dsSinkingUp">Sinking Up
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="1" id="dsSinkingDown">Sinking Down
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="0" id="sNone" checked="checked">None
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="dialog-footer">
            <button style="float: right" type="button" class="btn btn-default" onclick="document.getElementById('new-virtual-area').close();">Cancel</button>
            <button style="float: right" type="button" class="btn btn-primary" onclick="createVirtualArea()">Ok</button>
        </div>
    </dialog>
    <dialog id="remoteBrowse" data-title="Open remote file" style="overflow: hidden;width: 500px; height: 350px; padding: 5px;">
        <div class="dialog-body panel panel-default" style="top: 0;bottom: 85px;left: 0px;right: 0px;padding: 0px;margin: 0px;position: absolute;border:0;border-radius: 0">
            <div class="panel-heading">
                <label class="control-label" for="remote-path">
                    <button class="close" data-dismiss="modal" onclick="$dialog.el.close()">×</button>
                    <div style="padding-top: 2px;" id="remoteBrowseTitle">Open remote file</div>
                </label>
                <span class="path-container">
                    <div class="input-group">
                        <input type="text" id="remote-path" class="form-control">
                        <span class="input-group-btn">
                            <button id="button-remote" class="btn btn-default" style="width: 17px;min-width:17px;border-radius:0;padding-left:4px;padding-right:4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul id="remote-navigate" style="max-height: 200px" class="dropdown-menu pull-right" aria-labelledby="button-remote" data-container="body"></ul>
                            <button id="btn-remote-up" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Go up a directory">
                                <span class="fa-stack" style="top: -5px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                                    <i class="fa fa-folder-o fa-stack-2x" style="font-size: 1.2em"></i>
                                    <i class="fa fa-caret-up fa-stack-1x" style="font-size: 1em;margin-top: 1px;"></i>
                                </span>
                            </button>
                        </span>
                    </div>
                </span>
            </div>
            <div id="remoteBrowseList" class="panel-body" style="padding:0px;top:61px;bottom:1px;left:1px;right:1px;position: absolute;">
            </div>
        </div>
        <div id="remoteBrowseFooter" class="dialog-footer" style="padding-top: 35px;">
            <div style="position: absolute;top: 5px;left: 5px;right: 160px;bottom: 50px;">
                <span class="input-group">
                    <label class="input-group-addon" for="remoteBrowseFile" style="padding: 0 5px" id="remoteBrowseFile-label">File name:</label>
                    <input type="text" id="remoteBrowseFile" style="width:100%" class="input-sm form-control">
                </span>
            </div>
            <div style="position: absolute;top: 5px;right: 5px;bottom: 50px; width:150px">
                <select id="remoteBrowseFilter" class="form-control selectpicker dropup" data-style="btn-default btn-sm" data-width="150px" style="position: absolute;right: 5px;width: 150px;top: 5px;height: 30px;"></select>
            </div>
            <button type="button" class="btn btn-default" data-dismiss="modal" style="float: right;" onclick="$dialog.el.close()">Cancel</button>
            <button type="button" disabled="disabled" class="btn btn-primary" data-dismiss="modal" style="float: right;" id="remoteBrowseOk">Open</button>
        </div>
    </dialog>
    <dialog id="progress-dialog" style="z-index:1000;text-align:center">
        <div id="progress-dialog-title">Retrieving&hellip;</div>
        <div>
            <progress max="100" id="progress-dialog-progressbar"></progress>
        </div>
        <div>
            <button id="progress-dialog-cancel">
                Cancel
            </button>
        </div>
    </dialog>
    <div style="display: none" id="wizard-pages">
        <div id="mon-wizard-welcome">
            <img src="../assets/icons/png/wizmonlogo.png" alt="Welcome to the monster wizard" style="float: left;padding-top: 84px;">
            <div style="padding-top:104px" id="mon-wizard-welcome-message">Welcome to the new monster wizard, this will take you through the steps to create a monster quickly and easily. You may finish at any time to generate a monster based on your current selections.</div>
        </div>
        <div id="mon-wizard-general">
            <div class="col-sm-6 form-group">
                <label class="control-label">Type
                    <select id="mon-wiz-type" class="form-control selectpicker" data-style="btn-default btn-sm" data-width="100%">
                        <optgroup label="Area" id="mon-wiz-area-types">
                            <option value='BASEMONSTER'>Base</option>
                        </optgroup>
                        <optgroup label="Standard">
                            <option value='STD_MONSTER'>Standard</option>
                            <option value='MONTYPE_ARMOR_REPAIR'>Armor Repair</option>
                            <option value='MONTYPE_BARKEEP'>Barkeep</option>
                            <option value='MONTYPE_CRAFTER'>Crafter</option>
                            <option value='MONTYPE_CLERIC_TRAINER'>Cleric Trainer</option>
                            <option value='MONTYPE_SUBCLASSER'>Command Trainer</option>
                            <option value='MONTYPE_HEALER'>Healer</option>
                            <option value='MONTYPE_JEWELER'>Jeweler</option>
                            <option value='MONTYPE_LOCKPICK_REPAIR'>Lock pick Repair</option>
                            <option value='MONTYPE_MAGE_TRAINER'>Mage Trainer</option>
                            <option value='MONTYPE_MON_EDIBLE'>Edible Monster</option>
                            <option value='MONTYPE_SAGE_NPC'>Sage</option>
                            <option value='MONTYPE_SKILL_TRAINER'>Skill Trainer</option>
                            <option value='MONTYPE_SMITH'>Smith</option>
                            <option value='MONTYPE_SUMMON_MOB'>Summon Monster</option>
                            <option value='MONTYPE_SHIPWRIGHT'>Shipwright</option>
                            <option value='MONTYPE_TATTOOIST'>Tattooist</option>
                            <option value='MONTYPE_CMD_TRAIN_NPC'>Trainer</option>
                            <option value='MONTYPE_VENDOR'>Vendor</option>
                            <option value='MONTYPE_WEAPON_REPAIR'>Weapon Repair</option>
                        </optgroup>
                    </select>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Level
                    <input type="number" id="mon-wiz-level" class="input-sm form-control" min="1" />
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Alignment
                    <div class="input-group edit-dropdown">
                        <input type="text" id="mon-wiz-alignment" class="input-sm form-control">
                        <span class="input-group-btn">
                            <button id="btn-mon-wiz-alignment" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul style="max-height: 200px;" class="dropdown-menu pull-right" aria-labelledby="btn-mon-wiz-alignment" data-container="body">
                                <li>
                                    <a href="#">demonic</a>
                                </li>
                                <li>
                                    <a href="#">evil</a>
                                </li>
                                <li>
                                    <a href="#">bad</a>
                                </li>
                                <li>
                                    <a href="#">malevolent</a>
                                </li>
                                <li>
                                    <a href="#">mean</a>
                                </li>
                                <li>
                                    <a href="#">neutral</a>
                                </li>
                                <li>
                                    <a href="#">nice</a>
                                </li>
                                <li>
                                    <a href="#">benevolent</a>
                                </li>
                                <li>
                                    <a href="#">good</a>
                                </li>
                                <li>
                                    <a href="#">righteous</a>
                                </li>
                                <li>
                                    <a href="#">saintly</a>
                                </li>
                            </ul>
                        </span>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Race
                    <div class="input-group edit-dropdown">
                        <input type="text" id="mon-wiz-race" class="input-sm form-control">
                        <span class="input-group-btn">
                            <button id="btn-mon-wiz-race" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul id="mon-wiz-race-list" style="max-height: 200px;" class="dropdown-menu pull-right" aria-labelledby="btn-mon-wiz-race" data-container="body">
                            </ul>
                        </span>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Class
                    <div class="input-group edit-dropdown">
                        <input type="text" id="mon-wiz-class" class="input-sm form-control">
                        <span class="input-group-btn">
                            <button id="btn-mon-wiz-class" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul style="max-height: 180px;" class="dropdown-menu pull-right" aria-labelledby="btn-mon-wiz-class" data-container="body">
                                <li>
                                    <a href="#" class="main">cleric</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">baeron</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">cleric</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">edorin</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">ianthe</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">makkairi</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">phaedrus</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">vndyrwynd</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">zaal</a>
                                </li>
                                <li>
                                    <a href="#" class="main">fighter</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">barbarian</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">centurion</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">knight</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">marksman</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">ranger</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">warrior</a>
                                </li>
                                <li>
                                    <a href="#" class="main">mage</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">conjuror</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">elementalist</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">necromancer</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">planeswalker</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">sorcerer</a>
                                </li>
                                <li>
                                    <a href="#" class="main">monk</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">feather clan</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">hoof clan</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">spirit clan</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">tail clan</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">talon clan</a>
                                </li>
                                <li>
                                    <a href="#" class="main">rogue</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">acrobat</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">assassin</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">bard</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">thief</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">thug</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">trickster</a>
                                </li>
                            </ul>
                        </span>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Language
                    <div class="input-group edit-dropdown">
                        <input type="text" id="mon-wiz-language" class="input-sm form-control" placeholder="Defaults based on race">
                        <span class="input-group-btn">
                            <button id="btn-mon-wiz-language" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul style="max-height: 180px;" class="dropdown-menu pull-right" aria-labelledby="btn-mon-wiz-language" data-container="body">
                                <li>
                                    <a href="#">eltherian</a>
                                </li>
                                <li>
                                    <a href="#">caninen</a>
                                </li>
                                <li>
                                    <a href="#">common</a>
                                </li>
                                <li>
                                    <a href="#">dintali</a>
                                </li>
                                <li>
                                    <a href="#">draconian</a>
                                </li>
                                <li>
                                    <a href="#">draconic</a>
                                </li>
                                <li>
                                    <a href="#">draconic</a>
                                </li>
                                <li>
                                    <a href="#">elcharean</a>
                                </li>
                                <li>
                                    <a href="#">eltherian</a>
                                </li>
                                <li>
                                    <a href="#">ersi</a>
                                </li>
                                <li>
                                    <a href="#">farsi</a>
                                </li>
                                <li>
                                    <a href="#">gobbledegook</a>
                                </li>
                                <li>
                                    <a href="#">jhlorim</a>
                                </li>
                                <li>
                                    <a href="#">loyavenku</a>
                                </li>
                                <li>
                                    <a href="#">malkierien</a>
                                </li>
                                <li>
                                    <a href="#">malkierien</a>
                                </li>
                                <li>
                                    <a href="#">naga</a>
                                </li>
                                <li>
                                    <a href="#">nibelungen</a>
                                </li>
                                <li>
                                    <a href="#">nymal</a>
                                </li>
                                <li>
                                    <a href="#">shangtai</a>
                                </li>
                                <li>
                                    <a href="#">tangetto</a>
                                </li>
                                <li>
                                    <a href="#">terrakarn</a>
                                </li>
                                <li>
                                    <a href="#">westernese</a>
                                </li>
                                <li>
                                    <a href="#">wulinaxin</a>
                                </li>
                                <li>
                                    <a href="#">yak</a>
                                </li>
                            </ul>
                        </span>
                    </div>
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-ridable" /> Ridable
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-flying" /> Flying
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-getable" /> Getable
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-undead" /> Undead
                </label>
            </div>
            <div class="col-sm-4 form-group" style="width: auto;">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-waterbreathing" /> Water breathing
                </label>
            </div>
            <div class="col-sm-4 form-group" style="width: auto;">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-requires-water" /> Requires water
                </label>
            </div>
            <div class="col-sm-4 form-group" style="width: auto;">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-no-bleed" /> No bleeding
                </label>
            </div>
        </div>
        <div id="mon-wizard-description">
            <div class="col-sm-12 form-group">
                <label class="control-label">Name
                    <input type="text" class="input-sm form-control" id="mon-wiz-name" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">Short
                    <input type="text" class="input-sm form-control" id="mon-wiz-short" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Nouns
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;display:inline">A comma delimited list of words</span>
                    <input type="text" class="input-sm form-control" id="mon-wiz-nouns" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Adjectives
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;display:inline">A comma delimited list of words</span>
                    <input type="text" class="input-sm form-control" id="mon-wiz-adjectives" />
                </label>
            </div>
        </div>
        <div id="mon-wizard-description-long">
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Long
                    <a href="#" onclick="openAdvancedEditor(document.getElementById('mon-wiz-long').value);document.getElementById('mon-wizard-description-long').focus();">
                        <i class="fa fa-edit"></i>
                    </a>
                    <textarea class="input-sm form-control" id="mon-wiz-long" style="width: 100%;height: 273px;"></textarea>
                </label>
            </div>
        </div>
        <div id="mon-wizard-physical">
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Mass
                    <input type="number" id="mon-wiz-mass" class="input-sm form-control" min="0" value="0" />
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">A mass of 0 will use default mass</span>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Height
                    <div class="input-group">
                        <input type="number" id="mon-wiz-height" class="input-sm form-control" min="1" value="1" />
                        <div class="input-group-addon">inches</div>
                    </div>
                </label>
            </div>
            <div class="col-sm-12" style="padding: 0px;">
                <div class="col-sm-6 form-group">
                    <label class="control-label">Eye color
                        <div class="input-group edit-dropdown">
                            <input type="text" id="mon-wiz-eye" class="input-sm form-control">
                            <span class="input-group-btn">
                                <button id="btn-mon-wiz-eye" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="caret" style="margin-left: -1px;"></span>
                                </button>
                                <ul id="mon-wiz-eye-list" style="max-height: 200px;" class="dropdown-menu pull-right" aria-labelledby="btn-mon-wiz-eye" data-container="body">
                                </ul>
                            </span>
                        </div>
                    </label>
                </div>
                <div class="col-sm-6 form-group">
                    <label class="control-label">Hair color
                        <div class="input-group edit-dropdown">
                            <input type="text" id="mon-wiz-hair" class="input-sm form-control">
                            <span class="input-group-btn">
                                <button id="btn-mon-wiz-hair" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="caret" style="margin-left: -1px;"></span>
                                </button>
                                <ul id="mon-wiz-hair-list" style="max-height: 200px;" class="dropdown-menu pull-right" aria-labelledby="btn-mon-wiz-hair" data-container="body">
                                </ul>
                            </span>
                        </div>
                    </label>
                </div>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Gender
                    <select id="mon-wiz-gender" class="form-control selectpicker" data-style="btn-default btn-sm" data-width="100%">
                        <option value='male'>male</option>
                        <option value='female'>female</option>
                        <option value='random'>random</option>
                        <option value=''>none</option>
                    </select>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Body type
                    <div class="input-group edit-dropdown">
                        <input type="text" id="mon-wiz-body" class="input-sm form-control">
                        <span class="input-group-btn">
                            <button id="btn-mon-wiz-body" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul id="mon-wiz-body-list" style="max-height: 160px;" class="dropdown-menu pull-right" aria-labelledby="btn-mon-wiz-body" data-container="body">
                            </ul>
                        </span>
                    </div>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Defaults based on race</span>
                </label>
            </div>
        </div>
        <div id="mon-wizard-ask" data-mode="advanced">
            <div class="col-sm-4 form-group" style="width: auto;">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-ask" /> Can be asked questions
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Ask no topic reply
                    <input type="text" class="input-sm form-control" id="mon-wiz-ask-no-topic" />
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Ask response type
                    <select id="mon-wiz-ask-response" class="form-control selectpicker" data-style="btn-default btn-sm" data-width="100%">
                        <option value='0'>Say</option>
                        <option value='1'>Tell</option>
                        <option value='2'>Speak</option>
                        <option value='3'>Whisper</option>
                        <option value='4'>Custom</option>
                    </select>
                </label>
            </div>
        </div>
        <div id="mon-wizard-advanced" data-mode="advanced">
            <div class="col-sm-12 form-group">
                <label class="control-label">No corpse
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;display:inline">"" disable, $N or $n name, empty default</span>
                    <input type="text" class="input-sm form-control" id="mon-wiz-no-corpse" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">No limbs
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;display:inline">"" disable, $N/$n name, $L/$l limb, empty default</span>
                    <input type="text" class="input-sm form-control" id="mon-wiz-no-limbs" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">Monster party
                    <input type="text" class="input-sm form-control" id="mon-wiz-party" />
                </label>
            </div>
        </div>
        <div id="mon-wizard-finish">
            <img src="../assets/icons/png/wizmonlogo.png" alt="Monster finish summary" style="float: left;padding-top: 84px;"> To finish your monster simply click finished
            <div id="mon-wiz-summary" readonly="readonly" class="form-control" style="overflow:auto;height:280px;width:355px;white-space:pre;float: right;"></div>
        </div>
        <div id="mon-wizard-combat">
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Attack commands
                    <textarea class="input-sm form-control" id="mon-wiz-attack-commands" style="width: 100%;height: 78px;"></textarea>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">A comma delimited list of commands, defaults based on class</span>
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Attack command chance
                    <div class="input-group">
                        <input type="number" id="mon-wiz-chance" class="input-sm form-control" min="0" max="101" />
                        <div class="input-group-addon">%</div>
                    </div>
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Attack initiators
                    <textarea class="input-sm form-control" id="mon-wiz-initiators" style="width: 100%;height: 78px;"></textarea>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">A comma delimited list of commands, defaults based on class</span>
                </label>
            </div>
        </div>
        <div id="mon-wizard-tracking" data-mode="advanced">
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-tracking" /> Enable attacker tracking
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-tracking-aggressively" /> Track aggressively only
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">Enter message
                    <input type="text" class="input-sm form-control" id="mon-wiz-tracking-message" />
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Enter message action
                    <div class="input-group edit-dropdown">
                        <input type="text" id="mon-wiz-tracking-type" class="input-sm form-control">
                        <span class="input-group-btn">
                            <button id="btn-mon-wiz-class" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul style="max-height: 200px;" class="dropdown-menu pull-right" aria-labelledby="btn-mon-wiz-class" data-container="body">
                                <li>
                                    <a href="#">say</a>
                                </li>
                                <li>
                                    <a href="#">yell</a>
                                </li>
                                <li>
                                    <a href="#">speak</a>
                                </li>
                                <li>
                                    <a href="#">emote</a>
                                </li>
                            </ul>
                        </span>
                    </div>
                </label>
            </div>
        </div>
        <div id="mon-wizard-aggressive" data-mode="advanced">
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Aggressive
                    <textarea class="input-sm form-control" id="mon-wiz-aggressive" style="width: 100%;height: 265px;"></textarea>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">See /doc/build/monster/haggle for details</span>
                </label>
            </div>
        </div>
        <div id="mon-wizard-movement" data-mode="advanced">
            <div class="col-sm-12 form-group">
                <label class="control-label">
                    Speed
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;display:inline;">0 means no movement</span>
                    <input type="number" id="mon-wiz-speed" class="input-sm form-control" min="0" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Patrol route
                    <textarea class="input-sm form-control" id="mon-wiz-patrol" style="width: 100%;height: 78px;"></textarea>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">A comma delimited list of directions, must be full direction names</span>
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">No walk rooms
                    <textarea class="input-sm form-control" id="mon-wiz-no-walk" style="width: 100%;height: 78px;"></textarea>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">A comma delimited list of room paths, must include file extensions</span>
                </label>
            </div>
        </div>
        <div id="mon-wizard-actions" data-mode="advanced">
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Actions
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;display:inline">A comma delimited list of commands to execute on repop</span>
                    <input type="text" class="input-sm form-control" id="mon-wiz-actions" />
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Auto drop
                    <div class="input-group">
                        <input type="number" id="mon-wiz-auto-drop" class="input-sm form-control" min="0" max="120" />
                        <div class="input-group-addon" style="border-left: 0;">secs</div>
                        <div class="input-group-addon">
                            <label>
                                <input type="checkbox" id="mon-wiz-auto-drop-enabled" /> Enable</label>
                        </div>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Open storage
                    <div class="input-group">
                        <input type="number" id="mon-wiz-storage" class="input-sm form-control" min="0" max="120" />
                        <div class="input-group-addon" style="border-left: 0;">secs</div>
                        <div class="input-group-addon">
                            <label>
                                <input type="checkbox" id="mon-wiz-storage-enabled" /> Enable</label>
                        </div>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Auto wield
                    <div class="input-group">
                        <input type="number" id="mon-wiz-auto-wield" class="input-sm form-control" min="0" max="120" />
                        <div class="input-group-addon" style="border-left: 0;">secs</div>
                        <div class="input-group-addon">
                            <label>
                                <input type="checkbox" id="mon-wiz-auto-wield-enabled" /> Enable</label>
                        </div>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Auto loot
                    <div class="input-group">
                        <input type="number" id="mon-wiz-auto-loot" class="input-sm form-control" min="0" max="120" />
                        <div class="input-group-addon" style="border-left: 0;">secs</div>
                        <div class="input-group-addon">
                            <label>
                                <input type="checkbox" id="mon-wiz-auto-loot-enabled" /> Enable</label>
                        </div>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Auto wear
                    <div class="input-group">
                        <input type="number" id="mon-wiz-auto-wear" class="input-sm form-control" min="0" max="120" />
                        <div class="input-group-addon" style="border-left: 0;">secs</div>
                        <div class="input-group-addon">
                            <label>
                                <input type="checkbox" id="mon-wiz-auto-wear-enabled" /> Enable</label>
                        </div>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Wimpy
                    <div class="input-group">
                        <input type="number" id="mon-wiz-wimpy" class="input-sm form-control" min="0" max="101" />
                        <div class="input-group-addon">%</div>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-auto-stand" /> Auto stand
                </label>
            </div>
        </div>
        <div id="mon-wizard-vendor" data-visible="false">
            <div class="col-sm-6 form-group">
                <label class="control-label">Vendor type
                    <div class="input-group edit-dropdown">
                        <input type="text" id="mon-wiz-typeData-vendor" class="input-sm form-control">
                        <span class="input-group-btn">
                            <button id="btn-mon-wiz-typeData-vendor" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul style="max-height: 180px;" class="dropdown-menu pull-right" aria-labelledby="btn-mon-wiz-typeData-vendor" data-container="body">
                                <li><a href="#" class="main">armour</a></li>
                                <li><a href="#" class="main">armor</a></li>
                                <li><a href="#" class="main">treasure</a></li>
                                <li><a href="#" class="main">weapons</a></li>
                                <li><a href="#" class="main">weapon</a></li>
                                <li><a href="#" class="main">fruit</a></li>
                                <li><a href="#" class="main">raw</a></li>
                                <li><a href="#" class="main">potion</a></li>
                                <li><a href="#" class="main">herb</a></li>
                                <li><a href="#" class="main">food</a></li>
                                <li><a href="#" class="main">drink</a></li>
                                <li><a href="#" class="main">ore</a></li>
                                <li><a href="#" class="main">material</a></li>
                                <li><a href="#" class="main">gem</a></li>
                                <li><a href="#" class="main">bait</a></li>
                            </ul>
                        </span>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-typeData-use_default_storage" /> Use default storage room
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-typeData-no_clean_storage" /> Do not clean storage
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">Storage room
                    <div class="input-group" style="width: 100%">
                        <input type="text" id="mon-wiz-typeData-storageroom" style="width:100%" class="input-sm form-control" />
                        <span class="input-group-btn">
                            <button class="btn btn-default btn-sm" type="button" id="btn-mon-wiz-typeData-storageroom">
                                &hellip;
                            </button>
                        </span>
                    </div>
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">List item(s) <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;display:inline">A comma delimited list of words</span>
                    <input type="text" id="mon-wiz-typeData-list_items" style="width:100%" class="input-sm form-control" />
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">List type
                    <div class="input-group edit-dropdown">
                        <input type="text" id="mon-wiz-typeData-list_type" class="input-sm form-control">
                        <span class="input-group-btn">
                            <button id="btn-mon-wiz-typeData-list_type" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul style="max-height: 180px;" class="dropdown-menu pull-right" aria-labelledby="btn-mon-wiz-typeData-list_type" data-container="body">
                                <li><a href="#" class="main">item</a></li>
                                <li><a href="#" class="main">armor</a></li>
                                <li><a href="#" class="main">weapon</a></li>
                                <li><a href="#" class="main">fruit</a></li>
                            </ul>
                        </span>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-typeData-display_list_item" checked="checked" data-default="true" /> Append display list long to room
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">List item long
                    <input type="text" id="mon-wiz-typeData-list_long" style="width:100%" class="input-sm form-control" disabled="disabled" />
                </label>
            </div>
        </div>
        <div id="mon-wizard-vendor-advanced" data-visible="false" data-mode="advanced">
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Max number of each item
                    <input type="number" id="mon-wiz-typeData-max_item" class="input-sm form-control" min="0" max="20" value="5" data-default="5" />
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Permanent percent
                    <input type="number" step="0.01" id="mon-wiz-typeData-permanent_percent" class="input-sm form-control" min="-2.0" value="2.0" value="0.05" data-default="0.05" />
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Permanent offset
                    <input type="number" id="mon-wiz-typeData-permanent_offset" class="input-sm form-control" min="0" value="100" value="5" data-default="5" />
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Currency type
                    <select id="mon-wiz-typeData-currency_type" class="form-control selectpicker" data-style="btn-default btn-sm" data-width="100%" data-default="">
                        <option value=''>None</option>
                        <option value='copper'>Copper</option>
                        <option value='silver'>Silver</option>
                        <option value='electrum'>Electrum</option>
                        <option value='gold'>Gold</option>
                        <option value='platinum'>Platinum</option>
                    </select>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-typeData-only_currency_type" /> Only except currency type
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-typeData-translate" /> Translate
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-typeData-translate_list" /> Translate list
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-typeData-translate_commands" /> Translate commands
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-typeData-enable_price_tracking" /> Enable price tracking
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Price tracking weight
                    <input type="number" step="0.1" id="mon-wiz-typeData-price_tracking_weight" class="input-sm form-control" min="-1000.0" value="1000.0" value="30.0" data-default="30.0" />
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Price tracking max
                    <input type="number" step="0.1" id="mon-wiz-typeData-price_tracking_max" class="input-sm form-control" min="-1000.0" value="1000.0" value="15.0" data-default="15.0" />
                </label>
            </div>
        </div>
        <div id="mon-wizard-barkeep" data-visible="false" data-mode="advanced">
            <div class="col-sm-12 form-group">
                <label class="control-label">Menu title
                    <input type="text" id="mon-wiz-typeData-menu_title" style="width:100%" class="input-sm form-control" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">Read item(s) <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;display:inline">A comma delimited list of words, defaults to menu</span>
                    <input type="text" id="mon-wiz-typeData-read_items" style="width:100%" class="input-sm form-control" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">No money message
                    <input type="text" id="mon-wiz-typeData-no_money_message" style="width:100%" class="input-sm form-control" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">Pre menu text
                    <input type="text" id="mon-wiz-typeData-premenu" style="width:100%" class="input-sm form-control" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">Post menu text
                    <input type="text" id="mon-wiz-typeData-postmenu" style="width:100%" class="input-sm form-control" />
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-typeData-refill" /> Can refill
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-typeData-buy_empty" /> Can buy empty bottles
                </label>
            </div>
        </div>
        <div id="room-wizard-welcome">
            <img src="../assets/icons/png/wizroomlogo.png" alt="Welcome to the room wizard" style="float: left;margin-top: 56px;height: 128px;width:128px;">
            <div style="padding-top:76px" id="room-wizard-welcome-message">Welcome to the new room wizard, this will take you through the steps to create a room quickly and easily. You may finish at any time to generate a room based on your current selections.</div>
        </div>
        <div id="room-wizard-finish">
            <img src="../assets/icons/png/wizroomlogo.png" alt="Room wizard summary" style="float: left;margin-top: 56px;height: 128px;width:128px;"> To finish your room simply click finished
            <div id="room-wiz-summary" readonly="readonly" class="form-control" style="overflow:auto;height:219px;width:355px;white-space:pre;float: right;"></div>
        </div>
        <div id="room-wizard-general">
            <div class="col-sm-6 form-group">
                <label class="control-label">Type
                    <select id="room-wiz-type" class="form-control selectpicker" data-style="btn-default btn-sm" data-width="100%">
                        <optgroup label="Area" id="room-wiz-area-types">
                            <option value="BASEROOM">Base</option>
                        </optgroup>
                        <optgroup label="Standard">
                            <option value="STD_ROOM" selected="selected">Standard</option>
                            <option value="ROOMTYPE_ADVANCE_ROOM">Advance room</option>
                            <option value="ROOMTYPE_BANK">Bank</option>
                            <option value="ROOMTYPE_CLASS_JOIN">Class join</option>
                            <option value="ROOMTYPE_CLIMB">Climb</option>
                            <option value="ROOMTYPE_DOCK">Dock</option>
                            <option value="ROOMTYPE_GUILD_HALL">Guild hall</option>
                            <option value="ROOMTYPE_INN">Inn</option>
                            <option value="ROOMTYPE_LIBRARY">Library</option>
                            <option value="ROOMTYPE_LOCKER">Locker</option>
                            <option value="ROOMTYPE_MODROOM">Mod room</option>
                            <option value="ROOMTYPE_PIER">Pier</option>
                            <option value="ROOMTYPE_SAGE">Sage</option>
                            <option value="ROOMTYPE_SINK_ROOM">Sink</option>
                            <option value="ROOMTYPE_SKY_ROOM">Sky</option>
                            <option value="ROOMTYPE_STABLE">Stable</option>
                            <option value="ROOMTYPE_TRAIN_ROOM">Train</option>
                            <option value="ROOMTYPE_VAULT">Vault</option>
                            <option value="ROOMTYPE_VENDOR_STORAGE">Vendor storage</option>
                        </optgroup>
                    </select>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Terrain
                    <div class="input-group edit-dropdown">
                        <input type="text" id="room-wiz-terrain" class="input-sm form-control">
                        <span class="input-group-btn">
                            <button id="btn-room-wiz-terrain" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul id="room-wiz-terrain-list" style="max-height: 200px;" class="dropdown-menu pull-right" aria-labelledby="btn-room-wiz-terrain" data-container="body">
                                <li>
                                    <a href="#">beach</a>
                                </li>
                                <li>
                                    <a href="#">bog</a>
                                </li>
                                <li>
                                    <a href="#">city</a>
                                </li>
                                <li>
                                    <a href="#">cliff</a>
                                </li>
                                <li>
                                    <a href="#">cobble</a>
                                </li>
                                <li>
                                    <a href="#">desert</a>
                                </li>
                                <li>
                                    <a href="#">dirt</a>
                                </li>
                                <li>
                                    <a href="#">dirtroad</a>
                                </li>
                                <li>
                                    <a href="#">farmland</a>
                                </li>
                                <li>
                                    <a href="#">forest</a>
                                </li>
                                <li>
                                    <a href="#">grass</a>
                                </li>
                                <li>
                                    <a href="#">grassland</a>
                                </li>
                                <li>
                                    <a href="#">highmountain</a>
                                </li>
                                <li>
                                    <a href="#">hills</a>
                                </li>
                                <li>
                                    <a href="#">icesheet</a>
                                </li>
                                <li>
                                    <a href="#">jungle</a>
                                </li>
                                <li>
                                    <a href="#">lake</a>
                                </li>
                                <li>
                                    <a href="#">mountain</a>
                                </li>
                                <li>
                                    <a href="#">ocean</a>
                                </li>
                                <li>
                                    <a href="#">pavedroad</a>
                                </li>
                                <li>
                                    <a href="#">plains</a>
                                </li>
                                <li>
                                    <a href="#">prairie</a>
                                </li>
                                <li>
                                    <a href="#">river</a>
                                </li>
                                <li>
                                    <a href="#">rockdesert</a>
                                </li>
                                <li>
                                    <a href="#">rocky</a>
                                </li>
                                <li>
                                    <a href="#">sand</a>
                                </li>
                                <li>
                                    <a href="#">sanddesert</a>
                                </li>
                                <li>
                                    <a href="#">savannah</a>
                                </li>
                                <li>
                                    <a href="#">stone</a>
                                </li>
                                <li>
                                    <a href="#">swamp</a>
                                </li>
                                <li>
                                    <a href="#">tundra</a>
                                </li>
                                <li>
                                    <a href="#">underwater</a>
                                </li>
                                <li>
                                    <a href="#">water</a>
                                </li>

                            </ul>
                        </span>
                    </div>
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">Short
                    <input type="text" class="input-sm form-control" id="room-wiz-short" />
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Light
                    <input type="number" id="room-wiz-light" class="input-sm form-control" min="-20" max="20" />
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Night light adjustment
                    <input type="number" id="room-wiz-night-adjust" class="input-sm form-control" min="-20" max="20" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">Prevent peer all directions
                    <input type="text" class="input-sm form-control" id="room-wiz-prevent-peer" />
                </label>
            </div>
        </div>
        <div id="room-wizard-description">
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Long
                    <a href="#" onclick="openAdvancedEditor(document.getElementById('room-wiz-long').value);document.getElementById('room-wiz-long').focus();">
                        <i class="fa fa-edit"></i>
                    </a>
                    <textarea class="input-sm form-control" id="room-wiz-long" style="width: 100%;height: 216px;"></textarea>
                </label>
            </div>
        </div>
        <div id="room-wizard-properties">
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-indoors" /> Indoors
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-no-magic" /> No magic
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-no-scry" /> No scry
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-no-teleport" /> No teleport
                </label>
            </div>
            <div class="col-sm-4 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-explored" /> Explored Marker
                </label>
            </div>
            <div class="col-sm-4 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-no-map" /> No map send
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-hide-exits" /> Hide exits
                </label>
            </div>
            <div class="col-sm-4 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-no-forage" /> No forage
                </label>
            </div>
            <div class="col-sm-4 form-group">
                <label class="control-label">
                    Forage
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;display:inline">-1 default</span>
                    <input type="number" id="room-wiz-forage" class="input-sm form-control" min="-1" />
                </label>
            </div>
            <div class="col-sm-4 form-group">
                <label class="control-label">
                    Max forage
                    <input type="number" id="room-wiz-max-forage" class="input-sm form-control" min="0" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">Secret exit
                    <input type="text" class="input-sm form-control" id="room-wiz-secret-exit" />
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;">String, function, or boolean to indicate there is a secret exit</span>
                </label>
            </div>
            <div class="col-sm-4 form-group">
                <label class="control-label">
                    Temperature
                    <input type="number" id="room-wiz-temperature" class="input-sm form-control" min="-1000" max="1000" />
                </label>
            </div>
            <div class="col-sm-4 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-no-mgive" /> No mgive
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-underwater" /> Underwater
                </label>
            </div>
        </div>
        <div id="room-wizard-combat-properties">
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-no-attack" /> No attack
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-council" /> Council
                </label>
            </div>
            <div class="col-sm-4 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-melee" /> Melee as ability
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-pk" /> Enable pk
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-no-dirt" /> No dirt
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Dirt type
                    <div class="input-group edit-dropdown">
                        <input type="text" id="room-wiz-dirt" class="input-sm form-control">
                        <span class="input-group-btn">
                            <button id="btn-room-wiz-dirt" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul id="room-wiz-dirt-list" style="max-height: 200px;" class="dropdown-menu pull-right" aria-labelledby="btn-room-wiz-dirt" data-container="body">
                                <li>
                                    <a href="#" data-value=''>none</a>
                                </li>
                                <li>
                                    <a href="#">dirt</a>
                                </li>
                                <li>
                                    <a href="#">mud</a>
                                </li>
                                <li>
                                    <a href="#">snow</a>
                                </li>
                                <li>
                                    <a href="#">sand</a>
                                </li>
                                <li>
                                    <a href="#">dust</a>
                                </li>
                                <li>
                                    <a href="#">sludge</a>
                                </li>
                            </ul>
                        </span>
                    </div>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;">Empty default based on terrain/weather</span>
                </label>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">
    if (typeof module === 'object') { window.module = module; module = undefined; }
</script>
<script src="../lib/jquery.min.js" type="text/javascript"></script>
<script src="../lib/bootstrap.min.js" type="text/javascript"></script>
<script src="../lib/bootstrap-select.min.js" type="text/javascript"></script>
<script type="text/javascript">
    if (window.module) module = window.module;
    /*global _ready:true*/
    const { shell, ipcRenderer, webFrame, clipboard } = require('electron');
    const remote = require('@electron/remote');
    const { DockManager } = require('./js/dockmanager');
    const { EditorType } = require('./js/value.editors');
    const { DataGrid } = require('./js/datagrid');
    const { createFunction, formatFunctionPointer, formatArgumentList, formatMapping, MonacoCodeEditor, VirtualEditor, AreaDesigner, Source, FileBrowseValueEditor, RoomExit, RoomStates, formatVariableValue, formatArray, MonsterTypeFlags, RoomTypeFlags, getMonsterTypeFlags, getRoomTypeFlags } = require('./js/editor/code.editor');
    const { EditorSettings } = require('./js/editor/code.editor.settings');
    const { language } = require('./js/editor/lpc');

    const { Menu, MenuItem } = remote;
    const { Menubar } = require('./js/menubar');
    const { Wizard, WizardPage, WizardDataGridPage } = require('./js/wizard');

    // eslint-disable-next-line no-unused-vars
    const { formatString, inverse, parseTemplate, capitalize, existsSync, isDirSync, walkSync, formatSize, updateEditDropdown, initEditDropdown, stripPinkfish, addSlashes } = require('./js/library');
    const { IEDError } = require('./js/types');

    const { IED } = require('./js/ied');

    const moment = require('moment');
    const chokidar = require('chokidar');
    const path = require('path');
    const fs = require('fs');
    const tmp = require('tmp');
    tmp.setGracefulCleanup();

    var _windowState = getWindowOptions();

    ipcRenderer.invoke('window', 'setEnabled', false);

    var krypto = null;
    var menubar;
    var options, _updating = 0;
    var dictionaryIgnore = [];
    var _opening = {};
    var _open;
    var newCounter = 1;
    let $closeWindow = false;
    var watcher;
    var _watched = {};
    var outputDragging = false;
    var output = $('#output');
    var outputDisplay = $('#output-display');
    var problemDisplay;
    var _editors = {};
    var _recent = [];
    var sbSize = document.getElementById('statusbar-size');
    var sbName = document.getElementById('statusbar-file');
    var sbLocation = document.getElementById('statusbar-location');
    var sbMessage = document.getElementById('statusbar-message');
    var connected = window.opener ? window.opener.client.connected : false;
    var _ied;
    var $dialog;
    var $dialogs = {};
    var $queue = [];
    var tmpOptions = { prefix: 'jiMUD-', dir: getTempDir(), postfix: '.tmp', tmpdir: parseTemplate('{data}') };
    var $id = 0;

    var $fileFilters = [
        { name: 'Supported files (*.c, *.h, *.map, *.design)', extensions: ['c', 'h', 'map', 'design'] },
        { name: 'Code files (*.c, *.h)', extensions: ['c', 'h'] },
        { name: 'Data files (*.o, *.cfg)', extensions: ['o', 'cfg'] },
        { name: 'Text files (*.txt)', extensions: ['txt'] },
        { name: 'Map files (*.map)', extensions: ['map'] },
        { name: 'Area design files (*.design)', extensions: ['design'] },
        { name: 'All files (*.*)', extensions: ['*'] },
    ];

    outputDisplay.on('keydown', () => {
        if (event.ctrlKey) {
            // allow Ctrl-A, Ctrl-(any arrow key) combinations
            return true;
        }
        // keycode: http://www.programming-magic.com/file/20080205232140/keycode_table.html
        if (33 <= event.keyCode && event.keyCode <= 40) {
            return true;
        }
        return false;
    });

    window.addEventListener('keydown', (event) => {
        if (event.ctrlKey && !event.metaKey && !event.altKey && !event.shiftKey && event.key === 'v')
            doPaste();
    });    

    outputDisplay.on('cut', (e) => {
        e.preventDefault();
        e.stopPropagation();
    });

    outputDisplay.on('paste', (e) => {
        e.preventDefault();
        e.stopPropagation();
    });

    var menuTemplates = loadTemplates(parseTemplate(path.join('{assets}', 'templates')), '', ['wizards']);
    var subMenus = {
        'edit': [
            {
                label: '&Undo',
                accelerator: 'CmdOrCtrl+Z',
                click: doUndo,
                enabled: false,
                id: 'undo'
            },
            {
                label: '&Redo',
                accelerator: 'CmdOrCtrl+Y',
                click: doRedo,
                enabled: false,
            },
            { type: 'separator' },
            {
                label: 'Cu&t',
                accelerator: 'CmdOrCtrl+X',
                click: doCut,
                enabled: false,
            },
            {
                label: '&Copy',
                accelerator: 'CmdOrCtrl+C',
                click: doCopy,
                enabled: false,
            },
            {
                label: '&Paste',
                accelerator: 'CmdOrCtrl+V',
                click: doPaste,
                enabled: false,
            },
            {
                label: 'Paste to Advanced Editor',
                accelerator: 'CmdOrCtrl+Shift+V',
                click: doEditor,
                enabled: false,
            },
            { type: 'separator' },
            {
                label: '&Select All',
                id: 'SelectAll',
                accelerator: 'CmdOrCtrl+A',
                enabled: false,
                click: () => {
                    if (manager.active && manager.active.editor)
                        manager.active.editor.selectAll();
                }
            },
            { type: 'separator' },
            {
                label: '&Find',
                accelerator: 'CmdOrCtrl+F',
                enabled: false,
                click: doFind
            },
            {
                label: '&Replace',
                accelerator: 'CmdOrCtrl+H',
                enabled: false,
                click: doReplace
            },
        ],
        'view': [
            {
                label: '&Refresh',
                accelerator: 'F5',
                enabled: false,
                click: doRefresh
            },
            { type: 'separator' },
            {
                label: '&Previous change',
                enabled: false,
                click: gotoPrevChange
            },
            {
                label: '&Next change',
                enabled: false,
                click: gotoNextChange
            },
            { type: 'separator' },
            {
                label: '&Output',
                accelerator: 'CmdOrCtrl+Shift+U',
                type: 'checkbox',
                checked: false,
                click: toggleOutput,
                enabled: true
            },
            {
                label: '&Problems',
                accelerator: 'CmdOrCtrl+Shift+M',
                type: 'checkbox',
                checked: false,
                click: toggleProblems,
                enabled: true
            },
            { type: 'separator' },
            {
                label: '&Toggle Developer Tools',
                click: () => {
                    window.toggleDevTools();
                },
                enabled: true
            },
            {
                type: 'separator'
            },
            {
                role: 'resetZoom',
                enabled: true
            },
            {
                role: 'zoomIn',
                enabled: true
            },
            {
                role: 'zoomOut',
                enabled: true
            },
        ]
    };
    var menuItems = [
        {
            label: '&File',
            id: 'file',
            submenu: [
                {
                    label: '&New',
                    submenu: [
                        {
                            label: '&File',
                            accelerator: 'CmdOrCtrl+N',
                            click: () => { newFile(); }
                        },
                        { type: 'separator' },
                        {
                            label: '&Area...',
                            //accelerator: "CmdOrCtrl+N",
                            click: () => { newArea(); }
                        },
                        {
                            label: '&Virtual area...',
                            //accelerator: "CmdOrCtrl+N",
                            click: newVirtualArea
                        },
                        {
                            label: 'Area &design...',
                            //accelerator: "CmdOrCtrl+N",
                            click: newAreaDesign
                        },
                        { type: 'separator' },
                        {
                            label: '&Room...',
                            //accelerator: "CmdOrCtrl+N",
                            click: () => roomWizard()
                        },
                        {
                            label: '&Monster...',
                            //accelerator: "CmdOrCtrl+N",
                            click: () => monsterWizard()
                        },
                        { type: 'separator' },
                        {
                            label: 'From &template',
                            submenu: menuTemplates
                        }
                    ]
                },
                /*
                {
                    label: '&New from template',
                    submenu: menuTemplates
                },
                */
                { type: 'separator' },
                {
                    label: '&Open...',
                    accelerator: 'CmdOrCtrl+O',
                    click: () => { openFile(); }
                },
                {
                    label: 'Op&en Remote...',
                    accelerator: 'CmdOrCtrl+Shift+O',
                    click: () => { openRemote(); },
                    enabled: false,
                    visible: window.opener ? true : false
                },
                {
                    label: 'Open &Recent',
                    submenu: [],
                },
                { type: 'separator' },
                {
                    label: '&Save',
                    accelerator: 'CmdOrCtrl+S',
                    click: () => { saveFile(); },
                    enabled: false
                },
                {
                    label: 'Save &As...',
                    accelerator: 'CmdOrCtrl+Shift+S',
                    click: () => { saveFileAs(); },
                    enabled: false,
                },
                {
                    label: 'Save A&ll',
                    accelerator: 'CmdOrCtrl+Alt+S',
                    click: () => { saveAllFiles(); },
                    enabled: false
                },
                { type: 'separator' },
                {
                    label: '&Upload',
                    accelerator: 'CmdOrCtrl+U',
                    click: () => { uploadFile(); },
                    enabled: false,
                    visible: window.opener ? true : false
                },
                {
                    label: 'Up&load As...',
                    accelerator: 'CmdOrCtrl+Alt+U',
                    click: () => { uploadFileAs(); },
                    enabled: false,
                    visible: window.opener ? true : false
                },
                {
                    type: 'separator',
                    visible: window.opener ? true : false
                },
                {
                    label: '&Preferences...',
                    accelerator: 'CmdOrCtrl+Comma',
                    click: () => { openWindow('prefs'); }
                },
                { type: 'separator' },
                {
                    label: '&Diff',
                    submenu: [
                        {
                            label: '&Clear',
                            click: () => {
                                var pane = manager.panes.indexOf(manager.activePane);
                                if (manager.active.editor.diff)
                                    manager.active.editor.deactivate(window.$dEditors[pane]);
                                manager.active.editor.diff = null;
                                if (manager.active.diffFile)
                                    stopWatchFile(manager.active.diffFile);
                                manager.active.diffFile = null;
                                window.$dEditors[pane].getModifiedEditor().getContainerDomNode().parentElement.parentElement.style.display = '';
                                toggleDiffNav(false);
                                window.$editors[pane].getContainerDomNode().style.display = 'block';
                                manager.active.editor.activate(window.$editors[pane]);
                                doUpdate(2);
                            },
                            enabled: false
                        },
                        {
                            label: '&Original',
                            click: () => {
                                var pane = manager.panes.indexOf(manager.activePane);
                                if (!manager.active.editor.diff)
                                    manager.active.editor.deactivate(window.$editors[pane]);
                                manager.active.editor.diff = manager.active.editor.read();
                                manager.active.diffFile = manager.active.editor.file;
                                watchFile(manager.active.diffFile);
                                window.$dEditors[pane].getModifiedEditor().getContainerDomNode().parentElement.parentElement.style.display = 'block';
                                toggleDiffNav(true);
                                window.$editors[pane].getContainerDomNode().style.display = '';
                                manager.active.editor.activate(window.$dEditors[pane]);
                                window.$dEditors[pane].updateOptions(window.$editors[pane].getRawOptions());
                                doUpdate(2);
                            },
                            enabled: false
                        },
                        {
                            label: window.opener ? '&Local...' : '&File...',
                            click: () => {
                                dialog.showOpenDialog({
                                    filters: $fileFilters,
                                    properties: ['openFile'],
                                    defaultPath: (manager.active && manager.active.editor) ? path.dirname(manager.active.editor.file) : (options.recent && options.recent.length ? path.dirname(options.recent[0].file) : '')
                                }).then(result => {
                                    if (result.filePaths === undefined || result.filePaths.length === 0) {
                                        return;
                                    }
                                    var pane = manager.panes.indexOf(manager.activePane);
                                    if (!manager.active.editor.diff)
                                        manager.active.editor.deactivate(window.$editors[pane]);
                                    if (manager.active.diffFile)
                                        stopWatchFile(manager.active.diffFile);
                                    manager.active.editor.diff = manager.active.editor.read(result.filePaths[0]);
                                    manager.active.diffFile = result.filePaths[0];
                                    watchFile(manager.active.diffFile);
                                    window.$dEditors[pane].getModifiedEditor().getContainerDomNode().parentElement.parentElement.style.display = 'block';
                                    toggleDiffNav(true);
                                    window.$editors[pane].getContainerDomNode().style.display = '';
                                    manager.active.editor.activate(window.$dEditors[pane]);
                                    window.$dEditors[pane].updateOptions(window.$editors[pane].getRawOptions());
                                    doUpdate(2);
                                });
                            },
                            enabled: false
                        },
                        {
                            label: '&Remote...',
                            click: () => {
                                showBrowseDialog({
                                    defaultFile: manager.active.editor.remote || (options.remote + "/" + path.basename(manager.active.editor.file)),
                                    properties: ['openFile'],
                                    filters: $fileFilters,
                                }, (files) => {
                                    if (!files || files.length === 0) return;
                                    var t = tmp.tmpNameSync(tmpOptions);
                                    _ied.downloadToFile(files[0], t, false, 'editor-download:diffRemote:' + (manager.active ? manager.active.id : 0), false);
                                    showProgressDialog({
                                        file: files[0],
                                        tag: 'editor-download:diffRemote:' + (manager.active ? manager.active.id : 0),
                                        title: 'Downloading&hellip;',
                                        tmp: t
                                    });
                                });
                            },
                            enabled: false,
                            visible: window.opener ? true : false
                        },

                    ]
                },
                { type: 'separator' },
                {
                    label: 'Re&vert',
                    click: () => { revertFile(); },
                    enabled: false
                },
                {
                    label: 'Rever&t All',
                    click: () => { revertAllFiles(); },
                    enabled: false
                },
                { type: 'separator' },
                {
                    label: '&Close',
                    click: () => { closeFile(); },
                    accelerator: 'CmdOrCtrl+F4',
                    enabled: false
                },
                {
                    label: 'C&lose All',
                    click: () => { closeAllFiles(); },
                    accelerator: 'CmdOrCtrl+Shift+F4',
                    enabled: false
                },
                { type: 'separator' },
                {
                    label: 'E&xit',
                    accelerator: 'CmdOrCtrl+Shift+W',
                    click: () => { window.close(); }
                }
            ]
        },
        {
            label: '&Edit',
            submenu: subMenus['edit']
        },
        {
            label: '&View',
            submenu: subMenus['view']
        },
        {
            label: '&Sessions',
            submenu: [
                {
                    label: '&Open Session...',
                    click: () => openSessionFile()
                },
                {
                    label: 'O&pen Recent Session',
                    submenu: [],
                },
                { type: 'separator' },
                {
                    label: '&Replace With Session...',
                    click: () => openSessionFile(true)
                },
                {
                    label: 'R&eplace With Recent Session',
                    submenu: [],
                },
                { type: 'separator' },
                {
                    label: 'Reload &Previous Session',
                    click: () => openSession(options.session)
                },
                {
                    label: 'Replace With Pre&vious Session',
                    click: () => openSession(options.session, true)
                },
                { type: 'separator' },
                {
                    label: '&Save Session',
                    click: () => saveSession()
                },
                {
                    label: 'Save Session &As...',
                    click: () => saveSessionAs()
                }
            ]
        },
        {
            label: '&Help',
            role: 'help',
            id: 'help',
            submenu: [
                {
                    label: '&jiMUD...',
                    click: () => {
                        openWindow('help');
                    }
                },
                {
                    label: '&jiMUD website...',
                    click: () => {
                        shell.openExternal('https://github.com/icewolfz/jiMUD/tree/master/docs', '_blank');
                    }
                },
                { type: 'separator' },
                {
                    label: '&Immortal tutorial website...',
                    click: () => {
                        shell.openExternal('http://www.shadowmud.com/tutorial', '_blank');
                    },
                    enabled: true
                },
                {
                    label: '&Code editor website...',
                    click: () => {
                        shell.openExternal('https://github.com/icewolfz/jiMUD/tree/master/docs/codeeditor.md', '_blank');
                    },
                    enabled: true
                },
                { type: 'separator' },
                {
                    label: 'Check for updates...',
                    click: () => {
                        ipcRenderer.send('check-for-updates');
                    },
                    enabled: true
                },
                { type: 'separator' },
                {
                    label: '&About...',
                    click: () => {
                        ipcRenderer.send('show-window', 'about');
                    },
                    enabled: true
                }
            ]
        }
    ];
    if (!window.opener)
        menuItems[0].submenu.splice(menuItems[0].submenu.findIndex(item => item.label === 'Up&load As...') + 1, 1);
    menubar = new Menubar(menuItems);
    menubar.enabled = false;
    manager = new DockManager();
    var dock = $('.dock-manager');
    var toolbar = $('#toolbar');
    manager.hideTabstrip = false;
    manager.on('add', (e) => {
        if (e.panel && e.panel.editor)
            e.panel.editor.resize();
    });
    manager.on('tab-strip-shown', () => {
        doUpdate(128);
    });
    manager.on('add-pane', (idx, pane) => {
        var el = document.createElement('div');
        el.classList.add('editor-container');
        pane.pane.appendChild(el);
        var editor = monaco.editor.create(el, {
            language: 'lpc',
            autoIndent: true,
            rulers: [80],
            contextmenu: false,
            theme: (options ? (options.theme ? 'lpcThemeDark' : 'lpcTheme') : 'lpcTheme'),
            model: null
        });
        initEditor(editor);
        window.$editors.splice(idx, 0, editor);
        el = document.createElement('div');
        el.classList.add('diff-container');
        pane.pane.appendChild(el);
        editor = monaco.editor.createDiffEditor(el, {
            language: 'lpc',
            autoIndent: true,
            rulers: [80],
            contextmenu: false,
            theme: (options ? (options.theme ? 'lpcThemeDark' : 'lpcTheme') : 'lpcTheme'),
            model: null
        });
        initEditor(editor, 1);
        window.$dEditors.splice(idx, 0, editor);
        doUpdate(128);
    });
    manager.on('destroy-pane', (idx) => {
        window.$editors[idx].dispose();
        window.$editors.splice(idx, 1);
        window.$dEditors[idx].dispose();
        window.$dEditors.splice(idx, 1);
        if (idx === 0)
            window.$editor = window.$editors[0];
        doUpdate(128);
    });
    manager.on('tab-moved', (e) => {
        if (e.panel && e.panel.editor)
            e.panel.editor.focus();
    });
    manager.on('remove', (e) => {
        if (document.activeElement)
            document.activeElement.blur();
        if (e.panel.editor.changed || e.panel.editor.new) {
            e.cancel = !confirmSave(e.panel);
        }
    });
    manager.on('removed', (e, pane) => {
        closeEditor(e.panel);
        if (manager.panes[pane].panels.length === 0) {
            window.$dEditors[pane].getModifiedEditor().getContainerDomNode().parentElement.parentElement.style.display = '';
            window.$editors[pane].getContainerDomNode().style.display = '';
            toggleDiffNav(false);
        }
        doUpdate(5);
    });
    manager.on('dock-changed', (e, pane, oPane) => {
        if (manager.panes[oPane].panels.length === 0) {
            window.$editors[oPane].getContainerDomNode().style.display = '';
            window.$dEditors[pane].getModifiedEditor().getContainerDomNode().parentElement.parentElement.style.display = '';
            toggleDiffNav(false);
        }
        doUpdate(129);
    });
    manager.on('resize', () => {
        if (!window.$editors) return;
        var ed = window.$editors.length;
        while (ed--) {
            window.$editors[ed].layout();
            window.$dEditors[ed].layout();
        }
    });
    manager.on('activated', (e, pane) => {
        if (e.panel.editor) {
            if (e.panel.editor.type === 1) {
                if (e.panel.editor.diff) {
                    window.$dEditors[pane].getModifiedEditor().getContainerDomNode().parentElement.parentElement.style.display = 'block';
                    window.$editors[pane].getContainerDomNode().style.display = '';
                    e.panel.editor.activate(window.$dEditors[pane]);
                    toggleDiffNav(true);
                }
                else {
                    window.$editors[pane].getContainerDomNode().style.display = 'block';
                    window.$dEditors[pane].getModifiedEditor().getContainerDomNode().parentElement.parentElement.style.display = '';
                    var state;
                    if (!e.panel.restored) {
                        state = getViewState(e.panel.editor.file);
                        e.panel.restored = true;
                    }
                    e.panel.editor.activate(window.$editors[pane], state);
                    toggleDiffNav(false);
                }
            }
            else {
                window.$editors[pane].getContainerDomNode().style.display = '';
                window.$dEditors[pane].getModifiedEditor().getContainerDomNode().parentElement.parentElement.style.display = '';
                e.panel.editor.activate();
                toggleDiffNav(false);
            }
            setTimeout(() => { e.panel.editor.focus(); }, 50);
        }
        else {
            window.$editors[pane].getContainerDomNode().style.display = '';
            window.$dEditors[pane].getModifiedEditor().getContainerDomNode().parentElement.parentElement.style.display = '';
            toggleDiffNav(false);
        }
        doUpdate(1);
    });
    manager.on('pane-activated', () => {
        doUpdate(1);
    });
    manager.on('deactivated', (e, pane) => {
        if (_loading) return;
        if (e.panel.editor.type === 1) {
            if (e.panel.editor.diff)
                e.panel.editor.deactivate(window.$dEditors[pane]);
            else {
                //setViewState(e.panel.editor.file, window.$editors[pane].saveViewState());
                e.panel.editor.deactivate(window.$editors[pane]);
            }
            toggleDiffNav(false);
        }
        else
            e.panel.editor.deactivate();
    });
    manager.on('dragenter', (e) => {
        event.dataTransfer.dropEffect = 'copy';
        event.dataTransfer.effectAllowed = 'copy';
        if (e.dataTransfer.items) {
            for (var i = 0; i < e.dataTransfer.items.length; i++) {
                // If dropped items aren't files, reject them
                if (e.dataTransfer.items[i].kind === 'file') {
                    event.dataTransfer.dropEffect = 'link';
                    event.dataTransfer.effectAllowed = 'link';
                    event.preventDefault();
                    event.cancelBubble = true;
                    event.stopPropagation();
                    return false;
                }
            }
        }
        else if (e.dataTransfer.files && e.dataTransfer.files.length) {
            event.dataTransfer.dropEffect = 'link';
            event.dataTransfer.effectAllowed = 'link';
            event.preventDefault();
            event.cancelBubble = true;
            event.stopPropagation();
            return false;
        }
    });
    manager.on('dragover', (e) => {
        event.dataTransfer.dropEffect = 'copy';
        event.dataTransfer.effectAllowed = 'copy';
        if (e.dataTransfer.items) {
            for (var i = 0; i < e.dataTransfer.items.length; i++) {
                // If dropped items aren't files, reject them
                if (e.dataTransfer.items[i].kind === 'file') {
                    event.dataTransfer.dropEffect = 'link';
                    event.dataTransfer.effectAllowed = 'link';
                    event.preventDefault();
                    event.cancelBubble = true;
                    event.stopPropagation();
                    return false;
                }
            }
        }
        else if (e.dataTransfer.files && e.dataTransfer.files.length) {
            event.dataTransfer.dropEffect = 'link';
            event.dataTransfer.effectAllowed = 'link';
            event.preventDefault();
            event.cancelBubble = true;
            event.stopPropagation();
            return false;
        }
    });
    manager.on('drop', (e) => {
        var files = [];
        var f, fl;
        if (e.dataTransfer.items) {
            for (var i = 0; i < e.dataTransfer.items.length; i++) {
                // If dropped items aren't files, reject them
                if (e.dataTransfer.items[i].kind === 'file')
                    files.push(e.dataTransfer.items[i].getAsFile());
            }
        }
        else if (e.dataTransfer.files && e.dataTransfer.files.length) {
            for (f = 0, fl = e.dataTransfer.files.length; f < fl; f++)
                files.push(e.dataTransfer.files[f]);
        }
        if (files.length) {
            files = files.filter(f => !f.path.startsWith('/jiMUDPath:') && !f.path.startsWith('jiMUDPath://') && !isDirSync(f.path));
            if (files.length === 0) {
                event.preventDefault();
                event.cancelBubble = true;
                event.stopPropagation();
                return;
            }
            files = files.map(f => {
                if (f.path.startsWith('jiMUD://')) {
                    return {
                        remote: f.path.substring(8),
                        remoteEdit: true
                    };
                }
                else if (f.path.startsWith('/jiMUD:')) {
                    return {
                        remote: f.path.substring(7),
                        remoteEdit: true
                    };
                }
                else
                    return { file: f.path };
            });
            event.preventDefault();
            event.cancelBubble = true;
            event.stopPropagation();
            openFiles(files);
        }
        //else
        //manager.active.editor.focus();
    });
    manager.on('tab-contextmenu', (e) => {
        var temp = [];
        if (e.panel.editor.supports('refresh')) {
            temp.push({
                label: 'Refresh',
                click: () => {
                    e.panel.editor.refresh();
                    e.panel.editor.focus();
                },
                accelerator: 'F5'
            });
        }
        if (temp.length)
            temp.push({ type: 'separator' });
        temp.push({
            label: '&Copy path',
            click: () => {
                clipboard.writeText(e.panel.editor.file || '');
                clipboard.writeText(e.panel.editor.file || '', 'selection');
            }
        });
        if (e.panel.editor.remote && e.panel.editor.remote.length > 0)
            temp.push({
                label: '&Copy remote path',
                click: () => {
                    clipboard.writeText(e.panel.editor.remote || '');
                    clipboard.writeText(e.panel.editor.remote || '', 'selection');
                }
            });
        temp.push({ type: 'separator' });
        if (e.panel.editor.changed) {
            temp.push({
                label: '&Save',
                accelerator: 'CmdOrCtrl+S',
                click: () => { saveFile(e.panel); }
            });
        }
        temp.push({
            label: 'Save &As',
            accelerator: 'CmdOrCtrl+Shift+S',
            click: () => { saveFileAs(e.panel); },
        });
        if (e.panel.editor.changed) {
            if (temp.length)
                temp.push({ type: 'separator' });
            temp.push({
                label: 'Revert',
                click: () => { revertFile(e.panel); }
            });
        }
        if (e.panel.editor.supports('menu|tab-context')) {
            temp.push({ type: 'separator' });
            temp = temp.concat(e.panel.editor.menu('tab-context', connected));
        }
        if (temp.length)
            temp.push({ type: 'separator' });
        temp.push({
            label: '&Close',
            click: () => { closeFile(e.panel); },
            accelerator: 'CmdOrCtrl+F4'
        });
        if (manager.panels.length > 1)
            temp.push({
                label: '&Close Others',
                click: () => { manager.removeAllPanels(e.panel); }
            });
        if (manager.panels.length - 1 > manager.getPanelIndex(e.panel))
            temp.push({
                label: '&Close to the Right',
                click: () => { manager.removeAllPanelsAfter(e.panel); }
            });
        let tabMenu = Menu.buildFromTemplate(temp);
        tabMenu.popup({ window: remote.getCurrentWindow() });
    });

    //#region Id functions
    function setId(id) {
        _id = id;
    }

    function getId() {
        if (window.opener)
            return window.opener.getId();
        if (!_id)
            _id = ipcRenderer.sendSync('get-window-id') || 0;
        return _id;
    }
    //#endregion

    const _windows = {};

    function setTitle(title, lag) {
        if (title && title.length > 0)
            title = ' - ' + title;
        else
            title = '';
        if (manager.active && manager.active.editor)
            document.title = 'Code editor - ' + manager.active.tab.innerText + title + (window.opener ? window.opener.childWindowTitle(true) : '');
        else
            document.title = 'Code editor' + title + (window.opener ? window.opener.childWindowTitle(true) : '');
    }

    function updateCharacter(e) {
        if (!window.opener) return;
        setTitle(window.opener.getCharacterName());
    }


    function openAdvancedEditor(text, callBack) {
        if (_windows['editor.html'] && !_windows['editor.html'].closed) {
            _windows['editor.html'].callBack = callBack;
            _windows['editor.html'].show();
            _windows['editor.html'].focus();
            _windows['editor.html'].insertFormatted(text);
        }
        /*
        else if (window.opener && window.opener.client) {
            if (!window.opener._windows['editor.html']) {
                window.opener.openWindow('editor').then(() => {
                    window.opener._windows['editor.html'].show();
                    window.opener._windows['editor.html'].focus();
                    window.opener._windows['editor.html'].insertFormatted(text);
                });
            }
            else {
                window.opener._windows['editor.html'].show();
                window.opener._windows['editor.html'].focus();
                window.opener._windows['editor.html'].insertFormatted(text);
            }
        }
        */
        else {
            openWindow('editor');
            _windows['editor.html'].callBack = callBack;
            _windows['editor.html'].addEventListener('editor-init', () => {
                _windows['editor.html'].show();
                _windows['editor.html'].focus();
                _windows['editor.html'].insertFormatted(text);
            }, { once: true });
        }
        return _windows['editor.html'];
    }

    function updatePanel(panel) {
        panel.tab.classList.remove('new');
        panel.tab.classList.remove('changed');
        if (panel.editor.new)
            panel.tab.classList.add('new');
        else if (panel.editor.changed)
            panel.tab.classList.add('changed');
    }

    function updateUI() {
        var enabled = (manager.active && manager.active.editor) ? true : false;
        if (enabled)
            document.title = 'Code editor - ' + manager.active.tab.innerText + (window.opener ? window.opener.childWindowTitle() : '');
        else
            document.title = 'Code editor' + (window.opener ? window.opener.childWindowTitle() : '');
        $('#btn-close').prop('disabled', !enabled);
        $('#btn-close-all').prop('disabled', !enabled);
        menubar.updateItem('File|Close', { enabled: enabled });
        menubar.updateItem('File|Close all', { enabled: enabled });
        menubar.updateItem('File|save as...', { enabled: enabled });
        if (window.opener) {
            menubar.updateItem('file|diff|local...', { enabled: enabled && manager.active.editor.supports('diff') });
            menubar.updateItem('file|diff|remote...', { enabled: connected && enabled && manager.active.editor.supports('diff') });
            menubar.updateItem('file|upload', { enabled: connected && enabled && manager.active.editor.supports('upload') });
            menubar.updateItem('file|upload as...', { enabled: connected && enabled && manager.active.editor.supports('upload-as') });
            $('#btn-upload').prop('disabled', !(connected && enabled && manager.active.editor.supports('upload')));
            $('#btn-upload-as').prop('disabled', !(connected && enabled && manager.active.editor.supports('upload-as')));
        }
        else {
            menubar.updateItem('file|diff|file...', { enabled: enabled && manager.active.editor.supports('diff') });
        }
        var buttons = document.getElementById('editor-buttons');
        while (buttons.firstChild) {
            buttons.removeChild(buttons.firstChild);
        }
        if (enabled && manager.active.editor.supports('buttons'))
            buttons.append(...manager.active.editor.buttons);
        updateMenu('edit', 12);
        updateMenu('view', 9);
        sbSize.textContent = enabled ? (`Length: ${manager.active.editor.length.toLocaleString()}, Lines ${manager.active.editor.lineCount.toLocaleString()}`) : '';
        sbMessage.textContent = '';
        sbName.textContent = enabled ? (manager.active.editor.source === Source.local ? manager.active.editor.file : manager.active.editor.remote) : '';
        sbName.title = enabled ? (manager.active.editor.source === Source.local ? manager.active.editor.file : manager.active.editor.remote) : '';
        if (enabled && manager.active.editor.type === 1) {
            var l = manager.active.editor.location;
            sbLocation.textContent = enabled ? (`Ln ${l[1]}, Col ${l[0]}`) : 'Ln 0, Col 0';
        }
        else
            sbLocation.textContent = '';
        if (enabled && manager.active && manager.active.editor && manager.active.editor.updateUI) manager.active.editor.updateUI();
        var tbh = toolbar.outerHeight();
        dock.css('top', tbh + 'px');
        if (window.opener)
            $('.connected').prop('disabled', !(connected && enabled));
        if (manager.active && manager.active.editor)
            manager.active.editor.update('menu', menubar, connected);
        doUpdate(2);
    }

    function updateMenu(menu, length) {
        //filter out any dynamic items
        subMenus[menu] = subMenus[menu].filter(i => !i.after && !i.before && !i.beforeGroupContaining && !i.afterGroupContaining);
        var items = subMenus[menu].slice(0, length);
        if (manager.active && manager.active.editor && manager.active.editor.supports('menu|' + menu)) {
            var cItems = manager.active.editor.menu(menu);
            if (cItems && cItems.length) {
                items.push({ type: 'separator' });
                items = items.concat(cItems);
            }
        }
        menubar.updateItem(menu, { submenu: items });
    }

    function updateUIChange() {
        var changed = (manager.active && manager.active.editor) ? (manager.active.editor.changed || manager.active.editor.new) : false;
        var changedAll = false;
        var revertAll = false;
        var keys = Object.keys(_editors);
        var k = keys.length;
        var p;
        while (k--) {
            //no editor or of not changed and new try next
            p = keys[k];
            if (!_editors[p] || (!_editors[p].editor.changed && !_editors[p].editor.new))
                continue;
            changedAll = true;
            if (_editors[p].editor.changed)
                revertAll = true;
            if (revertAll && changedAll)
                break; //do not need to check all as soon as one has been found
        }
        $('#btn-save').prop('disabled', !changed);
        menubar.updateItem('file|save', { enabled: changed });
        $('#btn-save-all').prop('disabled', !changedAll);
        menubar.updateItem('file|save all', { enabled: changedAll });
        menubar.updateItem('file|diff|clear', { enabled: (manager.active && manager.active.editor) ? (manager.active.editor.diff !== null && manager.active.editor.supports('diff')) : false });
        menubar.updateItem('file|diff|original', { enabled: (manager.active && manager.active.editor) ? (manager.active.editor.diff === null && !manager.active.editor.new && manager.active.editor.changed && manager.active.editor.supports('diff')) : false });

        menubar.updateItem('file|revert', { enabled: (manager.active && manager.active.editor) ? (manager.active.editor.changed) : false });
        menubar.updateItem('file|revert all', { enabled: revertAll });

        $('#btn-undo').prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('undo') : true);
        menubar.updateItem('edit|undo', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('undo') : false });
        $('#btn-redo').prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('redo') : true);
        menubar.updateItem('edit|redo', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('redo') : false });

        $('#btn-cut').prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('cut') : true);
        menubar.updateItem('edit|cut', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('cut') : false });
        $('#btn-copy').prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('copy') : true);
        menubar.updateItem('edit|copy', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('copy') : false });
        $('#btn-editor').prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('paste-advanced') : true);
        menubar.updateItem('edit|paste to advanced editor', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('paste-advanced') : false });
        $('#btn-paste').prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('paste') : true);
        menubar.updateItem('edit|paste', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('paste') : false });
        $('#btn-find').prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('find') : true);
        menubar.updateItem('edit|find', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('find') : false });
        $('#btn-replace').prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('replace') : true);
        menubar.updateItem('edit|replace', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('replace') : false });
        $('#btn-refresh').prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('refresh') : true);
        menubar.updateItem('view|refresh', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('refresh') : false });
        menubar.updateItem('edit|select all', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('selectall') : false });
    }

    async function createWatcher() {
        if (watcher)
            watcher.close();
        watcher = chokidar.watch('', {
            persistent: true,
            depth: 0,
            ignoreInitial: true
        });
        watcher.unwatch('');

        // Something to use when events are received.
        var log = console.log.bind(console);
        watcher
            .on('error', error => {
                if (options.debug)
                    console.error(`Watcher error: ${error}`);
            })
            .on('ready', () => {
                if (options.debug)
                    log('Initial scan complete. Ready for changes');
            })
            .on('add', (file, stats) => {
                if (options.debug) {
                    log(`File ${file} has been added`);
                    log(stats);
                }
                fireWatch('add', file, stats);
            })
            .on('change', (file, stats) => {
                if (options.debug) {
                    log(`File ${file} has been changed`);
                    log(stats);
                }
                if (stats.birthtimeMs === stats.mtimeMs)
                    return;
                fireWatch('change', file, stats);
            })
            .on('unlink', file => {
                if (options.debug)
                    log(`File ${file} has been removed`);
                fireWatch('unlink', file);
            })
            .on('raw', (event, file, details) => {
                if (options.debug)
                    log('Raw event info:', event, file, details);
                fireWatch('raw', file, details);
            });
    }

    function fireWatch(event, file, args) {
        if (_opening[file]) return;
        var keys = Object.keys(_editors);
        var k = keys.length;
        var p;
        var choice;
        while (k--) {
            p = keys[k];
            //no editor or of not changed and new try next
            if (!_editors[p])
                continue;
            _editors[p].editor.watch(event, file, args);
            if (_editors[p] && _editors[p].diffFile === file) {
                if (event === 'unlink') {
                    choice = dialog.showMessageBoxSync({
                        type: 'question',
                        title: 'File deleted',
                        message: path.basename(file) + ' has been deleted, clear diff?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                        noLink: true
                    });
                    //no
                    if (choice === 1) {
                        var pane = manager.panes.indexOf(_editors[p].pane);
                        var a = _editors[p].pane.active == _editors[p];
                        if (a && _editors[p].editor.diff)
                            _editors[p].editor.deactivate(window.$dEditors[pane]);
                        _editors[p].editor.diff = null;
                        if (_editors[p].diffFile)
                            stopWatchFile(_editors[p].diffFile);
                        _editors[p].diffFile = null;
                        if (a) {
                            window.$dEditors[pane].getModifiedEditor().getContainerDomNode().parentElement.parentElement.style.display = '';
                            window.$editors[pane].getContainerDomNode().style.display = 'block';
                            toggleDiffNav(false);
                            _editors[p].editor.activate(window.$editors[pane]);
                            doUpdate(2);
                        }
                    }
                }
                else if (event !== 'raw') {
                    choice = dialog.showMessageBoxSync({
                        type: 'question',
                        title: 'File changed',
                        message: path.basename((file || p.editor.file) + ' has been changed, reload diff?'),
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                        noLink: true
                    });
                    //yes
                    if (choice === 0)
                        _editors[p].editor.diff = manager.active.editor.read(file);
                }
            }
        }
    }

    // eslint-disable-next-line no-unused-vars
    function closing() {
        if (watcher)
            watcher.close();
    }

    function loadOptions() {
        options = EditorSettings.load(parseTemplate(path.join('{data}', 'editor.json')));
        if (!options.outputSize || options.outputSize < 170)
            options.outputSize = 170;
        if (!options.maxRecent)
            options.maxRecent = 15;
        if (_ready) {
            monaco.editor.setTheme(options.theme ? 'lpcThemeDark' : 'lpcTheme');
            var e = window.$editors.length;
            while (e--) {
                window.$editors[e].updateOptions(options.editorOptions);
                window.$dEditors[e].updateOptions(options.editorOptions);
            }
        }
        output.css('height', (options.outputSize - 20) + 'px');
        if (options.output) {
            dock.css('bottom', options.outputSize + 'px');
            output.css('display', 'block');
        }
        else {
            dock.css('bottom', '');
            output.css('display', 'none');
        }
        if (options.outputTab === 0)
            showOutput();
        else
            showProblems();
        setIncludePaths(options.includePaths);

        var keys = Object.keys(_editors);
        var k = keys.length;
        var p;
        while (k--) {
            p = keys[k];
            if (!_editors[p] || _editors[p].editor.type !== 3) continue;
            _editors[p].editor.includePaths = options.includePaths;
        }
        menubar.updateItem('view|output', { checked: options.output && options.outputTab === 0 });
        menubar.updateItem('view|problems', { checked: options.output && options.outputTab === 1 });
        menubar.updateItem('sessions|reload previous session', { enabled: options.session && options.session.length });
        menubar.updateItem('sessions|replace with previous session', { enabled: options.session && options.session.length });
        if (_windows && _windows['help.html'] && _windows['help.html'].loadOptions)
            _windows['help.html'].loadOptions();
        if ($dialogs.room)
            $dialogs.room.mode = options.roomWizardMode;
        if ($dialogs.monster)
            $dialogs.monster.mode = options.monWizardMode;
        doUpdate(260);
    }

    function saveOptions() {
        options.save(parseTemplate(path.join('{data}', 'editor.json')));
    }

    function getFileIcon(file) {
        switch (path.extname(file)) {
            case '.pdf':
                return 'fa fa-file-pdf-o';
            case '.xls':
            case '.xlt':
            case '.xlm':
            case '.xlsx':
            case '.xlsm':
            case '.xltx':
            case '.xltm':
                return 'fa fa-file-excel-o';
            case '.doc':
            case '.dot':
            case '.wbk':
            case '.docx':
            case '.docm':
            case '.dotx':
            case '.dotm':
            case '.docb':
                return 'fa fa-file-word-o';
            case '.ppt':
            case '.pot':
            case '.pps':
            case '.pptx':
            case '.pptm':
            case '.potx':
            case '.potm':
            case '.ppam':
            case '.ppsx':
            case '.ppsm':
            case '.sldx':
            case '.sldm':
                return 'fa fa-file-powerpoint-o';
            case '.png':
            case '.gif':
            case '.jpg':
            case '.ico':
            case '.svg':
            case '.webp':
                return 'fa fa-file-image-o';
            case '.m4a':
            case '.wav':
            case '.mp3':
            case '.flac':
                return 'fa fa-file-audio-o';
            case '.avi':
            case '.mpg':
            case '.mov':
            case '.webm':
            case '.oog':
            case '.mkv':
                return 'fa fa-file-video-o';
            case '.7z':
            case '.zip':
            case '.rar':
            case '.jar':
                return 'fa fa-file-archive-o';
            case '.txt':
                return 'fa fa-file-text-o';
            case '.o':
            case '.csv':
                return 'fa fa-file-o icon-o';
            case '.h':
                return 'fa fa-file-code-o icon-h';
            case '.c':
                return 'fa fa-file-code-o icon-c';
            case '.map':
                return 'fa fa-map-o';
            case '.design':
                return 'fa fa-file-image-o icon-design';
        }
        return 'fa fa-file-o';
    }

    function clearButton(id) {
        $(id).removeClass('open');
        $(id).blur();
    }

    function doCut() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('cut'))
            manager.active.editor.cut();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doCopy() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('copy'))
            manager.active.editor.copy();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doPaste() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('paste'))
            manager.active.editor.paste();
        //if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doEditor() {
        if (!manager.active || !manager.active.editor || !manager.active.editor.supports('copy'))
            return;
        openAdvancedEditor(manager.active.editor.selected);
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doRedo() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('redo'))
            manager.active.editor.redo();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doUndo() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('undo'))
            manager.active.editor.undo();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doFind() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('find'))
            manager.active.editor.find();
    }

    function doReplace() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('replace'))
            manager.active.editor.replace();
    }

    function doRefresh() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('refresh'))
            manager.active.editor.refresh();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function toggleOutput() {
        if (options.output && options.outputTab !== 0) {
            showOutput();
            return;
        }
        if (options.output)
            options.output = false;
        else
            options.output = true;
        output.css('height', (options.outputSize - 20) + 'px');
        if (options.output) {
            dock.css('bottom', options.outputSize + 'px');
            output.css('display', 'block');
        }
        else {
            dock.css('bottom', '');
            output.css('display', 'none');
        }
        $(window).trigger('resize');
        doUpdate(16);
        showOutput();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function toggleProblems() {
        if (options.output && options.outputTab !== 1) {
            showProblems();
            return;
        }
        if (options.output)
            options.output = false;
        else
            options.output = true;
        output.css('height', (options.outputSize - 20) + 'px');
        if (options.output) {
            dock.css('bottom', options.outputSize + 'px');
            output.css('display', 'block');
        }
        else {
            dock.css('bottom', '');
            output.css('display', 'none');
        }
        $(window).trigger('resize');
        doUpdate(16);
        showProblems();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    // eslint-disable-next-line no-unused-vars
    function doClearOutput() {
        outputDisplay.empty();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    // eslint-disable-next-line no-unused-vars
    function closeOutput() {
        options.output = false;
        menubar.updateItem('view|output', { checked: options.output });
        menubar.updateItem('view|problems', { checked: options.output });
        dock.css('bottom', '');
        output.css('display', 'none');
        $(window).trigger('resize');
        doUpdate(16);
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function showOutput() {
        options.outputTab = 0;
        document.getElementById('btn-clear-output').style.display = '';
        menubar.updateItem('view|output', { checked: options.output });
        menubar.updateItem('view|problems', { checked: false });
        outputDisplay.css('display', 'block');
        document.getElementById('output-tab').classList.add('active');
        document.getElementById('problem-tab').classList.remove('active');
        if (problemDisplay)
            problemDisplay.parent.style.display = 'none';
    }

    function showProblems() {
        options.outputTab = 1;
        document.getElementById('btn-clear-output').style.display = 'none';
        menubar.updateItem('view|output', { checked: false });
        menubar.updateItem('view|problems', { checked: options.output });
        outputDisplay.css('display', 'none');
        document.getElementById('output-tab').classList.remove('active');
        document.getElementById('problem-tab').classList.add('active');
        if (!problemDisplay) {
            problemDisplay = new DataGrid(document.getElementById('problem-display'));
            problemDisplay.showChildren = true;
            problemDisplay.on('row-dblclick', (e, row) => {
                e.preventDefault();
                if (row.parent === -1) {
                    problemDisplay.toggleRows(row.row);
                }
                else {
                    gotoPosition(findEditor(row.row.file), row.row.children[row.child].startLineNumber, row.row.children[row.child].startColumn, row.row.children[row.child].endColumn);
                }
            });
            //text.push(`<li>${path.basename(markers[m].resource.path)} ${markers[m].message} ${markers[m].owner} [Ln ${markers[m].startLineNumber}, Col ${markers[m].startColumn}]</li>`);
            problemDisplay.columns = [
                {
                    label: 'File',
                    field: 'file',
                    width: 100,
                    readonly: true,
                    formatter: (data) => {
                        if (!data || data.parent !== -1) return '';
                        return path.basename(data.cell || '') + ` <span style="background-color: #bbb;color: white;border-radius: 10px;padding: 1px 4px;">${data.row.children.length > 100 ? 100 + '+' : data.row.children.length}</span>`;
                    },
                    tooltipFormatter: (data) => {
                        if (!data || data.parent !== -1) return '';
                        return path.basename(data.cell || '');
                    }
                }, {
                    label: 'Message',
                    field: 'message',
                    readonly: true,
                    sortable: false,
                    spring: true,
                    width: 250,
                    formatter: (data) => {
                        if (!data) return '';
                        if (data.parent === -1 && data.row.children)
                            return '';
                        return data.cell || '';
                    },
                    tooltipFormatter: (data) => {
                        if (!data) return '';
                        if (data.parent === -1 && data.row.children)
                            return '';
                        return data.cell || '';
                    },
                    editor: {
                        options: {
                            singleLine: true
                        }
                    }
                }, {
                    label: '',
                    field: 'owner',
                    width: 100,
                    readonly: true,
                    sortable: false,
                    formatter: (data) => {
                        if (!data) return '';
                        if (data.parent === -1 && data.row.children)
                            return '';
                        return data.cell;
                    },
                    tooltipFormatter: (data) => {
                        if (!data) return '';
                        if (data.parent === -1 && data.row.children)
                            return '';
                        return data.cell;
                    }
                }, {
                    label: 'Line',
                    field: 'startLineNumber',
                    width: 75,
                    sortable: false,
                    readonly: true,
                    formatter: (data) => {
                        if (!data) return '';
                        if (data.parent === -1 && data.row.children)
                            return '';
                        return data.cell;
                    },
                    tooltipFormatter: (data) => {
                        if (!data) return '';
                        if (data.parent === -1 && data.row.children)
                            return '';
                        return data.cell;
                    }
                }, {
                    label: 'Column',
                    field: 'startColumn',
                    width: 75,
                    sortable: false,
                    readonly: true,
                    formatter: (data) => {
                        if (!data) return '';
                        if (data.parent === -1 && data.row.children)
                            return '';
                        return data.cell;
                    },
                    tooltipFormatter: (data) => {
                        if (!data) return '';
                        if (data.parent === -1 && data.row.children)
                            return '';
                        return data.cell;
                    }
                }
            ];
        }
        problemDisplay.parent.style.display = 'block';
        buildProblems();
    }

    function buildProblems() {
        if (!problemDisplay || !options.output || options.outputTab !== 1) return;
        if (typeof monaco === 'undefined') {
            setTimeout(buildProblems, 100);
            return;
        }
        const markers = monaco.editor.getModelMarkers();
        const ml = markers.length;
        const url = require('url');
        let items = {};
        for (let m = 0; m < ml; m++) {
            const file = markers[m].source || url.fileURLToPath(markers[m].resource.toString());
            if (!items[file])
                items[file] = {
                    file: file,
                    children: []
                }
            markers[m].file = file;
            items[file].children.push(markers[m]);
        }
        problemDisplay.rows = Object.values(items);
    }

    function logOutput(text, open) {
        if (!text || text.length === 0)
            return;
        if (open && !options.output)
            toggleOutput();
        else if (open && optons.outputTab !== 0)
            showOutput();
        outputDisplay.append('<div>' + text + '</div>');
        outputDisplay[0].scrollTop = outputDisplay[0].scrollHeight;
    }

    function filterBrowseDialog() {
        if ($dialog.options.properties.indexOf('openDirectory') !== -1) {
            $dialog.datagrid.rows = $dialog.files.filter(f => {
                return f.size === -2;
            });
        }
        else if ($dialog.options.filters && $dialog.currentFilter > -1 && $dialog.currentFilter < $dialog.options.filters.length) {
            let filters = $dialog.options.filters[$dialog.currentFilter];
            $dialog.datagrid.rows = $dialog.files.filter(f => {
                if (f.size === -2)
                    return true;
                var e = path.extname(f.file).substr(1);
                if (!filters.extensions || filters.extensions.length === 0 || filters.extensions.indexOf('*') !== -1)
                    return true;
                return filters.extensions.indexOf(e) !== -1;
            });
        }
        else
            $dialog.datagrid.rows = $dialog.files;

    }

    //https://github.com/electron/electron/blob/master/docs/api/dialog.md
    function showBrowseDialog(ops, callback) {
        if (!window.opener) {
            dialog.showMessageBox({
                type: 'error',
                title: 'Not supported',
                message: 'Not supported in editor only mode, remote browsing can only be done when connected to the mud',
                defaultId: 1,
                noLink: true
            });
            return;
        }
        if (typeof ops === 'function') {
            callback = ops;
            ops = {};
        }
        ops = Object.assign({ title: 'Open remote file', properties: ['openFile', 'multiSelections'] }, ops || {});
        if (ops.properties.indexOf('saveFile') !== -1 && ops.title === 'Open remote file')
            ops.title = 'Save remote file';
        if (ops.defaultFile)
            options.remote = path.dirname(ops.defaultFile || '') || options.remote;
        else if (ops.defaultPath && ops.properties.indexOf('openDirectory') !== -1)
            options.remote = path.dirname(ops.defaultPath || '') || options.remote;
        else
            options.remote = ops.defaultPath || options.remote;
        saveOptions();

        if (!$dialog) {
            $dialog = {
                el: document.getElementById('remoteBrowse'),
                datagrid: new DataGrid(document.getElementById('remoteBrowseList')),
                ok: document.getElementById('remoteBrowseOk'),
                options: ops,
                title: document.getElementById('remoteBrowseTitle'),
                files: [],
                path: document.getElementById('remote-path'),
                up: document.getElementById('btn-remote-up'),
                current: options.remote,
                nav: document.getElementById('remote-navigate'),
                filter: document.getElementById('remoteBrowseFilter')
            };
            $dialog.datagrid.on('contextmenu', e => e.preventDefault());
            $dialog.up.addEventListener('click', () => {
                _ied.getDir(path.dirname($dialog.path.value || ''), true, 'remoteBrowse');
            });
            $dialog.path.addEventListener('change', () => {
                _ied.getDir($dialog.path.value, true, 'remoteBrowse');
            });
            $dialog.path.addEventListener('keyup', e => {
                if (e.which === 27)
                    _ied.getDir($dialog.current, false, 'remoteBrowse');
                e.preventDefault();
                e.stopPropagation();
            });
            $dialog.path.addEventListener('focus', () => {
                $dialog.path.select();
            });

            document.getElementById('remoteBrowseFile').addEventListener('change', () => {
                if (document.getElementById('remoteBrowseFile').value.length > 0 || ($dialog.options.properties.indexOf('openDirectory') !== -1 && $dialog.options.properties.indexOf('openFile') === -1 && $dialog.options.properties.indexOf('saveFile') === -1))
                    $dialog.ok.removeAttribute('disabled');
                else
                    $dialog.ok.setAttribute('disabled', 'true');
            });
            document.getElementById('remoteBrowseFile').addEventListener('input', () => {
                if (document.getElementById('remoteBrowseFile').value.length > 0 || ($dialog.options.properties.indexOf('openDirectory') !== -1 && $dialog.options.properties.indexOf('openFile') === -1 && $dialog.options.properties.indexOf('saveFile') === -1))
                    $dialog.ok.removeAttribute('disabled');
                else
                    $dialog.ok.setAttribute('disabled', 'true');
            });
            $dialog.nav.addEventListener('click', (e) => {
                e.preventDefault();
                e.cancelBubble = true;
                _ied.getDir(e.target.dataset.path, true, 'remoteBrowse');
                if (document.querySelector('.input-group-btn.open'))
                    document.querySelector('.input-group-btn.open').classList.remove('open');
                $dialog.datagrid.focus();
            });
            $dialog.datagrid.selectionSearchField = 'file';
            $dialog.datagrid.on('focus', () => {
                if (document.querySelector('.input-group-btn.open'))
                    document.querySelector('.input-group-btn.open').classList.remove('open');
            });
            $dialog.datagrid.allowMultipleSelection = ops.properties.indexOf('multiSelections') !== -1;
            $dialog.datagrid.columns = [
                {
                    label: 'Name',
                    field: 'file',
                    spring: true,
                    width: 200,
                    sort: (a, b, dir, prop, dataA, dataB) => {
                        if (dataA.size === -2 && dataB.size !== -2)
                            return -1 * dir;
                        if (dataA.size !== -2 && dataB.size === -2)
                            return 1 * dir;
                        if (dataA.file > dataB.file)
                            return 1 * dir;
                        if (dataA.file < dataB.file)
                            return -1 * dir;
                        return 0;
                    },
                    formatter: (data) => {
                        if (data.row.size === -2)
                            return '<i class="fa fa-folder-o" style="margin-right: 2px"></i>' + data.cell;
                        switch (data.row.type.toLowerCase()) {
                            case '.pdf':
                                return '<i class="fa fa-file-pdf-o" style="margin-right: 2px"></i>' + data.cell;
                            case '.xls':
                            case '.xlt':
                            case '.xlm':
                            case '.xlsx':
                            case '.xlsm':
                            case '.xltx':
                            case '.xltm':
                                return '<i class="fa fa-file-excel-o" style="margin-right: 2px"></i>' + data.cell;
                            case '.doc':
                            case '.dot':
                            case '.wbk':
                            case '.docx':
                            case '.docm':
                            case '.dotx':
                            case '.dotm':
                            case '.docb':
                                return '<i class="fa fa-file-word-o" style="margin-right: 2px"></i>' + data.cell;
                            case '.ppt':
                            case '.pot':
                            case '.pps':
                            case '.pptx':
                            case '.pptm':
                            case '.potx':
                            case '.potm':
                            case '.ppam':
                            case '.ppsx':
                            case '.ppsm':
                            case '.sldx':
                            case '.sldm':
                                return '<i class="fa fa-file-powerpoint-o" style="margin-right: 2px"></i>' + data.cell;
                            case '.png':
                            case '.gif':
                            case '.jpg':
                            case '.ico':
                            case '.svg':
                            case '.webp':
                                return '<i class="fa fa-file-image-o" style="margin-right: 2px"></i>' + data.cell;
                            case '.m4a':
                            case '.wav':
                            case '.mp3':
                            case '.flac':
                                return '<i class="fa fa-file-audio-o" style="margin-right: 2px"></i>' + data.cell;
                            case '.avi':
                            case '.mpg':
                            case '.mov':
                            case '.webm':
                            case '.oog':
                            case '.mkv':
                                return '<i class="fa fa-file-video-o" style="margin-right: 2px"></i>' + data.cell;
                            case '.7z':
                            case '.zip':
                            case '.rar':
                            case '.jar':
                                return '<i class="fa fa-file-archive-o" style="margin-right: 2px"></i>' + data.cell;
                            case '.txt':
                                return '<i class="fa fa-file-text-o" style="margin-right: 2px"></i>' + data.cell;
                            case '.o':
                            case '.csv':
                                return '<i class="fa fa-file-o icon-o" style="margin-right: 2px"></i>' + data.cell;
                            case '.h':
                                return '<i class="fa fa-file-code-o icon-h" style="margin-right: 2px"></i>' + data.cell;
                            case '.c':
                                return '<i class="fa fa-file-code-o icon-c" style="margin-right: 2px"></i>' + data.cell;

                        }
                        return '<i class="fa fa-file-o" style="margin-right: 2px"></i>' + data.cell;
                    }
                },
                {
                    label: 'Size',
                    field: 'size',
                    width: 100,
                    align: 'right',
                    formatter: (data) => {
                        if (data.cell === -2)
                            return '';
                        return formatSize(data.cell);
                    }
                },
                {
                    label: 'Type',
                    field: 'type',
                    sort: (a, b, dir, prop, dataA, dataB) => {
                        if (dataA.size === -2 && dataB.size !== -2)
                            return -1 * dir;
                        if (dataA.size !== -2 && dataB.size === -2)
                            return 1 * dir;
                        if (dataA.file > dataB.file)
                            return 1 * dir;
                        if (dataA.file < dataB.file)
                            return -1 * dir;
                        return 0;
                    }
                },
                {
                    label: 'Date Modified',
                    field: 'date',
                    width: 300,
                    sort: (a, b, dir, prop, dataA, dataB) => {
                        if (dataA.size === -2 && dataB.size !== -2)
                            return -1 * dir;
                        if (dataA.size !== -2 && dataB.size === -2)
                            return 1 * dir;
                        if (dataA.file > dataB.file)
                            return 1 * dir;
                        if (dataA.file < dataB.file)
                            return -1 * dir;
                        return 0;
                    },
                    formatter: (data) => {
                        return new moment(data.cell * 1000).format('MM/DD/YYYY hh:mm:ss A');
                    }
                }
            ];
            $dialog.datagrid.sort(0);
            $dialog.datagrid.on('row-dblclick', (e, data) => {
                e.preventDefault();
                if (!data || !data.row) return;
                let p = $dialog.current;
                if (!p.endsWith('/'))
                    p += '/';
                if (data.row.size === -2) {
                    if (connected)
                        _ied.getDir(p + data.row.file, true, 'remoteBrowse');
                    else
                        dialog.showMessageBox({
                            type: 'error',
                            title: 'Must be logged into the mud',
                            message: 'Remote browsing can only be done when connected to the mud',
                            defaultId: 1,
                            noLink: true
                        });
                }
                else {
                    $dialog.el.close();
                    options.remote = $dialog.current;
                    saveOptions();
                    if (callback)
                        callback([p + data.row.file]);
                }
            });
            $dialog.datagrid.on('selection-changed', () => {
                if (this.$dialog.datagrid.selectedCount > 0) {
                    let selected = $dialog.datagrid.selected;
                    if ($dialog.options.properties) {
                        if ($dialog.options.properties.indexOf('openDirectory') !== -1 && $dialog.options.properties.indexOf('openFile') === -1 && $dialog.options.properties.indexOf('saveFile') === -1)
                            selected = selected.filter(f => f.data.size === -2);
                        else if ($dialog.options.properties.indexOf('openDirectory') === -1 && ($dialog.options.properties.indexOf('openFile') !== -1) || $dialog.options.properties.indexOf('saveFile') !== -1)
                            selected = selected.filter(f => f.data.size !== -2);
                        else if ($dialog.options.properties.indexOf('openDirectory') === -1 && $dialog.options.properties.indexOf('openFile') === -1 && $dialog.options.properties.indexOf('saveFile') === -1)
                            selected = selected.filter(f => f.data.size !== -2);
                    }
                    else
                        selected = selected.filter(f => f.data.size !== -2);
                    selected = selected.map(f => f.data.file);
                    if (selected.length === 1)
                        document.getElementById('remoteBrowseFile').value = selected[0];
                    else if (selected.length > 1)
                        document.getElementById('remoteBrowseFile').value = selected.map(f => `"${f}"`).join(' ');
                }
                if (document.getElementById('remoteBrowseFile').value.length > 0 || ($dialog.options.properties.indexOf('openDirectory') !== -1 && $dialog.options.properties.indexOf('openFile') === -1 && $dialog.options.properties.indexOf('saveFile') === -1))
                    $dialog.ok.removeAttribute('disabled');
                else
                    $dialog.ok.setAttribute('disabled', 'true');
            });
            $dialog.title.textContent = ops.title;
            $dialog.ok.addEventListener('click', () => {
                let files;
                if (document.getElementById('remoteBrowseFile').value.length === 0 && $dialog.options.properties.indexOf('openDirectory') !== -1 && $dialog.options.properties.indexOf('openFile') === -1 && $dialog.options.properties.indexOf('saveFile') === -1)
                    files = [$dialog.current];
                else {
                    files = document.getElementById('remoteBrowseFile').value.splitQuote(' ', 2);
                    let p = $dialog.current;
                    if (!p.endsWith('/'))
                        p += '/';
                    files = files.map(f => p + f);
                }
                $dialog.el.close();
                options.remote = $dialog.current;
                saveOptions();
                if (callback)
                    callback(files);
            });
            $dialog.el.addEventListener('open', () => {
                menubar.enabled = false;
            });
            $dialog.el.addEventListener('close', () => {
                menubar.enabled = true;
            });
            $dialog.el.addEventListener('cancel', () => {
                menubar.enabled = true;
            });
            $dialog.filter.addEventListener('change', () => {
                $dialog.currentFilter = $dialog.filter.selectedIndex;
                filterBrowseDialog();
            });
        }
        else {
            $dialog.options = ops;
            $dialog.title.textContent = ops.title;
            var old_element = $dialog.ok;
            var new_element = $dialog.ok.cloneNode(true);
            new_element.addEventListener('click', () => {
                let files;
                if (document.getElementById('remoteBrowseFile').value.length === 0 && $dialog.options.properties.indexOf('openDirectory') !== -1 && $dialog.options.properties.indexOf('openFile') === -1 && $dialog.options.properties.indexOf('saveFile') === -1)
                    files = [$dialog.current];
                else {
                    files = document.getElementById('remoteBrowseFile').value.splitQuote(' ', 2);
                    let p = $dialog.current;
                    if (!p.endsWith('/'))
                        p += '/';
                    files = files.map(f => p + f);
                }
                $dialog.el.close();
                options.remote = $dialog.current;
                saveOptions();
                if (callback)
                    callback(files);
            });
            old_element.parentNode.replaceChild(new_element, old_element);
            $dialog.ok = new_element;
        }
        $dialog.first = true;
        if (ops.properties.indexOf('openDirectory') !== -1) {
            document.getElementById('remoteBrowseFile-label').textContent = 'Folder:';
            $dialog.ok.textContent = 'Select Folder';
        }
        else if (ops.properties.indexOf('saveFile') !== -1) {
            $dialog.ok.textContent = 'Save';
            document.getElementById('remoteBrowseFile-label').textContent = 'File name:';
        }
        else {
            $dialog.ok.textContent = 'Open';
            document.getElementById('remoteBrowseFile-label').textContent = 'File name:';
        }
        if (ops.defaultFile)
            document.getElementById('remoteBrowseFile').value = path.basename(ops.defaultFile || '');
        $dialog.path.value = options.remote;
        if (ops.filters && ops.filters.length > 0 && (ops.properties.indexOf('openFile') !== -1 || $dialog.options.properties.indexOf('saveFile') !== -1)) {
            document.getElementById('remoteBrowseFooter').children[0].style.right = '160px';
            document.getElementById('remoteBrowseFooter').children[1].style.display = '';
            while ($dialog.filter.firstChild)
                $dialog.filter.removeChild($dialog.filter.firstChild);
            let fl = ops.filters.length;
            for (let f = 0; f < fl; f++) {
                let o = document.createElement('option');
                o.value = f;
                o.textContent = ops.filters[f].name;
                $dialog.filter.appendChild(o);
            }
            $($dialog.filter).selectpicker('refresh');
            $dialog.currentFilter = 0;
        }
        else {
            $dialog.currentFilter = -1;
            document.getElementById('remoteBrowseFooter').children[0].style.right = '5px';
            document.getElementById('remoteBrowseFooter').children[1].style.display = 'none';
        }

        $dialog.datagrid.rows = [];
        $dialog.datagrid.allowMultipleSelection = ops.properties.indexOf('multiSelections') !== -1;
        if (connected)
            _ied.getDir(options.remote, false, 'remoteBrowse');
        else
            dialog.showMessageBox({
                type: 'error',
                title: 'Must be logged into the mud',
                message: 'Remote browsing can only be done when connected to the mud',
                defaultId: 1,
                noLink: true
            });
    }

    function showProgressDialog(data) {
        var progress = document.getElementById('progress-dialog');
        if (typeof data === 'object') {
            $queue.push(data);
            document.getElementById('progress-dialog-title').innerHTML = $queue[0].title || 'Retrieving&hellip;';
        }
        else
            document.getElementById('progress-dialog-title').innerHTML = data || 'Retrieving&hellip;';
        if (progress.open) return;
        menubar.enabled = false;
        if (!$dialogs.progress) {
            $dialogs.progress = {};
            progress.addEventListener('close', () => closeProgressDialog());
            progress.addEventListener('cancel', () => closeProgressDialog());
            document.getElementById('progress-dialog-cancel').addEventListener('click', () => closeProgressDialog());
        }
        setProgressDialogValue(0);
        progress.showModal();
    }

    function setProgressDialogValue(value, title) {
        if (window.opener)
            window.opener.updateProgress({ value: value / 100 });
        window.setProgressBar(value / 100);
        document.getElementById('progress-dialog-progressbar').value = value;
        if (title && title.length > 0)
            document.getElementById('progress-dialog-title').innerHTML = title;
    }

    function closeProgressDialog(id, saveTmp, removeItem) {
        var progress = document.getElementById('progress-dialog');
        if (id) {
            var ql = $queue.length;
            var data;
            for (var q = 0; q < ql; q++) {
                if ($queue[q].file && $queue[q].tag === id) {
                    data = $queue[q];
                    break;
                }
                else if ($queue[q].files && ($queue[q].tag + ($queue[q].files.length - 1)) === id) {
                    data = $queue[q];
                    break;
                }
            }
            if (!data) return;
            $queue.splice(q, 1);
        }
        else
            data = $queue.shift();
        if (data) {
            if (removeItem && data.file)
                _ied.removeItem(data.tag);
            else if (removeItem && data.files) {
                var fl = data.files.length;
                for (var f = 0; f < fl; f++)
                    _ied.removeItem(data.tag + f);
            }
            if (data.tmp && !saveTmp) {
                if (!Array.isArray(data.tmp))
                    data.tmp = [data.tmp];
                var tl = data.tmp.length;
                for (var t = 0; t < tl; t++) {
                    if (typeof data.tmp[t] === 'string') {
                        if (existsSync(data.tmp[t]))
                            fs.unlinkSync(data.tmp[t]);
                        continue;
                    }
                    var n = data.tmp[t].name;
                    data.tmp[t].removeCallback();
                    if (existsSync(n))
                        fs.unlinkSync(n);
                }
            }
        }
        if ($queue.length === 0) {
            if (progress.open)
                progress.close();
            setProgressDialogValue(-1);
            document.getElementById('progress-dialog-progressbar').removeAttribute('value');
            menubar.enabled = true;
        }
        else {
            setProgressDialogValue(0);
            menubar.enabled = false;
            if (!progress.open)
                progress.showModal();
        }
    }

    function showResizeDialog(size) {
        var dialog = document.getElementById('map-resize');
        document.getElementById('map-resize-width').value = size ? size.width || 0 : 0;
        document.getElementById('map-resize-height').value = size ? size.height || 0 : 0;
        document.getElementById('map-resize-depth').value = size ? size.depth || 0 : 0;
        $('#map-resize-horizontal-anchor').val(0).selectpicker('render');
        $('#map-resize-vertical-anchor').val(0).selectpicker('render');
        $('#map-resize-depth-anchor').val(0).selectpicker('render');
        if (!dialog.open)
            dialog.showModal();
    }

    // eslint-disable-next-line no-unused-vars
    function resizeMap() {
        if (manager.active.editor && manager.active.editor.resizeMap) {
            var w = (+$('#map-resize-width').val()) || 0;
            var h = (+$('#map-resize-height').val()) || 0;
            var d = (+$('#map-resize-depth').val()) || 0;
            var s = manager.active.editor.size;
            w -= s.width;
            h -= s.height;
            d -= s.depth;
            var sf = (+$('#map-resize-horizontal-anchor').val()) || 0;
            sf |= (+$('#map-resize-vertical-anchor').val()) || 0;
            sf |= (+$('#map-resize-depth-anchor').val()) || 0;
            manager.active.editor.resizeMap(w, h, d, sf);
        }
        document.getElementById('map-resize').close();
        setTimeout(() => { if (manager.active && manager.active.editor) manager.active.editor.focus(); }, 10);
    }

    // eslint-disable-next-line no-unused-vars
    function gotoLine(id, line) {
        if (!id) return;
        var panel = manager.findPanel(id);
        if (!panel) return;
        var dock = manager.panes.indexOf(panel.dock);
        if (dock === -1) return;
        manager.panes[dock].switchToPanel(panel);
        window.$editors[dock].setPosition({ column: 1, lineNumber: line });
        window.$dEditors[dock].setPosition({ column: 1, lineNumber: line });
        window.$editors[dock].revealPositionInCenterIfOutsideViewport({ column: 1, lineNumber: line });
        window.$dEditors[dock].revealPositionInCenterIfOutsideViewport({ column: 1, lineNumber: line });
    }

    function gotoPosition(id, line, column, endColumn) {
        if (!id) return;
        var panel = manager.findPanel(id);
        if (!panel) return;
        var dock = manager.panes.indexOf(panel.dock);
        if (dock === -1) return;
        manager.panes[dock].switchToPanel(panel);
        window.$editors[dock].setPosition({ column: column, lineNumber: line });
        window.$dEditors[dock].setPosition({ column: column, lineNumber: line });
        if (endColumn) {
            window.$editors[dock].revealRange({ startColumn: column, endColumn: endColumn, startLineNumber: line, endLineNumber: line });
            window.$dEditors[dock].revealRange({ startColumn: column, endColumn: endColumn, startLineNumber: line, endLineNumber: line });
            window.$editors[dock].setSelection({ startColumn: column, endColumn: endColumn, startLineNumber: line, endLineNumber: line });
            window.$dEditors[dock].setSelection({ startColumn: column, endColumn: endColumn, startLineNumber: line, endLineNumber: line });
        }
        else {
            window.$editors[dock].revealPositionInCenterIfOutsideViewport({ column: column, lineNumber: line });
            window.$dEditors[dock].revealPositionInCenterIfOutsideViewport({ column: column, lineNumber: line });
        }
    }

    function gotoNextChange() {
        if (!manager.active && !manager.active.editor && manager.active.editor.type !== 1)
            return;
        window.$dEditors[manager.panes.indexOf(manager.activePane)].goToDiff('next');
    }

    function gotoPrevChange() {
        if (!manager.active && !manager.active.editor && manager.active.editor.type !== 1)
            return;
        window.$dEditors[manager.panes.indexOf(manager.activePane)].goToDiff('previous');
    }

    $(document).ready(() => {
        loadOptions();
        if (!window.opener) {
            $('#btn-grp-remote').css('display', 'none');
        }
        else {
            window.opener.client.on('received-GMCP', processGMCP);
            window.opener.client.on('connected', clientConnected);
            window.opener.client.on('closed', clientClosed);
            window.opener._status.on('set-title', setTitle);
            window.opener.addEventListener('loadCharacter', updateCharacter);
            window.opener.addEventListener('updateCharacter', updateCharacter);
            window.opener.addEventListener('resetCharacter', updateCharacter);
            //#region init IED
            _ied = new IED();
            _ied.prefix = 'editor-';
            _ied.compressUpload = true;
            _ied.compressDownload = true;
            _ied.compressDir = true;
            _ied.on('init', () => {

            });
            _ied.on('error', (error) => {
                if (error && error.code) {
                    switch (error.code) {
                        case IEDError.USER_DENIED:
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Permission denied',
                                message: 'Permission denied'
                            });
                            closeProgressDialog(error.tag);
                            break;
                        case IEDError.DL_NOTSTART:
                        case IEDError.DL_TOOMANY:
                        case IEDError.DL_INPROGRESS:
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Download error',
                                message: `Download error for '${error.path}/${error.file}': ${error.msg}`
                            });
                            closeProgressDialog(error.tag);
                            break;
                        case IEDError.DL_INVALIDFMT:
                        case IEDError.DL_UNKNOWN:
                        case IEDError.DL_USERABORT:
                        case IEDError.DL_INVALIDFILE:
                        case IEDError.DL_INVALIDPATH:
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Download aborted',
                                message: `Download aborted for '${error.path}/${error.file}': ${error.msg}`
                            });
                            closeProgressDialog(error.tag);
                            break;
                        case IEDError.RESET:
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Reset',
                                message: 'Server reset: ' + error.msg
                            });
                            closeProgressDialog(error.tag);
                            break;
                        case IEDError.USERRESET:
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Reset',
                                message: error.msg
                            });
                            break;
                        case IEDError.UL_TOOMANY:
                        case IEDError.UL_INPROGRESS:
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Upload error',
                                message: `Upload error for '${error.path}/${error.file}': ${error.msg}`
                            });
                            closeProgressDialog(error.tag);
                            break;
                        case IEDError.UL_INVALIDFMT:
                        case IEDError.UL_USERABORT:
                        case IEDError.UL_BADENCODE:
                        case IEDError.UL_TOOLARGE:
                        case IEDError.UL_FAILWRITE:
                        case IEDError.UL_UNKNOWN:
                        case IEDError.UL_INVALIDFILE:
                        case IEDError.UL_INVALIDPATH:
                        case IEDError.UL_DENIED:
                        case IEDError.UL_FILE:
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Upload aborted',
                                message: `Upload aborted for '${error.path}/${error.file}': ${error.msg}`
                            });
                            closeProgressDialog(error.tag);
                            break;
                        case IEDError.CMD_EXIST:
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Already exist',
                                message: `File or directory already exist: '${error.path}/${error.file}`
                            });
                            closeProgressDialog(error.tag);
                            break;
                        case IEDError.CMD_DIRECTORY:
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Is a directory',
                                message: `File is a directory: '${error.path}/${error.file}`
                            });
                            closeProgressDialog(error.tag);
                            break;
                        case IEDError.CMD_NOEXIST:
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Does not exist',
                                message: `File or directory does not exist: '${error.path}/${error.file}`
                            });
                            closeProgressDialog(error.tag);
                            break;
                        case IEDError.CMD_FILE:
                            dialog.showMessageBox({
                                type: 'error',
                                title: 'Not a directory',
                                message: `File not a directory: '${error.path}/${error.file}`
                            });
                            closeProgressDialog(error.tag);
                            break;
                        case IEDError.DIR_CANTREAD:
                            if (error.tag && error.tag === 'editor-dir:remoteBrowse')
                                _ied.getDir('.', false, 'remoteBrowse');
                            else {
                                dialog.showMessageBox({
                                    type: 'error',
                                    title: 'Can not read',
                                    message: 'Can not read or permission denied'
                                });
                                closeProgressDialog(error.tag);
                            }
                            break;
                    }
                }
                var msg;
                if (error.stack)
                    msg = error.stack;
                else if (error instanceof TypeError)
                    msg = error.name + ': ' + error.message;
                else if (error instanceof Error)
                    msg = error.name + ': ' + error.message;
                else if (error.message)
                    msg = error.message;
                else if (error.msg)
                    msg = error.msg;
                else
                    msg = error;
                logOutput(msg);
            });
            _ied.on('reset', () => { });
            _ied.on('dir', (dir, files, tag) => {
                if (tag.startsWith('editor-dir:remoteBrowse')) {
                    $dialog.files = files;
                    $dialog.path.value = dir;
                    $dialog.current = dir;
                    if ($dialog.options.properties.indexOf('showHiddenFiles') === -1)
                        $dialog.files = files.filter(f => f.file[0] !== '.');
                    $dialog.files = files.map(f => {
                        if (f.size === -2)
                            f.type = 'Directory';
                        else
                            f.type = path.extname(f.file);
                        return f;
                    });
                    filterBrowseDialog();
                    if ($dialog.first) {
                        $dialog.first = false;
                        if ($dialog.options.defaultFile) {
                            let idx = $dialog.datagrid.rows.indexOf(path.basename($dialog.options.defaultFile));
                            $dialog.datagrid.selectByDataIndex(idx, true);
                        }
                        else
                            $dialog.datagrid.scrollToTop();
                    }
                    else
                        $dialog.datagrid.scrollToTop();
                    if (dir !== '/')
                        $dialog.up.removeAttribute('disabled');
                    else
                        $dialog.up.setAttribute('disabled', 'true');
                    while ($dialog.nav.firstChild)
                        $dialog.nav.removeChild($dialog.nav.firstChild);
                    setTimeout(() => {
                        var el;
                        var paths = [];
                        var parts = dir.split('/');
                        if (dir.endsWith('/'))
                            parts.pop();
                        else
                            dir += '/';
                        var c = [];
                        var dirs = files.filter(f => f.size === -2);

                        for (var pt = 0, pl = parts.length; pt < pl; pt++) {
                            c.push(parts[pt]);
                            if (pt === 0)
                                paths.push({ path: '/', name: '/', count: pt, open: pt === pl - 1 });
                            else
                                paths.push({ path: c.join('/'), name: parts[pt], count: pt, open: pt === pl - 1 });
                        }
                        for (var d = 0, dl = dirs.length; d < dl; d++) {
                            paths.push({ path: dir + dirs[d].file, name: dirs[d].file, count: pt });
                        }

                        paths.sort(function compare(a, b) {
                            if (a.path.toUpperCase() < b.path.toUpperCase())
                                return -1;
                            if (a.path.toUpperCase() > b.path.toUpperCase())
                                return 1;
                            return 0;
                        });

                        var frag = document.createDocumentFragment();
                        for (let c = 0, cl = paths.length; c < cl; c++) {
                            el = document.createElement('li');
                            if (paths[c].drive && paths[c].open)
                                el.innerHTML = `<a href="#" class="active" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-server"></i> ${paths[c].name}</a>`;
                            else if (paths[c].drive)
                                el.innerHTML = `<a href="#" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-server"></i> ${paths[c].name}</a>`;
                            else if (paths[c].open)
                                el.innerHTML = `<a href="#" class="active" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-folder-open-o"></i> ${paths[c].name}</a>`;
                            else
                                el.innerHTML = `<a href="#" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-folder-o"></i> ${paths[c].name}</a>`;
                            frag.appendChild(el);
                        }
                        $dialog.nav.appendChild(frag);
                    });
                    if (!$dialog.el.open) {
                        menubar.enabled = false;
                        $dialog.el.showModal();
                    }
                }
            });
            _ied.on('message', (msg) => {
                logOutput(msg);
            });
            _ied.on('add', () => {
            });
            _ied.on('remove', (item) => {
                if (!item) return;
                if (item.ID.startsWith('editor-download:remote-open:'))
                    closeProgressDialog(item.ID, true);
                else
                    closeProgressDialog(item.ID);
            });
            _ied.on('update', (item) => {
                if (!item) return;
                setProgressDialogValue(Math.ceil(item.percent * 100));
            });
            _ied.on('cmd', (obj) => {
                if (!obj) return;
                var id, panel, dock;
                if (obj.cmd === 'debug' && obj.tag.startsWith('editor-debug:')) {
                    id = parseInt(obj.tag.substr(13));
                    panel = manager.findPanel(id);
                    dock = manager.panes.indexOf(panel.dock);
                    logOutput('Debug data for ' + panel.editor.filename);
                    var errors = obj.data.trim().split('\n');
                    var el = errors.length;
                    var markers = [];
                    var delta = [];
                    var editor;
                    if (panel.editor.diff)
                        editor = window.$dEditors[dock].getModifiedEditor();
                    else
                        editor = window.$editors[dock];
                    var model = editor.getModel();
                    for (var e = 0; e < el; e++) {
                        let m;
                        let line;
                        if (m = /^line (\d+): Warning: (.*)/.exec(errors[e])) {
                            line = parseInt(m[1], 10) || 1;
                            markers.push({
                                startColumn: 1,
                                startLineNumber: line,
                                endColumn: model.getLineContent(line).length,
                                endLineNumber: line,
                                message: 'Warning: ' + m[2],
                                severity: 4 //waring
                            });
                            if (delta.filter(f => f.range.startLineNumber === line && f.options.marginClassName === 'line-error-margin').length === 0)
                                delta.push({
                                    range: new monaco.Range(line, 1, line, model.getLineContent(line).length),
                                    options: {
                                        stickiness: 1,
                                        isWholeLine: true,
                                        //className: 'line-warning-content',
                                        //glyphMarginHoverMessage: { value: 'Warning: ' + m[2] },
                                        //glyphMarginClassName: 'line-warning-glyph',
                                        marginClassName: 'line-warning-margin',
                                        zIndex: 0
                                    }
                                });
                            else
                                delta.push({
                                    range: new monaco.Range(line, 1, line, model.getLineContent(line).length),
                                    options: {
                                        stickiness: 1,
                                        isWholeLine: true,
                                        //className: 'line-warning-content',
                                        //glyphMarginHoverMessage: { value: 'Warning: ' + m[2] },
                                        //glyphMarginClassName: 'line-warning-glyph',
                                        marginClassName: 'line-error-margin',
                                        zIndex: 0
                                    }
                                });
                            logOutput(`<a class="warning" href="#" onclick="gotoLine(${id}, ${line})">${panel.editor.file}: ${errors[e]}</a>`);
                        }
                        else if (m = /^line (\d+): (.*)/.exec(errors[e])) {
                            line = parseInt(m[1], 10) || 1;
                            markers.push({
                                startColumn: 1,
                                startLineNumber: line,
                                endColumn: model.getLineContent(line).length,
                                endLineNumber: line,
                                message: m[2],
                                severity: 8, //error,
                                source: panel.editor.filename
                            });
                            delta.forEach(f => {
                                if (f.range.startLineNumber === line && f.options.marginClassName === 'line-warning-margin')
                                    f.options.marginClassName = 'line-error-margin';
                            });
                            delta.push({
                                range: new monaco.Range(line, 1, line, model.getLineContent(line).length),
                                options: {
                                    stickiness: 1,
                                    isWholeLine: true,
                                    //className: 'line-error-content',
                                    //glyphMarginHoverMessage: { value: m[2] },
                                    //glyphMarginClassName: 'line-error-glyph',
                                    marginClassName: 'line-error-margin',
                                    zIndex: 1
                                }
                            });
                            logOutput(`<a class="error href="#" onclick="gotoLine(${id}, ${line})">${panel.editor.file}: ${errors[e]}</a>`);
                        }
                        else
                            logOutput(errors[e]);
                    }
                    monaco.editor.setModelMarkers(model, 'errors', markers);
                    panel.editor.decorations = model.deltaDecorations(panel.editor.decorations || [], delta);
                    panel.editor.rawDecorations = delta;
                    //if (panel.editor.decorations && panel.editor.decorations.length)
                    //editor.updateOptions({ glyphMargin: true });
                    _ied.deleteFile(obj.path + '/' + obj.file);
                    closeProgressDialog(obj.tag);
                }
            });
            _ied.on('download-finished', (item) => {
                if (!item) return;
                var id;
                var panel;
                var dock;
                if (item.ID.startsWith('editor-download:diffRemote:')) {
                    id = parseInt(item.ID.substr(27));
                    panel = manager.findPanel(id);
                    dock = manager.panes.indexOf(panel.dock);
                    if (!manager.active.editor.diff)
                        manager.active.editor.deactivate(window.$editors[dock]);
                    if (manager.active.diffFile)
                        stopWatchFile(manager.active.diffFile);
                    manager.active.editor.diff = manager.active.editor.read(item.local);
                    window.$dEditors[dock].getModifiedEditor().getContainerDomNode().parentElement.parentElement.style.display = 'block';
                    toggleDiffNav(true);
                    window.$editors[dock].getContainerDomNode().style.display = '';
                    manager.active.editor.activate(window.$dEditors[dock]);
                    window.$dEditors[dock].updateOptions(window.$editors[dock].getRawOptions());
                    closeProgressDialog(item.ID);
                    doUpdate(2);
                }
                else if (item.ID.startsWith('editor-download:remote-open:')) {
                    var ids = item.ID.substr(28).split(':');
                    id = parseInt(ids[0]);
                    if (id !== 0) {
                        panel = manager.findPanel(id);
                        openFile($queue[0].tmp, item.remote, panel ? panel.dock : null, true, $queue[0].tmp);
                    }
                    else
                        openFile($queue[0].tmp, item.remote, null, true, $queue[0].tmp);
                    doUpdate(2);
                }
            });
            _ied.on('upload-finished', item => {
                if (!item) return;
                var id;
                var panel;
                //var dock;
                if (item.ID.startsWith('editor-upload:debug:')) {
                    id = parseInt(item.ID.substr(20));
                    panel = manager.findPanel(id);
                    //dock = manager.panes.indexOf(panel.dock);
                    setProgressDialogValue(-1);
                    document.getElementById('progress-dialog-progressbar').removeAttribute('value');
                    document.getElementById('progress-dialog-title').innerHTML = 'Getting debug data&hellip;';
                    logOutput('Requesting debug information for ' + panel.editor.file);
                    if (window.opener)
                        window.opener.client.sendGMCP('IED.cmd ' + JSON.stringify({ cmd: 'debug', path: path.dirname(item.remote), file: path.basename(item.remote), tag: 'editor-debug:' + id }));
                }
            });
            _ied.on('send-gmcp', command => {
                if (window.opener)
                    window.opener.client.sendGMCP(command);
            });
            //#endregion
        }
        $('#btm-drag-bar').mousedown(function (e) {
            e.preventDefault();
            outputDragging = true;
            var ghostBar = $('<div>',
                {
                    id: 'btm-ghost-bar',
                    css: {
                        width: output.outerWidth(),
                        top: output.offset().top,
                        left: output.offset().left
                    }
                }).appendTo('body');

            $(document).mousemove(function (e) {
                if (e.pageY < 169)
                    ghostBar.css('top', 169);
                else if (e.pageY > document.body.clientHeight - 170)
                    ghostBar.css('top', document.body.clientHeight - 170);
                else
                    ghostBar.css('top', e.pageY);
                //if (window.$editor)
                //window.$editor.layout();
            });
        });

        $('#toolbar').on('click', () => {
            if (manager.active && manager.active.editor)
                manager.active.editor.focus();
        });

        $(window).on('resize', () => {
            var tbh = toolbar.outerHeight();
            dock.css('top', tbh + 'px');
            if (options.output && output.outerHeight() < 170 && (dock.outerHeight() + tbh) > 172) {
                options.outputSize = 170;
                output.css('height', (options.outputSize - 20) + 'px');
                dock.css('bottom', options.outputSize + 'px');
                doUpdate(16);
            }
            doUpdate(128);
            if (manager.active && manager.active.editor) manager.active.editor.focus();
            if (!window.$editors) return;
            var e = window.$editors.length;
            while (e--) {
                window.$editors[e].layout();
                window.$dEditors[e].layout();
            }
        });

        $(document).mouseup(function (e) {
            if (outputDragging) {
                if (e.pageY < 170)
                    options.outputSize = document.body.clientHeight - 172;
                else if (e.pageY > document.body.clientHeight - 170)
                    options.outputSize = 170;
                else
                    options.outputSize = document.body.clientHeight - e.pageY + 2;
                output.css('height', (options.outputSize - 20) + 'px');
                dock.css('bottom', options.outputSize + 'px');
                doUpdate(16);
                $('#btm-ghost-bar').remove();
                $(document).unbind('mousemove');
                if (manager.active && manager.active.editor) manager.active.editor.focus();
                var ed = window.$editors.length;
                while (ed--) {
                    window.$editors[ed].layout();
                    window.$dEditors[ed].layout();
                }
                outputDragging = false;
            }
        });

        $('#btn-add-dropdown').click(function () {
            $(this).addClass('open');
            const pos = $(this).offset();
            const x = Math.floor(pos.left);
            const y = Math.floor(pos.top + $(this).outerHeight() + 2);
            const addMenu = new Menu();
            addMenu.append(new MenuItem({
                label: 'New file', click() {
                    clearButton('#btn-add-dropdown');
                    newFile();
                }
            }));
            addMenu.append(new MenuItem({ type: 'separator' }));
            addMenu.append(new MenuItem({
                label: 'New area...', click() {
                    clearButton('#btn-add-dropdown');
                    newArea();
                }
            }));
            addMenu.append(new MenuItem({
                label: 'New virtual area...', click() {
                    clearButton('#btn-add-dropdown');
                    newVirtualArea();
                }
            }));
            addMenu.append(new MenuItem({
                label: 'New area design...', click() {
                    clearButton('#btn-add-dropdown');
                    newAreaDesign();
                }
            }));
            addMenu.append(new MenuItem({ type: 'separator' }));
            addMenu.append(new MenuItem({
                label: 'New room...', click() {
                    clearButton('#btn-add-dropdown');
                    roomWizard();
                }
            }));
            addMenu.append(new MenuItem({
                label: 'New monster...', click() {
                    clearButton('#btn-add-dropdown');
                    monsterWizard();
                }
            }));
            addMenu.append(new MenuItem({ type: 'separator' }));
            addMenu.append(new MenuItem({
                label: 'Templates',
                submenu: menuTemplates
            }));
            addMenu.popup({ window: remote.getCurrentWindow(), x: x, y: y });
        });

        Array.from(document.querySelectorAll('.edit-dropdown')).forEach(d => initEditDropdown(d));
        if (window.opener) {
            if (connected) {
                document.getElementById('btn-open-remote').removeAttribute('disabled');
                menubar.updateItem('file|open remote...', { enabled: connected });
            }
            else {
                document.getElementById('btn-open-remote').setAttribute('disabled', 'true');
                menubar.updateItem('file|open remote...', { enabled: false });
            }
        }
        else {
            if (_windowState && _windowState.windows.length) {
                const _dir = 'file:///' + __dirname.replace(/\\/g, '/');
                const wl = _windowState.windows.length;
                for (let w = 0; w < wl; w++) {
                    let file = _windowState.windows[w].details.url;
                    if (file.startsWith(file))
                        file = path.basename(file.substring(__dirname.length + 9), '.html');
                    openWindow(file, _windowState.windows[w]);
                }
            }
        }
        createWatcher();
        postEditorLoad();
    });

    async function postEditorLoad() {
        if (!_ready) {
            setTimeout(postEditorLoad, 10);
            return;
        }
        if (_open) {
            if (options.opened.length && Array.isArray(options.opened[0])) {
                manager.layout = options.layout;
                options.opened[0] = options.opened[0].concat(_open.map((l) => { return { file: l[0], remote: l[1], remoteEdit: l[2] }; }));
                let l = options.opened.length;
                while (l--)
                    openFiles(options.opened[l], false, manager.panes[l]);
            }
            else
                openFiles(options.opened.concat(_open.map((l) => { return { file: l[0], remote: l[1], remoteEdit: l[2] }; })));
            if (_open[_open.length - 1][2])
                options.lastActive = 'remote:' + _open[_open.length - 1][0];
            else
                options.lastActive = _open[_open.length - 1][0];
            _open = 0;
        }
        else if (options.opened.length && Array.isArray(options.opened[0])) {
            manager.layout = options.layout;
            let l = options.opened.length;
            while (l--)
                openFiles(options.opened[l], false, manager.panes[l]);
        }
        else
            openFiles(options.opened);
        if (options.reopen) {
            if (options.opened.length && Array.isArray(options.opened[0])) {
                options.opened.forEach((o, i) => {
                    var a = o.filter(f => f.active);
                    if (a.length > 0) {
                        last = findEditor(a[0].file);
                        if (last)
                            manager.switchToPanel(last, manager.panes[i]);
                    }
                });
            }
            var last = findEditor(options.lastActive);
            if (last) {
                manager.focusPane(last.dock);
                last.dock.switchToPanel(last.id);
            }
        }
        buildRecent();
        $('#splashScreenMask').css('display', 'none');
        $('#splashLayout').css('display', 'none');
        ipcRenderer.invoke('window', 'setEnabled', true);
        menubar.enabled = true;
        _loading = 0;
    }

    function toggleDiffNav(state) {
        menubar.updateItem('view|previous change', { enabled: state });
        menubar.updateItem('view|next change', { enabled: state });
        $('#btn-diff-nav-prev').prop('disabled', !state);
        $('#btn-diff-nav-next').prop('disabled', !state);
    }

    function getOpened(skipUnSaved) {
        var opened = [];

        var panes = manager.panes;
        var s = panes.length;
        while (s--) {
            var panels = manager.panes[s].panels;
            var k = panels.length;
            var p;
            opened[s] = [];
            while (k--) {
                p = panels[k];
                if (p.editor.new)
                    p.editor.remote = null;
                if (p.editor.new || p.editor.changed) {
                    if (skipUnSaved === 2) continue;
                    if (!confirmSave(p)) {
                        if (skipUnSaved) continue;
                        return false;
                    }
                }
                //only save none new and local sourced
                if (!p.editor.new && p.editor.source === 0)
                    opened[s].unshift({
                        file: p.editor.file,
                        remote: p.editor.remote,
                        active: p == manager.panes[s].active
                    });
            }
        }
        return opened;
    }

    function saveSession() {
        let file = saveSessionAs(options.session, true);
        if (file && file.length !== 0)
            options.session = file;
    }

    function saveSessionAs(file) {
        if (!file || file.length === 0)
            file = dialog.showSaveDialogSync({
                title: 'Save session as...',
                defaultPath: options.session ? options.session : parseTemplate(path.join('{data}', 'editor.sess')),
                filters: [
                    { name: 'Session files (*.sess)', extensions: ['sess'] },
                    { name: 'All files (*.*)', extensions: ['*'] },
                ]
            });
        if (file === undefined || file.length === 0)
            return file;
        let _session = {
            opened: getOpened(),
            lastActive: '',
            layout: manager.layout
        };
        if (manager.active && manager.active.editor) {
            if (manager.active.editor.source)
                _session.lastActive = 'remote:' + manager.active.editor.remote;
            else
                _session.lastActive = manager.active.editor.file;
        }
        fs.writeFileSync(file, JSON.stringify(_session));
        return file;
    }

    function openSession(file, replace, silent) {
        if (!file || file.length === 0) return false;
        try {
            if (!fs.statSync(file).isFile()) {
                if (!silent)
                    dialog.showMessageBox({
                        type: 'error',
                        title: 'Invalid session file',
                        message: `Invalid session file.`,
                        defaultId: 1,
                        noLink: true
                    });
                return false;
            }
        }
        catch (err) {
            if (!silent)
                dialog.showMessageBox({
                    type: 'error',
                    title: 'Invalid session file',
                    message: `Invalid session file.`,
                    defaultId: 1,
                    noLink: true
                });
            return false;
        }
        let data = fs.readFileSync(file, 'utf-8');
        if (data.length === 0) {
            if (replace)
                closeAllFiles();
            return true;
        }
        try {
            data = JSON.parse(data);
        }
        catch (e) {
            if (!silent)
                dialog.showMessageBox({
                    type: 'error',
                    title: 'Error opening session file',
                    message: `Error opening session file: ${file}.`,
                    defaultId: 1,
                    noLink: true
                });
            return false;
        }
        let last;
        if (manager.active && manager.active.editor) {
            if (manager.active.editor.source)
                last = findEditor('remote:' + manager.active.editor.remote_);
            else
                last = findEditor(manager.active.editor.file);
        }
        if (replace) {
            closeAllFiles();
            //if could not close files double check in case some files got left open
            if (data.layout && manager.layout.length <= data.layout.length)
                manager.layout = data.layout;
        }
        else if (data.layout && data.layout.length > manager.layout.length)
            manager.layout = data.layout;
        if (!data.opened) return true;
        let l = data.opened.length;
        while (l--)
            openFiles(data.opened[l], false, manager.panes[l]);

        if (replace || !last)
            last = findEditor(data.lastActive);
        if (last) {
            manager.focusPane(last.dock);
            last.dock.switchToPanel(last.id);
        }
        addToRecentSessions(file);
        return true;
    }

    function openSessionFile(replace) {
        dialog.showOpenDialog({
            filters: [
                { name: 'Session files (*.sess)', extensions: ['sess'] },
                { name: 'All files (*.*)', extensions: ['*'] },
            ],
            properties: ['openFile'],
            defaultPath: options.session ? options.session : parseTemplate(path.join('{data}', 'editor.sess'))
        }).then(result => {
            if (result.filePaths === undefined || result.filePaths.length === 0) {
                return;
            }
            options.session = result.filePaths[0];
            if (!openSession(options.session, replace))
                options.session = '';
            else {
                menubar.updateItem('sessions|reload previous session', { enabled: true });
                menubar.updateItem('sessions|replace with previous session', { enabled: true });
            }
        });
    }

    function savedOpened() {
        if (!options) loadOptions();
        let opened = getOpened();
        if (!opened) return false;
        if (options.reopen)
            options.opened = opened;
        else
            options.opened = [];
        options.layout = manager.layout;
        if (manager.active && manager.active.editor) {
            if (manager.active.editor.source)
                options.lastActive = 'remote:' + manager.active.editor.remote;
            else
                options.lastActive = manager.active.editor.file;
        }
        else
            options.lastActive = '';
        saveOptions();
        return true;
    }

    function addToRecentSessions(file) {
        if (!options) loadOptions();
        if (!options.recentSessions) options.recentSessions = [];
        var recent = [];
        var r = options.recentSessions.length;
        while (r--) {
            if (options.recentSessions[r] !== file)
                recent.unshift(options.recentSessions[r]);
        }
        recent.unshift(file);
        if (recent.length > options.maxRecent)
            options.recentSessions = recent.slice(0, options.maxRecent);
        else
            options.recentSessions = recent;
        doUpdate(272);
    }

    //addToRecentSessions(_recent[r].file, _recent[r].remoteFile);
    async function buildRecentSessions() {
        var menu = [];
        var rmenu = [];
        var r = 0;
        if (options.recentSessions)
            r = options.recentSessions.length;
        while (r--) {
            menu.unshift(
                {
                    label: options.recentSessions[r],
                    idx: r,
                    click: (item) => {
                        if (!existsSync(options.recentSessions[item.idx])) {
                            dialog.showMessageBox({
                                type: 'info',
                                title: 'Path does not exist',
                                message: 'The path \'' + options.recentSessions[item.idx] + '\' does not seem to exist anymore on disk.'
                            });
                            options.recentSessions.splice(item.idx, 1);
                            doUpdate(272);
                        }
                        else
                            openSession(options.recentSessions[item.idx]);
                    }
                }
            );
            rmenu.unshift(
                {
                    label: options.recentSessions[r],
                    idx: r,
                    click: (item) => {
                        if (!existsSync(options.recentSessions[item.idx])) {
                            dialog.showMessageBox({
                                type: 'info',
                                title: 'Path does not exist',
                                message: 'The path \'' + options.recentSessions[item.idx] + '\' does not seem to exist anymore on disk.'
                            });
                            options.recentSessions.splice(item.idx, 1);
                            doUpdate(272);
                        }
                        else
                            openSession(options.recentSessions[item.idx], true);
                    }
                }
            );
        }
        if (menu.length > 0) {
            menu.push({ type: 'separator' });
            menu.push({
                label: 'Clear Recently Opened',
                click: () => {
                    options.recentSessions = [];
                    doUpdate(272);
                }
            });
            rmenu.push({ type: 'separator' });
            rmenu.push({
                label: 'Clear Recently Opened',
                click: () => {
                    options.recentSessions = [];
                    doUpdate(272);
                }
            });
        }
        menubar.updateItem('sessions|open recent session', { submenu: menu });
        menubar.updateItem('sessions|replace with recent session', { submenu: rmenu });
    }


    // eslint-disable-next-line no-unused-vars
    function closeHidden(hidden) {
        if (!hidden) return;
        /*
        var dialogs = document.body.getElementsByTagName('dialog');
        var e = 0, el = dialogs.length;
        for (; e < el; e++) {
            if (dialogs[e].open) {
                if (dialog.showMessageBoxSync({
                    type: 'question',
                    title: 'Open dialog',
                    message: (dialogs[e].dataset.title || 'Dialog') + ' is open, exit?',
                    buttons: ['Yes', 'No'],
                    defaultId: 1,
                        noLink: true
                }) === 1)
                    return false;
            }
        }
        if (!savedOpened())
            return false;
            */
        return true;
    }

    function closeable(all) {
        if (!$closeWindow) {
            for (key in _windows) {
                //if not a property, not defined, or closed skip
                if (!Object.prototype.hasOwnProperty.call(_windows, key) || !_windows[key] || _windows[key].closed)
                    continue;
                dialog.showMessageBox({
                    type: 'error',
                    title: _windows[key].document.title + ' dialog open',
                    message: `You must close the ${_windows[key].document.title} dialog before you can close code editor.`,
                    defaultId: 1,
                    noLink: true
                });
                _windows[key].focus();
                $closeWindow = false;
                return false;
            }
            if (document.activeElement)
                document.activeElement.blur();
            var dialogs = document.body.getElementsByTagName('dialog');
            var e = 0, el = dialogs.length;
            for (; e < el; e++) {
                if (dialogs[e].open) {
                    if (dialog.showMessageBoxSync({
                        type: 'question',
                        title: 'Open dialog',
                        message: (dialogs[e].dataset.title || 'Dialog') + ' is open, exit?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                        noLink: true
                    }) === 1) {
                        $closeWindow = false;
                        return false;
                    }
                }
            }
            if (!savedOpened())
                $closeWindow = false;
            else
                $closeWindow = true;
        }
        return $closeWindow;
    }

    if (!window.opener) {
        let _close = false;
        window.onbeforeunload = (e) => {
            if (_close) return;
            setTimeout(() => {
                if (!closeable()) return 'no';
                cleanUp();
                _close = true;
                window.close();
            });
            e.returnValue = false;
            return 'no';
        };
    }
    else
        window.onbeforeunload = cleanUp;

    function cleanUp(e) {
        //clean up
        if (window.opener) {
            if (window.opener.client.getOption('codeEditor.persistent')) {
                window.hide();
                e.returnValue = false;
                return 'no';
            }
            window.opener.client.off('received-GMCP', processGMCP);
            window.opener.client.off('connected', clientConnected);
            window.opener.client.off('closed', clientClosed);
            window.opener._status.off('set-title', setTitle);
            window.opener.removeEventListener('loadCharacter', updateCharacter);
            window.opener.removeEventListener('updateCharacter', updateCharacter);
            window.opener.removeEventListener('resetCharacter', updateCharacter);
        }
        var keys = Object.keys(_editors);
        var p = keys.length;
        while (p--)
            closeEditor(_editors[keys[p]]);
        if (watcher)
            watcher.close();
    }

    function skipSaveWindow() {
        if (window.opener) {
            if (window.opener.client.getOption('codeEditor.persistent'))
                return false;
            //if not visible do not save this window as it was probably preserved due to a setting change
            return !window.isVisible();
        }
        return false;
    }

    ipcRenderer.on('progress', (event, ...args) => {
        //already done so just close it
        if (!_windows['progress.html']) {
            ipcRenderer.send('progress', 'close');
            window.setProgressBar(-1);
        }
        if (args[0] === 'canceled' || args[0] === 'closed') {
            delete _windows['progress.html'];
            if (manager.active && manager.active.editor && manager.active.editor.cancel)
                manager.active.editor.cancel();
        }
    });

    ipcRenderer.on('open-editor', (event, file, remoteFile, remoteEdit) => {
        openEditor(file, remoteFile, remoteEdit);
    });

    function openEditor(file, remoteFile, remoteEdit) {
        if (_loading) {
            if (!_open)
                _open = [];
            if (Array.isArray(file))
                _open = _open.concat(file.map(m => {
                    if (Array.isArray(m))
                        return m;
                    if (typeof m === 'string')
                        return [m];
                    return [m.file || m.path, m.remote, m.remoteEdit];
                }));
            else
                _open.push([file, remoteFile, remoteEdit]);
        }
        else if (Array.isArray(file))
            openFiles(file.map(m => {
                if (Array.isArray(m)) {
                    if (m.length === 3)
                        return { file: m[0], remote: m[1], remoteEdit: m[2] };
                    if (m.length === 2)
                        return { file: m[0], remote: m[1] };
                    return { file: m[0] };
                }
                if (typeof m === 'string')
                    return { file: m };
                return m;
            }));
        else if (typeof file !== 'string')
            openFile(file.file || file.path, file.remote, null, file.remoteEdit);
        else
            openFile(file, remoteFile, null, remoteEdit);
    }

    function updateValue(text) {
        if (_windows['editor.html'] && _windows['editor.html'].callBack) {
            if (!_windows['editor.html'].closed)
                _windows['editor.html'].callBack(text);
        }
        else if (($dialogs.monster && $dialogs.monster.open) || ($dialogs.room && $dialogs.room.open)) {
            if ((document.activeElement.tagName === 'INPUT' && document.activeElement.type === 'text') || document.activeElement.tagName === 'TEXTAREA')
                document.activeElement.value = text;
            else {
                var el = document.activeElement.closest('.wizard');
                el = el.querySelector('.wizard-page textarea,.wizard-page input[type="text"]');
                if (el)
                    el.value = text;
            }
        }
        else
            manager.active.editor.insert(text);
    }

    function processGMCP(mod, obj) {
        if (options && options.debug)
            console.log({ mod: mod, obj, obj });
        if (_ied)
            _ied.processGMCP(mod, obj);
    };

    function clientConnected() {
        connected = true;
        menubar.updateItem('file|diff|remote...', { enabled: manager.active && manager.active.editor && manager.active.editor.supports('diff') });
        menubar.updateItem('file|upload', { enabled: manager.active && manager.active.editor && manager.active.editor.supports('upload') });
        menubar.updateItem('file|upload as...', { enabled: manager.active && manager.active.editor && manager.active.editor.supports('upload-as') });
        $('#btn-upload').prop('disabled', !(connected && manager.active && manager.active.editor && manager.active.editor.supports('upload')));
        $('#btn-upload-as').prop('disabled', !(connected && manager.active && manager.active.editor && manager.active.editor.supports('upload-as')));
        document.getElementById('btn-open-remote').removeAttribute('disabled');
        menubar.updateItem('file|open remote...', { enabled: connected });
        $('.connected').prop('disabled', !(connected && manager.active && manager.active.editor));
        if (manager.active && manager.active.editor)
            manager.active.editor.update('menu', menubar, connected);
    };
    function clientClosed() {
        connected = false;
        menubar.updateItem('file|diff|remote...', { enabled: false });
        menubar.updateItem('file|upload', { enabled: false });
        menubar.updateItem('file|upload as...', { enabled: false });
        $('#btn-upload').prop('disabled', true);
        $('#btn-upload-as').prop('disabled', true);
        document.getElementById('btn-open-remote').setAttribute('disabled', 'true');
        menubar.updateItem('file|open remote...', { enabled: false });
        $('.connected').prop('disabled', true);
        if (manager.active && manager.active.editor)
            manager.active.editor.update('menu', menubar, connected);
    };

    function reloadOptions() {
        loadOptions();
        var keys = Object.keys(_editors);
        var k = keys.length;
        var p;
        while (k--) {
            p = keys[k];
            if (_editors[p].editor.type === 1) {
                _editors[p].editor.options = options.modelOptions;
                _editors[p].editor.spellcheck = options.spellchecking;
                _editors[p].spellcheck = options.spellchecking;
                manager.setPanelIconClass(getFileIcon(_editors[p].editor.file), _editors[p]);
                if (options.nativeIcons)
                    ipcRenderer.invoke('get-app', 'getFileIconDataUrl', (path.extname(_editors[p].editor.file).length !== 0 ? _editors[p].editor.file : '.*'), { size: 'small' }).then(icon => {
                        if (!icon) return;
                        manager.setPanelIcon(icon, _editors[p]);
                    });
            }
            else if (_editors[p].editor.type === 2)
                _editors[p].editor.options = options.virtualOptions;

        }
    };

    function newFile(file, remoteFile) {
        createEditor({ file: file || 'new_' + newCounter + '.c', new: true, remote: remoteFile }, true);
        newCounter++;
        doUpdate(1);
        updatePanel(manager.active);
    }

    function newFromFile(file, name, remoteFile) {
        if (!file || file.length === 0) return;
        var value = parseFileTemplate(fs.readFileSync(file, 'utf8'));
        createEditor({ file: 'new_' + name.replace(/\s/g, '_') + '_' + newCounter + '.c', new: true, value: value, remote: remoteFile }, true);
        newCounter++;
        doUpdate(1);
        updatePanel(manager.active);
    }

    function newFromValue(value, file, remoteFile) {
        if (!file || file.length === 0) {
            file = 'new_' + name.replace(/\s/g, '_') + '_' + newCounter + '.c';
            newCounter++;
        }
        createEditor({ file: file, new: true, value: parseFileTemplate(value || ''), remote: remoteFile }, true);
        doUpdate(1);
        updatePanel(manager.active);
    }

    async function newFromValueFormatted(value, file, remoteFile) {
        try {
            value = await formatCode(value);
        }
        catch (e) {
            logOutput(`Message: ${e.message}\nFile: ${file}\nLine: ${e.line + 1}\nColumn: ${e.col + 1}`);
        }
        newFromValue(value, file, remoteFile);
    }

    function parseFileTemplate(template, data) {
        if (!template || template.length === 0) return template;
        if (!data) data = baseParseData();
        var d;
        for (d in data) {
            if (!Object.prototype.hasOwnProperty.call(data, d))
                continue;
            if (data[d].regex)
                template = template.replace(data[d].regex, data[d].value);
            else
                template = template.replace(new RegExp('{' + d + '}', 'g'), data[d]);
        }
        return template;
    }

    function baseParseData() {
        var character = 'Unknown';
        if (window.opener)
            character = capitalize(window.opener.getCharacterName() || character);
        return {
            'your name': character,
            'character': character,
            'name': character,
            'date': moment().format('YYYY-MM-DD')
        };
    }

    function newArea(title, ok, name) {
        if (!$dialogs.area) {
            $dialogs.area = {
                dialog: document.getElementById('new-area'),
                path: document.getElementById('new-area-path'),
                remote: document.getElementById('new-area-remote-path')
            };
            $('#btn-new-area-path').on('click', () => {
                dialog.showOpenDialog({
                    defaultPath: $dialogs.area.path.value,
                    properties: ['openDirectory', 'createDirectory']
                }).then(result => {
                    if (result.filePaths === undefined || result.filePaths.length === 0) {
                        return;
                    }
                    $dialogs.area.path.value = result.filePaths[0];
                });
            });
            $('#btn-new-area-remote-path').on('click', () => {
                showBrowseDialog({
                    defaultFile: $dialogs.area.remote.value || (manager.active ? (manager.active.editor.remote || options.uploadAs || (options.remote + "/" + path.basename(manager.active.editor.file))) : options.uploadAs),
                    title: 'Select remote folder',
                    properties: ['openDirectory']
                }, (files) => {
                    if (!files || files.length === 0) return;
                    $dialogs.area.remote.value = files[0];
                });
            });
            $('#new-area-name').on('change', () => {
                var data = baseParseData();
                $('#help-new-area-remote-path').text(`/realms/${data.name.toLowerCase()}/${$('#new-area-name').val().toLowerCase() || '{area name}'}` || '/realms/{character}/{area name}');
            });
            $('#new-area-name').on('keyup', () => {
                var data = baseParseData();
                $('#help-new-area-remote-path').text(`/realms/${data.name.toLowerCase()}/${$('#new-area-name').val().toLowerCase() || '{area name}'}` || '/realms/{character}/{area name}');
            })
        }
        $dialogs.area.ok = ok;
        $dialogs.area.dialog.dataset.title = title || 'Create new area...';
        var data = baseParseData();
        $('#help-new-area-remote-path').text(`/realms/${data.name.toLowerCase()}/${name.toLowerCase() || '{area name}'}` || '/realms/{character}/{area name}');
        $('#new-area-title').text(title || 'Create new area...');
        $('#new-area *').attr('disabled', false);
        $('#btn-new-area-remote-path').attr('disabled', !connected);

        var p = $('#new-area-path').parent().parent();
        p.removeClass('has-error');
        p.removeClass('has-feedback');
        $('button', p).removeClass('btn-danger');
        p = $('#new-area-name').parent();
        p.removeClass('has-error');
        p.removeClass('has-feedback');
        $('#new-area-path').val(options.browse || ((manager.active && manager.active.editor) ? path.dirname(manager.active.editor.file) : (options.recent && options.recent.length ? path.dirname(options.recent[0].file) : '')));
        $('#new-area-name').val(name || '');
        menubar.enabled = false;
        document.getElementById('new-area').showModal();
    }

    // eslint-disable-next-line no-unused-vars
    function createArea() {
        var p;
        p = $('#new-area-path').parent().parent();
        p.removeClass('has-error');
        p.removeClass('has-feedback');
        $('button', p).removeClass('btn-danger');
        p = $('#new-area-name').parent();
        p.removeClass('has-error');
        p.removeClass('has-feedback');
        if (!existsSync($('#new-area-path').val())) {
            p = $('#new-area-path').parent().parent();
            p.addClass('has-error');
            p.addClass('has-feedback');
            $('button', p).addClass('btn-danger');
            p.find('.form-error').html('<small class="text-error"><span class=\'sr-only\'>Error:</span>Path does not exist</small>');
            $('#new-area-path').focus();
            return;
        }
        if (!isDirSync($('#new-area-path').val())) {
            p = $('#new-area-path').parent();
            p.addClass('has-error');
            p.addClass('has-feedback');
            $('button', p).addClass('btn-danger');
            p.find('.form-error').html('<small class="text-error"><span class=\'sr-only\'>Error:</span>Invalid path</small>');
            $('#new-area-path').focus();
            return;
        }
        if (!validName($('#new-area-name').val())) {
            p = $('#new-area-name').parent();
            p.addClass('has-error');
            p.addClass('has-feedback');
            p.find('.form-error').html('<small class="text-error"><span class=\'sr-only\'>Error:</span>Invalid, can only contain letters, numbers, and _</small>');
            $('#new-area-name').focus();
            return;
        }
        var aPath = path.join($('#new-area-path').val(), $('#new-area-name').val());
        if (existsSync(aPath)) {
            p = $('#new-area-path').parent().parent();
            p.addClass('has-error');
            p.addClass('has-feedback');
            $('button', p).addClass('btn-danger');
            p.find('.form-error').html('<small class="text-error"><span class=\'sr-only\'>Error:</span>Directory with area name already exist</small>');
            $('#new-area-path').focus();
            return;
        }
        options.browse = $('#new-area-path').val();
        doUpdate(16);
        var data;
        $('#new-area *').attr('disabled', true);
        if ($dialogs.area.ok) {
            data = baseParseData();
            data.area = $('#new-area-name').val();
            data.path = $('#new-area-remote-path').val() || '/realms/' + data.name.toLowerCase() + '/' + $('#new-area-name').val().toLowerCase();
            if (data.path.endsWith('/'))
                data.path = data.path.substr(0, data.path.length - 1);
            if (!data.path.startsWith('/'))
                data.path = '/' + data.path;
            $dialogs.area.ok(aPath, data);
            document.getElementById('new-area').close();
            if (manager.active && manager.active.editor) manager.active.editor.focus();
            return;
        }
        var templatePath = parseTemplate(path.join('{assets}', 'templates', 'wizards', 'area'));
        var template = walkSync(templatePath);
        var templateRegex = new RegExp('^' + templatePath.replace(/\\/g, '\\\\'));
        var c = 0;
        var cl = template.dirs.length;
        fs.mkdirSync(aPath);
        for (; c < cl; c++)
            fs.mkdirSync(template.dirs[c].replace(templateRegex, aPath));
        c = 0;
        cl = template.files.length;
        data = baseParseData();
        data.area = $('#new-area-name').val();
        data.path = $('#new-area-remote-path').val() || '/realms/' + data.name.toLowerCase() + '/' + $('#new-area-name').val().toLowerCase();
        if (data.path.endsWith('/'))
            data.path = data.path.substr(0, data.path.length - 1);
        if (!data.path.startsWith('/'))
            data.path = '/' + data.path;
        var value;
        var file;
        var files = [];
        for (; c < cl; c++) {
            value = fs.readFileSync(template.files[c], 'utf8');
            value = parseFileTemplate(value, data);
            file = template.files[c].replace(templateRegex, aPath);
            writeFile(file, value);
            if (['.c', '.h', '.map'].indexOf(path.extname(file)) !== -1)
                files.push({
                    file: file,
                    remote: template.files[c].replace(templateRegex, data.path).replace(/\\/g, '/')
                });
        }
        openFiles(files);
        document.getElementById('new-area').close();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function validName(name) {
        if (!name || name.length === 0)
            return false;
        if (!name.match(/^[a-zA-Z0-9_]+$/g))
            return false;
        return true;
    }

    // eslint-disable-next-line no-unused-vars
    function newVirtualArea() {
        if (!$dialogs.virtualArea) {
            $dialogs.virtualArea = {
                dialog: document.getElementById('new-virtual-area')
            };
            $('#btn-new-virtual-area-path').on('click', () => {
                dialog.showOpenDialog({
                    defaultPath: $('#new-virtual-area-path').val(),
                    properties: ['openDirectory', 'createDirectory']
                }).then(result => {
                    if (result.filePaths === undefined || result.filePaths.length === 0) {
                        return;
                    }
                    $('#new-virtual-area-path').val(result.filePaths[0]);
                });
            });
            $('#btn-new-virtual-area-remote-path').on('click', () => {
                showBrowseDialog({
                    defaultFile: manager.active ? (manager.active.editor.remote || options.uploadAs || (options.remote + "/" + path.basename(manager.active.editor.file))) : options.uploadAs,
                    title: 'Select remote folder',
                    properties: ['openDirectory']
                }, (files) => {
                    if (!files || files.length === 0) return;
                    document.getElementById('new-virtual-area-remote-path').value = files[0];
                });
            });

            $('#eNone').on('change', function (e) {
                $('#new-virtual-area-default-exits input[id^="de"]').prop('checked', false);
                if (!this.checked) {
                    e.preventDefault();
                    $('#eNone').prop('checked', true);
                    $('.btn-group input').parent().removeClass('active');
                    $('.btn-group input:checked').parent().addClass('active');
                    return false;
                }
                $('.btn-group input').parent().removeClass('active');
                $('.btn-group input:checked').parent().addClass('active');
            });

            $('#new-virtual-area-default-exits input[id^="de"]').on('change', function () {
                $('#eNone').prop('checked', false);
                $('.btn-group input').parent().removeClass('active');
                $('.btn-group input:checked').parent().addClass('active');
            });

            $('#sNone').on('change', function (e) {
                $('#new-virtual-area-default-states input[id^="ds"]').prop('checked', false);
                if (!this.checked) {
                    e.preventDefault();
                    $('#sNone').prop('checked', true);
                    $('.btn-group input').parent().removeClass('active');
                    $('.btn-group input:checked').parent().addClass('active');
                    return false;
                }
                $('.btn-group input').parent().removeClass('active');
                $('.btn-group input:checked').parent().addClass('active');
            });

            $('#new-virtual-area-default-states input[id^="ds"]').on('change', function () {
                $('#sNone').prop('checked', false);
                $('.btn-group input').parent().removeClass('active');
                $('.btn-group input:checked').parent().addClass('active');
            });
            $('#new-virtual-area-depth').on('change input keypress', () => {
                var value = +$('#new-virtual-area-depth').val();
                if (value <= 1) {
                    $('#deUp').parent().addClass('disabled');
                    $('#deDown').parent().addClass('disabled');
                    $('#dsSinkingUp').parent().addClass('disabled');
                    $('#dsSinkingDown').parent().addClass('disabled');
                    $('#deUp').prop('checked', false);
                    $('#deDown').prop('checked', false);
                    $('#dsSinkingUp').prop('checked', false);
                    $('#dsSinkingDown').prop('checked', false);
                }
                else {
                    $('#deUp').parent().removeClass('disabled');
                    $('#deDown').parent().removeClass('disabled');
                    $('#dsSinkingUp').parent().removeClass('disabled');
                    $('#dsSinkingDown').parent().removeClass('disabled');
                }
            });
            $('#new-virtual-area-area').on('change', () => {
                var data = baseParseData();
                $('#help-new-virtual-area-remote-path').text(`/realms/${data.name.toLowerCase()}/${$('new-virtual-area-area').val().toLowerCase() || '{area name}'}` || '/realms/{character}/{area name}');
            });
            $('#new-virtual-area-area').on('keyup', () => {
                var data = baseParseData();
                $('#help-new-virtual-area-remote-path').text(`/realms/${data.name.toLowerCase()}/${$('#new-virtual-area-area').val().toLowerCase() || '{area name}'}` || '/realms/{character}/{area name}');
            })
        }
        var data = baseParseData();
        $('#help-new-virtual-area-remote-path').text(`/realms/${data.name.toLowerCase()}/${name.toLowerCase() || '{area name}'}` || '/realms/{character}/{area name}');
        $('#new-virtual-area *').attr('disabled', false);
        $('#new-virtual-area .nav-tabs a[href="#general"]').tab('show');
        $('#btn-new-virtual-area-remote-path').attr('disabled', !connected);
        $('#new-virtual-area-remote-path').val('');
        $('#new-virtual-area-default-exits .btn-group input:checked').prop('checked', false);
        $('#new-virtual-area-default-states .btn-group input:checked').prop('checked', false);
        $('#sNone').prop('checked', true);
        $('#deNorth').prop('checked', true);
        $('#deEast').prop('checked', true);
        $('#deSouth').prop('checked', true);
        $('#deWest').prop('checked', true);
        $('#deUp').parent().addClass('disabled');
        $('#deDown').parent().addClass('disabled');
        $('#dsSinkingUp').parent().addClass('disabled');
        $('#dsSinkingDown').parent().addClass('disabled');
        $('#new-virtual-area-path').val(options.browse || ((manager.active && manager.active.editor) ? path.dirname(manager.active.editor.file) : (options.recent && options.recent.length ? path.dirname(options.recent[0].file) : '')));
        $('#new-virtual-area-area').val('');
        $('#new-virtual-area-area-enabled').prop('checked', false);
        $('#new-virtual-area-area-enabled').change();
        $('#new-virtual-area-width').val('2');
        $('#new-virtual-area-height').val('2');
        $('#new-virtual-area-depth').val('1');
        $('#new-virtual-area-coordinates').prop('checked', false);
        $('#new-virtual-area-cache').val('200');
        $('.btn-group input').parent().removeClass('active');
        $('.btn-group input:checked').parent().addClass('active');

        var p = $('#new-virtual-area-path').parent().parent();
        p.removeClass('has-error');
        p.removeClass('has-feedback');
        $('button', p).removeClass('btn-danger');
        p = $('#new-virtual-area-area').parent().parent();
        p.removeClass('has-error');
        p.removeClass('has-feedback');

        menubar.enabled = false;
        document.getElementById('new-virtual-area').showModal();
    }

    // eslint-disable-next-line no-unused-vars
    function createVirtualArea() {
        var p;
        p = $('#new-virtual-area-path').parent().parent();
        p.removeClass('has-error');
        p.removeClass('has-feedback');
        $('button', p).removeClass('btn-danger');
        p = $('#new-virtual-area-name').parent();
        p.removeClass('has-error');
        p.removeClass('has-feedback');
        if (!existsSync($('#new-virtual-area-path').val())) {
            p = $('#new-virtual-area-path').parent().parent();
            p.addClass('has-error');
            p.addClass('has-feedback');
            $('button', p).addClass('btn-danger');
            p.find('.form-error').html('<small class="text-error"><span class=\'sr-only\'>Error:</span>Path does not exist</small>');
            $('#new-virtual-area-path').focus();
            return;
        }
        if (!isDirSync($('#new-virtual-area-path').val())) {
            p = $('#new-virtual-area-path').parent();
            p.addClass('has-error');
            p.addClass('has-feedback');
            $('button', p).addClass('btn-danger');
            p.find('.form-error').html('<small class="text-error"><span class=\'sr-only\'>Error:</span>Invalid path</small>');
            $('#new-virtual-area-path').focus();
            return;
        }
        if (!$('#new-virtual-area-area-enabled').prop('checked') && existsSync(path.join($('#new-virtual-area-path').val(), 'virtual'))) {
            p = $('#new-virtual-area-path').parent().parent();
            p.addClass('has-error');
            p.addClass('has-feedback');
            $('button', p).addClass('btn-danger');
            p.find('.form-error').html('<small class="text-error"><span class=\'sr-only\'>Error:</span>Path already contains a virtual server</small>');
            $('#new-virtual-area-path').focus();
            return;
        }
        var templatePath;
        var aPath = $('#new-virtual-area-path').val();
        var data = baseParseData();
        if ($('#new-virtual-area-area-enabled').prop('checked')) {
            if (!validName($('#new-virtual-area-area').val())) {
                p = $('#new-virtual-area-area').parent().parent();
                p.addClass('has-error');
                p.addClass('has-feedback');
                p.find('.form-error').html('<small class="text-error"><span class=\'sr-only\'>Error:</span>Invalid, can only contain letters, numbers, and _</small>');
                $('#new-virtual-area-area').focus();
                return;
            }
            aPath = path.join(aPath, $('#new-virtual-area-area').val());
            if (existsSync(aPath)) {
                p = $('#new-virtual-area-area').parent().parent();
                p.addClass('has-error');
                p.addClass('has-feedback');
                $('button', p).addClass('btn-danger');
                p.find('.form-error').html('<small class="text-error"><span class=\'sr-only\'>Error:</span>Directory with area name already exist</small>');
                $('#new-virtual-area-area').focus();
                return;
            }
            $('#new-area *').attr('disabled', true);
            templatePath = parseTemplate(path.join('{assets}', 'templates', 'wizards', 'virtual_area'));
            fs.mkdirSync(aPath);
            data.area = $('#new-virtual-area-area').val();
        }
        else {
            $('#new-area *').attr('disabled', true);
            templatePath = parseTemplate(path.join('{assets}', 'templates', 'wizards', 'virtual_server'));
            data.area = path.basename(aPath);
        }
        data.path = $('#new-virtual-area-remote-path').val() || '/realms/' + data.name.toLowerCase() + '/' + data.area.toLowerCase();
        if (data.path.endsWith('/'))
            data.path = data.path.substr(0, data.path.length - 1);
        if (!data.path.startsWith('/'))
            data.path = '/' + data.path;

        options.browse = $('#new-area-path').val();
        doUpdate(16);
        var template = walkSync(templatePath);
        var templateRegex = new RegExp('^' + templatePath.replace(/\\/g, '\\\\'));
        var c = 0;
        var cl = template.dirs.length;
        for (; c < cl; c++)
            fs.mkdirSync(template.dirs[c].replace(templateRegex, aPath));
        c = 0;
        cl = template.files.length;
        var value;
        var file;
        var files = [];

        for (; c < cl; c++) {
            value = fs.readFileSync(template.files[c], 'utf8');
            data.wizard = '';
            if (template.files[c].endsWith('server.c')) {
                if ($('#new-virtual-area-coordinates').prop('checked'))
                    data.wizard += '   set_coords(1);\n';
                if ($('#new-virtual-area-cache').val() !== '200') {
                    data.wizard += '   set_cache_size(' + $('#new-virtual-area-cache').val() + ');\n';
                }
            }
            else if (template.files[c].endsWith('virtual.map'))
                data.wizard = buildNewVirtualMap(+$('#new-virtual-area-width').val(), +$('#new-virtual-area-height').val(), +$('#new-virtual-area-depth').val(), Array.from(document.querySelectorAll('#new-virtual-area-default-exits input:checked')).map(f => +f.value).reduce((a, c) => a | c), Array.from(document.querySelectorAll('#new-virtual-area-default-states input:checked')).map(f => +f.value).reduce((a, c) => a | c));
            else if (template.files[c].endsWith('virtual.state'))
                data.wizard = buildNewVirtualMapStates(+$('#new-virtual-area-width').val(), +$('#new-virtual-area-height').val(), +$('#new-virtual-area-depth').val(), Array.from(document.querySelectorAll('#new-virtual-area-default-states input:checked')).map(f => +f.value).reduce((a, c) => a | c));
            else if (template.files[c].endsWith('virtual.terrain'))
                data.wizard = buildNewVirtualMapStates(+$('#new-virtual-area-width').val(), +$('#new-virtual-area-height').val(), +$('#new-virtual-area-depth').val(), '00');
            value = parseFileTemplate(value, data);
            file = template.files[c].replace(templateRegex, aPath);
            writeFile(file, value);
            if (['.c', '.h', '.map'].indexOf(path.extname(file)) !== -1)
                files.push({
                    file: file,
                    remote: template.files[c].replace(templateRegex, data.path).replace(/\\/g, '/')
                });
        }
        openFiles(files);
        document.getElementById('new-virtual-area').close();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function newAreaDesign() {
        if (!$dialogs.design) {
            $dialogs.design = {
                dialog: document.getElementById('new-design')
            };
        }
        $('#new-design-width').val('25');
        $('#new-design-height').val('25');
        $('#new-design-depth').val('1');
        menubar.enabled = false;
        document.getElementById('new-design').showModal();
    }

    // eslint-disable-next-line no-unused-vars
    function createAreaDesign(file, width, height, depth) {
        width = width || +$('#new-design-width').val() || 25;
        height = height || +$('#new-design-height').val() || 25;
        depth = depth || +$('#new-design-depth').val() || 1;
        createEditor({ file: file || 'new_design_' + newCounter + '.design', width: width, height: height, depth: depth, new: true }, true);
        newCounter++;
        doUpdate(1);
        updatePanel(manager.active);
        document.getElementById('new-design').close();
    }

    function buildNewVirtualMap(width, height, depth, exits, states) {
        var f = width + ' ' + height;
        if (depth > 1) f += ' ' + depth;
        f += '\n';
        if (states)
            states = ':0:0:' + states;
        else
            states = '';
        for (var z = 0; z < depth; z++) {
            var lExits = exits;
            if (z === 0)
                lExits = lExits & ~256;
            else if (z === depth - 1)
                lExits = lExits & ~512;
            var te = lExits & ~128 & ~64 & ~1;
            var be = lExits & ~16 & ~8 & ~4;
            var m = (te & ~4 & ~2) + states + ' ';
            if (width > 2) m += Array(width - 1).join(te + states + ' ');
            m += (te & ~32 & ~16) + states;
            m += '\n';
            for (var y = 1; y < height - 1; y++) {
                m += (lExits & ~4 & ~2 & ~1) + states + ' ';
                if (width > 2) m += Array(width - 1).join(lExits + states + ' ');
                m += (lExits & ~64 & ~32 & ~16) + states;
                m += '\n';
            }
            m += (be & ~2 & ~1) + states + ' ';
            if (width > 2) m += Array(width - 1).join(be + states + ' ');
            m += (be & ~64 & ~32 & ~16) + states;
            m += '\n';

            f += m + '\n';
        }
        return f;
    }

    function buildNewVirtualMapStates(width, height, depth, states) {
        var f = width + ' ' + height;
        if (depth > 1) f += ' ' + depth;
        f += '\n';
        if (!states)
            states = '00';
        var m = states + ' ';
        if (width > 2) m += Array(width - 1).join(states + ' ');
        m += states;
        m += '\n';
        for (var y = 1; y < height - 1; y++) {
            m += states + ' ';
            if (width > 2) m += Array(width - 1).join(states + ' ');
            m += states;
            m += '\n';
        }
        m += states + ' ';
        if (width > 2) m += Array(width - 1).join(states + ' ');
        m += states;
        m += '\n';
        for (var z = 0; z < depth; z++) f += m + '\n';
        return f;
    }

    function roomWizard(dData, opts) {
        if (!$dialogs.room) {
            $dialogs.roomExitPage = new WizardDataGridPage({
                title: 'Exits',
                id: 'room-wiz-exits',
                clipboard: 'jiMUD/',
                columns: [
                    {
                        label: 'Exit',
                        field: 'exit',
                        width: 150,
                        editor: {
                            type: EditorType.dropdown,
                            options: {
                                container: '#room-wizard',
                                data: [
                                    'north',
                                    'northeast',
                                    'east',
                                    'southeast',
                                    'south',
                                    'southwest',
                                    'west',
                                    'northwest',
                                    'out',
                                    'enter',
                                    'up',
                                    'down',
                                    'portal',
                                    'swim',
                                    'dive',
                                    'surface'
                                ]
                            }
                        }
                    },
                    {
                        label: 'Destination',
                        field: 'dest',
                        width: 300,
                        spring: true,
                        editor: {
                            type: EditorType.custom,
                            editor: FileBrowseValueEditor,
                            show: (prop, value) => {
                                return value;
                            }
                        }
                    },
                    {
                        label: 'Door',
                        field: 'door',
                        width: 150,
                        editor: {
                            type: EditorType.dropdown,
                            options: {
                                container: '#room-wizard',
                                data: [
                                    'door',
                                    'doors',
                                    'gate',
                                    'gates'
                                ]
                            }
                        }
                    },
                    {
                        label: 'Key ID',
                        field: 'key',
                        width: 200,
                        editor: {
                            options: {
                                container: '#room-wizard',
                                singleLine: true
                            }
                        }
                    },
                    {
                        label: 'Hidden',
                        field: 'hidden',
                        width: 60
                    },
                    {
                        label: 'Blocker',
                        field: 'blocker',
                        width: 200,
                        spring: true,
                        editor: {
                            options: {
                                container: '#room-wizard',
                                singleLine: true
                            }
                        }
                    },
                    {
                        label: 'Prevent peer',
                        field: 'peer',
                        width: 200,
                        spring: true,
                        editor: {
                            options: {
                                container: '#room-wizard',
                                singleLine: true
                            }
                        }
                    },
                    {
                        label: 'Destination Door',
                        field: 'destDoor',
                        width: 200,
                        editor: {
                            type: EditorType.dropdown,
                            options: {
                                container: '#room-wizard',
                                data: [
                                    'door',
                                    'doors',
                                    'gate',
                                    'gates'
                                ]
                            }
                        }
                    },
                    {
                        label: 'Locked',
                        field: 'locked',
                        width: 60
                    },
                    {
                        label: 'Closed',
                        field: 'closed',
                        width: 60
                    },
                    {
                        label: 'Climb',
                        field: 'climb',
                        width: 60
                    },
                    {
                        label: 'Climbing Difficulty',
                        field: 'diff',
                        width: 130
                    }
                ],
                add: (e) => {
                    e.data = {
                        exit: '',
                        dest: '',
                        door: '',
                        key: '',
                        hidden: false,
                        blocker: '',
                        peer: '',
                        destDoor: '',
                        locked: false,
                        closed: true,
                        climb: false,
                        diff: 0,
                    };
                }
            });
            $dialogs.roomExitPage.dataGrid.on('browse-file', e => {
                showBrowseDialog({
                    defaultFile: e.file,
                    title: 'Select remote file',
                    properties: ['openFile'],
                    filters: $fileFilters,
                    arguments: e
                }, (files) => {
                    if (!files || files.length === 0) return;
                    $dialog.options.arguments.editor.value = files[0];
                    $dialog.options.arguments.editor.focus();
                });
            });
            $dialogs.room = new Wizard({
                id: 'room-wizard',
                title: 'Create new room...',
                mode: options.roomWizardMode,
                pages: [
                    new WizardPage({
                        title: 'Welcome',
                        body: document.getElementById('room-wizard-welcome'),
                        reset: e => {
                            e.page.querySelector('#room-wizard-welcome-message').textContent = e.wizard.defaults['room-wiz-welcome-message'] || 'Welcome to the new room wizard, this will take you through the steps to create a room quickly and easily. You may finish at any time to generate a room based on your current selections.';
                        }
                    }),
                    new WizardPage({
                        title: 'General properties',
                        body: document.getElementById('room-wizard-general'),
                        reset: e => {
                            var aTypes = e.page.querySelector('#room-wiz-area-types');
                            aTypes.innerHTML = '';
                            if (e.wizard.defaults['room-wiz-area-types'] && e.wizard.defaults['room-wiz-area-types'].length > 0) {
                                if (Array.isArray(e.wizard.defaults['room-wiz-area-types']))
                                    aTypes.innerHTML = e.wizard.defaults['room-wiz-area-types'].map(r => `<option value="${r.value || r.display}">${r.display || r.value}</option>`).join('');
                                else
                                    aTypes.innerHTML = e.wizard.defaults['room-wiz-area-types'];
                            }
                            else
                                aTypes.innerHTML = '<option value="BASEROOM">Base</option>';
                            $('#room-wiz-type', e.page).selectpicker('refresh').val(e.wizard.defaults['room-wiz-type'] || 'STD_ROOM').selectpicker('render');
                            e.page.querySelector('#room-wiz-terrain').value = e.wizard.defaults['room-wiz-terrain'] || '';
                            e.page.querySelector('#room-wiz-short').value = e.wizard.defaults['room-wiz-short'] || '';
                            e.page.querySelector('#room-wiz-light').value = e.wizard.defaults['room-wiz-light'] || '3';
                            e.page.querySelector('#room-wiz-night-adjust').value = e.wizard.defaults['room-wiz-night-adjust'] || '0';
                            e.page.querySelector('#room-wiz-prevent-peer').value = e.wizard.defaults['room-wiz-prevent-peer'] || '';
                        }
                    }),
                    new WizardPage({
                        title: 'Description',
                        body: document.getElementById('room-wizard-description'),
                        reset: (e) => {
                            e.page.querySelector('#room-wiz-long').value = e.wizard.defaults['room-wiz-long'] || '';
                        }
                    }),
                    new WizardPage({
                        title: 'Properties',
                        body: document.getElementById('room-wizard-properties'),
                        reset: (e) => {
                            e.page.querySelector('#room-wiz-indoors').checked = e.wizard.defaults['room-wiz-indoors'] || false;
                            e.page.querySelector('#room-wiz-no-magic').checked = e.wizard.defaults['room-wiz-no-magic'] || false;
                            e.page.querySelector('#room-wiz-no-scry').checked = e.wizard.defaults['room-wiz-no-scry'] || false;
                            e.page.querySelector('#room-wiz-no-teleport').checked = e.wizard.defaults['room-wiz-no-teleport'] || false;
                            e.page.querySelector('#room-wiz-explored').checked = e.wizard.defaults['room-wiz-explored'] || false;
                            e.page.querySelector('#room-wiz-no-map').checked = e.wizard.defaults['room-wiz-no-map'] || false;
                            e.page.querySelector('#room-wiz-hide-exits').checked = e.wizard.defaults['room-wiz-hide-exits'] || false;
                            e.page.querySelector('#room-wiz-no-forage').checked = e.wizard.defaults['room-wiz-no-forage'] || false;
                            e.page.querySelector('#room-wiz-forage').value = e.wizard.defaults['room-wiz-forage'] || '-1';
                            e.page.querySelector('#room-wiz-max-forage').value = e.wizard.defaults['room-wiz-max-forage'] || '0';
                            e.page.querySelector('#room-wiz-secret-exit').value = e.wizard.defaults['room-wiz-secret-exit'] || '';
                            e.page.querySelector('#room-wiz-temperature').value = e.wizard.defaults['room-wiz-temperature'] || '0';
                            e.page.querySelector('#room-wiz-no-mgive').checked = e.wizard.defaults['room-wiz-no-mgive'] || false;
                            e.page.querySelector('#room-wiz-underwater').checked = e.wizard.defaults['room-wiz-underwater'] || false;
                        }
                    }),
                    new WizardPage({
                        title: 'Combat Properties',
                        body: document.getElementById('room-wizard-combat-properties'),
                        reset: (e) => {
                            e.page.querySelector('#room-wiz-no-attack').checked = e.wizard.defaults['room-wiz-no-attack'] || false;
                            e.page.querySelector('#room-wiz-council').checked = e.wizard.defaults['room-wiz-council'] || false;
                            e.page.querySelector('#room-wiz-melee').checked = e.wizard.defaults['room-wiz-melee'] || false;
                            e.page.querySelector('#room-wiz-pk').checked = e.wizard.defaults['room-wiz-pk'] || false;
                            e.page.querySelector('#room-wiz-no-dirt').checked = e.wizard.defaults['room-wiz-no-dirt'] || false;
                            e.page.querySelector('#room-wiz-dirt').value = e.wizard.defaults['room-wiz-dirt'] || '';
                        }
                    }),
                    new WizardDataGridPage({
                        title: 'Custom properties',
                        id: 'room-wiz-properties',
                        clipboard: 'jiMUD/',
                        mode: 1,
                        columns: [
                            {
                                label: 'Type',
                                field: 'type',
                                width: 150,
                                editor: {
                                    type: EditorType.select,
                                    options: {
                                        data: [
                                            { value: 0, display: 'normal' },
                                            { value: 1, display: 'temporary' }
                                        ]
                                    }
                                },
                                formatter: (data) => {
                                    if (!data) return '';
                                    switch (data.cell) {
                                        case 0:
                                            return 'normal';
                                        case 1:
                                            return 'temporary';
                                    }
                                    return '';
                                },
                                tooltipFormatter: (data) => {
                                    if (!data) return '';
                                    switch (data.cell) {
                                        case 0:
                                            return 'normal';
                                        case 1:
                                            return 'temporary';
                                    }
                                    return '';
                                }
                            },
                            {
                                label: 'Name',
                                field: 'name',
                                width: 150,
                                editor: {
                                    type: EditorType.dropdown,
                                    options: {
                                        container: '#object-wizard',
                                        data: [
                                            '[effect] bonus',
                                            'cold element bonus',
                                            'frost element bonus',
                                            'ice element bonus',
                                            'cold element penalty',
                                            'frost element penalty',
                                            'ice element penalty',
                                            'lightning element bonus',
                                            'lightning element penalty',
                                            'fire element bonus',
                                            'fire element penalty',
                                            'heat element bonus',
                                            'heat element penalty',
                                            'water element bonus',
                                            'water element penalty',
                                            'hide exits',
                                            'no convert',
                                            'no scry',
                                            'no dirt',
                                            'no cauterize',
                                            'no food decay',
                                            'no shock',
                                            'nonetrackable',
                                            'melee as ability',
                                            'crafting tool',
                                            'crafting quality',
                                            'crafting enchantment',
                                            'no range throw',
                                            'no range shoot'
                                        ]
                                    }
                                }
                            },
                            {
                                label: 'Value',
                                field: 'value',
                                spring: true,
                                width: 200,
                                editor: {
                                    options: {
                                        container: '#object-wizard'
                                    }
                                }
                            }
                        ],
                        add: (e) => {
                            e.data = {
                                type: 1,
                                name: '',
                                value: ''
                            };
                        }
                    }),
                    new WizardDataGridPage({
                        title: 'Items',
                        id: 'room-wiz-items',
                        clipboard: 'jiMUD/',
                        columns: [
                            {
                                label: 'Item',
                                field: 'item',
                                width: 150,
                                editor: {
                                    options: {
                                        container: '#room-wizard',
                                        singleLine: true
                                    }
                                }
                            },
                            {
                                label: 'Description',
                                field: 'description',
                                spring: true,
                                width: 200,
                                editor: {
                                    options: {
                                        container: '#room-wizard'
                                    }
                                }
                            }
                        ],
                        add: (e) => {
                            e.data = {
                                item: '',
                                description: ''
                            };
                        }
                    }),
                    new WizardDataGridPage({
                        title: 'Reads',
                        id: 'room-wiz-reads',
                        clipboard: 'jiMUD/',
                        mode: 1,
                        columns: [
                            {
                                label: 'Read',
                                field: 'read',
                                width: 150,
                                editor: {
                                    options: {
                                        container: '#room-wizard',
                                        singleLine: true
                                    }
                                }
                            },
                            {
                                label: 'Description',
                                field: 'description',
                                spring: true,
                                width: 200,
                                editor: {
                                    options: {
                                        container: '#room-wizard'
                                    }
                                }
                            },
                            {
                                label: 'Language',
                                field: 'language',
                                width: 200,
                                editor: {
                                    type: EditorType.dropdown,
                                    options: {
                                        container: '#room-wizard',
                                        data: [
                                            //spellchecker:disable
                                            'eltherian', 'ersi', 'jhlorim', 'malkierien', 'common',
                                            'draconic', 'elcharean', 'tangetto', 'terrakarn', 'gobbledegook',
                                            'malkierien', 'loyavenku', 'caninen', 'draconic', 'nibelungen',
                                            'wulinaxin', 'shangtai', 'farsi', 'nymal'
                                            //spellchecker:enable
                                        ]
                                    }
                                }
                            }
                        ],
                        add: (e) => {
                            e.data = {
                                read: '',
                                description: '',
                                language: ''
                            };
                        }
                    }),
                    $dialogs.roomExitPage,
                    new WizardDataGridPage({
                        title: 'Smells',
                        id: 'room-wiz-smells',
                        clipboard: 'jiMUD/',
                        columns: [
                            {
                                label: 'Smell',
                                field: 'smell',
                                width: 150,
                                editor: {
                                    options: {
                                        container: '#room-wizard',
                                        singleLine: true
                                    }
                                }
                            },
                            {
                                label: 'Description',
                                field: 'description',
                                spring: true,
                                width: 200,
                                editor: {
                                    options: {
                                        container: '#room-wizard'
                                    }
                                }
                            }
                        ],
                        add: (e) => {
                            e.data = {
                                smell: '',
                                description: ''
                            };
                        }
                    }),
                    new WizardDataGridPage({
                        title: 'Sounds',
                        id: 'room-wiz-sounds',
                        clipboard: 'jiMUD/',
                        columns: [
                            {
                                label: 'Sound',
                                field: 'sound',
                                width: 150,
                                editor: {
                                    options: {
                                        container: '#room-wizard',
                                        singleLine: true
                                    }
                                }
                            },
                            {
                                label: 'Description',
                                field: 'description',
                                spring: true,
                                width: 200,
                                editor: {
                                    options: {
                                        container: '#room-wizard'
                                    }
                                }
                            }
                        ],
                        add: (e) => {
                            e.data = {
                                sound: '',
                                description: ''
                            };
                        }
                    }),
                    new WizardDataGridPage({
                        title: 'Searches',
                        id: 'room-wiz-searches',
                        clipboard: 'jiMUD/',
                        mode: 1,
                        columns: [
                            {
                                label: 'Search',
                                field: 'search',
                                width: 150,
                                editor: {
                                    options: {
                                        container: '#room-wizard',
                                        singleLine: true
                                    }
                                }
                            },
                            {
                                label: 'Message',
                                field: 'message',
                                spring: true,
                                width: 200,
                                editor: {
                                    options: {
                                        container: '#room-wizard'
                                    }
                                }
                            }
                        ],
                        add: (e) => {
                            e.data = {
                                search: '',
                                message: ''
                            };
                        }
                    }),
                    new WizardPage({
                        title: 'Finish',
                        body: document.getElementById('room-wizard-finish'),
                        reset: (e) => {
                            e.page.querySelector('#room-wiz-summary').value = '';
                        },
                        shown: (e) => {
                            var summary = e.page.querySelector('#room-wiz-summary');
                            var data = e.wizard.data;
                            var doors = data['room-wiz-exits'].filter(r => r.door && r.door.length > 0 && !r.climb);
                            var exits = data['room-wiz-exits'].filter(r => !r.door || r.door.length === 0 && !r.climb);
                            var climbs = data['room-wiz-exits'].filter(r => !r.door || r.door.length === 0 && r.climb);
                            var sum = '<div><span style="font-weight:bold">Type:</span> ' + (data['room-wiz-type'].display || '') + '</div>';
                            sum += '<div><span style="font-weight:bold">Terrain:</span> ' + data['room-wiz-terrain'] + '</div>';
                            sum += '<div><span style="font-weight:bold">Short:</span> ' + data['room-wiz-short'] + '</div>';
                            sum += '<div><span style="font-weight:bold">Long:</span> ' + ellipse(data['room-wiz-long']) + '</div>';
                            sum += '<div><span style="font-weight:bold">Light:</span> ' + (data['room-wiz-light'] || 0) + '</div>';
                            if (data['room-wiz-night-adjust'] !== 0)
                                sum += '<div><span style="font-weight:bold">Night light adjustment:</span> ' + (data['room-wiz-night-adjust'] || 0) + '</div>';
                            if (data['room-wiz-prevent-peer'].length > 0)
                                sum += '<div><span style="font-weight:bold">Prevent peer all:</span> ' + data['room-wiz-prevent-peer'] + '</div>';
                            if (data['room-wiz-indoors']) sum += '<div><span style="font-weight:bold">Indoors:</span> Yes</div>';
                            if (data['room-wiz-no-magic']) sum += '<div><span style="font-weight:bold">No magic:</span> Yes</div>';
                            if (data['room-wiz-no-scry']) sum += '<div><span style="font-weight:bold">No scry:</span> Yes</div>';
                            if (data['room-wiz-no-teleport']) sum += '<div><span style="font-weight:bold">No teleport:</span> Yes</div>';
                            if (data['room-wiz-explored']) sum += '<div><span style="font-weight:bold">Explored Marker:</span> Yes</div>';
                            if (data['room-wiz-no-map']) sum += '<div><span style="font-weight:bold">No map send:</span> Yes</div>';
                            if (data['room-wiz-hide-exits']) sum += '<div><span style="font-weight:bold">Hide exits:</span> Yes</div>';
                            if (data['room-wiz-no-forage']) sum += '<div><span style="font-weight:bold">No forage:</span> Yes</div>';
                            if (data['room-wiz-forage'] >= 0) sum += '<div><span style="font-weight:bold">' + data['room-wiz-forage'] + ':</span> Yes</div>';
                            if (data['room-wiz-no-dirt']) sum += '<div><span style="font-weight:bold">No dirt:</span> Yes</div>';
                            if (data['room-wiz-no-mgive']) sum += '<div><span style="font-weight:bold">No mgive:</span> Yes</div>';
                            if (data['room-wiz-underwater']) sum += '<div><span style="font-weight:bold">Underwater:</span> Yes</div>';
                            if (data['room-wiz-waterdrink']) sum += '<div><span style="font-weight:bold">Water drink:</span> Yes</div>';
                            if (data.hasOwnProperty('room-wiz-water-quality') && data['room-wiz-water-quality'] != 5) sum += '<div><span style="font-weight:bold">Water quality:</span> ' + data['room-wiz-water-quality'] + '</div>';
                            if (data.hasOwnProperty('room-wiz-water-poisoned') && data['room-wiz-water-poisoned'] != 0) sum += '<div><span style="font-weight:bold">Water poisoned:</span> ' + data['room-wiz-water-poisoned'] + '</div>';
                            if (data['room-wiz-water-source'] && data['room-wiz-water-source'] != 'the water') sum += '<div><span style="font-weight:bold">Water source:</span> ' + data['room-wiz-water-source'] + '</div>';
                            if (data['room-wiz-water-drink-message'] && data['room-wiz-water-drink-message'].length > 0) sum += '<div><span style="font-weight:bold">Water drink message:</span> ' + data['room-wiz-water-drink-message'] + '</div>';
                            if (data['room-wiz-water-wash-message'] && data['room-wiz-water-wash-message'].length > 0) sum += '<div><span style="font-weight:bold">Water wash message:</span> ' + data['room-wiz-water-wash-message'] + '</div>';
                            if (data['room-wiz-water-germs'] && data['room-wiz-water-germs'].length) sum += '<div><span style="font-weight:bold">Water germs:</span> ' + data['room-wiz-water-germs'].length + '</div>';
                            if (data['room-wiz-max-forage'] > 0)
                                sum += '<div><span style="font-weight:bold">Max forage:</span> ' + data['room-wiz-max-forage'] + '</div>';
                            if (data['room-wiz-dirt'].length > 0)
                                sum += '<div><span style="font-weight:bold">Dirt type:</span> ' + data['room-wiz-dirt'] + '</div>';
                            if (data['room-wiz-secret-exit'].length > 0)
                                sum += '<div><span style="font-weight:bold">Secret exit:</span> ' + data['room-wiz-secret-exit'] + '</div>';
                            if (data['room-wiz-temperature'] !== 0)
                                sum += '<div><span style="font-weight:bold">Temperature:</span> ' + data['room-wiz-temperature'] + '</div>';

                            if (data['room-wiz-no-attack']) sum += '<div><span style="font-weight:bold">No attack:</span> Yes</div>';
                            if (data['room-wiz-council']) sum += '<div><span style="font-weight:bold">Council:</span> Yes</div>';
                            if (data['room-wiz-melee']) sum += '<div><span style="font-weight:bold">Melee as ability:</span> Yes</div>';
                            if (data['room-wiz-pk']) sum += '<div><span style="font-weight:bold">Enable pk:</span> Yes</div>';

                            sum += '<div><span style="font-weight:bold">Items:</span> ' + data['room-wiz-items'].length + '</div>';
                            sum += '<div><span style="font-weight:bold">Exits:</span> ' + exits.length + '</div>';
                            if (doors.length)
                                sum += '<div><span style="font-weight:bold">Doors:</span> ' + doors.length + '</div>';
                            if (climbs.length > 0)
                                sum += '<div><span style="font-weight:bold">Climbs:</span> ' + climbs.length + '</div>';
                            if (data['room-wiz-smells'].length > 0)
                                sum += '<div><span style="font-weight:bold">Smells:</span> ' + data['room-wiz-smells'].length + '</div>';
                            if (data['room-wiz-sounds'].length > 0)
                                sum += '<div><span style="font-weight:bold">Sounds:</span> ' + data['room-wiz-sounds'].length + '</div>';
                            if (data['room-wiz-searches'].length > 0)
                                sum += '<div><span style="font-weight:bold">Searches:</span> ' + data['room-wiz-searches'].length + '</div>';

                            if (data['room-wiz-includes'] && data['room-wiz-includes'].length > 0)
                                sum += '<div><span style="font-weight:bold">Includes:</span> ' + data['room-wiz-includes'].length + '</div>';
                            if (data['room-wiz-defines'] && data['room-wiz-defines'].length > 0)
                                sum += '<div><span style="font-weight:bold">Defines:</span> ' + data['mon-wiz-defines'].length + '</div>';
                            if (data['room-wiz-inherits'] && data['room-wiz-inherits'].length > 0)
                                sum += '<div><span style="font-weight:bold">Inherits:</span> ' + data['room-wiz-inherits'].length + '</div>';
                            if (data['room-wiz-variables'] && data['room-wiz-variables'].length > 0)
                                sum += '<div><span style="font-weight:bold">Variables:</span> ' + data['mon-wiz-variables'].length + '</div>';
                            if (data['room-wiz-functions'] && data['room-wiz-functions'].length > 0)
                                sum += '<div><span style="font-weight:bold">Functions:</span> ' + data['room-wiz-functions'].length + '</div>';
                            if (data['room-wiz-commands'] && data['room-wiz-commands'].length > 0)
                                sum += '<div><span style="font-weight:bold">Commands:</span> ' + data['room-wiz-commands'].length + '</div>';

                            summary.innerHTML = sum;
                        }
                    })
                ]
            });
            $dialogs.room.height = '345px';
            $dialogs.room.on('mode-changed', () => {
                options.roomWizardMode = $dialogs.room.mode;
            })
            $dialogs.room.on('value-changed', e => {
                if ($dialogs.room.options && $dialogs.room.options.valueChanged)
                    $dialogs.room.options.valueChanged(e);
            });
            $dialogs.room.on('open', () => {
                menubar.enabled = false;
            });
            $dialogs.room.on('close', () => {
                menubar.enabled = true;
                if ($dialogs.room.options && $dialogs.room.options.pages)
                    $dialogs.room.removePages($dialogs.room.options.pages);
                if ($dialogs.room.options && $dialogs.room.options.closed)
                    $dialogs.room.options.closed();
            });
            $dialogs.room.on('cancel', () => {
                menubar.enabled = true;
                if ($dialogs.room.options && $dialogs.room.options.pages)
                    $dialogs.room.removePages($dialogs.room.options.pages);
                if ($dialogs.room.options && $dialogs.room.options.closed)
                    $dialogs.room.options.closed();
            });
            $dialogs.room.on('finished', async (e) => {
                if ($dialogs.room.options && $dialogs.room.options.pages)
                    $dialogs.room.removePages($dialogs.room.options.pages);
                if ($dialogs.room.options && $dialogs.room.options.finish) {
                    $dialogs.room.options.finish(e);
                    return;
                }
                var value = fs.readFileSync(parseTemplate(path.join('{assets}', 'templates', 'wizards', 'room.c')), 'utf8');
                var data = e.data;
                var tmpl = baseParseData();
                var tmp, tmp2, tmp3;
                var doors = data['room-wiz-exits'].filter(r => r.exit.length > 0 && r.door && r.door.length > 0 && !r.climb);
                var exits = data['room-wiz-exits'].filter(r => r.exit.length > 0 && (!r.door || r.door.length === 0) && !r.climb);
                var climbs = data['room-wiz-exits'].filter(r => r.exit.length > 0 && (!r.door || r.door.length === 0) && r.climb);
                var props = {};
                var tempProps = {};
                var stubs = {};
                tmpl.doc = [];
                tmpl.includes = '';
                tmpl['create pre'] = '';
                tmpl['create body'] = '';
                tmpl['create post'] = '';
                tmpl.inherits = '';

                if (data['room-wiz-includes'] && tmpl['room-wiz-includes'].length) {
                    tmpl.includes += data['room-wiz-includes'].map(i => {
                        if (i.relative)
                            return `\n#include "${i.path}"`;
                        return `\n#include <${i.path}>`;
                    }).join('');
                }
                if (data['room-wiz-inherits'] && data['room-wiz-inherits'].length)
                    tmpl.inherits += data['room-wiz-inherits'].map(i => `\ninherit ${i};`).join('');

                if (data['room-wiz-defines']) {
                    data['room-wiz-defines'].forEach(r => tmpl['create pre'] += `#define ${r.key}${r.value && r.value.trim().length ? ' ' + r.value.trim() : ''}\n`);
                    if (data['room-wiz-defines'].length)
                        tmpl['create pre'] += '\n';
                }
                if (data['room-wiz-variables']) {
                    tmpl['create pre'] += data['room-wiz-variables'].map(
                        variable => {
                            if (variable.type == 'function' || (variable.type === 'mixed' && variable.value.trim().startsWith('(:'))) {
                                tmp3 = formatFunctionPointer(variable.value);
                                if (!stubs[tmp3]) {
                                    tmpl['create pre'] += createFunction(tmp3);
                                    stubs[tmp3] = 1;
                                }
                            }
                            return `${variable.type || 'mixed'}${variable.name} = ${formatVariableValue(variable.type, variable.value, 0)};\n`;
                        }
                    ).join('');
                    tmpl['reset body'] += data['room-wiz-variables'].filter(v => v.reset).map(
                        variable => `${variable.name} = ${formatVariableValue(variable.type, variable.value, 0)};\n`
                    ).join('');

                    if (tmp.length)
                        tmpl['create pre'] += '\n';
                }

                if (data['room-wiz-functions']) {
                    data['room-wiz-functions'].forEach(func => {
                        tmpl['create pre'] += createFunction(func.name, func);
                        stubs[formatFunctionPointer(func.name)] = 1;
                    });
                }

                if (data['room-wiz-forage'] !== -1 || doors.length > 0) {
                    tmpl['create post'] += '\n\nvoid reset()\n{\n   ::reset();\n';
                    if (data['room-wiz-forage'] !== -1)
                        props['forage'] = data['room-wiz-forage'];
                    doors.forEach(r => {
                        if (r.key.length !== 0)
                            tmpl['create post'] += `   set_locked("${r.door}", ${r.locked ? 1 : 0});\n`;
                        tmpl['create post'] += `   set_open("${r.door}", ${r.closed ? 0 : 1});\n`;
                    });
                    tmpl['create post'] += '}';
                }

                tmpl['create arguments'] = $dialogs.room.defaults['room-wiz-create'] || '';
                if ($dialogs.room.defaults['room-wiz-virtual'] && (data['room-wiz-type'].display === 'Standard') || data['room-wiz-type'].display === 'Base')
                    data['room-wiz-type'] = { display: 'Base', value: '(VIR+"baseroom")' };
                //check climbs first, as climb supports doors
                else if (climbs.length > 0 && data['room-wiz-type'].display === 'Standard')
                    data['room-wiz-type'] = { display: 'Climb', value: 'ROOMTYPE_CLIMB' };
                //if standard but has doors replace with vault, base leave alone as that is a different issue, all other types inherit vault
                else if (doors.length > 0 && data['room-wiz-type'].display === 'Standard')
                    data['room-wiz-type'] = { display: 'Vault', value: 'ROOMTYPE_VAULT' };

                tmpl.inherit = data['room-wiz-type'].value;

                if (climbs.length > 0 && data['room-wiz-type'].display !== 'Climb') {
                    tmpl.inherits += '\ninherit STD_CLIMBING;';
                    tmpl.doc.push('/doc/build/etc/climbing');
                }
                if (data['room-wiz-type'].display === 'Base' || $dialogs.room.defaults['room-wiz-virtual'])
                    tmpl.includes += '\n#include "area.h"';
                switch (data['room-wiz-type'].display) {
                    case 'Base':
                        tmpl.doc.push('/doc/build/areas/tutorial');
                        break;
                    case 'Advance room':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/bank');
                        break;
                    case 'Bank':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/bank');
                        break;
                    case 'Class join':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/classjoin');
                        break;
                    case 'Climb':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/climb');
                        tmpl.doc.push('/doc/build/etc/climbing');
                        break;
                    case 'Dock':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/pier');
                        tmpl.doc.push('/doc/build/room/types/dock');
                        break;
                    case 'Guild hall':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/guild_hall');
                        tmpl.doc.push('/doc/build/etc/voter');
                        break;
                    case 'Inn':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/inn');
                        break;
                    case 'Library':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/library');
                        break;
                    case 'Locker':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/locker');
                        break;
                    case 'Modroom':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/modroom');
                        break;
                    case 'Pier':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/pier');
                        tmpl.doc.push('/doc/build/room/fishing');
                        tmpl.doc.push('/doc/build/room/waterdrink');
                        break;
                    case 'Sage':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/library');
                        tmpl.doc.push('/doc/build/room/types/sage');
                        tmpl.doc.push('/doc/build/etc/sagebase');
                        break;
                    case 'Sink':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/sink_room');
                        break;
                    case 'Sky':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/sky_room');
                        break;
                    case 'Stable':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/stable');
                        break;
                    case 'Train':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/train_room');
                        break;
                    case 'Vault':
                        tmpl.doc.push('/doc/build/room/doors');
                        tmpl.doc.push('/doc/build/room/types/vault');
                        break;
                    case 'Vendor storage':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('doc/build/room/types/vendor_storage');
                        break;
                }
                data['room-wiz-short'] = data['room-wiz-short'].trim();
                if (data['room-wiz-short'].startsWith('(:')) {
                    tmpl['short'] = formatFunctionPointer(data['room-wiz-short']);
                    if (!stubs[tmpl['short']]) {
                        tmpl['create pre'] += createFunction(data['room-wiz-short'], 'string');
                        stubs[tmpl['short']] = 1;
                    }
                    tmpl['name'] = data['room-wiz-short'].substr(2);
                    if (tmpl['name'].endsWith(':)'))
                        tmpl['name'] = tmpl['name'].substr(0, tmpl['name'].length - 2);
                    tmpl['name'] = tmpl['name'].trim();
                }
                else if (data['room-wiz-short'].startsWith('"') && data['room-wiz-short'].endsWith('"')) {
                    tmpl['short'] = data['room-wiz-short'];
                    tmpl['name'] = data['room-wiz-short'].substr(1, data['room-wiz-short'].length - 2);
                }
                else {
                    tmpl['short'] = `"${data['room-wiz-short'].replace(/"/g, '\\"')}"`;
                    tmpl['name'] = data['room-wiz-short'];
                }
                data['room-wiz-long'] = data['room-wiz-long'].trim();
                if (data['room-wiz-long'].startsWith('(:')) {
                    tmpl['long'] = formatFunctionPointer(data['room-wiz-long']);
                    if (!stubs[mpl['long']]) {
                        tmpl['create pre'] += createFunction(data['room-wiz-long'], 'string');
                        stubs[mpl['long']] = 1
                    }
                    tmpl['description'] = data['room-wiz-long'].substr(2);
                    if (tmpl['description'].endsWith(':)'))
                        tmpl['description'] = tmpl['description'].substr(0, tmpl['description'].length - 2);
                    tmpl['description'] = tmpl['description'].trim();
                }
                else {
                    if (!data['room-wiz-long'].startsWith('"') && !data['room-wiz-long'].endsWith('"'))
                        data['room-wiz-long'] = data['room-wiz-long'].replace(/"/g, '\\"');
                    if (data['room-wiz-long'].startsWith('"'))
                        data['room-wiz-long'] = data['room-wiz-long'].substr(1);
                    if (data['room-wiz-long'].endsWith('"'))
                        data['room-wiz-long'] = data['room-wiz-long'].substr(0, data['room-wiz-long'].length - 1);
                    if (data['room-wiz-long'].length > 70) {
                        tmpl['description'] = formatString(data['room-wiz-long'], 0, 77, ' * ', '');
                        tmp = data['room-wiz-long'].substr(0, 66);
                        let tl = tmp.length;
                        while (tl--) {
                            if (tmp.charAt(tl) === ' ') {
                                tmp = tmp.substr(0, tl + 1);
                                break;
                            }
                        }
                        tmpl['long'] = `"${tmp}"\n     `;
                        data['room-wiz-long'] = data['room-wiz-long'].substr(tmp.length);
                        tmpl['long'] += `${formatString(data['room-wiz-long'], 5, 73)}`;
                    }
                    else {
                        tmpl['description'] = ' * ' + data['room-wiz-long'];
                        tmpl['long'] = `"${data['room-wiz-long']}"`;
                    }
                }
                tmpl['description'] = stripPinkfish(tmpl['description']);
                if (data['room-wiz-terrain'].length !== 0)
                    tmpl['create body'] += `   set_terrain("${data['room-wiz-terrain']}");\n`;

                if (data['room-wiz-light'] !== 0)
                    props['light'] = data['room-wiz-light'];
                if (data['room-wiz-indoors'])
                    props['indoors'] = 1;
                if (data['room-wiz-no-magic'])
                    props['no magic'] = 1;
                if (data['room-wiz-no-attack'])
                    props['no attack'] = 1;
                if (data['room-wiz-no-scry'])
                    props['no scry'] = 1;
                if (data['room-wiz-no-teleport'])
                    props['no teleport'] = 1;
                if (data['room-wiz-no-mgive'])
                    props['no mgive'] = 1;
                if (data['room-wiz-council'])
                    props['council'] = 1;
                if (data['room-wiz-no-map'])
                    props['no send info'] = 1;
                if (data['room-wiz-melee'])
                    props['melee as ability'] = 1;
                if (data['room-wiz-pk'])
                    props['enable pk'] = 1;
                if (data['room-wiz-hide-exits'])
                    props['hide exits'] = 1;
                if (data['room-wiz-no-forage'])
                    props['no forage'] = 1;
                if (data['room-wiz-no-dirt'])
                    props['no dirt'] = 1;
                if (data['room-wiz-dirt'].length > 0)
                    props['dirt type'] = `"${data['room-wiz-dirt']}"`;
                if (data['room-wiz-underwater'])
                    props['underwater'] = 1;

                data['room-wiz-secret-exit'] = data['room-wiz-secret-exit'].trim();
                if (data['room-wiz-secret-exit'] === 'false') { /**/ }
                else if (data['room-wiz-secret-exit'].startsWith('(:')) {
                    props['secret exit'] = formatFunctionPointer(data['room-wiz-secret-exit']);
                    if (!stubs[props['secret exit']]) {
                        tmpl['create pre'] += createFunction(data['room-wiz-secret-exit'], 'string', 'object room, object player');
                        stubs[props['secret exit']] = 1;
                    }
                }
                else if (data['room-wiz-secret-exit'] === 'true')
                    props['secret exit'] = 1;
                else if (typeof data['room-wiz-secret-exit'] === 'string' && parseFloat(data['room-wiz-secret-exit']).toString() == data['room-wiz-secret-exit'])
                    props['secret exit'] = data['room-wiz-secret-exit'];
                else if (data['room-wiz-secret-exit'].length > 0) {
                    props['secret exit'] = `"${data['room-wiz-secret-exit'].replace(/"/g, '\\"')}"`;
                }
                if (data['room-wiz-max-forage'] > 0)
                    props['maxforage'] = data['room-wiz-max-forage'];

                if (data['room-wiz-properties'].length > 0) {
                    data['room-wiz-properties'].forEach(b => {
                        b.value = b.value.trim();
                        if (b.value.startsWith('([')) {
                            if (b.type === 1)
                                tempProps[b.name] = formatMapping(b.value, 5);
                            else
                                props[b.name] = formatMapping(b.value, 5);
                        }
                        else if (b.value.startsWith('(:')) {
                            if (b.type === 1)
                                tempProps[b.name] = formatFunctionPointer(b.value);
                            else
                                props[b.name] = formatFunctionPointer(b.value);
                            if (!stubs[formatFunctionPointer(b.value)]) {
                                tmpl['create pre'] += createFunction(b.value);
                                stubs[formatFunctionPointer(b.value)] = 1;
                            }
                        }
                        else if (b.value.startsWith('({')) {
                            if (b.type === 1)
                                tempProps[b.name] = formatArray(b.value);
                            else
                                props[b.name] = formatArray(b.value);
                        }
                        else if ((b.value.startsWith('"') && b.value.endsWith('"')) || b.value.match(/^\d+$/) || b.value.match(/^-?([0-9]+\.[0-9]+)$/)) {
                            if (b.type === 1)
                                tempProps[b.name] = b.value;
                            else
                                props[b.name] = b.value;
                        }
                        else {
                            if (b.type === 1)
                                tempProps[b.name] = `"${b.value}"`;
                            else
                                props[b.name] = `"${b.value}"`;
                        }
                    });
                }

                tempProps = Object.keys(tempProps).map(k => `"${k}" : ${tempProps[k]}`);
                props = Object.keys(props).map(k => `"${k}" : ${props[k]}`);

                if (tempProps.length === 1)
                    tmpl['create body'] += `   set_temp_property(${tempProps[0].replace(' :', ',')});\n`;
                else if (tempProps.length > 0) {
                    tmpl['create body'] += '   set_temp_properties( ([\n       ';
                    tmpl['create body'] += tempProps.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }

                if (props.length === 1)
                    tmpl['create body'] += `   set_property(${props[0].replace(' :', ',')});\n`;
                else if (props.length > 0) {
                    tmpl['create body'] += '   set_properties( ([\n       ';
                    tmpl['create body'] += props.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }

                if (data['room-wiz-explored'])
                    tmpl['create body'] += '   set_explored_marker(1);\n';
                if (data['room-wiz-night-adjust'] !== 0)
                    tmpl['create body'] += `   set_night_adjust(${data['room-wiz-night-adjust']});\n`;

                if (data['room-wiz-waterdrink']) {
                    tmpl.inherits += '\ninherit STD_WATERDRINK;';
                    tmpl.doc.push('/doc/build/room/waterdrink');
                    if (data['room-wiz-commands'] && data['room-wiz-commands'].length) {
                        data['create post'] += '\n\nvoid init()\n{\n   room::init();\n   waterdrink::init();\n';
                        data['room-wiz-commands'].forEach(r => {
                            const cmds = r.name.split(',').map(c => c.trim());
                            tmp = r.function;
                            if (cmds.length > 1) {
                                if (!tmp || !tmp.length)
                                    tmp = 'cmd_' + cmds[0];
                                tmpl['create post'] += `    add_action("${tmp}", ({ "${cmds.join('", "')}" }) );\n`;
                            }
                            else {
                                if (!tmp || !tmp.length)
                                    tmp = 'cmd_' + r.name.trim();
                                tmpl['create post'] += `    add_action("${tmp}", "${r.name.trim()}");\n`;
                            }
                            if (!stubs[formatFunctionPointer(tmp)]) {
                                tmpl['create pre'] += createFunction(tmp, 'int', 'string args', '   return 1;');
                                stubs[formatFunctionPointer(tmp)] = 1;
                            }
                        });
                        tmpl['create post'] += '}';
                    }
                    else
                        tmpl['create post'] += '\n\nvoid init()\n{\n   room::init();\n   waterdrink::init();\n}';
                    if (data['room-wiz-water-quality'] !== 5)//default is 5
                        tmpl['create body'] += `   set_water_quality(${data['room-wiz-water-quality']});\n`;
                    if (data['room-wiz-water-poisoned'] != 0)//default is 5
                        tmpl['create body'] += `   set_water_poisoned(${data['room-wiz-water-poisoned']});\n`;
                    if (data['room-wiz-water-germs'] && data['room-wiz-water-germs'].length)
                        data['create body'] += `   set_germs(${formatArgumentList(data['room-wiz-water-germs'].join(', '), 55, 0, 0, true)});\n`;
                    if (data['room-wiz-water-source'] !== 'the water')//default is the water
                    {
                        if (!data['room-wiz-water-source'].startsWith('"') && !data['room-wiz-water-source'].endsWith('"'))
                            tmpl['create body'] += `   set_water_source("${data['room-wiz-water-source']}"");\n`;
                        else
                            tmpl['create body'] += `   set_water_source(${data['room-wiz-water-source']});\n`;
                    }

                    if (data['room-wiz-water-drink-message'] && data['room-wiz-water-drink-message'].length) {
                        if (data['room-wiz-water-drink-message'].startsWith('(:'))//default is empty string
                            data['create body'] += `   set_water_drink(${formatFunctionPointer(data['room-wiz-water-drink-message'])});\n`;
                        else if (!data['room-wiz-water-drink-message'].startsWith('"') && !data['room-wiz-water-drink-message'].endsWith('"'))
                            tmpl['create body'] += `   set_water_drink("${data['room-wiz-water-drink-message']}");\n`;
                        else
                            tmpl['create body'] += `   set_water_drink(${data['room-wiz-water-drink-message']});\n`;
                    }

                    if (data['room-wiz-water-wash-message'] && data['room-wiz-water-wash-message'].length) {
                        if (data['room-wiz-water-wash-message'].startsWith('(:'))//default is empty string
                            data['create body'] += `   set_water_wash(${formatFunctionPointer(data['room-wiz-water-wash-message'])});\n`;
                        else if (!data['room-wiz-water-wash-message'].startsWith('"') && !data['room-wiz-water-wash-message'].endsWith('"'))
                            tmpl['create body'] += `   set_water_wash("${data['room-wiz-water-wash-message']}");\n`;
                        else
                            tmpl['create body'] += `   set_water_wash(${data['room-wiz-water-wash-message']});\n`;
                    }
                }
                else if (data['room-wiz-commands'] && data['room-wiz-commands'].length) {
                    data['create post'] += '\n\nvoid init()\n{\n';
                    data['room-wiz-commands'].forEach(r => {
                        const cmds = r.name.split(',').map(c => c.trim());
                        tmp = r.function;
                        if (cmds.length > 1) {
                            if (!tmp || !tmp.length)
                                tmp = 'cmd_' + cmds[0];
                            tmpl['create post'] += `    add_action("${tmp}", ({ "${cmds.join('", "')}" }) );\n`;
                        }
                        else {
                            if (!tmp || !tmp.length)
                                tmp = 'cmd_' + r.name.trim();
                            tmpl['create post'] += `    add_action("${tmp}", "${r.name.trim()}");\n`;
                        }
                        if (!stubs[formatFunctionPointer(tmp)]) {
                            tmpl['create pre'] += createFunction(tmp, 'int', 'string args', '   return 1;');
                            stubs[formatFunctionPointer(tmp)] = 1;
                        }
                    });
                    tmpl['create post'] += '}';
                }
                data['room-wiz-prevent-peer'] = data['room-wiz-prevent-peer'].trim();
                if (data['room-wiz-prevent-peer'] === 'false') { /**/ }
                else if (data['room-wiz-prevent-peer'].startsWith('(:')) {
                    tmpl['create body'] += `   set_prevent_peer(${formatFunctionPointer(data['room-wiz-prevent-peer'])});\n`;
                    if (!stubs[formatFunctionPointer(data['room-wiz-prevent-peer'])]) {
                        tmpl['create pre'] += createFunction(data['room-wiz-prevent-peer'], 'string', 'string dir, object player');
                        stubs[formatFunctionPointer(data['room-wiz-prevent-peer'])] = 1;
                    }
                }
                else if (data['room-wiz-prevent-peer'] === 'true')
                    tmpl['create body'] += '   set_prevent_peer(1);\n';
                else if (data['room-wiz-prevent-peer'].startsWith('"') && data['room-wiz-prevent-peer'].endsWith('"'))
                    tmpl['create body'] += `   set_prevent_peer(${data['room-wiz-prevent-peer']});\n`;
                else if (data['room-wiz-prevent-peer'].length > 0)
                    tmpl['create body'] += `   set_prevent_peer("${data['room-wiz-prevent-peer'].replace(/"/g, '\\"')}");\n`;
                data['room-wiz-exits'].filter(p => p.peer && p.peer.trim().length > 0).forEach(p => {
                    p.peer = p.peer.trim();
                    if (p.peer === 'false') { /**/ }
                    if (p.peer.startsWith('(:')) {
                        tmpl['create body'] += `   set_prevent_peer("${p.exit}", ${formatFunctionPointer(p.peer)});\n`;
                        if (!stubs[formatFunctionPointer(p.peer)]) {
                            tmpl['create pre'] += createFunction(p.peer, 'string', 'string dir, object player');
                            stubs[formatFunctionPointer(p.peer)] = 1;
                        }
                    }
                    else if (p.peer === 'true')
                        tmpl['create body'] += `   set_prevent_peer("${p.exit}", 1);\n`;
                    else if (p.peer.startsWith('"') && p.peer.endsWith('"'))
                        tmpl['create body'] += `   set_prevent_peer("${p.exit}", ${p.peer});\n`;
                    else
                        tmpl['create body'] += `   set_prevent_peer("${p.exit}", "${p.peer.replace(/"/g, '\\"')}");\n`;
                });
                //add items
                tmp = data['room-wiz-items'].map(i => {
                    tmp2 = i.item.split(',').map(t => {
                        t.trim();
                        if (!t.startsWith('"') && !t.endsWith('"'))
                            t = '"' + t + '"';
                        return t;
                    });
                    if (tmp2.length === 1)
                        tmp2 = tmp2[0];
                    else
                        tmp2 = `({ ${tmp2.join(', ')} })`;
                    tmp3 = i.description.trim();
                    if (tmp3.startsWith('(:')) {
                        tmp3 = formatFunctionPointer(tmp3);
                        if (!stubs[tmp3]) {
                            tmpl['create pre'] += createFunction(tmp3, 'string');
                            stubs[tmp3] = 1;
                        }
                    }
                    else if (!tmp3.startsWith('"') && !tmp3.endsWith('"'))
                        tmp3 = '"' + tmp3 + '"';
                    return `${tmp2} : ${tmp3}`;
                });
                if (tmp.length > 0) {
                    tmpl['create body'] += '   set_items( ([\n       ';
                    tmpl['create body'] += tmp.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }
                //add exits
                tmp = exits.map(i => {
                    if (i.exit.length === 0) return '';
                    tmp2 = '';
                    if (i.dest.length > 0)
                        tmp2 = `"${i.dest}"`;
                    if (i.blocker.length > 0)
                        tmp3 = `"blockers" : ({ "${i.blocker.split(',').map(b => b.trim()).join('", "')}" })`;

                    if (!i.exit.startsWith('"') && !i.exit.endsWith('"'))
                        i.exit = `"${i.exit}"`;
                    if (i.blocker.length !== 0) {
                        tmp3 = `"blockers" : ({ "${i.blocker.split(',').map(b => b.trim()).join('", "')}" })`;
                        if (tmp2.length !== 0)
                            return `${i.exit} : ([\n         "room" : ${tmp2},\n         ${tmp3}\n       ])`;
                        return `${i.exit} : ([\n       ${tmp3}\n     ])`;
                    }
                    else if (tmp2.length !== 0)
                        return `${i.exit} : ${tmp2}`;
                    return `${i.exit} : ""`;
                });
                if (tmp.length > 0) {
                    tmpl['create body'] += '   set_exits( ([\n       ';
                    tmpl['create body'] += tmp.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }
                tmp = exits.filter(i => i.hidden).map(i => i.exit);
                if (tmp.length > 0)
                    tmpl['create body'] += `   add_invis_exits(${formatArgumentList(tmp.join(', '), 61)});\n`;
                //add climbs
                tmp = climbs.map(i => {
                    if (i.exit.length === 0) return '';
                    tmp2 = [];
                    if (i.dest.length !== 0)
                        tmp2.push(`"dest" : "${i.dest}"`);
                    if (i.diff !== 0)
                        tmp2.push(`"difficulty" : "${i.diff}"`);
                    if (!i.exit.startsWith('"') && !i.exit.endsWith('"'))
                        i.exit = `"${i.exit}"`;
                    if (tmp2.length !== 0)
                        return `${i.exit} : ([\n         ${tmp2.join(',\n         ')}\n       ])`;
                    return `${i.exit} : ([])`;
                });
                if (tmp.length !== 0) {
                    tmpl['create body'] += '   set_climbs( ([\n       ';
                    tmpl['create body'] += tmp.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }
                //add doors
                doors.forEach(d => {
                    if (!d.door.startsWith('"') && !d.door.endsWith('"'))
                        d.door = '"' + d.door + '"';
                    if (!d.exit.startsWith('"') && !d.exit.endsWith('"'))
                        d.exit = '"' + d.exit + '"';
                    if (d.key.length === 0)
                        d.key = '0';
                    else if (!d.key.startsWith('"') && !d.key.endsWith('"'))
                        d.key = '"' + d.key + '"';
                    if (d.destDoor.length > 0) {
                        if (!d.destDoor.startsWith('"') && !d.destDoor.endsWith('"'))
                            d.destDoor = '"' + d.destDoor + '"';
                        tmpl['create body'] += `   set_door(${d.door}, "${d.dest}", ${d.exit}, ${d.key}, ${d.hidden ? 1 : 0}, ${d.destDoor});\n`;
                    }
                    else if (d.hidden)
                        tmpl['create body'] += `   set_door(${d.door}, "${d.dest}", ${d.exit}, ${d.key}, 1);\n`;
                    else if (d.key !== '0')
                        tmpl['create body'] += `   set_door(${d.door}, "${d.dest}", ${d.exit}, ${d.key});\n`;
                    else
                        tmpl['create body'] += `   set_door(${d.door}, "${d.dest}", ${d.exit});\n`;
                });
                //smells
                tmp = data['room-wiz-smells'].map(i => {
                    tmp2 = i.smell.split(',').map(t => {
                        t.trim();
                        if (!t.startsWith('"') && !t.endsWith('"'))
                            t = '"' + t + '"';
                        return t;
                    });
                    if (tmp2.length === 1)
                        tmp2 = tmp2[0];
                    else
                        tmp2 = `({ ${tmp2.join(', ')} })`;
                    tmp3 = i.description.trim();
                    if (tmp3.startsWith('(:')) {
                        tmp3 = formatFunctionPointer(tmp3);
                        if (!stubs[ftmp3]) {
                            tmpl['create pre'] += createFunction(tmp3, 'string', 'string smell, object room, object player');
                            stubs[tmp3] = 1;
                        }
                    }
                    else if (!tmp3.startsWith('"') && !tmp3.endsWith('"'))
                        tmp3 = '"' + tmp3 + '"';
                    return `${tmp2} : ${tmp3}`;
                });

                if (tmp.length === 1 && data['room-wiz-smells'][0].smell === 'default') {
                    data['room-wiz-smells'][0].description = data['room-wiz-smells'][0].description.trim();
                    if (data['room-wiz-smells'][0].description.startsWith('(:'))
                        tmpl['create body'] += `   set_smell(${formatFunctionPointer(data['room-wiz-smells'][0].description)});\n`;
                    else if (!data['room-wiz-smells'][0].description.startsWith('"') && !data['room-wiz-smells'][0].description.endsWith('"'))
                        tmpl['create body'] += `   set_smell("${data['room-wiz-smells'][0].description}");\n`;
                    else
                        tmpl['create body'] += `   set_smell(${data['room-wiz-smells'][0].description});\n`;
                }
                else if (tmp.length > 0) {
                    tmpl['create body'] += '   set_smells( ([\n       ';
                    tmpl['create body'] += tmp.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }
                //sounds
                tmp = data['room-wiz-sounds'].map(i => {
                    tmp2 = i.sound.split(',').map(t => {
                        t.trim();
                        if (!t.startsWith('"') && !t.endsWith('"'))
                            t = '"' + t + '"';
                        return t;
                    });
                    if (tmp2.length === 1)
                        tmp2 = tmp2[0];
                    else
                        tmp2 = `({ ${tmp2.join(', ')} })`;
                    tmp3 = i.description.trim();
                    if (tmp3.startsWith('(:')) {
                        tmp3 = formatFunctionPointer(tmp3);
                        if (!stubs[tmp3]) {
                            tmpl['create pre'] += createFunction(tmp3, 'string', 'string sound, object room, object player');
                            stubs[tmp3] = 1;
                        }
                    }
                    else if (!tmp3.startsWith('"') && !tmp3.endsWith('"'))
                        tmp3 = '"' + tmp3 + '"';
                    return `${tmp2} : ${tmp3}`;
                });

                if (tmp.length === 1 && data['room-wiz-sounds'][0].sound === 'default') {
                    data['room-wiz-sounds'][0].description = data['room-wiz-sounds'][0].description.trim();
                    if (data['room-wiz-sounds'][0].description.startsWith('(:'))
                        tmpl['create body'] += `   set_listen(${formatFunctionPointer(data['room-wiz-sounds'][0].description)});\n`;
                    else if (!data['room-wiz-sounds'][0].description.startsWith('"') && !data['room-wiz-sounds'][0].description.endsWith('"'))
                        tmpl['create body'] += `   set_listen("${data['room-wiz-sounds'][0].description}");\n`;
                    else
                        tmpl['create body'] += `   set_listen(${data['room-wiz-sounds'][0].description});\n`;
                }
                else if (tmp.length > 0) {
                    tmpl['create body'] += '   set_listens( ([\n       ';
                    tmpl['create body'] += tmp.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }
                //searches
                tmp = data['room-wiz-searches'].map(i => {
                    tmp2 = i.search.split(',').map(t => {
                        t.trim();
                        if (!t.startsWith('"') && !t.endsWith('"'))
                            t = '"' + t + '"';
                        return t;
                    });
                    if (tmp2.length === 1)
                        tmp2 = tmp2[0];
                    else
                        tmp2 = `({ ${tmp2.join(', ')} })`;
                    tmp3 = i.message.trim();
                    if (tmp3.startsWith('(:')) {
                        tmp3 = formatFunctionPointer(tmp3);
                        if (!stubs[tmp3]) {
                            tmpl['create pre'] += createFunction(tmp3, 'string', 'string search');
                            stubs[tmp3] = 1;
                        }
                    }
                    else if (!tmp3.startsWith('"') && !tmp3.endsWith('"'))
                        tmp3 = '"' + tmp3 + '"';
                    return `${tmp2} : ${tmp3}`;
                });

                if (tmp.length === 1) {
                    tmp = data['room-wiz-searches'][0];
                    tmp2 = tmp.search.split(',').map(t => {
                        t.trim();
                        if (!t.startsWith('"') && !t.endsWith('"'))
                            t = '"' + t + '"';
                        return t;
                    });
                    if (tmp2.length === 1)
                        tmp2 = tmp2[0];
                    else
                        tmp2 = `({ ${tmp2.join(', ')} })`;
                    tmp.message = tmp.message.trim();
                    if (tmp.message.startsWith('(:'))
                        tmpl['create body'] += `   set_search(${tmp2}, ${formatFunctionPointer(tmp.message)});\n`;
                    else if (!tmp.message.startsWith('"') && !tmp.message.endsWith('"'))
                        tmpl['create body'] += `   set_search(${tmp2}, "${tmp.message}");\n`;
                    else
                        tmpl['create body'] += `   set_search(${tmp2}, ${tmp.message});\n`;
                }
                else if (tmp.length > 0) {
                    tmpl['create body'] += '   set_search( ([\n       ';
                    tmpl['create body'] += tmp.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }
                if (data['room-wiz-temperature'] !== 0)
                    tmpl['create body'] += `   set_temperature(${data['room-wiz-temperature']});\n`;

                //#region reads
                tmp = data['room-wiz-reads'].map(i => {
                    tmp2 = i.read.split(',').map(t => {
                        t.trim();
                        if (!t.startsWith('"') && !t.endsWith('"'))
                            t = '"' + t + '"';
                        return t;
                    });
                    if (tmp2.length === 1)
                        tmp2 = tmp2[0];
                    else
                        tmp2 = `({ ${tmp2.join(', ')} })`;
                    tmp3 = i.description.trim();
                    if (tmp3.startsWith('(:')) {
                        tmp3 = formatFunctionPointer(tmp3);
                        if (!stubs[tmp3]) {
                            tmpl['create pre'] += createFunction(tmp3, 'string', 'string id');
                            stubs[tmp3] = 1;
                        }
                    }
                    else if (!tmp3.startsWith('"') && !tmp3.endsWith('"'))
                        tmp3 = '"' + tmp3 + '"';
                    if (tmp2.length === 0)
                        tmp2 = 'default';
                    if (i.language.length !== 0)
                        return `${tmp2} : ([ "value" : ${tmp3}, "lang" : "${i.language}" ]) `;
                    return `${tmp2} : ${tmp3}`;
                });

                if (tmp.length === 1) {
                    tmp = data['room-wiz-reads'][0];
                    tmp2 = tmp.read.split(',').map(t => {
                        t.trim();
                        if (!t.startsWith('"') && !t.endsWith('"'))
                            t = '"' + t + '"';
                        return t;
                    });
                    if (tmp2.length === 1)
                        tmp2 = tmp2[0];
                    else
                        tmp2 = `({ ${tmp2.join(', ')} })`;
                    if ((tmp2 === 'default' || tmp2.length === 0) && tmp.language.length === 0)
                        tmp2 = '';
                    else if (tmp2.length === 0)
                        tmp2 = '"default", ';
                    else
                        tmp2 += ', ';
                    tmp.description = tmp.description.trim();
                    tmp3 = '';
                    if (tmp.language.length !== 0)
                        tmp3 = `, "${tmp.language}"`;
                    if (tmp.description.startsWith('(:'))
                        tmpl['create body'] += `   set_read(${tmp2}${formatFunctionPointer(tmp.description)}${tmp3});\n`;
                    else if (!tmp.description.startsWith('"') && !tmp.description.endsWith('"'))
                        tmpl['create body'] += `   set_read(${tmp2}"${tmp.description}"${tmp3});\n`;
                    else
                        tmpl['create body'] += `   set_read(${tmp2}${tmp.description}${tmp3});\n`;
                }
                else if (tmp.length > 0) {
                    tmpl['create body'] += '   set_read( ([\n       ';
                    tmpl['create body'] += tmp.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }
                //#endregion

                if (data['room-wiz-create-body'] && data['room-wiz-create-body'].length > 0)
                    tmpl['create body'] += data['room-wiz-create-body'];
                //add docs
                if (tmpl['doc'].length > 0)
                    tmpl['doc'] = ' * @doc ' + tmpl['doc'].join('\n * @doc ') + '\n';
                else
                    tmpl['doc'] = '';
                var f;
                if (data['room-wiz-type'].display === 'Standard' || data['room-wiz-type'].display === 'Base')
                    f = ('new_room_' + newCounter);
                else
                    f = ('new_' + data['room-wiz-type'].display.replace(/\s/g, '_') + '_' + newCounter);
                if (!this.$dialogs.room.defaults['room-wiz-file'] || this.$dialogs.room.defaults['room-wiz-file'].length === 0)
                    newCounter++;
                f += '.c';
                f.toLowerCase();
                newFromValueFormatted(parseFileTemplate(value, tmpl), this.$dialogs.room.defaults['room-wiz-file'] || f);
            });
            $('#room-wiz-type').on('change', (e) => {
                if ($dialogs.room.options && $dialogs.monster.room.typeChange)
                    $dialogs.room.options.typeChange(e);
            });
        }
        $dialogs.room.title = opts ? (opts.title || 'Create new room...') : 'Create new room...';
        $dialogs.room.defaults = dData || {};
        $dialogs.room.options = opts;
        if (opts && opts.pages)
            $dialogs.room.insertPages($dialogs.room.pages.length - 1, opts.pages);
        $dialogs.room.show();
    }

    function monsterWizard(dData, opts) {
        if (!$dialogs.monster) {
            $('#btn-mon-wiz-typeData-storageroom').on('click', () => {
                showBrowseDialog({
                    defaultFile: document.getElementById('mon-wiz-typeData-storageroom').value || (manager.active ? (manager.active.editor.remote || options.uploadAs || (options.remote + "/" + path.basename(manager.active.editor.file))) : options.uploadAs),
                    title: 'Select remote folder',
                    properties: ['openDirectory']
                }, (files) => {
                    if (!files || files.length === 0) return;
                    document.getElementById('mon-wiz-typeData-storageroom').value = files[0];
                });
            });
            var list = function () {
                if (!document.getElementById('mon-wiz-typeData-list_long')) return;
                if (!document.getElementById('mon-wiz-typeData-list_items')) return;
                if (!document.getElementById('mon-wiz-typeData-display_list_item')) return;
                document.getElementById('mon-wiz-typeData-list_long').disabled = !(document.getElementById('mon-wiz-typeData-list_items').value.trim().length && document.getElementById('mon-wiz-typeData-display_list_item').checked)
            }
            document.getElementById('mon-wiz-typeData-display_list_item').addEventListener('change', list);
            document.getElementById('mon-wiz-typeData-list_items').addEventListener('change', list);
            document.getElementById('mon-wiz-typeData-list_items').addEventListener('input', list);
            var colors = '<li><a href="#">' + fs.readFileSync(parseTemplate(path.join('{assets}', 'editor', 'color.lst')), 'utf8').replace(/\r\n|\n|\r/g, '</a></li><li><a href="#">') + '</a></li>';
            var races = '<li><a href="#">' + fs.readFileSync(parseTemplate(path.join('{assets}', 'editor', 'monster-race.lst')), 'utf8').replace(/\r\n|\n|\r/g, '</a></li><li><a href="#">') + '</a></li>';
            var bodies = '<li><a href="#">' + fs.readFileSync(parseTemplate(path.join('{assets}', 'editor', 'monster-bodies.lst')), 'utf8').replace(/\r\n|\n|\r/g, '</a></li><li><a href="#">') + '</a></li>';
            document.getElementById('mon-wiz-body-list').innerHTML = bodies;
            document.getElementById('mon-wiz-race-list').innerHTML = races;
            document.getElementById('mon-wiz-eye-list').innerHTML = colors;
            document.getElementById('mon-wiz-hair-list').innerHTML = colors;
            updateEditDropdown(document.getElementById('mon-wiz-body-list').closest('.edit-dropdown'));
            updateEditDropdown(document.getElementById('mon-wiz-race-list').closest('.edit-dropdown'));
            updateEditDropdown(document.getElementById('mon-wiz-eye-list').closest('.edit-dropdown'));
            updateEditDropdown(document.getElementById('mon-wiz-hair-list').closest('.edit-dropdown'));
            const reputation = new WizardDataGridPage({
                title: 'Reputation',
                id: 'mon-wiz-reputations',
                clipboard: 'jiMUD/',
                mode: 1,
                columns: [
                    {
                        label: 'Type',
                        field: 'type',
                        formatter: data => data ? (data.cell === 1 ? 'Die' : 'Attack') : 'Attack',
                        tooltipFormatter: data => data ? (data.cell === 1 ? 'Die' : 'Attack') : 'Attack',
                        width: 150,
                        editor: {
                            type: EditorType.select,
                            options: {
                                container: '#monster-wizard',
                                data: [
                                    { value: 0, display: 'Attack' },
                                    { value: 1, display: 'Die' },
                                ],
                            }
                        }
                    },
                    {
                        label: 'Group',
                        field: 'group',
                        spring: true,
                        width: 200,
                        editor: {
                            options: {
                                container: '#monster-wizard',
                                singleLine: true
                            }
                        }
                    },
                    {
                        label: 'Amount',
                        field: 'amount',
                        width: 200,
                        editor: {
                            options: {
                                min: -1000,
                                max: 1000
                            }
                        }
                    }
                ],
                add: (e) => {
                    e.data = {
                        type: 0,
                        group: '',
                        amount: ''
                    };
                }
            });
            reputation.page.lastChild.style.top = '90px';
            reputation.page.firstChild.textContent = 'Reputations';
            var el = document.createElement('div');
            el.classList.add('col-sm-12', 'form-group');
            el.style.padding = '0';
            el.innerHTML = '<label class="control-label">Default group<input type="text" class="input-sm form-control" id="mon-wiz-reputation-group" /></label>';
            reputation.page.insertBefore(el, reputation.page.firstChild);

            reputation.on('reset', (e) => {
                e.page.querySelector('#mon-wiz-reputation-group').value = e.wizard.defaults['mon-wiz-reputation-group'] || '';
            });

            const emotes = new WizardDataGridPage({
                title: 'Emotes and speaks',
                id: 'mon-wiz-emotes',
                clipboard: 'jiMUD/',
                mode: 1,
                columns: [
                    {
                        label: 'Type',
                        field: 'type',
                        width: 200,
                        editor: {
                            type: EditorType.select,
                            options: {
                                data: [
                                    { value: 0, display: 'emote' },
                                    { value: 1, display: 'combat emote' },
                                    { value: 2, display: 'speak' },
                                    { value: 3, display: 'combat speak' }
                                ]
                            }
                        },
                        formatter: (data) => {
                            if (!data) return '';
                            switch (data.cell) {
                                case 0:
                                    return 'emote';
                                case 1:
                                    return 'combat emote';
                                case 2:
                                    return 'speak';
                                case 3:
                                    return 'combat speak';
                            }
                            return '';
                        },
                        tooltipFormatter: (data) => {
                            if (!data) return '';
                            switch (data.cell) {
                                case 0:
                                    return 'emote';
                                case 1:
                                    return 'combat emote';
                                case 2:
                                    return 'speak';
                                case 3:
                                    return 'combat speak';
                            }
                            return '';
                        }
                    },
                    {
                        label: 'Message',
                        field: 'message',
                        spring: true,
                        width: 200,
                        editor: {
                            options: {
                                container: '#monster-wizard',
                                singleLine: true
                            }
                        }
                    },
                    {
                        label: 'Language',
                        field: 'language',
                        width: 200,
                        editor: {
                            type: EditorType.dropdown,
                            options: {
                                container: '#room-wizard',
                                data: [
                                    //spellchecker:disable
                                    'eltherian', 'ersi', 'jhlorim', 'malkierien', 'common',
                                    'draconic', 'elcharean', 'tangetto', 'terrakarn', 'gobbledegook',
                                    'malkierien', 'loyavenku', 'caninen', 'draconic', 'nibelungen',
                                    'wulinaxin', 'shangtai', 'farsi', 'nymal'
                                    //spellchecker:enable
                                ]
                            }
                        }
                    }
                ],
                add: (e) => {
                    e.data = {
                        type: 0,
                        message: '',
                        language: ''
                    };
                }
            });

            emotes.page.lastChild.style.top = '90px';
            emotes.page.firstChild.textContent = 'Emotes and speaks';
            el = document.createElement('div');
            el.classList.add('col-sm-3', 'form-group');
            el.style.padding = '0';
            el.innerHTML = '<label class="control-label">Speak combat<input type="number" class="input-sm form-control" min="0" max="101" id="mon-wiz-speech-chance-combat" /></label>';
            emotes.page.insertBefore(el, emotes.page.firstChild);
            el = document.createElement('div');
            el.classList.add('col-sm-3', 'form-group');
            el.style.padding = '0';
            el.style.paddingRight = '5px';
            el.innerHTML = '<label class="control-label">Speak chance<input type="number" class="input-sm form-control" min="0" max="101" id="mon-wiz-speech-chance" /></label>';
            emotes.page.insertBefore(el, emotes.page.firstChild);
            el = document.createElement('div');
            el.classList.add('col-sm-3', 'form-group');
            el.style.padding = '0';
            el.style.paddingRight = '5px';
            el.innerHTML = '<label class="control-label">Emote combat<input type="number" class="input-sm form-control" min="0" max="101" id="mon-wiz-emotes-chance-combat" /></label>';
            emotes.page.insertBefore(el, emotes.page.firstChild);
            el = document.createElement('div');
            el.classList.add('col-sm-3', 'form-group');
            el.style.padding = '0';
            el.style.paddingRight = '5px';
            el.innerHTML = '<label class="control-label">Emote chance<input type="number" class="input-sm form-control" min="0" max="101" id="mon-wiz-emotes-chance" /></label>';
            emotes.page.insertBefore(el, emotes.page.firstChild);

            emotes.on('reset', (e) => {
                e.page.querySelector('#mon-wiz-emotes-chance').value = e.wizard.defaults['mon-wiz-emotes-chance'] || '0';
                e.page.querySelector('#mon-wiz-speech-chance').value = e.wizard.defaults['mon-wiz-speech-chance'] || '0';
                e.page.querySelector('#mon-wiz-emotes-chance-combat').value = e.wizard.defaults['mon-wiz-emotes-chance-combat'] || '0';
                e.page.querySelector('#mon-wiz-speech-chance-combat').value = e.wizard.defaults['mon-wiz-speech-chance-combat'] || '0';
            });


            $dialogs.monster = new Wizard({
                id: 'monster-wizard',
                title: 'Create new monster...',
                mode: options.monWizardMode,
                pages: [
                    new WizardPage({
                        title: 'Welcome',
                        body: document.getElementById('mon-wizard-welcome'),
                        reset: e => {
                            e.page.querySelector('#mon-wizard-welcome-message').textContent = e.wizard.defaults['room-wiz-welcome-message'] || 'Welcome to the new monster wizard, this will take you through the steps to create a monster quickly and easily. You may finish at any time to generate a monster based on your current selections.';
                        }
                    }),
                    new WizardPage({
                        title: 'General properties',
                        body: document.getElementById('mon-wizard-general'),
                        reset: (e) => {
                            var aTypes = e.page.querySelector('#mon-wiz-area-types');
                            aTypes.innerHTML = '';
                            if (e.wizard.defaults['mon-wiz-area-types'] && e.wizard.defaults['mon-wiz-area-types'].length > 0) {
                                if (Array.isArray(e.wizard.defaults['mon-wiz-area-types']))
                                    aTypes.innerHTML = e.wizard.defaults['mon-wiz-area-types'].map(r => `<option value="${r.value || r.display}">${r.display || r.value}</option>`).join('');
                                else
                                    aTypes.innerHTML = e.wizard.defaults['mon-wiz-area-types'];
                            }
                            else
                                aTypes.innerHTML = '<option value="BASEMONSTER">Base</option>';

                            if ($dialogs.monster.options && $dialogs.monster.options.groups) {
                                var groups = Object.keys($dialogs.monster.options.groups);
                                Array.prototype.forEach.call(e.page.querySelectorAll('optgroup[data-types=moncustom]'), function (node) {
                                    node.parentNode.removeChild(node);
                                });
                                groups.forEach(g => {
                                    var el = document.createElement('optgroup');
                                    el.label = g;
                                    el.id = g.replace(/ /g, '');
                                    el.dataset.types = 'moncustom'
                                    el.innerHTML = $dialogs.monster.options.groups[g].map(r => `<option value="${r.value || r.display}">${r.display || r.value}</option>`).join('');
                                    aTypes.parentNode.insertBefore(el, aTypes.nextSibling);
                                });
                            }
                            $('#mon-wiz-type', e.page).selectpicker('refresh').val(e.wizard.defaults['mon-wiz-type'] || 'STD_MONSTER').selectpicker('render');
                            e.page.querySelector('#mon-wiz-level').value = e.wizard.defaults['mon-wiz-level'] || '1';
                            e.page.querySelector('#mon-wiz-alignment').value = e.wizard.defaults['mon-wiz-alignment'] || '';
                            e.page.querySelector('#mon-wiz-race').value = e.wizard.defaults['mon-wiz-race'] || '';
                            e.page.querySelector('#mon-wiz-class').value = e.wizard.defaults['mon-wiz-class'] || '';
                            e.page.querySelector('#mon-wiz-language').value = e.wizard.defaults['mon-wiz-language'] || '';
                            e.page.querySelector('#mon-wiz-ridable').checked = e.wizard.defaults['mon-wiz-ridable'] || false;
                            e.page.querySelector('#mon-wiz-flying').checked = e.wizard.defaults['mon-wiz-flying'] || false;
                            e.page.querySelector('#mon-wiz-getable').checked = e.wizard.defaults['mon-wiz-getable'] || false;
                            e.page.querySelector('#mon-wiz-undead').checked = e.wizard.defaults['mon-wiz-undead'] || false;
                            e.page.querySelector('#mon-wiz-waterbreathing').checked = e.wizard.defaults['mon-wiz-waterbreathing'] || false;
                            e.page.querySelector('#mon-wiz-requires-water').checked = e.wizard.defaults['mon-wiz-requires-water'] || false;
                            e.page.querySelector('#mon-wiz-no-bleed').checked = e.wizard.defaults['mon-wiz-no-bleed'] || false;
                        }
                    }),
                    new WizardPage({
                        title: 'Description',
                        body: document.getElementById('mon-wizard-description'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-name').value = e.wizard.defaults['mon-wiz-name'] || '';
                            e.page.querySelector('#mon-wiz-short').value = e.wizard.defaults['mon-wiz-short'] || '';
                            e.page.querySelector('#mon-wiz-nouns').value = e.wizard.defaults['mon-wiz-nouns'] || '';
                            e.page.querySelector('#mon-wiz-adjectives').value = e.wizard.defaults['mon-wiz-adjectives'] || '';
                        }
                    }),
                    new WizardPage({
                        title: 'Long description',
                        body: document.getElementById('mon-wizard-description-long'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-long').value = e.wizard.defaults['mon-wiz-long'] || '';
                        }
                    }),
                    new WizardPage({
                        title: 'Physical properties',
                        body: document.getElementById('mon-wizard-physical'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-mass').value = e.wizard.defaults['mon-wiz-mass'] || '0';
                            e.page.querySelector('#mon-wiz-height').value = e.wizard.defaults['mon-wiz-height'] || '1';
                            e.page.querySelector('#mon-wiz-eye').value = e.wizard.defaults['mon-wiz-eye'] || '';
                            e.page.querySelector('#mon-wiz-hair').value = e.wizard.defaults['mon-wiz-hair'] || '';
                            $('#mon-wiz-gender', e.page).val(e.wizard.defaults['mon-wiz-gender'] || 'male').selectpicker('render');
                            e.page.querySelector('#mon-wiz-body').value = e.wizard.defaults['mon-wiz-body'] || '';
                        }
                    }),
                    new WizardDataGridPage({
                        title: 'Resistances',
                        id: 'mon-wiz-resistances',
                        clipboard: 'jiMUD/',
                        mode: 1,
                        columns: [
                            {
                                label: 'Type',
                                field: 'type',
                                width: 200,
                                spring: true,
                                editor: {
                                    type: EditorType.dropdown,
                                    options: {
                                        container: '#monster-wizard',
                                        data: [
                                            'cutting',
                                            'puncture',
                                            'blunt',
                                            'slicing',
                                            'melee',
                                            'magic',
                                            'faith',
                                            'fire',
                                            'heat',
                                            'cold',
                                            'ice',
                                            'frost',
                                            'air',
                                            'acid',
                                            'lightning',
                                            'shock',
                                            'rock',
                                            'water',
                                            'poison',
                                            'scry'
                                        ]
                                    }
                                }
                            },
                            {
                                label: 'Amount',
                                field: 'amount',
                                width: 200,
                                editor: {
                                    type: EditorType.number,
                                    options: {
                                        min: -1000,
                                        max: 1000
                                    }
                                }
                            }
                        ],
                        add: (e) => {
                            e.data = {
                                type: '',
                                amount: 0
                            };
                        }
                    }),
                    new WizardPage({
                        title: 'Ask',
                        body: document.getElementById('mon-wizard-ask'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-ask').value = e.wizard.defaults['mon-wiz-ask'] || false;
                            e.page.querySelector('#mon-wiz-ask-no-topic').value = e.wizard.defaults['mon-wiz-no-topic'] || '';
                            $('#mon-wiz-ask-response', e.page).val(e.wizard.defaults['mon-wiz-ask-response'] || '0').selectpicker('render');
                        }
                    }),
                    new WizardDataGridPage({
                        title: 'Ask topics',
                        id: 'mon-wiz-ask-topics',
                        clipboard: 'jiMUD/',
                        mode: 1,
                        columns: [
                            {
                                label: 'Topic',
                                field: 'topic',
                                width: 200,
                            },
                            {
                                label: 'Message',
                                field: 'message',
                                spring: true,
                                width: 200,
                                editor: {
                                    options: {
                                        container: '#monster-wizard',
                                        singleLine: true
                                    }
                                }
                            }
                        ],
                        add: (e) => {
                            e.data = {
                                topic: '',
                                message: ''
                            };
                        }
                    }),
                    new WizardPage({
                        title: 'Vendor properties',
                        body: document.getElementById('mon-wizard-vendor'),
                        reset: e => {
                            const controls = e.page.querySelectorAll('[id^="mon-wiz-typeData"]');
                            const cl = controls.length;
                            for (let c = 0; c < cl; c++) {
                                let d = controls[c].dataset ? controls[c].dataset.default : null;
                                switch (controls[c].tagName) {
                                    case 'INPUT':
                                        if (controls[c].type === 'checkbox')
                                            controls[c].check = e.wizard.defaults[controls[c].id] || d === 'true' || false;
                                        else if (controls[c].type === 'number')
                                            controls[c].value = e.wizard.defaults[controls[c].id] || +d || 0;
                                        else
                                            controls[c].value = e.wizard.defaults[controls[c].id] || d || '';
                                        break;
                                    case 'SELECT':
                                        $(controls[c]).val(e.wizard.defaults[controls[c].id] || d || '').selectpicker('render');
                                        break;
                                    default:
                                        controls[c].value = e.wizard.defaults[controls[c].id] || d || '';
                                        break;
                                }
                            }
                        },
                        shown: e => {
                            list();
                        }
                    }),
                    new WizardPage({
                        title: 'Vendor advanced properties',
                        body: document.getElementById('mon-wizard-vendor-advanced'),
                        reset: e => {
                            const controls = e.page.querySelectorAll('[id^="mon-wiz-typeData"]');
                            const cl = controls.length;
                            for (let c = 0; c < cl; c++) {
                                let d = controls[c].dataset ? controls[c].dataset.default : null;
                                switch (controls[c].tagName) {
                                    case 'INPUT':
                                        if (controls[c].type === 'checkbox')
                                            controls[c].check = e.wizard.defaults[controls[c].id] || d === 'true' || false;
                                        else if (controls[c].type === 'number')
                                            controls[c].value = e.wizard.defaults[controls[c].id] || +d || 0;
                                        else
                                            controls[c].value = e.wizard.defaults[controls[c].id] || d || '';
                                        break;
                                    case 'SELECT':
                                        $(controls[c]).val(e.wizard.defaults[controls[c].id] || d || '').selectpicker('render');
                                        break;
                                    default:
                                        controls[c].value = e.wizard.defaults[controls[c].id] || d || '';
                                        break;
                                }
                            }
                        },
                        shown: e => {
                            list();
                        }
                    }),
                    new WizardDataGridPage({
                        title: 'Barkeep menu',
                        id: 'mon-wiz-typeData-menu',
                        visible: false,
                        clipboard: 'jiMUD/',
                        columns: [
                            {
                                label: 'Short',
                                field: 'short',
                                width: 150,
                                editor: {
                                    options: {
                                        container: '#monster-wizard',
                                        singleLine: true
                                    }
                                }
                            },
                            {
                                label: 'Name',
                                field: 'name',
                                width: 150,
                                editor: {
                                    options: {
                                        container: '#monster-wizard',
                                        singleLine: true
                                    }
                                }
                            },
                            {
                                label: 'Strength',
                                field: 'strength',
                                width: 75,
                                editor: {
                                    options: {
                                        min: 0,
                                        max: 1000
                                    }
                                }
                            },
                            {
                                label: 'Type',
                                field: 'type',
                                width: 150,
                                editor: {
                                    type: EditorType.select,
                                    options: {
                                        data: [
                                            { value: 'alcoholic', display: 'alcoholic' },
                                            { value: 'caffeine', display: 'caffeine' },
                                            { value: 'drink', display: 'drink' },
                                            { value: 'food', display: 'food' }
                                        ]
                                    }
                                }
                            },
                            {
                                label: 'Long',
                                field: 'long',
                                width: 250,
                                editor: {
                                    options: {
                                        dialog: true,
                                        title: 'Edit long&hellip;',
                                        container: document.body
                                    }
                                }
                            },
                            {
                                label: 'Nouns',
                                field: 'nouns',
                                width: 150,
                                editor: {
                                    type: EditorType.collection,
                                    options: {
                                        columnLabel: 'Noun',
                                        stringCollection: true,
                                        open: true,
                                        type: 'string'
                                    }
                                }
                            },
                            {
                                label: 'Adjectives',
                                field: 'adjectives',
                                width: 150,
                                editor: {
                                    type: EditorType.collection,
                                    options: {
                                        columnLabel: 'Adjective',
                                        stringCollection: true,
                                        open: true,
                                        type: 'string'
                                    }
                                }
                            },
                            {
                                label: 'Category',
                                field: 'category',
                                width: 100,
                                editor: {
                                    type: EditorType.dropdown,
                                    options: {
                                        container: '#monster-wizard',
                                        data: ['food', 'drink']
                                    }
                                }
                            },
                            {
                                label: 'My Message',
                                field: 'my_mess',
                                width: 250,
                                editor: {
                                    options: {
                                        dialog: true,
                                        title: 'Edit long&hellip;',
                                        container: document.body
                                    }
                                }
                            },
                            {
                                label: 'Your Message',
                                field: 'your_mess',
                                width: 250,
                                editor: {
                                    options: {
                                        dialog: true,
                                        title: 'Edit long&hellip;',
                                        container: document.body
                                    }
                                }
                            },
                        ],
                        add: (e) => {
                            e.data = {
                                short: '',
                                name: '',
                                strength: 5,
                                type: '',
                                long: '',
                                nouns: '',
                                adjectives: '',
                                category: '',
                                my_mess: '',
                                your_mess: ''
                            };
                        }
                    }),
                    new WizardPage({
                        title: 'Barkeep properties',
                        body: document.getElementById('mon-wizard-barkeep'),
                        reset: e => {
                            const controls = e.page.querySelectorAll('[id^="mon-wiz-typeData"]');
                            const cl = controls.length;
                            for (let c = 0; c < cl; c++) {
                                let d = controls[c].dataset ? controls[c].dataset.default : null;
                                switch (controls[c].tagName) {
                                    case 'INPUT':
                                        if (controls[c].type === 'checkbox')
                                            controls[c].check = e.wizard.defaults[controls[c].id] || d === 'true' || false;
                                        else if (controls[c].type === 'number')
                                            controls[c].value = e.wizard.defaults[controls[c].id] || +d || 0;
                                        else
                                            controls[c].value = e.wizard.defaults[controls[c].id] || d || '';
                                        break;
                                    case 'SELECT':
                                        $(controls[c]).val(e.wizard.defaults[controls[c].id] || d || '').selectpicker('render');
                                        break;
                                    default:
                                        controls[c].value = e.wizard.defaults[controls[c].id] || d || '';
                                        break;
                                }
                            }
                        }
                    }),
                    new WizardPage({
                        title: 'Advanced properties',
                        body: document.getElementById('mon-wizard-advanced'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-no-corpse').value = e.wizard.defaults['mon-wiz-no-corpse'] || '';
                            e.page.querySelector('#mon-wiz-no-limbs').value = e.wizard.defaults['mon-wiz-no-limbs'] || '';
                            e.page.querySelector('#mon-wiz-party').value = e.wizard.defaults['mon-wiz-limbs'] || '';
                        }
                    }),
                    new WizardDataGridPage({
                        title: 'Custom properties',
                        id: 'mon-wiz-properties',
                        clipboard: 'jiMUD/',
                        mode: 1,
                        columns: [
                            {
                                label: 'Type',
                                field: 'type',
                                width: 150,
                                editor: {
                                    type: EditorType.select,
                                    options: {
                                        data: [
                                            { value: 0, display: 'normal' },
                                            { value: 1, display: 'temporary' }
                                        ]
                                    }
                                },
                                formatter: (data) => {
                                    if (!data) return '';
                                    switch (data.cell) {
                                        case 0:
                                            return 'normal';
                                        case 1:
                                            return 'temporary';
                                    }
                                    return '';
                                },
                                tooltipFormatter: (data) => {
                                    if (!data) return '';
                                    switch (data.cell) {
                                        case 0:
                                            return 'normal';
                                        case 1:
                                            return 'temporary';
                                    }
                                    return '';
                                }
                            },
                            {
                                label: 'Name',
                                field: 'name',
                                width: 150,
                                editor: {
                                    type: EditorType.dropdown,
                                    options: {
                                        container: '#object-wizard',
                                        data: [
                                            'undead',
                                            'waterbreathing',
                                            'requires water',
                                            'canttrack',
                                            'nonetrackable',
                                            'no teleport',
                                            'no steal',
                                            'no corpse',
                                            'no limbs',
                                            'no bleed',
                                            'no sever',
                                            'no manure',
                                            'no attack',
                                            'canseecloaked',
                                            'no wimpy',
                                            'hamstrung',
                                            'command no class',
                                            'no give',
                                            'weapon_two_as_one',
                                            'no open',
                                            'humaniod',
                                            'allow_follow',
                                            'no command failure',
                                            'kill name',
                                            'no add kill',
                                            'entrails object',
                                            'no entrails',
                                            'no weapon drop',
                                            'can look inventory',
                                            'track env',
                                            'no turn'
                                        ]
                                    }
                                }
                            },
                            {
                                label: 'Value',
                                field: 'value',
                                spring: true,
                                width: 200,
                                editor: {
                                    options: {
                                        container: '#object-wizard'
                                    }
                                }
                            }
                        ],
                        add: (e) => {
                            e.data = {
                                type: 1,
                                name: '',
                                value: ''
                            };
                        }
                    }),
                    reputation,
                    new WizardPage({
                        title: 'Movement',
                        mode: 1,
                        body: document.getElementById('mon-wizard-movement'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-speed').value = e.wizard.defaults['mon-wiz-speed'] || '0';
                            e.page.querySelector('#mon-wiz-patrol').value = e.wizard.defaults['mon-wiz-patrol'] || '';
                            e.page.querySelector('#mon-wiz-no-walk').value = e.wizard.defaults['mon-wiz-no-walk'] || '';
                        }
                    }),
                    emotes,
                    new WizardPage({
                        title: 'Combat',
                        body: document.getElementById('mon-wizard-combat'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-chance').value = e.wizard.defaults['mon-wiz-chance'] || '33';
                            e.page.querySelector('#mon-wiz-attack-commands').value = e.wizard.defaults['mon-wiz-attack-commands'] || '';
                            e.page.querySelector('#mon-wiz-initiators').value = e.wizard.defaults['mon-wiz-initiators'] || '';
                        }
                    }),
                    new WizardPage({
                        title: 'Tracking',
                        body: document.getElementById('mon-wizard-tracking'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-tracking').checked = e.wizard.defaults['mon-wiz-tracking'] || false;
                            e.page.querySelector('#mon-wiz-tracking-message').value = e.wizard.defaults['mon-wiz-tracking-message'] || '';
                            e.page.querySelector('#mon-wiz-tracking-type').value = e.wizard.defaults['mon-wiz-tracking-type'] || '';
                            e.page.querySelector('#mon-wiz-tracking-aggressively').checked = e.wizard.defaults['mon-wiz-tracking-aggressively'] || false;
                        }
                    }),
                    new WizardPage({
                        title: 'Aggressive',
                        body: document.getElementById('mon-wizard-aggressive'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-aggressive').value = e.wizard.defaults['mon-wiz-aggressive'] || '';
                        }
                    }),
                    new WizardPage({
                        title: 'Actions',
                        body: document.getElementById('mon-wizard-actions'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-actions').value = e.wizard.defaults['mon-wiz-actions'] || '';
                            e.page.querySelector('#mon-wiz-auto-drop').value = e.wizard.defaults['mon-wiz-drop'] || '1';
                            e.page.querySelector('#mon-wiz-auto-drop-enabled').checked = e.wizard.defaults['mon-wiz-drop-enabled'] || false;
                            e.page.querySelector('#mon-wiz-storage').value = e.wizard.defaults['mon-wiz-storage'] || '3';
                            e.page.querySelector('#mon-wiz-storage-enabled').checked = Object.prototype.hasOwnProperty.call(e.wizard.defaults, '#mon-wiz-storage-enabled') ? e.wizard.defaults['mon-wiz-storage-enabled'] : true;
                            e.page.querySelector('#mon-wiz-auto-wield').value = e.wizard.defaults['mon-wiz-auto-wield'] || '3';
                            e.page.querySelector('#mon-wiz-auto-wield-enabled').checked = Object.prototype.hasOwnProperty.call(e.wizard.defaults, '#mon-wiz-auto-wield-enabled') ? e.wizard.defaults['mon-wiz-auto-wield-enabled'] : true;
                            e.page.querySelector('#mon-wiz-auto-wear').value = e.wizard.defaults['mon-wiz-auto-wear'] || '3';
                            e.page.querySelector('#mon-wiz-auto-wear-enabled').checked = e.wizard.defaults['mon-wiz-auto-wear-enabled'] || false;
                            e.page.querySelector('#mon-wiz-auto-loot').value = e.wizard.defaults['mon-wiz-auto-loot'] || '1';
                            e.page.querySelector('#mon-wiz-auto-loot-enabled').checked = e.wizard.defaults['mon-wiz-auto-loot-enabled'] || false;
                            e.page.querySelector('#mon-wiz-auto-stand').checked = Object.prototype.hasOwnProperty.call(e.wizard.defaults, '#mon-wiz-auto-stand') ? e.wizard.defaults['mon-wiz-auto-stand'] : true;
                            e.page.querySelector('#mon-wiz-wimpy').value = e.wizard.defaults['mon-wiz-wimpy'] || '0';
                        }
                    }),
                    new WizardDataGridPage({
                        title: 'Reactions',
                        id: 'mon-wiz-reactions',
                        clipboard: 'jiMUD/',
                        mode: 1,
                        columns: [
                            {
                                label: 'Type',
                                field: 'type',
                                formatter: data => data ? capitalize(data.cell) : '',
                                tooltipFormatter: data => data ? capitalize(data.cell) : '',
                                width: 150,
                                editor: {
                                    type: EditorType.select,
                                    options: {
                                        container: '#monster-wizard',
                                        data: [
                                            { value: '', display: 'Normal' },
                                            { value: 'party', display: 'Party' },
                                            { value: 'combat', display: 'Combat' },
                                            { value: 'Combat party', display: 'Combat party' }
                                        ],
                                    }
                                }
                            },
                            {
                                label: 'Reaction',
                                field: 'reaction',
                                formatter: data => data ? capitalize(data.cell) : '',
                                tooltipFormatter: data => data ? capitalize(data.cell) : '',
                                width: 200,
                                editor: {
                                    type: EditorType.select,
                                    options: {
                                        data: [
                                            'low health',
                                            'half health',
                                            'hurt',
                                            'full health',
                                            'poisoned',
                                            'bleeding',
                                            'severed limb',
                                            'magic protection',
                                            'faith protection',
                                            'cursed',
                                            'held',
                                            'cloaked',
                                            'no cloak',
                                            '0 minions',
                                            '1 minions',
                                            '2 minions',
                                            '3 minions',
                                            '4 minions',
                                            'encumbered 90',
                                            'encumbered 50',
                                            'encumbered 10',
                                            'present',
                                            'not present',
                                            'enhance',
                                            'enhance self',
                                            'temp property',
                                            'temp properties'
                                        ],
                                        container: '#monster-wizard'
                                    }
                                }
                            },
                            {
                                label: 'Action',
                                field: 'action',
                                spring: true,
                                width: 200,
                                editor: {
                                    options: {
                                        container: '#monster-wizard',
                                        singleLine: true
                                    }
                                }
                            }
                        ],
                        add: (e) => {
                            e.data = {
                                type: '',
                                reaction: '',
                                action: ''
                            };
                        }
                    }),
                    new WizardPage({
                        title: 'Finish',
                        body: document.getElementById('mon-wizard-finish'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-summary').value = '';
                        },
                        shown: (e) => {
                            var summary = e.page.querySelector('#mon-wiz-summary');
                            var data = e.wizard.data;
                            var sum = '<div><span style="font-weight:bold">Type:</span> ' + data['mon-wiz-type'].display + '</div>';
                            sum += '<div><span style="font-weight:bold">Level:</span> ' + data['mon-wiz-level'] + '</div>';
                            if (data['mon-wiz-alignment'] && data['mon-wiz-alignment'].length > 0 && data['mon-wiz-alignment'] !== '0' && data['mon-wiz-alignment'] !== 'neutral')
                                sum += '<div><span style="font-weight:bold">Alignment:</span> ' + (data['mon-wiz-alignment'] || 'neutral') + '</div>';
                            sum += '<div><span style="font-weight:bold">Race:</span> ' + (data['mon-wiz-race'] || 'human') + '</div>';
                            if (data['mon-wiz-class'] && data['mon-wiz-class'].length > 0)
                                sum += '<div><span style="font-weight:bold">Class:</span> ' + data['mon-wiz-class'] + '</div>';
                            if (data['mon-wiz-language'] && data['mon-wiz-language'].length > 0)
                                sum += '<div><span style="font-weight:bold">Lang:</span> ' + data['mon-wiz-language'] + '</div>';
                            if (data['mon-wiz-ridable'])
                                sum += '<div><span style="font-weight:bold">Ridable:</span> Yes</div>';
                            if (data['mon-wiz-flying'])
                                sum += '<div><span style="font-weight:bold">Flying:</span> Yes</div>';
                            if (data['mon-wiz-getable'])
                                sum += '<div><span style="font-weight:bold">Getable:</span> Yes</div>';
                            if (data['mon-wiz-undead'])
                                sum += '<div><span style="font-weight:bold">Undead:</span> Yes</div>';
                            if (data['mon-wiz-waterbreathing'])
                                sum += '<div><span style="font-weight:bold">Water breathing:</span> Yes</div>';
                            if (data['mon-wiz-requires-water'])
                                sum += '<div><span style="font-weight:bold">Requires water:</span> Yes</div>';
                            if (data['mon-wiz-no-bleed'])
                                sum += '<div><span style="font-weight:bold">No bleeding:</span> Yes</div>';
                            sum += '<div><span style="font-weight:bold">Name:</span> ' + data['mon-wiz-name'] + '</div>';
                            sum += '<div><span style="font-weight:bold">Short:</span> ' + data['mon-wiz-short'] + '</div>';
                            sum += '<div><span style="font-weight:bold">Long:</span> ' + ellipse(data['mon-wiz-long']) + '</div>';
                            if (data['mon-wiz-nouns'] && data['mon-wiz-nouns'].length > 0)
                                sum += '<div><span style="font-weight:bold">Nouns:</span> ' + ellipse(data['mon-wiz-nouns'].replace(/\n/g, '')) + '</div>';
                            if (data['mon-wiz-adjectives'] && data['mon-wiz-adjectives'].length > 0)
                                sum += '<div><span style="font-weight:bold">Adjectives:</span> ' + ellipse(data['mon-wiz-adjectives'].replace(/\n/g, '')) + '</div>';
                            if (data['mon-wiz-mass'] > 0)
                                sum += '<div><span style="font-weight:bold">Mass:</span> ' + data['mon-wiz-mass'] + '</div>';
                            sum += '<div><span style="font-weight:bold">Height:</span> ' + data['mon-wiz-height'] + '</div>';
                            if (data['mon-wiz-eye'] && data['mon-wiz-eye'].length > 0)
                                sum += '<div><span style="font-weight:bold">Eyes:</span> ' + data['mon-wiz-eye'] + '</div>';
                            if (data['mon-wiz-hair'] && data['mon-wiz-hair'].length > 0)
                                sum += '<div><span style="font-weight:bold">Hair:</span> ' + data['mon-wiz-hair'] + '</div>';
                            if (data['mon-wiz-gender'].value && data['mon-wiz-gender'].value.length > 0)
                                sum += '<div><span style="font-weight:bold">Gender:</span> ' + data['mon-wiz-gender'].value + '</div>';
                            if (data['mon-wiz-body'] && data['mon-wiz-body'].length > 0)
                                sum += '<div><span style="font-weight:bold">Body type:</span> ' + data['mon-wiz-body'] + '</div>';
                            if (data['mon-wiz-resistances'] && data['mon-wiz-resistances'].length !== 0)
                                sum += '<div><span style="font-weight:bold">Resistances:</span> ' + data['mon-wiz-resistances'].length + '</div>';
                            if (data['mon-wiz-ask'] || data['mon-wiz-ask-topics'].length !== 0)
                                sum += '<div><span style="font-weight:bold">Can ask questions:</span> Yes</div>';
                            if (data['mon-wiz-ask-no-topic'] && data['mon-wiz-ask-no-topic'].length > 0)
                                sum += '<div><span style="font-weight:bold">Ask no topic:</span> ' + ellipse(data['mon-wiz-ask-no-topic'].replace(/\n/g, '')) + '</div>';
                            if (+data['mon-wiz-ask-response'].value !== 0)
                                sum += '<div><span style="font-weight:bold">Ask response type:</span> ' + data['mon-wiz-ask-response'].display + '</div>';
                            if (data['mon-wiz-ask-topics'].length !== 0)
                                sum += '<div><span style="font-weight:bold">Ask topics:</span> ' + data['mon-wiz-ask-topics'].length + '</div>';
                            if (data['mon-wiz-no-corpse'] && data['mon-wiz-no-corpse'].length > 0)
                                sum += '<div><span style="font-weight:bold">No corpse:</span> ' + ellipse(data['mon-wiz-no-corpse'].replace(/\n/g, '')) + '</div>';
                            if (data['mon-wiz-no-limbs'] && data['mon-wiz-no-limbs'].length > 0)
                                sum += '<div><span style="font-weight:bold">No limbs:</span> ' + ellipse(data['mon-wiz-no-limbs'].replace(/\n/g, '')) + '</div>';
                            if (data['mon-wiz-party'] && data['mon-wiz-party'].length > 0)
                                sum += '<div><span style="font-weight:bold">Party:</span> ' + ellipse(data['mon-wiz-party'].replace(/\n/g, '')) + '</div>';

                            if (data['mon-wiz-reputation-group'].length !== 0)
                                sum += '<div><span style="font-weight:bold">Default reputation group:</span> ' + ellipse(data['mon-wiz-reputation-group'].replace(/\n/g, '')) + '</div>';

                            if (data['mon-wiz-reputations'].length !== 0)
                                sum += '<div><span style="font-weight:bold">Reputations:</span> ' + data['mon-wiz-reputations'].length + '</div>';

                            if (data['mon-wiz-speed'] > 0)
                                sum += '<div><span style="font-weight:bold">Speed:</span> ' + data['mon-wiz-speed'] + '</div>';
                            if (data['mon-wiz-patrol'] && data['mon-wiz-patrol'].length > 0)
                                sum += '<div><span style="font-weight:bold">Patrol route:</span> ' + ellipse(data['mon-wiz-patrol'].replace(/\n/g, '')) + '</div>';
                            if (data['mon-wiz-no-walk'] && data['mon-wiz-no-walk'].length > 0)
                                sum += '<div><span style="font-weight:bold">No walk:</span> ' + ellipse(data['mon-wiz-no-walk'].replace(/\n/g, '')) + '</div>';
                            if (data['mon-wiz-attack-commands'] && data['mon-wiz-attack-commands'].length > 0)
                                sum += '<div><span style="font-weight:bold">Attack commands:</span> ' + ellipse(data['mon-wiz-attack-commands'].replace(/\n/g, '')) + '</div>';
                            if (data['mon-wiz-chance'].length > 0)
                                sum += '<div><span style="font-weight:bold">Attack commands chance:</span> ' + data['mon-wiz-chance'] + '%</div>';
                            if (data['mon-wiz-initiators'] && data['mon-wiz-initiators'].length > 0)
                                sum += '<div><span style="font-weight:bold">Attack initiators:</span> ' + ellipse(data['mon-wiz-initiators'].replace(/\n/g, '')) + '</div>';

                            if (data['mon-wiz-tracking'])
                                sum += '<div><span style="font-weight:bold">Enable attacker tracking:</span> ' + (data['mon-wiz-tracking'] ? 'Yes' : 'No') + '</div>';
                            if (data['mon-wiz-tracking-message'].length > 0)
                                sum += '<div><span style="font-weight:bold">Enter message:</span> ' + ellipse(data['mon-wiz-tracking-message']) + '</div>';
                            if (data['mon-wiz-tracking-type'].length > 0)
                                sum += '<div><span style="font-weight:bold">Enter message action:</span> ' + ellipse(data['mon-wiz-tracking-type']) + '</div>';
                            if (data['mon-wiz-tracking-aggressively'])
                                sum += '<div><span style="font-weight:bold">Aggressive:</span> ' + (data['mon-wiz-tracking-aggressively'] ? 'Yes' : 'No') + '</div>';

                            if (data['mon-wiz-aggressive'] && data['mon-wiz-aggressive'].length > 0)
                                sum += '<div><span style="font-weight:bold">Aggressive:</span> ' + ellipse(data['mon-wiz-aggressive']) + '</div>';

                            if (data['mon-wiz-actions'] && data['mon-wiz-actions'].length > 0)
                                sum += '<div><span style="font-weight:bold">Actions:</span> ' + ellipse(data['mon-wiz-actions']) + '</div>';

                            if (data['mon-wiz-reactions'] && data['mon-wiz-reactions'].length > 0)
                                sum += '<div><span style="font-weight:bold">Reactions:</span> ' + data['mon-wiz-reactions'].length + '</div>';

                            if (data['mon-wiz-auto-drop-enabled']) {
                                sum += '<div><span style="font-weight:bold">Auto drop:</span> Yes</div>';
                                sum += '<div><span style="font-weight:bold">Auto drop delay:</span> ' + data['mon-wiz-auto-drop'] + ' seconds</div>';
                            }
                            if (!data['mon-wiz-storage-enabled'])
                                sum += '<div><span style="font-weight:bold">Open storage:</span> No</div>';
                            if (data['mon-wiz-storage'] !== 3)
                                sum += '<div><span style="font-weight:bold">Open storage delay:</span> ' + data['mon-wiz-storage'] + ' seconds</div>';
                            if (!data['mon-wiz-auto-wield-enabled'])
                                sum += '<div><span style="font-weight:bold">Auto wield:</span> Yes</div>';
                            if (data['mon-wiz-auto-wield'] !== 3)
                                sum += '<div><span style="font-weight:bold">Auto wield delay:</span> ' + data['mon-wiz-auto-wield'] + ' seconds</div>';

                            if (data['mon-wiz-auto-loot-enabled'])
                                sum += '<div><span style="font-weight:bold">Auto loot:</span> Yes</div>';
                            if (data['mon-wiz-auto-loot'] !== 1)
                                sum += '<div><span style="font-weight:bold">Auto loot delay:</span> ' + data['mon-wiz-auto-loot'] + ' seconds</div>';

                            if (data['mon-wiz-auto-wear-enabled'])
                                sum += '<div><span style="font-weight:bold">Auto wear:</span> Yes</div>';
                            if (data['mon-wiz-auto-wear'] !== 3)
                                sum += '<div><span style="font-weight:bold">Auto wear delay:</span> ' + data['mon-wiz-auto-wear'] + ' seconds</div>';

                            if (data['mon-wiz-wimpy'] !== 0)
                                sum += '<div><span style="font-weight:bold">Wimpy:</span> ' + data['mon-wiz-wimpy'] + '%</div>';
                            if (!data['mon-wiz-auto-stand'])
                                sum += '<div><span style="font-weight:bold">Auto stand:</span> No</div>';
                            if (data['mon-wiz-properties'] && data['mon-wiz-properties'].length !== 0)
                                sum += '<div><span style="font-weight:bold">Custom properties:</span> ' + data['mon-wiz-properties'].length + '</div>';


                            if (data['mon-wiz-includes'] && data['mon-wiz-includes'].length > 0)
                                sum += '<div><span style="font-weight:bold">Includes:</span> ' + data['mon-wiz-includes'].length + '</div>';
                            if (data['mon-wiz-defines'] && data['mon-wiz-defines'].length > 0)
                                sum += '<div><span style="font-weight:bold">Defines:</span> ' + data['mon-wiz-defines'].length + '</div>';
                            if (data['mon-wiz-inherits'] && data['mon-wiz-inherits'].length > 0)
                                sum += '<div><span style="font-weight:bold">Inherits:</span> ' + data['mon-wiz-inherits'].length + '</div>';
                            if (data['mon-wiz-variables'] && data['mon-wiz-variables'].length > 0)
                                sum += '<div><span style="font-weight:bold">Variables:</span> ' + data['mon-wiz-functions'].length + '</div>';
                            if (data['mon-wiz-functions'] && data['mon-wiz-functions'].length > 0)
                                sum += '<div><span style="font-weight:bold">Functions:</span> ' + data['mon-wiz-functions'].length + '</div>';
                            if (data['mon-wiz-commands'] && data['mon-wiz-commands'].length > 0)
                                sum += '<div><span style="font-weight:bold">Commands:</span> ' + data['mon-wiz-commands'].length + '</div>';
                            summary.innerHTML = sum;
                        }
                    })
                ]
            });
            $('#mon-wiz-type').on('change', (e) => {
                if ($dialogs.monster.options && $dialogs.monster.options.typeChange)
                    $dialogs.monster.options.typeChange(e);
            });
            $dialogs.monster.height = '402px';
            $dialogs.monster.on('mode-changed', () => {
                options.monWizardMode = $dialogs.monster.mode;
            })
            $dialogs.monster.on('value-changed', e => {
                if ($dialogs.monster.options && $dialogs.monster.options.valueChanged)
                    $dialogs.monster.options.valueChanged(e);
                if (e.preventDefault) return;
                if (e.id === 'mon-wiz-type') {
                    let type = (e.type || 0) | getMonsterTypeFlags(e.value);
                    let page;
                    page = $dialogs.monster.pages.find(i => i.title === 'Vendor properties');
                    page.visible = (type & MonsterTypeFlags.Vendor) === MonsterTypeFlags.Vendor;
                    page = $dialogs.monster.pages.find(i => i.title === 'Vendor advanced properties');
                    page.visible = (type & MonsterTypeFlags.Vendor) === MonsterTypeFlags.Vendor;
                    page = $dialogs.monster.pages.find(i => i.title === 'Barkeep menu');
                    page.visible = (type & MonsterTypeFlags.Barkeep) === MonsterTypeFlags.Barkeep;
                    page = $dialogs.monster.pages.find(i => i.title === 'Barkeep properties');
                    page.visible = (type & MonsterTypeFlags.Barkeep) === MonsterTypeFlags.Barkeep;
                }
            });
            $dialogs.monster.on('open', () => {
                menubar.enabled = false;
            });
            $dialogs.monster.on('close', () => {
                menubar.enabled = true;
                if ($dialogs.monster.options && $dialogs.monster.options.groups) {
                    var groups = Object.keys($dialogs.monster.options.groups);
                    groups.forEach(g => {
                        var el = document.getElementById(g.replace(/ /g, ''));
                        if (el) el.remove();
                    });
                    $('#mon-wiz-type').selectpicker('refresh');
                }
                if ($dialogs.monster.options && $dialogs.monster.options.pages)
                    $dialogs.monster.removePages($dialogs.monster.options.pages);
                if ($dialogs.monster.options && $dialogs.monster.options.closed)
                    $dialogs.monster.options.closed();
            });
            $dialogs.monster.on('cancel', () => {
                menubar.enabled = true;
                if ($dialogs.monster.options && $dialogs.monster.options.groups) {
                    var groups = Object.keys($dialogs.monster.options.groups);
                    groups.forEach(g => {
                        var el = document.getElementById(g.replace(/ /g, ''));
                        if (el) el.remove();
                    });
                    $('#mon-wiz-type').selectpicker('refresh');
                }
                if ($dialogs.monster.options && $dialogs.monster.options.pages)
                    $dialogs.monster.removePages($dialogs.monster.options.pages);
                if ($dialogs.monster.options && $dialogs.monster.options.closed)
                    $dialogs.monster.options.closed();
            });
            $dialogs.monster.on('finished', async (e) => {
                if ($dialogs.monster.options && $dialogs.monster.options.groups) {
                    var groups = Object.keys($dialogs.monster.options.groups);
                    groups.forEach(g => {
                        var el = document.getElementById(g.replace(/ /g, ''));
                        if (el) el.remove();
                    });
                    $('#mon-wiz-type').selectpicker('refresh');
                }
                if ($dialogs.monster.options && $dialogs.monster.options.pages)
                    $dialogs.monster.removePages($dialogs.monster.options.pages);
                if ($dialogs.monster.options && $dialogs.monster.options.finish) {
                    $dialogs.monster.options.finish(e);
                    return;
                }
                var value = fs.readFileSync(parseTemplate(path.join('{assets}', 'templates', 'wizards', 'monster.c')), 'utf8');
                var data = e.data;
                var tmpl = baseParseData();
                var tmp, tmp2, tmp3;
                var props = [];
                var tempProps = [];
                var stubs = {};
                let typeFlags = getMonsterTypeFlags(data['mon-wiz-type'].value);
                tmpl.inherit = data['mon-wiz-type'].value;
                tmpl.includes = data['mon-wiz-type'].display === 'Base' ? '\n#include "../area.h"' : '';
                tmpl.inherits = '';
                tmpl['doc'] = [];
                tmpl['create pre'] = '';
                tmpl['create body'] = '';
                tmpl['create post'] = '';
                switch (data['mon-wiz-type'].display) {
                    case 'Base':
                        tmpl.doc.push('/doc/build/areas/tutorial');
                        break;
                    case 'Armor Repair':
                        tmpl.doc.push('/doc/build/monster/types/smith');
                        tmpl.doc.push('/doc/build/monster/types/vendor');
                        break;
                    case 'Barkeep':
                        tmpl.doc.push('/doc/build/monster/types/barkeep');
                        break;
                    case 'Cleric Trainer':
                        tmpl.doc.push('/doc/build/monster/types/cleric_trainer');
                        break;
                    case 'Command Trainer':
                        tmpl.doc.push('/doc/build/monster/types/subclasser');
                        break;
                    case 'Healer':
                        tmpl.doc.push('/doc/build/monster/types/healer');
                        break;
                    case 'Jeweler':
                        tmpl.doc.push('/doc/build/monster/types/jeweler');
                        tmpl.doc.push('/doc/build/monster/types/vendor');
                        break;
                    case 'Lock pick Repair':
                        tmpl.doc.push('/doc/build/monster/types/lockpick_repair');
                        tmpl.doc.push('/doc/build/monster/types/vendor');
                        break;
                    case 'Mage Trainer':
                        tmpl.doc.push('/doc/build/monster/types/mage_trainer');
                        break;
                    case 'Edible Monster':
                        tmpl.doc.push('/doc/build/monster/types/mon_edible');
                        break;
                    case 'Sage':
                        tmpl.doc.push('/doc/build/monster/types/sage');
                        tmpl.doc.push('/doc/build/etc/sagebase');
                        break;
                    case 'Skill Trainer':
                        tmpl.doc.push('/doc/build/monster/types/skill_trainer');
                        break;
                    case 'Smith':
                        tmpl.doc.push('/doc/build/monster/types/smith');
                        tmpl.doc.push('/doc/build/monster/types/vendor');
                        break;
                    case 'Summon Monster':
                        tmpl.doc.push('/doc/build/monster/types/summon');
                        break;
                    case 'Tattooist':
                        tmpl.doc.push('/doc/build/monster/types/tattooist');
                        break;
                    case 'Trainer':
                        tmpl.doc.push('/doc/build/monster/types/subclasser');
                        break;
                    case 'Vendor':
                        tmpl.doc.push('/doc/build/monster/types/vendor');
                        break;
                    case 'Weapon Repair':
                        tmpl.doc.push('/doc/build/monster/types/smith');
                        tmpl.doc.push('/doc/build/monster/types/vendor');
                        break;
                    case 'Shipwright':
                        tmpl.doc.push('/doc/build/monster/haggle');
                        tmpl.doc.push('/doc/build/monster/types/shipwright');
                        break;
                    case 'Crafter':
                        tmpl.doc.push('/doc/build/monster/types/crafter');
                        tmpl.doc.push('/doc/build/monster/types/skill_trainer');
                        tmpl.doc.push('/doc/build/monster/types/smith');
                        tmpl.doc.push('/doc/build/monster/types/vendor');
                        break;
                }
                if ((typeFlags & MonsterTypeFlags.Vendor) === MonsterTypeFlags.Vendor) {
                    if (data['mon-wiz-typeData-storageroom']) {
                        data['mon-wiz-typeData-storageroom'] = data['mon-wiz-typeData-storageroom'].trim();
                        if (data['mon-wiz-typeData-storageroom'].startsWith('"') && data['mon-wiz-typeData-storageroom'].endsWith('"'))
                            tmpl['create body'] += `    set_storage_room(${data['mon-wiz-typeData-storageroom']})\n`;
                        else
                            tmpl['create body'] += `    set_storage_room("${data['mon-wiz-typeData-storageroom'].replace(/"/g, '\\"')}")\n`;
                    }
                    if (data['mon-wiz-typeData-vender'] && data['mon-wiz-typeData-vender'].trim().length && data['mon-wiz-typeData-vender'].trim() !== 'treasure')
                        tmpl['create body'] += `    set_vendor("${data['mon-wiz-typeData-vender'].trim()}");\n`;
                    if (data['mon-wiz-typeData-use_default_storage'])
                        tmpl['create body'] += `    set_use_default_storage(1);\n`;
                    if (data['mon-wiz-typeData-no_clean_storage'])
                        tmpl['create body'] += `    set_no_clean_storage(1);\n`;
                    if (data['mon-wiz-typeData-list_items'] && data['mon-wiz-typeData-list_items'].trim().length) {
                        tmp = data['mon-wiz-typeData-list_items'].split(',').map(i => '"' + i.trim() + '"');
                        if (tmp.length > 1)
                            tmpl['create body'] += `    set_list_items(${tmp.join(', ')});\n`;
                        else
                            tmpl['create body'] += `    set_list_item(${tmp[0]});\n`;
                    }
                    if (data['mon-wiz-typeData-list_long'] && data['mon-wiz-typeData-list_long'].trim().length)
                        tmpl['create body'] += `    set_list_long("${data['mon-wiz-typeData-vender'].trim()}");\n`;

                    if (data['mon-wiz-typeData-list_type'] && data['mon-wiz-typeData-list_type'].trim().length && data['mon-wiz-typeData-list_type'].trim() !== 'item')
                        tmpl['create body'] += `    set_list_type("${data['mon-wiz-typeData-list_type'].trim()}");\n`;
                    if (Object.hasOwn(data, 'on-wiz-typeData-display_list_item') && !data['mon-wiz-typeData-display_list_item'])
                        tmpl['create body'] += `    set_display_list_item(0);\n`;

                    if (data['mon-wiz-typeData-max_item'] && data['mon-wiz-typeData-max_item'] !== 5)
                        tmpl['create body'] += `    set_max_item(${data['mon-wiz-typeData-max_item']});\n`;
                    if (data['mon-wiz-typeData-permanent_percent'] && data['mon-wiz-typeData-permanent_percent'] !== 0.05)
                        tmpl['create body'] += `    set_permanent_percent(${data['mon-wiz-typeData-permanent_percent']});\n`;
                    if (data['mon-wiz-typeData-permanent_offset'] && data['mon-wiz-typeData-permanent_offset'] !== 5.0)
                        tmpl['create body'] += `    set_permanent_offset(${data['mon-wiz-typeData-permanent_offset']});\n`;
                    if (data['mon-wiz-typeData-currency_type'] && data['mon-wiz-typeData-currency_type'].value && data['mon-wiz-typeData-currency_type'].value.length)
                        tmpl['create body'] += `    set_currency_type("${data['mon-wiz-typeData-currency_type'].value}");\n`;
                    if (data['mon-wiz-typeData-only_currency_type'] === true)
                        tmpl['create body'] += `    set_currency_type(1);\n`;
                    if (data['mon-wiz-typeData-translate'] === true)
                        tmpl['create body'] += `    set_translate(1);\n`;
                    if (data['mon-wiz-typeData-translate_list'] === true)
                        tmpl['create body'] += `    set_translate_list(1);\n`;
                    if (data['mon-wiz-typeData-translate_commands'] === true)
                        tmpl['create body'] += `    set_translate_commands(1);\n`;
                    if (data['mon-wiz-typeData-enable_price_tracking'] === true)
                        tmpl['create body'] += `    set_enable_price_tracking(1);\n`;
                    if (data['mon-wiz-typeData-price_tracking_weight'] && data['mon-wiz-typeData-price_tracking_weight'] !== 30.0)
                        tmpl['create body'] += `    set_price_tracking_weight(${data['mon-wiz-typeData-price_tracking_weight']});\n`;
                    if (data['mon-wiz-typeData-price_tracking_max'] && data['mon-wiz-typeData-price_tracking_max'] !== 15.0)
                        tmpl['create body'] += `    set_price_tracking_max(${data['mon-wiz-typeData-price_tracking_max']});\n`;
                }

                if ((typeFlags & MonsterTypeFlags.Barkeep) === MonsterTypeFlags.Barkeep) {
                    tmpl['create body'] += '/* Start barkeep properties*/\n';
                    if (data['mon-wiz-typeData-menu'] && Array.isArray(data['mon-wiz-typeData-menu']) && data['mon-wiz-typeData-menu'].length) {
                        tmpl['create body'] += `    create_menu( ([\n`;
                        tmp = data['mon-wiz-typeData-menu'].map(i => {
                            return `      "${i.short}": (["name":"${i.name}", "strength": ${i.strength}, "type":"${i.type}",\n
      "long": "${i.long}", 
      "nouns": ({ ${(Array.isArray(i.nouns) ? i.nouns : i.nouns.splitQuote()).map(n => '"' + n.trim().replace(/^"(.+(?="$))?"$/, '$1') + '"').join(', ')} }), 
      "adjectives": ({ ${(Array.isArray(i.adjectives) ? i.adjectives : i.adjectives.splitQuote()).map(n => '"' + n.trim().replace(/^"(.+(?="$))?"$/, '$1') + '"').join(', ')} }), 
      "category": "${i.category}",
      "my_mess":"${i.my_mess}",
      "your_mess": "${i.your_mess}"
   ])`});
                        tmpl['create body'] += tmp.join(',');
                        tmpl['create body'] += `    ]) );\n`;
                    }
                    if (data['mon-wiz-typeData-menu_title'] && data['mon-wiz-typeData-menu_title'].trim().length)
                        tmpl['create body'] += `    set_menu_title("${data['mon-wiz-typeData-menu_title'].trim().replace(/"/g, '\\"')}");\n`;
                    if (data['mon-wiz-typeData-read_items'] && data['mon-wiz-typeData-read_items'].trim().length && data['mon-wiz-typeData-read_items'].trim() !== 'menu') {
                        tmp = data['mon-wiz-typeData-read_items'].splitQuote().map(v => '"' + v.trim().replace(/"/g, '\\"') + '"');
                        if (tmp.length === 1)
                            tmpl['create body'] += `    set_read_item(${tmp[0]});\n`;
                        else
                            tmpl['create body'] += `    set_read_items(${tmp[0].join(', ')})\;n`;
                    }
                    if (data['mon-wiz-typeData-no_money_message'] && data['mon-wiz-typeData-no_money_message'].trim().length)
                        tmpl['create body'] += `    set_no_money_message("${data['mon-wiz-typeData-no_money_message'].trim().replace(/"/g, '\\"')}");\n`;
                    if (data['mon-wiz-typeData-premenu'] && data['mon-wiz-typeData-premenu'].trim().length)
                        tmpl['create body'] += `    set_premenu("${data['mon-wiz-typeData-premenu'].trim().replace(/"/g, '\\"')}");\n`;
                    if (data['mon-wiz-typeData-postmenu'] && data['mon-wiz-typeData-postmenu'].trim().length)
                        tmpl['create body'] += `    set_postmenu("${data['mon-wiz-typeData-postmenu'].trim().replace(/"/g, '\\"')}");\n`;
                    if (data['mon-wiz-typeData-refill'] === true)
                        tmpl['create body'] += `    set_refill(1);\n`;
                    if (data['mon-wiz-typeData-buy_empty'] === true)
                        tmpl['create body'] += `    set_buy_empty(1);\n`;
                    tmpl['create body'] += '/* End barkeep properties*/\n';
                }

                if (data['mon-wiz-includes'] && tmpl['mon-wiz-includes'].length) {
                    tmpl.includes += data['mon-wiz-includes'].map(i => {
                        if (i.relative)
                            return `\n#include "${i.path}"`;
                        return `\n#include <${i.path}>`;
                    }).join('');
                }
                if (data['mon-wiz-inherits'] && data['mon-wiz-inherits'].length)
                    tmpl.inherits += data['mon-wiz-inherits'].map(i => `\ninherit ${i};`).join('');

                if (data['mon-wiz-defines']) {
                    data['mon-wiz-defines'].forEach(r => tmpl['create pre'] += `#define ${r.key}${r.value && r.value.trim().length ? ' ' + r.value.trim() : ''}\n`);
                    if (data['mon-wiz-defines'].length)
                        tmpl['create pre'] += '\n';
                }
                if (data['mon-wiz-variables']) {
                    tmpl['create pre'] += data['mon-wiz-variables'].map(
                        variable => {
                            if (variable.type == 'function' || (variable.type === 'mixed' && variable.value.trim().startsWith('(:'))) {
                                tmp3 = formatFunctionPointer(variable.value);
                                if (!stubs[tmp3]) {
                                    tmpl['create pre'] += createFunction(tmp3);
                                    stubs[tmp3] = 1;
                                }
                            }
                            return `${variable.type || 'mixed'}${variable.name} = ${formatVariableValue(variable.type, variable.value, 0)};\n`;
                        }
                    ).join('');
                    tmpl['reset body'] += data['mon-wiz-variables'].filter(v => v.reset).map(
                        variable => `${variable.name} = ${formatVariableValue(variable.type, variable.value, 0)};\n`
                    ).join('');
                    if (tmp.length)
                        tmpl['create pre'] += '\n';
                }

                if (data['mon-wiz-functions']) {
                    data['mon-wiz-functions'].forEach(func => {
                        tmpl['create pre'] += createFunction(func.name, func);
                        stubs[formatFunctionPointer(func.name)] = 1;
                    });
                }

                if (data['mon-wiz-commands'] && data['mon-wiz-commands'].length) {
                    data['create post'] += '\n\nvoid init()\n{\n';
                    data['mon-wiz-commands'].forEach(r => {
                        const cmds = r.name.split(',').map(c => c.trim());
                        tmp = r.function;
                        if (cmds.length > 1) {
                            if (!tmp || !tmp.length)
                                tmp = 'cmd_' + cmds[0];
                            tmpl['create post'] += `    add_action("${tmp}", ({ "${cmds.join('", "')}" }) );\n`;
                        }
                        else {
                            if (!tmp || !tmp.length)
                                tmp = 'cmd_' + r.name.trim();
                            tmpl['create post'] += `    add_action("${tmp}", "${r.name.trim()}");\n`;
                        }
                        if (!stubs[formatFunctionPointer(tmp)]) {
                            tmpl['create pre'] += createFunction(tmp, 'int', 'string args', '   return 1;');
                            stubs[formatFunctionPointer(tmp)] = 1;
                        }
                    });
                    tmpl['create post'] += '}';
                }

                if (data['mon-wiz-name'].startsWith('"') && data['mon-wiz-name'].endsWith('"')) {
                    tmpl['name'] = data['mon-wiz-name'].substr(1, data['mon-wiz-name'].length - 2).replace(/"/g, '\\"');
                }
                else
                    tmpl['name'] = data['mon-wiz-name'].replace(/"/g, '\\"');
                data['mon-wiz-short'] = data['mon-wiz-short'].trim();
                if (data['mon-wiz-short'].startsWith('(:')) {
                    tmpl['short'] = formatFunctionPointer(data['mon-wiz-short']);
                    if (!stubs[tmpl['short']]) {
                        tmpl['create pre'] += createFunction(data['mon-wiz-short'], 'string');
                        stubs[tmpl['short']] = 1;
                    }
                }
                else if (data['mon-wiz-short'].startsWith('"') && data['mon-wiz-short'].endsWith('"'))
                    tmpl['short'] = `${data['mon-wiz-short']}`;
                else
                    tmpl['short'] = `"${data['mon-wiz-short'].replace(/"/g, '\\"')}"`;
                data['mon-wiz-long'] = data['mon-wiz-long'].trim();
                if (data['mon-wiz-long'].startsWith('(:')) {
                    tmpl['long'] = formatFunctionPointer(data['mon-wiz-long']);
                    if (!stubs[tmpl['long']]) {
                        tmpl['create pre'] += createFunction(data['mon-wiz-long'], 'string');
                        stubs[tmpl['long']] = 1
                    }
                    tmpl['description'] = data['mon-wiz-long'].substr(2);
                    if (tmpl['description'].endsWith(':)'))
                        tmpl['description'] = tmpl['description'].substr(0, tmpl['description'].length - 2);
                    tmpl['description'] = tmpl['description'].trim();
                }
                else {
                    if (!data['mon-wiz-long'].startsWith('"') && !data['mon-wiz-long'].endsWith('"'))
                        data['mon-wiz-long'] = data['mon-wiz-long'].replace(/"/g, '\\"');
                    if (data['mon-wiz-long'].startsWith('"'))
                        data['mon-wiz-long'] = data['mon-wiz-long'].substr(1);
                    if (data['mon-wiz-long'].endsWith('"'))
                        data['mon-wiz-long'] = data['mon-wiz-long'].substr(0, data['mon-wiz-long'].length - 1);
                    if (data['mon-wiz-long'].length > 70) {
                        tmpl['description'] = formatString(data['mon-wiz-long'], 0, 77, ' * ', '');
                        tmp = data['mon-wiz-long'].substr(0, 66);
                        let tl = tmp.length;
                        while (tl--) {
                            if (tmp.charAt(tl) === ' ') {
                                tmp = tmp.substr(0, tl + 1);
                                break;
                            }
                        }
                        tmpl['long'] = `"${tmp}"\n     `;
                        data['mon-wiz-long'] = data['mon-wiz-long'].substr(tmp.length);
                        tmpl['long'] += `${formatString(data['mon-wiz-long'], 5, 73)}`;
                    }
                    else {
                        tmpl['long'] = `"${data['mon-wiz-long']}"`;
                        tmpl['description'] = ' * ' + data['mon-wiz-long'];
                    }
                }
                tmpl['description'] = stripPinkfish(tmpl['description']);
                tmpl['height'] = data['mon-wiz-height'];

                tmpl['create arguments'] = `${data['mon-wiz-level']}, "${data['mon-wiz-race'] || 'human'}"`;
                tmpl['create arguments comment'] = '';
                if (data['mon-wiz-class'].length > 0) {
                    tmpl['create arguments'] += `, "${data['mon-wiz-class']}"`;
                    tmpl['create arguments comment'] += ', Class';
                }
                else if (data['mon-wiz-body'].length > 0) {
                    tmpl['create arguments'] += ', 0';
                    tmpl['create arguments comment'] += ', No class';
                }
                if (data['mon-wiz-body'].length > 0) {
                    tmpl['create arguments'] += `, "${data['mon-wiz-body']}"`;
                    tmpl['create arguments comment'] += ', Body type';
                }
                if (data['mon-wiz-nouns'].length > 0) {

                    data['mon-wiz-nouns'] = data['mon-wiz-nouns'].split(',');
                    data['mon-wiz-nouns'] = data['mon-wiz-nouns'].map(w => {
                        w = w.trim();
                        if (!w.startsWith('"'))
                            w = '"' + w;
                        if (!w.endsWith('"'))
                            w += '"';
                        return w;
                    });
                    tmpl['create body'] += '   set_nouns(' + data['mon-wiz-nouns'].join(', ') + ');\n';
                }
                if (data['mon-wiz-adjectives'].length > 0) {
                    data['mon-wiz-adjectives'] = data['mon-wiz-adjectives'].split(',');
                    data['mon-wiz-adjectives'] = data['mon-wiz-adjectives'].map(w => {
                        w = w.trim();
                        if (!w.startsWith('"'))
                            w = '"' + w;
                        if (!w.endsWith('"'))
                            w += '"';
                        return w;
                    });
                    tmpl['create body'] += '   set_adjectives(' + data['mon-wiz-adjectives'].join(', ') + ');\n';
                }

                if (data['mon-wiz-undead'])
                    props['undead'] = 1;
                if (data['mon-wiz-waterbreathing'])
                    props['waterbreathing'] = 1;
                if (data['mon-wiz-requires-water'])
                    props['requires water'] = 1;
                if (data['mon-wiz-no-bleed'])
                    props['no bleed'] = 1;
                data['mon-wiz-no-corpse'] = data['mon-wiz-no-corpse'].trim();
                if (data['mon-wiz-no-corpse'].startsWith('(:')) {
                    props['no corpse'] = formatFunctionPointer(data['mon-wiz-no-corpse']);
                    if (!stubs[props['no corpse']]) {
                        tmpl['create pre'] += createFunction(data['mon-wiz-no-corpse'], 'string');
                        stubs[props['no corpse']] = 1;
                    }
                }
                else if (data['mon-wiz-no-corpse'].startsWith('"') && data['mon-wiz-no-corpse'].endsWith('"'))
                    props['no corpse'] = data['mon-wiz-no-corpse'];
                else if (data['mon-wiz-no-corpse'].length > 0)
                    props['no corpse'] = `"${data['mon-wiz-no-corpse'].replace(/"/g, '\\"')}"`;
                data['mon-wiz-no-limbs'] = data['mon-wiz-no-limbs'].trim();
                if (data['mon-wiz-no-limbs'].startsWith('(:')) {
                    props['no limbs'] = formatFunctionPointer(data['mon-wiz-no-limbs']);
                    if (!stubs[props['no limbs']]) {
                        tmpl['create pre'] += createFunction(data['mon-wiz-no-limbs'], 'string');
                        stubs[props['no limbs']] = 1;
                    }
                }
                else if (data['mon-wiz-no-limbs'].startsWith('"') && data['mon-wiz-no-limbs'].endsWith('"'))
                    props['no limbs'] = data['mon-wiz-no-limbs'];
                else if (data['mon-wiz-no-limbs'].length > 0)
                    props['no limbs'] = `"${data['mon-wiz-no-limbs'].replace(/"/g, '\\"')} "`;

                if (data['mon-wiz-properties'].length > 0) {
                    data['mon-wiz-properties'].forEach(b => {
                        b.value = b.value.trim();
                        if (b.value.startsWith('([')) {
                            if (b.type === 1)
                                tempProps[b.name] = formatMapping(b.value, 5);
                            else
                                props[b.name] = formatMapping(b.value, 5);
                        }
                        else if (b.value.startsWith('(:')) {
                            if (b.type === 1)
                                tempProps[b.name] = formatFunctionPointer(b.value);
                            else
                                props[b.name] = formatFunctionPointer(b.value);
                            if (!stubs[formatFunctionPointer(b.value)]) {
                                tmpl['create pre'] += createFunction(b.value);
                                stubs[formatFunctionPointer(b.value)] = 1;
                            }
                        }
                        else if (b.value.startsWith('({')) {
                            if (b.type === 1)
                                tempProps[b.name] = formatArray(b.value);
                            else
                                props[b.name] = formatArray(b.value);
                        }
                        else if ((b.value.startsWith('"') && b.value.endsWith('"')) || b.value.match(/^\d+$/) || b.value.match(/^-?([0-9]+\.[0-9]+)$/)) {
                            if (b.type === 1)
                                tempProps[b.name] = b.value;
                            else
                                props[b.name] = b.value;
                        }
                        else {
                            if (b.type === 1)
                                tempProps[b.name] = `"${b.value}"`;
                            else
                                props[b.name] = `"${b.value}"`;
                        }
                    });
                }

                tempProps = Object.keys(tempProps).map(k => `"${k}" : ${tempProps[k]}`);
                props = Object.keys(props).map(k => `"${k}" : ${props[k]}`);

                if (tempProps.length === 1)
                    tmpl['create body'] += `   set_temp_property(${tempProps[0].replace(' :', ',')});\n`;
                else if (tempProps.length > 0) {
                    tmpl['create body'] += '   set_temp_properties( ([\n       ';
                    tmpl['create body'] += tempProps.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }

                if (props.length === 1)
                    tmpl['create body'] += `   set_property(${props[0].replace(' :', ',')});\n`;
                else if (props.length > 0) {
                    tmpl['create body'] += '   set_properties( ([\n       ';
                    tmpl['create body'] += props.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }

                if (data['mon-wiz-mass'] > 0)
                    tmpl['create body'] += `   set_mass(${data['mon-wiz-mass']});\n`;
                //tmpl['create body'] += `   set_height(${data['mon-wiz-height']});\n`;
                if (data['mon-wiz-alignment'].length > 0 && data['mon-wiz-alignment'] !== '0' && data['mon-wiz-alignment'] !== 'neutral') {
                    if (typeof data['mon-wiz-alignment'] === 'string' && parseFloat(data['mon-wiz-alignment']).toString() == data['mon-wiz-alignment'])
                        tmpl['create body'] += `   set_alignment(${data['mon-wiz-alignment']});\n`;
                    else
                        tmpl['create body'] += `   set_alignment("${data['mon-wiz-alignment']}");\n`;
                }
                if (data['mon-wiz-language'].length > 0)
                    tmpl['create body'] += `   set_primary_lang("${data['mon-wiz-language']}");\n`;
                if (data['mon-wiz-gender'].value && data['mon-wiz-gender'].value.length > 0) {
                    if (data['mon-wiz-gender'].value === 'random')
                        tmpl['create body'] += '   set_gender(random(2) ? "male" : "female");\n';
                    else
                        tmpl['create body'] += `   set_gender("${data['mon-wiz-gender'].value}");\n`;
                }
                if (data['mon-wiz-eye'].length > 0)
                    tmpl['create body'] += `   set_eyecolor("${data['mon-wiz-eye']}");\n`;
                if (data['mon-wiz-hair'].length > 0)
                    tmpl['create body'] += `   set_haircolor("${data['mon-wiz-hair']}");\n`;
                if (data['mon-wiz-ridable'])
                    tmpl['create body'] += '   set_rideable(1); //Enable riding\n   set_follow_type("steed");/ /set the follow type to steed for proper limiting\n';
                if (data['mon-wiz-flying'])
                    tmpl['create body'] += '   set_can_fly(1); //Enable fly/land abilities\n';
                if (data['mon-wiz-getable'])
                    tmpl['create body'] += '   set_getable(1); //turn on getable\n';
                data['mon-wiz-speed'] = data['mon-wiz-speed'] || 0;
                if (data['mon-wiz-patrol'].length > 0)
                    tmpl['create body'] += `   set_patrol(${data['mon-wiz-speed']}, ${formatArgumentList(data['mon-wiz-patrol'], 64 - ('' + data['mon-wiz-speed']).length)}); //Set speed and patrol route\n`;
                else if (data['mon-wiz-speed'] > 0)
                    tmpl['create body'] += `   set_speed(${data['mon-wiz-speed']}); //Set speed\n`;
                if (data['mon-wiz-no-walk'].length > 0)
                    tmpl['create body'] += `   set_no_walk(${formatArgumentList(data['mon-wiz-no-walk'], 63, 0, 0, true)}); //Set no walk rooms\n`;
                if (data['mon-wiz-chance'] !== 0)
                    tmpl['create body'] += `   set_spell_chance(${data['mon-wiz-chance']}); //Set the chance an attack command will be used\n`;
                if (data['mon-wiz-attack-commands'].length > 0)
                    tmpl['create body'] += `   set_spells(${formatArgumentList(data['mon-wiz-attack-commands'], 64)}); //Set attack commands\n`;
                if (data['mon-wiz-initiators'].length > 0)
                    tmpl['create body'] += `   set_combat_initiator(${formatArgumentList(data['mon-wiz-initiators'], 56)}); //Set attack initiators\n`;
                if (data['mon-wiz-aggressive'].length > 0) {
                    if (data['mon-wiz-aggressive'].trim().startsWith('(['))
                        tmpl['create body'] += `   set_aggressive( ${formatMapping(data['mon-wiz-aggressive'], 5).trim()} ); //Set monster aggressiveness\n`;
                    else
                        tmpl['create body'] += `   set_aggressive(${data['mon-wiz-aggressive'].trim()}); //Set monster aggressiveness\n`;
                    tmpl['doc'].push('/doc/build/monster/haggle');
                    tmpl['doc'].push('/doc/build/monster/aggressive');
                }
                if (data['mon-wiz-party'].length > 0)
                    tmpl['create body'] += `   set_mon_party("${data['mon-wiz-party']}");\n`;
                if (data['mon-wiz-auto-drop-enabled'])
                    tmpl['create body'] += '   set_auto_drop(1);\n';
                if (data['mon-wiz-auto-drop'] !== 1)
                    tmpl['create body'] += `   set_auto_drop_delay(${data['mon-wiz-auto-drop']});\n`;
                if (!data['mon-wiz-storage-enabled'])
                    tmpl['create body'] += '   set_open_storage(0);\n';
                if (data['mon-wiz-storage'] !== 3)
                    tmpl['create body'] += `   set_open_storage_delay(${data['mon-wiz-storage']});\n`;
                if (!data['mon-wiz-auto-wield-enabled'])
                    tmpl['create body'] += '   set_auto_wield(0);\n';
                if (data['mon-wiz-auto-wield'] !== 3)
                    tmpl['create body'] += `   set_auto_wield_delay(${data['mon-wiz-auto-wield']});\n`;
                if (data['mon-wiz-auto-loot-enabled'])
                    tmpl['create body'] += '   set_auto_loot(1);\n';
                if (data['mon-wiz-auto-loot'] !== 1)
                    tmpl['create body'] += `   set_auto_loot_delay(${data['mon-wiz-auto-loot']});\n`;
                if (data['mon-wiz-auto-wear-enabled'])
                    tmpl['create body'] += '   set_auto_wear(1);\n';
                if (data['mon-wiz-auto-wear'] !== 3)
                    tmpl['create body'] += `   set_auto_wear_delay(${data['mon-wiz-auto-wear']});\n`;
                if (data['mon-wiz-wimpy'] !== 0)
                    tmpl['create body'] += `   set_wimpy(${data['mon-wiz-wimpy']});\n`;
                if (!data['mon-wiz-auto-stand'])
                    tmpl['create body'] += '   set_auto_stand(0);\n';
                data['mon-wiz-reactions'] = data['mon-wiz-reactions'].filter(r => r.reaction.length > 0);
                if (data['mon-wiz-reactions'].length === 1)
                    tmpl['create body'] += `   set_reaction("${data['mon-wiz-reactions'][0].type.length > 0 ? data['mon-wiz-reactions'][0].type + ' ' : ''}${data['mon-wiz-reactions'][0].reaction}", "${data['mon-wiz-reactions'][0].action}");\n`;
                else if (data['mon-wiz-reactions'].length > 1) {
                    tmpl['create body'] += '   set_reactions( ([\n';
                    tmpl['create body'] += data['mon-wiz-reactions'].map(r => `       "${r.type.length > 0 ? r.type + ' ' : ''}${r.reaction}" : "${r.action}"`).join(',\n');
                    tmpl['create body'] += '\n     ]) );\n';
                }

                if (data['mon-wiz-tracking'])
                    tmpl['create body'] += '   set_track_attackers(1);\n';
                if (data['mon-wiz-tracking-message'].length > 0)
                    tmpl['create body'] += `   set_track_enter_message("${data['mon-wiz-tracking-message']}");\n`;
                if (data['mon-wiz-tracking'].length > 0)
                    tmpl['create body'] += `   set_track_enter_message_type("${data['mon-wiz-tracking-type']}");\n`;
                if (data['mon-wiz-tracking-aggressively'])
                    tmpl['create body'] += '   set_track_aggressively_only(1);\n';

                if (data['mon-wiz-ask'] && data['mon-wiz-ask-topics'].length === 0)
                    tmpl['create body'] += '   set_enable_ask(1);\n';
                if (data['mon-wiz-ask-no-topic'].trim().length !== 0)
                    tmpl['create body'] += `   set_no_topic("${data['mon-wiz-ask-no-topic'].trim()}");\n`;
                switch (+data['mon-wiz-ask-response'].value) {
                    case 1:
                        tmpl['create body'] += '   set_response_type("tell");\n';
                        break;
                    case 2:
                        tmpl['create body'] += '   set_response_type("speak");\n';
                        break;
                    case 3:
                        tmpl['create body'] += '   set_response_type("whisper");\n';
                        break;
                    case 4:
                        tmpl['create body'] += '   set_response_type("custom");\n';
                        break;
                }
                tmp = data['mon-wiz-ask-topics'].map(i => {
                    tmp2 = i.topic.split(',').map(t => {
                        t.trim();
                        if (!t.startsWith('"') && !t.endsWith('"'))
                            t = '"' + t + '"';
                        return t;
                    });
                    if (tmp2.length === 1)
                        tmp2 = tmp2[0];
                    else
                        tmp2 = `({ ${tmp2.join(', ')} })`;
                    tmp3 = i.message.trim();
                    if (tmp3.startsWith('(:')) {
                        tmp3 = formatFunctionPointer(tmp3);
                        if (!stubs[tmp3]) {
                            tmpl['create pre'] += createFunction(tmp3, 'string', 'object player, string topic');
                            stubs[tmp3] = 1;
                        }
                    }
                    else if (!tmp3.startsWith('"') && !tmp3.endsWith('"'))
                        tmp3 = '"' + tmp3 + '"';
                    return `${tmp2} : ${tmp3}`;
                });

                if (tmp.length === 1) {
                    if (!data['mon-wiz-ask-topics'][0].topic.trim().startsWith('"') && !data['mon-wiz-ask-topics'][0].topic.trim().endsWith('"'))
                        data['mon-wiz-ask-topics'][0].topic = `"${data['mon-wiz-ask-topics'][0].topic.trim()}"`;
                    data['mon-wiz-ask-topics'][0].message = data['mon-wiz-ask-topics'][0].message.trim();
                    if (data['mon-wiz-ask-topics'][0].message.startsWith('(:')) {
                        tmp3 = formatFunctionPointer(data['mon-wiz-ask-topics'][0].message);
                        tmpl['create body'] += `   set_topic(${data['mon-wiz-ask-topics'][0].topic}, ${tmp3});\n`;
                        if (!stubs[tmp3]) {
                            tmpl['create pre'] += createFunction(tmp3, 'string', 'object player, string topic');
                            stubs[tmp3] = 1;
                        }
                    }
                    else if (!data['mon-wiz-ask-topics'][0].message.startsWith('"') && !data['mon-wiz-ask-topics'][0].message.endsWith('"'))
                        tmpl['create body'] += `   set_topic(${data['mon-wiz-ask-topics'][0].topic}, "${data['mon-wiz-ask-topics'][0].message}");\n`;
                    else
                        tmpl['create body'] += `   set_topic(${data['mon-wiz-ask-topics'][0].topic}, ${data['mon-wiz-ask-topics'][0].message});\n`;
                }
                else if (tmp.length > 0) {
                    tmpl['create body'] += '   set_topics( ([\n       ';
                    tmpl['create body'] += tmp.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }

                if (data['mon-wiz-reputation-group'].length !== 0)
                    tmpl['create body'] += `   set_reputation_area("${data['mon-wiz-reputation-group'].trim()}");\n`;
                //#region emotes
                tmp = data['mon-wiz-emotes'].filter(s => s.type === 0).map(i => {
                    tmp3 = i.message.trim();
                    if (tmp3.startsWith('(:')) {
                        tmp3 = formatFunctionPointer(tmp3);
                        if (!stubs[tmp3]) {
                            tmpl['create pre'] += createFunction(tmp3, 'mixed', 'object monster');
                            stubs[tmp3] = 1;
                        }
                    }
                    else if (!tmp3.startsWith('"') && !tmp3.endsWith('"'))
                        tmp3 = '"' + tmp3 + '"';
                    return tmp3;
                });
                if (tmp.length !== 0)
                    tmpl['create body'] += `   set_emotes(${data['mon-wiz-emotes-chance']}, ({\n       ${tmp.join(',\n       ')}\n     }) );\n`;
                tmp = data['mon-wiz-emotes'].filter(s => s.type === 1).map(i => {
                    tmp3 = i.message.trim();
                    if (tmp3.startsWith('(:')) {
                        tmp3 = formatFunctionPointer(tmp3);
                        if (!stubs[tmp3]) {
                            tmpl['create pre'] += createFunction(tmp3, 'mixed', 'object monster');
                            stubs[tmp3] = 1;
                        }
                    }
                    else if (!tmp3.startsWith('"') && !tmp3.endsWith('"'))
                        tmp3 = '"' + tmp3 + '"';
                    return tmp3;
                });
                if (tmp.length !== 0)
                    tmpl['create body'] += `   set_emotes(${data['mon-wiz-emotes-chance-combat']}, ({\n       ${tmp.join(',\n       ')}\n     }), 1);\n`;
                //#endregion
                //#region speeches
                tmp = {};
                data['mon-wiz-emotes'].filter(s => s.type === 2 && s.language.length !== 0).forEach(i => {
                    tmp3 = i.message.trim();
                    if (tmp3.startsWith('(:')) {
                        tmp3 = formatFunctionPointer(tmp3);
                        if (!stubs[tmp3]) {
                            tmpl['create pre'] += createFunction(tmp3, 'mixed', 'object monster, string language');
                            stubs[tmp3] = 1;
                        }
                    }
                    else if (!tmp3.startsWith('"') && !tmp3.endsWith('"'))
                        tmp3 = '"' + tmp3 + '"';
                    if (!tmp[i.language])
                        tmp[i.language] = [tmp3];
                    else
                        tmp[i.language].push(tmp3);
                });
                Object.keys(tmp).forEach(k => {
                    tmpl['create body'] += `   set_speech(${data['mon-wiz-speech-chance']}, "${k}", ({\n       ${tmp[k].join(',\n       ')}\n     }) );\n`;
                });
                tmp = {};
                data['mon-wiz-emotes'].filter(s => s.type === 3 && s.language.length !== 0).forEach(i => {
                    tmp3 = i.message.trim();
                    if (tmp3.startsWith('(:')) {
                        tmp3 = formatFunctionPointer(tmp3);
                        if (!stubs[tmp3]) {
                            tmpl['create pre'] += createFunction(tmp3, 'mixed', 'object monster, string language');
                            stubs[tmp3] = 1;
                        }
                    }
                    else if (!tmp3.startsWith('"') && !tmp3.endsWith('"'))
                        tmp3 = '"' + tmp3 + '"';
                    if (!tmp[i.language])
                        tmp[i.language] = [tmp3];
                    else
                        tmp[i.language].push(tmp3);
                });
                Object.keys(tmp).forEach(k => {
                    tmpl['create body'] += `   set_speech(${data['mon-wiz-speech-chance-combat']}, "${k}", ({\n       ${tmp[k].join(',\n       ')}\n     }), 1);\n`;
                });
                //#endregion

                if (data['mon-wiz-resistances'] && data['mon-wiz-resistances'].length) {
                    if (data['mon-wiz-resistances'].length.length === 1)
                        tmpl['create body'] += `   add_permanent_resistance(\"${data['mon-wiz-resistances'][0].type}\", ${data['mon-wiz-resistances'][0].amount});\n`;
                    else {
                        tmpl['create body'] += '   add_permanent_resistances( ([\n       ';
                        data['mon-wiz-resistances'].forEach(r => {
                            tmpl['create body'] += `\"${r.type}\" : ${r.amount},\n       `;
                        });
                        tmpl['create body'] = tmpl['create body'].substring(0, tmpl['create body'].length - 9) + '\n     ]) );\n';
                    }
                }

                data['mon-wiz-reputations'].forEach(r => {
                    if (!r.amount) return;
                    r.amount.trim();
                    if (r.amount.length === 0 || r.amount === '0') return;
                    const fun = r.type === 1 ? 'ondie' : 'onattack';
                    r.group = r.group.trim();
                    if (r.group.length !== 0 && !r.group.startsWith('"') && !r.group.endsWith('"'))
                        r.group = `"${r.group.replace(/"/g, '\\"')}", `;
                    else if (r.group.length !== 0)
                        r.group = `${r.group}, `;

                    if (typeof r.amount === 'string' && parseFloat(r.amount).toString() == r.amount)
                        tmpl['create body'] += `   set_reputation_${fun}(${r.group}${r.amount});\n`;
                    else if (r.amount.startsWith('(:')) {
                        tmp3 = formatFunctionPointer(r.amount);
                        tmpl['create body'] += `   set_reputation_${fun}(${r.group}${tmp3});\n`;
                        if (!stubs[tmp3]) {
                            tmpl['create pre'] += createFunction(tmp3, 'string', 'object monster, object killer');
                            stubs[tmp3] = 1;
                        }
                    }
                    else if (!r.amount.startsWith('"') && !r.amount.endsWith('"'))
                        tmpl['create body'] += `   set_reputation_${fun}(${r.group}"${r.amount}");\n`;
                    else
                        tmpl['create body'] += `   set_reputation_${fun}(${r.group}${r.amount});\n`;
                });

                if (data['mon-wiz-actions'].length > 0) {
                    data['mon-wiz-actions'] = data['mon-wiz-actions'].split(',');
                    data['mon-wiz-actions'].forEach(w => {
                        w = w.trim();
                        if (w.length === 0) return;
                        if (!w.startsWith('"'))
                            w = '"' + w;
                        if (!w.endsWith('"'))
                            w += '"';
                        tmpl['create body'] += `   command(${w});\n`;
                    });
                }
                if (tmpl['doc'].length > 0)
                    tmpl['doc'] = ' * @doc ' + tmpl['doc'].join('\n * @doc ') + '\n';
                else
                    tmpl['doc'] = '';

                var f = data['mon-wiz-name'].replace(/\s/g, '_').toLowerCase();
                if (!f || f.length === 0) {
                    if (data['mon-wiz-type'].display === 'Standard' || data['mon-wiz-type'].display === 'Base')
                        f = ('new_monster_' + newCounter);
                    else
                        f = ('new_' + data['mon-wiz-type'].display.replace(/\s/g, '_') + '_' + newCounter);
                }
                f += '.c';
                f.toLowerCase();
                newFromValueFormatted(parseFileTemplate(value, tmpl), f);
                newCounter++;
            });
        }
        $dialogs.monster.title = opts ? (opts.title || 'Create new monster...') : 'Create new monster...';
        $dialogs.monster.defaults = dData || {};
        $dialogs.monster.options = opts;
        if (opts && opts.pages)
            $dialogs.monster.insertPages($dialogs.monster.pages.length - 1, opts.pages);
        $dialogs.monster.show();
    }

    function ellipse(text, len) {
        if (!len || len < 1) len = 15;
        if (!text || text.lengt <= len) return text || '';
        return text.substr(0, len) + '&hellip;';
    }

    function writeFile(file, data) {
        var fd = fs.openSync(file, fs.constants.O_WRONLY | fs.constants.O_CREAT | fs.constants.O_TRUNC | fs.constants.O_SYNC);
        fs.writeSync(fd, data);
        fs.fsyncSync(fd);
        fs.closeSync(fd);
    }

    async function openRemote(remoteFile) {
        var p;
        if (p = findEditor('remote:' + remoteFile)) {
            manager.switchToPanel(p);
            doUpdate(17);
            flushRecent();
            return;
        }
        if (!connected) {
            dialog.showMessageBox({
                type: 'error',
                title: 'Must be logged into the mud',
                message: 'Must be connected to the mud to open a remote file',
                defaultId: 1,
                noLink: true
            });
            return;
        }
        if (remoteFile && remoteFile.length !== 0) {
            var t = tmp.tmpNameSync(tmpOptions);
            _ied.downloadToFile(remoteFile, t, false, 'editor-download:remote-open:' + (manager.active ? manager.active.id : 0) + ':' + $id, false);
            showProgressDialog({
                file: remoteFile,
                tag: 'editor-download:remote-open:' + (manager.active ? manager.active.id : 0) + ':' + $id,
                title: 'Downloading&hellip;',
                tmp: t
            });
            $id++;
        }
        else {
            showBrowseDialog({
                defaultFile: manager.active.editor.remote || (options.remote + "/" + path.basename(manager.active.editor.file)),
                properties: ['openFile'],
                filters: $fileFilters,
            }, (files) => {
                if (!files || files.length === 0) return;
                var t = tmp.tmpNameSync(tmpOptions);
                _ied.downloadToFile(files[0], t, false, 'editor-download:remote-open:' + (manager.active ? manager.active.id : 0) + ':' + $id, false);
                showProgressDialog({
                    file: files[0],
                    tag: 'editor-download:remote-open:' + (manager.active ? manager.active.id : 0) + ':' + $id,
                    title: 'Downloading&hellip;',
                    tmp: t
                });
                $id++;
            });
        }
    }

    async function openFile(file, remoteFile, dock, remoteEdit, tmpObj) {
        if (!file || file.length === 0) {
            if (remoteEdit)
                openRemote(remoteFile);
            else
                dialog.showOpenDialog({
                    filters: $fileFilters,
                    properties: ['multiSelections', 'openFile'],
                    defaultPath: (manager.active && manager.active.editor) ? path.dirname(manager.active.editor.file) : (options.recent && options.recent.length ? path.dirname(options.recent[0].file) : '')
                }).then(result => {
                    if (result.filePaths === undefined || result.filePaths.length === 0) {
                        return;
                    }
                    openFiles(result.filePaths.map((l) => { return { file: l }; }), true, dock);
                });
        }
        else if (isDirSync(file)) {
            dialog.showMessageBox({
                type: 'info',
                title: 'Can not open folders',
                message: '\'' + file + '\' is a folder not a file.'
            });
        }
        else {
            _opening[file] = 1;
            if (!remoteFile || remoteFile.length === 0)
                remoteFile = getRemoteCache(file);
            else if (!remoteEdit)
                setRemoteCache(file, remoteFile);
            if (!remoteEdit)
                _recent.unshift({ file: file, remote: remoteFile });
            createEditor({ file: file, open: true, remote: remoteFile, source: remoteEdit ? 1 : 0 }, true, dock, tmpObj);
            doUpdate(17);
            flushRecent();
            delete _opening[file];
        }
    }

    async function openFiles(files, exists, dock) {
        if (files.length === 0) return;
        var panels = [];
        for (var f = 0, fl = files.length; f < fl; f++) {
            if (typeof files[f].file !== 'string') {
                if (files[f].remoteEdit && (!files[f].file || files[f].file.length === 0))
                    openRemote(files[f].remote);
                continue;
            }
            if (!files[f].remoteEdit && isDirSync(files[f].file)) {
                dialog.showMessageBox({
                    type: 'info',
                    title: 'Can not open folders',
                    message: '\'' + files[f].file + '\' is a folder not a file.'
                });
                continue;
            }
            if (!files[f].remoteEdit && !existsSync(files[f].file)) {
                if (exists)
                    dialog.showMessageBox({
                        type: 'info',
                        title: 'Path does not exist',
                        message: 'The path \'' + files[f].file + '\' does not seem to exist anymore on disk.'
                    });
                continue;
            }
            _opening[files[f].file || files[f].path] = 1;
            if (!files[f].remote || files[f].remote.length === 0)
                files[f].remote = getRemoteCache(files[f].file || files[f].path);
            else if (!files[f].remoteEdit)
                setRemoteCache(files[f].file || files[f].path, files[f].remote);
            if (!files[f].remoteEdit)
                _recent.unshift({ file: files[f].file || files[f].path, remote: files[f].remote });
            else if (files[f].remoteEdit && (!files[f].file || files[f].file.length === 0)) {
                openRemote(files[f].remote);
                continue;
            }
            var p = createEditor({ file: files[f].file || files[f].path, remote: files[f].remote, open: true, source: files[f].remoteEdit ? 1 : 0 });
            if (p)
                panels.push(p);
            delete _opening[files[f].file || files[f].path];
        }
        manager.addPanels(panels, dock);
        doUpdate(17);
        flushRecent()
    }

    function setRemoteCache(file, remoteFile) {
        if (!options.cacheRemote || !remoteFile || remoteFile.length === 0) return;
        if (typeof remoteFile !== 'string') return;
        let p = path.join(parseTemplate('{data}'), 'editor');
        if (!existsSync(p))
            fs.mkdirSync(p);
        krypto = krypto || require('crypto');
        let name = krypto.createHash('md5').update(file).digest('hex');
        fs.writeFileSync(path.join(p, name), remoteFile);
    }

    function getTempDir() {
        let p = path.join(parseTemplate('{data}'), 'editor.temp');
        if (!existsSync(p))
            fs.mkdirSync(p);
        return p;
    }

    function getRemoteCache(file) {
        if (!options.cacheRemote || !file || file.length === 0) return null;
        krypto = krypto || require('crypto');
        let name = path.join(parseTemplate('{data}'), 'editor', krypto.createHash('md5').update(file).digest('hex'));
        if (!existsSync(name)) return null;
        return fs.readFileSync(name, 'utf8');
    }

    function getViewState(file) {
        if (!options.viewState || !file || file.length === 0) return null;
        krypto = krypto || require('crypto');
        let name = path.join(parseTemplate('{data}'), 'editor', krypto.createHash('md5').update(file).digest('hex') + '.state');
        if (!existsSync(name)) return null;
        try {
            return JSON.parse(fs.readFileSync(name, 'utf8'));
        }
        catch (err) {
            return null;
        }
    }

    // eslint-disable-next-line no-unused-vars
    function setViewState(editor, codeEditor) {
        var file;
        if (typeof editor === 'string')
            editor = { file: editor };
        if (!editor || editor.new || _loading) return;
        var file = editor.file;
        var state = codeEditor.saveViewState();
        if (!options.viewState || !file || !state) return;
        let p = path.join(parseTemplate('{data}'), 'editor');
        if (!existsSync(p))
            fs.mkdirSync(p);
        krypto = krypto || require('crypto');
        let name = krypto.createHash('md5').update(file).digest('hex') + '.state';
        fs.writeFileSync(path.join(p, name), JSON.stringify(state));
    }

    function addToRecent(file, remoteFile) {
        if (!options) loadOptions();
        if (!options.recent) options.recent = [];
        var recent = [];
        var r = options.recent.length;
        var f = getFilePath(file);
        while (r--) {
            if (getFilePath(options.recent[r].file) !== f)
                recent.unshift(options.recent[r]);
        }
        recent.unshift({ file: file, remote: remoteFile });
        if (recent.length > options.maxRecent)
            options.recent = recent.slice(0, options.maxRecent);
        else
            options.recent = recent;
        ipcRenderer.invoke('get-app', 'addRecentDocument', file);
        doUpdate(20);
    }

    function flushRecent() {
        if (!_recent.length) return;
        var r = _recent.length;
        while (r--) {
            addToRecent(_recent[r].file, _recent[r].remoteFile);
        }
        _recent = [];
        doUpdate(4);
    }

    async function buildRecent() {
        var menu = [];
        var r = options.recent.length;
        while (r--) {
            if (options.hideOpenRecent && findEditor(options.recent[r].file))
                continue;
            menu.unshift(
                {
                    label: options.recent[r].file,
                    idx: r,
                    click: (item) => {
                        if (!existsSync(options.recent[item.idx].file)) {
                            dialog.showMessageBox({
                                type: 'info',
                                title: 'Path does not exist',
                                message: 'The path \'' + options.recent[item.idx].file + '\' does not seem to exist anymore on disk.'
                            });
                            options.recent.splice(item.idx, 1);
                            doUpdate(20);
                        }
                        else
                            openFile(options.recent[item.idx].file, options.recent[item.idx].remote);
                    }
                }
            );
        }
        if (menu.length > 0) {
            for (let acc = 0; acc < 9 && acc < menu.length; acc++)
                menu[acc].accelerator = 'CmdOrCtrl+' + (acc + 1);
            if (menu.length > 9)
                menu[9].accelerator = 'CmdOrCtrl+0';
            menu.push({ type: 'separator' });
            menu.push({
                label: 'Clear Recently Opened',
                click: () => {
                    options.recent = [];
                    doUpdate(20);
                }
            });
        }
        menubar.updateItem('file|open recent', { submenu: menu });
    }

    function saveFile(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        if (panel.editor.new)
            return saveFileAs(panel);
        try {
            panel.editor.save();
        }
        catch (err) {
            dialog.showMessageBox({
                type: 'error',
                title: 'Error saving',
                message: err.toString(),
                defaultId: 1,
                noLink: true
            });
            return false;
        }
        if (panel.editor.source === 1) {
            if (!connected) {
                dialog.showMessageBox({
                    type: 'error',
                    title: 'Must be logged into the mud',
                    message: 'Saving remote files requires being connected to the mud',
                    defaultId: 1,
                    noLink: true
                });
                return;
            }
            panel.editor.upload();
        }
        if (manager.active && manager.active.editor)
            manager.active.editor.focus();
        return true;
    }

    function saveAllFiles() {
        var keys = Object.keys(_editors);
        var k = keys.length;
        var p;
        while (k--) {
            p = keys[k];
            if (!_editors[p].editor.new && !_editors[p].editor.changed)
                continue;
            if (!saveFile(_editors[p]))
                return false;
        }
        return true;
    }

    function saveFileAs(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        if (panel.editor.source === 1) {
            if (!connected) {
                dialog.showMessageBox({
                    type: 'error',
                    title: 'Must be logged into the mud',
                    message: 'Saving remote files requires being connected to the mud',
                    defaultId: 1,
                    noLink: true
                });
                return;
            }
            uploadFileAs(panel, true);
            return;
        }
        var file = dialog.showSaveDialogSync({
            title: 'Save as...',
            defaultPath: panel.editor.file,
            filters: $fileFilters
        });
        if (file === undefined || file.length === 0)
            return false;
        let old = panel.editor.file;
        if (!panel.editor.canSaveAs())
            return false;
        panel.editor.file = file;
        panel.editor.remote = '';
        manager.setPanelTooltip(panel.editor.file, panel);
        manager.setPanelTitle(panel.editor.filename, panel);
        if (manager.active && manager.active.editor && manager.active.editor === panel.editor)
            document.title = 'Code editor - ' + manager.active.tab.innerText + (window.opener ? window.opener.childWindowTitle() : '');
        try {
            panel.editor.save();
        }
        catch (err) {
            dialog.showMessageBox({
                type: 'error',
                title: 'Error saving',
                message: err.toString(),
                defaultId: 1,
                noLink: true
            });
            return false;
        }
        addToRecent(file);
        delete _editors[getFilePath(old)];
        _editors[getFilePath(file)] = panel;
        if (manager.active && manager.active.editor) {
            manager.active.editor.focus();
            sbName.textContent = manager.active.editor.source === Source.local ? manager.active.editor.file : manager.active.editor.remote;
            sbName.title = manager.active.editor.source === Source.local ? manager.active.editor.file : manager.active.editor.remote;
        }
        return true;
    }

    function uploadFile(panel) {
        if (!connected) {
            dialog.showMessageBox({
                type: 'error',
                title: 'Must be logged into the mud',
                message: 'Uploading requires being connected to the mud',
                defaultId: 1,
                noLink: true
            });
            return;
        }
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        if (!panel.editor.supports('upload')) return;
        if (!panel.editor.remote || panel.editor.remote.length === 0) {
            showBrowseDialog({
                defaultFile: panel.editor.remote || (options.remote + "/" + path.basename(manager.active.editor.file)),
                properties: ['saveFile'],
                filters: $fileFilters,
                arguments: panel
            }, (files) => {
                if (!files || files.length === 0) return;
                $dialog.options.arguments.editor.remote = files[0];
                if (!$dialog.options.arguments.editor.new)
                    setRemoteCache($dialog.options.arguments.editor.file, $dialog.options.arguments.editor.remote);
                $dialog.options.arguments.editor.upload();
            });
        }
        else
            panel.editor.upload();
    }

    function uploadFileAs(panel, remoteEdit) {
        if (!connected) {
            dialog.showMessageBox({
                type: 'error',
                title: 'Must be logged into the mud',
                message: 'Uploading requires being connected to the mud',
                defaultId: 1,
                noLink: true
            });
            return;
        }
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        if (!panel.editor.supports('upload-as')) return;
        showBrowseDialog({
            defaultFile: remoteEdit ? panel.editor.remote : (options.uploadAs || panel.editor.remote || (options.remote + "/" + path.basename(manager.active.editor.file))),
            title: 'Save remote file as...',
            properties: ['saveFile'],
            filters: $fileFilters,
        }, (files) => {
            if (!files || files.length === 0) return;
            if (remoteEdit)
                panel.editor.remote = files[0];
            panel.editor.upload();
            options.uploadAs = files[0];
            saveOptions();
        });
    }

    function closeEditor(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        panel.editor.close();
        if (panel.tmp) {
            if (typeof panel.tmp === 'string') {
                if (existsSync(panel.tmp))
                    fs.unlinkSync(panel.tmp);
            }
            else {
                var t = panel.tmp.name;
                panel.tmp.removeCallback();
                panel.tmp = null;
                if (existsSync(t))
                    fs.unlinkSync(t);
            }
        }
        if (panel.diffFile)
            stopWatchFile(panel.diffFile);
        if (!panel.editor.source && existsSync(panel.editor.file))
            addToRecent(panel.editor.file, panel.editor.remote);
        if (panel.editor.source)
            delete _editors['remote:' + panel.editor.remote];
        else
            delete _editors[getFilePath(panel.editor.file)];
    }

    function revertFile(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        var choice;
        if (panel.editor.changed && panel.editor.new) {
            choice = dialog.showMessageBoxSync({
                type: 'question',
                title: 'Revert new file?',
                message: 'Revert ' + panel.editor.filename + ' to start and lose changes?',
                buttons: ['Yes', 'No'],
                defaultId: 1,
                noLink: true
            });
            if (choice === 0)
                panel.editor.revert();
        }
        else if (panel.editor.changed && !panel.editor.new) {
            choice = dialog.showMessageBoxSync({
                type: 'question',
                title: 'Revert file?',
                message: 'Revert ' + panel.editor.filename + ' and lose changes?',
                buttons: ['Yes', 'No'],
                defaultId: 1,
                noLink: true
            });
            if (choice === 0)
                panel.editor.revert();
        }
        if (manager.active && manager.active.editor)
            manager.active.editor.focus();
    }

    function revertAllFiles() {
        var keys = Object.keys(_editors);
        var k = keys.length;
        var p;
        while (k--) {
            p = keys[k];
            //not changed try next
            if (!_editors[p].editor.changed)
                continue;
            if (!revertFile(_editors[p]))
                return false;
        }
        return true;
    }

    function closeFile(panel) {
        if (!panel) {
            if (!manager.active)
                return;
            panel = manager.active;
        }
        if (panel) {
            if (panel.editor && panel.editor.clean)
                panel.editor.clean();
            manager.removePanel(panel);
        }
        if (manager.active && manager.active.editor)
            manager.active.editor.focus();
    }

    function closeAllFiles() {
        manager.removeAllPanels();
    }

    function confirmSave(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        var choice = dialog.showMessageBoxSync({
            type: 'question',
            title: panel.editor.new ? 'Save file?' : 'Save changes?',
            message: panel.editor.new ? ('Save ' + panel.editor.filename + '?') : ('Save changes to ' + panel.editor.filename + '?'),
            buttons: ['Yes', 'No', 'Cancel'],
            defaultId: 1,
            noLink: true
        });
        //canceled
        if (choice === 2)
            return false;
        //no
        if (choice === 1)
            return true;
        //attempt to save
        return saveFile(panel);
    }

    function sortFiles(a, b, p) {
        if (fs.lstatSync(path.join(p, a)).isDirectory())
            return -1;
        if (fs.lstatSync(path.join(p, b)).isDirectory())
            return 1;
        return a.localeCompare(b);
    }

    function loadTemplates(p, root, exclude) {
        const menu = [];
        const files = fs.readdirSync(p);
        files.sort((a, b) => { return sortFiles(a, b, p); });
        const fl = files.length;
        var base = false;
        for (let f = 0; f < fl; f++) {
            if (exclude && exclude.indexOf(files[f]) !== -1)
                continue;
            if (fs.lstatSync(path.join(p, files[f])).isDirectory()) {
                menu.push({
                    label: capitalize(path.basename(files[f], path.extname(files[f])).replace(/_/g, ' ')),
                    submenu: loadTemplates(path.join(p, files[f]), path.join(root, files[f]))
                });
            }
            else {
                if (files[f] === 'base.c') {
                    base = true;
                    continue;
                }
                menu.push({
                    label: capitalize(path.basename(files[f], path.extname(files[f])).replace(/_/g, ' ')),
                    path: path.join(root, files[f]),
                    click: openTemplate
                });
            }
        }
        if (base) {
            if (menu.length > 0)
                menu.unshift({ type: 'separator' });
            menu.unshift(
                {
                    label: 'base',
                    newName: path.basename(p).replace(/_/g, ' ').slice(0, -1),
                    path: path.join(root, 'base.c'),
                    click: openTemplate
                }
            );
        }
        return menu;
    }

    function openTemplate(item) {
        newFromFile(parseTemplate(path.join('{assets}', 'templates', item.path)), (item.newName || item.label).toLowerCase());
    }

    function findEditor(file) {
        if (!file || file.length === 0)
            return 0;
        return _editors[getFilePath(file)];
    }

    function watchFile(file) {
        if (!_watched[file]) {
            _watched[file] = 1;
            watcher.add(file);
        }
        else
            _watched[file]++;
    }

    function stopWatchFile(file) {
        _watched[file]--;
        if (_watched[file] === 0) {
            watcher.unwatch(file);
            delete _watched[file];
        }
    }

    function createEditor(data, add, dock, tmpObj) {//file, open, remoteFile, _new, value) {
        var p;
        if (data.source)
            p = findEditor('remote:' + data.remote);
        else
            p = findEditor(data.file);
        if (p) {
            p.editor.remote = data.remote;
            manager.switchToPanel(p);
            return null;
        }
        else {
            _loading++;
            p = manager.createPanel(data.source ? path.basename(data.remote) : path.basename(data.file), getFileIcon(data.file), data.file);
            p.tmp = tmpObj;
            data.container = p.pane;
            data.watch = (files) => {
                if (!files) return;
                for (var f = 0, fl = files.length; f < fl; f++)
                    watchFile(files[f]);
            };
            data.watchStop = (files) => {
                if (!files) return;
                for (var f = 0, fl = files.length; f < fl; f++) {
                    stopWatchFile(files[f]);
                }
            };
            if (path.extname(data.file) === '.design') {
                data.options = options.designOptions;
                try {
                    p.editor = new AreaDesigner(data);
                    p.editor.objWizardMode = options.objWizardMode;
                    p.editor.includePaths = options.includePaths;
                }
                catch (err) {
                    dialog.showMessageBox({
                        type: 'info',
                        title: 'Error opening file',
                        message: 'Could not open \'' + data.file + '\'.'
                    });
                    if (options && options.debug)
                        console.log(err);
                }

                p.editor.on('show-room-wizard', e => {
                    roomWizard(e.data, e);
                });
                p.editor.on('show-monster-wizard', e => {
                    monsterWizard(e.data, e);
                });
                p.editor.on('show-resize', size => {
                    showResizeDialog(size);
                });
                p.editor.on('show-area', e => {
                    newArea(e.title, e.ok, e.name);
                });
                p.editor.on('dialog-close', () => menubar.enabled = true);
                p.editor.on('dialog-cancel', () => menubar.enabled = true);
                p.editor.on('dialog-open', () => menubar.enabled = false);
                /*
                p.editor.on('room-dblclick', (room) => {
                });
                */
                p.editor.on('map-context-menu', () => {
                    let temp = [];
                    if (p.editor.supports('undo'))
                        temp.push({
                            label: 'Undo',
                            click: doUndo,
                            accelerator: 'CmdOrCtrl+Z'
                        });
                    if (p.editor.supports('redo'))
                        temp.push({
                            label: 'Redo',
                            click: doRedo,
                            accelerator: 'CmdOrCtrl+Y'
                        });
                    if (p.editor.supports('undo') || p.editor.supports('redo'))
                        temp.push({ type: 'separator' });
                    temp.push({
                        label: 'Cut',
                        click: doCut,
                        accelerator: 'CmdOrCtrl+C'
                    });
                    temp.push({
                        label: 'Copy',
                        click: doCopy,
                        accelerator: 'CmdOrCtrl+X'
                    });
                    if (p.editor.supports('paste'))
                        temp.push({
                            label: 'Paste',
                            click: doPaste,
                            accelerator: 'CmdOrCtrl+V'
                        });
                    temp.push({ type: 'separator' });
                    temp.push({
                        label: 'Delete',
                        click: () => {
                            p.editor.delete();
                            p.editor.focus();
                        },
                        accelerator: 'Delete'
                    });
                    temp.push({ type: 'separator' });
                    temp.push({
                        label: 'Edit items',
                        click: () => {
                            p.editor.openItems();
                        }
                    });
                    temp.push({
                        label: 'Edit objects',
                        click: () => {
                            p.editor.openObjects();
                        }
                    });
                    temp.push({
                        label: 'Edit monsters',
                        click: () => {
                            p.editor.openMonsters();
                        }
                    });
                    temp.push({
                        label: 'Edit exits',
                        click: () => {
                            p.editor.openExits();
                        }
                    });
                    let inputMenu = Menu.buildFromTemplate(temp);
                    inputMenu.popup({ window: remote.getCurrentWindow() });
                });
            }
            else if (path.extname(data.file) === '.map' && data.source !== 1) {
                data.options = options.virtualOptions;
                try {
                    p.editor = new VirtualEditor(data);
                }
                catch (err) {
                    dialog.showMessageBox({
                        type: 'info',
                        title: 'Error opening file',
                        message: 'Could not open \'' + data.file + '\'.'
                    });
                    if (options && options.debug)
                        console.log(err);
                }
                p.editor.on('show-resize', size => {
                    showResizeDialog(size);
                });
                p.editor.on('dialog-close', () => menubar.enabled = true);
                p.editor.on('dialog-cancel', () => menubar.enabled = true);
                p.editor.on('dialog-open', () => menubar.enabled = false);
                p.editor.on('room-dblclick', async (room) => {
                    var f;
                    if (p.editor.maxLevel > 1)
                        f = room.x + ',' + room.y + ',' + room.z + '.c';
                    else
                        f = room.x + ',' + room.y + '.c';
                    f = path.join(path.dirname(p.editor.file), f);
                    if (existsSync(f))
                        openFile(f);
                    else if (dialog.showMessageBoxSync({
                        type: 'question',
                        title: 'Create room?',
                        message: 'Create new external room?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                        noLink: true
                    }) === 0) {
                        if (p.editor.remote)
                            newFromValueFormatted(p.editor.externalCode(room), f, path.dirname(p.editor.remote) + '/' + path.basename(f));
                        else
                            newFromValueFormatted(p.editor.externalCode(room), f);
                    }
                });
                p.editor.on('map-context-menu', (e) => {
                    let temp = [];
                    if (p.editor.supports('undo'))
                        temp.push({
                            label: 'Undo',
                            click: doUndo,
                            accelerator: 'CmdOrCtrl+Z'
                        });
                    if (p.editor.supports('redo'))
                        temp.push({
                            label: 'Redo',
                            click: doRedo,
                            accelerator: 'CmdOrCtrl+Y'
                        });
                    if (p.editor.supports('undo') || p.editor.supports('redo'))
                        temp.push({ type: 'separator' });
                    temp.push({
                        label: 'Cut',
                        click: doCut,
                        accelerator: 'CmdOrCtrl+C'
                    });
                    temp.push({
                        label: 'Copy',
                        click: doCopy,
                        accelerator: 'CmdOrCtrl+X'
                    });
                    if (p.editor.supports('paste'))
                        temp.push({
                            label: 'Paste',
                            click: doPaste,
                            accelerator: 'CmdOrCtrl+V'
                        });
                    temp.push({ type: 'separator' });
                    temp.push({
                        label: 'Delete',
                        click: () => {
                            p.editor.delete();
                            p.editor.focus();
                        },
                        accelerator: 'Delete'
                    });
                    temp.push({ type: 'separator' });
                    var f;
                    if (p.editor.maxLevel > 1)
                        f = e.room.x + ',' + e.room.y + ',' + e.room.z + '.c';
                    else
                        f = e.room.x + ',' + e.room.y + '.c';
                    f = path.join(path.dirname(p.editor.file), f);
                    if (existsSync(f)) {
                        temp.push({
                            label: 'Open external file',
                            file: f,
                            remote: p.editor.remote ? (path.dirname(p.editor.remote) + '/' + path.basename(f)) : null,
                            click: (item) => {
                                openFile(item.file, item.remote);
                            }
                        });
                    }
                    else {
                        temp.push({
                            label: 'Create external file',
                            file: f,
                            remote: p.editor.remote ? (path.dirname(p.editor.remote) + '/' + path.basename(f)) : null,
                            coords: [e.room.x, e.room.y, e.room.z],
                            click: (item) => {
                                newFromValueFormatted(p.editor.externalCode(...item.coords), item.file, item.remote);
                            }
                        });
                        temp.push({
                            label: 'Create empty external file',
                            file: f,
                            remote: p.editor.remote ? (path.dirname(p.editor.remote) + '/' + path.basename(f)) : null,
                            click: (item) => {
                                newFile(item.file, item.remote);
                            }
                        });
                        temp.push({
                            label: 'Room wizard',
                            file: f,
                            room: e.room,
                            remote: p.editor.remote ? (path.dirname(p.editor.remote) + '/' + path.basename(f)) : null,
                            click: (item) => {
                                var data = {};
                                var room = item.room;
                                data['room-wiz-file'] = item.file;
                                data['room-wiz-virtual'] = true;
                                data['room-wiz-create'] = `${room.x}, ${room.y}, ${room.z}, ${room.terrain}, ${room.item}, ${room.exits}`;
                                data['room-wiz-short'] = room.short;
                                data['room-wiz-long'] = room.long;
                                data['room-wiz-light'] = '' + (room.light || 0);
                                if (room.terrainType.length > 0 && room.terrainType !== '0')
                                    data['room-wiz-terrain'] = room.terrainType;
                                if (room.sound.length > 0 && room.sound !== '0')
                                    data['room-wiz-sounds'] = [{
                                        sound: 'default',
                                        description: room.sound
                                    }];
                                if (room.smell.length > 0 && room.smell !== '0')
                                    data['room-wiz-smells'] = [{
                                        smell: 'default',
                                        description: room.smell
                                    }];
                                data['room-wiz-items'] = room.items;
                                data['room-wiz-exits'] = room.external.map(r => {
                                    return {
                                        exit: r.exit,
                                        dest: r.dest,
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        closed: true,
                                        climb: false,
                                        diff: 0,
                                    };
                                });
                                var tmp = [];
                                var x = room.x;
                                var y = room.y;
                                var z = room.z;
                                var depth = e.size.depth;
                                var f;
                                if (depth === 1)
                                    f = '(VIR+"{x},{y}.c")';
                                else
                                    f = '(VIR+"{x},{y},{z}.c")';
                                if ((room.exits & RoomExit.Up) === RoomExit.Up && z + 1 < depth) {
                                    tmp.push({
                                        exit: 'up',
                                        dest: f.replace('{x}', x).replace('{y}', y).replace('{z}', z + 1),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        closed: true,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                if ((room.exits & RoomExit.Down) === RoomExit.Down && z > 0) {
                                    tmp.push({
                                        exit: 'down',
                                        dest: f.replace('{x}', x).replace('{y}', y).replace('{z}', z - 1),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        closed: true,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                if ((room.exits & RoomExit.North) === RoomExit.North) {
                                    tmp.push({
                                        exit: 'north',
                                        dest: f.replace('{x}', x).replace('{y}', y - 1).replace('{z}', z),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        closed: true,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                if ((room.exits & RoomExit.NorthEast) === RoomExit.NorthEast) {
                                    tmp.push({
                                        exit: 'northeast',
                                        dest: f.replace('{x}', x + 1).replace('{y}', y - 1).replace('{z}', z),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        closed: true,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                if ((room.exits & RoomExit.East) === RoomExit.East) {
                                    tmp.push({
                                        exit: 'east',
                                        dest: f.replace('{x}', x + 1).replace('{y}', y).replace('{z}', z),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        closed: true,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                if ((room.exits & RoomExit.SouthEast) === RoomExit.SouthEast) {
                                    tmp.push({
                                        exit: 'southeast',
                                        dest: f.replace('{x}', x + 1).replace('{y}', y + 1).replace('{z}', z),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        closed: true,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                if ((room.exits & RoomExit.South) === RoomExit.South) {
                                    tmp.push({
                                        exit: 'south',
                                        dest: f.replace('{x}', x).replace('{y}', y + 1).replace('{z}', z),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        closed: true,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                if ((room.exits & RoomExit.SouthWest) === RoomExit.SouthWest) {
                                    tmp.push({
                                        exit: 'southwest',
                                        dest: f.replace('{x}', x - 1).replace('{y}', y + 1).replace('{z}', z),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        closed: true,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                if ((room.exits & RoomExit.West) === RoomExit.West) {
                                    tmp.push({
                                        exit: 'west',
                                        dest: f.replace('{x}', x - 1).replace('{y}', y).replace('{z}', z),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        closed: true,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                if ((room.exits & RoomExit.NorthWest) === RoomExit.NorthWest) {
                                    tmp.push({
                                        exit: 'southwest',
                                        dest: f.replace('{x}', x - 1).replace('{y}', y - 1).replace('{z}', z),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        closed: true,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                data['room-wiz-no-attack'] = (room.state & RoomStates.NoAttack) === RoomStates.NoAttack;
                                data['room-wiz-coul'] = (room.state & RoomStates.Council) === RoomStates.Council;
                                data['room-wiz-no-magic'] = (room.state & RoomStates.NoMagic) === RoomStates.NoMagic;
                                data['room-wiz-indoors'] = (room.state & RoomStates.Indoors) === RoomStates.Indoors;
                                if ((room.state & RoomStates.Water) === RoomStates.Water)
                                    data['room-wiz-terrain'] = 'water';
                                data['room-wiz-create-body'] = '';

                                if ((room.state & RoomStates.Cold) === RoomStates.Cold)
                                    data['room-wiz-temperature'] = -200;
                                else if ((room.state & RoomStates.Hot) === RoomStates.Hot)
                                    data['room-wiz-temperature'] = 200;
                                if (((room.state & RoomStates.SinkingUp) === RoomStates.SinkingUp && z + 1 < depth) || ((room.state & RoomStates.SinkingDown) === RoomStates.SinkingDown && z > 0 && depth > 1))
                                    data['room-wiz-create-body'] += '   set_living_sink(1);\n';
                                if ((room.state & RoomStates.SinkingUp) === RoomStates.SinkingUp && z + 1 < depth)
                                    data['room-wiz-create-body'] += `   set_up(VIR + "${x},${y},${z + 1}.c");\n`;
                                if ((room.state & RoomStates.SinkingDown) === RoomStates.SinkingDown && z > 0 && depth > 1)
                                    data['room-wiz-create-body'] += `   set_down(VIR + "${x},${y},${z - 1}.c");\n`;
                                data['room-wiz-exits'].push(...tmp);
                                roomWizard(data);
                            }
                        });
                    }
                    temp.push({ type: 'separator' });
                    temp.push({
                        label: 'Edit items',
                        click: () => {
                            p.editor.openItems();
                        }
                    });
                    temp.push({
                        label: 'Edit external exits',
                        click: () => {
                            p.editor.openExternalExits();
                        }
                    });
                    let inputMenu = Menu.buildFromTemplate(temp);
                    inputMenu.popup({ window: remote.getCurrentWindow() });
                });
            }
            else {
                try {
                    p.editor = new MonacoCodeEditor(data);
                }
                catch (err) {
                    dialog.showMessageBox({
                        type: 'info',
                        title: 'Error opening file',
                        message: 'Could not open \'' + data.file + '\'.'
                    });
                    if (options && options.debug)
                        console.log(err);
                }
                if (options.nativeIcons)
                    ipcRenderer.invoke('get-app', 'getFileIconDataUrl', (path.extname(data.source ? data.remote : data.file).length !== 0 ? data.source ? data.remote : data.file : '.*'), { size: 'small' }).then(icon => {
                        if (!icon) return;
                        manager.setPanelIcon(icon, p);
                    });
                //check in case errored above
                if (p.editor) {
                    p.editor.options = options.modelOptions;
                    p.editor.spellcheck = options.spellchecking;
                }
            }
            /*
            if (!_watched[data.file]) {
                _watched[data.file] = 1;
                watcher.add(data.file);
            }
            else
                _watched[data.file]++;
            */
            p.editor.on('debug', file => {
                if (!connected) {
                    dialog.showMessageBox({
                        type: 'error',
                        title: 'Must be logged into the mud',
                        message: 'Testing can only be done when connected to the mud',
                        defaultId: 1,
                        noLink: true
                    });
                    return;
                }
                if (!p.editor.remote)
                    showBrowseDialog({
                        defaultFile: p.editor.remote || (options.remote + "/" + path.basename(p.editor.file)),
                        filters: $fileFilters,
                    }, (files) => {
                        if (!files || files.length === 0) return;
                        p.editor.remote = files[0];
                        var remoteFile = path.dirname(p.editor.remote) + '/jiMUD.' + path.basename(p.editor.remote);
                        if (p.editor.new || p.editor.changed) {
                            var t = tmp.tmpNameSync(tmpOptions);
                            p.editor.write(p.editor.value, t);
                            _ied.uploadTo(t, remoteFile, false, 'editor-upload:debug:' + (p ? p.id : 0), false);
                            showProgressDialog({
                                file: remoteFile,
                                tag: 'editor-upload:debug:' + (p ? p.id : 0),
                                title: 'Uploading&hellip;',
                                tmp: t
                            });
                        }
                        else {
                            setRemoteCache(file, p.editor.remote);
                            _ied.uploadTo(file, remoteFile, false, 'editor-upload:debug:' + (p ? p.id : 0), false);
                            showProgressDialog({
                                file: remoteFile,
                                title: 'Uploading&hellip;',
                                tag: 'editor-upload:debug:' + (p ? p.id : 0),
                            });
                        }
                    });
                else {
                    var remoteFile = path.dirname(p.editor.remote) + '/jiMUD.' + path.basename(p.editor.remote);
                    if (p.editor.new || p.editor.changed) {
                        var t = tmp.tmpNameSync(tmpOptions);
                        p.editor.write(p.editor.value, t);
                        _ied.uploadTo(t, remoteFile, false, 'editor-upload:debug:' + (p ? p.id : 0), false);
                        showProgressDialog({
                            file: remoteFile,
                            tag: 'editor-upload:debug:' + (p ? p.id : 0),
                            title: 'Uploading&hellip;',
                            tmp: t
                        });
                    }
                    else {
                        _ied.uploadTo(file, remoteFile, false, 'editor-upload:debug:' + (p ? p.id : 0), false);
                        showProgressDialog({
                            file: remoteFile,
                            title: 'Uploading&hellip;',
                            tag: 'editor-upload:debug:' + (p ? p.id : 0),
                        });
                    }
                }
            });
            p.editor.on('reload', (type, file) => {
                var choice;
                if (type === 'unlink') {
                    choice = dialog.showMessageBoxSync({
                        type: 'question',
                        title: 'File deleted',
                        message: path.basename(file || p.editor.file) + ' has been deleted, keep open?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                        noLink: true
                    });
                    //no
                    if ((!file || p.editor.file === file) && choice === 1)
                        closeFile(p);
                    else
                        p.editor.deleted(choice === 0, file);
                }
                else {
                    choice = dialog.showMessageBoxSync({
                        type: 'question',
                        title: 'File changed',
                        message: path.basename((file || p.editor.file) + ' has been changed, reload?'),
                        buttons: ['Yes', 'No'],
                        defaultId: 1,
                        noLink: true
                    });
                    //yes
                    if (choice === 0)
                        p.editor.revert(file);
                    //else
                    //p.editor.changed = true;
                }
            });
            p.editor.on('supports-changed', () => {
                if (p !== manager.active) return;
                doUpdate(2);
            });
            p.editor.on('changed', (length, lines) => {
                updatePanel(p);
                if (p !== manager.active) return;
                doUpdate(2);
                if (length === -1)
                    sbSize.textContent = '';
                else if (lines === -1)
                    sbSize.textContent = `Length: ${length.toLocaleString()}`;
                else
                    sbSize.textContent = `Length: ${length.toLocaleString()}, Lines: ${lines.toLocaleString()}`;
            });
            p.editor.on('saved', () => {
                updatePanel(p);
                if (p !== manager.active) return;
                doUpdate(2);
            });
            p.editor.on('upload', files => {
                if (!files || files.length === 0) return;
                let fl = files.length;
                var t = [];
                for (let f = 0; f < fl; f++) {
                    if (files[f].local)
                        _ied.uploadTo(files[f].local, files[f].remote, false, 'editor-upload:' + (p ? p.id : 0) + ':' + f);
                    else if (Object.prototype.hasOwnProperty.call(files[f], 'value')) {
                        var t2 = tmp.tmpNameSync(tmpOptions);
                        p.editor.write(files[f].value || '', t2);
                        _ied.uploadTo(t2.name, files[f].remote, false, 'editor-upload:' + (p ? p.id : 0) + ':' + f);
                        t.push(t2);
                    }
                }
                showProgressDialog({
                    files: files,
                    title: 'Uploading&hellip;',
                    tmp: t,
                    tag: 'editor-upload:' + (p ? p.id : 0) + ':'
                });
            });
            p.editor.on('reverted', () => {
                updatePanel(p);
                if (p !== manager.active) return;
                doUpdate(2);
            });
            p.editor.on('selection-changed', () => {
                if (p !== manager.active) return;
                doUpdate(2);
            });
            p.editor.on('menu-update', (menu, options) => {
                if (p !== manager.active) return;
                menubar.updateItem(menu, options);
            });
            p.editor.on('rebuild-menu', (menu) => {
                if (p !== manager.active) return;
                if (menu === 'edit')
                    updateMenu('edit', 12);
                else if (menu === 'view')
                    updateMenu('view', 9);
            });
            p.editor.on('rebuild-buttons', () => {
                if (p !== manager.active) return;
                var buttons = document.getElementById('editor-buttons');
                while (buttons.firstChild) {
                    buttons.removeChild(buttons.firstChild);
                }
                if (p.editor.supports('buttons')) {
                    buttons.append(...p.editor.buttons);
                    if (window.opener)
                        $('.connected').prop('disabled', !(connected && manager.active && manager.active.editor));
                }
            });
            p.editor.on('contextmenu-diff', () => {
                var temp = [];
                if (p.editor.type === 1) {
                    temp.push({
                        label: '&Previous change',
                        click: gotoPrevChange
                    });
                    temp.push({
                        label: '&Next change',
                        click: gotoNextChange
                    });
                    temp.push({ type: 'separator' });
                }
                if (p.editor.supports('copy')) {
                    temp.push({
                        label: 'Copy',
                        click: doCopy,
                        accelerator: 'CmdOrCtrl+X'
                    });
                    temp.push({ type: 'separator' });
                }
                temp.push({
                    label: 'Select all',
                    click: () => {
                        if (manager.active && manager.active.editor)
                            manager.active.editor.selectAll();
                    },
                    accelerator: 'CmdOrCtrl+A'
                });
                if (p.editor.changed) {
                    temp.push({ type: 'separator' });
                    temp.push({
                        label: 'Revert',
                        click: () => { revertFile(); }
                    });
                }
                if (p.editor.supports('find') || p.editor.supports('replace'))
                    temp.push({ type: 'separator' });
                if (p.editor.supports('find'))
                    temp.push({
                        label: 'Find',
                        click: doFind,
                        accelerator: 'CmdOrCtrl+F'
                    });
                if (p.editor.supports('replace'))
                    temp.push({
                        label: 'Replace',
                        click: doReplace,
                        accelerator: 'CmdOrCtrl+H'
                    });

                if (p.editor.supports('menu|context')) {
                    temp.push({ type: 'separator' });
                    temp = temp.concat(p.editor.menu('context', connected));
                }
                let inputMenu = Menu.buildFromTemplate(temp);
                inputMenu.popup({ window: remote.getCurrentWindow() });
            });
            p.editor.on('contextmenu', (e, editor) => {
                var temp = [];
                //Broken on windows, seems spell checker always returns false try again once fixed to add spell checker
                //This seems to work if the application uses a built exe, and only broken when running from electron
                //seems if you change the lang to en-GB it will work, seems en-US is broken
                //const curr = remote.getCurrentWindow().webContents.session.getSpellCheckerLanguages() || [];
                //remote.getCurrentWindow().webContents.session.setSpellCheckerLanguages(['en-GB'])
                let word = editor.getModel().getWordAtPosition(e.target.position);
                if (p.spellcheck && word && word.word.length !== 0) {
                    //let words = word.word.split('_');
                    let words = word.word.split(/(_)|(?=[A-Z])|(\d+)/g);
                    ///_|(?=[A-Z])|(?<=[a-z])(?=\d)/g
                    let sCol = word.startColumn;
                    for (let w = 0, wl = words.length; w < wl; w++) {
                        if (!words[w]) continue;
                        if (sCol + words[w].length >= e.target.position.column) {
                            word = words[w];
                            break;
                        }
                        //sCol += words[w].length + 1;
                        sCol += words[w].length;
                    }
                    if (isWordMisspelled(word, p.editor)) {
                        words = webFrame.getWordSuggestions(word);
                        if (words.length) {
                            for (let w = 0, wl = words.length; w < wl; w++)
                                temp.push({
                                    label: words[w],
                                    word: word,
                                    column: sCol,
                                    position: e.target.position,
                                    click: (item) => {
                                        editor.pushUndoStop();
                                        editor.executeCommands(null, [
                                            new ReplaceCommandThatPreservesSelection(
                                                new monaco.Range(item.position.lineNumber, item.column, item.position.lineNumber, item.column + item.word.length),
                                                item.label,
                                                new monaco.Selection(item.position.lineNumber, item.position.column, item.position.lineNumber, item.position.column)
                                            )
                                        ]);
                                        editor.pushUndoStop();
                                    }
                                });
                            temp.push({ type: 'separator' });
                        }
                        temp.push(...[{
                            label: `Add "${word}" to editor dictionary`,
                            word: word,
                            click: item => {
                                if (!options.dictionary)
                                    options.dictionary = [];
                                options.dictionary.push(item.word.toLowerCase());
                                saveOptions();
                                var keys = Object.keys(_editors);
                                var k = keys.length;
                                while (k--) {
                                    ((p) => {
                                        if (_editors[p].editor.type === 1)
                                            setTimeout(() => _editors[p].editor.spellcheckDocument(), 0);
                                    })(keys[k]);
                                }
                            }
                        },
                        {
                            label: `Add "${word}" to operating system dictionary`,
                            word: word,
                            click: item => {
                                ipcRenderer.send('addWordToSpellCheckerDictionary', item.word.toLowerCase());
                                var keys = Object.keys(_editors);
                                var k = keys.length;
                                while (k--) {
                                    ((p) => {
                                        if (_editors[p].editor.type === 1)
                                            setTimeout(() => _editors[p].editor.spellcheckDocument(), 1);
                                    })(keys[k]);
                                }
                            }
                        },
                        {
                            label: `Ignore "${word}" in this document`,
                            word: word,
                            click: item => {
                                p.editor.addIgnoredWord(item.word);
                                p.editor.spellcheckDocument();
                            }
                        },
                        {
                            label: `Ignore "${word}" in all documents`,
                            word: word,
                            click: item => {
                                dictionaryIgnore.push(item.word.toLowerCase());
                                var keys = Object.keys(_editors);
                                var k = keys.length;
                                while (k--) {
                                    ((p) => {
                                        if (_editors[p].editor.type === 1)
                                            setTimeout(() => _editors[p].editor.spellcheckDocument(), 0);
                                    })(keys[k]);
                                }
                            }
                        },
                        { type: 'separator' }]);
                    }
                }
                //remote.getCurrentWindow().webContents.session.setSpellCheckerLanguages(curr)

                if (p.editor.supports('refresh')) {
                    temp.push({
                        label: 'Refresh',
                        click: doRefresh,
                        accelerator: 'F5'
                    });
                    temp.push({ type: 'separator' });
                }
                if (p.editor.type === 1 && p.editor.diff) {
                    temp.push({
                        label: '&Previous change',
                        click: gotoPrevChange
                    });
                    temp.push({
                        label: '&Next change',
                        click: gotoNextChange
                    });
                    temp.push({ type: 'separator' });
                }
                if (p.editor.supports('undo'))
                    temp.push({
                        label: 'Undo',
                        click: doUndo,
                        accelerator: 'CmdOrCtrl+Z'
                    });
                if (p.editor.supports('redo'))
                    temp.push({
                        label: 'Redo',
                        click: doRedo,
                        accelerator: 'CmdOrCtrl+Y'
                    });
                if (p.editor.supports('undo') || p.editor.supports('redo'))
                    temp.push({ type: 'separator' });
                if (p.editor.supports('cut'))
                    temp.push({
                        label: 'Cut',
                        click: doCut,
                        accelerator: 'CmdOrCtrl+C'
                    });
                if (p.editor.supports('copy'))
                    temp.push({
                        label: 'Copy',
                        click: doCopy,
                        accelerator: 'CmdOrCtrl+X'
                    });
                if (p.editor.supports('paste'))
                    temp.push({
                        label: 'Paste',
                        click: doPaste,
                        accelerator: 'CmdOrCtrl+V'
                    });
                if (p.editor.supports('copy'))
                    temp.push({
                        label: 'Paste to &Advanced Editor',
                        click: doEditor,
                        accelerator: 'CmdOrCtrl+Shift+V'
                    });
                if (p.editor.supports('cut') || p.editor.supports('copy') || p.editor.supports('paste'))
                    temp.push({ type: 'separator' });
                temp.push({
                    label: 'Select all',
                    click: () => {
                        if (manager.active && manager.active.editor)
                            manager.active.editor.selectAll();
                    },
                    accelerator: 'CmdOrCtrl+A'
                });
                if (p.editor.changed) {
                    temp.push({ type: 'separator' });
                    temp.push({
                        label: 'Revert',
                        click: () => { revertFile(); }
                    });
                }
                if (p.editor.supports('find') || p.editor.supports('replace'))
                    temp.push({ type: 'separator' });
                if (p.editor.supports('find'))
                    temp.push({
                        label: 'Find',
                        click: doFind,
                        accelerator: 'CmdOrCtrl+F'
                    });
                if (p.editor.supports('replace'))
                    temp.push({
                        label: 'Replace',
                        click: doReplace,
                        accelerator: 'CmdOrCtrl+H'
                    });

                if (p.editor.supports('menu|context')) {
                    temp.push({ type: 'separator' });
                    temp = temp.concat(p.editor.menu('context', connected));
                }
                temp[0].id = '1';
                let inputMenu = Menu.buildFromTemplate(temp);
                inputMenu.popup({ window: remote.getCurrentWindow() });
            });
            p.editor.on('error', e => {
                if (p.editor.type === 3)
                    logOutput(`Message: ${e.message}\nFile: ${e.file || p.editor.filename}\nLine: ${e.line + 1}\nColumn: ${e.col + 1}`);
            });
            p.editor.on('progress-start', async (type) => {
                if (type === 'indent')
                    logOutput(p.editor.filename + ': Indenting started');
                else if (type === 'format')
                    logOutput(p.editor.filename + ': Formatting started');
                else if (type === 'designer')
                    openWindow('progress', { title: 'Generating area...' });
            });
            p.editor.on('progress-canceled', (type) => {
                if (type === 'designer') {
                    ipcRenderer.send('progress', 'close');
                    window.setProgressBar(-1);
                }
            });
            p.editor.on('progress-error', (type, err) => {
                if (type === 'designer') {
                    ipcRenderer.send('progress', 'close');
                    window.setProgressBar(-1);
                }
                if (options && options.debug)
                    console.log(err);
            });
            p.editor.on('progress', async (pObject) => {
                if (!pObject) return;
                if (pObject.type === 'designer') {
                    window.setProgressBar(pObject.percent);
                    ipcRenderer.send('progress', 'update', pObject);
                }
            });
            p.editor.on('progress-complete', (type) => {
                if (type === 'indent')
                    logOutput(p.editor.filename + ': Indenting finished');
                else if (type === 'format')
                    logOutput(p.editor.filename + ': Formatting finished');
                else if (type === 'designer') {
                    ipcRenderer.send('progress', 'close');
                    window.setProgressBar(-1);
                    delete _windows['progress.html'];
                }
            });
            p.editor.on('output', (msg) => {
                logOutput(msg, true);
            });
            p.editor.on('location-changed', (x, y) => {
                if (p !== manager.active) return;
                if (p.editor.type == 1)
                    sbLocation.textContent = `Ln ${y}, Col ${x}`;
                else if (y != -1 && x != -1)
                    sbLocation.textContent = `${x}, ${y}`;
                else
                    sbLocation.textContent = '';
            });
            p.editor.on('status-message', (msg) => {
                if (p !== manager.active) return;
                sbMessage.textContent = msg;
            });
            p.editor.on('option-changed', (option, value) => {
                if (_loading) return;
                if (p.editor.type === 1) {
                    var pane = manager.panes.indexOf(p.dock);
                    if (pane === -1) return;
                    options.editorOptions = window.$editors[pane].getRawOptions();
                    saveOptions();
                }
                else if (p.editor.type === 2) {
                    options.virtualOptions[option] = value;
                    saveOptions();
                }
                else if (p.editor.type === 3) {
                    if (option === 'objWizardMode')
                        options.objWizardMode = value;
                    else
                        options.designOptions[option] = value;
                    saveOptions();
                }
            });
            p.editor.on('open-file', (file) => {
                if (existsSync(file))
                    openFile(file);
            });
            p.editor.on('browse-file', (e) => {
                showBrowseDialog({
                    defaultFile: e.file,
                    title: 'Select remote file',
                    properties: ['openFile'],
                    filters: $fileFilters,
                    arguments: e
                }, (files) => {
                    if (!files || files.length === 0) return;
                    if ($dialog.options.arguments.callback)
                        $dialog.options.arguments.callback(files);
                    $dialog.options.arguments.editor.value = files[0];
                    $dialog.options.arguments.editor.focus();
                });
            });
            p.editor.on('new-file', (file, value) => {
                newFromValue(value, file);
            });
            if (data.source)
                _editors['remote:' + data.remote] = p;
            else
                _editors[getFilePath(data.file)] = p;
            p.spellcheck = options.spellchecking;
            _loading--;
        }
        if (add) {
            manager.addPanels([p], dock);
            doUpdate(1);
            p.editor.resize();
            p.editor.focus();
        }
        return p;
    }

    var _rTimeout = 0;
    function doUpdate(type) {
        if (!type) return;
        _updating |= type;
        if (_updating === 0 || _rTimeout)
            return;
        _rTimeout = window.requestAnimationFrame(() => {
            if ((_updating & 1) === 1) {
                updateUI();
                _updating &= ~1;
            }
            if ((_updating & 2) === 2) {
                updateUIChange();
                _updating &= ~2;
            }
            if ((_updating & 4) === 4) {
                buildRecent();
                _updating &= ~4;
            }
            if ((_updating & 8) === 8) {
                flushRecent();
                _updating &= ~8;
            }
            if ((_updating & 16) === 16) {
                saveOptions();
                _updating &= ~16;
            }
            if ((_updating & 32) === 32) {
                if (manager.active && manager.active.editor && manager.active.editor.selectionChanged)
                    manager.active.editor.selectionChanged();
                _updating &= ~32;
            }
            if ((_updating & 64) === 64) {
                let l = manager.active.editor.location;
                sbLocation.textContent = `Ln ${l[1]}, Col ${l[0]}`;
                _updating &= ~64;
            }
            if ((_updating & 128) === 128) {
                var keys = Object.keys(_editors);
                var k = keys.length;
                var p;
                while (k--) {
                    p = keys[k];
                    if (!_editors[p]) continue;
                    _editors[p].editor.resize();
                }
                _updating &= ~128;
            }
            if ((_updating & 256) === 256) {
                buildRecentSessions();
                _updating &= ~256;
            }
            _rTimeout = 0;
            doUpdate(_updating);
        });
    }

    async function openWindow(name, data) {
        if (name === 'preferences' || name === 'options')
            name = 'prefs';
        if (_windows[name + '.html'] && !_windows[name + '.html'].closed) {
            _windows[name + '.html'].show();
            _windows[name + '.html'].focus();
            return;
        }
        let _options = '';
        if (data && data.state) {
            _options += ',' + buildWindowOptions(data.state, ['bounds', 'alwaysOnTop']);
            _options += ',' + buildWindowOptions(data.state.bounds);
        }
        switch (name) {
            case 'progress':
                //fake a window for easy close detection
                _windows['progress.html'] = { document: { title: 'progress', show: function () { ipcRenderer.send('show-window', 'progress', data ? data.title || '' : '', true); }, focus: function () { ipcRender.send('progess', 'focus'); } } };
                ipcRenderer.send('show-window', 'progress', data ? data.title || '' : '', true);
                break;
            case 'editor':
                if (data && data.details)
                    _options += ',' + buildWindowOptions(data.details.options, ['alwaysOnTopClient', 'backgroundColor', 'icon', 'persistent', 'defaultWidth', 'defaultHeight', 'showInTaskBar', 'noInputContext', ...Object.keys(data.state || {})]);
                //advEditor = window.open('editor.html', 'Code Advanced Editor-' + getId(), `noInputContext=true,alwaysOnTopClient=true,showInTaskBar=false,persistent=false,defaultHeight=225,defaultWidth=300,backgroundColor=#000,icon=${path.join(__dirname, '../assets/icons/png/edit.png')}`);
                _windows['editor.html'] = window.open('editor.html', 'Code Advanced Editor-' + getId(), `noInputContext=true,alwaysOnTopClient=true,showInTaskBar=false,persistent=false,defaultHeight=225,defaultWidth=300,backgroundColor=#000,icon=${path.join(__dirname, '../assets/icons/png/edit.png')}${_options}`);
                break;
            case 'prefs':
                _windows['prefs.html'] = window.open('code.editor.prefs.html', 'modal-' + getId(), 'backgroundColor=#fff,height=465,width=800,icon=' + path.join(__dirname, '../assets/icons/png/preferences.png'));
                break;
            case 'help':
                if (window.opener) {
                    if (window.opener._windows['help.html'])
                        window.opener._windows['help.html'].loadUrl('codeeditor');
                    else
                        window.opener.openWindow('help').then(() => {
                            _windows['help.html'].addEventListener('load', () => {
                                _windows['help.html'].loadUrl('codeeditor');
                            }, { once: true });
                        });
                }
                else {
                    if (data && data.details)
                        _options += ',' + buildWindowOptions(data.details.options, ['alwaysOnTopClient', 'backgroundColor', 'icon', 'defaultWidth', 'defaultHeight', ...Object.keys(data.state || {})]);
                    _windows['help.html'] = window.open('help.html', 'Help-' + getId(), `defaultWidth=800,defaultHeight=600,alwaysOnTopClient=true,backgroundColor=#fff,icon=${path.join(__dirname, '../assets/icons/png/help.png')}${_options}`);
                    _windows['help.html'].addEventListener('load', () => {
                        _windows['help.html'].loadUrl('codeeditor');
                    }, { once: true });
                }
                break;
        }
        if (data && data.data && typeof _windows[name + '.html'].restoreWindow !== 'undefined')
            _windows[name + '.html'].restoreWindow(data.data);
    }

    // eslint-disable-next-line no-unused-vars
    function childClosed(file, url, name) {
        delete _windows[file];
    }

    function buildWindowOptions(options, filters) {
        if (!options) return '';
        if (!filters) filters = [];
        return Object.keys(options).filter(key => filters.indexOf(key) === -1).map(key => `${key}=${options[key]}`).join(',');
    }

    function saveWindow() {
        if (!window.opener)
            return _windowState.data;
        return null;
    }

    function getWindowOptions() {
        if (window.opener) return;
        let data = ipcRenderer.sendSync('get-options', true);
        if (data) {
            //safety checks to make sure some basic objects
            if (!('windows' in data) || !data.windows)
                data.windows = [];
            if (!('states' in data) || !data.windows)
                data.states = {};
            //make sure we have a settings file, default to global file
            if (!('data' in data) || !data.data)
                data.data = {};
        }
        else
            data = {
                data: {},
                windows: [],
                states: {}
            };
        return data;
    }

    function isWordMisspelled(word, editor) {
        if (!word || word.length === 0 || word === '_' || !word.match(/\w+/)) return false;
        if (options && options.dictionary && options.dictionary.indexOf(word.toLowerCase()) !== -1)
            return false;
        if (editor && editor.isWordIgnored(word))
            return false;
        if (dictionaryIgnore.indexOf(word.toLowerCase()) !== -1)
            return false;
        if (language.keywords.indexOf(word) !== -1 ||
            language.const.indexOf(word) !== -1 ||
            language.efuns.indexOf(word) !== -1 ||
            language.abbr.indexOf(word) !== -1 ||
            language.sefuns.indexOf(word) !== -1 ||
            language.applies.indexOf(word) !== -1
        )
            return false;
        return webFrame.isWordMisspelled(word);
    }

    //Hack to fix window/mac casing issues
    function getFilePath(file) {
        if (file.startsWith('remote:'))
            return file;
        if (file && process.platform !== 'linux')
            return file.toLowerCase();
        return file;
    }

    function executeContextItem(idx, itemId, itemLabel, itemRole, keyboard) {
        if (manager && manager.active && manager.active.editor && typeof manager.active.editor.executeContxtItem === 'function') {
            manager.active.editor.executeContxtItem(idx, itemId, itemLabel, itemRole, keyboard);
        }
        window.dispatchEvent(new CustomEvent('context-item', {
            detail: {
                idx: idx, itemId: itemId, itemLabel: itemLabel, itemRole: itemRole, keyboard: keyboard
            }
        }));
    }
</script>

</html>
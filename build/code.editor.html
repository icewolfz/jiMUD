<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>Code Editor</title>
    <link rel="shortcut icon" href="../assets/icons/win/code.ico" />
    <link href="../lib/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-select.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-treeview.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/form.css" rel="stylesheet" type="text/css" />
    <link href="../lib/datatables.min.css" rel="stylesheet" type="text/css" />
    <link href="css/cm.css" rel="stylesheet" type="text/css" />
    <link href="css/code.editor.css" rel="stylesheet" type="text/css" />
    <link href="css/datagrid.css" rel="stylesheet" type="text/css" />
    <script>
        /* global manager, inverse, capitalize, options, monaco, ReplaceCommandThatPreservesSelection */
        var _ready = false;
        const { SetupEditor } = require('./js/editor/code.editor');
        const { ReplaceCommandThatPreservesSelection } = require('./js/editor/monaco');
        SetupEditor().then((monaco) => {
            var pane = document.getElementById('cm-tabpane');
            var el = document.createElement('div');
            el.classList.add('editor-container');
            pane.appendChild(el);
            window.$editor = monaco.editor.create(el, {
                language: 'lpc',
                autoIndent: true,
                rulers: [80],
                contextmenu: false,
                theme: 'lpcTheme',
                model: null
            });
            window.$editors = [window.$editor];
            window.$editor.addAction({
                id: 'jimud.action.transformToInverse',
                label: 'Transform to Inverse',
                run: function (editor) {
                    let selections = editor.getSelections();
                    let model = editor.getModel();
                    let commands = [];

                    for (let i = 0, len = selections.length; i < len; i++) {
                        let selection = selections[i];
                        if (selection.isEmpty()) {
                            let cursor = selection.getStartPosition();
                            let word = model.getWordAtPosition(cursor);
                            if (!word) {
                                continue;
                            }

                            let wordRange = new monaco.Range(cursor.lineNumber, word.startColumn, cursor.lineNumber, word.endColumn);
                            let text = model.getValueInRange(wordRange);
                            commands.push(new ReplaceCommandThatPreservesSelection(wordRange, inverse(text), new monaco.Selection(cursor.lineNumber, cursor.column, cursor.lineNumber, cursor.column)));

                        } else {
                            let text = model.getValueInRange(selection);
                            commands.push(new ReplaceCommandThatPreservesSelection(selection, inverse(text), selection));
                        }
                    }
                    editor.pushUndoStop();
                    editor.executeCommands(this.id, commands);
                    editor.pushUndoStop();
                }
            });

            window.$editor.addAction({
                id: 'jimud.action.transformToCapitalize',
                label: 'Transform to Capitalize',
                run: function (editor) {
                    let selections = editor.getSelections();
                    let model = editor.getModel();
                    let commands = [];

                    for (let i = 0, len = selections.length; i < len; i++) {
                        let selection = selections[i];
                        if (selection.isEmpty()) {
                            let cursor = selection.getStartPosition();
                            let word = model.getWordAtPosition(cursor);
                            if (!word) {
                                continue;
                            }

                            let wordRange = new monaco.Range(cursor.lineNumber, word.startColumn, cursor.lineNumber, word.endColumn);
                            let text = model.getValueInRange(wordRange);
                            commands.push(new ReplaceCommandThatPreservesSelection(wordRange, capitalize(text), new monaco.Selection(cursor.lineNumber, cursor.column, cursor.lineNumber, cursor.column)));

                        } else {
                            let text = model.getValueInRange(selection);
                            commands.push(new ReplaceCommandThatPreservesSelection(selection, capitalize(text), selection));
                        }
                    }
                    editor.pushUndoStop();
                    editor.executeCommands(this.id, commands);
                    editor.pushUndoStop();
                }
            });

            window.$editor.addAction({
                id: 'jimud.action.insertColor',
                label: 'Transform to Capitalize',
                run: function (editor) {
                    let selections = editor.getSelections();
                    let model = editor.getModel();
                    let commands = [];

                    for (let i = 0, len = selections.length; i < len; i++) {
                        let selection = selections[i];
                        if (selection.isEmpty()) {
                            let cursor = selection.getStartPosition();
                            let word = model.getWordAtPosition(cursor);
                            if (!word) {
                                continue;
                            }

                            let wordRange = new monaco.Range(cursor.lineNumber, word.startColumn, cursor.lineNumber, word.endColumn);
                            let text = model.getValueInRange(wordRange);
                            commands.push(new ReplaceCommandThatPreservesSelection(wordRange, capitalize(text), new monaco.Selection(cursor.lineNumber, cursor.column, cursor.lineNumber, cursor.column)));

                        } else {
                            let text = model.getValueInRange(selection);
                            commands.push(new ReplaceCommandThatPreservesSelection(selection, capitalize(text), selection));
                        }
                    }
                    editor.pushUndoStop();
                    editor.executeCommands(this.id, commands);
                    editor.pushUndoStop();
                }
            });

            window.$editor.onContextMenu((e) => {
                let idx = window.$editors.indexOf(window.$editor);
                if (manager.activePane === manager.panes[idx])
                    manager.active.editor.emit('contextmenu', e);
            });
            window.$editor.onDidChangeCursorSelection((e) => {
                let idx = window.$editors.indexOf(window.$editor);
                if (manager.activePane === manager.panes[idx])
                    manager.active.editor.selectionChanged(e);
            });
            window.$editor.onDidChangeCursorPosition((e) => {
                let idx = window.$editors.indexOf(window.$editor);
                if (manager.activePane === manager.panes[idx])
                    manager.active.editor.emit('location-changed', e.position.column, e.position.lineNumber);
            });

            if (options && options.editorOptions)
                window.$editor.updateOptions(options.editorOptions);
            _ready = true;
        });        
    </script>
</head>

<body>
    <div id="splashScreenMask" class="splash-mask"></div>
    <div id="splashLayout" class="splash-layout">
        <div id="SplashScreen" class="splash-screen">
            <h1 id="splashTitle">jiMUD - Code editor</h1>
            <h3>
                <!--span class="fa fa-circle-o-notch fa-spin" title="Loading..."></span-->
                <span id="splashMessage">Loading...</span>
            </h3>
        </div>
    </div>
    <div id="toolbar" class="btn-toolbar" role="toolbar">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default btn-xs" title="New File" onclick="newFile()">
                <i class="fa fa-plus"></i>
            </button>
            <button id="btn-add-dropdown" type="button" class="btn btn-default btn-xs" title="New...">
                <span class="caret"></span>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-open" type="button" class="btn btn-default btn-xs" title="Open..." onclick="openFile()">
                <i class="fa fa-folder-open-o"></i>
            </button>
            <button id="btn-close" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Close" onclick="closeFile()">
                <i class="fa fa-window-close"></i>
            </button>
            <button id="btn-close-all" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Close All" onclick="closeAllFiles()">
                <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                    <i class="fa fa-window-close fa-stack-2x" style="font-size: 1em;margin-top: -2px;margin-left: 2px;"></i>
                    <i class="fa fa-window-close fa-stack-2x" style="font-size: 1em;margin-top: 2px;margin-left: -2px;"></i>
                </span>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-save" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Save" onclick="saveFile()">
                <i class="fa fa-save"></i>
            </button>
            <button id="btn-save-all" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Save All" onclick="saveAllFiles()">
                <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                    <i class="fa fa-save fa-stack-2x" style="font-size: 1em;margin-top: -2px;margin-left: 2px;"></i>
                    <i class="fa fa-save fa-stack-2x" style="font-size: 1em;margin-top: 2px;margin-left: -2px;"></i>
                </span>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-undo" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Undo" onclick="doUndo()">
                <i class="fa fa-undo"></i>
            </button>
            <button id="btn-redo" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Redo" onclick="doRedo()">
                <i class="fa fa-repeat"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-cut" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Cut" onclick="doCut()">
                <i class="fa fa-cut"></i>
            </button>
            <button id="btn-copy" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Copy" onclick="doCopy()">
                <i class="fa fa-copy"></i>
            </button>
            <button id="btn-paste" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Paste" onclick="doPaste()">
                <i class="fa fa-paste"></i>
            </button>
            <button id="btn-editor" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Paste to advanced editor" onclick="doEditor()">
                <i class="fa fa-edit"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-find" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Find" onclick="doFind()">
                <i class="fa fa-search"></i>
            </button>
            <button id="btn-replace" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Replace" onclick="doReplace()">
                <i class="fa fa-exchange"></i>
            </button>
        </div>
        <button id="btn-refresh" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Refresh" onclick="doRefresh()">
            <i class="fa fa-refresh"></i>
        </button>
        <div id="editor-buttons"></div>
    </div>
    <div id="output" class="output">
        <div id="btm-drag-bar"></div>
        <div id="output-toolbar" class="btn-toolbar" role="toolbar">
            <a href="javascript:void(0)" onclick="closeOutput()" class="close">
                <i class="fa fa-times"></i>
            </a>
            <button id="btn-clear-output" type="button" class="btn btn-default btn-xs" title="Clear output" onclick="doClearOutput()">
                <i class="fa fa-trash"></i>
            </button>
        </div>
        <div id="output-display" class="output-display" contenteditable="true" readonly="readonly"></div>
    </div>
    <div id="statusbar" class="statusbar">
        <span id="statusbar-file" class="left"></span>
        <span id="statusbar-message" class="center"></span>
        <span id="statusbar-location" class="right"></span>
        <span id="statusbar-size" class="right"></span>
    </div>
    <dialog id="newArea" data-title="Create new area" style="width:400px;height:348px;padding:5px;">
        <div class="dialog-header" style="font-weight: bold">
            <button type="button" class="close" data-dismiss="modal" onclick="document.getElementById('newArea').close();">&times;</button>
            <div style="padding-top: 2px;">Create new area...</div>
        </div>
        <div class="dialog-body" style="padding-top:40px">
            <div class="form-group">
                <label class="control-label" style="width:100%">
                    Save path
                    <div class="input-group">
                        <input type="text" id="newarea-path" style="width:100%" class="input-sm form-control" />
                        <span class="input-group-btn">
                            <button class="btn btn-default btn-sm" type="button" id="btn-newarea-path">
                                &hellip;
                            </button>
                        </span>
                    </div>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Local path where files will be generated</span>
                    <div class="form-error"></div>
                </label>
            </div>
            <div class="form-group">
                <label class="control-label" style="width: 100%">Remote path
                    <input class="form-control" style="width:100%" type="text" id="newarea-remote-path">
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Remote path for area, if blank will default to /realms/character/area</span>
                </label>
            </div>
            <div class="form-group">
                <label class="control-label" style="width:100%">
                    Name
                    <input class="form-control" style="width:100%" type="text" id="newarea-name" style="width:100%">
                    <span class="glyphicon glyphicon-remove form-control-feedback" aria-hidden="true"></span>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Area name, used as folder name</span>
                    <div class="form-error"></div>
                </label>
            </div>
        </div>
        <div class="dialog-footer">
            <button style="float: right" type="button" class="btn btn-default" onclick="document.getElementById('newArea').close();">Cancel</button>
            <button style="float: right" type="button" class="btn btn-primary" onclick="createArea()">Ok</button>
        </div>
    </dialog>

    <dialog id="newVirtualArea" data-title="Create new virtual area" style="width:400px;height:450px;padding:0px;">
        <div class="dialog-header" style="font-weight: bold">
            <button type="button" class="close" data-dismiss="modal" onclick="document.getElementById('newVirtualArea').close();">&times;</button>
            <div style="padding-top: 2px;">Create new virtual area...</div>
        </div>
        <div class="dialog-body" style="padding-top:33px">
            <ul class="nav nav-tabs" role="tablist" style="background-color: #F5F5F5;box-shadow: inset 0 -1px 0 #fff;">
                <li role="presentation" class="active">
                    <a href="#general" aria-controls="general" role="tab" data-toggle="tab">General</a>
                </li>
                <li role="presentation">
                    <a href="#advanced" aria-controls="advanced" role="tab" data-toggle="tab">Advanced</a>
                </li>
            </ul>
            <div class="tab-content" style="overflow: auto;height: 324px;">
                <div role="tabpanel" class="container tab-pane fade in active" id="general" style="width: auto;">
                    <div class="form-group">
                        <label class="control-label" style="width:100%">
                            Save path
                            <div class="input-group">
                                <input type="text" id="newvirtualarea-path" style="width:100%" class="input-sm form-control" />
                                <span class="input-group-btn">
                                    <button class="btn btn-default btn-sm" type="button" id="btn-newvirtualarea-path">
                                        &hellip;
                                    </button>
                                </span>
                            </div>
                            <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Local path where files will be generated</span>
                            <div class="form-error"></div>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="control-label" style="width: 100%">Remote path
                            <input class="form-control" style="width:100%" type="text" id="newvirtualarea-remote-path">
                            <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Remote path for area, if blank will default to /realms/character/area</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="control-label" style="width:100%">
                            Area
                            <div class="input-group" style="width:100%">
                                <input type="text" id="newvirtualarea-area" disabled="disabled" class="input-sm form-control" style="width:100%" />
                                <div class="input-group-addon">
                                    <label>
                                        <input type="checkbox" id="newvirtualarea-area-enabled" onchange="$('#newvirtualarea-area').attr('disabled', !this.checked);" /> Create
                                    </label>
                                </div>
                            </div>
                            <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Area name, used as folder name</span>
                            <div class="form-error"></div>
                        </label>
                    </div>
                    <div class="col-sm-4 form-group">
                        <label class="control-label">
                            Width
                            <input type="number" id="newvirtualarea-width" class="input-sm form-control" value="2" min="2" max="100" style="width: 100%" />
                        </label>
                    </div>
                    <div class="col-sm-4 form-group">
                        <label class="control-label">
                            Height
                            <input type="number" id="newvirtualarea-height" class="input-sm form-control" value="2" min="2" max="100" style="width: 100%" />
                        </label>
                    </div>
                    <div class="col-sm-4 form-group">
                        <label class="control-label">
                            Depth
                            <input type="number" id="newvirtualarea-depth" class="input-sm form-control" value="1" min="2" max="100" style="width: 100%" />
                        </label>
                    </div>
                </div>
                <div role="tabpanel" class="container tab-pane fade" id="advanced" style="width: auto;overflow:auto">
                    <div class="col-sm-6 form-group">
                        <label class="control-label">
                            <input type="checkbox" id="newvirtualarea-coordinates" /> Coordinates
                        </label>
                    </div>
                    <div class="col-sm-6 form-group">
                        <label class="control-label">
                            Room cache
                            <input type="number" id="newvirtualarea-cache" class="input-sm form-control" value="200" min="1" max="500" style="width: 100%" />
                        </label>
                    </div>
                    <div class="col-sm-12 form-group">
                        <label class="control-label">Default Exits</label>
                        <div id="newvirtualarea-default-exits">
                            <div class="btn-group" data-toggle="buttons">
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="512" id="deUp">Up
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="256" id="deDown">Down
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="128" id="deNorth" checked="checked">North
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="64" id="deNorthEast">NorthEast
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="32" id="deEast" checked="checked">East
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="16" id="deSouthEast">SouthEast
                                </label>
                            </div>
                            <div class="btn-group" data-toggle="buttons">
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="8" id="deSouth" checked="checked">South
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="4" id="deSouthWest">SouthWest
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="2" id="deWest" checked="checked">West
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="1" id="deNorthWest">NorthWest
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="0" id="eNone">None
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12 form-group">
                        <label class="control-label">Default States</label>
                        <div id="newvirtualarea-default-states">
                            <div class="btn-group" data-toggle="buttons">
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="512" id="dsNoAttack">No Attack
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="256" id="dsNoMagic">No Magic
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="128" id="dsCouncil">Council
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="64" id="dsOutdoors">Outdoors
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="32" id="dsIndoors">Indoors
                                </label>
                            </div>
                            <div class="btn-group" data-toggle="buttons">
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="16" id="dsWater">Water
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="8" id="dsHot">Hot
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="4" id="dsCold">Cold
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="2" id="dsSinkingUp">SinkingUp
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="1" id="dsSinkingDown">SinkingDown
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="0" id="sNone" checked="checked">None
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="dialog-footer">
                <button style="float: right" type="button" class="btn btn-default" onclick="document.getElementById('newVirtualArea').close();">Cancel</button>
                <button style="float: right" type="button" class="btn btn-primary" onclick="createVirtualArea()">Ok</button>
            </div>
    </dialog>

    <dialog id="monsterWizard" data-title="Create new monster" style="width:500px;height:208px;padding:5px;">
        <div class="dialog-header" style="font-weight: bold">
            <button type="button" class="close" data-dismiss="modal" onclick="document.getElementById('monsterWizard').close();">&times;</button>
            <div style="padding-top: 2px;">Create new monster...</div>
        </div>
        <div class="dialog-body" style="padding-top:30px">
            <div id="monwiz0" style="height:100%;width:100%;text-align:center;font-size:12pt;">
                <img src="../assets/icons/png/wizmonlogo.png" alt="Welcome to the monster wizard" style="float: left">
                <br> Welcome to the new monster wizard, this will take you through the steps to create a monster quickly and easily. You may finish at any time to generate a monster based on your current selections.
            </div>
            <div id="monwiz1" style="height:100%;width:100%;text-align:left;font-size:12pt;display:none;">
                <label style="width:100%">
                    <div style="width: 70px;display:inline-block">Type:</div>
                    <select id="monwizType" data-options="editable:false,onSelect:doMonType" style="width: 130px">
                        <option>Standard</option>
                        <option>Armor Repair</option>
                        <option>Barkeep</option>
                        <option>Cleric Trainer</option>
                        <option>Command Trainer</option>
                        <option>Healer</option>
                        <option>Jeweler</option>
                        <option>Lockpick Repair</option>
                        <option>Mage Trainer</option>
                        <option>Edible Monster</option>
                        <option>Getable Monster</option>
                        <option>Sage</option>
                        <option>Skill Trainer</option>
                        <option>Smith</option>
                        <option>Summon Monster</option>
                        <option>Tattooist</option>
                        <option>Vendor</option>
                        <option>Weapon Repair</option>
                    </select>
                </label>
                <label>Level:
                    <input id="monwizLevel" style="width: 50px" value="1">
                </label>
                <label>Alignment:
                    <select id="monwizAlignment" style="width: 90px">
                        <option>demonic</option>
                        <option>evil</option>
                        <option>bad</option>
                        <option>malevolent</option>
                        <option>mean</option>
                        <option selected="selected">neutral</option>
                        <option>nice</option>
                        <option>benevolent</option>
                        <option>good</option>
                        <option>righteous</option>
                        <option>saintly</option>
                    </select>
                </label>
                <label style="width:100%;display:block">
                    <div style="width: 70px;display:inline-block">Race:</div>
                    <select style="width:400px" id="monwizRace"></select>
                </label>
                <label style="width:100%;display:block;">
                    <div style="width: 70px;display:inline-block">Class:</div>
                    <select style="width:400px" id="monwizClass"></select>
                </label>
                <label style="width:100%;display:block;">
                    <div style="width: 70px;display:inline-block">Language:</div>
                    <select style="width:400px" id="monwizLang"></select>
                </label>
                <label>
                    <div style="width: 70px;display:inline-block">Ridable:</div>
                    <input type="checkbox" id="monwizRide">
                </label>
                <label>Flys:
                    <input type="checkbox" id="monwizFly">
                </label>
            </div>
            <div id="monwiz2" style="height:100%;width:100%;text-align:left;font-size:12pt;display:none;">
                <label style="width:100%;display:block">
                    <div style="width: 50px;display:inline-block">Name:</div>
                    <input id="monwizName" style="width:420px" class="easyui-textbox">
                </label>
                <label style="width:100%;display:block">
                    <div style="width: 50px;display:inline-block">Short:</div>
                    <input id="monwizShort" style="width:420px" class="easyui-textbox">
                </label>
                <label style="width:100%;display:block;margin-top:2px;">
                    <div style="width: 50px;display:inline-block;">Long:</div>
                    <span style="float:right;padding-right:2px;">
                        <textarea id="monwizLong" style="width:420px;height:75px;resize: none;" wrap="off" class="easyui-textbox" data-options="multiline:true"></textarea>
                    </span>
                </label>
            </div>
            <div id="monwizDesc2" style="height:100%;width:100%;text-align:left;font-size:12pt;display:none;">
                <label style="width:100%;display:block;">
                    <div style="width: 80px;display:inline-block;">Nouns:</div>
                    <span style="padding-right:2px;">
                        <textarea id="monwizNouns" style="width:388px;height:60px;resize: none;" wrap="off" class="easyui-textbox" data-options="multiline:true,prompt:'A comma delimited list of words'"></textarea>
                    </span>
                    <label style="width:100%;display:block;margin-top:2px;">
                        <div style="width: 80px;display:inline-block;">Adjectives:</div>
                        <span style="padding-right:2px;">
                            <textarea id="monwizAdjs" style="width:388px;height:60px;resize: none;" wrap="off" class="easyui-textbox" data-options="multiline:true,prompt:'A comma delimited list of words'"></textarea>
                        </span>
                    </label>
            </div>
            <div id="monwiz3" style="height:100%;width:100%;text-align:left;font-size:12pt;display:none;">
                <label style="width:100%;display:block">
                    <div style="width: 75px;display:inline-block">Mass:</div>
                    <input id="monwizMass" class="easyui-numberspinner" data-options="min:0" style="width: 100px" value="0"> A mass of 0 will use default mass</label>
                <label style="width:100%;display:block">
                    <div style="width: 75px;display:inline-block">Height:</div>
                    <input id="monwizHeight" class="easyui-numberspinner" data-options="min:1" style="width: 100px" value="1"> inches</label>
                <label style="width:100%;display:block">
                    <div style="width: 75px;display:inline-block">Eye color:</div>
                    <select style="width:395px" id="monwizEyes" class="easyui-combobox" data-options="url:'/auth/dev?a=colors',valueField:'color',textField:'color',method:'get'"></select>
                </label>
                <label style="width:100%;display:block">
                    <div style="width: 75px;display:inline-block">Hair color:</div>
                    <select style="width:395px" id="monwizHair" class="easyui-combobox" data-options="url:'/auth/dev?a=colors',valueField:'color',textField:'color',method:'get'"></select>
                </label>
                <label style="width:100%;display:block">
                    <div style="width: 75px;display:inline-block">Body type:</div>
                    <select style="width:395px" id="monwizBodytype" class="easyui-combobox" data-options="url:'/auth/dev?a=monraces',valueField:'value',textField:'value',method:'get',prompt:'Defaults based on race'"></select>
                </label>
            </div>
            <div id="monwiz4" style="height:100%;width:100%;text-align:left;font-size:12pt;display:none;">
                change based on monster type, may not even always need this panel
            </div>
            <div id="monwizBarkeep" style="height:100%;width:100%;text-align:left;font-size:12pt;display:none;">
                barkeeper
            </div>
            <div id="monwiz5" style="height:100%;width:100%;text-align:left;font-size:12pt;display:none;">
                <img src="../assets/icons/png/wizmonlogo.png" alt="Welcome to the monster wizard" style="float: left"> To finish your monster simply click finished
                <div style="height:100px;width:345px;overflow:auto;border:1px groove">
                    <span id="monwizSummary"></span>
                </div>
            </div>
        </div>
        <div class="dialog-footer">
            <select id="monwizJump" style="float: left" class="form-control selectpicker" onchange="doWizard(this.selectedIndex, 'monwiz', 'goto');" data-width="200px">
                <option>Welcome</option>
                <option>General Properties</option>
                <option>Description</option>
                <option>Description Continued</option>
                <option>Physical Properties</option>
                <option>Finish</option>
            </select>
            <button style="float: right" type="button" class="btn btn-default" onclick="document.getElementById('monsterWizard').close();">Cancel</button>
            <button style="float: right" type="button" class="btn btn-primary" onclick="doWizard('last', 'monwiz');">Finish</button>
            <button style="float: right" type="button" class="btn btn-default" onclick="doWizard(1, 'monwiz');">
                <i class="fa fa-chevron-right" aria-hidden="true"></i>
            </button>
            <button style="float: right" type="button" class="btn btn-default" onclick="doWizard(-1, 'monwiz');">
                <i class="fa fa-chevron-left" aria-hidden="true"></i>
            </button>
        </div>
    </dialog>
</body>
<script>
    if (typeof module === 'object') { window.module = module; module = undefined; }
</script>
<script src="../lib/jquery.min.js" type="text/javascript"></script>
<script src="../lib/bootstrap.min.js" type="text/javascript"></script>
<script src="../lib/bootstrap-select.min.js" type="text/javascript"></script>
<script src="../lib/datatables.min.js" type="text/javascript"></script>
<script src="../lib/datatables.scrollresize.js" type="text/javascript"></script>
<script src="../lib/bootstrap-treeview.min.js"></script>
<script>
    /*global _ready:true*/
    const { remote, ipcRenderer, webFrame, clipboard } = require('electron');
    const { DockManager } = require('./js/dockmanager');
    const { DebugTimer, MonacoCodeEditor, VirtualEditor } = require('./js/editor/code.editor');
    const { EditorSettings } = require('./js/editor/code.editor.settings');

    const { dialog, Menu, MenuItem, app } = remote;
    const { Menubar } = require('./js/menubar');
    const { inverse, parseTemplate, capitalize, existsSync, isDirSync, walkSync } = require('./js/library');

    const moment = require('moment');
    const chokidar = require('chokidar');
    const path = require('path');
    const fs = require('fs');

    remote.getCurrentWindow().setEnabled(false);

    var spellchecker, menubar;
    var options, _updating = 0;
    var _loading = 1;
    var _open;
    var newCounter = 1;
    let $closeWindow = false;
    var watcher;
    var _watched = {};
    var outputDragging = false;
    var output = $('#output');
    var outputDisplay = $('#output-display');
    var _editors = {};
    var _recent = [];
    var sbSize = document.getElementById('statusbar-size');
    var sbName = document.getElementById('statusbar-file');
    var sbLocation = document.getElementById('statusbar-location');
    var sbMessage = document.getElementById('statusbar-message');

    outputDisplay.on('keydown', (e) => {
        if (event.ctrlKey) {
            // allow Ctrl-A, Ctrl-(any arrow key) combinations
            return true;
        }
        // keycode: http://www.programming-magic.com/file/20080205232140/keycode_table.html
        if (33 <= event.keyCode && event.keyCode <= 40) {
            return true;
        }
        return false;
    });

    outputDisplay.on('cut', (e) => {
        e.preventDefault();
        e.stopPropagation();
    });

    outputDisplay.on('paste', (e) => {
        e.preventDefault();
        e.stopPropagation();
    });

    webFrame.setSpellCheckProvider("en-US", true, {
        spellCheck: function (text) {
            if (!spellchecker || !options.spellchecking)
                return true;
            return !(spellchecker.isMisspelled(text));
        }
    });

    window.addEventListener('contextmenu', (e) => {
        if (!options || !options.spellchecking || !spellchecker || !e.srcElement || !e.srcElement.spellcheck || (e.srcElement.tagName !== 'TEXTAREA' && e.srcElement.tagName !== 'INPUT'))
            return;
        e.preventDefault();
        var inputMenu = Menu.buildFromTemplate([
            { role: 'undo' },
            { role: 'redo' },
            { type: 'separator' },
            { role: 'cut' },
            { role: 'copy' },
            { role: 'paste' },
            { type: 'separator' },
            { role: 'selectall' },
        ]);
        if (remote.getGlobal('debug')) {
            inputMenu.append(new MenuItem({ type: 'separator' }));
            inputMenu.append(new MenuItem({
                label: 'Inspect', click: () => {
                    remote.getCurrentWindow().webContents.inspectElement(e.pageX, e.pageY);
                }
            }));
        }
        if (options.spellchecking && spellchecker && e.srcElement.spellcheck && e.srcElement.value) {
            var word = e.srcElement.value.substring(e.srcElement.selectionStart, e.srcElement.selectionEnd);
            var ol = word.length;
            word = word.trimRight();
            var ll = ol - word.length;
            if (ll > 0)
                e.srcElement.selectionEnd = e.srcElement.selectionEnd - ll;

            if (spellchecker.isMisspelled(word)) {
                var words = spellchecker.getCorrectionsForMisspelling(word);
                if (words.length > 0)
                    inputMenu.insert(0, new MenuItem({ type: 'separator' }));
                var start = e.srcElement.selectionStart;
                var end = e.srcElement.selectionEnd;
                for (var w = words.length - 1; w >= 0; w--) {
                    inputMenu.insert(0, new MenuItem({
                        label: words[w],
                        start: start,
                        end: end,
                        click: function (item) {
                            var value = e.srcElement.value;
                            value = value.substring(0, item.start) + item.label + value.substring(item.end);
                            e.srcElement.value = value;
                            e.srcElement.selectionStart = start + item.label.length;
                            e.srcElement.selectionEnd = start + item.label.length;
                            e.srcElement.setSelectionRange(start + item.label.length, start + item.label.length);
                            //e.srcElement.blur();
                            e.srcElement.focus();
                        }
                    }));
                }
            }
        }
        inputMenu.popup({ window: remote.getCurrentWindow() });

    });

    var menuTemplates = loadTemplates(parseTemplate(path.join('{assets}', 'templates')), '', ['wizards']);
    var subMenus = {
        'edit': [
            {
                label: '&Undo',
                accelerator: "CmdOrCtrl+Z",
                click: doUndo,
                enabled: false,
            },
            {
                label: '&Redo',
                accelerator: "CmdOrCtrl+Y",
                click: doRedo,
                enabled: false,
            },
            { type: 'separator' },
            {
                label: 'Cu&t',
                accelerator: "CmdOrCtrl+X",
                click: doCut,
                enabled: false,
            },
            {
                label: '&Copy',
                accelerator: "CmdOrCtrl+C",
                click: doCopy,
                enabled: false,
            },
            {
                label: '&Paste',
                accelerator: "CmdOrCtrl+V",
                click: doPaste,
                enabled: false,
            },
            {
                label: 'Paste to Advanced Editor',
                accelerator: "CmdOrCtrl+Shift+V",
                click: doEditor,
                enabled: false,
            },
            { type: 'separator' },
            {
                label: '&Select All',
                accelerator: "CmdOrCtrl+A",
                enabled: false,
                click: () => {
                    if (manager.active && manager.active.editor)
                        manager.active.editor.selectAll();
                }
            },
            { type: 'separator' },
            {
                label: '&Find',
                accelerator: "CmdOrCtrl+F",
                enabled: false,
                click: doFind
            },
            {
                label: '&Replace',
                accelerator: "CmdOrCtrl+H",
                enabled: false,
                click: doReplace
            },
        ],
        'view': [
            {
                label: '&Refresh',
                accelerator: "F5",
                enabled: false,
                click: doRefresh
            },
            { type: 'separator' },
            {
                label: '&Output',
                accelerator: 'CmdOrCtrl+Shift+U',
                type: 'checkbox',
                checked: false,
                click: toggleOutput
            },
            { type: 'separator' },
            {
                label: '&Toggle Developer Tools',
                click: () => {
                    if (remote.getCurrentWindow().isDevToolsOpened())
                        remote.getCurrentWindow().closeDevTools();
                    else
                        remote.getCurrentWindow().openDevTools();
                }
            },
            {
                type: 'separator'
            },
            {
                role: 'resetzoom'
            },
            {
                role: 'zoomin'
            },
            {
                role: 'zoomout'
            },
        ]
    };
    menubar = new Menubar([
        {
            label: '&File',
            id: 'file',
            submenu: [
                {
                    label: '&New',
                    submenu: [
                        {
                            label: '&File',
                            accelerator: "CmdOrCtrl+N",
                            click: () => { newFile(); }
                        },
                        { type: 'separator' },
                        {
                            label: '&Area...',
                            //accelerator: "CmdOrCtrl+N",
                            click: newArea
                        },
                        /*
                        {
                            label: '&Virtual Area...',
                            //accelerator: "CmdOrCtrl+N",
                            click: newVirtualArea
                        },
                        */
                        { type: 'separator' },
                        {
                            label: '&Room...',
                            //accelerator: "CmdOrCtrl+N",
                            click: roomWizard
                        },
                        {
                            label: '&Monster...',
                            //accelerator: "CmdOrCtrl+N",
                            click: monsterWizard
                        },
                        { type: 'separator' },
                        {
                            label: '&Templates',
                            submenu: menuTemplates
                        }
                    ]
                },
                {
                    label: '&Open',
                    accelerator: "CmdOrCtrl+O",
                    click: () => { openFile(); }
                },
                {
                    label: 'Open &Recent',
                    submenu: [],
                },
                { type: 'separator' },
                {
                    label: '&Save',
                    accelerator: "CmdOrCtrl+S",
                    click: () => { saveFile(); },
                    enabled: false
                },
                {
                    label: 'Save A&ll',
                    accelerator: "CmdOrCtrl+Alt+S",
                    click: () => { saveAllFiles(); },
                    enabled: false
                },
                {
                    label: 'Save &As',
                    accelerator: "CmdOrCtrl+Shift+S",
                    click: () => { saveFileAs(); },
                    enabled: false,
                },
                { type: 'separator' },
                {
                    label: '&Preferences...',
                    accelerator: "CmdOrCtrl+Comma",
                    click: () => {
                        window.open('code.editor.prefs.html', 'modal', 'backgroundColor=#fff,height=465,width=800,icon=' + path.join(__dirname, '../assets/icons/png/preferences.png'));
                    }
                },
                { type: 'separator' },
                {
                    label: 'Revert',
                    click: () => { revertFile(); },
                    enabled: false
                },
                {
                    label: 'Revert All',
                    click: () => { revertAllFiles(); },
                    enabled: false
                },
                { type: 'separator' },
                {
                    label: '&Close',
                    click: () => { closeFile(); },
                    accelerator: "CmdOrCtrl+F4",
                    enabled: false
                },
                {
                    label: 'C&lose All',
                    click: () => { closeAllFiles(); },
                    accelerator: "CmdOrCtrl+Shift+F4",
                    enabled: false
                },
                { type: 'separator' },
                {
                    label: 'E&xit',
                    accelerator: "CmdOrCtrl+Shift+W",
                    click: () => { window.close(); }
                }
            ]
        },
        {
            label: '&Edit',
            submenu: subMenus['edit']
        },
        {
            label: '&View',
            submenu: subMenus['view']
        },
    ]);

    var manager = new DockManager();
    var dock = $(".dock-manager");
    manager.hideTabstrip = false;
    manager.on('add', (e) => {
    });
    manager.on('add-pane', (idx, pane) => {
        var el = document.createElement('div');
        el.classList.add('editor-container');
        pane.pane.appendChild(el);
        var editor = monaco.editor.create(el, {
            language: 'lpc',
            autoIndent: true,
            rulers: [80],
            contextmenu: false,
            theme: 'lpcTheme',
            model: null
        });

        editor.addAction({
            id: 'jimud.action.transformToInverse',
            label: 'Transform to Inverse',
            run: function (editor) {
                let selections = editor.getSelections();
                let model = editor.getModel();
                let commands = [];

                for (let i = 0, len = selections.length; i < len; i++) {
                    let selection = selections[i];
                    if (selection.isEmpty()) {
                        let cursor = selection.getStartPosition();
                        let word = model.getWordAtPosition(cursor);
                        if (!word) {
                            continue;
                        }

                        let wordRange = new monaco.Range(cursor.lineNumber, word.startColumn, cursor.lineNumber, word.endColumn);
                        let text = model.getValueInRange(wordRange);
                        commands.push(new ReplaceCommandThatPreservesSelection(wordRange, inverse(text), new monaco.Selection(cursor.lineNumber, cursor.column, cursor.lineNumber, cursor.column)));

                    } else {
                        let text = model.getValueInRange(selection);
                        commands.push(new ReplaceCommandThatPreservesSelection(selection, inverse(text), selection));
                    }
                }
                editor.pushUndoStop();
                editor.executeCommands(this.id, commands);
                editor.pushUndoStop();
            }
        });

        editor.addAction({
            id: 'jimud.action.transformToCapitalize',
            label: 'Transform to Capitalize',
            run: function (editor) {
                let selections = editor.getSelections();
                let model = editor.getModel();
                let commands = [];

                for (let i = 0, len = selections.length; i < len; i++) {
                    let selection = selections[i];
                    if (selection.isEmpty()) {
                        let cursor = selection.getStartPosition();
                        let word = model.getWordAtPosition(cursor);
                        if (!word) {
                            continue;
                        }

                        let wordRange = new monaco.Range(cursor.lineNumber, word.startColumn, cursor.lineNumber, word.endColumn);
                        let text = model.getValueInRange(wordRange);
                        commands.push(new ReplaceCommandThatPreservesSelection(wordRange, capitalize(text), new monaco.Selection(cursor.lineNumber, cursor.column, cursor.lineNumber, cursor.column)));

                    } else {
                        let text = model.getValueInRange(selection);
                        commands.push(new ReplaceCommandThatPreservesSelection(selection, capitalize(text), selection));
                    }
                }
                editor.pushUndoStop();
                editor.executeCommands(this.id, commands);
                editor.pushUndoStop();
            }
        });

        editor.addAction({
            id: 'jimud.action.insertColor',
            label: 'Transform to Capitalize',
            run: function (editor) {
                let selections = editor.getSelections();
                let model = editor.getModel();
                let commands = [];

                for (let i = 0, len = selections.length; i < len; i++) {
                    let selection = selections[i];
                    if (selection.isEmpty()) {
                        let cursor = selection.getStartPosition();
                        let word = model.getWordAtPosition(cursor);
                        if (!word) {
                            continue;
                        }

                        let wordRange = new monaco.Range(cursor.lineNumber, word.startColumn, cursor.lineNumber, word.endColumn);
                        let text = model.getValueInRange(wordRange);
                        commands.push(new ReplaceCommandThatPreservesSelection(wordRange, capitalize(text), new monaco.Selection(cursor.lineNumber, cursor.column, cursor.lineNumber, cursor.column)));

                    } else {
                        let text = model.getValueInRange(selection);
                        commands.push(new ReplaceCommandThatPreservesSelection(selection, capitalize(text), selection));
                    }
                }
                editor.pushUndoStop();
                editor.executeCommands(this.id, commands);
                editor.pushUndoStop();
            }
        });

        editor.onContextMenu((e) => {
            let idx = window.$editors.indexOf(editor);
            if (manager.activePane === manager.panes[idx])
                manager.active.editor.emit('contextmenu', e);
        });
        editor.onDidChangeCursorSelection((e) => {
            let idx = window.$editors.indexOf(editor);
            if (manager.activePane === manager.panes[idx])
                manager.active.editor.selectionChanged(e);
        });
        editor.onDidChangeCursorPosition((e) => {
            let idx = window.$editors.indexOf(editor);
            if (manager.activePane === manager.panes[idx])
                manager.active.editor.emit('location-changed', e.position.column, e.position.lineNumber);
        });

        if (options && options.editorOptions)
            editor.updateOptions(options.editorOptions);
        window.$editors.splice(idx, 0, editor);
    });
    manager.on('destroy-pane', (idx, pane) => {
        window.$editors[idx].dispose();
        window.$editors.splice(idx, 1);
    });
    manager.on('tab-moved', (e) => {
        if (e.panel && e.panel.editor)
            e.panel.editor.focus();
    });
    manager.on('remove', (e) => {
        if (e.panel.editor.changed || e.panel.editor.new) {
            e.cancel = !confirmSave(e.panel);
        }
    });
    manager.on('removed', (e, pane) => {
        e.panel.editor.close();
        delete _editors[e.panel.editor.file];
        if (manager.panes[pane].panels.length === 0)
            window.$editors[pane].domElement.style.display = 'none';
        doUpdate(1);
    });
    manager.on('dock-changed', (e, pane, oPane) => {
        if (manager.panes[oPane].panels.length === 0)
            window.$editors[oPane].domElement.style.display = 'none';
        doUpdate(1);
    });
    manager.on('resize', (e) => {
        if (!window.$editors) return;
        var ed = window.$editors.length;
        while (ed--)
            window.$editors[ed].layout();
    });
    manager.on('activated', (e, pane) => {
        if (e.panel.editor) {
            if (e.panel.editor.type === 1) {
                window.$editors[pane].domElement.style.display = '';
                e.panel.editor.activate(window.$editors[pane]);
                window.$editors[pane].layout();
            }
            else {
                window.$editors[pane].domElement.style.display = 'none';
                e.panel.editor.activate();
            }
            setTimeout(() => { e.panel.editor.focus(); }, 50);
        }
        else
            window.$editors[pane].domElement.style.display = 'none';
        doUpdate(1);
    });
    manager.on('pane-activated', (e, pane) => {
        doUpdate(1);
    });
    manager.on('deactivated', (e, pane) => {
        if (e.panel.editor.type === 1)
            e.panel.editor.deactivate(window.$editors[pane]);
        else
            e.panel.editor.deactivate();
    });
    manager.on('dragenter', (e) => {
        event.dataTransfer.dropEffect = "copy";
        event.dataTransfer.effectAllowed = "copy";
        if (e.dataTransfer.items) {
            for (var i = 0; i < e.dataTransfer.items.length; i++) {
                // If dropped items aren't files, reject them
                if (e.dataTransfer.items[i].kind === 'file') {
                    event.dataTransfer.dropEffect = "link";
                    event.dataTransfer.effectAllowed = "link";
                    event.preventDefault();
                    event.cancelBubble = true;
                    event.stopPropagation();
                    return false;
                }
            }
        }
        else if (e.dataTransfer.files && e.dataTransfer.files.length) {
            event.dataTransfer.dropEffect = "link";
            event.dataTransfer.effectAllowed = "link";
            event.preventDefault();
            event.cancelBubble = true;
            event.stopPropagation();
            return false;
        }
    });
    manager.on('dragover', (e) => {
        event.dataTransfer.dropEffect = "copy";
        event.dataTransfer.effectAllowed = "copy";
        if (e.dataTransfer.items) {
            for (var i = 0; i < e.dataTransfer.items.length; i++) {
                // If dropped items aren't files, reject them
                if (e.dataTransfer.items[i].kind === 'file') {
                    event.dataTransfer.dropEffect = "link";
                    event.dataTransfer.effectAllowed = "link";
                    event.preventDefault();
                    event.cancelBubble = true;
                    event.stopPropagation();
                    return false;
                }
            }
        }
        else if (e.dataTransfer.files && e.dataTransfer.files.length) {
            event.dataTransfer.dropEffect = "link";
            event.dataTransfer.effectAllowed = "link";
            event.preventDefault();
            event.cancelBubble = true;
            event.stopPropagation();
            return false;
        }
    });
    manager.on('drop', (e) => {
        var files = [];
        var f, fl;
        if (e.dataTransfer.items) {
            for (var i = 0; i < e.dataTransfer.items.length; i++) {
                // If dropped items aren't files, reject them
                if (e.dataTransfer.items[i].kind === 'file')
                    files.push(e.dataTransfer.items[i].getAsFile());
            }
        }
        else if (e.dataTransfer.files && e.dataTransfer.files.length) {
            for (f = 0, fl = e.dataTransfer.files.length; f < fl; f++)
                files.push(e.dataTransfer.files[f]);
        }
        if (files.length) {
            event.preventDefault();
            event.cancelBubble = true;
            event.stopPropagation();
            openFiles(files);
        }
        //else
        //manager.active.editor.focus();
    });
    manager.on('tab-contextmenu', (e, pane) => {
        var temp = [];
        if (e.panel.editor.supports('refresh')) {
            temp.push({
                label: 'Refresh',
                click: () => {
                    e.panel.editor.refresh();
                    e.panel.editor.focus();
                },
                accelerator: "F5"
            });
        }
        if (temp.length)
            temp.push({ type: 'separator' });
        temp.push({
            label: '&Copy path',
            click: () => {
                clipboard.writeText(e.panel.editor.file || '');
                clipboard.writeText(e.panel.editor.file || '', 'selection');
            }
        });
        temp.push({ type: 'separator' });
        if (e.panel.editor.changed) {
            temp.push({
                label: '&Save',
                accelerator: "CmdOrCtrl+S",
                click: () => { saveFile(e.panel); }
            });
        }
        temp.push({
            label: 'Save &As',
            accelerator: "CmdOrCtrl+Shift+S",
            click: () => { saveFileAs(e.panel); },
        });
        if (e.panel.editor.changed) {
            if (temp.length)
                temp.push({ type: 'separator' });
            temp.push({
                label: 'Revert',
                click: () => { revertFile(e.panel); }
            });
        }
        if (e.panel.editor.supports('menu|tab-context')) {
            temp.push({ type: 'separator' });
            temp = temp.concat(e.panel.editor.menu('tab-context'));
        }
        if (temp.length)
            temp.push({ type: 'separator' });
        temp.push({
            label: '&Close',
            click: () => { closeFile(e.panel); },
            accelerator: "CmdOrCtrl+F4"
        });
        if (manager.panels.length > 1)
            temp.push({
                label: '&Close Others',
                click: () => { manager.removeAllPanels(e.panel); }
            });
        if (manager.panels.length - 1 > manager.getPanelIndex(e.panel))
            temp.push({
                label: '&Close to the Right',
                click: () => { manager.removeAllPanelsAfter(e.panel); }
            });
        let tabMenu = Menu.buildFromTemplate(temp);
        tabMenu.popup({ window: remote.getCurrentWindow() });
    });

    function updatePanel(panel) {
        if (panel.editor.new)
            panel.tab.classList.add('new');
        else if (panel.editor.changed)
            panel.tab.classList.add('changed');
        else
            panel.tab.classList.remove('changed');
    }

    function updateUI() {
        var enabled = (manager.active && manager.active.editor) ? true : false;
        if (enabled)
            document.title = 'Code Editor - ' + manager.active.tab.innerText;
        else
            document.title = 'Code Editor';
        $("#btn-close").prop('disabled', !enabled);
        $("#btn-close-all").prop('disabled', !enabled);
        menubar.updateItem('File|Close', { enabled: enabled });
        menubar.updateItem('File|Close all', { enabled: enabled });
        menubar.updateItem('File|save as', { enabled: enabled });
        var buttons = document.getElementById("editor-buttons");
        while (buttons.firstChild) {
            buttons.removeChild(buttons.firstChild);
        }
        if (enabled && manager.active.editor.supports('buttons'))
            buttons.append(...manager.active.editor.buttons);
        updateMenu('edit');
        updateMenu('view');
        sbSize.textContent = enabled ? ('Length: ' + manager.active.editor.length.toLocaleString()) : '';
        sbMessage.textContent = '';
        sbName.textContent = enabled ? manager.active.editor.file : '';
        sbName.title = enabled ? manager.active.editor.file : '';
        if (enabled && manager.active.editor.type === 1) {
            var l = manager.active.editor.location;
            sbLocation.textContent = enabled ? (`Ln ${l[1]}, Col ${l[0]}`) : 'Ln 0, Col 0';
        }
        else
            sbLocation.textContent = '';
        if (enabled && manager.active.editor.updateUI) manager.active.editor.updateUI();
        doUpdate(2);
    }

    function updateMenu(menu) {
        var items = subMenus[menu].slice();
        if (manager.active && manager.active.editor && manager.active.editor.supports('menu|' + menu)) {
            var cItems = manager.active.editor.menu(menu);
            if (cItems && cItems.length) {
                items.push({ type: 'separator' });
                items = items.concat(cItems);
            }
        }
        menubar.updateItem(menu, { submenu: items });
    }

    function updateUIChange() {
        var changed = (manager.active && manager.active.editor) ? (manager.active.editor.changed || manager.active.editor.new) : false;
        var changedAll = false;
        var revertAll = false;
        var keys = Object.keys(_editors);
        var k = keys.length;
        var p;
        while (k--) {
            //no editor or of not changed and new try next
            p = keys[k];
            if (!_editors[p] || (!_editors[p].editor.changed && !_editors[p].editor.new))
                continue;
            changedAll = true;
            if (_editors[p].editor.changed)
                revertAll = true;
            if (revertAll && changedAll)
                break; //do not need to check all as soon as one has been found
        }
        $("#btn-save").prop('disabled', !changed);
        menubar.updateItem('file|save', { enabled: changed });
        $("#btn-save-all").prop('disabled', !changedAll);
        menubar.updateItem('file|save all', { enabled: changedAll });

        menubar.updateItem('file|revert', { enabled: (manager.active && manager.active.editor) ? (manager.active.editor.changed) : false });
        menubar.updateItem('file|revert all', { enabled: revertAll });

        $("#btn-undo").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('undo') : true);
        menubar.updateItem('edit|undo', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('undo') : false });
        $("#btn-redo").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('redo') : true);
        menubar.updateItem('edit|redo', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('redo') : false });

        $("#btn-cut").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('cut') : true);
        menubar.updateItem('edit|cut', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('cut') : false });
        $("#btn-copy").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('copy') : true);
        menubar.updateItem('edit|copy', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('copy') : false });
        $("#btn-editor").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('paste-advanced') : true);
        menubar.updateItem('edit|paste to advanced editor', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('paste-advanced') : false });
        $("#btn-paste").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('paste') : true);
        menubar.updateItem('edit|paste', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('paste') : false });
        $("#btn-find").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('find') : true);
        menubar.updateItem('edit|find', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('find') : false });
        $("#btn-replace").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('replace') : true);
        menubar.updateItem('edit|replace', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('replace') : false });
        $("#btn-refresh").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('refresh') : true);
        menubar.updateItem('view|refresh', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('refresh') : false });
        menubar.updateItem('edit|select all', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('selectall') : false });
    }

    function createWatcher() {
        if (watcher)
            watcher.close();
        watcher = chokidar.watch('', {
            persistent: true,
            depth: 0,
            ignoreInitial: true
        });

        // Something to use when events are received.
        var log = console.log.bind(console);
        var ready = false;
        watcher
            .on('error', error => {
                log(`Watcher error: ${error}`);
            })
            .on('ready', () => {
                log('Initial scan complete. Ready for changes');
                ready = true;
            })
            .on('add', (file, stats) => {
                log(`File ${file} has been added`);
                fireWatch('add', file, stats);
            })
            .on('change', (file, stats) => {
                log(`File ${file} has been changed`);
                fireWatch('change', file, stats);
            })
            .on('unlink', file => {
                log(`File ${file} has been removed`);
                fireWatch('unlink', file);
            })
            .on('raw', (event, file, details) => {
                log('Raw event info:', event, file, details);
                fireWatch('raw', file, details);
            });
    }

    function fireWatch(event, file, args) {
        var keys = Object.keys(_editors);
        var k = keys.length;
        var p;
        while (k--) {
            p = keys[k];
            //no editor or of not changed and new try next
            if (!_editors[p])
                continue;
            _editors[p].editor.watch(event, file, args);
        }
    }

    function closing() {
        if (watcher)
            watcher.close();
    }

    function loadOptions() {
        options = EditorSettings.load(parseTemplate(path.join('{data}', 'editor.json')));
        if (!options.outputSize || options.outputSize < 170)
            options.outputSize = 170;
        if (!options.maxRecent)
            options.maxRecent = 15;
        try {
            if (!spellchecker && options.spellchecking)
                spellchecker = require('spellchecker');
        }
        catch (ex) {
            ipcRenderer.send('error', ex);
        }
        if (_ready) {
            var e = window.$editors.length;
            while (e--)
                window.$editors[e].updateOptions(options.editorOptions);
        }
        output.css('height', options.outputSize + 'px');
        if (options.output) {
            dock.css('bottom', options.outputSize + 'px');
            output.css('display', 'block');
        }
        else {
            dock.css('bottom', '');
            output.css('display', 'none');
        }
        menubar.updateItem('view|output', { checked: options.output });
        doUpdate(4);
    }

    function saveOptions() {
        options.save(parseTemplate(path.join('{data}', 'editor.json')));
        ipcRenderer.send('editor-settings-reload');
    }

    function getFileIcon(file) {
        switch (path.extname(file)) {
            case ".pdf":
                return 'fa fa-file-pdf-o';
            case ".xls":
            case ".xlt":
            case ".xlm":
            case ".xlsx":
            case ".xlsm":
            case ".xltx":
            case ".xltm":
                return 'fa fa-file-excel-o';
            case ".doc":
            case ".dot":
            case ".wbk":
            case ".docx":
            case ".docm":
            case ".dotx":
            case ".dotm":
            case ".docb":
                return 'fa fa-file-word-o';
            case ".ppt":
            case ".pot":
            case ".pps":
            case ".pptx":
            case ".pptm":
            case ".potx":
            case ".potm":
            case ".ppam":
            case ".ppsx":
            case ".ppsm":
            case ".sldx":
            case ".sldm":
                return 'fa fa-file-powerpoint-o';
            case ".png":
            case ".gif":
            case ".jpg":
            case ".ico":
            case ".svg":
            case ".webp":
                return 'fa fa-file-image-o';
            case ".m4a":
            case ".wav":
            case ".mp3":
            case ".flac":
                return 'fa fa-file-audio-o';
            case ".avi":
            case ".mpg":
            case ".mov":
            case ".webm":
            case ".oog":
            case ".mkv":
                return 'fa fa-file-video-o';
            case ".7z":
            case ".zip":
            case ".rar":
            case ".jar":
                return 'fa fa-file-archive-o';
            case ".txt":
                return 'fa fa-file-text-o';
            case ".o":
            case ".csv":
                return 'fa fa-file-o icon-o';
            case ".h":
                return 'fa fa-file-code-o icon-h';
            case ".c":
                return 'fa fa-file-code-o icon-c';
            case ".map":
                return 'fa fa-map-o';
        }
        return 'fa fa-file-o';
    }

    function childClosed(url, name) {
    }

    function clearButton(id) {
        $(id).removeClass('open');
        $(id).blur();
    }

    function doCut() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('cut'))
            manager.active.editor.cut();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doCopy() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('copy'))
            manager.active.editor.copy();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doPaste() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('paste'))
            manager.active.editor.paste();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doEditor() {
        if (!manager.active || !manager.active.editor || !manager.active.editor.supports('copy'))
            return;
        ipcRenderer.send('send-editor', manager.active.editor.selected, 'editor', true);
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doRedo() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('redo'))
            manager.active.editor.redo();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doUndo() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('undo'))
            manager.active.editor.undo();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doFind() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('find'))
            manager.active.editor.find();
    }

    function doReplace() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('replace'))
            manager.active.editor.replace();
    }

    function doRefresh() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('refresh'))
            manager.active.editor.refresh();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function toggleOutput() {
        if (options.output)
            options.output = false;
        else
            options.output = true;
        menubar.updateItem('view|output', { checked: options.output });
        output.css('height', options.outputSize + 'px');
        if (options.output) {
            dock.css('bottom', options.outputSize + 'px');
            output.css('display', 'block');
        }
        else {
            dock.css('bottom', '');
            output.css('display', 'none');
        }
        $(window).trigger('resize');
        doUpdate(16);
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doClearOutput() {
        outputDisplay.empty();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function closeOutput() {
        options.output = false;
        menubar.updateItem('view|output', { checked: options.output });
        dock.css('bottom', '');
        output.css('display', 'none');
        $(window).trigger('resize');
        doUpdate(16);
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function logOutput(text, open) {
        if (!text || text.length === 0)
            return;
        if (open && !options.output)
            toggleOutput();
        outputDisplay.append('<div>' + text + '</div>');
        outputDisplay[0].scrollTop = outputDisplay[0].scrollHeight;
    }

    var timer = new DebugTimer();

    $(document).ready(() => {
        loadOptions();
        $('#btm-drag-bar').mousedown(function (e) {
            e.preventDefault();
            outputDragging = true;
            var ghostBar = $('<div>',
                {
                    id: 'btm-ghost-bar',
                    css: {
                        width: output.outerWidth(),
                        top: output.offset().top,
                        left: output.offset().left
                    }
                }).appendTo('body');

            $(document).mousemove(function (e) {
                if (e.pageY < 169)
                    ghostBar.css("top", 169);
                else if (e.pageY > document.body.clientHeight - 170)
                    ghostBar.css("top", document.body.clientHeight - 170);
                else
                    ghostBar.css("top", e.pageY);
                //if (window.$editor)
                //window.$editor.layout();
            });
        });

        $('#toolbar').on('click', () => {
            if (manager.active && manager.active.editor)
                manager.active.editor.focus();
        });

        $(window).on('resize', () => {
            if (output.outerHeight() < 170 && (dock.outerHeight() + 28) > 172) {
                options.outputSize = 170;
                output.css("height", options.outputSize);
                dock.css("bottom", options.outputSize);
                doUpdate(16);
            }
            var keys = Object.keys(_editors);
            var k = keys.length;
            var p;
            while (k--) {
                p = keys[k];
                if (!_editors[p]) continue;
                _editors[p].editor.resize();
            }
            if (manager.active && manager.active.editor) manager.active.editor.focus();
            if (window.$editor)
                window.$editor.layout();
        });

        $(document).mouseup(function (e) {
            if (outputDragging) {
                if (e.pageY < 170)
                    options.outputSize = document.body.clientHeight - 172;
                else if (e.pageY > document.body.clientHeight - 170)
                    options.outputSize = 170;
                else
                    options.outputSize = document.body.clientHeight - e.pageY + 2;
                output.css("height", options.outputSize);
                dock.css("bottom", options.outputSize);
                doUpdate(16);
                $('#btm-ghost-bar').remove();
                $(document).unbind('mousemove');
                if (manager.active && manager.active.editor) manager.active.editor.focus();
                if (window.$editor)
                    window.$editor.layout();
                outputDragging = false;
            }
        });

        $('#btn-add-dropdown').click(function () {
            $(this).addClass('open');
            const pos = $(this).offset();
            const x = Math.floor(pos.left);
            const y = Math.floor(pos.top + $(this).outerHeight() + 2);
            const addMenu = new Menu();
            addMenu.append(new MenuItem({
                label: 'New file', click() {
                    clearButton('#btn-add-dropdown');
                    newFile();
                }
            }));
            addMenu.append(new MenuItem({ type: 'separator' }));
            addMenu.append(new MenuItem({
                label: 'New area...', click() {
                    clearButton('#btn-add-dropdown');
                    newArea();
                }
            }));
            /*
            addMenu.append(new MenuItem({
                label: 'New virtual area...', click() {
                    clearButton('#btn-add-dropdown');
                    newVirtualArea();
                }
            }));
            */
            addMenu.append(new MenuItem({ type: 'separator' }));
            addMenu.append(new MenuItem({
                label: 'New room...', click() {
                    clearButton('#btn-add-dropdown');
                    roomWizard();
                }
            }));
            addMenu.append(new MenuItem({
                label: 'New monster...', click() {
                    clearButton('#btn-add-dropdown');
                    monsterWizard();
                }
            }));
            addMenu.append(new MenuItem({ type: 'separator' }));
            addMenu.append(new MenuItem({
                label: 'Templates',
                submenu: menuTemplates
            }));
            addMenu.popup({ window: remote.getCurrentWindow(), x: x, y: y });
        });

        $("#btn-newarea-path").on('click', () => {
            dialog.showOpenDialog(remote.getCurrentWindow(), {
                defaultPath: $("#newarea-path").val(),
                properties: ['openDirectory', 'createDirectory']
            },
                function (fileNames) {
                    if (fileNames === undefined) {
                        return;
                    }
                    $("#newarea-path").val(fileNames[0]);
                });
        });
        $("#btn-newvirtualarea-path").on('click', () => {
            dialog.showOpenDialog(remote.getCurrentWindow(), {
                defaultPath: $("#newvirtualarea-path").val(),
                properties: ['openDirectory', 'createDirectory']
            },
                function (fileNames) {
                    if (fileNames === undefined) {
                        return;
                    }
                    $("#newvirtualarea-path").val(fileNames[0]);
                });
        });

        $('#eNone').on('change', function (e) {
            $('#newvirtualarea-default-exits input[id^="de"]').prop('checked', false);
            if (!this.checked) {
                e.preventDefault();
                $('#eNone').prop('checked', true);
                $('.btn-group input').parent().removeClass('active');
                $('.btn-group input:checked').parent().addClass('active');
                return false;
            }
            $('.btn-group input').parent().removeClass('active');
            $('.btn-group input:checked').parent().addClass('active');
        });

        $('#newvirtualarea-default-exits input[id^="de"]').on('change', function (e) {
            $('#eNone').prop('checked', false);
            $('.btn-group input').parent().removeClass('active');
            $('.btn-group input:checked').parent().addClass('active');
        });

        $('#sNone').on('change', function (e) {
            $('#newvirtualarea-default-states input[id^="ds"]').prop('checked', false);
            if (!this.checked) {
                e.preventDefault();
                $('#sNone').prop('checked', true);
                $('.btn-group input').parent().removeClass('active');
                $('.btn-group input:checked').parent().addClass('active');
                return false;
            }
            $('.btn-group input').parent().removeClass('active');
            $('.btn-group input:checked').parent().addClass('active');
        });

        $('#newvirtualarea-default-states input[id^="ds"]').on('change', function (e) {
            $('#sNone').prop('checked', false);
            $('.btn-group input').parent().removeClass('active');
            $('.btn-group input:checked').parent().addClass('active');
        });
        createWatcher();
        postEditorLoad();
    });

    function postEditorLoad() {
        if (!_ready) {
            setTimeout(postEditorLoad, 10);
            return;
        }
        var o, ol;
        //var start = new Date().getTime();
        if (_open) {
            if (options.opened.length && Array.isArray(options.opened[0])) {
                manager.layout = options.layout;
                options.opened[0] = options.opened[0].concat(_open.map((l) => { return { file: l[0], remote: [1] }; }));
                let l = options.opened.length;
                while (l--)
                    openFiles(options.opened[l], false, manager.panes[l]);
            }
            else
                openFiles(options.opened.concat(_open.map((l) => { return { file: l[0], remote: [1] }; })));
            _open = 0;
        }
        else if (options.opened.length && Array.isArray(options.opened[0])) {
            manager.layout = options.layout;
            let l = options.opened.length;
            while (l--)
                openFiles(options.opened[l], false, manager.panes[l]);
        }
        else
            openFiles(options.opened);
        $("#splashScreenMask").css('display', 'none');
        $("#splashLayout").css('display', 'none');
        remote.getCurrentWindow().setEnabled(true);
        _loading = 0;
    }

    function savedOpened() {
        var opened = [];

        var panes = manager.panes;
        var s = panes.length;
        while (s--) {
            var panels = manager.panes[s].panels;
            var k = panels.length;
            var p;
            opened[s] = [];
            while (k--) {
                p = panels[k];
                if (!p.editor.new)
                    opened[s].unshift({
                        file: p.editor.file,
                        remote: p.editor.remote
                    });
                if (!p.editor.new && !p.editor.changed)
                    continue;
                if (!confirmSave(p))
                    return false;
            }
        }
        if (!options) loadOptions();
        if (options.reopen)
            options.opened = opened;
        else
            options.opened = [];
        options.layout = manager.layout;
        saveOptions();
        return true;
    }

    function closeHidden() {
        var elems = document.body.getElementsByTagName("dialog");
        var e = 0, el = elems.length;
        for (; e < el; e++) {
            if (elems[e].open) {
                if (dialog.showMessageBox(
                    remote.getCurrentWindow(),
                    {
                        type: 'question',
                        title: 'Open dialog',
                        message: (elems[e].dataset.title || 'Dialog') + ' is open, exit?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1
                    }) === 1)
                    return;
            }
        }
        if (!savedOpened())
            return;
        remote.getCurrentWindow().hide();
    }

    function closeWindow() {
        remote.getCurrentWindow().close();
    }

    window.onbeforeunload = function (evt) {
        if (!$closeWindow) {
            console.log(document.activeElement);
            if (document.activeElement)
                document.activeElement.blur();
            evt.returnValue = false;
            setTimeout(() => {
                var elems = document.body.getElementsByTagName("dialog");
                var e = 0, el = elems.length;
                for (; e < el; e++) {
                    if (elems[e].open) {
                        if (dialog.showMessageBox(
                            remote.getCurrentWindow(),
                            {
                                type: 'question',
                                title: 'Open dialog',
                                message: (elems[e].dataset.title || 'Dialog') + ' is open, exit?',
                                buttons: ['Yes', 'No'],
                                defaultId: 1
                            }) === 1)
                            return 'no';
                    }
                }
                if (!savedOpened())
                    return 'no';
                //clean up
                var keys = Object.keys(_editors);
                var p = keys.length;
                while (p--)
                    _editors[keys[p]].editor.close();
                if (watcher)
                    watcher.close();
                $closeWindow = true;
                remote.getCurrentWindow().close();
            });
            return 'no';
        }
        if (watcher)
            watcher.close();
        $closeWindow = true;
        remote.getCurrentWindow().close();
        return;
    };

    ipcRenderer.on('open-editor', (event, file, remoteFile) => {
        if (_loading) {
            if (!_open)
                _open = [];
            _open.push([file, remoteFile]);
        }
        else
            openFile(file, remoteFile);
    });

    ipcRenderer.on('send-editor', (event, text, window) => {
        if (!manager.active || !manager.active.editor || window != "code-editor")
            return;
        manager.active.editor.insert(text);
    });

    ipcRenderer.on('GMCP-received', (event, data) => {
        if (options && options.debug)
            console.log(data);
        //if ()
        //_ied.processGMCP(data.mod, data.obj);
    });

    ipcRenderer.on('editor-setting-changed', (event, data) => {
        loadOptions();
        var keys = Object.keys(_editors);
        var k = keys.length;
        var p;
        while (k--) {
            p = keys[k];
            if (_editors[p].editor.type === 1) {
                _editors[p].editor.options = options.modelOptions;
                manager.setPanelIconClass(getFileIcon(_editors[p].editor.file), _editors[p]);
                if (options.nativeIcons)
                    app.getFileIcon((path.extname(_editors[p].editor.file).length !== 0 ? _editors[p].editor.file : '.*'), { size: 'small' }, (err, icon) => {
                        if (err || !icon) return;
                        manager.setPanelIcon(icon.toDataURL(), _editors[p]);
                    });
            }
            else if (_editors[p].editor.type === 2)
                _editors[p].editor.options = options.virtualOptions;

        }
    });

    function newFile(file) {
        createEditor({ file: 'new_' + newCounter + '.c', new: true }, true);
        newCounter++;
        doUpdate(1);
        updatePanel(manager.active);
    }

    function newFromFile(file, name) {
        if (!file || file.length === 0) return;
        var value = parseFileTemplate(fs.readFileSync(file, 'utf8'));
        createEditor({ file: 'new_' + name.replace(/\s/g, '_') + '_' + newCounter + '.c', new: true, value: value }, true);
        newCounter++;
        doUpdate(1);
        updatePanel(manager.active);
    }

    function newFromValue(value, file) {
        if (!file || file.length === 0) {
            file = 'new_' + name.replace(/\s/g, '_') + '_' + newCounter + '.c';
            newCounter++;
        }
        createEditor({ file: file, new: true, value: parseFileTemplate(value || '') }, true);
        doUpdate(1);
        updatePanel(manager.active);
    }

    function parseFileTemplate(template, data) {
        if (!template || template.length === 0) return template;
        if (!data) data = baseParseData();
        var d;
        for (d in data) {
            if (!data.hasOwnProperty(d))
                continue;
            if (data[d].regex)
                template = template.replace(data[d].regex, data[d].value);
            else
                template = template.replace(new RegExp('{' + d + '}', 'g'), data[d]);
        }
        return template;
    }

    function baseParseData() {
        var character = capitalize(remote.getGlobal('characterLogin') || remote.getGlobal('character')) || 'Unknown';
        return {
            'your name': character,
            'character': character,
            'name': character,
            'date': moment().format('YYYY-MM-DD')
        };
    }

    function newArea() {
        $('#newArea *').attr('disabled', false);
        var p = $("#newarea-path").parent().parent();
        p.removeClass("has-error");
        p.removeClass("has-feedback");
        $("button", p).removeClass('btn-danger');
        p = $("#newarea-name").parent();
        p.removeClass("has-error");
        p.removeClass("has-feedback");
        $('#newarea-path').val(options.browse || ((manager.active && manager.active.editor) ? path.dirname(manager.active.editor.file) : (options.recent && options.recent.length ? path.dirname(options.recent[0].file) : '')));
        $('#newarea-name').val('');
        document.getElementById('newArea').showModal();
    }

    function createArea() {
        var p;
        p = $("#newarea-path").parent().parent();
        p.removeClass("has-error");
        p.removeClass("has-feedback");
        $("button", p).removeClass('btn-danger');
        p = $("#newarea-name").parent();
        p.removeClass("has-error");
        p.removeClass("has-feedback");
        if (!existsSync($('#newarea-path').val())) {
            p = $("#newarea-path").parent().parent();
            p.addClass("has-error");
            p.addClass("has-feedback");
            $("button", p).addClass('btn-danger');
            p.find(".form-error").html("<small class=\"aura-error\"><span class='sr-only'>Error:</span>Path does not exist</small>");
            $('#newarea-path').focus();
            return;
        }
        if (!isDirSync($('#newarea-path').val())) {
            p = $("#newarea-path").parent();
            p.addClass("has-error");
            p.addClass("has-feedback");
            $("button", p).addClass('btn-danger');
            p.find(".form-error").html("<small class=\"aura-error\"><span class='sr-only'>Error:</span>Invalid path</small>");
            $('#newarea-path').focus();
            return;
        }
        if (!validName($('#newarea-name').val())) {
            p = $("#newarea-name").parent();
            p.addClass("has-error");
            p.addClass("has-feedback");
            p.find(".form-error").html("<small class=\"aura-error\"><span class='sr-only'>Error:</span>Invalid, can only contain letters, numbers, and _</small>");
            $('#newarea-name').focus();
            return;
        }
        var aPath = path.join($('#newarea-path').val(), $('#newarea-name').val());
        if (existsSync(aPath)) {
            p = $("#newarea-path").parent().parent();
            p.addClass("has-error");
            p.addClass("has-feedback");
            $("button", p).addClass('btn-danger');
            p.find(".form-error").html("<small class=\"aura-error\"><span class='sr-only'>Error:</span>Directory with area name already exist</small>");
            $('#newarea-path').focus();
            return;
        }
        options.browse = $('#newarea-path').val();
        doUpdate(16);
        $('#newArea *').attr('disabled', true);
        var templatePath = parseTemplate(path.join('{assets}', 'templates', 'wizards', 'area'));
        var template = walkSync(templatePath);
        var templateRegex = new RegExp('^' + templatePath.replace(/\\/g, '\\\\'));
        var c = 0;
        var cl = template.dirs.length;
        fs.mkdirSync(aPath);
        for (; c < cl; c++)
            fs.mkdirSync(template.dirs[c].replace(templateRegex, aPath));
        c = 0;
        cl = template.files.length;
        var data = baseParseData();
        data.area = $('#newarea-name').val();
        data.path = $('#newarea-remote-path').val() || '/realms/' + data.name.toLowerCase() + '/' + $('#newarea-name').val().toLowerCase();
        if (data.path.endsWith('/'))
            data.path = data.path.substr(0, data.path.length - 1);
        if (!data.path.startsWith('/'))
            data.path = '/' + data.path;
        var value;
        var file;
        var files = [];
        for (; c < cl; c++) {
            value = fs.readFileSync(template.files[c], 'utf8');
            value = parseFileTemplate(value, data);
            file = template.files[c].replace(templateRegex, aPath);
            fs.writeFileSync(file, value);
            files.push({
                file: file,
                remote: template.files[c].replace(templateRegex, data.path).replace(/\\/g, '/')
            });
        }
        openFiles(files);
        document.getElementById('newArea').close();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function validName(name) {
        if (!name || name.length === 0)
            return false;
        if (!name.match(/^[a-zA-Z0-9_]+$/g))
            return false;
        return true;
    }

    function newVirtualArea() {
        $('#newvirtualarea-path').val(options.browse || ((manager.active && manager.active.editor) ? path.dirname(manager.active.editor.file) : (options.recent && options.recent.length ? path.dirname(options.recent[0].file) : '')));
        $('#newvirtualarea-area').val('');
        $('.btn-group input').parent().removeClass('active');
        $('.btn-group input:checked').parent().addClass('active');
        document.getElementById('newVirtualArea').showModal();
    }

    function roomWizard() {
        newFromFile(parseTemplate(path.join('{assets}', 'templates', 'rooms', 'base.c')), 'room');
    }

    function monsterWizard() {
        newFromFile(parseTemplate(path.join('{assets}', 'templates', 'monsters', 'base.c')), 'monster');
    }

    function openFile(file, remoteFile, dock) {
        if (!file || file.length === 0) {
            dialog.showOpenDialog(remote.getCurrentWindow(),
                {
                    filters: [
                        { name: 'Supported files (*.c, *.h, *.map)', extensions: ['c', 'h', 'map'] },
                        { name: 'Code files (*.c, *.h)', extensions: ['c', 'h'] },
                        { name: 'Data files (*.o, *.cfg)', extensions: ['o', 'cfg'] },
                        { name: 'Text files (*.txt)', extensions: ['txt'] },
                        { name: 'Map files (*.map)', extensions: ['map'] },
                        { name: 'All files (*.*)', extensions: ['*'] },
                    ],
                    properties: ['multiSelections', 'openFile'],
                    defaultPath: (manager.active && manager.active.editor) ? path.dirname(manager.active.editor.file) : (options.recent && options.recent.length ? path.dirname(options.recent[0].file) : '')
                },
                function (fileNames) {
                    if (fileNames === undefined) {
                        return;
                    }
                    openFiles(fileNames.map((l) => { return { file: l }; }), true, dock);
                });
        }
        else {
            _recent.unshift({ file: file, remote: remoteFile });
            createEditor({ file: file, open: true, remote: remoteFile }, true, dock);
            doUpdate(25);
        }
    }

    function openFiles(files, exists, dock) {
        if (files.length === 0) return;
        var panels = [];
        for (var f = 0, fl = files.length; f < fl; f++) {
            if (exists && !existsSync(files[f].file)) {
                dialog.showMessageBox(remote.getCurrentWindow(), {
                    type: 'info',
                    title: 'Path does not exist',
                    message: 'The path \'' + files[f].file + '\' does not seem to exist anymore on disk.'
                });
                continue;
            }
            _recent.unshift({ file: files[f].file || files[f].path, remote: files[f].remote });
            var p = createEditor({ file: files[f].file || files[f].path, remote: files[f].remote, open: true });
            if (p)
                panels.push(p);
        }
        manager.addPanels(panels, dock);
        doUpdate(25);
    }

    function addToRecent(file, remoteFile) {
        if (!options) loadOptions();
        if (!options.recent) options.recent = [];
        var recent = [];
        var r = options.recent.length;
        while (r--) {
            if (options.recent[r].file !== file)
                recent.unshift(options.recent[r]);
        }
        recent.unshift({ file: file, remote: remoteFile });
        if (recent.length > options.maxRecent)
            options.recent = recent.slice(0, options.maxRecent);
        else
            options.recent = recent;
        app.addRecentDocument(file);
        doUpdate(20);
    }

    function flushRecent() {
        if (!_recent.length) return;
        var r = _recent.length;
        while (r--) {
            addToRecent(_recent[r].file, _recent[r].remoteFile);
        }
        _recent = [];
        doUpdate(4);
    }

    function buildRecent() {
        var menu = [];
        var r = options.recent.length;
        while (r--) {
            menu.unshift(
                {
                    label: options.recent[r].file,
                    idx: r,
                    click: (item) => {
                        if (!existsSync(options.recent[item.idx].file)) {
                            dialog.showMessageBox(remote.getCurrentWindow(), {
                                type: 'info',
                                title: 'Path does not exist',
                                message: 'The path \'' + options.recent[item.idx].file + '\' does not seem to exist anymore on disk.'
                            });
                            options.recent = options.recent.slice(item.idx, 1);
                            doUpdate(20);
                        }
                        else
                            openFile(options.recent[item.idx].file, options.recent[item.idx].remote);
                    }
                }
            );
            if (r < 10)
                menu[0].accelerator = 'CmdOrCtrl+' + (r + 1);
        }
        if (menu.length > 0) {
            menu.push({ type: 'separator' });
            menu.push({
                label: 'Clear Recently Opened',
                click: () => {
                    options.recent = [];
                    app.clearRecentDocuments();
                    doUpdate(20);
                }
            });
        }
        menubar.updateItem('file|open recent', { submenu: menu });
    }

    function saveFile(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        if (panel.editor.new)
            return saveFileAs(panel);
        panel.editor.save();
        if (manager.active && manager.active.editor)
            manager.active.editor.focus();
        return true;
    }

    function saveAllFiles() {
        var keys = Object.keys(_editors);
        var k = keys.length;
        var p;
        while (k--) {
            p = keys[k];
            if (!_editors[p].editor.new && !_editors[p].editor.changed)
                continue;
            if (!saveFile(_editors[p]))
                return false;
        }
        return true;
    }

    function saveFileAs(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        var file = dialog.showSaveDialog(remote.getCurrentWindow(), {
            title: 'Save as...',
            defaultPath: panel.editor.file,
            filters: [
                { name: 'Supported files (*.c, *.h, *.map)', extensions: ['c', 'h', 'map'] },
                { name: 'Code files (*.c, *.h)', extensions: ['c', 'h'] },
                { name: 'Data files (*.o, *.cfg)', extensions: ['o', 'cfg'] },
                { name: 'Text files (*.txt)', extensions: ['txt'] },
                { name: 'Map files (*.map)', extensions: ['map'] },
                { name: 'All files (*.*)', extensions: ['*'] },
            ]
        });
        if (file === undefined)
            return false;
        panel.editor.file = file;
        if (!panel.editor.canSaveAs())
            return false;
        manager.setPanelTooltip(panel.editor.file, panel);
        manager.setPanelTitle(panel.editor.filename, panel);
        panel.editor.save();
        if (manager.active && manager.active.editor)
            manager.active.editor.focus();
        return true;
    }

    function revertFile(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        var choice;
        if (panel.editor.changed && panel.editor.new) {
            choice = dialog.showMessageBox(
                remote.getCurrentWindow(),
                {
                    type: 'question',
                    title: 'Revert new file?',
                    message: 'Revert ' + panel.editor.filename + ' to start and lose changes?',
                    buttons: ['Yes', 'No'],
                    defaultId: 1
                });
            if (choice === 0)
                panel.editor.revert();
        }
        else if (panel.editor.changed && !panel.editor.new) {
            choice = dialog.showMessageBox(
                remote.getCurrentWindow(),
                {
                    type: 'question',
                    title: 'Revert file?',
                    message: 'Revert ' + panel.editor.filename + ' and lose changes?',
                    buttons: ['Yes', 'No'],
                    defaultId: 1
                });
            if (choice === 0)
                panel.editor.revert();
        }
        if (manager.active && manager.active.editor)
            manager.active.editor.focus();
    }

    function revertAllFiles() {
        var keys = Object.keys(_editors);
        var k = keys.length;
        var p;
        while (k--) {
            p = keys[k];
            //not changed try next
            if (!_editors[p].editor.changed)
                continue;
            if (!revertFile(_editors[p]))
                return false;
        }
        return true;
    }

    function closeFile(panel) {
        if (!panel) {
            if (!manager.active)
                return;
            panel = manager.active;
        }
        if (panel)
            manager.removePanel(panel);
        if (manager.active && manager.active.editor)
            manager.active.editor.focus();
    }

    function closeAllFiles() {
        manager.removeAllPanels();
    }

    function confirmSave(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        var choice = dialog.showMessageBox(
            remote.getCurrentWindow(),
            {
                type: 'question',
                title: panel.editor.new ? 'Save file?' : 'Save changes?',
                message: panel.editor.new ? ('Save ' + panel.editor.filename + '?') : ('Save changes to ' + panel.editor.filename + '?'),
                buttons: ['Yes', 'No', 'Cancel'],
                defaultId: 1
            });
        //canceled
        if (choice === 2)
            return false;
        //no
        if (choice === 1)
            return true;
        //attempt to save
        return saveFile(panel);
    }

    function sortFiles(a, b, p) {
        if (fs.lstatSync(path.join(p, a)).isDirectory())
            return -1;
        if (fs.lstatSync(path.join(p, b)).isDirectory())
            return 1;
        return a.localeCompare(b);
    }

    function loadTemplates(p, root, exclude) {
        const menu = [];
        const files = fs.readdirSync(p);
        files.sort((a, b) => { return sortFiles(a, b, p); });
        const fl = files.length;
        var base = false;
        for (let f = 0; f < fl; f++) {
            if (exclude && exclude.indexOf(files[f]) !== -1)
                continue;
            if (fs.lstatSync(path.join(p, files[f])).isDirectory()) {
                menu.push({
                    label: capitalize(path.basename(files[f], path.extname(files[f])).replace(/_/g, ' ')),
                    submenu: loadTemplates(path.join(p, files[f]), path.join(root, files[f]))
                });
            }
            else {
                if (files[f] === 'base.c') {
                    base = true;
                    continue;
                }
                menu.push({
                    label: capitalize(path.basename(files[f], path.extname(files[f])).replace(/_/g, ' ')),
                    path: path.join(root, files[f]),
                    click: (item) => {
                        newFromFile(parseTemplate(path.join('{assets}', 'templates', item.path)), item.label.toLowerCase());
                    }
                });
            }
        }
        if (base) {
            if (menu.length > 0)
                menu.unshift({ type: 'separator' });
            menu.unshift(
                {
                    label: 'base',
                    newName: path.basename(p).replace(/_/g, ' ').slice(0, -1),
                    path: path.join(root, 'base.c'),
                    click: (item) => {
                        newFromFile(parseTemplate(path.join('{assets}', 'templates', item.path)), item.newName.toLowerCase());
                    }
                }
            );
        }
        return menu;
    }

    function findEditor(file) {
        if (!file || file.length === 0)
            return 0;
        return _editors[file];
    }

    function createEditor(data, add, dock) {//file, open, remoteFile, _new, value) {
        var p = findEditor(data.file);
        if (p) {
            p.editor.remote = data.remote;
            manager.switchToPanel(p);
            return null;
        }
        else {
            _loading++;
            p = manager.createPanel(path.basename(data.file), getFileIcon(data.file), data.file);
            data.container = p.pane;
            data.watch = (files) => {
                if (!files) return;
                for (var f = 0, fl = files.length; f < fl; f++) {
                    if (!_watched[files[f]]) {
                        _watched[files[f]] = 1;
                        watcher.add(files[f]);
                    }
                    else
                        _watched[files[f]]++;
                }
            };
            data.watchStop = (files) => {
                if (!files) return;
                for (var f = 0, fl = files.length; f < fl; f++) {
                    _watched[files[f]]--;
                    if (_watched[files[f]] === 0) {
                        watcher.unwatch(files[f]);
                        delete _watched[files[f]];
                    }
                }
            };
            if (path.extname(data.file) === '.map') {
                data.options = options.virtualOptions;
                p.editor = new VirtualEditor(data);
                p.editor.on('room-dblclick', (room) => {
                    var f;
                    if (p.editor.maxLevel > 1)
                        f = room.x + "," + room.y + "," + room.z + ".c";
                    else
                        f = room.x + "," + room.y + ".c";
                    f = path.join(path.dirname(p.editor.file), f);
                    if (existsSync(f))
                        openFile(f);
                    else if (dialog.showMessageBox(
                        remote.getCurrentWindow(),
                        {
                            type: 'question',
                            title: 'Create room?',
                            message: 'Create new external room?',
                            buttons: ['Yes', 'No'],
                            defaultId: 1
                        }) === 0) {
                        newFromValue(p.editor.externalCode(room), f);
                    }
                });
            }
            else {
                p.editor = new MonacoCodeEditor(data);
                if (options.nativeIcons)
                    app.getFileIcon((path.extname(data.file).length !== 0 ? data.file : '.*'), { size: 'small' }, (err, icon) => {
                        if (err || !icon) return;
                        manager.setPanelIcon(icon.toDataURL(), p);
                    });
                p.editor.options = options.modelOptions;
            }
            if (!_watched[data.file]) {
                _watched[data.file] = 1;
                watcher.add(data.file);
            }
            else
                _watched[data.file]++;
            p.editor.on('reload', (type, file) => {
                var choice;
                if (type === 'unlink') {
                    choice = dialog.showMessageBox(
                        remote.getCurrentWindow(),
                        {
                            type: 'question',
                            title: 'File deleted',
                            message: path.basename(file || p.editor.file) + ' has been deleted, keep open?',
                            buttons: ['Yes', 'No'],
                            defaultId: 1
                        });
                    //no
                    if ((!file || p.editor.file === file) && choice === 1)
                        closeFile(p);
                    else
                        p.editor.deleted(choice === 0, file);
                }
                else {
                    choice = dialog.showMessageBox(
                        remote.getCurrentWindow(),
                        {
                            type: 'question',
                            title: 'File changed',
                            message: path.basename((file || p.editor.file) + ' has been changed, reload?'),
                            buttons: ['Yes', 'No'],
                            defaultId: 1
                        });
                    //yes
                    if (choice === 0)
                        p.editor.revert(file);
                    //else
                    //p.editor.changed = true;
                }
            });
            p.editor.on('supports-changed', () => {
                if (p !== manager.active) return;
                doUpdate(2);
            });
            p.editor.on('changed', (length) => {
                updatePanel(p);
                if (p !== manager.active) return;
                doUpdate(2);
                sbSize.textContent = 'Length: ' + length.toLocaleString();
            });
            p.editor.on('saved', () => {
                updatePanel(p);
                if (p !== manager.active) return;
                doUpdate(2);
            });
            p.editor.on('reverted', () => {
                updatePanel(p);
                if (p !== manager.active) return;
                doUpdate(2);
            });
            p.editor.on('selection-changed', () => {
                if (p !== manager.active) return;
                doUpdate(2);
            });
            p.editor.on('menu-update', (menu, options) => {
                if (p !== manager.active) return;
                menubar.updateItem(menu, options);
            });
            p.editor.on('rebuild-buttons', () => {
                if (p !== manager.active) return;
                var buttons = document.getElementById("editor-buttons");
                while (buttons.firstChild) {
                    buttons.removeChild(buttons.firstChild);
                }
                if (p.editor.supports('buttons'))
                    buttons.append(...p.editor.buttons);
            });
            p.editor.on('contextmenu', (e, token) => {
                var temp = [];
                if (p.editor.supports('refresh')) {
                    temp.push({
                        label: 'Refresh',
                        click: doRefresh,
                        accelerator: "F5"
                    });
                }
                if (p.editor.supports('undo'))
                    temp.push({
                        label: 'Undo',
                        click: doUndo,
                        accelerator: "CmdOrCtrl+Z"
                    });
                if (p.editor.supports('redo'))
                    temp.push({
                        label: 'Redo',
                        click: doRedo,
                        accelerator: "CmdOrCtrl+Y"
                    });
                if (p.editor.supports('undo') || p.editor.supports('redp'))
                    temp.push({ type: 'separator' });
                if (p.editor.supports('cut'))
                    temp.push({
                        label: 'Cut',
                        click: doCut,
                        accelerator: "CmdOrCtrl+C"
                    });
                if (p.editor.supports('copy'))
                    temp.push({
                        label: 'Copy',
                        click: doCopy,
                        accelerator: "CmdOrCtrl+X"
                    });
                if (p.editor.supports('paste'))
                    temp.push({
                        label: 'Paste',
                        click: doPaste,
                        accelerator: "CmdOrCtrl+V"
                    });
                if (p.editor.supports('copy'))
                    temp.push({
                        label: 'Paste to Advanced Editor',
                        click: doEditor,
                        accelerator: "CmdOrCtrl+Shift+V"
                    });
                if (p.editor.supports('cut') || p.editor.supports('copy') || p.editor.supports('paste'))
                    temp.push({ type: 'separator' });
                temp.push({
                    label: 'Select all',
                    click: () => {
                        if (manager.active && manager.active.editor)
                            manager.active.editor.selectAll();
                    }
                });
                if (p.editor.changed) {
                    temp.push({ type: 'separator' });
                    temp.push({
                        label: 'Revert',
                        click: () => { revertFile(); }
                    });
                }
                if (p.editor.supports('find') || p.editor.supports('replace'))
                    temp.push({ type: 'separator' });
                if (p.editor.supports('find'))
                    temp.push({
                        label: 'Find',
                        click: doFind
                    });
                if (p.editor.supports('replace'))
                    temp.push({
                        label: 'Replace',
                        click: doReplace
                    });

                if (p.editor.supports('menu|context')) {
                    temp.push({ type: 'separator' });
                    temp = temp.concat(p.editor.menu('context'));
                }
                let inputMenu = Menu.buildFromTemplate(temp);
                inputMenu.popup({ window: remote.getCurrentWindow() });
            });
            p.editor.on('error', (e, type) => {
                //logOutput(manager.active.editor.filename+': Indenting complete');
            });
            p.editor.on('progress-start', (type) => {
                if (type === 'indent')
                    logOutput(manager.active.editor.filename + ': Indenting started');
                else if (type === 'format')
                    logOutput(manager.active.editor.filename + ': Formatting started');
            });
            //p.editor.on('progress', (p, type) => {});
            p.editor.on('progress-complete', (type) => {
                if (type === 'indent')
                    logOutput(manager.active.editor.filename + ': Indenting finished');
                else if (type === 'format')
                    logOutput(manager.active.editor.filename + ': Formatting finished');
            });
            p.editor.on('output', (msg) => {
                logOutput(msg, true);
            });
            p.editor.on('location-changed', (x, y) => {
                if (p !== manager.active) return;
                if (p.editor.type == 1)
                    sbLocation.textContent = `Ln ${y}, Col ${x}`;
                else if (y != -1 && x != -1)
                    sbLocation.textContent = `${x}, ${y}`;
                else
                    sbLocation.textContent = '';
            });
            p.editor.on('status-message', (msg) => {
                if (p !== manager.active) return;
                sbMessage.textContent = msg;
            });
            p.editor.on('option-changed', (option, value) => {
                if (_loading) return;
                if (p.editor.type === 2) {
                    options.virtualOptions[option] = value;
                    saveOptions();
                }
            });
            p.editor.on('open-file', (file) => {
                if (existsSync(file))
                    openFile(file);
            });
            p.editor.on('new-file', (file, value) => {
                newFromValue(value, file);
            });
            _editors[data.file] = p;
            p.spellCheck = options.spellCheck;
            _loading--;
        }
        if (add) {
            manager.addPanels([p], dock);
            doUpdate(1);
            p.editor.focus();
        }
        return p;
    }

    function doUpdate(type) {
        if (!type) return;
        _updating |= type;
        if (_updating === 0)
            return;
        window.requestAnimationFrame(() => {
            if ((_updating & 1) === 1) {
                updateUI();
                _updating &= ~1;
            }
            if ((_updating & 2) === 2) {
                updateUIChange();
                _updating &= ~2;
            }
            if ((_updating & 4) === 4) {
                buildRecent();
                _updating &= ~4;
            }
            if ((_updating & 8) === 8) {
                flushRecent();
                _updating &= ~8;
            }
            if ((_updating & 16) === 16) {
                saveOptions();
                _updating &= ~16;
            }
            doUpdate(_updating);
        });
    }
</script>

</html>
<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>Code Editor</title>
    <link rel="shortcut icon" href="../assets/icons/png/ied.png" />
    <link href="css/cm.css" rel="stylesheet" type="text/css" />
    <link href="css/code.editor.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-select.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-treeview.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/form.css" rel="stylesheet" type="text/css" />
    <link href="../lib/datatables.min.css" rel="stylesheet" type="text/css" />
    <script>
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="../lib/jquery.min.js" type="text/javascript"></script>
    <script src="../lib/bootstrap.min.js" type="text/javascript"></script>
    <script src="../lib/bootstrap-select.min.js" type="text/javascript"></script>
    <script src="../lib/datatables.min.js" type="text/javascript"></script>
    <script src="../lib/datatables.scrollresize.js" type="text/javascript"></script>
    <script src="../lib/bootstrap-treeview.min.js"></script>
    <script src="../lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="../lib/ace/ext-statusbar.js" type="text/javascript"></script>
    <script src="../lib/ace/ext-language_tools.js" type="text/javascript"></script>
    <script src="../lib/ace/ext-settings_menu.js" type="text/javascript"></script>
    <script src="../lib/ace/ext-themelist.js" type="text/javascript"></script>
    <script src="../lib/ace/ext-modelist.js" type="text/javascript"></script>
    <script src="../lib/ace/ext-spellcheck.js"></script>
</head>

<body>
    <div id="toolbar" class="btn-toolbar" role="toolbar">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default btn-xs" title="New File" onclick="newFile()">
                <i class="fa fa-plus"></i>
            </button>
            <button id="btn-add-dropdown" type="button" class="btn btn-default btn-xs" title="New...">
                <span class="caret"></span>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-open" type="button" class="btn btn-default btn-xs" title="Open..." onclick="openFile()">
                <i class="fa fa-folder-open-o"></i>
            </button>
            <button id="btn-close" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Close" onclick="closeFile()">
                <i class="fa fa-times"></i>
            </button>
            <button id="btn-close-all" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Close All" onclick="closeAllFiles()">
                <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                    <i class="fa fa-times fa-stack-2x" style="font-size: 1em;margin-top: -1px;margin-left: 1px;"></i>
                    <i class="fa fa-times fa-stack-2x" style="font-size: 1em;margin-top: 1px;margin-left: -1px;"></i>
                </span>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-save" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Save" onclick="saveFile()">
                <i class="fa fa-save"></i>
            </button>
            <button id="btn-save-all" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Save All" onclick="saveAllFiles()">
                <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                    <i class="fa fa-save fa-stack-2x" style="font-size: 1em;margin-top: -2px;margin-left: 2px;"></i>
                    <i class="fa fa-save fa-stack-2x" style="font-size: 1em;margin-top: 2px;margin-left: -2px;"></i>
                </span>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-undo" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Undo" onclick="doUndo()">
                <i class="fa fa-undo"></i>
            </button>
            <button id="btn-redo" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Redo" onclick="doRedo()">
                <i class="fa fa-repeat"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-cut" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Cut" onclick="doCut()">
                <i class="fa fa-cut"></i>
            </button>
            <button id="btn-copy" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Copy" onclick="doCopy()">
                <i class="fa fa-copy"></i>
            </button>
            <button id="btn-paste" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Paste" onclick="doPaste()">
                <i class="fa fa-paste"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-find" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Find" onclick="doFind()">
                <i class="fa fa-search"></i>
            </button>
            <button id="btn-replace" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Replace" onclick="doReplace()">
                <i class="fa fa-exchange"></i>
            </button>
        </div>
        <button id="btn-refresh" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Refresh" onclick="doRefresh()">
            <i class="fa fa-refresh"></i>
        </button>
        <div id="editor-buttons"></div>
    </div>
</body>
<script>
    const { remote, ipcRenderer, webFrame } = require('electron');
    const { DockManager } = require('./js/dockmanager');
    const { CodeEditor, VirtualEditor } = require('./js/code.editor');

    const { dialog, Menu, MenuItem } = remote;
    const { Menubar } = require('./js/menubar');
    const { parseTemplate, capitalize } = require('./js/library');
    const { Settings } = require('./js/settings');

    const chokidar = require('chokidar');
    const path = require('path');
    const fs = require('fs');

    var spellchecker, menubar;
    var options, _updating = 0;
    var _loading = 1;
    var _open;
    var newCounter = 1;
    let closeWindow = false;
    var watcher;
    var _watched = {};

    webFrame.setSpellCheckProvider("en-US", true, {
        spellCheck: function (text) {
            if (!spellchecker || !options.spellchecking)
                return true;
            return !(spellchecker.isMisspelled(text));
        }
    });

    var menuTemplates = loadTemplates(parseTemplate(path.join('{assets}', 'templates')), '');
    var subMenus = {
        'edit': [
            {
                label: '&Undo',
                accelerator: "CmdOrCtrl+Z",
                click: doUndo,
                enabled: false,
            },
            {
                label: '&Redo',
                accelerator: "CmdOrCtrl+Y",
                click: doRedo,
                enabled: false,
            },
            { type: 'separator' },
            {
                label: 'Cu&t',
                accelerator: "CmdOrCtrl+X",
                click: doCut,
                enabled: false,
            },
            {
                label: '&Copy',
                accelerator: "CmdOrCtrl+C",
                click: doCopy,
                enabled: false,
            },
            {
                label: '&Paste',
                accelerator: "CmdOrCtrl+V",
                click: doPaste,
                enabled: false,
            },
            { type: 'separator' },
            {
                label: '&Select All',
                accelerator: "CmdOrCtrl+A",
                enabled: false,
                click: () => {
                    if (manager.active && manager.active.editor)
                        manager.active.editor.selectAll();
                }
            },
            { type: 'separator' },
            {
                label: '&Find',
                accelerator: "CmdOrCtrl+F",
                enabled: false,
                click: doFind
            },
            {
                label: '&Replace',
                accelerator: "CmdOrCtrl+H",
                enabled: false,
                click: doReplace
            },
        ],
        'view': [
            {
                label: '&Refresh',
                accelerator: "F5",
                enabled: false,
                click: doRefresh
            },
            { type: 'separator' },
            {
                role: 'toggledevtools'
            },
            {
                type: 'separator'
            },
            {
                role: 'resetzoom'
            },
            {
                role: 'zoomin'
            },
            {
                role: 'zoomout'
            },
        ]
    };
    menubar = new Menubar([
        {
            label: '&File',
            id: 'file',
            submenu: [
                {
                    label: '&New',
                    submenu: [
                        {
                            label: '&File',
                            accelerator: "CmdOrCtrl+N",
                            click: () => { newFile(); }
                        },
                        { type: 'separator' },
                        {
                            label: '&Area...',
                            //accelerator: "CmdOrCtrl+N",
                            click: () => { }
                        },
                        {
                            label: '&Virtual Area...',
                            //accelerator: "CmdOrCtrl+N",
                            click: () => { }
                        },
                        { type: 'separator' },
                        {
                            label: '&Room...',
                            //accelerator: "CmdOrCtrl+N",
                            click: () => { }
                        },
                        {
                            label: '&Monster...',
                            //accelerator: "CmdOrCtrl+N",
                            click: () => { }
                        },
                        { type: 'separator' },
                        {
                            label: '&Templates',
                            submenu: menuTemplates
                        }
                    ]
                },
                {
                    label: '&Open',
                    accelerator: "CmdOrCtrl+O",
                    click: () => { openFile(); }
                },
                {
                    label: 'Open &Recent',
                    submenu: [],
                },
                { type: 'separator' },
                {
                    label: '&Save',
                    accelerator: "CmdOrCtrl+S",
                    click: () => { saveFile(); },
                    enabled: false
                },
                {
                    label: 'Save A&ll',
                    accelerator: "CmdOrCtrl+Alt+S",
                    click: () => { saveAllFiles(); },
                    enabled: false
                },
                {
                    label: 'Save &As',
                    accelerator: "CmdOrCtrl+Shift+S",
                    click: () => { saveFileAs(); },
                    enabled: false,
                },
                { type: 'separator' },
                {
                    label: '&Preferences...',
                    accelerator: "CmdOrCtrl+Comma",
                    click: () => {
                        window.open('code.editor.prefs.html', 'modal', 'backgroundColor=#fff,height=300,width=600,icon=' + path.join(__dirname, '../assets/icons/png/preferences.png'));
                    }
                },
                { type: 'separator' },
                {
                    label: 'Revert',
                    click: () => { revertFile(); },
                    enabled: false
                },
                {
                    label: 'Revert All',
                    click: () => { revertAllFiles(); },
                    enabled: false
                },
                { type: 'separator' },
                {
                    label: '&Close',
                    click: () => { closeFile(); },
                    enabled: false
                },
                {
                    label: 'C&lose All',
                    click: () => { closeAllFiles(); },
                    enabled: false
                },
                { type: 'separator' },
                {
                    label: 'E&xit',
                    click: () => { window.close(); }
                }
            ]
        },
        {
            label: '&Edit',
            submenu: subMenus['edit']
        },
        {
            label: '&View',
            submenu: subMenus['view']
        },
    ]);

    var manager = new DockManager();
    manager.hideTabstrip = false;
    manager.on('add', (e) => {
    });
    manager.on('remove', (e) => {
        if (e.panel.editor.changed || e.panel.editor.new) {
            e.cancel = !confirmSave(e.panel);
        }
    });
    manager.on('removed', (e) => {
        e.panel.editor.close();
        doUpdate(1);
    });
    manager.on('activated', (e) => {
        if (e.panel.editor)
            e.panel.editor.focus();
        doUpdate(1);
    });
    manager.on('deactivated', (e) => {
    });

    function updatePanel(panel) {
        if (panel.editor.new)
            panel.tab.classList.add('new');
        else if (panel.editor.changed)
            panel.tab.classList.add('changed');
        else
            panel.tab.classList.remove('changed');
    }

    function updateUI() {
        var enabled = (manager.active && manager.active.editor) ? true : false;
        if (enabled)
            document.title = 'Code Editor - ' + manager.active.tab.title.innerText;
        else
            document.title = 'Code Editor';
        $("#btn-close").prop('disabled', !enabled);
        $("#btn-close-all").prop('disabled', !enabled);
        menubar.updateItem('File|Close', { enabled: enabled });
        menubar.updateItem('File|Close all', { enabled: enabled });
        menubar.updateItem('File|save as', { enabled: enabled });
        var buttons = $("#editor-buttons");
        buttons.empty();
        if (enabled && manager.active.editor.supports('buttons'))
            buttons.append(manager.active.editor.buttons);
        updateMenu('edit');
        updateMenu('view');
        doUpdate(2);
    }

    function updateMenu(menu) {
        var items = subMenus[menu].slice();
        if (manager.active && manager.active.editor && manager.active.editor.supports('menu|') + menu) {
            var cItems = manager.active.editor.menu(menu);
            if (cItems && cItems.length) {
                items.push({ type: 'separator' });
                items = items.concat(cItems);
            }
        }
        menubar.updateItem(menu, { submenu: items });
    }

    function updateUIChange() {
        var changed = (manager.active && manager.active.editor) ? (manager.active.editor.changed || manager.active.editor.new) : false;
        var changedAll = false;
        var revertAll = false;
        for (var p = 0, l = manager.panels.length; p < l; p++) {
            //no editor or of not changed and new try next
            if (!manager.panels[p].editor || (!manager.panels[p].editor.changed && !manager.panels[p].editor.new))
                continue;
            changedAll = true;
            if (manager.panels[p].editor.changed && !manager.panels[p].editor.new)
                revertAll = true;
            if (revertAll && changedAll)
                break; //do not need to check all as soon as one has been found
        }
        $("#btn-save").prop('disabled', !changed);
        menubar.updateItem('file|save', { enabled: changed });
        $("#btn-save-all").prop('disabled', !changedAll);
        menubar.updateItem('file|save all', { enabled: changedAll });

        menubar.updateItem('file|revert', { enabled: (manager.active && manager.active.editor) ? (manager.active.editor.changed && !manager.active.editor.new) : false });
        menubar.updateItem('file|revert all', { enabled: revertAll });

        $("#btn-undo").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('undo') : true);
        menubar.updateItem('edit|undo', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('undo') : false });
        $("#btn-redo").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('redo') : true);
        menubar.updateItem('edit|redo', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('redo') : false });

        $("#btn-cut").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('cut') : true);
        menubar.updateItem('edit|cut', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('cut') : false });
        $("#btn-copy").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('copy') : true);
        menubar.updateItem('edit|copy', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('copy') : false });
        $("#btn-paste").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('paste') : true);
        menubar.updateItem('edit|paste', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('paste') : false });
        $("#btn-find").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('find') : true);
        menubar.updateItem('edit|find', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('find') : false });
        $("#btn-replace").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('replace') : true);
        menubar.updateItem('edit|replace', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('replace') : false });
        $("#btn-refresh").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('refresh') : true);
        menubar.updateItem('view|refresh', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('refresh') : false });
    }

    // List all files in a directory in Node.js recursively in a synchronous fashion
    var walkSync = function (dir, fileList, dirList, empty) {
        var path = path || require('path');
        var fs = fs || require('fs'),
            files = fs.readdirSync(dir);
        fileList = fileList || [];
        dirList = dirList || [];
        empty = empty || [];
        if (files.length == 0)
            empty.push(dir);
        files.forEach(function (file) {
            if (fs.statSync(path.join(dir, file)).isDirectory()) {
                dirList.push(path.join(dir, file));
                var t = walkSync(path.join(dir, file), fileList, dirList, empty);
                fileList = t.files;
                dirList = t.dirs;
                empty = t.empty;
            }
            else {
                fileList.push(path.join(dir, file));
            }
        });
        return { files: fileList, dirs: dirList, empty: empty };
    };

    var walk = function (dir, callback) {
        var path = path || require('path');
        var fs = fs || require('fs');
        fs.readdir(dir, (err, files) => {
            var fileList = [];
            var dirList = [];
            var empty = [];
            if (files.length == 0)
                empty.push(dir);
            files.forEach(function (file) {
                if (fs.statSync(path.join(dir, file)).isDirectory()) {
                    dirList.push(path.join(dir, file));
                    var t = walkSync(path.join(dir, file), fileList, dirList, empty);
                    fileList = t.files;
                    dirList = t.dirs;
                    empty = t.empty;
                }
                else {
                    fileList.push(path.join(dir, file));
                }
            });
            if (callback)
                callback(fileList, dirList, empty);

        });
    };

    function createWatcher() {
        if (watcher)
            watcher.close();
        watcher = chokidar.watch('', {
            persistent: true,
            depth: 0,
            ignoreInitial: true
        });

        // Something to use when events are received.
        var log = console.log.bind(console);
        var ready = false;
        watcher
            .on('error', error => {
                log(`Watcher error: ${error}`);
            })
            .on('ready', () => {
                log('Initial scan complete. Ready for changes');
                ready = true;
            })
            .on('add', (file, stats) => {
                log(`File ${file} has been added`);
                for (var p = 0, l = manager.panels.length; p < l; p++)
                    manager.panels[p].editor.watch('add', file, stats);
            })
            .on('change', (file, stats) => {
                log(`File ${file} has been changed`);
                for (var p = 0, l = manager.panels.length; p < l; p++)
                    manager.panels[p].editor.watch('change', file, stats);
            })
            .on('unlink', file => {
                log(`File ${file} has been removed`);
                for (var p = 0, l = manager.panels.length; p < l; p++)
                    manager.panels[p].editor.watch('unlink', file);
            })
            .on('raw', (event, file, details) => {
                log('Raw event info:', event, file, details);
                for (var p = 0, l = manager.panels.length; p < l; p++)
                    manager.panels[p].editor.watch('raw', file, details);
            });
    }

    function closing() {
        if (watcher)
            watcher.close();
    }

    function loadOptions(data) {
        if (!data) {
            var set = Settings.load(remote.getGlobal('settingsFile'));
            options = set.extensions["code-editor"];
        }
        else
            options = data;
        if (!options) {
            options = {
                spellchecking: true,
                recent: [],
                opened: [],
                maxRecent: 15,
                reopen: true,
                options: {
                    persistent: false,
                    alwaysOnTopClient: true,
                    alwaysOnTop: false
                }
            };
            saveOptions();
        }
        try {
            //if (!spellchecker && options.spellchecking)
            //spellchecker = require('spellchecker');
        }
        catch (ex) {
            ipcRenderer.send('error', ex);
        }
    }

    function saveOptions() {
        ipcRenderer.send('setting-changed', { type: 'extensions', name: 'code-editor', value: options });
    }

    function getFileIcon(file) {
        switch (path.extname(file)) {
            case ".pdf":
                return 'fa fa-file-pdf-o';
            case ".xls":
            case ".xlt":
            case ".xlm":
            case ".xlsx":
            case ".xlsm":
            case ".xltx":
            case ".xltm":
                return 'fa fa-file-excel-o';
            case ".doc":
            case ".dot":
            case ".wbk":
            case ".docx":
            case ".docm":
            case ".dotx":
            case ".dotm":
            case ".docb":
                return 'fa fa-file-word-o';
            case ".ppt":
            case ".pot":
            case ".pps":
            case ".pptx":
            case ".pptm":
            case ".potx":
            case ".potm":
            case ".ppam":
            case ".ppsx":
            case ".ppsm":
            case ".sldx":
            case ".sldm":
                return 'fa fa-file-powerpoint-o';
            case ".png":
            case ".gif":
            case ".jpg":
            case ".ico":
            case ".svg":
            case ".webp":
                return 'fa fa-file-image-o';
            case ".m4a":
            case ".wav":
            case ".mp3":
            case ".flac":
                return 'fa fa-file-audio-o';
            case ".avi":
            case ".mpg":
            case ".mov":
            case ".webm":
            case ".oog":
            case ".mkv":
                return 'fa fa-file-video-o';
            case ".7z":
            case ".zip":
            case ".rar":
            case ".jar":
                return 'fa fa-file-archive-o';
            case ".txt":
                return 'fa fa-file-text-o';
            case ".o":
            case ".csv":
                return 'fa fa-file-o icon-o';
            case ".h":
                return 'fa fa-file-code-o icon-h';
            case ".c":
                return 'fa fa-file-code-o icon-c';
            case ".map":
                return 'fa fa-map-o';
        }
        return 'fa fa-file-o';
    }

    function childClosed(url, name) {
    }

    function clearButton(id) {
        $(id).removeClass('open');
        $(id).blur();
    }

    function doCut() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('cut'))
            manager.active.editor.cut();
    }

    function doCopy() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('copy'))
            manager.active.editor.copy();
    }

    function doPaste() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('paste'))
            manager.active.editor.paste();
    }

    function doRedo() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('redo'))
            manager.active.editor.redo();
    }

    function doUndo() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('undo'))
            manager.active.editor.undo();
    }

    function doFind() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('find'))
            manager.active.editor.find();
    }

    function doReplace() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('replace'))
            manager.active.editor.replace();
    }

    function doRefresh() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('refresh'))
            manager.active.editor.refresh();
    }

    $(document).ready(() => {
        loadOptions();

        $(document).keydown((event) => {

        });
        $('#btn-add-dropdown').click(function () {
            $(this).addClass('open');
            const pos = $(this).offset();
            const x = Math.floor(pos.left);
            const y = Math.floor(pos.top + $(this).outerHeight() + 2);
            const addMenu = new Menu();
            addMenu.append(new MenuItem({
                label: 'New file', click() {
                    clearButton('#btn-add-dropdown');
                    newFile();
                }
            }));
            addMenu.append(new MenuItem({ type: 'separator' }));
            addMenu.append(new MenuItem({
                label: 'New area...', click() {
                    clearButton('#btn-add-dropdown');

                }
            }));
            addMenu.append(new MenuItem({
                label: 'New virtual area...', click() {
                    clearButton('#btn-add-dropdown');

                }
            }));
            addMenu.append(new MenuItem({ type: 'separator' }));
            addMenu.append(new MenuItem({
                label: 'New room...', click() {
                    clearButton('#btn-add-dropdown');

                }
            }));
            addMenu.append(new MenuItem({
                label: 'New monster...', click() {
                    clearButton('#btn-add-dropdown');

                }
            }));
            addMenu.append(new MenuItem({ type: 'separator' }));
            addMenu.append(new MenuItem({
                label: 'Templates',
                submenu: menuTemplates
            }));
            addMenu.popup(remote.getCurrentWindow(), { x: x, y: y });
        });
        createWatcher();
        var o, ol;
        if (options.opened && options.reopen) {
            for (o = 0, ol = options.opened.length; o < ol; o++)
                openFile(options.opened[o].file, options.opened.remote);
        }
        if (_open) {
            for (o = 0, ol = _open.length; o < ol; o++)
                openFile(_open[o][0], _open[o][1]);
            _open = 0;
        }
        if (!(options.opened && !options.reopen) && !_open)
            doUpdate(4);
        _loading = 0;
    });

    window.onbeforeunload = function (evt) {
        if (!closeWindow) {
            evt.returnValue = false;
            setTimeout(() => {
                var p, l = manager.panels.length;
                var opened = [];
                //check if need to save
                for (p = 0; p < l; p++) {
                    if (!manager.panels[p].editor.new)
                        opened.push({
                            file: manager.panels[p].editor.file,
                            remote: manager.panels[p].remote
                        });
                    if (!manager.panels[p].editor.new && !manager.panels[p].editor.changed)
                        continue;
                    if (!confirmSave(manager.panels[p]))
                        return 'no';
                }
                if (!options) loadOptions();
                if (options.reopen) {
                    options.opened = opened;
                    saveOptions();
                }
                //clean up
                for (p = 0; p < l; p++)
                    manager.panels[p].editor.close();
                if (watcher)
                    watcher.close();
                closeWindow = true;
                remote.getCurrentWindow().close();
            });
            return 'no';
        }
        if (watcher)
            watcher.close();
        closeWindow = true;
        remote.getCurrentWindow().close();
        return;
    };

    ipcRenderer.on('open-editor', (event, file, remoteFile) => {
        if (_loading) {
            if (!_open)
                _open = [];
            _open.push([file, remoteFile]);
        }
        else
            openFile(file, remoteFile);
    });

    ipcRenderer.on('GMCP-received', (event, data) => {
        if (options && options.debug)
            console.log(data);
        //if (_ied)
        //_ied.processGMCP(data.mod, data.obj);
    });

    ipcRenderer.on('reload-options', (event) => {
        loadOptions();
    });

    ipcRenderer.on('setting-changed', (event, data) => {
        if (data.type === "extensions" && data.name === "code-editor") {
            loadOptions(data.value);
        }
    });

    function newFile() {
        var editor = createEditor('new ' + newCounter + '.c');
        editor.new = true;
        newCounter++;
        doUpdate(1);
        updatePanel(manager.active);
    }

    function openFile(file, remoteFile) {
        if (!file || file.length === 0) {
            dialog.showOpenDialog(remote.getCurrentWindow(),
                {
                    filters: [
                        { name: 'Code files (*.c, *.h)', extensions: ['c', 'h'] },
                        { name: 'Data files (*.o, *.cfg)', extensions: ['o', 'cfg'] },
                        { name: 'Text files (*.txt)', extensions: ['txt'] },
                        { name: 'Map files (*.map)', extensions: ['map'] },
                        { name: 'All files (*.*)', extensions: ['*'] },
                    ],
                    properties: ['multiSelections', 'openFile'],
                    defaultPath: (manager.active && manager.active.editor) ? path.dirname(manager.active.editor.file) : (options.recent && options.recent.length ? path.dirname(options.recent[0].file) : '')
                },
                function (fileNames) {
                    if (fileNames === undefined) {
                        return;
                    }
                    for (var f = 0, fl = fileNames.length; f < fl; f++) {
                        addToRecent(fileNames[f]);
                        createEditor(fileNames[f], true);
                    }
                });
        }
        else {
            addToRecent(file, remoteFile);
            createEditor(file, true, remoteFile);
        }
    }

    function addToRecent(file, remoteFile) {
        if (!options) loadOptions();
        if (!options.recent) options.recent = [];
        var recent = [{ file: file, remote: remoteFile }];
        for (var r = 0, rl = options.recent.length; r < rl; r++) {
            if (options.recent[r].file !== file)
                recent.push(options.recent[r]);
        }
        if (recent.length > options.maxRecent)
            options.recent = recent.slice(0, options.maxRecent);
        else
            options.recent = recent;
        saveOptions();
        doUpdate(4);
    }

    function buildRecent() {
        var menu = [];
        for (var r = 0, rl = options.recent.length; r < rl; r++) {
            menu.push(
                {
                    label: options.recent[r].file,
                    idx: r,
                    click: (item) => {
                        openFile(options.recent[item.idx].file, options.recent[item.idx].remote);
                    }
                }
            );
            if (r < 10)
                menu[r].accelerator = 'CmdOrCtrl+' + (r + 1);
        }
        if (menu.length > 0) {
            menu.push({ type: 'separator' });
            menu.push({
                label: 'Clear Recently Opened',
                click: () => {
                    options.recent = [];
                    saveOptions();
                    doUpdate(4);
                }
            });
        }
        menubar.updateItem('file|open recent', { submenu: menu });
    }

    function saveFile(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        if (panel.editor.new)
            return saveFileAs(panel);
        panel.editor.save();
        return true;
    }

    function saveAllFiles() {
        for (var p = 0, l = manager.panels.length; p < l; p++) {
            //not changed and new try next
            if (!manager.panels[p].editor.new && !manager.panels[p].editor.changed)
                continue;
            if (!saveFile(manager.panels[p]))
                return false;
        }
        return true;
    }

    function saveFileAs(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        var file = dialog.showSaveDialog(remote.getCurrentWindow(), {
            title: 'Save as...',
            defaultPath: panel.editor.file,
            filters: [
                { name: 'Code files (*.c, *.h)', extensions: ['c', 'h'] },
                { name: 'Data files (*.o, *.cfg)', extensions: ['o', 'cfg'] },
                { name: 'Text files (*.txt)', extensions: ['txt'] },
                { name: 'Map files (*.map)', extensions: ['map'] },
                { name: 'All files (*.*)', extensions: ['*'] },
            ]
        });
        if (file === undefined)
            return false;
        panel.editor.file = file;
        manager.setPanelTooltip(panel.editor.file, panel);
        manager.setPanelTitle(panel.editor.filename, panel);
        panel.editor.save();
        return true;
    }

    function revertFile(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        if (panel.editor.changed && !panel.editor.new) {
            var choice = dialog.showMessageBox(
                remote.getCurrentWindow(),
                {
                    type: 'question',
                    title: 'Revert file?',
                    message: 'Revert ' + panel.editor.filename + ' and lose changes?',
                    buttons: ['Yes', 'No'],
                    defaultId: 1
                });
            if (choice === 0)
                panel.editor.revert();
        }
    }

    function revertAllFiles() {
        for (var p = 0, l = manager.panels.length; p < l; p++) {
            //not changed and new try next
            if (!manager.panels[p].editor.new && !manager.panels[p].editor.changed)
                continue;
            if (!revertFile(manager.panels[p]))
                return false;
        }
        return true;
    }

    function closeFile(panel) {
        if (!panel) {
            if (!manager.active)
                return;
            panel = manager.active;
        }
        if (panel)
            manager.removePanel(panel);
    }

    function closeAllFiles() {
        manager.removeAllPanels();
    }

    function confirmSave(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        var choice = dialog.showMessageBox(
            remote.getCurrentWindow(),
            {
                type: 'question',
                title: panel.editor.new ? 'Save file?' : 'Save changes?',
                message: panel.editor.new ? ('Save ' + panel.editor.filename + '?') : ('Save changes to ' + panel.editor.filename + '?'),
                buttons: ['Yes', 'No', 'Cancel'],
                defaultId: 1
            });
        //canceled
        if (choice === 2)
            return false;
        //no
        if (choice === 1)
            return true;
        //attempt to save
        return saveFile(panel);
    }

    function sortFiles(a, b, p) {
        if (fs.lstatSync(path.join(p, a)).isDirectory())
            return -1;
        if (fs.lstatSync(path.join(p, b)).isDirectory())
            return 1;
        return a.localeCompare(b);
    }

    function loadTemplates(p, root) {
        const menu = [];
        const files = fs.readdirSync(p);
        files.sort((a, b) => { return sortFiles(a, b, p); });
        const fl = files.length;
        var base = false;
        for (let f = 0; f < fl; f++) {
            if (fs.lstatSync(path.join(p, files[f])).isDirectory()) {
                menu.push({
                    label: capitalize(path.basename(files[f], path.extname(files[f])).replace(/_/g, ' ')),
                    submenu: loadTemplates(path.join(p, files[f]), path.join(root, files[f]))
                });
            }
            else {
                if (files[f] === 'base.c') {
                    base = true;
                    continue;
                }
                menu.push({
                    label: capitalize(path.basename(files[f], path.extname(files[f])).replace(/_/g, ' ')),
                    path: path.join(root, files[f]),
                    click: (item) => {
                    }
                });
            }
        }
        if (base) {
            if (menu.length > 0)
                menu.unshift({ type: 'separator' });
            menu.unshift(
                {
                    label: 'base',
                    path: path.join(root, 'base.c'),
                    click: (item) => {
                    }
                }
            );
        }
        return menu;
    }

    function findEditor(file) {
        if (!file || file.length === 0)
            return 0;
        for (var p = 0, l = manager.panels.length; p < l; p++) {
            if (manager.panels[p].editor.file === file)
                return manager.panels[p];
        }
        return 0;
    }

    function createEditor(file, open, remoteFile, value) {
        var p = findEditor(file);
        if (p) {
            p.editor.remote = remoteFile;
            manager.switchToPanel(p);
        }
        else {
            p = manager.addPanel(path.basename(file), getFileIcon(file), file);
            //if (path.extname(file) === '.map')
            //p.editor = new VirtualEditor({ file: file, container: p.pane, open: open, value: value });
            //else
            p.editor = new CodeEditor({ file: file, container: p.pane, open: open, value: value });
            if (!_watched[file]) {
                _watched[file] = 1;
                watcher.add(file);
            }
            else
                _watched[file]++;
            p.editor.remote = remoteFile;
            p.editor.on('watch', (files) => {
                if (!files) return;
                for (var f = 0, fl = files.length; f < fl; f++) {
                    if (!_watched[files[f]]) {
                        _watched[files[f]] = 1;
                        watcher.add(files[f]);
                    }
                    else
                        _watched[files[f]]++;
                }
            });
            p.editor.on('watch-stop', (files) => {
                if (!files) return;
                for (var f = 0, fl = files.length; f < fl; f++) {
                    _watched[files[f]]--;
                    if (_watched[files[f]] === 0) {
                        watcher.unwatch(files[f]);
                        delete _watched[files[f]];
                    }
                }
            });
            p.editor.on('reload', (type) => {
                var choice;
                if (type === 'unlink') {
                    choice = dialog.showMessageBox(
                        remote.getCurrentWindow(),
                        {
                            type: 'question',
                            title: 'File deleted',
                            message: p.editor.filename + ' has been deleted, keep open?',
                            buttons: ['Yes', 'No'],
                            defaultId: 1
                        });
                    //no
                    if (choice === 1)
                        closeFile(p);
                    else
                        p.editor.changed = true;
                }
                else {
                    choice = dialog.showMessageBox(
                        remote.getCurrentWindow(),
                        {
                            type: 'question',
                            title: 'File changed',
                            message: (p.editor.filename + ' has been changed, reload?'),
                            buttons: ['Yes', 'No'],
                            defaultId: 1
                        });
                    //yes
                    if (choice === 0)
                        p.editor.revert();
                    //else
                    //p.editor.changed = true;
                }
            });
            p.editor.on('changed', () => {
                doUpdate(2);
                updatePanel(p);
            });

            p.editor.on('saved', () => {
                doUpdate(2);
                updatePanel(p);
            });
            p.editor.on('reverted', () => {
                doUpdate(2);
                updatePanel(p);
            });
            p.editor.on('selection-changed', () => {
                doUpdate(2);
            });
            p.editor.on('menu-update', (menu, options) => {
                menubar.updateItem(menu, options);
            });
            p.editor.on('contextmenu', (e, token) => {
                var temp = [];
                if (p.editor.supports('refresh')) {
                    temp.push({
                        label: 'Refresh',
                        click: doRefresh
                    });
                }
                if (p.editor.supports('undo'))
                    temp.push({
                        label: 'Undo',
                        click: doUndo
                    });
                if (p.editor.supports('redo'))
                    temp.push({
                        label: 'Redo',
                        click: doRedo
                    });
                if (p.editor.supports('undo') || p.editor.supports('redp'))
                    temp.push({ type: 'separator' });
                if (p.editor.supports('cut'))
                    temp.push({
                        label: 'Cut',
                        click: doCut
                    });
                if (p.editor.supports('copy'))
                    temp.push({
                        label: 'Copy',
                        click: doCopy
                    });
                if (p.editor.supports('paste'))
                    temp.push({
                        label: 'Paste',
                        click: doPaste
                    });
                if (p.editor.supports('cut') || p.editor.supports('copy') || p.editor.supports('paste'))
                    temp.push({ type: 'separator' });
                temp.push({
                    label: 'Select all',
                    click: () => {
                        if (manager.active && manager.active.editor)
                            manager.active.editor.selectAll();
                    }
                });
                if (p.editor.changed) {
                    temp.push({ type: 'separator' });
                    temp.push({
                        label: 'Revert',
                        click: () => { revertFile(); },
                        enabled: false
                    });
                }
                if (p.editor.supports('find') || p.editor.supports('replace'))
                    temp.push({ type: 'separator' });
                if (p.editor.supports('find'))
                    temp.push({
                        label: 'Find',
                        click: doFind
                    });
                if (p.editor.supports('replace'))
                    temp.push({
                        label: 'Replace',
                        click: doReplace
                    });

                if (p.editor.supports('menu|context')) {
                    temp.push({ type: 'separator' });
                    temp = temp.concat(p.editor.menu('context'));
                }
                let inputMenu = Menu.buildFromTemplate(temp);
                inputMenu.popup(remote.getCurrentWindow());
            });
            doUpdate(1);
        }
        p.spellCheck = options.spellCheck;
        p.editor.focus();
        return p.editor;
    }

    function doUpdate(type) {
        if (!type) return;
        _updating |= type;
        if (_updating === 0)
            return;
        window.requestAnimationFrame(() => {
            if ((this._updating & 1) === 1) {
                updateUI();
                _updating &= ~1;
            }
            if ((this._updating & 2) === 2) {
                updateUIChange();
                _updating &= ~2;
            }
            if ((this._updating & 4) === 4) {
                buildRecent();
                _updating &= ~4;
            }
            doUpdate(_updating);
        });
    }
</script>

</html>
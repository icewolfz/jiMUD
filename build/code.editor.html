<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>Code Editor</title>
    <link rel="shortcut icon" href="../assets/icons/png/ied.png" />
    <link href="css/cm.css" rel="stylesheet" type="text/css" />
    <link href="css/code.editor.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-select.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-treeview.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/form.css" rel="stylesheet" type="text/css" />
    <link href="../lib/datatables.min.css" rel="stylesheet" type="text/css" />
    <script>
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="../lib/jquery.min.js" type="text/javascript"></script>
    <script src="../lib/bootstrap.min.js" type="text/javascript"></script>
    <script src="../lib/bootstrap-select.min.js" type="text/javascript"></script>
    <script src="../lib/datatables.min.js" type="text/javascript"></script>
    <script src="../lib/datatables.scrollresize.js" type="text/javascript"></script>
    <script src="../lib/bootstrap-treeview.min.js"></script>
    <script src="../lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="../lib/ace/ext-statusbar.js" type="text/javascript"></script>
    <script src="../lib/ace/ext-language_tools.js" type="text/javascript"></script>
    <script src="../lib/ace/ext-settings_menu.js" type="text/javascript"></script>
    <script src="../lib/ace/ext-themelist.js" type="text/javascript"></script>
    <script src="../lib/ace/ext-modelist.js" type="text/javascript"></script>

</head>

<body>
    <div id="toolbar" class="btn-toolbar" role="toolbar">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default btn-xs" title="New File" onclick="newFile()">
                <i class="fa fa-plus"></i>
            </button>
            <button id="btn-add-dropdown" type="button" class="btn btn-default btn-xs" title="New...">
                <span class="caret"></span>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-open" type="button" class="btn btn-default btn-xs" title="Open File..." onclick="openFile()">
                <i class="fa fa-folder-open-o"></i>
            </button>
            <button id="btn-close" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Close File" onclick="closeFile()">
                <i class="fa fa-window-close-o"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-save" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Save File" onclick="saveFile()">
                <i class="fa fa-save"></i>
            </button>
            <button id="btn-save-all" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Save All Files" onclick="saveAllFiles()">
                <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                    <i class="fa fa-save fa-stack-2x" style="font-size: 1em;margin-top: -2px;margin-left: 2px;"></i>
                    <i class="fa fa-save fa-stack-2x" style="font-size: 1em;margin-top: 2px;margin-left: -2px;"></i>
                </span>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-undo" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Undo" onclick="doUndo()">
                <i class="fa fa-undo"></i>
            </button>
            <button id="btn-redo" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Redo" onclick="doRedo()">
                <i class="fa fa-repeat"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-cut" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Cut" onclick="doCut()">
                <i class="fa fa-cut"></i>
            </button>
            <button id="btn-copy" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Copy" onclick="doCopy()">
                <i class="fa fa-copy"></i>
            </button>
            <button id="btn-paste" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Paste" onclick="doPaste()">
                <i class="fa fa-paste"></i>
            </button>
        </div>
    </div>
</body>
<script>
    const { remote, ipcRenderer, shell, clipboard, webFrame } = require('electron');
    const { DockManager } = require('./js/dockmanager');
    const { CodeEditor, VirtualEditor } = require('./js/code.editor');

    const { app, dialog, Menu, MenuItem } = remote;
    const { Menubar } = require('./js/menubar');
    const { parseTemplate, existsSync } = require('./js/library');
    const { Settings } = require('./js/settings');

    const path = require('path');

    var spellchecker, menubar;
    var options, _updating = 0;
    var newCounter = 1;
    let closeWindow = false;

    webFrame.setSpellCheckProvider("en-US", true, {
        spellCheck: function (text) {
            if (!spellchecker || !options.spellchecking)
                return true;
            return !(spellchecker.isMisspelled(text));
        }
    });

    var menuTemplates = [];

    menubar = new Menubar([
        {
            label: '&File',
            id: 'file',
            submenu: [
                {
                    label: '&New',
                    submenu: [
                        {
                            label: '&File',
                            accelerator: "CmdOrCtrl+N",
                            click: () => { newFile(); }
                        },
                        { type: 'separator' },
                        {
                            label: '&Area...',
                            //accelerator: "CmdOrCtrl+N",
                            click: () => { }
                        },
                        {
                            label: '&Virtual Area...',
                            //accelerator: "CmdOrCtrl+N",
                            click: () => { }
                        },
                        { type: 'separator' },
                        {
                            label: '&Room...',
                            //accelerator: "CmdOrCtrl+N",
                            click: () => { }
                        },
                        {
                            label: '&Monster...',
                            //accelerator: "CmdOrCtrl+N",
                            click: () => { }
                        },
                        { type: 'separator' },
                        {
                            label: '&Templates',
                            submenu: menuTemplates
                        }
                    ]
                },
                {
                    label: '&Open',
                    accelerator: "CmdOrCtrl+O",
                    click: () => { openFile(); }
                },
                {
                    label: 'Open &Recent',
                    submenu: [],
                    visible: false
                },
                { type: 'separator' },
                {
                    label: '&Save',
                    accelerator: "CmdOrCtrl+S",
                    click: () => { saveFile(); },
                    enabled: false
                },
                {
                    label: 'Save A&ll',
                    accelerator: "CmdOrCtrl+Alt+S",
                    click: () => { saveAllFiles(); },
                    enabled: false
                },
                {
                    label: 'Save &As',
                    accelerator: "CmdOrCtrl+Shift+S",
                    click: () => { saveFileAs(); },
                },
                { type: 'separator' },
                {
                    label: '&Preferences...',
                    accelerator: "CmdOrCtrl+Comma",
                    click: () => {
                        window.open('code.editor.prefs.html', 'modal', 'backgroundColor=#fff,height=300,width=600,icon=' + path.join(__dirname, '../assets/icons/png/preferences.png'));
                    }
                },
                { type: 'separator' },
                {
                    label: 'Revert',
                    click: () => { },
                    enabled: false
                },
                {
                    label: 'Revert All',
                    click: () => { },
                    enabled: false
                },
                {
                    label: '&Close',
                    click: () => { closeFile(); },
                    enabled: false
                },
                { type: 'separator' },
                {
                    label: 'E&xit',
                    click: () => { window.close(); }
                }
            ]
        },
        {
            label: '&Edit',
            submenu: [
                {
                    label: '&Undo',
                    accelerator: "CmdOrCtrl+Z",
                    click: doUndo
                },
                {
                    label: '&Redo',
                    accelerator: "CmdOrCtrl+Y",
                    click: doRedo
                },
                { type: 'separator' },
                {
                    label: 'Cu&t',
                    accelerator: "CmdOrCtrl+X",
                    click: doCut
                },
                {
                    label: '&Copy',
                    accelerator: "CmdOrCtrl+C",
                    click: doCopy
                },
                {
                    label: '&Paste',
                    accelerator: "CmdOrCtrl+V",
                    click: doPaste
                },
                { type: 'separator' },
                {
                    label: '&Select All',
                    accelerator: "CmdOrCtrl+A",
                    click: () => {
                        if (manager.active && manager.active.editor)
                            manager.active.editor.selectAll();
                    }
                },
            ]
        },
        {
            label: '&View',
            submenu: [
                {
                    label: '&Refresh',
                    accelerator: "F5",
                    click: () => { }
                },
                { type: 'separator' },
                {
                    role: 'toggledevtools'
                },
                {
                    type: 'separator'
                },
                {
                    role: 'resetzoom'
                },
                {
                    role: 'zoomin'
                },
                {
                    role: 'zoomout'
                },
            ]
        },
    ]);

    var manager = new DockManager();
    manager.hideTabstrip = false;
    manager.on('add', (e) => {
    });
    manager.on('remove', (e) => {
        if (e.panel.editor.changed || e.panel.editor.new) {
            e.cancel = !confirmSave(e.panel);
        }
    });
    manager.on('removed', (e) => {
        doUpdate(1);
    });
    manager.on('activated', (e) => {
        doUpdate(1);
    });
    manager.on('deactivated', (e) => {
    });

    function updatePanel(panel) {
        if (panel.editor.new)
            panel.tab.classList.add('new');
        else if (panel.editor.changed)
            panel.tab.classList.add('changed');
        else
            panel.tab.classList.remove('changed');
    }

    function updateUI() {
        var enabled = (manager.active && manager.active.editor) ? true : false;
        if (enabled)
            document.title = 'Code Editor - ' + manager.active.tab.title.innerText;
        else
            document.title = 'Code Editor';
        $("#btn-close").prop('disabled', !enabled);
        menubar.updateItem('File|Revert file', { enabled: enabled });
        menubar.updateItem('File|Close', { enabled: enabled });
        doUpdate(2);
    }

    function updateUIChange() {
        var changed = (manager.active && manager.active.editor) ? (manager.active.editor.changed || manager.active.editor.new) : false;
        var changedAll = false;
        for (var p = 0, l = manager.panels.length; p < l; p++) {
            //no editor or of not changed and new try next
            if (!manager.panels[p].editor || (!manager.panels[p].editor.changed && !manager.panels[p].editor.new))
                continue;
            changedAll = true;
            break; //do not need to check all as soon as one has been found
        }
        $("#btn-save").prop('disabled', !changed);
        menubar.updateItem('file|save', { enabled: changed });
        $("#btn-save-all").prop('disabled', !changedAll);
        menubar.updateItem('file|save all', { enabled: changedAll });
        $("#btn-undo").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.hasUndo : true);
        menubar.updateItem('edit|undo', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.hasUndo : false });
        $("#btn-redo").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.hasRedo : true);
        menubar.updateItem('edit|redo', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.hasRedo : false });

        $("#btn-cut").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.canCut : true);
        menubar.updateItem('edit|cut', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.canCut : false });
        $("#btn-copy").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.canCopy : true);
        menubar.updateItem('edit|copy', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.canCopy : false });
        $("#btn-paste").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.canPaste : true);
        menubar.updateItem('edit|paste', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.canPaste : false });
    }

    // List all files in a directory in Node.js recursively in a synchronous fashion
    var walkSync = function (dir, fileList, dirList, empty) {
        var path = path || require('path');
        var fs = fs || require('fs'),
            files = fs.readdirSync(dir);
        fileList = fileList || [];
        dirList = dirList || [];
        empty = empty || [];
        if (files.length == 0)
            empty.push(dir);
        files.forEach(function (file) {
            if (fs.statSync(path.join(dir, file)).isDirectory()) {
                dirList.push(path.join(dir, file));
                var t = walkSync(path.join(dir, file), fileList, dirList, empty);
                fileList = t.files;
                dirList = t.dirs;
                empty = t.empty;
            }
            else {
                fileList.push(path.join(dir, file));
            }
        });
        return { files: fileList, dirs: dirList, empty: empty };
    };

    var walk = function (dir, callback) {
        var path = path || require('path');
        var fs = fs || require('fs');
        fs.readdir(dir, (err, files) => {
            var fileList = [];
            var dirList = [];
            var empty = [];
            if (files.length == 0)
                empty.push(dir);
            files.forEach(function (file) {
                if (fs.statSync(path.join(dir, file)).isDirectory()) {
                    dirList.push(path.join(dir, file));
                    var t = walkSync(path.join(dir, file), fileList, dirList, empty);
                    fileList = t.files;
                    dirList = t.dirs;
                    empty = t.empty;
                }
                else {
                    fileList.push(path.join(dir, file));
                }
            });
            if (callback)
                callback(fileList, dirList, empty);

        });
    };

    function loadOptions(data) {
        if (!data) {
            var set = Settings.load(remote.getGlobal('settingsFile'));
            options = set.extensions["code-editor"];
        }
        else
            options = data;
        if (!options) {
            options = {
                spellchecking: true
            };
            saveOptions();
        }
        try {
            if (!spellchecker && options.spellchecking)
                spellchecker = require('spellchecker');
        }
        catch (ex) {
            ipcRenderer.send('error', ex);
        }
    }

    function saveOptions() {
        ipcRenderer.send('setting-changed', { type: 'extensions', name: 'code-editor', value: options });
    }

    function getFileIcon(file) {
        switch (path.extname(file)) {
            case ".pdf":
                return 'fa fa-file-pdf-o';
            case ".xls":
            case ".xlt":
            case ".xlm":
            case ".xlsx":
            case ".xlsm":
            case ".xltx":
            case ".xltm":
                return 'fa fa-file-excel-o';
            case ".doc":
            case ".dot":
            case ".wbk":
            case ".docx":
            case ".docm":
            case ".dotx":
            case ".dotm":
            case ".docb":
                return 'fa fa-file-word-o';
            case ".ppt":
            case ".pot":
            case ".pps":
            case ".pptx":
            case ".pptm":
            case ".potx":
            case ".potm":
            case ".ppam":
            case ".ppsx":
            case ".ppsm":
            case ".sldx":
            case ".sldm":
                return 'fa fa-file-powerpoint-o';
            case ".png":
            case ".gif":
            case ".jpg":
            case ".ico":
            case ".svg":
            case ".webp":
                return 'fa fa-file-image-o';
            case ".m4a":
            case ".wav":
            case ".mp3":
            case ".flac":
                return 'fa fa-file-audio-o';
            case ".avi":
            case ".mpg":
            case ".mov":
            case ".webm":
            case ".oog":
            case ".mkv":
                return 'fa fa-file-video-o';
            case ".7z":
            case ".zip":
            case ".rar":
            case ".jar":
                return 'fa fa-file-archive-o';
            case ".txt":
                return 'fa fa-file-text-o';
            case ".o":
            case ".csv":
                return 'fa fa-file-o icon-o';
            case ".h":
                return 'fa fa-file-code-o icon-h';
            case ".c":
                return 'fa fa-file-code-o icon-c';
            case ".map":
                return 'fa fa-map-o';
        }
        return 'fa fa-file-o';
    }

    function clearButton(id) {
        $(id).removeClass('open');
        $(id).blur();
    }

    function doCut() {
        if (manager.active && manager.active.editor)
            manager.active.editor.cut();
    }

    function doCopy() {
        if (manager.active && manager.active.editor)
            manager.active.editor.copy();
    }

    function doPaste() {
        if (manager.active && manager.active.editor)
            manager.active.editor.paste();
    }

    function doRedo() {
        if (manager.active && manager.active.editor)
            manager.active.editor.redo();
    }

    function doUndo() {
        if (manager.active && manager.active.editor)
            manager.active.editor.undo();
    }


    $(document).ready(() => {
        loadOptions();

        $(document).keydown((event) => {

        });
        $('#btn-add-dropdown').click(function () {
            $(this).addClass('open');
            const pos = $(this).offset();
            const x = Math.floor(pos.left);
            const y = Math.floor(pos.top + $(this).outerHeight() + 2);
            const addMenu = new Menu();
            addMenu.append(new MenuItem({
                label: 'New file', click() {
                    clearButton('#btn-add-dropdown');

                }
            }));
            addMenu.append(new MenuItem({ type: 'separator' }));
            addMenu.append(new MenuItem({
                label: 'New area...', click() {
                    clearButton('#btn-add-dropdown');

                }
            }));
            addMenu.append(new MenuItem({
                label: 'New virtual area...', click() {
                    clearButton('#btn-add-dropdown');

                }
            }));
            addMenu.append(new MenuItem({ type: 'separator' }));
            addMenu.append(new MenuItem({
                label: 'New room...', click() {
                    clearButton('#btn-add-dropdown');

                }
            }));
            addMenu.append(new MenuItem({
                label: 'New monster...', click() {
                    clearButton('#btn-add-dropdown');

                }
            }));
            addMenu.append(new MenuItem({ type: 'separator' }));
            addMenu.append(new MenuItem({
                label: 'Templates',
                submenu: menuTemplates
            }));
            addMenu.popup(remote.getCurrentWindow(), { x: x, y: y });
        });

    });

    window.onbeforeunload = function (evt) {
        if (!closeWindow) {
            evt.returnValue = false;
            setTimeout(() => {
                for (var p = 0, l = manager.panels.length; p < l; p++) {
                    if (!manager.panels[p].editor.new && !manager.panels[p].editor.changed)
                        continue;
                    if (!confirmSave(manager.panels[p]))
                        return 'no';
                }
                closeWindow = true;
                remote.getCurrentWindow().close();
            });
            return 'no';
        }
        closeWindow = true;
        remote.getCurrentWindow().close();
        return;
    };


    ipcRenderer.on('GMCP-received', (event, data) => {
        if (options && options.debug)
            console.log(data);
        //if (_ied)
        //_ied.processGMCP(data.mod, data.obj);
    });

    ipcRenderer.on('reload-options', (event) => {
        loadOptions();
    });

    ipcRenderer.on('setting-changed', (event, data) => {
        if (data.type === "extensions" && data.name === "code-editor") {
            loadOptions(data.value);
        }
    });

    function newFile() {
        var editor = createEditor('new ' + newCounter + '.c');
        editor.new = true;
        newCounter++;
        doUpdate(1);
        updatePanel(manager.active);
    }

    function openFile(file) {
        if (!file || file.length === 0) {
            dialog.showOpenDialog(remote.getCurrentWindow(),
                {
                    filters: [
                        { name: 'Code files (*.c, *.h)', extensions: ['c', 'h'] },
                        { name: 'Data files (*.o, *.cfg)', extensions: ['o', 'cfg'] },
                        { name: 'Text files (*.txt)', extensions: ['txt'] },
                        { name: 'Map files (*.map)', extensions: ['map'] },
                        { name: 'All files (*.*)', extensions: ['*'] },
                    ],
                    properties: ['multiSelections', 'openFile']
                },
                function (fileNames) {
                    if (fileNames === undefined) {
                        return;
                    }
                    for (var f = 0, fl = fileNames.length; f < fl; f++)
                        createEditor(fileNames[f], true);
                });
        }
        else
            createEditor(file, true);
    }

    function saveFile(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        if (panel.editor.new)
            return saveFileAs(panel);
        panel.editor.save();
        return true;
    }

    function saveAllFiles() {
        for (var p = 0, l = manager.panels.length; p < l; p++) {
            //not changed and new try next
            if (!manager.panels[p].editor.new && !manager.panels[p].editor.changed)
                continue;
            if (!saveFile(manager.panels[p]))
                return false;
        }
        return true;
    }

    function saveFileAs(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        var file = dialog.showSaveDialog(remote.getCurrentWindow(), {
            title: 'Save as...',
            defaultPath: panel.editor.file,
            filters: [
                { name: 'Code files (*.c, *.h)', extensions: ['c', 'h'] },
                { name: 'Data files (*.o, *.cfg)', extensions: ['o', 'cfg'] },
                { name: 'Text files (*.txt)', extensions: ['txt'] },
                { name: 'Map files (*.map)', extensions: ['map'] },
                { name: 'All files (*.*)', extensions: ['*'] },
            ]
        });
        if (file === undefined)
            return false;
        panel.editor.file = file;
        manager.setPanelTooltip(panel.editor.file, panel);
        manager.setPanelTitle(panel.editor.filename, panel);
        panel.editor.save();
        return true;
    }

    function closeFile() {
        if (manager.active) {
            manager.removePanel();
        }
    }

    function confirmSave(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        var choice = dialog.showMessageBox(
            remote.getCurrentWindow(),
            {
                type: 'question',
                title: panel.editor.new ? 'Save file?' : 'Save changes?',
                message: panel.editor.new ? ('Save ' + panel.editor.filename + '?') : ('Save changes to ' + panel.editor.filename + '?'),
                buttons: ['Yes', 'No', 'Cancel'],
                defaultId: 1
            });
        //canceled
        if (choice === 2)
            return false;
        //no
        if (choice === 1)
            return true;
        //attempt to save
        return saveFile(panel);
    }


    function findEditor(file) {
        if (!file || file.length === 0)
            return 0;
        for (var p = 0, l = manager.panels.length; p < l; p++) {
            if (manager.panels[p].editor.file === file)
                return manager.panels[p];
        }
        return 0;
    }

    function createEditor(file, open) {
        var p = findEditor(file);
        if (p)
            manager.switchToPanel(p);
        else {
            p = manager.addPanel(path.basename(file), getFileIcon(file), file);
            if (path.extname(file) === '.map')
                p.editor = new VirtualEditor({ file: file, container: p.pane, open: open });
            else
                p.editor = new CodeEditor({ file: file, container: p.pane, open: open });
            p.editor.on('changed', () => {
                doUpdate(2);
                updatePanel(p);
            });

            p.editor.on('saved', () => {
                doUpdate(2);
                updatePanel(p);
            });
            p.editor.on('selection-changed', () => {
                doUpdate(2);
            });
            doUpdate(1);
        }
        return p.editor;
    }


    function doUpdate(type) {
        if (!type) return;
        _updating |= type;
        if (_updating === 0)
            return;
        window.requestAnimationFrame(() => {
            if ((this._updating & 1) === 1) {
                updateUI();
                _updating &= ~1;
            }
            if ((this._updating & 2) === 2) {
                updateUIChange();
                _updating &= ~2;
            }
            doUpdate(_updating);
        });
    }

</script>

</html>
<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>Code Editor</title>
    <link rel="shortcut icon" href="../assets/icons/win/code.ico" />
    <link href="../lib/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-select.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/form.css" rel="stylesheet" type="text/css" />
    <link href="css/cm.css" rel="stylesheet" type="text/css" />
    <link href="css/code.editor.css" rel="stylesheet" type="text/css" />
    <link href="css/datagrid.css" rel="stylesheet" type="text/css" />
    <script>
        // eslint-disable-next-line no-unused-vars
        /* global _ready, doUpdate, manager, inverse, capitalize, options, monaco, initEditor */
        // eslint-disable-next-line no-unused-vars
        var _ready = false;
        const { SetupEditor } = require('./js/editor/code.editor');
        const { ReplaceCommandThatPreservesSelection } = require('./js/editor/monaco');

        function initEditor(editor) {

            editor.addAction({
                id: 'jimud.action.transformToInverse',
                label: 'Transform to Inverse',
                run: function (editor) {
                    let selections = editor.getSelections();
                    let model = editor.getModel();
                    let commands = [];

                    for (let i = 0, len = selections.length; i < len; i++) {
                        let selection = selections[i];
                        if (selection.isEmpty()) {
                            let cursor = selection.getStartPosition();
                            let word = model.getWordAtPosition(cursor);
                            if (!word) {
                                continue;
                            }

                            let wordRange = new monaco.Range(cursor.lineNumber, word.startColumn, cursor.lineNumber, word.endColumn);
                            let text = model.getValueInRange(wordRange);
                            commands.push(new ReplaceCommandThatPreservesSelection(wordRange, inverse(text), new monaco.Selection(cursor.lineNumber, cursor.column, cursor.lineNumber, cursor.column)));

                        } else {
                            let text = model.getValueInRange(selection);
                            commands.push(new ReplaceCommandThatPreservesSelection(selection, inverse(text), selection));
                        }
                    }
                    editor.pushUndoStop();
                    editor.executeCommands(this.id, commands);
                    editor.pushUndoStop();
                }
            });

            editor.addAction({
                id: 'jimud.action.transformToCapitalize',
                label: 'Transform to Capitalize',
                run: function (editor) {
                    let selections = editor.getSelections();
                    let model = editor.getModel();
                    let commands = [];

                    for (let i = 0, len = selections.length; i < len; i++) {
                        let selection = selections[i];
                        if (selection.isEmpty()) {
                            let cursor = selection.getStartPosition();
                            let word = model.getWordAtPosition(cursor);
                            if (!word) {
                                continue;
                            }

                            let wordRange = new monaco.Range(cursor.lineNumber, word.startColumn, cursor.lineNumber, word.endColumn);
                            let text = model.getValueInRange(wordRange);
                            commands.push(new ReplaceCommandThatPreservesSelection(wordRange, capitalize(text), new monaco.Selection(cursor.lineNumber, cursor.column, cursor.lineNumber, cursor.column)));

                        } else {
                            let text = model.getValueInRange(selection);
                            commands.push(new ReplaceCommandThatPreservesSelection(selection, capitalize(text), selection));
                        }
                    }
                    editor.pushUndoStop();
                    editor.executeCommands(this.id, commands);
                    editor.pushUndoStop();
                }
            });

            editor.addAction({
                id: 'jimud.action.insertColor',
                label: 'Transform to Capitalize',
                run: function (editor) {
                    let selections = editor.getSelections();
                    let model = editor.getModel();
                    let commands = [];

                    for (let i = 0, len = selections.length; i < len; i++) {
                        let selection = selections[i];
                        if (selection.isEmpty()) {
                            let cursor = selection.getStartPosition();
                            let word = model.getWordAtPosition(cursor);
                            if (!word) {
                                continue;
                            }

                            let wordRange = new monaco.Range(cursor.lineNumber, word.startColumn, cursor.lineNumber, word.endColumn);
                            let text = model.getValueInRange(wordRange);
                            commands.push(new ReplaceCommandThatPreservesSelection(wordRange, capitalize(text), new monaco.Selection(cursor.lineNumber, cursor.column, cursor.lineNumber, cursor.column)));

                        } else {
                            let text = model.getValueInRange(selection);
                            commands.push(new ReplaceCommandThatPreservesSelection(selection, capitalize(text), selection));
                        }
                    }
                    editor.pushUndoStop();
                    editor.executeCommands(this.id, commands);
                    editor.pushUndoStop();
                }
            });

            if (editor.getEditorType() === 'vs.editor.ICodeEditor') {
                editor.onContextMenu((e) => {
                    let idx = window.$editors.indexOf(editor);
                    if (manager.activePane === manager.panes[idx])
                        manager.active.editor.emit('contextmenu', e);
                });
                editor.onDidChangeCursorSelection(() => {
                    doUpdate(32);
                });
                editor.onDidChangeCursorPosition(() => {
                    doUpdate(64);
                });
                editor.onDidFocusEditor(() => {
                    doUpdate(32);
                });
            }
            else {
                let m = monaco.editor.createModel('', 'lpc');
                editor.setModel({
                    original: m,
                    modified: m
                });
                editor.setModel(null);
                m.dispose();
                editor.getOriginalEditor().onContextMenu((e) => {
                    let idx = window.$dEditors.indexOf(editor);
                    if (manager.activePane === manager.panes[idx])
                        manager.active.editor.emit('contextmenu-diff', e);
                });
                editor.getOriginalEditor().onDidChangeCursorSelection(() => {
                    doUpdate(32);
                });
                editor.getOriginalEditor().onDidChangeCursorPosition(() => {
                    doUpdate(64);
                });
                editor.getOriginalEditor().onDidFocusEditor(() => {
                    doUpdate(32);
                });
                editor.getModifiedEditor().onContextMenu((e) => {
                    let idx = window.$dEditors.indexOf(editor);
                    if (manager.activePane === manager.panes[idx])
                        manager.active.editor.emit('contextmenu', e);
                });
                editor.getModifiedEditor().onDidChangeCursorSelection(() => {
                    doUpdate(32);
                });
                editor.getModifiedEditor().onDidChangeCursorPosition(() => {
                    doUpdate(64);
                });
                editor.getModifiedEditor().onDidFocusEditor(() => {
                    doUpdate(32);
                });
            }

            if (options && options.editorOptions)
                editor.updateOptions(options.editorOptions);
        }

        SetupEditor().then((monaco) => {
            var pane = document.getElementById('cm-tabpane');
            var el = document.createElement('div');
            el.classList.add('editor-container');
            pane.appendChild(el);
            window.$editors = [monaco.editor.create(el, {
                language: 'lpc',
                autoIndent: true,
                rulers: [80],
                contextmenu: false,
                theme: 'lpcTheme',
                model: null
            })];
            initEditor(window.$editors[0]);
            el = document.createElement('div');
            el.classList.add('diff-container');
            pane.appendChild(el);
            window.$dEditors = [monaco.editor.createDiffEditor(el, {
                language: 'lpc',
                autoIndent: true,
                rulers: [80],
                contextmenu: false,
                theme: 'lpcTheme',
                model: null
            })];
            window.$dNavs = [
                monaco.editor.createDiffNavigator(window.$dEditors[0], {
                    followsCaret: true, // resets the navigator state when the user selects something in the editor
                    ignoreCharChanges: true // jump from line to line
                })
            ];
            initEditor(window.$dEditors[0]);
            _ready = true;
        });
    </script>
</head>

<body>
    <div id="splashScreenMask" class="splash-mask"></div>
    <div id="splashLayout" class="splash-layout">
        <div id="SplashScreen" class="splash-screen">
            <h1 id="splashTitle">jiMUD - Code editor</h1>
            <h3>
                <!--span class="fa fa-circle-o-notch fa-spin" title="Loading..."></span-->
                <span id="splashMessage">Loading...</span>
            </h3>
        </div>
    </div>
    <div id="toolbar" class="btn-toolbar" role="toolbar">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default btn-xs" title="New File" onclick="newFile()">
                <i class="fa fa-plus"></i>
            </button>
            <button id="btn-add-dropdown" type="button" class="btn btn-default btn-xs" title="New...">
                <span class="caret"></span>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-open" type="button" class="btn btn-default btn-xs" title="Open..." onclick="openFile()">
                <i class="fa fa-folder-open-o"></i>
            </button>
            <button id="btn-close" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Close" onclick="closeFile()">
                <i class="fa fa-window-close"></i>
            </button>
            <button id="btn-close-all" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Close All" onclick="closeAllFiles()">
                <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                    <i class="fa fa-window-close fa-stack-2x" style="font-size: 1em;margin-top: -2px;margin-left: 2px;"></i>
                    <i class="fa fa-window-close fa-stack-2x" style="font-size: 1em;margin-top: 2px;margin-left: -2px;"></i>
                </span>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-save" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Save" onclick="saveFile()">
                <i class="fa fa-save"></i>
            </button>
            <button id="btn-save-all" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Save All" onclick="saveAllFiles()">
                <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                    <i class="fa fa-save fa-stack-2x" style="font-size: 1em;margin-top: -2px;margin-left: 2px;"></i>
                    <i class="fa fa-save fa-stack-2x" style="font-size: 1em;margin-top: 2px;margin-left: -2px;"></i>
                </span>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-open-remote" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Open Remote..." onclick="openRemote()">
                <i class="fa fa-cloud-download"></i>
            </button>
            <button id="btn-upload" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Upload" onclick="uploadFile()">
                <i class="fa fa-upload"></i>
            </button>
            <button id="btn-upload-as" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Upload as..." onclick="uploadFileAs()">
                <i class="fa fa-cloud-upload"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-undo" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Undo" onclick="doUndo()">
                <i class="fa fa-undo"></i>
            </button>
            <button id="btn-redo" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Redo" onclick="doRedo()">
                <i class="fa fa-repeat"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-cut" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Cut" onclick="doCut()">
                <i class="fa fa-cut"></i>
            </button>
            <button id="btn-copy" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Copy" onclick="doCopy()">
                <i class="fa fa-copy"></i>
            </button>
            <button id="btn-paste" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Paste" onclick="doPaste()">
                <i class="fa fa-paste"></i>
            </button>
            <button id="btn-editor" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Paste to advanced editor" onclick="doEditor()">
                <i class="fa fa-edit"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-find" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Find" onclick="doFind()">
                <i class="fa fa-search"></i>
            </button>
            <button id="btn-replace" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Replace" onclick="doReplace()">
                <i class="fa fa-exchange"></i>
            </button>
        </div>
        <button id="btn-refresh" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Refresh" onclick="doRefresh()">
            <i class="fa fa-refresh"></i>
        </button>
        <div id="btn-group-diff-nav" class="btn-group" role="group">
            <button id="btn-diff-nav-prev" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Previous change" onclick="gotoPrevChange()">
                <i class="fa fa-arrow-left"></i>
            </button>
            <button id="btn-diff-nav-next" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Next change" onclick="gotoNextChange()">
                <i class="fa fa-arrow-right"></i>
            </button>
        </div>
        <div id="editor-buttons"></div>
    </div>
    <div id="output" class="output">
        <div id="btm-drag-bar"></div>
        <div id="output-toolbar" class="btn-toolbar" role="toolbar">
            <a href="javascript:void(0)" onclick="closeOutput()" class="close">
                <i class="fa fa-times"></i>
            </a>
            <button id="btn-clear-output" type="button" class="btn btn-default btn-xs" title="Clear output" onclick="doClearOutput()">
                <i class="fa fa-trash"></i>
            </button>
        </div>
        <div id="output-display" class="output-display" contenteditable="true" readonly="readonly"></div>
    </div>
    <div id="statusbar" class="statusbar">
        <span id="statusbar-file" class="left"></span>
        <span id="statusbar-message" class="center"></span>
        <span id="statusbar-location" class="right"></span>
        <span id="statusbar-size" class="right"></span>
    </div>
    <dialog id="resize" class="resize-dialog" data-title="Resize map" style="width:250px;height:313px;padding:5px;" onclose="menubar.enabled = true;" oncancel="menubar.enabled = true;">
        <div class="dialog-header" style="font-weight: bold">
            <button type="button" class="close" data-dismiss="modal" onclick="document.getElementById('new-area').close();">&times;</button>
            <div style="padding-top: 2px;">Create new area...</div>
        </div>
        <div class="dialog-body" style="padding-top:28px">
            <table style="width:100%;height:100%">
                <colgroup>
                    <col>
                    <col>
                    <col>
                    <col style="width:20px">
                    <col>
                </colgroup>
                <tr>
                    <td colspan="5">
                        <div class="form-group col-sm-4">
                            <label class="control-label">
                                Width
                                <input type="number" id="new-virtual-area-width" class="input-sm form-control" value="2" min="2" max="100" style="width: 100%" />
                            </label>
                        </div>
                        <div class="form-group col-sm-4">
                            <label class="control-label">
                                Height
                                <input type="number" id="new-virtual-area-height" class="input-sm form-control" value="2" min="2" max="100" style="width: 100%" />
                            </label>
                        </div>
                        <div class="form-group col-sm-4">
                            <label class="control-label">
                                Depth
                                <input type="number" id="new-virtual-area-depth" class="input-sm form-control" value="1" min="1" max="100" style="width: 100%" />
                            </label>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <button id="btn-add-dropdown" type="button" class="btn btn-default" title="New...">
                            &#8598; </button>
                    </td>
                    <td>
                        <button id="btn-add-dropdown" type="button" class="btn btn-default" title="New...">
                            &#8593; </button>
                    </td>
                    <td>
                        <button id="btn-add-dropdown" type="button" class="btn btn-default" title="New...">
                            &#8599; </button>
                    </td>
                    <td class="col-sm-4 form-group"></td>
                    <td>
                        <button id="btn-add-dropdown" type="button" class="btn btn-default" title="New...">
                            &#8593;</button>
                    </td>
                </tr>
                <tr>
                    <td>
                        <button id="btn-add-dropdown" type="button" class="btn btn-default" title="New...">
                            &#8592; </button>
                    </td>
                    <td>
                        <button id="btn-add-dropdown" type="button" class="active btn btn-default" title="New...">
                        </button>
                    </td>
                    <td>
                        <button id="btn-add-dropdown" type="button" class="btn btn-default" title="New...">
                            &#8594; </button>
                    </td>
                    <td></td>
                    <td>
                        <button id="btn-add-dropdown" type="button" class="active btn btn-default" title="New...">
                        </button>
                    </td>
                </tr>
                <td>
                    <button id="btn-add-dropdown" type="button" class="btn btn-default" title="New...">
                        &#8601; </button>
                </td>
                <td>
                    <button id="btn-add-dropdown" type="button" class="btn btn-default" title="New...">
                        &#8595; </button>
                </td>
                <td>
                    <button id="btn-add-dropdown" type="button" class="btn btn-default" title="New...">
                        &#8600; </button>
                </td>
                <td></td>
                <td>
                    <button id="btn-add-dropdown" type="button" class="btn btn-default" title="New...">
                        &#8595; </button>
                </td>
                </tr>
            </table>
        </div>
        <div class="dialog-footer">
            <button style="float: right" type="button" class="btn btn-default" onclick="document.getElementById('new-area').close();">Cancel</button>
            <button style="float: right" type="button" class="btn btn-primary" onclick="createArea()">Ok</button>
        </div>
    </dialog>

    <dialog id="new-area" data-title="Create new area" style="width:400px;height:348px;padding:5px;" onclose="menubar.enabled = true;" oncancel="menubar.enabled = true;">
        <div class="dialog-header" style="font-weight: bold">
            <button type="button" class="close" data-dismiss="modal" onclick="document.getElementById('new-area').close();">&times;</button>
            <div style="padding-top: 2px;">Create new area...</div>
        </div>
        <div class="dialog-body" style="padding-top:40px">
            <div class="form-group">
                <label class="control-label" style="width:100%">
                    Save path
                    <div class="input-group">
                        <input type="text" id="new-area-path" style="width:100%" class="input-sm form-control" />
                        <span class="input-group-btn">
                            <button class="btn btn-default btn-sm" type="button" id="btn-new-area-path">
                                &hellip;
                            </button>
                        </span>
                    </div>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Local path where files will be generated</span>
                    <div class="form-error"></div>
                </label>
            </div>
            <div class="form-group">
                <label class="control-label" style="width: 100%">Remote path
                    <div class="input-group">
                        <input type="text" id="new-area-remote-path" style="width:100%" class="input-sm form-control" />
                        <span class="input-group-btn">
                            <button class="btn btn-default btn-sm" type="button" id="btn-new-area-remote-path" disabled="disabled">
                                &hellip;
                            </button>
                        </span>
                    </div>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Remote path for area, if blank will default to /realms/character/area</span>
                </label>
            </div>
            <div class="form-group">
                <label class="control-label" style="width:100%">
                    Name
                    <input class="form-control" style="width:100%" type="text" id="new-area-name" style="width:100%">
                    <span class="glyphicon glyphicon-remove form-control-feedback" aria-hidden="true"></span>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Area name, used as folder name</span>
                    <div class="form-error"></div>
                </label>
            </div>
        </div>
        <div class="dialog-footer">
            <button style="float: right" type="button" class="btn btn-default" onclick="document.getElementById('new-area').close();">Cancel</button>
            <button style="float: right" type="button" class="btn btn-primary" onclick="createArea()">Ok</button>
        </div>
    </dialog>

    <dialog id="new-virtual-area" data-title="Create new virtual area" style="width:400px;height:450px;padding:0px;" onclose="menubar.enabled = true;" oncancel="menubar.enabled = true;">
        <div class="dialog-header" style="font-weight: bold">
            <button type="button" class="close" data-dismiss="modal" onclick="document.getElementById('new-virtual-area').close();">&times;</button>
            <div style="padding-top: 2px;">Create new virtual area...</div>
        </div>
        <div class="dialog-body" style="padding-top:33px">
            <ul class="nav nav-tabs" role="tablist" style="background-color: #F5F5F5;box-shadow: inset 0 -1px 0 #fff;">
                <li role="presentation" class="active">
                    <a href="#general" aria-controls="general" role="tab" data-toggle="tab">General</a>
                </li>
                <li role="presentation">
                    <a href="#advanced" aria-controls="advanced" role="tab" data-toggle="tab">Advanced</a>
                </li>
            </ul>
            <div class="tab-content" style="overflow: auto;height: 324px;">
                <div role="tabpanel" class="container tab-pane fade in active" id="general" style="width: auto;">
                    <div class="form-group">
                        <label class="control-label" style="width:100%">
                            Save path
                            <div class="input-group">
                                <input type="text" id="new-virtual-area-path" style="width:100%" class="input-sm form-control" />
                                <span class="input-group-btn">
                                    <button class="btn btn-default btn-sm" type="button" id="btn-new-virtual-area-path">
                                        &hellip;
                                    </button>
                                </span>
                            </div>
                            <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Local path where files will be generated</span>
                            <div class="form-error"></div>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="control-label" style="width: 100%">Remote path
                            <div class="input-group">
                                <input type="text" id="new-virtual-area-remote-path" style="width:100%" class="input-sm form-control" />
                                <span class="input-group-btn">
                                    <button class="btn btn-default btn-sm" type="button" id="btn-new-virtual-area-remote-path" disabled="disabled">
                                        &hellip;
                                    </button>
                                </span>
                            </div>
                            <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Remote path for area, if blank will default to /realms/character/area</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="control-label" style="width:100%">
                            Area
                            <div class="input-group" style="width:100%">
                                <input type="text" id="new-virtual-area-area" disabled="disabled" class="input-sm form-control" style="width:100%" />
                                <div class="input-group-addon">
                                    <label>
                                        <input type="checkbox" id="new-virtual-area-area-enabled" onchange="$('#new-virtual-area-area').attr('disabled', !this.checked);" /> Create
                                    </label>
                                </div>
                            </div>
                            <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Area name, used as folder name</span>
                            <div class="form-error"></div>
                        </label>
                    </div>
                    <div class="col-sm-4 form-group">
                        <label class="control-label">
                            Width
                            <input type="number" id="new-virtual-area-width" class="input-sm form-control" value="2" min="2" max="100" style="width: 100%" />
                        </label>
                    </div>
                    <div class="col-sm-4 form-group">
                        <label class="control-label">
                            Height
                            <input type="number" id="new-virtual-area-height" class="input-sm form-control" value="2" min="2" max="100" style="width: 100%" />
                        </label>
                    </div>
                    <div class="col-sm-4 form-group">
                        <label class="control-label">
                            Depth
                            <input type="number" id="new-virtual-area-depth" class="input-sm form-control" value="1" min="1" max="100" style="width: 100%" />
                        </label>
                    </div>
                </div>
                <div role="tabpanel" class="container tab-pane fade" id="advanced" style="width: auto;overflow:auto">
                    <div class="col-sm-6 form-group">
                        <label class="control-label">
                            <input type="checkbox" id="new-virtual-area-coordinates" /> Coordinates
                        </label>
                    </div>
                    <div class="col-sm-6 form-group">
                        <label class="control-label">
                            Room cache
                            <input type="number" id="new-virtual-area-cache" class="input-sm form-control" value="200" min="1" max="500" style="width: 100%" />
                        </label>
                    </div>
                    <div class="col-sm-12 form-group">
                        <label class="control-label">Default Exits</label>
                        <div id="new-virtual-area-default-exits">
                            <div class="btn-group" data-toggle="buttons">
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="512" id="deUp" disabled="disabled">Up
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="256" id="deDown" disabled="disabled">Down
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="128" id="deNorth" checked="checked">North
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="64" id="deNorthEast">NorthEast
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="32" id="deEast" checked="checked">East
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="16" id="deSouthEast">SouthEast
                                </label>
                            </div>
                            <div class="btn-group" data-toggle="buttons">
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="8" id="deSouth" checked="checked">South
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="4" id="deSouthWest">SouthWest
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="2" id="deWest" checked="checked">West
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="1" id="deNorthWest">NorthWest
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="0" id="eNone">None
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12 form-group">
                        <label class="control-label">Default States</label>
                        <div id="new-virtual-area-default-states">
                            <div class="btn-group" data-toggle="buttons">
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="512" id="dsNoAttack">No attack
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="256" id="dsNoMagic">No magic
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="128" id="dsCouncil">Council
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="64" id="dsOutdoors">Outdoor
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="32" id="dsIndoors">Indoor
                                </label>
                            </div>
                            <div class="btn-group" data-toggle="buttons">
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="16" id="dsWater">Water
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="8" id="dsHot">Hot
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="4" id="dsCold">Cold
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="2" id="dsSinkingUp">Sinking Up
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="1" id="dsSinkingDown">Sinking Down
                                </label>
                                <label class="btn btn-default btn-xs">
                                    <input type="checkbox" value="0" id="sNone" checked="checked">None
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="dialog-footer">
            <button style="float: right" type="button" class="btn btn-default" onclick="document.getElementById('new-virtual-area').close();">Cancel</button>
            <button style="float: right" type="button" class="btn btn-primary" onclick="createVirtualArea()">Ok</button>
        </div>
    </dialog>
    <dialog id="remoteBrowse" data-title="Open remote file" style="width: 500px; height: 350px; padding: 5px;">
        <div class="dialog-body panel panel-default" style="top: 0;bottom: 85px;left: 0px;right: 0px;padding: 0px;margin: 0px;position: absolute;border:0;border-radius: 0">
            <div class="panel-heading">
                <label class="control-label" for="remote-path">
                    <button class="close" data-dismiss="modal" onclick="$dialog.el.close()">×</button>
                    <div style="padding-top: 2px;" id="remoteBrowseTitle">Open remote file</div>
                </label>
                <span class="path-container">
                    <div class="input-group">
                        <input type="text" id="remote-path" class="form-control">
                        <span class="input-group-btn">
                            <button id="button-remote" class="btn btn-default" style="width: 17px;min-width:17px;border-radius:0;padding-left:4px;padding-right:4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul id="remote-navigate" style="max-height: 265px" class="dropdown-menu pull-right" aria-labelledby="button-remote" data-container="body"></ul>
                            <button id="btn-remote-up" disabled="disabled" type="button" class="btn btn-default btn-xs" title="Go up a directory">
                                <span class="fa-stack" style="top: -3px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                                    <i class="fa fa-folder-o fa-stack-2x" style="font-size: 1.2em"></i>
                                    <i class="fa fa-caret-up fa-stack-1x" style="font-size: 1em;margin-top: 1px;"></i>
                                </span>
                            </button>
                        </span>
                    </div>
                </span>
            </div>
            <div id="remoteBrowseList" class="panel-body" style="padding:0px;top:61px;bottom:1px;left:1px;right:1px;position: absolute;">
            </div>
        </div>
        <div id="remoteBrowseFooter" class="dialog-footer" style="padding-top: 35px;">
            <div style="position: absolute;top: 5px;left: 5px;right: 160px;bottom: 50px;">
                <span class="input-group">
                    <label class="input-group-addon" for="remoteBrowseFile" style="padding: 0 5px" id="remoteBrowseFile-label">File name:</label>
                    <input type="text" id="remoteBrowseFile" style="width:100%" class="input-sm form-control">
                </span>
            </div>
            <div style="position: absolute;top: 5px;right: 5px;bottom: 50px; width:150px">
                <select id="remoteBrowseFilter" class="form-control selectpicker" data-style="btn-default btn-sm" data-width="150px" style="position: absolute;right: 5px;width: 150px;top: 5px;height: 30px;"></select>
            </div>
            <button type="button" class="btn btn-default" data-dismiss="modal" style="float: right;" onclick="$dialog.el.close()">Cancel</button>
            <button type="button" disabled="disabled" class="btn btn-primary" data-dismiss="modal" style="float: right;" id="remoteBrowseOk">Open</button>
        </div>
    </dialog>

    <dialog id="progress-dialog" style="z-index:1000;text-align:center">
        <div id="progress-dialog-title">Retrieving&hellip;</div>
        <div>
            <progress max="100" id="progress-dialog-progressbar"></progress>
        </div>
        <div>
            <button id="progress-dialog-cancel">
                Cancel
            </button>
        </div>
    </dialog>
    <dialog id="update-progress" style="z-index:1000;text-align:center">
        <div id="update-progress-title"></div>
        <div>
            <progress max="100" id="update-progressbar"></progress>
        </div>
    </dialog>
    <div style="display: none" id="wizard-pages">
        <div id="mon-wizard-welcome">
            <img src="../assets/icons/png/wizmonlogo.png" alt="Welcome to the monster wizard" style="float: left;padding-top: 56px;">
            <div style="padding-top:76px">Welcome to the new monster wizard, this will take you through the steps to create a monster quickly and easily. You may finish at any time to generate a monster based on your current selections.</div>
        </div>
        <div id="mon-wizard-general">
            <div class="col-sm-6 form-group">
                <label class="control-label">Type
                    <select id="mon-wiz-type" class="form-control selectpicker" data-style="btn-default btn-sm" data-width="100%">
                        <option value='STD_MONSTER'>Standard</option>
                        <option value='BASEMONSTER'>Base</option>
                        <option value='MONTYPE_ARMOR_REPAIR'>Armor Repair</option>
                        <option value='MONTYPE_BARKEEP'>Barkeep</option>
                        <option value='MONTYPE_CLERIC_TRAINER'>Cleric Trainer</option>
                        <option value='MONTYPE_SUBCLASSER'>Command Trainer</option>
                        <option value='MONTYPE_HEALER'>Healer</option>
                        <option value='MONTYPE_JEWELER'>Jeweler</option>
                        <option value='MONTYPE_LOCKPICK_REPAIR'>Lock pick Repair</option>
                        <option value='MONTYPE_MAGE_TRAINER'>Mage Trainer</option>
                        <option value='MONTYPE_MON_EDIBLE'>Edible Monster</option>
                        <option value='MONTYPE_SAGE_NPC'>Sage</option>
                        <option value='MONTYPE_SKILL_TRAINER'>Skill Trainer</option>
                        <option value='MONTYPE_SMITH'>Smith</option>
                        <option value='MONTYPE_SUMMON_MOB'>Summon Monster</option>
                        <option value='MONTYPE_TATTOOIST'>Tattooist</option>
                        <option value='MONTYPE_CMD_TRAIN_NPC'>Trainer</option>
                        <option value='MONTYPE_VENDOR'>Vendor</option>
                        <option value='MONTYPE_WEAPON_REPAIR'>Weapon Repair</option>
                    </select>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Level
                    <input type="number" id="mon-wiz-level" class="input-sm form-control" min="1" />
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Alignment
                    <div class="input-group edit-dropdown">
                        <input type="text" id="mon-wiz-alignment" class="input-sm form-control">
                        <span class="input-group-btn">
                            <button id="btn-mon-wiz-alignment" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul style="max-height: 265px;" class="dropdown-menu pull-right" aria-labelledby="btn-mon-wiz-alignment" data-container="body">
                                <li>
                                    <a href="#">demonic</a>
                                </li>
                                <li>
                                    <a href="#">evil</a>
                                </li>
                                <li>
                                    <a href="#">bad</a>
                                </li>
                                <li>
                                    <a href="#">malevolent</a>
                                </li>
                                <li>
                                    <a href="#">mean</a>
                                </li>
                                <li>
                                    <a href="#">neutral</a>
                                </li>
                                <li>
                                    <a href="#">nice</a>
                                </li>
                                <li>
                                    <a href="#">benevolent</a>
                                </li>
                                <li>
                                    <a href="#">good</a>
                                </li>
                                <li>
                                    <a href="#">righteous</a>
                                </li>
                                <li>
                                    <a href="#">saintly</a>
                                </li>
                            </ul>
                        </span>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Race
                    <div class="input-group edit-dropdown">
                        <input type="text" id="mon-wiz-race" class="input-sm form-control">
                        <span class="input-group-btn">
                            <button id="btn-mon-wiz-race" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul id="mon-wiz-race-list" style="max-height: 265px;" class="dropdown-menu pull-right" aria-labelledby="btn-mon-wiz-race" data-container="body">
                            </ul>
                        </span>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Class
                    <div class="input-group edit-dropdown">
                        <input type="text" id="mon-wiz-class" class="input-sm form-control">
                        <span class="input-group-btn">
                            <button id="btn-mon-wiz-class" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul style="max-height: 265px;" class="dropdown-menu pull-right" aria-labelledby="btn-mon-wiz-class" data-container="body">
                                <li>
                                    <a href="#" class="main">cleric</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">baeron</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">cleric</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">edorin</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">ianthe</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">makkairi</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">phaedrus</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">vndyrwynd</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">zaal</a>
                                </li>
                                <li>
                                    <a href="#" class="main">fighter</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">barbarian</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">centurion</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">knight</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">marksman</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">ranger</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">warrior</a>
                                </li>
                                <li>
                                    <a href="#" class="main">mage</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">conjuror</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">elementalist</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">necromancer</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">planeswalker</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">sorcerer</a>
                                </li>
                                <li>
                                    <a href="#" class="main">monk</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">feather clan</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">hoof clan</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">spirit clan</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">tail clan</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">talon clan</a>
                                </li>
                                <li>
                                    <a href="#" class="main">rogue</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">acrobat</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">assassin</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">bard</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">thief</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">thug</a>
                                </li>
                                <li>
                                    <a href="#" class="sub">trickster</a>
                                </li>
                            </ul>
                        </span>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Language
                    <div class="input-group edit-dropdown">
                        <input type="text" id="mon-wiz-language" class="input-sm form-control" placeholder="Defaults based on race">
                        <span class="input-group-btn">
                            <button id="btn-mon-wiz-language" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul style="max-height: 265px;" class="dropdown-menu pull-right" aria-labelledby="btn-mon-wiz-language" data-container="body">
                                <li>
                                    <a href="#">eltherian</a>
                                </li>
                                <li>
                                    <a href="#">caninen</a>
                                </li>
                                <li>
                                    <a href="#">common</a>
                                </li>
                                <li>
                                    <a href="#">dintali</a>
                                </li>
                                <li>
                                    <a href="#">draconian</a>
                                </li>
                                <li>
                                    <a href="#">draconic</a>
                                </li>
                                <li>
                                    <a href="#">draconic</a>
                                </li>
                                <li>
                                    <a href="#">elcharean</a>
                                </li>
                                <li>
                                    <a href="#">eltherian</a>
                                </li>
                                <li>
                                    <a href="#">ersi</a>
                                </li>
                                <li>
                                    <a href="#">farsi</a>
                                </li>
                                <li>
                                    <a href="#">gobbledegook</a>
                                </li>
                                <li>
                                    <a href="#">jhlorim</a>
                                </li>
                                <li>
                                    <a href="#">loyavenku</a>
                                </li>
                                <li>
                                    <a href="#">malkierien</a>
                                </li>
                                <li>
                                    <a href="#">malkierien</a>
                                </li>
                                <li>
                                    <a href="#">naga</a>
                                </li>
                                <li>
                                    <a href="#">nibelungen</a>
                                </li>
                                <li>
                                    <a href="#">nymal</a>
                                </li>
                                <li>
                                    <a href="#">shangtai</a>
                                </li>
                                <li>
                                    <a href="#">tangetto</a>
                                </li>
                                <li>
                                    <a href="#">terrakarn</a>
                                </li>
                                <li>
                                    <a href="#">westernese</a>
                                </li>
                                <li>
                                    <a href="#">wulinaxin</a>
                                </li>
                                <li>
                                    <a href="#">yak</a>
                                </li>
                            </ul>
                        </span>
                    </div>
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-ridable" /> Ridable
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-flying" /> Flying
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-getable" /> Getable
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-undead" /> Undead
                </label>
            </div>
            <div class="col-sm-4 form-group" style="width: auto;">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-waterbreathing" /> Water breathing
                </label>
            </div>
            <div class="col-sm-4 form-group" style="width: auto;">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-requires-water" /> Requires water
                </label>
            </div>
            <div class="col-sm-4 form-group" style="width: auto;">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-no-bleed" /> No bleeding
                </label>
            </div>
        </div>
        <div id="mon-wizard-description">
            <div class="col-sm-12 form-group">
                <label class="control-label">Name
                    <input type="text" class="input-sm form-control" id="mon-wiz-name" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">Short
                    <input type="text" class="input-sm form-control" id="mon-wiz-short" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Nouns
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;display:inline">A comma delimited list of words</span>
                    <input type="text" class="input-sm form-control" id="mon-wiz-nouns" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Adjectives
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;display:inline">A comma delimited list of words</span>
                    <input type="text" class="input-sm form-control" id="mon-wiz-adjectives" />
                </label>
            </div>
        </div>
        <div id="mon-wizard-description-long">
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Long
                    <a href="#" onclick="ipcRenderer.send('send-editor', document.getElementById('mon-wiz-long').value, 'editor', true);document.getElementById('mon-wizard-description-long').focus();">
                        <i class="fa fa-edit"></i>
                    </a>
                    <textarea class="input-sm form-control" id="mon-wiz-long" style="width: 100%;height: 216px;"></textarea>
                </label>
            </div>
        </div>
        <div id="mon-wizard-physical">
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Mass
                    <input type="number" id="mon-wiz-mass" class="input-sm form-control" min="0" value="0" />
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">A mass of 0 will use default mass</span>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Height
                    <div class="input-group">
                        <input type="number" id="mon-wiz-height" class="input-sm form-control" min="1" value="1" />
                        <div class="input-group-addon">inches</div>
                    </div>
                </label>
            </div>
            <div class="col-sm-12" style="padding: 0px;">
                <div class="col-sm-6 form-group">
                    <label class="control-label">Eye color
                        <div class="input-group edit-dropdown">
                            <input type="text" id="mon-wiz-eye" class="input-sm form-control">
                            <span class="input-group-btn">
                                <button id="btn-mon-wiz-eye" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="caret" style="margin-left: -1px;"></span>
                                </button>
                                <ul id="mon-wiz-eye-list" style="max-height: 265px;" class="dropdown-menu pull-right" aria-labelledby="btn-mon-wiz-eye" data-container="body">
                                </ul>
                            </span>
                        </div>
                    </label>
                </div>
                <div class="col-sm-6 form-group">
                    <label class="control-label">Hair color
                        <div class="input-group edit-dropdown">
                            <input type="text" id="mon-wiz-hair" class="input-sm form-control">
                            <span class="input-group-btn">
                                <button id="btn-mon-wiz-hair" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="caret" style="margin-left: -1px;"></span>
                                </button>
                                <ul id="mon-wiz-hair-list" style="max-height: 265px;" class="dropdown-menu pull-right" aria-labelledby="btn-mon-wiz-hair" data-container="body">
                                </ul>
                            </span>
                        </div>
                    </label>
                </div>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Gender
                    <select id="mon-wiz-gender" class="form-control selectpicker" data-style="btn-default btn-sm" data-width="100%">
                        <option value='male'>male</option>
                        <option value='female'>female</option>
                        <option value=''>none</option>
                    </select>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Body type
                    <div class="input-group edit-dropdown">
                        <input type="text" id="mon-wiz-body" class="input-sm form-control">
                        <span class="input-group-btn">
                            <button id="btn-mon-wiz-body" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul id="mon-wiz-body-list" style="max-height: 265px;" class="dropdown-menu pull-right" aria-labelledby="btn-mon-wiz-body" data-container="body">
                            </ul>
                        </span>
                    </div>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">Defaults based on race</span>
                </label>
            </div>
        </div>
        <div id="mon-wizard-advanced">
            <div class="col-sm-12 form-group">
                <label class="control-label">No corpse
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;display:inline">"" disable, $N or $n name, empty default</span>
                    <input type="text" class="input-sm form-control" id="mon-wiz-no-corpse" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">No limbs
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;display:inline">"" disable, $N/$n name, $L/$l limb, empty default</span>
                    <input type="text" class="input-sm form-control" id="mon-wiz-no-limbs" />
                </label>
            </div>
        </div>
        <div id="mon-wizard-finish">
            <img src="../assets/icons/png/wizmonlogo.png" alt="Monster finish summary" style="float: left;padding-top: 56px;"> To finish your monster simply click finished
            <div id="mon-wiz-summary" readonly="readonly" class="form-control" style="overflow:auto;height:219px;width:355px;white-space:pre;float: right;"></div>
        </div>
        <div id="mon-wizard-combat">
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Attack commands
                    <textarea class="input-sm form-control" id="mon-wiz-commands" style="width: 100%;height: 44px;"></textarea>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">A comma delimited list of commands, defaults based on class</span>
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Attack command chance
                    <div class="input-group">
                        <input type="number" id="mon-wiz-chance" class="input-sm form-control" min="0" max="101" />
                        <div class="input-group-addon">%</div>
                    </div>
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Attack initiators
                    <textarea class="input-sm form-control" id="mon-wiz-initiators" style="width: 100%;height: 44px;"></textarea>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">A comma delimited list of commands, defaults based on class</span>
                </label>
            </div>
        </div>
        <div id="mon-wizard-aggressive">
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Aggressive
                    <textarea class="input-sm form-control" id="mon-wiz-aggressive" style="width: 100%;height: 200px;"></textarea>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">See /doc/build/monster/haggle for details</span>
                </label>
            </div>
        </div>
        <div id="mon-wizard-movement">
            <div class="col-sm-12 form-group">
                <label class="control-label">
                    Speed
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;display:inline;">0 means no movement</span>
                    <input type="number" id="mon-wiz-speed" class="input-sm form-control" min="0" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Patrol route
                    <textarea class="input-sm form-control" id="mon-wiz-patrol" style="width: 100%;height: 44px;"></textarea>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">A comma delimited list of directions</span>
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">No walk rooms
                    <textarea class="input-sm form-control" id="mon-wiz-no-walk" style="width: 100%;height: 44px;"></textarea>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0">A comma delimited list of room paths</span>
                </label>
            </div>
        </div>
        <div id="mon-wizard-actions">
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Auto drop
                    <div class="input-group">
                        <input type="number" id="mon-wiz-auto-drop" class="input-sm form-control" min="0" max="120" />
                        <div class="input-group-addon" style="border-left: 0;">secs</div>
                        <div class="input-group-addon">
                            <label>
                                <input type="checkbox" id="mon-wiz-auto-drop-enabled" /> Enable</label>
                        </div>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Open storage
                    <div class="input-group">
                        <input type="number" id="mon-wiz-storage" class="input-sm form-control" min="0" max="120" />
                        <div class="input-group-addon" style="border-left: 0;">secs</div>
                        <div class="input-group-addon">
                            <label>
                                <input type="checkbox" id="mon-wiz-storage-enabled" /> Enable</label>
                        </div>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Auto wield
                    <div class="input-group">
                        <input type="number" id="mon-wiz-auto-wield" class="input-sm form-control" min="0" max="120" />
                        <div class="input-group-addon" style="border-left: 0;">secs</div>
                        <div class="input-group-addon">
                            <label>
                                <input type="checkbox" id="mon-wiz-auto-wield-enabled" /> Enable</label>
                        </div>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Auto loot
                    <div class="input-group">
                        <input type="number" id="mon-wiz-auto-loot" class="input-sm form-control" min="0" max="120" />
                        <div class="input-group-addon" style="border-left: 0;">secs</div>
                        <div class="input-group-addon">
                            <label>
                                <input type="checkbox" id="mon-wiz-auto-loot-enabled" /> Enable</label>
                        </div>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Auto wear
                    <div class="input-group">
                        <input type="number" id="mon-wiz-auto-wear" class="input-sm form-control" min="0" max="120" />
                        <div class="input-group-addon" style="border-left: 0;">secs</div>
                        <div class="input-group-addon">
                            <label>
                                <input type="checkbox" id="mon-wiz-auto-wear-enabled" /> Enable</label>
                        </div>
                    </div>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Wimpy
                    <div class="input-group">
                        <input type="number" id="mon-wiz-wimpy" class="input-sm form-control" min="0" max="101" />
                        <div class="input-group-addon">%</div>
                    </div>
                </label>
            </div>
            <div class="col-sm-5 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-drop-encumbered" /> Drop encumbered
                </label>
            </div>
            <div class="col-sm-7 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-drop-encumbered-combat" /> Drop encumbered combat
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    <input type="checkbox" id="mon-wiz-auto-stand" /> Auto stand
                </label>
            </div>

        </div>
        <div id="room-wizard-welcome">
            <img src="../assets/icons/png/wizroomlogo.png" alt="Welcome to the room wizard" style="float: left;margin-top: 56px;height: 128px;width:128px;">
            <div style="padding-top:76px">Welcome to the new room wizard, this will take you through the steps to create a room quickly and easily. You may finish at any time to generate a room based on your current selections.</div>
        </div>
        <div id="room-wizard-finish">
            <img src="../assets/icons/png/wizroomlogo.png" alt="Room wizard summary" style="float: left;margin-top: 56px;height: 128px;width:128px;"> To finish your room simply click finished
            <div id="room-wiz-summary" readonly="readonly" class="form-control" style="overflow:auto;height:219px;width:355px;white-space:pre;float: right;"></div>
        </div>
        <div id="room-wizard-general">
            <div class="col-sm-6 form-group">
                <label class="control-label">Type
                    <select id="room-wiz-type" class="form-control selectpicker" data-style="btn-default btn-sm" data-width="100%">
                        <option value='STD_ROOM'>Standard</option>
                        <option value='BASEROOM'>Base</option>
                        <option value="ROOMTYPE_ADVANCE_ROOM">Advance room</option>
                        <option value="ROOMTYPE_BANK">Bank</option>
                        <option value="ROOMTYPE_CLASS_JOIN">Class join</option>
                        <option value="ROOMTYPE_CLIMB">Climb</option>
                        <option value="ROOMTYPE_DOCK">Dock</option>
                        <option value="ROOMTYPE_GUILD_HALL">Guild hall</option>
                        <option value="ROOMTYPE_INN">Inn</option>
                        <option value="ROOMTYPE_LIBRARY">Library</option>
                        <option value="ROOMTYPE_LOCKER">Locker</option>
                        <option value="ROOMTYPE_MODROOM">Modroom</option>
                        <option value="ROOMTYPE_PIER">Pier</option>
                        <option value="ROOMTYPE_SAGE">Sage</option>
                        <option value="ROOMTYPE_SINK_ROOM">Sink</option>
                        <option value="ROOMTYPE_SKY_ROOM">Sky</option>
                        <option value="ROOMTYPE_STABLE">Stable</option>
                        <option value="ROOMTYPE_TRAIN_ROOM">Train</option>
                        <option value="ROOMTYPE_VAULT">Vault</option>
                        <option value="ROOMTYPE_VENDOR_STORAGE">Vendor storage</option>
                    </select>
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Terrain
                    <div class="input-group edit-dropdown">
                        <input type="text" id="room-wiz-terrain" class="input-sm form-control">
                        <span class="input-group-btn">
                            <button id="btn-room-wiz-terrain" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul id="room-wiz-terrain-list" style="max-height: 265px;" class="dropdown-menu pull-right" aria-labelledby="btn-room-wiz-terrain" data-container="body">
                                <li>
                                    <a href="#">beach</a>
                                </li>
                                <li>
                                    <a href="#">bog</a>
                                </li>
                                <li>
                                    <a href="#">city</a>
                                </li>
                                <li>
                                    <a href="#">cliff</a>
                                </li>
                                <li>
                                    <a href="#">cobble</a>
                                </li>
                                <li>
                                    <a href="#">desert</a>
                                </li>
                                <li>
                                    <a href="#">dirt</a>
                                </li>
                                <li>
                                    <a href="#">dirtroad</a>
                                </li>
                                <li>
                                    <a href="#">farmland</a>
                                </li>
                                <li>
                                    <a href="#">forest</a>
                                </li>
                                <li>
                                    <a href="#">grass</a>
                                </li>
                                <li>
                                    <a href="#">grassland</a>
                                </li>
                                <li>
                                    <a href="#">highmountain</a>
                                </li>
                                <li>
                                    <a href="#">hills</a>
                                </li>
                                <li>
                                    <a href="#">icesheet</a>
                                </li>
                                <li>
                                    <a href="#">jungle</a>
                                </li>
                                <li>
                                    <a href="#">lake</a>
                                </li>
                                <li>
                                    <a href="#">mountain</a>
                                </li>
                                <li>
                                    <a href="#">ocean</a>
                                </li>
                                <li>
                                    <a href="#">pavedroad</a>
                                </li>
                                <li>
                                    <a href="#">plains</a>
                                </li>
                                <li>
                                    <a href="#">prairie</a>
                                </li>
                                <li>
                                    <a href="#">river</a>
                                </li>
                                <li>
                                    <a href="#">rockdesert</a>
                                </li>
                                <li>
                                    <a href="#">rocky</a>
                                </li>
                                <li>
                                    <a href="#">sand</a>
                                </li>
                                <li>
                                    <a href="#">sanddesert</a>
                                </li>
                                <li>
                                    <a href="#">savannah</a>
                                </li>
                                <li>
                                    <a href="#">stone</a>
                                </li>
                                <li>
                                    <a href="#">swamp</a>
                                </li>
                                <li>
                                    <a href="#">tundra</a>
                                </li>
                                <li>
                                    <a href="#">underwater</a>
                                </li>
                                <li>
                                    <a href="#">water</a>
                                </li>

                            </ul>
                        </span>
                    </div>
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">Short
                    <input type="text" class="input-sm form-control" id="room-wiz-short" />
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Light
                    <input type="number" id="room-wiz-light" class="input-sm form-control" min="-20" max="20" />
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">
                    Night light adjustment
                    <input type="number" id="room-wiz-night-adjust" class="input-sm form-control" min="-20" max="20" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">Prevent peer all directions
                    <input type="text" class="input-sm form-control" id="room-wiz-prevent-peer" />
                </label>
            </div>
        </div>
        <div id="room-wizard-description">
            <div class="col-sm-12 form-group">
                <label class="control-label" style="width: 100%">Long
                    <a href="#" onclick="ipcRenderer.send('send-editor', document.getElementById('room-wiz-long').value, 'editor', true);document.getElementById('room-wiz-long').focus();">
                        <i class="fa fa-edit"></i>
                    </a>
                    <textarea class="input-sm form-control" id="room-wiz-long" style="width: 100%;height: 216px;"></textarea>
                </label>
            </div>
        </div>
        <div id="room-wizard-properties">
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-indoors" /> Indoors
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-no-magic" /> No magic
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-no-scry" /> No scry
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-no-teleport" /> No teleport
                </label>
            </div>
            <div class="col-sm-4 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-explored" /> Explored Marker
                </label>
            </div>
            <div class="col-sm-4 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-no-map" /> No map send
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-hide-exits" /> Hide exits
                </label>
            </div>
            <div class="col-sm-4 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-no-forage" /> No forage
                </label>
            </div>
            <div class="col-sm-4 form-group">
                <label class="control-label">
                    Forage
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;display:inline">-1 default</span>
                    <input type="number" id="room-wiz-forage" class="input-sm form-control" min="-1" />
                </label>
            </div>
            <div class="col-sm-4 form-group">
                <label class="control-label">
                    Max forage
                    <input type="number" id="room-wiz-max-forage" class="input-sm form-control" min="0" />
                </label>
            </div>
            <div class="col-sm-12 form-group">
                <label class="control-label">Secret exit
                    <input type="text" class="input-sm form-control" id="room-wiz-secret-exit" />
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;">String, function, or boolean to indicate there is a secret exit</span>
                </label>
            </div>
        </div>
        <div id="room-wizard-combat-properties">
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-no-attack" /> No attack
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-council" /> Council
                </label>
            </div>
            <div class="col-sm-4 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-melee" /> Melee as ability
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-pk" /> Enable pk
                </label>
            </div>
            <div class="col-sm-3 form-group">
                <label class="control-label">
                    <input type="checkbox" id="room-wiz-no-dirt" /> No dirt
                </label>
            </div>
            <div class="col-sm-6 form-group">
                <label class="control-label">Dirt type
                    <div class="input-group edit-dropdown">
                        <input type="text" id="room-wiz-dirt" class="input-sm form-control">
                        <span class="input-group-btn">
                            <button id="btn-room-wiz-dirt" class="btn-sm btn btn-default" style="width: 17px;min-width:17px;padding-left:4px;padding-right:4px;border-top-right-radius: 4px;border-bottom-right-radius: 4px;" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret" style="margin-left: -1px;"></span>
                            </button>
                            <ul id="room-wiz-dirt-list" style="max-height: 265px;" class="dropdown-menu pull-right" aria-labelledby="btn-room-wiz-dirt" data-container="body">
                                <li>
                                    <a href="#" data-value=''>none</a>
                                </li>
                                <li>
                                    <a href="#">dirt</a>
                                </li>
                                <li>
                                    <a href="#">mud</a>
                                </li>
                                <li>
                                    <a href="#">snow</a>
                                </li>
                                <li>
                                    <a href="#">sand</a>
                                </li>
                                <li>
                                    <a href="#">dust</a>
                                </li>
                                <li>
                                    <a href="#">sludge</a>
                                </li>
                            </ul>
                        </span>
                    </div>
                    <span class="help-block" style="font-size: 0.8em;margin:0;padding:0;">Empty default based on terrain/weather</span>
                </label>
            </div>
        </div>
    </div>
</body>
<script>
    if (typeof module === 'object') { window.module = module; module = undefined; }
</script>
<script src="../lib/jquery.min.js" type="text/javascript"></script>
<script src="../lib/bootstrap.min.js" type="text/javascript"></script>
<script src="../lib/bootstrap-select.min.js" type="text/javascript"></script>
<script>
    /*global _ready:true*/
    const { shell, remote, ipcRenderer, webFrame, clipboard } = require('electron');
    const { DockManager } = require('./js/dockmanager');
    const { DataGrid, EditorType } = require('./js/datagrid');
    const { MonacoCodeEditor, VirtualEditor, AreaEditor, Source, FileBrowseValueEditor, RoomExit, RoomStates } = require('./js/editor/code.editor');
    const { EditorSettings } = require('./js/editor/code.editor.settings');

    const { dialog, Menu, MenuItem, app } = remote;
    const { Menubar } = require('./js/menubar');
    const { Wizard, WizardPage, WizardDataGridPage } = require('./js/wizard');

    // eslint-disable-next-line no-unused-vars
    const { formatString, wordWrap, inverse, parseTemplate, capitalize, existsSync, isDirSync, walkSync, formatSize } = require('./js/library');
    const { IEDError } = require('./js/types');

    const { IED } = require('./js/ied');

    const moment = require('moment');
    const chokidar = require('chokidar');
    const path = require('path');
    const fs = require('fs');
    const tmp = require('tmp');
    tmp.setGracefulCleanup();

    remote.getCurrentWindow().setEnabled(false);

    var krypto = null;
    var spellchecker, menubar;
    var options, _updating = 0;
    var _loading = 1;
    var _opening = {};
    var _open;
    var newCounter = 1;
    let $closeWindow = false;
    var watcher;
    var _watched = {};
    var outputDragging = false;
    var output = $('#output');
    var outputDisplay = $('#output-display');
    var _editors = {};
    var _recent = [];
    var sbSize = document.getElementById('statusbar-size');
    var sbName = document.getElementById('statusbar-file');
    var sbLocation = document.getElementById('statusbar-location');
    var sbMessage = document.getElementById('statusbar-message');
    var connected = remote.getGlobal('connected') === true;
    var _ied;
    var $dialog;
    var $dialogs = {};
    var $queue = [];
    var tmpOptions = { prefix: 'jiMUD-', dir: getTempDir(), postfix: '.tmp' };
    var $id = 0;

    var $fileFilters = [
        { name: 'Supported files (*.c, *.h, *.map)', extensions: ['c', 'h', 'map'] },
        { name: 'Code files (*.c, *.h)', extensions: ['c', 'h'] },
        { name: 'Data files (*.o, *.cfg)', extensions: ['o', 'cfg'] },
        { name: 'Text files (*.txt)', extensions: ['txt'] },
        { name: 'Map files (*.map)', extensions: ['map'] },
        { name: 'All files (*.*)', extensions: ['*'] },
    ];

    outputDisplay.on('keydown', () => {
        if (event.ctrlKey) {
            // allow Ctrl-A, Ctrl-(any arrow key) combinations
            return true;
        }
        // keycode: http://www.programming-magic.com/file/20080205232140/keycode_table.html
        if (33 <= event.keyCode && event.keyCode <= 40) {
            return true;
        }
        return false;
    });

    outputDisplay.on('cut', (e) => {
        e.preventDefault();
        e.stopPropagation();
    });

    outputDisplay.on('paste', (e) => {
        e.preventDefault();
        e.stopPropagation();
    });

    webFrame.setSpellCheckProvider("en-US", true, {
        spellCheck: function (text) {
            if (!spellchecker || !options.spellchecking)
                return true;
            return !(spellchecker.isMisspelled(text));
        }
    });

    window.addEventListener('contextmenu', (e) => {
        if (!options || !options.spellchecking || !spellchecker || !e.srcElement || !e.srcElement.spellcheck || (e.srcElement.tagName !== 'TEXTAREA' && e.srcElement.tagName !== 'INPUT'))
            return;
        e.preventDefault();
        var inputMenu = Menu.buildFromTemplate([
            { role: 'undo' },
            { role: 'redo' },
            { type: 'separator' },
            { role: 'cut' },
            { role: 'copy' },
            { role: 'paste' },
            { type: 'separator' },
            { role: 'selectall' },
        ]);
        if (remote.getGlobal('debug')) {
            inputMenu.append(new MenuItem({ type: 'separator' }));
            inputMenu.append(new MenuItem({
                label: 'Inspect', click: () => {
                    remote.getCurrentWindow().webContents.inspectElement(e.pageX, e.pageY);
                }
            }));
        }
        if (options.spellchecking && spellchecker && e.srcElement.spellcheck && e.srcElement.value) {
            var word = e.srcElement.value.substring(e.srcElement.selectionStart, e.srcElement.selectionEnd);
            var ol = word.length;
            word = word.trimRight();
            var ll = ol - word.length;
            if (ll > 0)
                e.srcElement.selectionEnd = e.srcElement.selectionEnd - ll;

            if (spellchecker.isMisspelled(word)) {
                var words = spellchecker.getCorrectionsForMisspelling(word);
                if (words.length > 0)
                    inputMenu.insert(0, new MenuItem({ type: 'separator' }));
                var start = e.srcElement.selectionStart;
                var end = e.srcElement.selectionEnd;
                for (var w = words.length - 1; w >= 0; w--) {
                    inputMenu.insert(0, new MenuItem({
                        label: words[w],
                        start: start,
                        end: end,
                        click: function (item) {
                            var value = e.srcElement.value;
                            value = value.substring(0, item.start) + item.label + value.substring(item.end);
                            e.srcElement.value = value;
                            e.srcElement.selectionStart = start + item.label.length;
                            e.srcElement.selectionEnd = start + item.label.length;
                            e.srcElement.setSelectionRange(start + item.label.length, start + item.label.length);
                            //e.srcElement.blur();
                            e.srcElement.focus();
                        }
                    }));
                }
            }
        }
        inputMenu.popup({ window: remote.getCurrentWindow() });

    });

    var menuTemplates = loadTemplates(parseTemplate(path.join('{assets}', 'templates')), '', ['wizards']);
    var subMenus = {
        'edit': [
            {
                label: '&Undo',
                accelerator: "CmdOrCtrl+Z",
                click: doUndo,
                enabled: false,
            },
            {
                label: '&Redo',
                accelerator: "CmdOrCtrl+Y",
                click: doRedo,
                enabled: false,
            },
            { type: 'separator' },
            {
                label: 'Cu&t',
                accelerator: "CmdOrCtrl+X",
                click: doCut,
                enabled: false,
            },
            {
                label: '&Copy',
                accelerator: "CmdOrCtrl+C",
                click: doCopy,
                enabled: false,
            },
            {
                label: '&Paste',
                accelerator: "CmdOrCtrl+V",
                click: doPaste,
                enabled: false,
            },
            {
                label: 'Paste to Advanced Editor',
                accelerator: "CmdOrCtrl+Shift+V",
                click: doEditor,
                enabled: false,
            },
            { type: 'separator' },
            {
                label: '&Select All',
                accelerator: "CmdOrCtrl+A",
                enabled: false,
                click: () => {
                    if (manager.active && manager.active.editor)
                        manager.active.editor.selectAll();
                }
            },
            { type: 'separator' },
            {
                label: '&Find',
                accelerator: "CmdOrCtrl+F",
                enabled: false,
                click: doFind
            },
            {
                label: '&Replace',
                accelerator: "CmdOrCtrl+H",
                enabled: false,
                click: doReplace
            },
        ],
        'view': [
            {
                label: '&Refresh',
                accelerator: "F5",
                enabled: false,
                click: doRefresh
            },
            { type: 'separator' },
            {
                label: '&Previous change',
                enabled: false,
                click: gotoPrevChange
            },
            {
                label: '&Next change',
                enabled: false,
                click: gotoNextChange
            },
            { type: 'separator' },
            {
                label: '&Output',
                accelerator: 'CmdOrCtrl+Shift+U',
                type: 'checkbox',
                checked: false,
                click: toggleOutput,
                enabled: true
            },
            { type: 'separator' },
            {
                label: '&Toggle Developer Tools',
                click: () => {
                    if (remote.getCurrentWindow().isDevToolsOpened())
                        remote.getCurrentWindow().closeDevTools();
                    else
                        remote.getCurrentWindow().openDevTools();
                },
                enabled: true
            },
            {
                type: 'separator'
            },
            {
                role: 'resetzoom',
                enabled: true
            },
            {
                role: 'zoomin',
                enabled: true
            },
            {
                role: 'zoomout',
                enabled: true
            },
        ]
    };
    menubar = new Menubar([
        {
            label: '&File',
            id: 'file',
            submenu: [
                {
                    label: '&New',
                    submenu: [
                        {
                            label: '&File',
                            accelerator: "CmdOrCtrl+N",
                            click: () => { newFile(); }
                        },
                        { type: 'separator' },
                        {
                            label: '&Area...',
                            //accelerator: "CmdOrCtrl+N",
                            click: newArea
                        },
                        {
                            label: '&Virtual area...',
                            //accelerator: "CmdOrCtrl+N",
                            click: newVirtualArea
                        },
                        /*
                        {
                            label: 'Area &design...',
                            //accelerator: "CmdOrCtrl+N",
                            click: newAreaDesign
                        },
                        */
                        { type: 'separator' },
                        {
                            label: '&Room...',
                            //accelerator: "CmdOrCtrl+N",
                            click: roomWizard
                        },
                        {
                            label: '&Monster...',
                            //accelerator: "CmdOrCtrl+N",
                            click: monsterWizard
                        },
                        { type: 'separator' },
                        {
                            label: '&Templates',
                            submenu: menuTemplates
                        }
                    ]
                },
                { type: 'separator' },
                {
                    label: '&Open...',
                    accelerator: "CmdOrCtrl+O",
                    click: () => { openFile(); }
                },
                {
                    label: 'Op&en Remote...',
                    accelerator: "CmdOrCtrl+Shift+O",
                    click: () => { openRemote(); },
                    enabled: false
                },
                {
                    label: 'Open &Recent',
                    submenu: [],
                },
                { type: 'separator' },
                {
                    label: '&Save',
                    accelerator: "CmdOrCtrl+S",
                    click: () => { saveFile(); },
                    enabled: false
                },
                {
                    label: 'Save &As...',
                    accelerator: "CmdOrCtrl+Shift+S",
                    click: () => { saveFileAs(); },
                    enabled: false,
                },
                {
                    label: 'Save A&ll',
                    accelerator: "CmdOrCtrl+Alt+S",
                    click: () => { saveAllFiles(); },
                    enabled: false
                },
                { type: 'separator' },
                {
                    label: '&Upload',
                    accelerator: "CmdOrCtrl+U",
                    click: () => { uploadFile(); },
                    enabled: false,
                },
                {
                    label: 'Up&load As...',
                    accelerator: "CmdOrCtrl+Alt+U",
                    click: () => { uploadFileAs(); },
                    enabled: false,
                },
                { type: 'separator' },
                {
                    label: '&Preferences...',
                    accelerator: "CmdOrCtrl+Comma",
                    click: () => {
                        window.open('code.editor.prefs.html', 'modal', 'backgroundColor=#fff,height=465,width=800,icon=' + path.join(__dirname, '../assets/icons/png/preferences.png'));
                    }
                },
                { type: 'separator' },
                {
                    label: '&Diff',
                    submenu: [
                        {
                            label: '&Clear',
                            click: () => {
                                var pane = manager.panes.indexOf(manager.activePane);
                                if (manager.active.editor.diff)
                                    manager.active.editor.deactivate(window.$dEditors[pane]);
                                manager.active.editor.diff = null;
                                if (manager.active.diffFile)
                                    stopWatchFile(manager.active.diffFile);
                                manager.active.diffFile = null;
                                window.$dEditors[pane].modifiedEditor.domElement.parentElement.parentElement.style.display = '';
                                toggleDiffNav(false);
                                window.$editors[pane].domElement.style.display = 'block';
                                manager.active.editor.activate(window.$editors[pane]);
                                window.$editors[pane].layout();
                                doUpdate(2);
                            },
                            enabled: false
                        },
                        {
                            label: '&Original',
                            click: () => {
                                var pane = manager.panes.indexOf(manager.activePane);
                                if (!manager.active.editor.diff)
                                    manager.active.editor.deactivate(window.$editors[pane]);
                                manager.active.editor.diff = manager.active.editor.read();
                                manager.active.diffFile = manager.active.editor.file;
                                watchFile(manager.active.diffFile);
                                window.$dEditors[pane].modifiedEditor.domElement.parentElement.parentElement.style.display = 'block';
                                toggleDiffNav(true);
                                window.$editors[pane].domElement.style.display = '';
                                manager.active.editor.activate(window.$dEditors[pane]);
                                window.$dEditors[pane].layout();
                                doUpdate(2);
                            },
                            enabled: false
                        },
                        {
                            label: '&Local...',
                            click: () => {
                                dialog.showOpenDialog(remote.getCurrentWindow(),
                                    {
                                        filters: $fileFilters,
                                        properties: ['openFile'],
                                        defaultPath: (manager.active && manager.active.editor) ? path.dirname(manager.active.editor.file) : (options.recent && options.recent.length ? path.dirname(options.recent[0].file) : '')
                                    },
                                    function (fileNames) {
                                        if (fileNames === undefined) {
                                            return;
                                        }
                                        var pane = manager.panes.indexOf(manager.activePane);
                                        if (!manager.active.editor.diff)
                                            manager.active.editor.deactivate(window.$editors[pane]);
                                        if (manager.active.diffFile)
                                            stopWatchFile(manager.active.diffFile);
                                        manager.active.editor.diff = manager.active.editor.read(fileNames[0]);
                                        manager.active.diffFile = fileNames[0];
                                        watchFile(manager.active.diffFile);
                                        window.$dEditors[pane].modifiedEditor.domElement.parentElement.parentElement.style.display = 'block';
                                        toggleDiffNav(true);
                                        window.$editors[pane].domElement.style.display = '';
                                        manager.active.editor.activate(window.$dEditors[pane]);
                                        window.$dEditors[pane].layout();
                                        doUpdate(2);
                                    });
                            },
                            enabled: false
                        },
                        {
                            label: '&Remote...',
                            click: () => {
                                showBrowseDialog({
                                    defaultFile: manager.active.editor.remote,
                                    properties: ['openFile'],
                                    filters: $fileFilters,
                                }, (files) => {
                                    if (!files || files.length === 0) return;
                                    var t = tmp.tmpNameSync(tmpOptions);
                                    _ied.downloadToFile(files[0], t, false, 'editor-download:diffRemote:' + (manager.active ? manager.active.id : 0), false);
                                    showProgressDialog({
                                        file: files[0],
                                        tag: 'editor-download:diffRemote:' + (manager.active ? manager.active.id : 0),
                                        title: 'Downloading&hellip;',
                                        tmp: t
                                    });
                                });
                            },
                            enabled: false
                        },

                    ]
                },
                { type: 'separator' },
                {
                    label: 'Re&vert',
                    click: () => { revertFile(); },
                    enabled: false
                },
                {
                    label: 'Rever&t All',
                    click: () => { revertAllFiles(); },
                    enabled: false
                },
                { type: 'separator' },
                {
                    label: '&Close',
                    click: () => { closeFile(); },
                    accelerator: "CmdOrCtrl+F4",
                    enabled: false
                },
                {
                    label: 'C&lose All',
                    click: () => { closeAllFiles(); },
                    accelerator: "CmdOrCtrl+Shift+F4",
                    enabled: false
                },
                { type: 'separator' },
                {
                    label: 'E&xit',
                    accelerator: "CmdOrCtrl+Shift+W",
                    click: () => { window.close(); }
                }
            ]
        },
        {
            label: '&Edit',
            submenu: subMenus['edit']
        },
        {
            label: '&View',
            submenu: subMenus['view']
        },
        {
            label: '&Help',
            role: 'help',
            id: 'help',
            submenu: [
                {
                    label: '&Immortal',
                    click: () => {
                        shell.openExternal("http://www.shadowmud.com/tutorial", '_blank');
                    },
                    enabled: true
                },
                { type: 'separator' },
                {
                    label: '&Code editor',
                    click: () => {
                        shell.openExternal("https://github.com/icewolfz/jiMUD/tree/master/docs/codeeditor.md", '_blank');
                    },
                    enabled: true
                },
                {
                    label: '&jiMUD',
                    click: () => {
                        shell.openExternal("https://github.com/icewolfz/jiMUD/tree/master/docs", '_blank');
                    },
                    enabled: true
                },
                { type: 'separator' },
                {
                    label: 'Check for updates...',
                    click: () => {
                        ipcRenderer.send('check-for-updates');
                    },
                    enabled: true
                },
                { type: 'separator' },
                {
                    label: '&About...',
                    click: () => {
                        ipcRenderer.send('show-window', 'about');
                    },
                    enabled: true
                }
            ]
        }
    ]);
    menubar.enabled = false;
    var manager = new DockManager();
    var dock = $(".dock-manager");
    var toolbar = $('#toolbar');
    manager.hideTabstrip = false;
    manager.on('add', (e) => {
        if (e.panel && e.panel.editor)
            e.panel.editor.resize();
    });
    manager.on('tab-strip-shown', () => {
        doUpdate(128);
    });
    manager.on('add-pane', (idx, pane) => {
        var el = document.createElement('div');
        el.classList.add('editor-container');
        pane.pane.appendChild(el);
        var editor = monaco.editor.create(el, {
            language: 'lpc',
            autoIndent: true,
            rulers: [80],
            contextmenu: false,
            theme: 'lpcTheme',
            model: null
        });
        initEditor(editor);
        window.$editors.splice(idx, 0, editor);
        el = document.createElement('div');
        el.classList.add('diff-container');
        pane.pane.appendChild(el);
        editor = monaco.editor.createDiffEditor(el, {
            language: 'lpc',
            autoIndent: true,
            rulers: [80],
            contextmenu: false,
            theme: 'lpcTheme',
            model: null
        });
        initEditor(editor);
        window.$dEditors.splice(idx, 0, editor);
        var nav = monaco.editor.createDiffNavigator(editor, {
            followsCaret: true, // resets the navigator state when the user selects something in the editor
            ignoreCharChanges: true // jump from line to line
        });
        window.$dNavs.splice(idx, 0, nav);
        doUpdate(128);
    });
    manager.on('destroy-pane', (idx) => {
        window.$editors[idx].dispose();
        window.$editors.splice(idx, 1);
        window.$dEditors[idx].dispose();
        window.$dEditors.splice(idx, 1);
        window.$dNavs[idx].dispose();
        window.$dNavs.splice(idx, 1);
        if (idx === 0)
            window.$editor = window.$editors[0];
        doUpdate(128);
    });
    manager.on('tab-moved', (e) => {
        if (e.panel && e.panel.editor)
            e.panel.editor.focus();
    });
    manager.on('remove', (e) => {
        if (e.panel.editor.changed || e.panel.editor.new) {
            e.cancel = !confirmSave(e.panel);
        }
    });
    manager.on('removed', (e, pane) => {
        closeEditor(e.panel);
        if (manager.panes[pane].panels.length === 0) {
            window.$dEditors[pane].modifiedEditor.domElement.parentElement.parentElement.style.display = '';
            window.$editors[pane].domElement.style.display = '';
            toggleDiffNav(false);
        }
        doUpdate(1);
    });
    manager.on('dock-changed', (e, pane, oPane) => {
        if (manager.panes[oPane].panels.length === 0) {
            window.$editors[oPane].domElement.style.display = '';
            window.$dEditors[pane].modifiedEditor.domElement.parentElement.parentElement.style.display = '';
            toggleDiffNav(false);
        }
        doUpdate(129);
    });
    manager.on('resize', () => {
        if (!window.$editors) return;
        var ed = window.$editors.length;
        while (ed--) {
            window.$editors[ed].layout();
            window.$dEditors[ed].layout();
        }
    });
    manager.on('activated', (e, pane) => {
        if (e.panel.editor) {
            if (e.panel.editor.type === 1) {
                if (e.panel.editor.diff) {
                    window.$dEditors[pane].modifiedEditor.domElement.parentElement.parentElement.style.display = 'block';
                    window.$editors[pane].domElement.style.display = '';
                    e.panel.editor.activate(window.$dEditors[pane]);
                    window.$dEditors[pane].layout();
                    toggleDiffNav(true);
                }
                else {
                    window.$editors[pane].domElement.style.display = 'block';
                    window.$dEditors[pane].modifiedEditor.domElement.parentElement.parentElement.style.display = '';
                    e.panel.editor.activate(window.$editors[pane]);
                    window.$editors[pane].layout();
                    toggleDiffNav(false);
                }
            }
            else {
                window.$editors[pane].domElement.style.display = '';
                window.$dEditors[pane].modifiedEditor.domElement.parentElement.parentElement.style.display = '';
                e.panel.editor.activate();
                toggleDiffNav(false);
            }
            setTimeout(() => { e.panel.editor.focus(); }, 50);
        }
        else {
            window.$editors[pane].domElement.style.display = '';
            window.$dEditors[pane].modifiedEditor.domElement.parentElement.parentElement.style.display = '';
            toggleDiffNav(false);
        }
        doUpdate(1);
    });
    manager.on('pane-activated', () => {
        doUpdate(1);
    });
    manager.on('deactivated', (e, pane) => {
        if (e.panel.editor.type === 1) {
            if (e.panel.editor.diff)
                e.panel.editor.deactivate(window.$dEditors[pane]);
            else
                e.panel.editor.deactivate(window.$editors[pane]);
            toggleDiffNav(false);
        }
        else
            e.panel.editor.deactivate();
    });
    manager.on('dragenter', (e) => {
        event.dataTransfer.dropEffect = "copy";
        event.dataTransfer.effectAllowed = "copy";
        if (e.dataTransfer.items) {
            for (var i = 0; i < e.dataTransfer.items.length; i++) {
                // If dropped items aren't files, reject them
                if (e.dataTransfer.items[i].kind === 'file') {
                    event.dataTransfer.dropEffect = "link";
                    event.dataTransfer.effectAllowed = "link";
                    event.preventDefault();
                    event.cancelBubble = true;
                    event.stopPropagation();
                    return false;
                }
            }
        }
        else if (e.dataTransfer.files && e.dataTransfer.files.length) {
            event.dataTransfer.dropEffect = "link";
            event.dataTransfer.effectAllowed = "link";
            event.preventDefault();
            event.cancelBubble = true;
            event.stopPropagation();
            return false;
        }
    });
    manager.on('dragover', (e) => {
        event.dataTransfer.dropEffect = "copy";
        event.dataTransfer.effectAllowed = "copy";
        if (e.dataTransfer.items) {
            for (var i = 0; i < e.dataTransfer.items.length; i++) {
                // If dropped items aren't files, reject them
                if (e.dataTransfer.items[i].kind === 'file') {
                    event.dataTransfer.dropEffect = "link";
                    event.dataTransfer.effectAllowed = "link";
                    event.preventDefault();
                    event.cancelBubble = true;
                    event.stopPropagation();
                    return false;
                }
            }
        }
        else if (e.dataTransfer.files && e.dataTransfer.files.length) {
            event.dataTransfer.dropEffect = "link";
            event.dataTransfer.effectAllowed = "link";
            event.preventDefault();
            event.cancelBubble = true;
            event.stopPropagation();
            return false;
        }
    });
    manager.on('drop', (e) => {
        var files = [];
        var f, fl;
        if (e.dataTransfer.items) {
            for (var i = 0; i < e.dataTransfer.items.length; i++) {
                // If dropped items aren't files, reject them
                if (e.dataTransfer.items[i].kind === 'file')
                    files.push(e.dataTransfer.items[i].getAsFile());
            }
        }
        else if (e.dataTransfer.files && e.dataTransfer.files.length) {
            for (f = 0, fl = e.dataTransfer.files.length; f < fl; f++)
                files.push(e.dataTransfer.files[f]);
        }
        if (files.length) {
            files = files.filter(f => !f.path.startsWith('/jiMUDPath:') && !f.path.startsWith('jiMUDPath://') && !isDirSync(f.path));
            if (files.length === 0) {
                event.preventDefault();
                event.cancelBubble = true;
                event.stopPropagation();
                return;
            }
            files = files.map(f => {
                if (f.path.startsWith('jiMUD://')) {
                    return {
                        remote: f.path.substring(8),
                        remoteEdit: true
                    };
                }
                else if (f.path.startsWith('/jiMUD:')) {
                    return {
                        remote: f.path.substring(7),
                        remoteEdit: true
                    };
                }
                else
                    return { file: f.path };
            });
            event.preventDefault();
            event.cancelBubble = true;
            event.stopPropagation();
            openFiles(files);
        }
        //else
        //manager.active.editor.focus();
    });
    manager.on('tab-contextmenu', (e) => {
        var temp = [];
        if (e.panel.editor.supports('refresh')) {
            temp.push({
                label: 'Refresh',
                click: () => {
                    e.panel.editor.refresh();
                    e.panel.editor.focus();
                },
                accelerator: "F5"
            });
        }
        if (temp.length)
            temp.push({ type: 'separator' });
        temp.push({
            label: '&Copy path',
            click: () => {
                clipboard.writeText(e.panel.editor.file || '');
                clipboard.writeText(e.panel.editor.file || '', 'selection');
            }
        });
        if (e.panel.editor.remote && e.panel.editor.remote.length > 0)
            temp.push({
                label: '&Copy remote path',
                click: () => {
                    clipboard.writeText(e.panel.editor.remote || '');
                    clipboard.writeText(e.panel.editor.remote || '', 'selection');
                }
            });
        temp.push({ type: 'separator' });
        if (e.panel.editor.changed) {
            temp.push({
                label: '&Save',
                accelerator: "CmdOrCtrl+S",
                click: () => { saveFile(e.panel); }
            });
        }
        temp.push({
            label: 'Save &As',
            accelerator: "CmdOrCtrl+Shift+S",
            click: () => { saveFileAs(e.panel); },
        });
        if (e.panel.editor.changed) {
            if (temp.length)
                temp.push({ type: 'separator' });
            temp.push({
                label: 'Revert',
                click: () => { revertFile(e.panel); }
            });
        }
        if (e.panel.editor.supports('menu|tab-context')) {
            temp.push({ type: 'separator' });
            temp = temp.concat(e.panel.editor.menu('tab-context'));
        }
        if (temp.length)
            temp.push({ type: 'separator' });
        temp.push({
            label: '&Close',
            click: () => { closeFile(e.panel); },
            accelerator: "CmdOrCtrl+F4"
        });
        if (manager.panels.length > 1)
            temp.push({
                label: '&Close Others',
                click: () => { manager.removeAllPanels(e.panel); }
            });
        if (manager.panels.length - 1 > manager.getPanelIndex(e.panel))
            temp.push({
                label: '&Close to the Right',
                click: () => { manager.removeAllPanelsAfter(e.panel); }
            });
        let tabMenu = Menu.buildFromTemplate(temp);
        tabMenu.popup({ window: remote.getCurrentWindow() });
    });

    function updatePanel(panel) {
        panel.tab.classList.remove('new');
        panel.tab.classList.remove('changed');
        if (panel.editor.new)
            panel.tab.classList.add('new');
        else if (panel.editor.changed)
            panel.tab.classList.add('changed');
    }

    function updateUI() {
        var enabled = (manager.active && manager.active.editor) ? true : false;
        if (enabled)
            document.title = 'Code Editor - ' + manager.active.tab.innerText;
        else
            document.title = 'Code Editor';
        $("#btn-close").prop('disabled', !enabled);
        $("#btn-close-all").prop('disabled', !enabled);
        menubar.updateItem('File|Close', { enabled: enabled });
        menubar.updateItem('File|Close all', { enabled: enabled });
        menubar.updateItem('File|save as...', { enabled: enabled });
        menubar.updateItem('file|diff|local...', { enabled: enabled && manager.active.editor.supports('diff') });
        menubar.updateItem('file|diff|remote...', { enabled: connected && enabled && manager.active.editor.supports('diff') });
        menubar.updateItem('file|upload', { enabled: connected && enabled && manager.active.editor.supports('upload') });
        menubar.updateItem('file|upload as...', { enabled: connected && enabled && manager.active.editor.supports('upload-as') });
        $("#btn-upload").prop('disabled', !(connected && enabled && manager.active.editor.supports('upload')));
        $("#btn-upload-as").prop('disabled', !(connected && enabled && manager.active.editor.supports('upload-as')));
        var buttons = document.getElementById("editor-buttons");
        while (buttons.firstChild) {
            buttons.removeChild(buttons.firstChild);
        }
        if (enabled && manager.active.editor.supports('buttons'))
            buttons.append(...manager.active.editor.buttons);
        updateMenu('edit', 12);
        updateMenu('view', 9);
        sbSize.textContent = enabled ? ('Length: ' + manager.active.editor.length.toLocaleString()) : '';
        sbMessage.textContent = '';
        sbName.textContent = enabled ? (manager.active.editor.source === Source.local ? manager.active.editor.file : manager.active.editor.remote) : '';
        sbName.title = enabled ? (manager.active.editor.source === Source.local ? manager.active.editor.file : manager.active.editor.remote) : '';
        if (enabled && manager.active.editor.type === 1) {
            var l = manager.active.editor.location;
            sbLocation.textContent = enabled ? (`Ln ${l[1]}, Col ${l[0]}`) : 'Ln 0, Col 0';
        }
        else
            sbLocation.textContent = '';
        if (enabled && manager.active.editor.updateUI) manager.active.editor.updateUI();
        var tbh = toolbar.outerHeight();
        dock.css('top', tbh + 'px');
        doUpdate(2);
    }

    function updateMenu(menu, length) {
        var items = subMenus[menu].slice(0, length);
        if (manager.active && manager.active.editor && manager.active.editor.supports('menu|' + menu)) {
            var cItems = manager.active.editor.menu(menu);
            if (cItems && cItems.length) {
                items.push({ type: 'separator' });
                items = items.concat(cItems);
            }
        }
        menubar.updateItem(menu, { submenu: items });
    }

    function updateUIChange() {
        var changed = (manager.active && manager.active.editor) ? (manager.active.editor.changed || manager.active.editor.new) : false;
        var changedAll = false;
        var revertAll = false;
        var keys = Object.keys(_editors);
        var k = keys.length;
        var p;
        while (k--) {
            //no editor or of not changed and new try next
            p = keys[k];
            if (!_editors[p] || (!_editors[p].editor.changed && !_editors[p].editor.new))
                continue;
            changedAll = true;
            if (_editors[p].editor.changed)
                revertAll = true;
            if (revertAll && changedAll)
                break; //do not need to check all as soon as one has been found
        }
        $("#btn-save").prop('disabled', !changed);
        menubar.updateItem('file|save', { enabled: changed });
        $("#btn-save-all").prop('disabled', !changedAll);
        menubar.updateItem('file|save all', { enabled: changedAll });
        menubar.updateItem('file|diff|clear', { enabled: (manager.active && manager.active.editor) ? (manager.active.editor.diff !== null && manager.active.editor.supports('diff')) : false });
        menubar.updateItem('file|diff|original', { enabled: (manager.active && manager.active.editor) ? (manager.active.editor.diff === null && !manager.active.editor.new && manager.active.editor.changed && manager.active.editor.supports('diff')) : false });

        menubar.updateItem('file|revert', { enabled: (manager.active && manager.active.editor) ? (manager.active.editor.changed) : false });
        menubar.updateItem('file|revert all', { enabled: revertAll });

        $("#btn-undo").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('undo') : true);
        menubar.updateItem('edit|undo', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('undo') : false });
        $("#btn-redo").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('redo') : true);
        menubar.updateItem('edit|redo', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('redo') : false });

        $("#btn-cut").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('cut') : true);
        menubar.updateItem('edit|cut', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('cut') : false });
        $("#btn-copy").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('copy') : true);
        menubar.updateItem('edit|copy', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('copy') : false });
        $("#btn-editor").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('paste-advanced') : true);
        menubar.updateItem('edit|paste to advanced editor', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('paste-advanced') : false });
        $("#btn-paste").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('paste') : true);
        menubar.updateItem('edit|paste', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('paste') : false });
        $("#btn-find").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('find') : true);
        menubar.updateItem('edit|find', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('find') : false });
        $("#btn-replace").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('replace') : true);
        menubar.updateItem('edit|replace', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('replace') : false });
        $("#btn-refresh").prop('disabled', (manager.active && manager.active.editor) ? !manager.active.editor.supports('refresh') : true);
        menubar.updateItem('view|refresh', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('refresh') : false });
        menubar.updateItem('edit|select all', { enabled: (manager.active && manager.active.editor) ? manager.active.editor.supports('selectall') : false });
    }

    function createWatcher() {
        if (watcher)
            watcher.close();
        watcher = chokidar.watch('', {
            persistent: true,
            depth: 0,
            ignoreInitial: true
        });
        watcher.unwatch('');

        // Something to use when events are received.
        var log = console.log.bind(console);
        watcher
            .on('error', error => {
                if (options.debug)
                    console.error(`Watcher error: ${error}`);
            })
            .on('ready', () => {
                if (options.debug)
                    log('Initial scan complete. Ready for changes');
            })
            .on('add', (file, stats) => {
                if (options.debug) {
                    log(`File ${file} has been added`);
                    log(stats);
                }
                fireWatch('add', file, stats);
            })
            .on('change', (file, stats) => {
                if (options.debug) {
                    log(`File ${file} has been changed`);
                    log(stats);
                }
                if (stats.birthtimeMs === stats.mtimeMs)
                    return;
                fireWatch('change', file, stats);
            })
            .on('unlink', file => {
                if (options.debug)
                    log(`File ${file} has been removed`);
                fireWatch('unlink', file);
            })
            .on('raw', (event, file, details) => {
                if (options.debug)
                    log('Raw event info:', event, file, details);
                fireWatch('raw', file, details);
            });
    }

    function fireWatch(event, file, args) {
        if (_opening[file]) return;
        var keys = Object.keys(_editors);
        var k = keys.length;
        var p;
        var choice;
        while (k--) {
            p = keys[k];
            //no editor or of not changed and new try next
            if (!_editors[p])
                continue;
            _editors[p].editor.watch(event, file, args);
            if (_editors[p] && _editors[p].diffFile === file) {
                if (event === 'unlink') {
                    choice = dialog.showMessageBox(
                        remote.getCurrentWindow(),
                        {
                            type: 'question',
                            title: 'File deleted',
                            message: path.basename(file) + ' has been deleted, clear diff?',
                            buttons: ['Yes', 'No'],
                            defaultId: 1
                        });
                    //no
                    if (choice === 1) {
                        var pane = manager.panes.indexOf(_editors[p].pane);
                        var a = _editors[p].pane.active == _editors[p];
                        if (a && _editors[p].editor.diff)
                            _editors[p].editor.deactivate(window.$dEditors[pane]);
                        _editors[p].editor.diff = null;
                        if (_editors[p].diffFile)
                            stopWatchFile(_editors[p].diffFile);
                        _editors[p].diffFile = null;
                        if (a) {
                            window.$dEditors[pane].modifiedEditor.domElement.parentElement.parentElement.style.display = '';
                            window.$editors[pane].domElement.style.display = 'block';
                            toggleDiffNav(false);
                            _editors[p].editor.activate(window.$editors[pane]);
                            window.$editors[pane].layout();
                            doUpdate(2);
                        }
                    }
                }
                else if (event !== 'raw') {
                    choice = dialog.showMessageBox(
                        remote.getCurrentWindow(),
                        {
                            type: 'question',
                            title: 'File changed',
                            message: path.basename((file || p.editor.file) + ' has been changed, reload diff?'),
                            buttons: ['Yes', 'No'],
                            defaultId: 1
                        });
                    //yes
                    if (choice === 0)
                        _editors[p].editor.diff = manager.active.editor.read(file);
                }
            }
        }
    }

    // eslint-disable-next-line no-unused-vars
    function closing() {
        if (watcher)
            watcher.close();
    }

    function loadOptions() {
        options = EditorSettings.load(parseTemplate(path.join('{data}', 'editor.json')));
        if (!options.outputSize || options.outputSize < 170)
            options.outputSize = 170;
        if (!options.maxRecent)
            options.maxRecent = 15;
        try {
            if (!spellchecker && options.spellchecking)
                spellchecker = require('spellchecker');
        }
        catch (ex) {
            ipcRenderer.send('error', ex);
        }
        if (_ready) {
            var e = window.$editors.length;
            while (e--) {
                window.$editors[e].updateOptions(options.editorOptions);
                window.$dEditors[e].updateOptions(options.editorOptions);
            }
        }
        output.css('height', (options.outputSize - 20) + 'px');
        if (options.output) {
            dock.css('bottom', options.outputSize + 'px');
            output.css('display', 'block');
        }
        else {
            dock.css('bottom', '');
            output.css('display', 'none');
        }
        menubar.updateItem('view|output', { checked: options.output });
        doUpdate(4);
    }

    function saveOptions() {
        options.save(parseTemplate(path.join('{data}', 'editor.json')));
        ipcRenderer.send('editor-settings-reload');
    }

    function getFileIcon(file) {
        switch (path.extname(file)) {
            case ".pdf":
                return 'fa fa-file-pdf-o';
            case ".xls":
            case ".xlt":
            case ".xlm":
            case ".xlsx":
            case ".xlsm":
            case ".xltx":
            case ".xltm":
                return 'fa fa-file-excel-o';
            case ".doc":
            case ".dot":
            case ".wbk":
            case ".docx":
            case ".docm":
            case ".dotx":
            case ".dotm":
            case ".docb":
                return 'fa fa-file-word-o';
            case ".ppt":
            case ".pot":
            case ".pps":
            case ".pptx":
            case ".pptm":
            case ".potx":
            case ".potm":
            case ".ppam":
            case ".ppsx":
            case ".ppsm":
            case ".sldx":
            case ".sldm":
                return 'fa fa-file-powerpoint-o';
            case ".png":
            case ".gif":
            case ".jpg":
            case ".ico":
            case ".svg":
            case ".webp":
                return 'fa fa-file-image-o';
            case ".m4a":
            case ".wav":
            case ".mp3":
            case ".flac":
                return 'fa fa-file-audio-o';
            case ".avi":
            case ".mpg":
            case ".mov":
            case ".webm":
            case ".oog":
            case ".mkv":
                return 'fa fa-file-video-o';
            case ".7z":
            case ".zip":
            case ".rar":
            case ".jar":
                return 'fa fa-file-archive-o';
            case ".txt":
                return 'fa fa-file-text-o';
            case ".o":
            case ".csv":
                return 'fa fa-file-o icon-o';
            case ".h":
                return 'fa fa-file-code-o icon-h';
            case ".c":
                return 'fa fa-file-code-o icon-c';
            case ".map":
                return 'fa fa-map-o';
        }
        return 'fa fa-file-o';
    }

    // eslint-disable-next-line no-unused-vars
    function childClosed(url, name) {
    }

    function clearButton(id) {
        $(id).removeClass('open');
        $(id).blur();
    }

    function doCut() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('cut'))
            manager.active.editor.cut();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doCopy() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('copy'))
            manager.active.editor.copy();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doPaste() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('paste'))
            manager.active.editor.paste();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doEditor() {
        if (!manager.active || !manager.active.editor || !manager.active.editor.supports('copy'))
            return;
        ipcRenderer.send('send-editor', manager.active.editor.selected, 'editor', true);
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doRedo() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('redo'))
            manager.active.editor.redo();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doUndo() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('undo'))
            manager.active.editor.undo();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function doFind() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('find'))
            manager.active.editor.find();
    }

    function doReplace() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('replace'))
            manager.active.editor.replace();
    }

    function doRefresh() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('refresh'))
            manager.active.editor.refresh();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function toggleOutput() {
        if (options.output)
            options.output = false;
        else
            options.output = true;
        menubar.updateItem('view|output', { checked: options.output });
        output.css('height', (options.outputSize - 20) + 'px');
        if (options.output) {
            dock.css('bottom', options.outputSize + 'px');
            output.css('display', 'block');
        }
        else {
            dock.css('bottom', '');
            output.css('display', 'none');
        }
        $(window).trigger('resize');
        doUpdate(16);
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    // eslint-disable-next-line no-unused-vars
    function doClearOutput() {
        outputDisplay.empty();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    // eslint-disable-next-line no-unused-vars
    function closeOutput() {
        options.output = false;
        menubar.updateItem('view|output', { checked: options.output });
        dock.css('bottom', '');
        output.css('display', 'none');
        $(window).trigger('resize');
        doUpdate(16);
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function logOutput(text, open) {
        if (!text || text.length === 0)
            return;
        if (open && !options.output)
            toggleOutput();
        outputDisplay.append('<div>' + text + '</div>');
        outputDisplay[0].scrollTop = outputDisplay[0].scrollHeight;
    }

    function filterBrowseDialog() {
        if ($dialog.options.properties.indexOf('openDirectory') !== -1) {
            $dialog.datagrid.rows = $dialog.files.filter(f => {
                return f.size === -2;
            });
        }
        else if ($dialog.options.filters && $dialog.currentFilter > -1 && $dialog.currentFilter < $dialog.options.filters.length) {
            let filters = $dialog.options.filters[$dialog.currentFilter];
            $dialog.datagrid.rows = $dialog.files.filter(f => {
                if (f.size === -2)
                    return true;
                var e = path.extname(f.file).substr(1);
                if (!filters.extensions || filters.extensions.length === 0 || filters.extensions.indexOf('*') !== -1)
                    return true;
                return filters.extensions.indexOf(e) !== -1;
            });
        }
        else
            $dialog.datagrid.rows = $dialog.files;

    }

    //https://github.com/electron/electron/blob/master/docs/api/dialog.md
    function showBrowseDialog(ops, callback) {
        if (typeof ops === 'function') {
            callback = ops;
            ops = {};
        }
        ops = Object.assign({ title: 'Open remote file', properties: ['openFile', 'multiSelections'] }, ops || {});
        if (ops.properties.indexOf('saveFile') !== -1 && ops.title === 'Open remote file')
            ops.title = 'Save remote file';
        if (ops.defaultFile)
            options.remote = path.dirname(ops.defaultFile || '') || options.remote;
        else if (ops.defaultPath && ops.properties.indexOf('openDirectory') !== -1)
            options.remote = path.dirname(ops.defaultPath || '') || options.remote;
        else
            options.remote = ops.defaultPath || options.remote;
        saveOptions();

        if (!$dialog) {
            $dialog = {
                el: document.getElementById('remoteBrowse'),
                datagrid: new DataGrid(document.getElementById('remoteBrowseList')),
                ok: document.getElementById('remoteBrowseOk'),
                options: ops,
                title: document.getElementById('remoteBrowseTitle'),
                files: [],
                path: document.getElementById('remote-path'),
                up: document.getElementById('btn-remote-up'),
                current: options.remote,
                nav: document.getElementById('remote-navigate'),
                filter: document.getElementById('remoteBrowseFilter')
            };
            $dialog.datagrid.on('contextmenu', e => e.preventDefault());
            $dialog.up.addEventListener('click', () => {
                _ied.getDir(path.dirname($dialog.path.value || ''), true, 'remoteBrowse');
            });
            $dialog.path.addEventListener('change', () => {
                _ied.getDir($dialog.path.value, true, 'remoteBrowse');
            });
            $dialog.path.addEventListener('keyup', e => {
                if (e.which === 27)
                    _ied.getDir($dialog.current, false, 'remoteBrowse');
                e.preventDefault();
                e.stopPropagation();
            });
            $dialog.path.addEventListener('focus', () => {
                $dialog.path.select();
            });

            document.getElementById('remoteBrowseFile').addEventListener('change', () => {
                if (document.getElementById('remoteBrowseFile').value.length > 0 || ($dialog.options.properties.indexOf('openDirectory') !== -1 && $dialog.options.properties.indexOf('openFile') === -1 && $dialog.options.properties.indexOf('saveFile') === -1))
                    $dialog.ok.removeAttribute('disabled');
                else
                    $dialog.ok.setAttribute('disabled', 'true');
            });
            document.getElementById('remoteBrowseFile').addEventListener('input', () => {
                if (document.getElementById('remoteBrowseFile').value.length > 0 || ($dialog.options.properties.indexOf('openDirectory') !== -1 && $dialog.options.properties.indexOf('openFile') === -1 && $dialog.options.properties.indexOf('saveFile') === -1))
                    $dialog.ok.removeAttribute('disabled');
                else
                    $dialog.ok.setAttribute('disabled', 'true');
            });
            $dialog.nav.addEventListener('click', (e) => {
                e.preventDefault();
                e.cancelBubble = true;
                _ied.getDir(e.target.dataset.path, true, 'remoteBrowse');
                if (document.querySelector('.input-group-btn.open'))
                    document.querySelector('.input-group-btn.open').classList.remove('open');
                $dialog.datagrid.focus();
            });
            $dialog.datagrid.selectionSearchField = 'file';
            $dialog.datagrid.on('focus', () => {
                if (document.querySelector('.input-group-btn.open'))
                    document.querySelector('.input-group-btn.open').classList.remove('open');
            });
            $dialog.datagrid.allowMultipleSelection = ops.properties.indexOf('multiSelections') !== -1;
            $dialog.datagrid.columns = [
                {
                    label: 'Name',
                    field: 'file',
                    spring: true,
                    width: 200,
                    sort: (a, b, dir, prop, dataA, dataB) => {
                        if (dataA.size === -2 && dataB.size !== -2)
                            return -1 * dir;
                        if (dataA.size !== -2 && dataB.size === -2)
                            return 1 * dir;
                        if (dataA.file > dataB.file)
                            return 1 * dir;
                        if (dataA.file < dataB.file)
                            return -1 * dir;
                        return 0;
                    },
                    formatter: (data) => {
                        if (data.row.size === -2)
                            return '<i class="fa fa-folder-o" style="margin-right: 2px"></i>' + data.cell;
                        switch (data.row.type.toLowerCase()) {
                            case ".pdf":
                                return '<i class="fa fa-file-pdf-o" style="margin-right: 2px"></i>' + data.cell;
                            case ".xls":
                            case ".xlt":
                            case ".xlm":
                            case ".xlsx":
                            case ".xlsm":
                            case ".xltx":
                            case ".xltm":
                                return '<i class="fa fa-file-excel-o" style="margin-right: 2px"></i>' + data.cell;
                            case ".doc":
                            case ".dot":
                            case ".wbk":
                            case ".docx":
                            case ".docm":
                            case ".dotx":
                            case ".dotm":
                            case ".docb":
                                return '<i class="fa fa-file-word-o" style="margin-right: 2px"></i>' + data.cell;
                            case ".ppt":
                            case ".pot":
                            case ".pps":
                            case ".pptx":
                            case ".pptm":
                            case ".potx":
                            case ".potm":
                            case ".ppam":
                            case ".ppsx":
                            case ".ppsm":
                            case ".sldx":
                            case ".sldm":
                                return '<i class="fa fa-file-powerpoint-o" style="margin-right: 2px"></i>' + data.cell;
                            case ".png":
                            case ".gif":
                            case ".jpg":
                            case ".ico":
                            case ".svg":
                            case ".webp":
                                return '<i class="fa fa-file-image-o" style="margin-right: 2px"></i>' + data.cell;
                            case ".m4a":
                            case ".wav":
                            case ".mp3":
                            case ".flac":
                                return '<i class="fa fa-file-audio-o" style="margin-right: 2px"></i>' + data.cell;
                            case ".avi":
                            case ".mpg":
                            case ".mov":
                            case ".webm":
                            case ".oog":
                            case ".mkv":
                                return '<i class="fa fa-file-video-o" style="margin-right: 2px"></i>' + data.cell;
                            case ".7z":
                            case ".zip":
                            case ".rar":
                            case ".jar":
                                return '<i class="fa fa-file-archive-o" style="margin-right: 2px"></i>' + data.cell;
                            case ".txt":
                                return '<i class="fa fa-file-text-o" style="margin-right: 2px"></i>' + data.cell;
                            case ".o":
                            case ".csv":
                                return '<i class="fa fa-file-o icon-o" style="margin-right: 2px"></i>' + data.cell;
                            case ".h":
                                return '<i class="fa fa-file-code-o icon-h" style="margin-right: 2px"></i>' + data.cell;
                            case ".c":
                                return '<i class="fa fa-file-code-o icon-c style="margin-right: 2px"></i>' + data.cell;

                        }
                        return '<i class="fa fa-file-o" style="margin-right: 2px"></i>' + data.cell;
                    }
                },
                {
                    label: 'Size',
                    field: 'size',
                    width: 100,
                    align: 'right',
                    formatter: (data) => {
                        if (data.cell === -2)
                            return '';
                        return formatSize(data.cell);
                    }
                },
                {
                    label: 'Type',
                    field: 'type',
                    sort: (a, b, dir, prop, dataA, dataB) => {
                        if (dataA.size === -2 && dataB.size !== -2)
                            return -1 * dir;
                        if (dataA.size !== -2 && dataB.size === -2)
                            return 1 * dir;
                        if (dataA.file > dataB.file)
                            return 1 * dir;
                        if (dataA.file < dataB.file)
                            return -1 * dir;
                        return 0;
                    }
                },
                {
                    label: 'Date Modified',
                    field: 'date',
                    width: 300,
                    sort: (a, b, dir, prop, dataA, dataB) => {
                        if (dataA.size === -2 && dataB.size !== -2)
                            return -1 * dir;
                        if (dataA.size !== -2 && dataB.size === -2)
                            return 1 * dir;
                        if (dataA.file > dataB.file)
                            return 1 * dir;
                        if (dataA.file < dataB.file)
                            return -1 * dir;
                        return 0;
                    },
                    formatter: (data) => {
                        return new moment(data.cell * 1000).format('MM/DD/YYYY hh:mm:ss A');
                    }
                }
            ];
            $dialog.datagrid.sort(0);
            $dialog.datagrid.on('row-dblclick', (e, data) => {
                e.preventDefault();
                if (!data || !data.row) return;
                let p = $dialog.current;
                if (!p.endsWith('/'))
                    p += '/';
                if (data.row.size === -2) {
                    if (connected)
                        _ied.getDir(p + data.row.file, true, 'remoteBrowse');
                    else
                        dialog.showMessageBox(
                            remote.getCurrentWindow(),
                            {
                                type: 'error',
                                title: 'Must be logged into the mud',
                                message: 'Remote browsing can only be done when connected to the mud',
                                defaultId: 1
                            });
                }
                else {
                    $dialog.el.close();
                    options.remote = $dialog.current;
                    saveOptions();
                    if (callback)
                        callback([p + data.row.file]);
                }
            });
            $dialog.datagrid.on('selection-changed', () => {
                if (this.$dialog.datagrid.selectedCount > 0) {
                    let selected = $dialog.datagrid.selected;
                    if ($dialog.options.properties) {
                        if ($dialog.options.properties.indexOf('openDirectory') !== -1 && $dialog.options.properties.indexOf('openFile') === -1 && $dialog.options.properties.indexOf('saveFile') === -1)
                            selected = selected.filter(f => f.data.size === -2);
                        else if ($dialog.options.properties.indexOf('openDirectory') === -1 && ($dialog.options.properties.indexOf('openFile') !== -1) || $dialog.options.properties.indexOf('saveFile') !== -1)
                            selected = selected.filter(f => f.data.size !== -2);
                        else if ($dialog.options.properties.indexOf('openDirectory') === -1 && $dialog.options.properties.indexOf('openFile') === -1 && $dialog.options.properties.indexOf('saveFile') === -1)
                            selected = selected.filter(f => f.data.size !== -2);
                    }
                    else
                        selected = selected.filter(f => f.data.size !== -2);
                    selected = selected.map(f => f.data.file);
                    if (selected.length === 1)
                        document.getElementById('remoteBrowseFile').value = selected[0];
                    else if (selected.length > 1)
                        document.getElementById('remoteBrowseFile').value = selected.map(f => `"${f}"`).join(' ');
                }
                if (document.getElementById('remoteBrowseFile').value.length > 0 || ($dialog.options.properties.indexOf('openDirectory') !== -1 && $dialog.options.properties.indexOf('openFile') === -1 && $dialog.options.properties.indexOf('saveFile') === -1))
                    $dialog.ok.removeAttribute('disabled');
                else
                    $dialog.ok.setAttribute('disabled', 'true');
            });
            $dialog.title.textContent = ops.title;
            $dialog.ok.addEventListener('click', () => {
                let files;
                if (document.getElementById('remoteBrowseFile').value.length === 0 && $dialog.options.properties.indexOf('openDirectory') !== -1 && $dialog.options.properties.indexOf('openFile') === -1 && $dialog.options.properties.indexOf('saveFile') === -1)
                    files = [$dialog.current];
                else {
                    files = document.getElementById('remoteBrowseFile').value.splitQuote(' ', 2);
                    let p = $dialog.current;
                    if (!p.endsWith('/'))
                        p += '/';
                    files = files.map(f => p + f);
                }
                $dialog.el.close();
                options.remote = $dialog.current;
                saveOptions();
                if (callback)
                    callback(files);
            });
            $dialog.el.addEventListener('open', () => {
                menubar.enabled = false;
            });
            $dialog.el.addEventListener('close', () => {
                menubar.enabled = true;
            });
            $dialog.el.addEventListener('cancel', () => {
                menubar.enabled = true;
            });
            $dialog.filter.addEventListener('change', () => {
                $dialog.currentFilter = $dialog.filter.selectedIndex;
                filterBrowseDialog();
            });
        }
        else {
            $dialog.options = ops;
            $dialog.title.textContent = ops.title;
            var old_element = $dialog.ok;
            var new_element = $dialog.ok.cloneNode(true);
            new_element.addEventListener('click', () => {
                let files;
                if (document.getElementById('remoteBrowseFile').value.length === 0 && $dialog.options.properties.indexOf('openDirectory') !== -1 && $dialog.options.properties.indexOf('openFile') === -1 && $dialog.options.properties.indexOf('saveFile') === -1)
                    files = [$dialog.current];
                else {
                    files = document.getElementById('remoteBrowseFile').value.splitQuote(' ', 2);
                    let p = $dialog.current;
                    if (!p.endsWith('/'))
                        p += '/';
                    files = files.map(f => p + f);
                }
                $dialog.el.close();
                options.remote = $dialog.current;
                saveOptions();
                if (callback)
                    callback(files);
            });
            old_element.parentNode.replaceChild(new_element, old_element);
            $dialog.ok = new_element;
        }
        $dialog.first = true;
        if (ops.properties.indexOf('openDirectory') !== -1) {
            document.getElementById('remoteBrowseFile-label').textContent = 'Folder:';
            $dialog.ok.textContent = 'Select Folder';
        }
        else if (ops.properties.indexOf('saveFile') !== -1) {
            $dialog.ok.textContent = 'Save';
            document.getElementById('remoteBrowseFile-label').textContent = 'File name:';
        }
        else {
            $dialog.ok.textContent = 'Open';
            document.getElementById('remoteBrowseFile-label').textContent = 'File name:';
        }
        if (ops.defaultFile)
            document.getElementById('remoteBrowseFile').value = path.basename(ops.defaultFile || '');
        $dialog.path.value = options.remote;
        if (ops.filters && ops.filters.length > 0 && (ops.properties.indexOf('openFile') !== -1 || $dialog.options.properties.indexOf('saveFile') !== -1)) {
            document.getElementById('remoteBrowseFooter').children[0].style.right = '160px';
            document.getElementById('remoteBrowseFooter').children[1].style.display = '';
            while ($dialog.filter.firstChild)
                $dialog.filter.removeChild($dialog.filter.firstChild);
            let fl = ops.filters.length;
            for (let f = 0; f < fl; f++) {
                let o = document.createElement('option');
                o.value = f;
                o.textContent = ops.filters[f].name;
                $dialog.filter.appendChild(o);
            }
            $($dialog.filter).selectpicker('refresh');
            $dialog.currentFilter = 0;
        }
        else {
            $dialog.currentFilter = -1;
            document.getElementById('remoteBrowseFooter').children[0].style.right = '5px';
            document.getElementById('remoteBrowseFooter').children[1].style.display = 'none';
        }

        $dialog.datagrid.rows = [];
        $dialog.datagrid.allowMultipleSelection = ops.properties.indexOf('multiSelections') !== -1;
        if (connected)
            _ied.getDir(options.remote, false, 'remoteBrowse');
        else
            dialog.showMessageBox(
                remote.getCurrentWindow(),
                {
                    type: 'error',
                    title: 'Must be logged into the mud',
                    message: 'Remote browsing can only be done when connected to the mud',
                    defaultId: 1
                });
    }

    function showProgressDialog(data) {
        var progress = document.getElementById('progress-dialog');
        this.$queue.push(data);
        if (progress.open) return;
        menubar.enabled = false;
        document.getElementById('progress-dialog-title').innerHTML = $queue[0].title || 'Retrieving&hellip;';
        progress.addEventListener('close', closeProgressDialog);
        progress.addEventListener('cancel', closeProgressDialog);
        document.getElementById('progress-dialog-cancel').addEventListener('click', closeProgressDialog);
        setProgressDialogValue(0);
        progress.showModal();
    }

    function setProgressDialogValue(value) {
        ipcRenderer.send('set-progress', { value: value });
        ipcRenderer.send('set-progress-window', 'code-editor', { value: value });
        document.getElementById('progress-dialog-progressbar').value = value;
    }

    function closeProgressDialog(id, saveTmp, removeItem) {
        var progress = document.getElementById('progress-dialog');
        if (id) {
            var ql = $queue.length;
            var data;
            for (var q = 0; q < ql; q++) {
                if ($queue[q].file && $queue[q].tag === id) {
                    data = $queue[q];
                    break;
                }
                else if ($queue[q].files && ($queue[q].tag + ($queue[q].files.length - 1)) === id) {
                    data = $queue[q];
                    break;
                }
            }
            if (!data) return;
            $queue.splice(q, 1);
        }
        else
            data = $queue.shift();
        if (removeItem && data.file)
            _ied.removeItem(data.tag);
        else if (removeItem && data.files) {
            var fl = data.files.length;
            for (var f = 0; f < fl; f++)
                _ied.removeItem(data.tag + f);
        }
        if (data.tmp && !saveTmp) {
            if (!Array.isArray(data.tmp))
                data.tmp = [data.tmp];
            var tl = data.tmp.length;
            for (var t = 0; t < tl; t++) {
                if (typeof data.tmp[t] === 'string') {
                    if (existsSync(data.tmp[t]))
                        fs.unlinkSync(data.tmp[t]);
                    continue;
                }
                var n = data.tmp[t].name;
                data.tmp[t].removeCallback();
                if (existsSync(n))
                    fs.unlinkSync(n);
            }
        }
        if ($queue.length === 0) {
            if (progress.open)
                progress.close();
            setProgressDialogValue(-1);
            document.getElementById('progress-dialog-progressbar').removeAttribute('value');
            menubar.enabled = true;
        }
        else {
            setProgressDialogValue(0);
            menubar.enabled = false;
            if (!progress.open)
                progress.showModal();
        }
    }

    // eslint-disable-next-line no-unused-vars
    function gotoLine(id, line) {
        if (!id) return;
        var panel = manager.findPanel(id);
        if (!panel) return;
        var dock = manager.panes.indexOf(panel.dock);
        if (dock === -1) return;
        manager.panes[dock].switchToPanel(panel);
        window.$editors[dock].setPosition({ column: 1, lineNumber: line });
        window.$dEditors[dock].setPosition({ column: 1, lineNumber: line });
    }

    function gotoNextChange() {
        if (!manager.active && !manager.active.editor && manager.active.editor.type !== 1)
            return;
        if (!manager.active && !manager.active.editor && manager.active.editor.type !== 1)
            return;
        var idx = manager.panes.indexOf(manager.active.dock);
        if (idx !== -1)
            window.$dNavs[idx].next();
    }

    function gotoPrevChange() {
        if (!manager.active && !manager.active.editor && manager.active.editor.type !== 1)
            return;
        var idx = manager.panes.indexOf(manager.active.dock);
        if (idx !== -1)
            window.$dNavs[idx].previous();
    }

    $(document).ready(() => {
        loadOptions();
        _ied = new IED();
        _ied.prefix = 'editor-';
        _ied.compressUpload = true;
        _ied.compressDownload = true;
        _ied.compressDir = true;
        _ied.on('init', () => {

        });
        _ied.on('error', (error) => {
            if (error && error.code) {
                switch (error.code) {
                    case IEDError.USER_DENIED:
                        dialog.showMessageBox(remote.getCurrentWindow(), {
                            type: 'error',
                            title: 'Permission denied',
                            message: 'Permission denied'
                        });
                        closeProgressDialog(error.tag);
                        break;
                    case IEDError.DL_NOTSTART:
                    case IEDError.DL_TOOMANY:
                    case IEDError.DL_INPROGRESS:
                        dialog.showMessageBox(remote.getCurrentWindow(), {
                            type: 'error',
                            title: 'Download error',
                            message: `Download error for '${error.path}/${error.file}': ${error.msg}`
                        });
                        closeProgressDialog(error.tag);
                        break;
                    case IEDError.DL_INVALIDFMT:
                    case IEDError.DL_UNKNOWN:
                    case IEDError.DL_USERABORT:
                    case IEDError.DL_INVALIDFILE:
                    case IEDError.DL_INVALIDPATH:
                        dialog.showMessageBox(remote.getCurrentWindow(), {
                            type: 'error',
                            title: 'Download aborted',
                            message: `Download aborted for '${error.path}/${error.file}': ${error.msg}`
                        });
                        closeProgressDialog(error.tag);
                        break;
                    case IEDError.RESET:
                        dialog.showMessageBox(remote.getCurrentWindow(), {
                            type: 'error',
                            title: 'Reset',
                            message: 'Server reset: ' + error.msg
                        });
                        closeProgressDialog(error.tag);
                        break;
                    case IEDError.USERRESET:
                        dialog.showMessageBox(remote.getCurrentWindow(), {
                            type: 'error',
                            title: 'Reset',
                            message: error.msg
                        });
                        break;
                    case IEDError.UL_TOOMANY:
                    case IEDError.UL_INPROGRESS:
                        dialog.showMessageBox(remote.getCurrentWindow(), {
                            type: 'error',
                            title: 'Upload error',
                            message: `Upload error for '${error.path}/${error.file}': ${error.msg}`
                        });
                        closeProgressDialog(error.tag);
                        break;
                    case IEDError.UL_INVALIDFMT:
                    case IEDError.UL_USERABORT:
                    case IEDError.UL_BADENCODE:
                    case IEDError.UL_TOOLARGE:
                    case IEDError.UL_FAILWRITE:
                    case IEDError.UL_UNKNOWN:
                    case IEDError.UL_INVALIDFILE:
                    case IEDError.UL_INVALIDPATH:
                    case IEDError.UL_DENIED:
                    case IEDError.UL_FILE:
                        dialog.showMessageBox(remote.getCurrentWindow(), {
                            type: 'error',
                            title: 'Upload aborted',
                            message: `Upload aborted for '${error.path}/${error.file}': ${error.msg}`
                        });
                        closeProgressDialog(error.tag);
                        break;
                    case IEDError.CMD_EXIST:
                        dialog.showMessageBox(remote.getCurrentWindow(), {
                            type: 'error',
                            title: 'Already exist',
                            message: `File or directory already exist: '${error.path}/${error.file}`
                        });
                        closeProgressDialog(error.tag);
                        break;
                    case IEDError.CMD_DIRECTORY:
                        dialog.showMessageBox(remote.getCurrentWindow(), {
                            type: 'error',
                            title: 'Is a directory',
                            message: `File is a directory: '${error.path}/${error.file}`
                        });
                        closeProgressDialog(error.tag);
                        break;
                    case IEDError.CMD_NOEXIST:
                        dialog.showMessageBox(remote.getCurrentWindow(), {
                            type: 'error',
                            title: 'Does not exist',
                            message: `File or directory does not exist: '${error.path}/${error.file}`
                        });
                        closeProgressDialog(error.tag);
                        break;
                    case IEDError.CMD_FILE:
                        dialog.showMessageBox(remote.getCurrentWindow(), {
                            type: 'error',
                            title: 'Not a directory',
                            message: `File not a directory: '${error.path}/${error.file}`
                        });
                        closeProgressDialog(error.tag);
                        break;
                    case IEDError.DIR_CANTREAD:
                        if (error.tag && error.tag === 'editor-dir:remoteBrowse')
                            _ied.getDir('.', false, 'remoteBrowse');
                        else {
                            dialog.showMessageBox(remote.getCurrentWindow(), {
                                type: 'error',
                                title: 'Can not read',
                                message: 'Can not read or permission denied'
                            });
                            closeProgressDialog(error.tag);
                        }
                        break;
                }
            }
            var msg;
            if (error.stack)
                msg = error.stack;
            else if (error instanceof TypeError)
                msg = error.name + " - " + error.message;
            else if (error instanceof Error)
                msg = error.name + " - " + error.message;
            else if (error.message)
                msg = error.message;
            else if (error.msg)
                msg = error.msg;
            else
                msg = error;
            logOutput(msg);
        });
        _ied.on('reset', () => { });
        _ied.on('dir', (dir, files, tag) => {
            if (tag.startsWith('editor-dir:remoteBrowse')) {
                $dialog.files = files;
                $dialog.path.value = dir;
                $dialog.current = dir;
                if ($dialog.options.properties.indexOf('showHiddenFiles') === -1)
                    $dialog.files = files.filter(f => f.file[0] !== '.');
                $dialog.files = files.map(f => {
                    if (f.size === -2)
                        f.type = 'Directory';
                    else
                        f.type = path.extname(f.file);
                    return f;
                });
                filterBrowseDialog();
                if ($dialog.first) {
                    $dialog.first = false;
                    if ($dialog.options.defaultFile) {
                        let idx = $dialog.datagrid.rows.indexOf(path.basename($dialog.options.defaultFile));
                        $dialog.datagrid.selectByDataIndex(idx, true);
                    }
                    else
                        $dialog.datagrid.scrollToTop();
                }
                else
                    $dialog.datagrid.scrollToTop();
                if (dir !== '/')
                    $dialog.up.removeAttribute('disabled');
                else
                    $dialog.up.setAttribute('disabled', 'true');
                while ($dialog.nav.firstChild)
                    $dialog.nav.removeChild($dialog.nav.firstChild);
                setTimeout(() => {
                    var el;
                    var paths = [];
                    var parts = dir.split('/');
                    if (dir.endsWith('/'))
                        parts.pop();
                    else
                        dir += '/';
                    var c = [];
                    var dirs = files.filter(f => f.size === -2);

                    for (var pt = 0, pl = parts.length; pt < pl; pt++) {
                        c.push(parts[pt]);
                        if (pt === 0)
                            paths.push({ path: "/", name: "/", count: pt, open: pt === pl - 1 });
                        else
                            paths.push({ path: c.join('/'), name: parts[pt], count: pt, open: pt === pl - 1 });
                    }
                    for (var d = 0, dl = dirs.length; d < dl; d++) {
                        paths.push({ path: dir + dirs[d].file, name: dirs[d].file, count: pt });
                    }

                    paths.sort(function compare(a, b) {
                        if (a.path.toUpperCase() < b.path.toUpperCase())
                            return -1;
                        if (a.path.toUpperCase() > b.path.toUpperCase())
                            return 1;
                        return 0;
                    });

                    var frag = document.createDocumentFragment();
                    for (let c = 0, cl = paths.length; c < cl; c++) {
                        el = document.createElement('li');
                        if (paths[c].drive && paths[c].open)
                            el.innerHTML = `<a href="#" class="active" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-server"></i> ${paths[c].name}</a>`;
                        else if (paths[c].drive)
                            el.innerHTML = `<a href="#" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-server"></i> ${paths[c].name}</a>`;
                        else if (paths[c].open)
                            el.innerHTML = `<a href="#" class="active" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-folder-open-o"></i> ${paths[c].name}</a>`;
                        else
                            el.innerHTML = `<a href="#" data-path="${paths[c].path}" style="padding-left: ${20 + paths[c].count * 15}px"><i class="fa fa-folder-o"></i> ${paths[c].name}</a>`;
                        frag.appendChild(el);
                    }
                    $dialog.nav.appendChild(frag);
                });
                if (!$dialog.el.open) {
                    menubar.enabled = false;
                    $dialog.el.showModal();
                }
            }
        });
        _ied.on('message', (msg) => {
            logOutput(msg);
        });
        _ied.on('add', () => {
        });
        _ied.on('remove', (item) => {
            if (!item) return;
            if (item.ID.startsWith('editor-download:remote-open:'))
                closeProgressDialog(item.ID, true);
            else
                closeProgressDialog(item.ID);
        });
        _ied.on('update', (item) => {
            if (!item) return;
            setProgressDialogValue(Math.ceil(item.percent * 100));
        });
        _ied.on('cmd', (obj) => {
            if (!obj) return;
            var id, panel, dock;
            if (obj.cmd === 'debug' && obj.tag.startsWith('editor-debug:')) {
                id = parseInt(obj.tag.substr(13));
                panel = manager.findPanel(id);
                dock = manager.panes.indexOf(panel.dock);
                logOutput('Debug data for ' + panel.editor.filename);
                var errors = obj.data.trim().split('\n');
                var el = errors.length;
                var markers = [];
                var model = window.$editors[dock].getModel();
                for (var e = 0; e < el; e++) {
                    let m;
                    let line;
                    if (m = /^line (\d+): Warning: (.*)/.exec(errors[e])) {
                        line = parseInt(m[1], 10) || 1;
                        markers.push({
                            startColumn: 1,
                            startLineNumber: line,
                            endColumn: model.getLineContent(line).length,
                            endLineNumber: line,
                            message: 'Warning: ' + m[2],
                            severity: 4 //waring
                        });
                        logOutput(`<a class="warning" href="#" onclick="gotoLine(${id}, ${line})">${panel.editor.file}: ${errors[e]}</a>`);
                    }
                    else if (m = /^line (\d+): (.*)/.exec(errors[e])) {
                        line = parseInt(m[1], 10) || 1;
                        markers.push({
                            startColumn: 1,
                            startLineNumber: line,
                            endColumn: model.getLineContent(line).length,
                            endLineNumber: line,
                            message: m[2],
                            severity: 8, //error
                        });
                        logOutput(`<a class="error href="#" onclick="gotoLine(${id}, ${line})">${panel.editor.file}: ${errors[e]}</a>`);
                    }
                    else
                        logOutput(errors[e]);
                }
                monaco.editor.setModelMarkers(model, '', markers);
                _ied.deleteFile(obj.path + '/' + obj.file);
                closeProgressDialog(obj.tag);
            }
        });
        _ied.on('download-finished', (item) => {
            if (!item) return;
            var id;
            var panel;
            var dock;
            if (item.ID.startsWith('editor-download:diffRemote:')) {
                id = parseInt(item.ID.substr(27));
                panel = manager.findPanel(id);
                dock = manager.panes.indexOf(panel.dock);
                if (!manager.active.editor.diff)
                    manager.active.editor.deactivate(window.$editors[dock]);
                if (manager.active.diffFile)
                    stopWatchFile(manager.active.diffFile);
                manager.active.editor.diff = manager.active.editor.read(item.local);
                window.$dEditors[dock].modifiedEditor.domElement.parentElement.parentElement.style.display = 'block';
                toggleDiffNav(true);
                window.$editors[dock].domElement.style.display = '';
                manager.active.editor.activate(window.$dEditors[dock]);
                window.$dEditors[dock].layout();
                closeProgressDialog(item.ID);
                doUpdate(2);
            }
            else if (item.ID.startsWith('editor-download:remote-open:')) {
                var ids = item.ID.substr(28).split(':');
                id = parseInt(ids[0]);
                if (id !== 0) {
                    panel = manager.findPanel(id);
                    openFile($queue[0].tmp, item.remote, panel ? panel.dock : null, true, $queue[0].tmp);
                }
                else
                    openFile($queue[0].tmp, item.remote, null, true, $queue[0].tmp);
                doUpdate(2);
            }
        });
        _ied.on('upload-finished', item => {
            if (!item) return;
            var id;
            var panel;
            //var dock;
            if (item.ID.startsWith('editor-upload:debug:')) {
                id = parseInt(item.ID.substr(20));
                panel = manager.findPanel(id);
                //dock = manager.panes.indexOf(panel.dock);
                setProgressDialogValue(-1);
                document.getElementById('progress-dialog-progressbar').removeAttribute('value');
                document.getElementById('progress-dialog-title').innerHTML = 'Getting debug data&hellip;';
                logOutput('Requesting debug information for ' + panel.editor.file);
                ipcRenderer.send('send-gmcp', 'IED.cmd ' + JSON.stringify({ cmd: 'debug', path: path.dirname(item.remote), file: path.basename(item.remote), tag: 'editor-debug:' + id }));
            }
        });
        $('#btm-drag-bar').mousedown(function (e) {
            e.preventDefault();
            outputDragging = true;
            var ghostBar = $('<div>',
                {
                    id: 'btm-ghost-bar',
                    css: {
                        width: output.outerWidth(),
                        top: output.offset().top,
                        left: output.offset().left
                    }
                }).appendTo('body');

            $(document).mousemove(function (e) {
                if (e.pageY < 169)
                    ghostBar.css("top", 169);
                else if (e.pageY > document.body.clientHeight - 170)
                    ghostBar.css("top", document.body.clientHeight - 170);
                else
                    ghostBar.css("top", e.pageY);
                //if (window.$editor)
                //window.$editor.layout();
            });
        });

        $('#toolbar').on('click', () => {
            if (manager.active && manager.active.editor)
                manager.active.editor.focus();
        });

        $(window).on('resize', () => {
            var tbh = toolbar.outerHeight();
            dock.css('top', tbh + 'px');
            if (output.outerHeight() < 170 && (dock.outerHeight() + tbh) > 172) {
                options.outputSize = 170;
                output.css("height", (options.outputSize - 20) + 'px');
                dock.css("bottom", options.outputSize + 'px');
                doUpdate(16);
            }
            doUpdate(128);
            if (manager.active && manager.active.editor) manager.active.editor.focus();
            if (!window.$editors) return;
            var e = window.$editors.length;
            while (e--) {
                window.$editors[e].layout();
                window.$dEditors[e].layout();
            }
        });

        $(document).mouseup(function (e) {
            if (outputDragging) {
                if (e.pageY < 170)
                    options.outputSize = document.body.clientHeight - 172;
                else if (e.pageY > document.body.clientHeight - 170)
                    options.outputSize = 170;
                else
                    options.outputSize = document.body.clientHeight - e.pageY + 2;
                output.css("height", (options.outputSize - 20) + 'px');
                dock.css("bottom", options.outputSize + 'px');
                doUpdate(16);
                $('#btm-ghost-bar').remove();
                $(document).unbind('mousemove');
                if (manager.active && manager.active.editor) manager.active.editor.focus();
                var ed = window.$editors.length;
                while (ed--) {
                    window.$editors[ed].layout();
                    window.$dEditors[ed].layout();
                }
                outputDragging = false;
            }
        });

        $('#btn-add-dropdown').click(function () {
            $(this).addClass('open');
            const pos = $(this).offset();
            const x = Math.floor(pos.left);
            const y = Math.floor(pos.top + $(this).outerHeight() + 2);
            const addMenu = new Menu();
            addMenu.append(new MenuItem({
                label: 'New file', click() {
                    clearButton('#btn-add-dropdown');
                    newFile();
                }
            }));
            addMenu.append(new MenuItem({ type: 'separator' }));
            addMenu.append(new MenuItem({
                label: 'New area...', click() {
                    clearButton('#btn-add-dropdown');
                    newArea();
                }
            }));
            addMenu.append(new MenuItem({
                label: 'New virtual area...', click() {
                    clearButton('#btn-add-dropdown');
                    newVirtualArea();
                }
            }));
            /*
            addMenu.append(new MenuItem({
                label: 'New area design...', click() {
                    clearButton('#btn-add-dropdown');
                }
            }));
            */
            addMenu.append(new MenuItem({ type: 'separator' }));
            addMenu.append(new MenuItem({
                label: 'New room...', click() {
                    clearButton('#btn-add-dropdown');
                    roomWizard();
                }
            }));
            addMenu.append(new MenuItem({
                label: 'New monster...', click() {
                    clearButton('#btn-add-dropdown');
                    monsterWizard();
                }
            }));
            addMenu.append(new MenuItem({ type: 'separator' }));
            addMenu.append(new MenuItem({
                label: 'Templates',
                submenu: menuTemplates
            }));
            addMenu.popup({ window: remote.getCurrentWindow(), x: x, y: y });
        });

        Array.from(document.querySelectorAll('.edit-dropdown')).forEach(d => initEditDropdown(d));

        if (connected) {
            document.getElementById('btn-open-remote').removeAttribute('disabled');
            menubar.updateItem('file|open remote...', { enabled: connected });
        }
        else {
            document.getElementById('btn-open-remote').setAttribute('disabled', 'true');
            menubar.updateItem('file|open remote...', { enabled: false });
        }
        createWatcher();
        postEditorLoad();
    });

    function initEditDropdown(d) {
        updateEditDropdown(d);
        var ip = d.querySelector('input');
        var b = d.querySelector('button');
        b.addEventListener('click', () => {
            var m = Array.from(b.nextElementSibling.querySelectorAll('li > a'));
            m.forEach(i => {
                i.classList.remove('active');
            });
            var el = m.filter(i => i.dataset.value === ip.value);
            if (el.length === 0)
                el = m.filter(i => i.textContent === ip.value);
            if (el.length === 0)
                return;
            el = el[0];
            el.classList.add('active');
        });
    }

    function updateEditDropdown(d) {
        var m = Array.from(d.querySelectorAll('ul > li > a'));
        var ip = d.querySelector('input');
        m.forEach(i => {
            i.addEventListener('click', (e) => {
                ip.value = e.target.dataset.value || e.target.textContent || '';
                const evt = document.createEvent('HTMLEvents');
                evt.initEvent('change', false, true);
                ip.dispatchEvent(evt);
            });
        });
    }

    function postEditorLoad() {
        if (!_ready) {
            setTimeout(postEditorLoad, 10);
            return;
        }
        if (_open) {
            if (options.opened.length && Array.isArray(options.opened[0])) {
                manager.layout = options.layout;
                options.opened[0] = options.opened[0].concat(_open.map((l) => { return { file: l[0], remote: l[1], remoteEdit: l[2] }; }));
                let l = options.opened.length;
                while (l--)
                    openFiles(options.opened[l], false, manager.panes[l]);
            }
            else
                openFiles(options.opened.concat(_open.map((l) => { return { file: l[0], remote: l[1], remoteEdit: l[2] }; })));
            if (_open[_open.length - 1][2])
                options.lastActive = 'remote:' + _open[_open.length - 1][0];
            else
                options.lastActive = _open[_open.length - 1][0];
            _open = 0;
        }
        else if (options.opened.length && Array.isArray(options.opened[0])) {
            manager.layout = options.layout;
            let l = options.opened.length;
            while (l--)
                openFiles(options.opened[l], false, manager.panes[l]);
        }
        else
            openFiles(options.opened);
        if (options.reopen) {
            if (options.opened.length && Array.isArray(options.opened[0])) {
                options.opened.forEach((o, i) => {
                    var a = o.filter(f => f.active);
                    if (a.length > 0) {
                        manager.switchToPanel(findEditor(a[0].file), manager.panes[i]);
                    }
                });
            }
            var last = findEditor(options.lastActive);
            if (last) {
                manager.focusPane(last.dock);
                last.dock.switchToPanel(last.id);
            }
        }
        doUpdate(4);
        $("#splashScreenMask").css('display', 'none');
        $("#splashLayout").css('display', 'none');
        remote.getCurrentWindow().setEnabled(true);
        menubar.enabled = true;
        _loading = 0;
    }

    function toggleDiffNav(state) {
        menubar.updateItem('view|previous change', { enabled: state });
        menubar.updateItem('view|next change', { enabled: state });
        $("#btn-diff-nav-prev").prop('disabled', !state);
        $("#btn-diff-nav-next").prop('disabled', !state);
    }

    function savedOpened() {
        var opened = [];

        var panes = manager.panes;
        var s = panes.length;
        while (s--) {
            var panels = manager.panes[s].panels;
            var k = panels.length;
            var p;
            opened[s] = [];
            while (k--) {
                p = panels[k];
                if (p.editor.new)
                    p.editor.remote = null;
                if (p.editor.new || p.editor.changed) {
                    if (!confirmSave(p))
                        return false;
                }
                //only save none new and local sourced
                if (!p.editor.new && p.editor.source === 0)
                    opened[s].unshift({
                        file: p.editor.file,
                        remote: p.editor.remote,
                        active: p == manager.panes[s].active
                    });
            }
        }
        if (!options) loadOptions();
        if (options.reopen)
            options.opened = opened;
        else
            options.opened = [];
        options.layout = manager.layout;
        if (manager.active && manager.active.editor) {
            if (manager.active.editor.source)
                options.lastActive = 'remote:' + manager.active.editor.remote;
            else
                options.lastActive = manager.active.editor.file;
        }
        else
            options.lastActive = '';
        saveOptions();
        return true;
    }

    // eslint-disable-next-line no-unused-vars
    function closeHidden() {
        var dialogs = document.body.getElementsByTagName("dialog");
        var e = 0, el = dialogs.length;
        for (; e < el; e++) {
            if (dialogs[e].open) {
                if (dialog.showMessageBox(
                    remote.getCurrentWindow(),
                    {
                        type: 'question',
                        title: 'Open dialog',
                        message: (dialogs[e].dataset.title || 'Dialog') + ' is open, exit?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1
                    }) === 1)
                    return;
            }
        }
        if (!savedOpened())
            return;
        remote.getCurrentWindow().hide();
    }

    // eslint-disable-next-line no-unused-vars
    function closeWindow() {
        remote.getCurrentWindow().close();
    }

    window.onbeforeunload = function (evt) {
        if (!$closeWindow) {
            if (document.activeElement)
                document.activeElement.blur();
            evt.returnValue = false;
            setTimeout(() => {
                var dialogs = document.body.getElementsByTagName("dialog");
                var e = 0, el = dialogs.length;
                for (; e < el; e++) {
                    if (dialogs[e].open) {
                        if (dialog.showMessageBox(
                            remote.getCurrentWindow(),
                            {
                                type: 'question',
                                title: 'Open dialog',
                                message: (dialogs[e].dataset.title || 'Dialog') + ' is open, exit?',
                                buttons: ['Yes', 'No'],
                                defaultId: 1
                            }) === 1)
                            return 'no';
                    }
                }
                if (!savedOpened())
                    return 'no';
                //clean up
                var keys = Object.keys(_editors);
                var p = keys.length;
                while (p--)
                    closeEditor(_editors[keys[p]]);
                if (watcher)
                    watcher.close();
                $closeWindow = true;
                remote.getCurrentWindow().close();
            });
            return 'no';
        }
        if (watcher)
            watcher.close();
        $closeWindow = true;
        remote.getCurrentWindow().close();
        return;
    };

    ipcRenderer.on('update-progress', (event, progressObj) => {
        if (!$("#update-progress")[0].open) {
            $("#update-progress-title").html("Downloading update&hellip;");
            $("#update-progress")[0].show();
        }
        $("#update-progressbar").val(value);
    });

    ipcRenderer.on('update-downloaded', () => {
        if ($("#update-progress")[0].open)
            $("#update-progress")[0].close();
    });

    ipcRenderer.on('open-editor', (event, file, remoteFile, remoteEdit) => {
        if (_loading) {
            if (!_open)
                _open = [];
            _open.push([file, remoteFile, remoteEdit]);
        }
        else
            openFile(file, remoteFile, null, remoteEdit);
    });

    ipcRenderer.on('send-editor', (event, text, window) => {
        if (!manager.active || !manager.active.editor || window != "code-editor")
            return;
        if (($dialogs.monster && $dialogs.monster.open) || ($dialogs.room && $dialogs.room.open)) {
            if ((document.activeElement.tagName === 'INPUT' && document.activeElement.type === 'text') || document.activeElement.tagName === 'TEXTAREA')
                document.activeElement.value = text;
            else {
                var el = document.activeElement.closest('.wizard');
                el = el.querySelector('.wizard-page textarea,.wizard-page input[type="text"]');
                if (el)
                    el.value = text;
            }
        }
        else
            manager.active.editor.insert(text);
    });

    ipcRenderer.on('GMCP-received', (event, data) => {
        if (options && options.debug)
            console.log(data);
        if (_ied)
            _ied.processGMCP(data.mod, data.obj);
    });

    ipcRenderer.on('connected', () => {
        connected = true;
        menubar.updateItem('file|diff|remote...', { enabled: manager.active && manager.active.editor && manager.active.editor.supports('diff') });
        menubar.updateItem('file|upload', { enabled: manager.active && manager.active.editor && manager.active.editor.supports('upload') });
        menubar.updateItem('file|upload as...', { enabled: manager.active && manager.active.editor && manager.active.editor.supports('upload-as') });
        $("#btn-upload").prop('disabled', !(connected && manager.active && manager.active.editor && manager.active.editor.supports('upload')));
        $("#btn-upload-as").prop('disabled', !(connected && manager.active && manager.active.editor && manager.active.editor.supports('upload-as')));
        document.getElementById('btn-open-remote').removeAttribute('disabled');
        menubar.updateItem('file|open remote...', { enabled: connected });
    });
    ipcRenderer.on('closed', () => {
        connected = false;
        menubar.updateItem('file|diff|remote...', { enabled: false });
        menubar.updateItem('file|upload', { enabled: false });
        menubar.updateItem('file|upload as...', { enabled: false });
        $("#btn-upload").prop('disabled', true);
        $("#btn-upload-as").prop('disabled', true);
        document.getElementById('btn-open-remote').setAttribute('disabled', 'true');
        menubar.updateItem('file|open remote...', { enabled: false });
    });

    ipcRenderer.on('editor-setting-changed', () => {
        loadOptions();
        var keys = Object.keys(_editors);
        var k = keys.length;
        var p;
        while (k--) {
            p = keys[k];
            if (_editors[p].editor.type === 1) {
                _editors[p].editor.options = options.modelOptions;
                manager.setPanelIconClass(getFileIcon(_editors[p].editor.file), _editors[p]);
                if (options.nativeIcons)
                    app.getFileIcon((path.extname(_editors[p].editor.file).length !== 0 ? _editors[p].editor.file : '.*'), { size: 'small' }, (err, icon) => {
                        if (err || !icon) return;
                        manager.setPanelIcon(icon.toDataURL(), _editors[p]);
                    });
            }
            else if (_editors[p].editor.type === 2)
                _editors[p].editor.options = options.virtualOptions;

        }
    });

    ipcRenderer.on('menu-update', (menu, options) => {
        if (menubar)
            menubar.updateItem(menu, options);
    });

    function newFile(file, remoteFile) {
        createEditor({ file: file || 'new_' + newCounter + '.c', new: true, remote: remoteFile }, true);
        newCounter++;
        doUpdate(1);
        updatePanel(manager.active);
    }

    function newFromFile(file, name, remoteFile) {
        if (!file || file.length === 0) return;
        var value = parseFileTemplate(fs.readFileSync(file, 'utf8'));
        createEditor({ file: 'new_' + name.replace(/\s/g, '_') + '_' + newCounter + '.c', new: true, value: value, remote: remoteFile }, true);
        newCounter++;
        doUpdate(1);
        updatePanel(manager.active);
    }

    function newFromValue(value, file, remoteFile) {
        if (!file || file.length === 0) {
            file = 'new_' + name.replace(/\s/g, '_') + '_' + newCounter + '.c';
            newCounter++;
        }
        createEditor({ file: file, new: true, value: parseFileTemplate(value || ''), remote: remoteFile }, true);
        doUpdate(1);
        updatePanel(manager.active);
    }

    function parseFileTemplate(template, data) {
        if (!template || template.length === 0) return template;
        if (!data) data = baseParseData();
        var d;
        for (d in data) {
            if (!data.hasOwnProperty(d))
                continue;
            if (data[d].regex)
                template = template.replace(data[d].regex, data[d].value);
            else
                template = template.replace(new RegExp('{' + d + '}', 'g'), data[d]);
        }
        return template;
    }

    function baseParseData() {
        var character = capitalize(remote.getGlobal('characterLogin') || remote.getGlobal('character')) || 'Unknown';
        return {
            'your name': character,
            'character': character,
            'name': character,
            'date': moment().format('YYYY-MM-DD')
        };
    }

    function newArea() {
        if (!$dialogs.area) {
            $dialogs.area = {
                dialog: document.getElementById('new-area'),
                path: document.getElementById('new-area-path'),
                remote: document.getElementById('new-area-remote-path')
            };
            $("#btn-new-area-path").on('click', () => {
                dialog.showOpenDialog(remote.getCurrentWindow(), {
                    defaultPath: $dialogs.area.path.value,
                    properties: ['openDirectory', 'createDirectory']
                },
                    function (fileNames) {
                        if (fileNames === undefined) {
                            return;
                        }
                        $dialogs.area.path.value = fileNames[0];
                    });
            });
            $('#btn-new-area-remote-path').on('click', () => {
                showBrowseDialog({
                    defaultFile: $dialogs.area.remote.value || (manager.active ? (manager.active.editor.remote || options.uploadAs) : options.uploadAs),
                    title: 'Select remote folder',
                    properties: ['openDirectory']
                }, (files) => {
                    if (!files || files.length === 0) return;
                    $dialogs.area.remote.value = files[0];
                });
            });
        }
        $('#new-area *').attr('disabled', false);
        $('#btn-new-area-remote-path').attr('disabled', !connected);

        var p = $("#new-area-path").parent().parent();
        p.removeClass("has-error");
        p.removeClass("has-feedback");
        $("button", p).removeClass('btn-danger');
        p = $("#new-area-name").parent();
        p.removeClass("has-error");
        p.removeClass("has-feedback");
        $('#new-area-path').val(options.browse || ((manager.active && manager.active.editor) ? path.dirname(manager.active.editor.file) : (options.recent && options.recent.length ? path.dirname(options.recent[0].file) : '')));
        $('#new-area-name').val('');
        menubar.enabled = false;
        document.getElementById('new-area').showModal();
    }

    // eslint-disable-next-line no-unused-vars
    function createArea() {
        var p;
        p = $("#new-area-path").parent().parent();
        p.removeClass("has-error");
        p.removeClass("has-feedback");
        $("button", p).removeClass('btn-danger');
        p = $("#new-area-name").parent();
        p.removeClass("has-error");
        p.removeClass("has-feedback");
        if (!existsSync($('#new-area-path').val())) {
            p = $("#new-area-path").parent().parent();
            p.addClass("has-error");
            p.addClass("has-feedback");
            $("button", p).addClass('btn-danger');
            p.find(".form-error").html("<small class=\"aura-error\"><span class='sr-only'>Error:</span>Path does not exist</small>");
            $('#new-area-path').focus();
            return;
        }
        if (!isDirSync($('#new-area-path').val())) {
            p = $("#new-area-path").parent();
            p.addClass("has-error");
            p.addClass("has-feedback");
            $("button", p).addClass('btn-danger');
            p.find(".form-error").html("<small class=\"aura-error\"><span class='sr-only'>Error:</span>Invalid path</small>");
            $('#new-area-path').focus();
            return;
        }
        if (!validName($('#new-area-name').val())) {
            p = $("#new-area-name").parent();
            p.addClass("has-error");
            p.addClass("has-feedback");
            p.find(".form-error").html("<small class=\"aura-error\"><span class='sr-only'>Error:</span>Invalid, can only contain letters, numbers, and _</small>");
            $('#new-area-name').focus();
            return;
        }
        var aPath = path.join($('#new-area-path').val(), $('#new-area-name').val());
        if (existsSync(aPath)) {
            p = $("#new-area-path").parent().parent();
            p.addClass("has-error");
            p.addClass("has-feedback");
            $("button", p).addClass('btn-danger');
            p.find(".form-error").html("<small class=\"aura-error\"><span class='sr-only'>Error:</span>Directory with area name already exist</small>");
            $('#new-area-path').focus();
            return;
        }
        options.browse = $('#new-area-path').val();
        doUpdate(16);
        $('#new-area *').attr('disabled', true);
        var templatePath = parseTemplate(path.join('{assets}', 'templates', 'wizards', 'area'));
        var template = walkSync(templatePath);
        var templateRegex = new RegExp('^' + templatePath.replace(/\\/g, '\\\\'));
        var c = 0;
        var cl = template.dirs.length;
        fs.mkdirSync(aPath);
        for (; c < cl; c++)
            fs.mkdirSync(template.dirs[c].replace(templateRegex, aPath));
        c = 0;
        cl = template.files.length;
        var data = baseParseData();
        data.area = $('#new-area-name').val();
        data.path = $('#new-area-remote-path').val() || '/realms/' + data.name.toLowerCase() + '/' + $('#new-area-name').val().toLowerCase();
        if (data.path.endsWith('/'))
            data.path = data.path.substr(0, data.path.length - 1);
        if (!data.path.startsWith('/'))
            data.path = '/' + data.path;
        var value;
        var file;
        var files = [];
        for (; c < cl; c++) {
            value = fs.readFileSync(template.files[c], 'utf8');
            value = parseFileTemplate(value, data);
            file = template.files[c].replace(templateRegex, aPath);
            writeFile(file, value);
            if (['.c', '.h', '.map'].indexOf(path.extname(file)) !== -1)
                files.push({
                    file: file,
                    remote: template.files[c].replace(templateRegex, data.path).replace(/\\/g, '/')
                });
        }
        openFiles(files);
        document.getElementById('new-area').close();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function validName(name) {
        if (!name || name.length === 0)
            return false;
        if (!name.match(/^[a-zA-Z0-9_]+$/g))
            return false;
        return true;
    }

    // eslint-disable-next-line no-unused-vars
    function newVirtualArea() {
        if (!$dialogs.virtualArea) {
            $dialogs.virtualArea = {
                dialog: document.getElementById('new-virtual-area')
            };
            $("#btn-new-virtual-area-path").on('click', () => {
                dialog.showOpenDialog(remote.getCurrentWindow(), {
                    defaultPath: $("#new-virtual-area-path").val(),
                    properties: ['openDirectory', 'createDirectory']
                },
                    function (fileNames) {
                        if (fileNames === undefined) {
                            return;
                        }
                        $("#new-virtual-area-path").val(fileNames[0]);
                    });
            });
            $('#btn-new-virtual-area-remote-path').on('click', () => {
                showBrowseDialog({
                    defaultFile: manager.active ? (manager.active.editor.remote || options.uploadAs) : options.uploadAs,
                    title: 'Select remote folder',
                    properties: ['openDirectory']
                }, (files) => {
                    if (!files || files.length === 0) return;
                    document.getElementById('new-virtual-area-remote-path').value = files[0];
                });
            });

            $('#eNone').on('change', function (e) {
                $('#new-virtual-area-default-exits input[id^="de"]').prop('checked', false);
                if (!this.checked) {
                    e.preventDefault();
                    $('#eNone').prop('checked', true);
                    $('.btn-group input').parent().removeClass('active');
                    $('.btn-group input:checked').parent().addClass('active');
                    return false;
                }
                $('.btn-group input').parent().removeClass('active');
                $('.btn-group input:checked').parent().addClass('active');
            });

            $('#new-virtual-area-default-exits input[id^="de"]').on('change', function () {
                $('#eNone').prop('checked', false);
                $('.btn-group input').parent().removeClass('active');
                $('.btn-group input:checked').parent().addClass('active');
            });

            $('#sNone').on('change', function (e) {
                $('#new-virtual-area-default-states input[id^="ds"]').prop('checked', false);
                if (!this.checked) {
                    e.preventDefault();
                    $('#sNone').prop('checked', true);
                    $('.btn-group input').parent().removeClass('active');
                    $('.btn-group input:checked').parent().addClass('active');
                    return false;
                }
                $('.btn-group input').parent().removeClass('active');
                $('.btn-group input:checked').parent().addClass('active');
            });

            $('#new-virtual-area-default-states input[id^="ds"]').on('change', function () {
                $('#sNone').prop('checked', false);
                $('.btn-group input').parent().removeClass('active');
                $('.btn-group input:checked').parent().addClass('active');
            });
            $('#new-virtual-area-depth').on('change input keypress', () => {
                var value = +$('#new-virtual-area-depth').val();
                if (value <= 1) {
                    $("#deUp").parent().addClass('disabled');
                    $("#deDown").parent().addClass('disabled');
                    $("#dsSinkingUp").parent().addClass('disabled');
                    $("#dsSinkingDown").parent().addClass('disabled');
                    $("#deUp").prop("checked", false);
                    $("#deDown").prop("checked", false);
                    $("#dsSinkingUp").prop("checked", false);
                    $("#dsSinkingDown").prop("checked", false);
                }
                else {
                    $("#deUp").parent().removeClass('disabled');
                    $("#deDown").parent().removeClass('disabled');
                    $("#dsSinkingUp").parent().removeClass('disabled');
                    $("#dsSinkingDown").parent().removeClass('disabled');
                }
            });
        }
        $('#new-virtual-area *').attr('disabled', false);
        $('#new-virtual-area .nav-tabs a[href="#general"]').tab('show');
        $('#btn-new-virtual-area-remote-path').attr('disabled', !connected);
        $('#new-virtual-area-remote-path').val('');
        $('#new-virtual-area-default-exits .btn-group input:checked').prop('checked', false);
        $('#new-virtual-area-default-states .btn-group input:checked').prop('checked', false);
        $('#sNone').prop('checked', true);
        $('#deNorth').prop('checked', true);
        $('#deEast').prop('checked', true);
        $('#deSouth').prop('checked', true);
        $('#deWest').prop('checked', true);
        $("#deUp").parent().addClass('disabled');
        $("#deDown").parent().addClass('disabled');
        $("#dsSinkingUp").parent().addClass('disabled');
        $("#dsSinkingDown").parent().addClass('disabled');
        $('#new-virtual-area-path').val(options.browse || ((manager.active && manager.active.editor) ? path.dirname(manager.active.editor.file) : (options.recent && options.recent.length ? path.dirname(options.recent[0].file) : '')));
        $('#new-virtual-area-area').val('');
        $('#new-virtual-area-area-enabled').prop('checked', false);
        $('#new-virtual-area-area-enabled').change();
        $('#new-virtual-area-width').val('2');
        $('#new-virtual-area-height').val('2');
        $('#new-virtual-area-depth').val('1');
        $('#new-virtual-area-coordinates').prop('checked', false);
        $('#new-virtual-area-cache').val('200');
        $('.btn-group input').parent().removeClass('active');
        $('.btn-group input:checked').parent().addClass('active');

        var p = $("#new-virtual-area-path").parent().parent();
        p.removeClass("has-error");
        p.removeClass("has-feedback");
        $("button", p).removeClass('btn-danger');
        p = $("#new-virtual-area-area").parent().parent();
        p.removeClass("has-error");
        p.removeClass("has-feedback");

        menubar.enabled = false;
        document.getElementById('new-virtual-area').showModal();
    }

    // eslint-disable-next-line no-unused-vars
    function createVirtualArea() {
        var p;
        p = $("#new-virtual-area-path").parent().parent();
        p.removeClass("has-error");
        p.removeClass("has-feedback");
        $("button", p).removeClass('btn-danger');
        p = $("#new-virtual-area-name").parent();
        p.removeClass("has-error");
        p.removeClass("has-feedback");
        if (!existsSync($('#new-virtual-area-path').val())) {
            p = $("#new-virtual-area-path").parent().parent();
            p.addClass("has-error");
            p.addClass("has-feedback");
            $("button", p).addClass('btn-danger');
            p.find(".form-error").html("<small class=\"aura-error\"><span class='sr-only'>Error:</span>Path does not exist</small>");
            $('#new-virtual-area-path').focus();
            return;
        }
        if (!isDirSync($('#new-virtual-area-path').val())) {
            p = $("#new-virtual-area-path").parent();
            p.addClass("has-error");
            p.addClass("has-feedback");
            $("button", p).addClass('btn-danger');
            p.find(".form-error").html("<small class=\"aura-error\"><span class='sr-only'>Error:</span>Invalid path</small>");
            $('#new-virtual-area-path').focus();
            return;
        }
        if (!$('#new-virtual-area-area-enabled').prop('checked') && existsSync(path.join($('#new-virtual-area-path').val(), 'virtual'))) {
            p = $("#new-virtual-area-path").parent().parent();
            p.addClass("has-error");
            p.addClass("has-feedback");
            $("button", p).addClass('btn-danger');
            p.find(".form-error").html("<small class=\"aura-error\"><span class='sr-only'>Error:</span>Path already contains a virtual server</small>");
            $('#new-virtual-area-path').focus();
            return;
        }
        var templatePath;
        var aPath = $('#new-virtual-area-path').val();
        var data = baseParseData();
        if ($('#new-virtual-area-area-enabled').prop('checked')) {
            if (!validName($('#new-virtual-area-area').val())) {
                p = $("#new-virtual-area-area").parent().parent();
                p.addClass("has-error");
                p.addClass("has-feedback");
                p.find(".form-error").html("<small class=\"aura-error\"><span class='sr-only'>Error:</span>Invalid, can only contain letters, numbers, and _</small>");
                $('#new-virtual-area-area').focus();
                return;
            }
            aPath = path.join(aPath, $('#new-virtual-area-area').val());
            if (existsSync(aPath)) {
                p = $("#new-virtual-area-area").parent().parent();
                p.addClass("has-error");
                p.addClass("has-feedback");
                $("button", p).addClass('btn-danger');
                p.find(".form-error").html("<small class=\"aura-error\"><span class='sr-only'>Error:</span>Directory with area name already exist</small>");
                $('#new-virtual-area-area').focus();
                return;
            }
            $('#new-area *').attr('disabled', true);
            templatePath = parseTemplate(path.join('{assets}', 'templates', 'wizards', 'virtual_area'));
            fs.mkdirSync(aPath);
            data.area = $('#new-virtual-area-area').val();
        }
        else {
            $('#new-area *').attr('disabled', true);
            templatePath = parseTemplate(path.join('{assets}', 'templates', 'wizards', 'virtual_server'));
            data.area = path.basename(aPath);
        }
        data.path = $('#new-virtual-area-remote-path').val() || '/realms/' + data.name.toLowerCase() + '/' + data.area.toLowerCase();
        if (data.path.endsWith('/'))
            data.path = data.path.substr(0, data.path.length - 1);
        if (!data.path.startsWith('/'))
            data.path = '/' + data.path;

        options.browse = $('#new-area-path').val();
        doUpdate(16);
        var template = walkSync(templatePath);
        var templateRegex = new RegExp('^' + templatePath.replace(/\\/g, '\\\\'));
        var c = 0;
        var cl = template.dirs.length;
        for (; c < cl; c++)
            fs.mkdirSync(template.dirs[c].replace(templateRegex, aPath));
        c = 0;
        cl = template.files.length;
        var value;
        var file;
        var files = [];

        for (; c < cl; c++) {
            value = fs.readFileSync(template.files[c], 'utf8');
            data.wizard = '';
            if (template.files[c].endsWith('server.c')) {
                if ($('#new-virtual-area-coordinates').prop('checked'))
                    data.wizard += '   set_coords(1);\n';
                if ($('#new-virtual-area-cache').val() !== '200') {
                    data.wizard += '   set_cache_size(' + $('#new-virtual-area-cache').val() + ');\n';
                }
            }
            else if (template.files[c].endsWith('virtual.map'))
                data.wizard = buildNewVirtualMap(+$('#new-virtual-area-width').val(), +$('#new-virtual-area-height').val(), +$('#new-virtual-area-depth').val(), Array.from(document.querySelectorAll('#new-virtual-area-default-exits input:checked')).map(f => +f.value).reduce((a, c) => a | c), Array.from(document.querySelectorAll('#new-virtual-area-default-states input:checked')).map(f => +f.value).reduce((a, c) => a | c));
            value = parseFileTemplate(value, data);
            file = template.files[c].replace(templateRegex, aPath);
            writeFile(file, value);
            if (['.c', '.h', '.map'].indexOf(path.extname(file)) !== -1)
                files.push({
                    file: file,
                    remote: template.files[c].replace(templateRegex, data.path).replace(/\\/g, '/')
                });
        }
        openFiles(files);
        document.getElementById('new-virtual-area').close();
        if (manager.active && manager.active.editor) manager.active.editor.focus();
    }

    function buildNewVirtualMap(width, height, depth, exits, states) {
        var f = width + " " + height;
        if (depth > 1) f += " " + depth;
        f += "\n";
        if (states)
            states = ":0:0:" + states;
        else
            states = "";
        var te = exits & ~128 & ~64 & ~1;
        var be = exits & ~16 & ~8 & ~4;
        var m = (te & ~4 & ~2) + states + " ";
        if (width > 2) m += Array(width - 1).join(te + states + " ");
        m += (te & ~32 & ~16) + states;
        m += "\n";
        for (var y = 1; y < height - 1; y++) {
            m += (exits & ~4 & ~2 & ~1) + states + " ";
            if (width > 2) m += Array(width - 1).join(exits + states + " ");
            m += (exits & ~64 & ~32 & ~16) + states;
            m += "\n";
        }
        m += (be & ~2 & ~1) + states + " ";
        if (width > 2) m += Array(width - 1).join(be + states + " ");
        m += (be & ~64 & ~32 & ~16) + states;
        m += "\n";
        for (var z = 0; z < depth; z++) f += m + "\n";
        return f;
    }

    function roomWizard(dData) {
        if (!$dialogs.room) {
            $dialogs.roomExitPage = new WizardDataGridPage({
                title: 'Exits',
                id: 'room-wiz-exits',
                columns: [
                    {
                        label: 'Exit',
                        field: 'exit',
                        width: 150,
                        editor: {
                            type: EditorType.dropdown,
                            options: {
                                container: '#room-wizard',
                                data: [
                                    'surface',
                                    'dive',
                                    'swim',
                                    'portal',
                                    'down',
                                    'up',
                                    'enter',
                                    'out',
                                    'northwest',
                                    'west',
                                    'southwest',
                                    'south',
                                    'southeast',
                                    'east',
                                    'northeast',
                                    'north'
                                ]
                            }
                        }
                    },
                    {
                        label: 'Destination',
                        field: 'dest',
                        width: 300,
                        spring: true,
                        editor: {
                            type: EditorType.custom,
                            editor: FileBrowseValueEditor,
                            show: (prop, value) => {
                                return value;
                            }
                        }
                    },
                    {
                        label: 'Door',
                        field: 'door',
                        width: 150,
                        editor: {
                            type: EditorType.dropdown,
                            options: {
                                container: '#room-wizard',
                                data: [
                                    'gates',
                                    'gate',
                                    'doors',
                                    'door'
                                ]
                            }
                        }
                    },
                    {
                        label: 'Key ID',
                        field: 'key',
                        width: 200,
                        editor: {
                            options: {
                                container: '#room-wizard',
                                singleLine: true
                            }
                        }
                    },
                    {
                        label: 'Hidden',
                        field: 'hidden',
                        width: 60
                    },
                    {
                        label: 'Blocker',
                        field: 'blocker',
                        width: 200,
                        spring: true,
                        editor: {
                            options: {
                                container: '#room-wizard',
                                singleLine: true
                            }
                        }
                    },
                    {
                        label: 'Prevent peer',
                        field: 'peer',
                        width: 200,
                        spring: true,
                        editor: {
                            options: {
                                container: '#room-wizard',
                                singleLine: true
                            }
                        }
                    },
                    {
                        label: 'Destination Door',
                        field: 'destDoor',
                        width: 200,
                        editor: {
                            options: {
                                container: '#room-wizard',
                                singleLine: true
                            }
                        }
                    },
                    {
                        label: 'Locked',
                        field: 'locked',
                        width: 60
                    },
                    {
                        label: 'Climb',
                        field: 'climb',
                        width: 60
                    },
                    {
                        label: 'Climbing Difficulty',
                        field: 'diff',
                        width: 130
                    }
                ],
                add: (e) => {
                    e.data = {
                        exit: '',
                        dest: '',
                        door: '',
                        key: '',
                        hidden: false,
                        blocker: '',
                        peer: '',
                        destDoor: '',
                        locked: false,
                        climb: false,
                        diff: 0,
                    };
                }
            });
            $dialogs.roomExitPage.dataGrid.on('browse-file', e => {
                showBrowseDialog({
                    defaultFile: e.file,
                    title: 'Select remote file',
                    properties: ['openFile'],
                    filters: $fileFilters,
                    arguments: e
                }, (files) => {
                    if (!files || files.length === 0) return;
                    $dialog.options.arguments.editor.value = files[0];
                    $dialog.options.arguments.editor.focus();
                });
            });
            $dialogs.room = new Wizard({
                id: 'room-wizard',
                title: 'Create new room...',
                pages: [
                    new WizardPage({
                        title: 'Welcome',
                        body: document.getElementById('room-wizard-welcome')
                    }),
                    new WizardPage({
                        title: 'General properties',
                        body: document.getElementById('room-wizard-general'),
                        reset: (e) => {
                            $('#room-wiz-type', e.page).val(e.wizard.defaults['room-wiz-type'] || 'STD_ROOM').selectpicker('render');
                            e.page.querySelector('#room-wiz-terrain').value = e.wizard.defaults['room-wiz-terrain'] || '';
                            e.page.querySelector('#room-wiz-short').value = e.wizard.defaults['room-wiz-short'] || '';
                            e.page.querySelector('#room-wiz-light').value = e.wizard.defaults['room-wiz-light'] || '3';
                            e.page.querySelector('#room-wiz-night-adjust').value = e.wizard.defaults['room-wiz-night-adjust'] || '0';
                            e.page.querySelector('#room-wiz-prevent-peer').value = e.wizard.defaults['room-wiz-prevent-peer'] || '';
                        }
                    }),
                    new WizardPage({
                        title: 'Description',
                        body: document.getElementById('room-wizard-description'),
                        reset: (e) => {
                            e.page.querySelector('#room-wiz-long').value = e.wizard.defaults['room-wiz-long'] || '';
                        }
                    }),
                    new WizardPage({
                        title: 'Properties',
                        body: document.getElementById('room-wizard-properties'),
                        reset: (e) => {
                            e.page.querySelector('#room-wiz-indoors').checked = e.wizard.defaults['room-wiz-indoors'] || false;
                            e.page.querySelector('#room-wiz-no-magic').checked = e.wizard.defaults['room-wiz-no-magic'] || false;
                            e.page.querySelector('#room-wiz-no-scry').checked = e.wizard.defaults['room-wiz-no-scry'] || false;
                            e.page.querySelector('#room-wiz-no-teleport').checked = e.wizard.defaults['room-wiz-no-teleport'] || false;
                            e.page.querySelector('#room-wiz-explored').checked = e.wizard.defaults['room-wiz-explored'] || false;
                            e.page.querySelector('#room-wiz-no-map').checked = e.wizard.defaults['room-wiz-no-map'] || false;
                            e.page.querySelector('#room-wiz-hide-exits').checked = e.wizard.defaults['room-wiz-hide-exits'] || false;
                            e.page.querySelector('#room-wiz-no-forage').checked = e.wizard.defaults['room-wiz-no-forage'] || false;
                            e.page.querySelector('#room-wiz-forage').value = e.wizard.defaults['room-wiz-forage'] || '-1';
                            e.page.querySelector('#room-wiz-max-forage').value = e.wizard.defaults['room-wiz-max-forage'] || '0';
                            e.page.querySelector('#room-wiz-secret-exit').value = e.wizard.defaults['room-wiz-secret-exit'] || '';
                        }
                    }),
                    new WizardPage({
                        title: 'Combat Properties',
                        body: document.getElementById('room-wizard-combat-properties'),
                        reset: (e) => {
                            e.page.querySelector('#room-wiz-no-attack').checked = e.wizard.defaults['room-wiz-no-attack'] || false;
                            e.page.querySelector('#room-wiz-council').checked = e.wizard.defaults['room-wiz-council'] || false;
                            e.page.querySelector('#room-wiz-melee').checked = e.wizard.defaults['room-wiz-melee'] || false;
                            e.page.querySelector('#room-wiz-pk').checked = e.wizard.defaults['room-wiz-pk'] || false;
                            e.page.querySelector('#room-wiz-no-dirt').checked = e.wizard.defaults['room-wiz-no-dirt'] || false;
                            e.page.querySelector('#room-wiz-dirt').value = e.wizard.defaults['room-wiz-dirt'] || '';
                        }
                    }),
                    new WizardDataGridPage({
                        title: 'Items',
                        id: 'room-wiz-items',
                        columns: [
                            {
                                label: 'Item',
                                field: 'item',
                                width: 150,
                                editor: {
                                    options: {
                                        container: '#room-wizard',
                                        singleLine: true
                                    }
                                }
                            },
                            {
                                label: 'Description',
                                field: 'description',
                                spring: true,
                                width: 200,
                                editor: {
                                    options: {
                                        container: '#room-wizard'
                                    }
                                }
                            }
                        ],
                        add: (e) => {
                            e.data = {
                                item: '',
                                description: ''
                            };
                        }
                    }),
                    $dialogs.roomExitPage,
                    new WizardDataGridPage({
                        title: 'Smells',
                        id: 'room-wiz-smells',
                        columns: [
                            {
                                label: 'Smell',
                                field: 'smell',
                                width: 150,
                                editor: {
                                    options: {
                                        container: '#room-wizard',
                                        singleLine: true
                                    }
                                }
                            },
                            {
                                label: 'Description',
                                field: 'description',
                                spring: true,
                                width: 200,
                                editor: {
                                    options: {
                                        container: '#room-wizard'
                                    }
                                }
                            }
                        ],
                        add: (e) => {
                            e.data = {
                                smell: '',
                                description: ''
                            };
                        }
                    }),
                    new WizardDataGridPage({
                        title: 'Sounds',
                        id: 'room-wiz-sounds',
                        columns: [
                            {
                                label: 'Sound',
                                field: 'sound',
                                width: 150,
                                editor: {
                                    options: {
                                        container: '#room-wizard',
                                        singleLine: true
                                    }
                                }
                            },
                            {
                                label: 'Description',
                                field: 'description',
                                spring: true,
                                width: 200,
                                editor: {
                                    options: {
                                        container: '#room-wizard'
                                    }
                                }
                            }
                        ],
                        add: (e) => {
                            e.data = {
                                sound: '',
                                description: ''
                            };
                        }
                    }),
                    new WizardDataGridPage({
                        title: 'Searches',
                        id: 'room-wiz-searches',
                        columns: [
                            {
                                label: 'Search',
                                field: 'search',
                                width: 150,
                                editor: {
                                    options: {
                                        container: '#room-wizard',
                                        singleLine: true
                                    }
                                }
                            },
                            {
                                label: 'Message',
                                field: 'message',
                                spring: true,
                                width: 200,
                                editor: {
                                    options: {
                                        container: '#room-wizard'
                                    }
                                }
                            }
                        ],
                        add: (e) => {
                            e.data = {
                                search: '',
                                message: ''
                            };
                        }
                    }),
                    new WizardPage({
                        title: 'Finish',
                        body: document.getElementById('room-wizard-finish'),
                        reset: (e) => {
                            e.page.querySelector('#room-wiz-summary').value = '';
                        },
                        shown: (e) => {
                            var summary = e.page.querySelector('#room-wiz-summary');
                            var data = e.wizard.data;
                            var doors = data['room-wiz-exits'].filter(r => r.door && r.door.length > 0 && !r.climb);
                            var exits = data['room-wiz-exits'].filter(r => !r.door || r.door.length === 0 && !r.climb);
                            var climbs = data['room-wiz-exits'].filter(r => !r.door || r.door.length === 0 && r.climb);
                            var sum = '<div><span style="font-weight:bold">Type:</span> ' + data['room-wiz-type'].display + '</div>';
                            sum += '<div><span style="font-weight:bold">Terrain:</span> ' + data['room-wiz-terrain'] + '</div>';
                            sum += '<div><span style="font-weight:bold">Short:</span> ' + data['room-wiz-short'] + '</div>';
                            sum += '<div><span style="font-weight:bold">Long:</span> ' + ellipse(data['room-wiz-long']) + '</div>';
                            sum += '<div><span style="font-weight:bold">Light:</span> ' + (data['room-wiz-light'] || 0) + '</div>';
                            sum += '<div><span style="font-weight:bold">Night light adjustment:</span> ' + (data['room-wiz-night-adjust'] || 0) + '</div>';
                            if (data['room-wiz-prevent-peer'].length > 0)
                                sum += '<div><span style="font-weight:bold">Prevent peer all:</span> ' + data['room-wiz-prevent-peer'] + '</div>';
                            if (data['room-wiz-indoors']) sum += '<div><span style="font-weight:bold">Indoors:</span> Yes</div>';
                            if (data['room-wiz-no-magic']) sum += '<div><span style="font-weight:bold">No magic:</span> Yes</div>';
                            if (data['room-wiz-no-scry']) sum += '<div><span style="font-weight:bold">No scry:</span> Yes</div>';
                            if (data['room-wiz-no-teleport']) sum += '<div><span style="font-weight:bold">No teleport:</span> Yes</div>';
                            if (data['room-wiz-explored']) sum += '<div><span style="font-weight:bold">Explored Marker:</span> Yes</div>';
                            if (data['room-wiz-no-map']) sum += '<div><span style="font-weight:bold">No map send:</span> Yes</div>';
                            if (data['room-wiz-hide-exits']) sum += '<div><span style="font-weight:bold">Hide exits:</span> Yes</div>';
                            if (data['room-wiz-no-forage']) sum += '<div><span style="font-weight:bold">No forage:</span> Yes</div>';
                            if (data['room-wiz-forage'] >= 0) sum += '<div><span style="font-weight:bold">' + data['room-wiz-forage'] + ':</span> Yes</div>';
                            if (data['room-wiz-no-dirt']) sum += '<div><span style="font-weight:bold">No dirt:</span> Yes</div>';
                            if (data['room-wiz-max-forage'] > 0)
                                sum += '<div><span style="font-weight:bold">Max forage:</span> ' + data['room-wiz-max-forage'] + '</div>';
                            if (data['room-wiz-dirt'].length > 0)
                                sum += '<div><span style="font-weight:bold">Dirt type:</span> ' + data['room-wiz-dirt'] + '</div>';
                            if (data['room-wiz-secret-exit'].length > 0)
                                sum += '<div><span style="font-weight:bold">Secret exit:</span> ' + data['room-wiz-secret-exit'] + '</div>';
                            if (data['room-wiz-no-attack']) sum += '<div><span style="font-weight:bold">No attack:</span> Yes</div>';
                            if (data['room-wiz-council']) sum += '<div><span style="font-weight:bold">Council:</span> Yes</div>';
                            if (data['room-wiz-melee']) sum += '<div><span style="font-weight:bold">Melee as ability:</span> Yes</div>';
                            if (data['room-wiz-pk']) sum += '<div><span style="font-weight:bold">Enable pk:</span> Yes</div>';

                            sum += '<div><span style="font-weight:bold">Items:</span> ' + data['room-wiz-items'].length + '</div>';
                            sum += '<div><span style="font-weight:bold">Exits:</span> ' + exits.length + '</div>';
                            if (doors.length)
                                sum += '<div><span style="font-weight:bold">Doors:</span> ' + doors.length + '</div>';
                            if (climbs.length > 0)
                                sum += '<div><span style="font-weight:bold">Climbs:</span> ' + climbs.length + '</div>';
                            if (data['room-wiz-smells'].length > 0)
                                sum += '<div><span style="font-weight:bold">Smells:</span> ' + data['room-wiz-smells'].length + '</div>';
                            if (data['room-wiz-sounds'].length > 0)
                                sum += '<div><span style="font-weight:bold">Sounds:</span> ' + data['room-wiz-sounds'].length + '</div>';
                            if (data['room-wiz-searches'].length > 0)
                                sum += '<div><span style="font-weight:bold">Searches:</span> ' + data['room-wiz-searches'].length + '</div>';

                            summary.innerHTML = sum;
                        }
                    })
                ]
            });
            $dialogs.room.height = '340px';
            $dialogs.room.width = '570px';
            $dialogs.room.on('open', () => {
                menubar.enabled = false;
            });
            $dialogs.room.on('open', () => {
                menubar.enabled = false;
            });
            $dialogs.room.on('close', () => {
                menubar.enabled = true;
            });
            $dialogs.room.on('cancel', () => {
                menubar.enabled = true;
            });
            $dialogs.room.on('finished', (e) => {
                var value = fs.readFileSync(parseTemplate(path.join('{assets}', 'templates', 'wizards', 'room.c')), 'utf8');
                var data = e.data;
                var tmpl = baseParseData();
                var tmp, tmp2, tmp3;
                var doors = data['room-wiz-exits'].filter(r => r.exit.length > 0 && r.door && r.door.length > 0 && !r.climb);
                var exits = data['room-wiz-exits'].filter(r => r.exit.length > 0 && !r.door || r.door.length === 0 && !r.climb);
                var climbs = data['room-wiz-exits'].filter(r => r.exit.length > 0 && !r.door || r.door.length === 0 && r.climb);
                tmpl.doc = [];
                tmpl.includes = '';
                tmpl['create pre'] = '';
                tmpl['create body'] = '';
                tmpl['create post'] = '';
                tmpl['create arguments'] = $dialogs.room.defaults['room-wiz-create'] || '';

                if ($dialogs.room.defaults['room-wiz-virtual'] && (data['room-wiz-type'].display === 'Standard') || data['room-wiz-type'].display === 'Base')
                    data['room-wiz-type'] = { display: 'Base', value: '(VIR+"baseroom")' };
                //if standard but has doors replace with vault, base leave alone as that is a different issue, all other types inherit vault
                else if (doors.length > 0 && data['room-wiz-type'].display === 'Standard')
                    data['room-wiz-type'] = { display: 'Vault', value: 'ROOMTYPE_VAULT' };
                else if (climbs.length > 0 && data['room-wiz-type'].display === 'Standard')
                    data['room-wiz-type'] = { display: 'Climb', value: 'ROOMTYPE_CLIMB' };

                tmpl.inherit = data['room-wiz-type'].value;
                tmpl.inherits = '';
                if (climbs.length > 0 && data['room-wiz-type'].display !== 'Climb') {
                    tmpl.includes += '\n#include <climbing.h>';
                    tmpl.doc.push('/doc/build/etc/climbing');
                }
                if (data['room-wiz-type'].display === 'Base' || $dialogs.room.defaults['room-wiz-virtual'])
                    tmpl.includes += '\n#include "area.h"';
                switch (data['room-wiz-type'].display) {
                    case 'Base':
                        tmpl.doc.push('/doc/build/areas/tutorial');
                        break;
                    case 'Advance room':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/bank');
                        break;
                    case 'Bank':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/bank');
                        break;
                    case 'Class join':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/classjoin');
                        break;
                    case 'Climb':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/climb');
                        tmpl.doc.push('/doc/build/etc/climbing');
                        break;
                    case 'Dock':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/pier');
                        tmpl.doc.push('/doc/build/room/types/dock');
                        break;
                    case 'Guild hall':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/guild_hall');
                        tmpl.doc.push('/doc/build/etc/voter');
                        break;
                    case 'Inn':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/inn');
                        break;
                    case 'Library':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/library');
                        break;
                    case 'Locker':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/locker');
                        break;
                    case 'Modroom':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/modroom');
                        break;
                    case 'Pier':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/pier');
                        tmpl.doc.push('/doc/build/room/fishing');
                        break;
                    case 'Sage':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/library');
                        tmpl.doc.push('/doc/build/room/types/sage');
                        tmpl.doc.push('/doc/build/etc/sagebase');
                        break;
                    case 'Sink':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/sink_room');
                        break;
                    case 'Sky':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/sky_room');
                        break;
                    case 'Stable':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/stable');
                        break;
                    case 'Train':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('/doc/build/room/types/train_room');
                        break;
                    case 'Vault':
                        tmpl.doc.push('/doc/build/room/doors');
                        tmpl.doc.push('/doc/build/room/types/vault');
                        break;
                    case 'Vendor storage':
                        tmpl.doc.push('/doc/build/room/types/vault');
                        tmpl.doc.push('doc/build/room/types/vendor_storage');
                        break;
                }
                data['room-wiz-short'] = data['room-wiz-short'].trim();
                if (data['room-wiz-short'].startsWith('(:')) {
                    tmpl['short'] = formatFunctionPointer(data['room-wiz-short']);
                    tmpl['create pre'] += createFunction(data['room-wiz-short'], 'string');
                }
                else if (data['room-wiz-short'].startsWith('"') && data['room-wiz-short'].endsWith('"'))
                    tmpl['short'] = `${data['room-wiz-short']}`;
                else
                    tmpl['short'] = `"${data['room-wiz-short'].replace(/"/g, '\\"')}"`;
                data['room-wiz-long'] = data['room-wiz-long'].trim();
                if (data['room-wiz-long'].startsWith('(:')) {
                    tmpl['long'] = formatFunctionPointer(data['room-wiz-long']);
                    tmpl['create pre'] += createFunction(data['room-wiz-long'], 'string');
                }
                else {
                    if (!data['room-wiz-long'].startsWith('"') && !data['room-wiz-long'].endsWith('"'))
                        data['room-wiz-long'] = data['room-wiz-long'].replace(/"/g, '\\"');
                    if (data['room-wiz-long'].startsWith('"'))
                        data['room-wiz-long'] = data['room-wiz-long'].substr(1);
                    if (data['room-wiz-long'].endsWith('"'))
                        data['room-wiz-long'] = data['room-wiz-long'].substr(0, data['room-wiz-long'].length - 1);
                    if (data['room-wiz-long'].length > 70) {
                        tmp = data['room-wiz-long'].substr(0, 66);
                        let tl = tmp.length;
                        while (tl--) {
                            if (tmp.charAt(tl) === ' ') {
                                tmp.substr(0, tl);
                                break;
                            }
                        }
                        tmpl['long'] = `"${tmp}"\n     `;
                        data['room-wiz-long'] = data['room-wiz-long'].substr(tmp.length);
                        tmpl['long'] += `${formatString(data['room-wiz-long'], 5, 73)}`;
                    }
                    else
                        tmpl['long'] = `"${data['room-wiz-long']}"`;
                }
                tmp = [];
                if (data['room-wiz-light'] !== 0)
                    tmp.push(`"light" : ${data['room-wiz-light']}`);
                if (data['room-wiz-indoors'])
                    tmp.push('"indoors" : 1');
                if (data['room-wiz-no-magic'])
                    tmp.push('"no magic" : 1');
                if (data['room-wiz-no-attack'])
                    tmp.push('"no attack" : 1');
                if (data['room-wiz-no-scry'])
                    tmp.push('"no scry" : 1');
                if (data['room-wiz-no-teleport'])
                    tmp.push('"no teleport" : 1');
                if (data['room-wiz-council'])
                    tmp.push('"council" : 1');
                if (data['room-wiz-no-map'])
                    tmp.push('"no send info" : 1');
                if (data['room-wiz-melee'])
                    tmp.push('"melee as ability" : 1');
                if (data['room-wiz-pk'])
                    tmp.push('"enable pk" : 1');
                if (data['room-wiz-hide-exits'])
                    tmp.push('"hide exits" : 1');
                if (data['room-wiz-no-forage'])
                    tmp.push('"no forage" : 1');
                if (data['room-wiz-forage'] >= 0)
                    tmp.push(`"forage" : ${data['room-wiz-forage']}`);
                if (data['room-wiz-no-dirt'])
                    tmp.push('"no dirt" : 1');
                if (data['room-wiz-dirt'].length > 0)
                    tmp.push(`"dirt type" : ${data['room-wiz-dirt']}`);
                data['room-wiz-secret-exit'] = data['room-wiz-secret-exit'].trim();
                if (data['room-wiz-secret-exit'] === 'false') { /**/ }
                else if (data['room-wiz-secret-exit'].startsWith('(:')) {
                    tmp.push(`"secret exit" : ${formatFunctionPointer(data['room-wiz-secret-exit'], true)})`);
                    tmpl['create pre'] += createFunction(data['room-wiz-secret-exit'], 'string', 'object room, object player');
                }
                else if (data['room-wiz-secret-exit'] === 'true')
                    tmp.push(`"secret exit" : 1`);
                else if (typeof data['room-wiz-secret-exit'] === "string" && parseFloat(data['room-wiz-secret-exit']).toString() == data['room-wiz-secret-exit'])
                    tmp.push(`"secret exit" : ${data['room-wiz-secret-exit']}`);
                else if (data['room-wiz-secret-exit'].length > 0) {
                    tmp.push(`"secret exit" : "${data['room-wiz-secret-exit'].replace(/"/g, '\\"')}"`);
                }
                if (data['room-wiz-max-forage'] > 0)
                    tmp.push(`"light" : ${data['room-wiz-max-forage']}`);

                if (tmp.length > 0) {
                    tmpl['create body'] += '   set_properties( ([\n       ';
                    tmpl['create body'] += tmp.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }

                if (data['room-wiz-explored'])
                    tmpl['create body'] += '   set_explored_marker(1);\n';
                if (data['room-wiz-night-adjust'] !== 0)
                    tmpl['create body'] += `   set_night_adjust(${data['room-wiz-night-adjust']});\n`;

                data['room-wiz-prevent-peer'] = data['room-wiz-prevent-peer'].trim();
                if (data['room-wiz-prevent-peer'] === 'false') { /**/ }
                else if (data['room-wiz-prevent-peer'].startsWith('(:')) {
                    tmpl['create body'] += `   set_prevent_peer(${formatFunctionPointer(data['room-wiz-prevent-peer'])});\n`;
                    tmpl['create pre'] += createFunction(data['room-wiz-prevent-peer'], 'string', 'string dir, object player');
                }
                else if (data['room-wiz-prevent-peer'] === 'true')
                    tmpl['create body'] += `   set_prevent_peer(1);\n`;
                else if (data['room-wiz-prevent-peer'].startsWith('"') && data['room-wiz-prevent-peer'].endsWith('"'))
                    tmpl['create body'] += `   set_prevent_peer(${data['room-wiz-prevent-peer']});\n`;
                else if (data['room-wiz-prevent-peer'].length > 0)
                    tmpl['create body'] += `   set_prevent_peer("${data['room-wiz-prevent-peer'].replace(/"/g, '\\"')}");\n`;
                data['room-wiz-exits'].filter(p => p.peer && e.peer.trim().length > 0).forEach(p => {
                    p.peer = p.peer.trim();
                    if (p.peer === 'false') { /**/ }
                    if (p.peer.startsWith('(:')) {
                        tmpl['create body'] += `   set_prevent_peer("${p.exit}",${formatFunctionPointer(p.peer)});\n`;
                        tmpl['create pre'] += createFunction(p, 'string', 'string dir, object player');
                    }
                    else if (data['room-wiz-prevent-peer'] === 'true')
                        tmpl['create body'] += `   set_prevent_peer("${p.exit}", 1);\n`;
                    else if (p.peer.startsWith('"') && p.peer.endsWith('"'))
                        tmpl['create body'] += `   set_prevent_peer("${p.exit}", ${p.peer});\n`;
                    else
                        tmpl['create body'] += `   set_prevent_peer("${p.exit}", "${p.peer.replace(/"/g, '\\"')}");\n`;
                });
                //add items
                tmp = data['room-wiz-items'].map(i => {
                    tmp2 = i.item.split(',').map(t => {
                        t.trim();
                        if (!t.startsWith('"') && !t.endsWith('"'))
                            t = '"' + t + '"';
                        return t;
                    });
                    if (tmp2.lengh === 1)
                        tmp2 = tmp2[0];
                    else
                        tmp2 = `({ ${tmp2.join(', ')} })`;
                    tmp3 = i.description.trim();
                    if (tmp3.startsWith('(:')) {
                        tmp3 = formatFunctionPointer(tmp3, true);
                        tmpl['create pre'] += createFunction(tmp3, 'string');
                    }
                    else if (!tmp3.startsWith('"') && !tmp3.endsWith('"'))
                        tmp3 = '"' + tmp3 + '"';
                    return `${tmp2} : ${tmp3}`;
                });

                if (tmp.length > 0) {
                    tmpl['create body'] += '   set_items( ([\n       ';
                    tmpl['create body'] += tmp.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }
                //add exits
                tmp = exits.map(i => {
                    if (i.exit.length === 0) return '';
                    tmp2 = [];
                    if (i.dest.length > 0)
                        tmp2.push(`"room" : "${i.dest}"`);
                    if (i.blocker.length > 0)
                        tmp2.push(`"blockers" : "${i.blocker}"`);
                    if (!i.exit.startsWith('"') && !i.exit.endsWith('"')) {
                        if (tmp2.length > 0)
                            return `   "${i.exit}" : ([])\n       ${tmp2.join(',\n       ')}\n     ]) );\n`;
                        return `   "${i.exit}" : ([])`;
                    }
                    if (tmp2.length > 0)
                        return `   ${i.exit} : ([])\n       ${tmp2.join(',\n       ')}\n     ]) );\n`;
                    return `   ${i.exit} : ([])`;

                });
                if (tmp.length > 0) {
                    tmpl['create body'] += '   set_exits( ([\n       ';
                    tmpl['create body'] += tmp.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }
                tmp = exits.filter(i => i.hidden).map(i => {
                    i.trim();
                    if (!i.startsWith('"') && !i.endsWith('"'))
                        i = '"' + i + '"';
                    return i;
                });
                if (tmp.length > 0)
                    tmpl['create body'] += `   add_invis_exits(${formatArgumentList(tmp.join(', '), 61)});\n`;
                //add climbs
                tmp = exits.map(i => {
                    if (i.exit.length === 0) return '';
                    tmp2 = [];
                    if (exits.dest.length > 0)
                        tmp2.push(`"dest" : "${exits.dest}"`);
                    if (exits.diff.length > 0)
                        tmp2.push(`"difficulty" : "${exits.diff}"`);
                    if (tmp2.length > 0)
                        return `   ${i.exit} : ([])\n       ${tmp2.join(',\n       ')}\n     ]) );\n`;
                    return `   ${i.exit} : ([])`;
                });
                if (tmp.length > 0) {
                    tmpl['create body'] += '   set_climbs( ([\n       ';
                    tmpl['create body'] += tmp.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }
                //add doors
                doors.forEach(d => {
                    if (!d.door.startsWith('"') && !d.door.endsWith('"'))
                        d.door = '"' + d.door + '"';
                    if (!d.exit.startsWith('"') && !d.exit.endsWith('"'))
                        d.exit = '"' + d.exit + '"';
                    if (d.key.length === 0)
                        d.key = '0';
                    else if (!d.key.startsWith('"') && !d.key.endsWith('"'))
                        d.key = '"' + d.key + '"';
                    if (d.destDoor.length > 0) {
                        if (!d.destDoor.startsWith('"') && !d.destDoor.endsWith('"'))
                            d.destDoor = '"' + d.destDoor + '"';
                        tmpl['create body'] += `   set_door(${d.door}, "${d.dest}", ${d.exit}, ${d.key}, ${d.hidden ? 1 : 0}, ${d.destDoor});\n`;
                    }
                    else if (d.hidden)
                        tmpl['create body'] += `   set_door(${d.door}, "${d.dest}", ${d.exit}, ${d.key}, 1);\n`;
                    else if (d.key !== '0')
                        tmpl['create body'] += `   set_door(${d.door}, "${d.dest}", ${d.exit}, ${d.key});\n`;
                    else
                        tmpl['create body'] += `   set_door(${d.door}, "${d.dest}", ${d.exit});\n`;
                });
                //smells
                tmp = data['room-wiz-smells'].map(i => {
                    tmp2 = i.smell.split(',').map(t => {
                        t.trim();
                        if (!t.startsWith('"') && !t.endsWith('"'))
                            t = '"' + t + '"';
                        return t;
                    });
                    if (tmp2.lengh === 1)
                        tmp2 = tmp2[0];
                    else
                        tmp2 = `({ ${tmp2.join(', ')} })`;
                    tmp3 = i.description.trim();
                    if (tmp3.startsWith('(:')) {
                        tmp3 = formatFunctionPointer(tmp3, true);
                        tmpl['create pre'] += createFunction(tmp3, 'string', 'string smell, object room, object player');
                    }
                    else if (!tmp3.startsWith('"') && !tmp3.endsWith('"'))
                        tmp3 = '"' + tmp3 + '"';
                    return `${tmp2} : ${tmp3}`;
                });

                if (tmp.length === 1 && data['room-wiz-smells'][0].smell === 'default') {
                    data['room-wiz-smells'][0].description = data['room-wiz-smells'][0].description.trim();
                    if (data['room-wiz-smells'][0].description.startsWith('(:'))
                        tmpl['create body'] += `   set_smell(${formatFunctionPointer(data['room-wiz-smells'][0].description)});`;
                    else if (!data['room-wiz-smells'][0].description.startsWith('"') && !data['room-wiz-smells'][0].description.endsWith('"'))
                        tmpl['create body'] += `   set_smell("${data['room-wiz-smells'][0].description}");`;
                    else
                        tmpl['create body'] += `   set_smell(${data['room-wiz-smells'][0].description});`;
                }
                else if (tmp.length > 0) {
                    tmpl['create body'] += '   set_smells( ([\n       ';
                    tmpl['create body'] += tmp.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }
                //sounds
                tmp = data['room-wiz-sounds'].map(i => {
                    tmp2 = i.sound.split(',').map(t => {
                        t.trim();
                        if (!t.startsWith('"') && !t.endsWith('"'))
                            t = '"' + t + '"';
                        return t;
                    });
                    if (tmp2.lengh === 1)
                        tmp2 = tmp2[0];
                    else
                        tmp2 = `({ ${tmp2.join(', ')} })`;
                    tmp3 = i.description.trim();
                    if (tmp3.startsWith('(:')) {
                        tmp3 = formatFunctionPointer(tmp3, true);
                        tmpl['create pre'] += createFunction(tmp3, 'string', 'string sound, object room, object player');
                    }
                    else if (!tmp3.startsWith('"') && !tmp3.endsWith('"'))
                        tmp3 = '"' + tmp3 + '"';
                    return `${tmp2} : ${tmp3}`;
                });

                if (tmp.length === 1 && data['room-wiz-sounds'][0].smell === 'default') {
                    data['room-wiz-sounds'][0].description = data['room-wiz-sounds'][0].description.trim();
                    if (data['room-wiz-sounds'][0].description.startsWith('(:'))
                        tmpl['create body'] += `   set_listen(${formatFunctionPointer(data['room-wiz-sounds'][0].description)});`;
                    else if (!data['room-wiz-sounds'][0].description.startsWith('"') && !data['room-wiz-sounds'][0].description.endsWith('"'))
                        tmpl['create body'] += `   set_listen("${data['room-wiz-sounds'][0].description}");`;
                    else
                        tmpl['create body'] += `   set_listen(${data['room-wiz-sounds'][0].description});`;
                }
                else if (tmp.length > 0) {
                    tmpl['create body'] += '   set_listens( ([\n       ';
                    tmpl['create body'] += tmp.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }
                //searches
                tmp = data['room-wiz-searches'].map(i => {
                    tmp2 = i.search.split(',').map(t => {
                        t.trim();
                        if (!t.startsWith('"') && !t.endsWith('"'))
                            t = '"' + t + '"';
                        return t;
                    });
                    if (tmp2.lengh === 1)
                        tmp2 = tmp2[0];
                    else
                        tmp2 = `({ ${tmp2.join(', ')} })`;
                    tmp3 = i.message.trim();
                    if (tmp3.startsWith('(:')) {
                        tmp3 = formatFunctionPointer(tmp3, true);
                        tmpl['create pre'] += createFunction(tmp3, 'string', 'string search');
                    }
                    else if (!tmp3.startsWith('"') && !tmp3.endsWith('"'))
                        tmp3 = '"' + tmp3 + '"';
                    return `${tmp2} : ${tmp3}`;
                });

                if (tmp.length === 1) {
                    if (!data['room-wiz-searches'][0].search.trim().startsWith('"') && !data['room-wiz-searches'][0].search.trim().endsWith('"'))
                        data['room-wiz-searches'][0].search = `"${data['room-wiz-searches'][0].search.trim()}"`;
                    data['room-wiz-searches'][0].message = data['room-wiz-searches'][0].message.trim();
                    if (data['room-wiz-searches'][0].message.startsWith('(:'))
                        tmpl['create body'] += `   set_search(${data['room-wiz-searches'][0].search},${formatFunctionPointer(data['room-wiz-searches'][0].message)});`;
                    else if (!data['room-wiz-searches'][0].message.startsWith('"') && !data['room-wiz-searches'][0].message.endsWith('"'))
                        tmpl['create body'] += `   set_search(${data['room-wiz-searches'][0].search}, "${data['room-wiz-searches'][0].message}");`;
                    else
                        tmpl['create body'] += `   set_search(${data['room-wiz-searches'][0].search}, ${data['room-wiz-searches'][0].message});`;
                }
                else if (tmp.length > 0) {
                    tmpl['create body'] += '   set_search( ([\n       ';
                    tmpl['create body'] += tmp.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }
                if (data['room-wiz-create-body'] && data['room-wiz-create-body'].length > 0)
                    tmpl['create body'] += data['room-wiz-create-body'];
                //ad docs
                if (tmpl['doc'].length > 0)
                    tmpl['doc'] = ' * @doc' + tmpl['doc'].join('\n * @doc') + '\n';
                else
                    tmpl['doc'] = '';
                var f;
                if (data['room-wiz-type'].display === 'Standard' || data['room-wiz-type'].display === 'Base')
                    f = ('new_room_' + newCounter);
                else
                    f = ('new_' + data['room-wiz-type'].display.replace(/\s/g, '_') + '_' + newCounter);
                if (!this.$dialogs.room.defaults['room-wiz-file'] || this.$dialogs.room.defaults['room-wiz-file'].length === 0)
                    newCounter++;
                f += '.c';
                f.toLowerCase();
                newFromValue(parseFileTemplate(value, tmpl), this.$dialogs.room.defaults['room-wiz-file'] || f);
            });
        }
        $dialogs.room.defaults = dData || {};
        $dialogs.room.show();
    }

    function monsterWizard() {
        if (!$dialogs.monster) {
            var colors = '<li><a href="#">' + fs.readFileSync(parseTemplate(path.join('{assets}', 'editor', 'color.lst')), 'utf8').replace(/\r\n|\n|\r/g, '</a></li><li><a href="#">') + '</a></li>';
            var races = '<li><a href="#">' + fs.readFileSync(parseTemplate(path.join('{assets}', 'editor', 'monster-race.lst')), 'utf8').replace(/\r\n|\n|\r/g, '</a></li><li><a href="#">') + '</a></li>';
            var bodies = '<li><a href="#">' + fs.readFileSync(parseTemplate(path.join('{assets}', 'editor', 'monster-bodies.lst')), 'utf8').replace(/\r\n|\n|\r/g, '</a></li><li><a href="#">') + '</a></li>';
            document.getElementById('mon-wiz-body-list').innerHTML = bodies;
            document.getElementById('mon-wiz-race-list').innerHTML = races;
            document.getElementById('mon-wiz-eye-list').innerHTML = colors;
            document.getElementById('mon-wiz-hair-list').innerHTML = colors;
            updateEditDropdown(document.getElementById('mon-wiz-body-list').closest('.edit-dropdown'));
            updateEditDropdown(document.getElementById('mon-wiz-race-list').closest('.edit-dropdown'));
            updateEditDropdown(document.getElementById('mon-wiz-eye-list').closest('.edit-dropdown'));
            updateEditDropdown(document.getElementById('mon-wiz-hair-list').closest('.edit-dropdown'));
            $dialogs.monster = new Wizard({
                id: 'monster-wizard',
                title: 'Create new monster...',
                pages: [
                    new WizardPage({
                        title: 'Welcome',
                        body: document.getElementById('mon-wizard-welcome')
                    }),
                    new WizardPage({
                        title: 'General properties',
                        body: document.getElementById('mon-wizard-general'),
                        reset: (e) => {
                            $('#mon-wiz-type', e.page).val('STD_MONSTER').selectpicker('render');
                            e.page.querySelector('#mon-wiz-level').value = '1';
                            e.page.querySelector('#mon-wiz-alignment').value = '';
                            e.page.querySelector('#mon-wiz-race').value = '';
                            e.page.querySelector('#mon-wiz-class').value = '';
                            e.page.querySelector('#mon-wiz-language').value = '';
                            e.page.querySelector('#mon-wiz-ridable').checked = false;
                            e.page.querySelector('#mon-wiz-flying').checked = false;
                            e.page.querySelector('#mon-wiz-getable').checked = false;
                            e.page.querySelector('#mon-wiz-undead').checked = false;
                            e.page.querySelector('#mon-wiz-waterbreathing').checked = false;
                            e.page.querySelector('#mon-wiz-requires-water').checked = false;
                            e.page.querySelector('#mon-wiz-no-bleed').checked = false;
                        }
                    }),
                    new WizardPage({
                        title: 'Description',
                        body: document.getElementById('mon-wizard-description'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-name').value = '';
                            e.page.querySelector('#mon-wiz-short').value = '';
                            e.page.querySelector('#mon-wiz-nouns').value = '';
                            e.page.querySelector('#mon-wiz-adjectives').value = '';
                        }
                    }),
                    new WizardPage({
                        title: 'Long description',
                        body: document.getElementById('mon-wizard-description-long'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-long').value = '';
                        }
                    }),
                    new WizardPage({
                        title: 'Physical properties',
                        body: document.getElementById('mon-wizard-physical'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-mass').value = '0';
                            e.page.querySelector('#mon-wiz-height').value = '1';
                            e.page.querySelector('#mon-wiz-eye').value = '';
                            e.page.querySelector('#mon-wiz-hair').value = '';
                            $('#mon-wiz-gender', e.page).val('male').selectpicker('render');
                            e.page.querySelector('#mon-wiz-body').value = '';
                        }
                    }),
                    new WizardPage({
                        title: 'Advanced properties',
                        body: document.getElementById('mon-wizard-advanced'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-no-corpse').value = '';
                            e.page.querySelector('#mon-wiz-no-limbs').value = '';
                        }
                    }),
                    new WizardPage({
                        title: 'Movement',
                        body: document.getElementById('mon-wizard-movement'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-speed').value = '0';
                            e.page.querySelector('#mon-wiz-patrol').value = '';
                            e.page.querySelector('#mon-wiz-no-walk').value = '';
                        }
                    }),
                    new WizardPage({
                        title: 'Combat',
                        body: document.getElementById('mon-wizard-combat'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-chance').value = '33';
                            e.page.querySelector('#mon-wiz-commands').value = '';
                            e.page.querySelector('#mon-wiz-initiators').value = '';
                        }
                    }),
                    new WizardPage({
                        title: 'Aggressive',
                        body: document.getElementById('mon-wizard-aggressive'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-aggressive').value = '';
                        }
                    }),
                    new WizardPage({
                        title: 'Actions',
                        body: document.getElementById('mon-wizard-actions'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-auto-drop').value = '1';
                            e.page.querySelector('#mon-wiz-auto-drop-enabled').checked = false;
                            e.page.querySelector('#mon-wiz-storage').value = '3';
                            e.page.querySelector('#mon-wiz-storage-enabled').checked = true;
                            e.page.querySelector('#mon-wiz-auto-wield').value = '3';
                            e.page.querySelector('#mon-wiz-auto-wield-enabled').checked = true;
                            e.page.querySelector('#mon-wiz-auto-wear').value = '3';
                            e.page.querySelector('#mon-wiz-auto-wear-enabled').checked = false;
                            e.page.querySelector('#mon-wiz-auto-loot').value = '1';
                            e.page.querySelector('#mon-wiz-auto-loot-enabled').checked = false;
                            e.page.querySelector('#mon-wiz-auto-stand').checked = true;
                            e.page.querySelector('#mon-wiz-drop-encumbered').checked = false;
                            e.page.querySelector('#mon-wiz-drop-encumbered-combat').checked = false;
                            e.page.querySelector('#mon-wiz-wimpy').value = '0';
                        }
                    }),
                    new WizardPage({
                        title: 'Finish',
                        body: document.getElementById('mon-wizard-finish'),
                        reset: (e) => {
                            e.page.querySelector('#mon-wiz-summary').value = '';
                        },
                        shown: (e) => {
                            var summary = e.page.querySelector('#mon-wiz-summary');
                            var data = e.wizard.data;
                            var sum = '<div><span style="font-weight:bold">Type:</span> ' + data['mon-wiz-type'].display + '</div>';
                            sum += '<div><span style="font-weight:bold">Level:</span> ' + data['mon-wiz-level'] + '</div>';
                            sum += '<div><span style="font-weight:bold">Alignment:</span> ' + (data['mon-wiz-alignment'] || 'neutral') + '</div>';
                            sum += '<div><span style="font-weight:bold">Race:</span> ' + (data['mon-wiz-race'] || 'human') + '</div>';
                            if (data['mon-wiz-class'] && data['mon-wiz-class'].length > 0)
                                sum += '<div><span style="font-weight:bold">Class:</span> ' + data['mon-wiz-class'] + '</div>';
                            if (data['mon-wiz-language'] && data['mon-wiz-language'].length > 0)
                                sum += '<div><span style="font-weight:bold">Lang:</span> ' + data['mon-wiz-language'] + '</div>';
                            if (data['mon-wiz-ridable'])
                                sum += '<div><span style="font-weight:bold">Ridable:</span> Yes</div>';
                            if (data['mon-wiz-flying'])
                                sum += '<div><span style="font-weight:bold">Flying:</span> Yes</div>';
                            if (data['mon-wiz-getable'])
                                sum += '<div><span style="font-weight:bold">Getable:</span> Yes</div>';
                            if (data['mon-wiz-undead'])
                                sum += '<div><span style="font-weight:bold">Undead:</span> Yes</div>';
                            if (data['mon-wiz-waterbreathing'])
                                sum += '<div><span style="font-weight:bold">Water breathing:</span> Yes</div>';
                            if (data['mon-wiz-requires-water'])
                                sum += '<div><span style="font-weight:bold">Requires water:</span> Yes</div>';
                            if (data['mon-wiz-no-bleed'])
                                sum += '<div><span style="font-weight:bold">No bleeding:</span> Yes</div>';
                            sum += '<div><span style="font-weight:bold">Name:</span> ' + data['mon-wiz-name'] + '</div>';
                            sum += '<div><span style="font-weight:bold">Short:</span> ' + data['mon-wiz-short'] + '</div>';
                            sum += '<div><span style="font-weight:bold">Long:</span> ' + ellipse(data['mon-wiz-long']) + '</div>';
                            if (data['mon-wiz-nouns'] && data['mon-wiz-nouns'].length > 0)
                                sum += '<div><span style="font-weight:bold">Nouns:</span> ' + ellipse(data['mon-wiz-nouns'].replace(/\n/g, '')) + '</div>';
                            if (data['mon-wiz-adjectives'] && data['mon-wiz-adjectives'].length > 0)
                                sum += '<div><span style="font-weight:bold">Adjectives:</span> ' + ellipse(data['mon-wiz-adjectives'].replace(/\n/g, '')) + '</div>';
                            if (data['mon-wiz-mass'] > 0)
                                sum += '<div><span style="font-weight:bold">Mass:</span> ' + data['mon-wiz-mass'] + '</div>';
                            sum += '<div><span style="font-weight:bold">Height:</span> ' + data['mon-wiz-height'] + '</div>';
                            if (data['mon-wiz-eye'] && data['mon-wiz-eye'].length > 0)
                                sum += '<div><span style="font-weight:bold">Eyes:</span> ' + data['mon-wiz-eye'] + '</div>';
                            if (data['mon-wiz-hair'] && data['mon-wiz-hair'].length > 0)
                                sum += '<div><span style="font-weight:bold">Hair:</span> ' + data['mon-wiz-hair'] + '</div>';
                            if (data['mon-wiz-gender'].value.length > 0)
                                sum += '<div><span style="font-weight:bold">Gender:</span> ' + data['mon-wiz-gender'].value + '</div>';
                            if (data['mon-wiz-body'] && data['mon-wiz-body'].length > 0)
                                sum += '<div><span style="font-weight:bold">Body type:</span> ' + data['mon-wiz-body'] + '</div>';
                            if (data['mon-wiz-no-corpse'] && data['mon-wiz-no-corpse'].length > 0)
                                sum += '<div><span style="font-weight:bold">No corpse:</span> ' + ellipse(data['mon-wiz-no-corpse'].replace(/\n/g, '')) + '</div>';
                            if (data['mon-wiz-no-limbs'] && data['mon-wiz-hair'].length > 0)
                                sum += '<div><span style="font-weight:bold">No limbs:</span> ' + ellipse(data['mon-wiz-no-limbs'].replace(/\n/g, '')) + '</div>';
                            if (data['mon-wiz-speed'] > 0)
                                sum += '<div><span style="font-weight:bold">Speed:</span> ' + data['mon-wiz-speed'] + '</div>';
                            if (data['mon-wiz-patrol'] && data['mon-wiz-patrol'].length > 0)
                                sum += '<div><span style="font-weight:bold">Patrol route:</span> ' + ellipse(data['mon-wiz-patrol'].replace(/\n/g, '')) + '</div>';
                            if (data['mon-wiz-no-walk'] && data['mon-wiz-no-walk'].length > 0)
                                sum += '<div><span style="font-weight:bold">No walk:</span> ' + ellipse(data['mon-wiz-no-walk'].replace(/\n/g, '')) + '</div>';
                            if (data['mon-wiz-commands'] && data['mon-wiz-commands'].length > 0)
                                sum += '<div><span style="font-weight:bold">Attack commands:</span> ' + ellipse(data['mon-wiz-commands'].replace(/\n/g, '')) + '</div>';
                            if (data['mon-wiz-chance'].length > 0)
                                sum += '<div><span style="font-weight:bold">Attack commands chance:</span> ' + data['mon-wiz-chance'] + '%</div>';
                            if (data['mon-wiz-initiators'] && data['mon-wiz-initiators'].length > 0)
                                sum += '<div><span style="font-weight:bold">Attack initiators:</span> ' + ellipse(data['mon-wiz-initiators'].replace(/\n/g, '')) + '</div>';
                            if (data['mon-wiz-aggressive'] && data['mon-wiz-aggressive'].length > 0)
                                sum += '<div><span style="font-weight:bold">Aggressive:</span> ' + ellipse(data['mon-wiz-aggressive']) + '</div>';

                            if (data['mon-wiz-auto-drop-enabled']) {
                                sum += '<div><span style="font-weight:bold">Auto drop:</span> Yes</div>';
                                sum += '<div><span style="font-weight:bold">Auto drop delay:</span> ' + data['mon-wiz-auto-drop'] + ' seconds</div>';
                            }
                            if (data['mon-wiz-storage-enabled']) {
                                sum += '<div><span style="font-weight:bold">Open storage:</span> Yes</div>';
                                sum += '<div><span style="font-weight:bold">Open storage delay:</span> ' + data['mon-wiz-storage'] + ' seconds</div>';
                            }
                            if (data['mon-wiz-auto-wield-enabled']) {
                                sum += '<div><span style="font-weight:bold">Auto wield:</span> Yes</div>';
                                sum += '<div><span style="font-weight:bold">Auto wield delay:</span> ' + data['mon-wiz-auto-wield'] + ' seconds</div>';
                            }
                            if (data['mon-wiz-auto-loot-enabled']) {
                                sum += '<div><span style="font-weight:bold">Auto loot:</span> Yes</div>';
                                sum += '<div><span style="font-weight:bold">Auto loot delay:</span> ' + data['mon-wiz-auto-loot'] + ' seconds</div>';
                            }
                            if (data['mon-wiz-auto-wear-enabled']) {
                                sum += '<div><span style="font-weight:bold">Auto wear:</span> Yes</div>';
                                sum += '<div><span style="font-weight:bold">Auto wear delay:</span> ' + data['mon-wiz-auto-wear'] + ' seconds</div>';
                            }
                            if (data['mon-wiz-wimpy'] !== 0)
                                sum += '<div><span style="font-weight:bold">Wimpy:</span> ' + data['mon-wiz-wimpy'] + '%</div>';
                            if (data['mon-wiz-auto-stand'])
                                sum += '<div><span style="font-weight:bold">Auto stand:</span> Yes</div>';
                            if (data['mon-wiz-drop-encumbered'])
                                sum += '<div><span style="font-weight:bold">Drop encumbered:</span> Yes</div>';
                            if (data['mon-wiz-drop-encumbered-combat'])
                                sum += '<div><span style="font-weight:bold">Drop encumbered combat:</span> Yes</div>';
                            summary.innerHTML = sum;
                        }
                    })
                ]
            });
            $dialogs.monster.height = '340px';
            $dialogs.monster.on('open', () => {
                menubar.enabled = false;
            });
            $dialogs.monster.on('close', () => {
                menubar.enabled = true;
            });
            $dialogs.monster.on('cancel', () => {
                menubar.enabled = true;
            });
            $dialogs.monster.on('finished', (e) => {
                var value = fs.readFileSync(parseTemplate(path.join('{assets}', 'templates', 'wizards', 'monster.c')), 'utf8');
                var data = e.data;
                var tmpl = baseParseData();
                var tmp;
                tmpl.inherit = data['mon-wiz-type'].value;
                tmpl.includes = data['mon-wiz-type'].display === 'Base' ? '\n#include "../area.h"' : '';
                tmpl['doc'] = [];
                tmpl['create pre'] = '';
                tmpl['create post'] = '';
                switch (data['mon-wiz-type'].display) {
                    case 'Base':
                        tmpl.doc.push('/doc/build/areas/tutorial');
                        break;
                    case 'Armor Repair':
                        tmpl.doc.push('/doc/build/monster/types/smith');
                        tmpl.doc.push('/doc/build/monster/types/vendor');
                        break;
                    case 'Barkeep':
                        tmpl.doc.push('/doc/build/monster/types/barkeep');
                        break;
                    case 'Cleric Trainer':
                        tmpl.doc.push('/doc/build/monster/types/cleric_trainer');
                        break;
                    case 'Command Trainer':
                        tmpl.doc.push('/doc/build/monster/types/subclasser');
                        break;
                    case 'Healer':
                        tmpl.doc.push('/doc/build/monster/types/healer');
                        break;
                    case 'Jeweler':
                        tmpl.doc.push('/doc/build/monster/types/jeweler');
                        tmpl.doc.push('/doc/build/monster/types/vendor');
                        break;
                    case 'Lock pick Repair':
                        tmpl.doc.push('/doc/build/monster/types/lockpick_repair');
                        tmpl.doc.push('/doc/build/monster/types/vendor');
                        break;
                    case 'Mage Trainer':
                        tmpl.doc.push('/doc/build/monster/types/mage_trainer');
                        break;
                    case 'Edible Monster':
                        tmpl.doc.push('/doc/build/monster/types/mon_edible');
                        break;
                    case 'Sage':
                        tmpl.doc.push('/doc/build/monster/types/sage');
                        tmpl.doc.push('/doc/build/etc/sagebase');
                        break;
                    case 'Skill Trainer':
                        tmpl.doc.push('/doc/build/monster/types/skill_trainer');
                        break;
                    case 'Smith':
                        tmpl.doc.push('/doc/build/monster/types/smith');
                        tmpl.doc.push('/doc/build/monster/types/vendor');
                        break;
                    case 'Summon Monster':
                        tmpl.doc.push('/doc/build/monster/types/summon');
                        break;
                    case 'Tattooist':
                        tmpl.doc.push('/doc/build/monster/types/tattooist');
                        break;
                    case 'Trainer':
                        tmpl.doc.push('/doc/build/monster/types/subclasser');
                        break;
                    case 'Vendor':
                        tmpl.doc.push('/doc/build/monster/types/vendor');
                        break;
                    case 'Weapon Repair':
                        tmpl.doc.push('/doc/build/monster/types/smith');
                        tmpl.doc.push('/doc/build/monster/types/vendor');
                        break;
                }

                tmpl['name'] = data['mon-wiz-name'].replace(/"/g, '\\"');
                data['mon-wiz-short'] = data['mon-wiz-short'].trim();
                if (data['mon-wiz-short'].startsWith('(:')) {
                    tmpl['short'] = formatFunctionPointer(data['mon-wiz-short']);
                    tmpl['create pre'] += createFunction(data['mon-wiz-short'], 'string');
                }
                else if (data['mon-wiz-short'].startsWith('"') && data['mon-wiz-short'].endsWith('"'))
                    tmpl['short'] = `${data['mon-wiz-short']}`;
                else
                    tmpl['short'] = `"${data['mon-wiz-short'].replace(/"/g, '\\"')}"`;
                data['mon-wiz-long'] = data['mon-wiz-long'].trim();
                if (data['mon-wiz-long'].startsWith('(:')) {
                    tmpl['long'] = formatFunctionPointer(data['mon-wiz-long']);
                    tmpl['create pre'] += createFunction(data['mon-wiz-long'], 'string');
                }
                else {
                    if (!data['mon-wiz-long'].startsWith('"') && !data['mon-wiz-long'].endsWith('"'))
                        data['mon-wiz-long'] = data['mon-wiz-long'].replace(/"/g, '\\"');
                    if (data['mon-wiz-long'].startsWith('"'))
                        data['mon-wiz-long'] = data['mon-wiz-long'].substr(1);
                    if (data['mon-wiz-long'].endsWith('"'))
                        data['mon-wiz-long'] = data['mon-wiz-long'].substr(0, data['mon-wiz-long'].length - 1);
                    if (data['mon-wiz-long'].length > 70) {
                        tmp = data['mon-wiz-long'].substr(0, 66);
                        let tl = tmp.length;
                        while (tl--) {
                            if (tmp.charAt(tl) === ' ') {
                                tmp.substr(0, tl);
                                break;
                            }
                        }
                        tmpl['long'] = `"${tmp}"\n     `;
                        data['mon-wiz-long'] = data['mon-wiz-long'].substr(tmp.length);
                        tmpl['long'] += `${formatString(data['mon-wiz-long'], 5, 73)}`;
                    }
                    else
                        tmpl['long'] = `"${data['mon-wiz-long']}"`;
                }
                tmpl['height'] = data['mon-wiz-height'];

                tmpl['create'] = `${data['mon-wiz-level']}, "${data['mon-wiz-race'] || 'human'}"`;
                tmpl['create comment'] = '';
                if (data['mon-wiz-class'].length > 0) {
                    tmpl['create'] += `, "${data['mon-wiz-class']}"`;
                    tmpl['create comment'] += ', Class';
                }
                if (data['mon-wiz-body'].length > 0) {
                    tmpl['create'] += `, "${data['mon-wiz-body']}"`;
                    tmpl['create comment'] += ', Body type';
                }
                tmpl['create body'] = '';
                if (data['mon-wiz-nouns'].length > 0) {

                    data['mon-wiz-nouns'] = data['mon-wiz-nouns'].split(',');
                    data['mon-wiz-nouns'] = data['mon-wiz-nouns'].map(w => {
                        w = w.trim();
                        if (!w.startsWith('"'))
                            w = '"' + w;
                        if (!w.endsWith('"'))
                            w += '"';
                        return w;
                    });
                    tmpl['create body'] += '   set_nouns(' + data['mon-wiz-nouns'].join(', ') + ');\n';
                }
                if (data['mon-wiz-adjectives'].length > 0) {
                    data['mon-wiz-adjectives'] = data['mon-wiz-adjectives'].split(',');
                    data['mon-wiz-adjectives'] = data['mon-wiz-adjectives'].map(w => {
                        w = w.trim();
                        if (!w.startsWith('"'))
                            w = '"' + w;
                        if (!w.endsWith('"'))
                            w += '"';
                        return w;
                    });
                    tmpl['create body'] += '   set_adjectives(' + data['mon-wiz-adjectives'].join(', ') + ');\n';
                }
                tmp = [];
                if (data['mon-wiz-undead'])
                    tmp.push('"undead" : 1');
                if (data['mon-wiz-waterbreathing'])
                    tmp.push('"waterbreathing" : 1');
                if (data['mon-wiz-requires-water'])
                    tmp.push('"requires water" : 1');
                if (data['mon-wiz-no-bleed'])
                    tmp.push('"no bleed" : 1');
                data['mon-wiz-no-corpse'] = data['mon-wiz-no-corpse'].trim();
                if (data['mon-wiz-no-corpse'].startsWith('(:')) {
                    tmp.push(`"no corpse" : ${formatFunctionPointer(data['mon-wiz-no-corpse'], true)}`);
                    tmpl['create pre'] += createFunction(data['mon-wiz-no-corpse'], 'string');
                }
                else if (data['mon-wiz-no-corpse'].startsWith('"') && data['mon-wiz-no-corpse'].endsWith('"'))
                    tmp.push(`"no corpse" : ${data['mon-wiz-no-corpse']}`);
                else if (data['mon-wiz-no-corpse'].length > 0)
                    tmp.push(`"no corpse" : "${data['mon-wiz-no-corpse'].replace(/"/g, '\\"')}"`);
                data['mon-wiz-no-limbs'] = data['mon-wiz-no-limbs'].trim();
                if (data['mon-wiz-no-limbs'].startsWith('(:')) {
                    tmp.push(`"no limbs" : ${formatFunctionPointer(data['mon-wiz-no-limbs'], true)}`);
                    tmpl['create pre'] += createFunction(data['mon-wiz-no-limbs'], 'string');
                }
                else if (data['mon-wiz-no-limbs'].startsWith('"') && data['mon-wiz-no-limbs'].endsWith('"'))
                    tmp.push(`"no limbs" : ${data['mon-wiz-no-limbs']}`);
                else if (data['mon-wiz-no-limbs'].length > 0)
                    tmp.push(`"no limbs" : "${data['mon-wiz-no-limbs'].replace(/"/g, '\\"')}"`);
                if (tmp.length > 0) {
                    tmpl['create body'] += '   set_properties( ([\n       ';
                    tmpl['create body'] += tmp.join(',\n       ');
                    tmpl['create body'] += '\n     ]) );\n';
                }
                if (data['mon-wiz-mass'] > 0)
                    tmpl['create body'] += `   set_mass(${data['mon-wiz-mass']});\n`;
                tmpl['create body'] += `   set_height(${data['mon-wiz-height']});\n`;
                if (data['mon-wiz-alignment'].length > 0 && data['mon-wiz-alignment'] !== '0' && data['mon-wiz-alignment'] !== 'neutral') {
                    if (typeof data['mon-wiz-alignment'] === "string" && parseFloat(data['mon-wiz-alignment']).toString() == data['mon-wiz-alignment'])
                        tmpl['create body'] += `   set_alignment(${data['mon-wiz-alignment']});\n`;
                    else
                        tmpl['create body'] += `   set_alignment("${data['mon-wiz-alignment']}");\n`;
                }
                if (data['mon-wiz-language'].length > 0)
                    tmpl['create body'] += `   set_primary_lang("${data['mon-wiz-mass']}");\n`;
                if (data['mon-wiz-gender'].value.length > 0)
                    tmpl['create body'] += `   set_gender("${data['mon-wiz-gender'].value}");\n`;
                if (data['mon-wiz-eye'].length > 0)
                    tmpl['create body'] += `   set_eyecolor("${data['mon-wiz-mass']}");\n`;
                if (data['mon-wiz-hair'].length > 0)
                    tmpl['create body'] += `   set_haircolor("${data['mon-wiz-mass']}");\n`;
                if (data['mon-wiz-ridable'])
                    tmpl['create body'] += '   set_rideable(1); //Enable riding\n   set_follow_type("steed");/ /set the follow type to steed for proper limiting\n';
                if (data['mon-wiz-flying'])
                    tmpl['create body'] += '   set_can_fly(1); //Enable fly/land abilities\n';
                if (data['mon-wiz-flying'])
                    tmpl['create body'] += '   set_getable(1); //turn on getable\n';
                data['mon-wiz-speed'] = data['mon-wiz-speed'] || 0;
                if (data['mon-wiz-patrol'].length > 0)
                    tmpl['create body'] += `   set_patrol(${data['mon-wiz-speed']}, ${formatArgumentList(data['mon-wiz-patrol'], 64 - ('' + data['mon-wiz-speed']).length)}); //Set speed and patrol route\n`;
                else if (data['mon-wiz-speed'] > 0)
                    tmpl['create body'] += `   set_speed(${data['mon-wiz-speed']}); //Set speed\n`;
                if (data['mon-wiz-no-walk'].length > 0)
                    tmpl['create body'] += `   set_no_walk(${formatArgumentList(data['mon-wiz-no-walk'], 63, 0, 0, true)}); //Set no walk rooms\n`;
                if (data['mon-wiz-chance'].length > 0)
                    tmpl['create body'] += `   set_spell_chance(${data['mon-wiz-chance']}); //Set the chance an attack command will be used\n`;
                if (data['mon-wiz-commands'].length > 0)
                    tmpl['create body'] += `   set_spells(${formatArgumentList(data['mon-wiz-commands'], 64)}); //Set attack commands\n`;
                if (data['mon-wiz-initiators'].length > 0)
                    tmpl['create body'] += `   set_combat_initiator(${formatArgumentList(data['mon-wiz-initiators'], 56)}); //Set attack initiators\n`;
                if (data['mon-wiz-aggressive'].length > 0) {
                    tmpl['create body'] += `   set_aggressive(${data['mon-wiz-chance']}); //Set monster aggressiveness\n`;
                    tmpl['doc'].push('/doc/build/monster/haggle');
                }
                if (data['mon-wiz-auto-drop-enabled'])
                    tmpl['create body'] += `   set_auto_drop(1);`;
                if (data['mon-wiz-auto-drop'] !== 1)
                    tmpl['create body'] += `   set_auto_drop_delay(${data['mon-wiz-auto-drop']});`;
                if (!data['mon-wiz-storage-enabled'])
                    tmpl['create body'] += `   set_open_storage(0);`;
                if (data['mon-wiz-storage'] !== 3)
                    tmpl['create body'] += `   set_open_storage_delay(${data['mon-wiz-storage']});`;
                if (!data['mon-wiz-auto-wield-enabled'])
                    tmpl['create body'] += `   set_auto_wield(0);`;
                if (data['mon-wiz-auto-wield'] !== 3)
                    tmpl['create body'] += `   set_auto_wield_delay(${data['mon-wiz-auto-wield']});`;
                if (data['mon-wiz-auto-loot-enabled'])
                    tmpl['create body'] += `   set_auto_loot(1);`;
                if (data['mon-wiz-auto-loot'] !== 1)
                    tmpl['create body'] += `   set_auto_loot_delay(${data['mon-wiz-auto-loot']});`;
                if (data['mon-wiz-auto-wear-enabled'])
                    tmpl['create body'] += `   set_auto_wear(1);`;
                if (data['mon-wiz-auto-wear'] !== 3)
                    tmpl['create body'] += `   set_auto_wear_delay(${data['mon-wiz-auto-wear']});`;
                if (data['mon-wiz-wimpy'] !== 0)
                    tmpl['create body'] += `   set_wimpy(${data['mon-wiz-wimpy']});`;
                if (!data['mon-wiz-auto-stand'])
                    tmpl['create body'] += `   set_auto_stand(0);`;
                if (data['mon-wiz-drop-encumbered'] && data['mon-wiz-drop-encumbered-combat'])
                    tmpl['create body'] += '   set_reactions( ([\n       "encumbered 50" : "drop extra"\n       combat encumbered 50" : "drop extra"\n     ]) );\n';
                else if (data['mon-wiz-drop-encumbered'])
                    tmpl['create body'] += '   set_reaction("encumbered 50", "drop extra");\n';
                else if (data['mon-wiz-drop-encumbered-combat'])
                    tmpl['create body'] += '   set_reaction("combat encumbered 50", "drop extra");\n';

                if (tmpl['doc'].length > 0)
                    tmpl['doc'] = ' * @doc' + tmpl['doc'].join('\n * @doc') + '\n';
                else
                    tmpl['doc'] = '';

                var f = data['mon-wiz-name'].replace(/\s/g, '_');
                if (!f || f.length === 0) {
                    if (data['mon-wiz-type'].display === 'Standard' || data['mon-wiz-type'].display === 'Base')
                        f = ('new_monster_' + newCounter);
                    else
                        f = ('new_' + data['mon-wiz-type'].display.replace(/\s/g, '_') + '_' + newCounter);
                }
                f += '.c';
                f.toLowerCase();
                newFromValue(parseFileTemplate(value, tmpl), f);
                newCounter++;
            });
        }
        $dialogs.monster.show();
    }

    function createFunction(name, type, args) {
        name = name.trim();
        if (name.startsWith('(:'))
            name = name.substr(2);
        if (name.endsWith(':)'))
            name = name.substr(0, name.length - 2);
        name = name.trim();
        if (!type) type = 'void';
        if (type === 'void')
            return `${type} ${name}(${args})\n{\n}\n\n`;
        if (type === 'string')
            return `${type} ${name}(${args})\n{\n   return "";\n}\n\n`;
        return `${type} ${name}(${args})\n{\n   return 0;\n}\n\n`;
    }

    function formatFunctionPointer(pointer, trim) {
        //remove spaces
        pointer = pointer.trim();
        //remove (::)
        pointer = pointer.substr(2);
        pointer = pointer.substr(0, pointer.length - 2);
        if (trim)
            return `(: ${pointer.trim()} :)`;
        return ` (: ${pointer.trim()} :) `;
    }

    function formatArgumentList(str, first, second, indent, quotes) {
        if (!str) return;
        first = first || 64;
        second = second || 75;
        indent = indent || 5;
        if (!Array.isArray(str))
            str = str.splitQuote(',');
        str = str.map(w => {
            w = w.trim().replace(/\n|\r/g, '');
            if (!quotes && !w.startsWith('"'))
                w = '"' + w;
            if (!quotes && !w.endsWith('"'))
                w += '"';
            return w;
        });
        var tmp = [];
        var tl = str.length;
        var tmp2 = [];
        var tl2 = 0;
        var w = first;
        for (var t = 0; t < tl; t++) {
            var c = str[t];
            if (tmp.length > 0)
                w = second;
            if (tl2 + (tmp2.length - 1) * 2 + c.length < w) {
                tmp2.push(c);
                tl2 += c.length;
            }
            else {
                tmp.push(tmp2.join(', '));
                tmp2 = [c];
                tl2 = c.length;
            }
        }
        if (tmp2.length)
            tmp.push(tmp2.join(', '));
        return tmp.join(',\n' + ' '.repeat(indent));
    }

    function ellipse(text, len) {
        if (!len || len < 1) len = 15;
        if (!text || text.lengt <= len) return text || '';
        return text.substr(0, len) + '...';
    }

    function writeFile(file, data) {
        var fd = fs.openSync(file, fs.constants.O_WRONLY | fs.constants.O_CREAT | fs.constants.O_TRUNC | fs.constants.O_SYNC);
        fs.writeSync(fd, data);
        fs.fsyncSync(fd);
        fs.closeSync(fd);
    }

    function openRemote(remoteFile) {
        var p;
        if (p = findEditor('remote:' + remoteFile)) {
            manager.switchToPanel(p);
            doUpdate(25);
            return;
        }
        if (!connected) {
            dialog.showMessageBox(
                remote.getCurrentWindow(),
                {
                    type: 'error',
                    title: 'Must be logged into the mud',
                    message: 'Must be connected to the mud to open a remote file',
                    defaultId: 1
                });
            return;
        }
        if (remoteFile && remoteFile.length !== 0) {
            var t = tmp.tmpNameSync(tmpOptions);
            _ied.downloadToFile(remoteFile, t, false, 'editor-download:remote-open:' + (manager.active ? manager.active.id : 0) + ':' + $id, false);
            showProgressDialog({
                file: remoteFile,
                tag: 'editor-download:remote-open:' + (manager.active ? manager.active.id : 0) + ':' + $id,
                title: 'Downloading&hellip;',
                tmp: t
            });
            $id++;
        }
        else {
            showBrowseDialog({
                defaultFile: manager.active.editor.remote,
                properties: ['openFile'],
                filters: $fileFilters,
            }, (files) => {
                if (!files || files.length === 0) return;
                var t = tmp.tmpNameSync(tmpOptions);
                _ied.downloadToFile(files[0], t, false, 'editor-download:remote-open:' + (manager.active ? manager.active.id : 0) + ':' + $id, false);
                showProgressDialog({
                    file: files[0],
                    tag: 'editor-download:remote-open:' + (manager.active ? manager.active.id : 0) + ':' + $id,
                    title: 'Downloading&hellip;',
                    tmp: t
                });
                $id++;
            });
        }
    }

    function openFile(file, remoteFile, dock, remoteEdit, tmpObj) {
        if (!file || file.length === 0) {
            if (remoteEdit)
                openRemote(remoteFile);
            else
                dialog.showOpenDialog(remote.getCurrentWindow(),
                    {
                        filters: $fileFilters,
                        properties: ['multiSelections', 'openFile'],
                        defaultPath: (manager.active && manager.active.editor) ? path.dirname(manager.active.editor.file) : (options.recent && options.recent.length ? path.dirname(options.recent[0].file) : '')
                    },
                    function (fileNames) {
                        if (fileNames === undefined) {
                            return;
                        }
                        openFiles(fileNames.map((l) => { return { file: l }; }), true, dock);
                    });
        }
        else {
            _opening[file] = 1;
            if (!remoteFile || remoteFile.length === 0)
                remoteFile = getRemoteCache(file);
            else if (!remoteEdit)
                setRemoteCache(file, remoteFile);
            if (!remoteEdit)
                _recent.unshift({ file: file, remote: remoteFile });
            createEditor({ file: file, open: true, remote: remoteFile, source: remoteEdit ? 1 : 0 }, true, dock, tmpObj);
            doUpdate(25);
            delete _opening[file];
        }
    }

    function openFiles(files, exists, dock) {
        if (files.length === 0) return;
        var panels = [];
        for (var f = 0, fl = files.length; f < fl; f++) {
            if (!existsSync(files[f].file)) {
                if (exists)
                    dialog.showMessageBox(remote.getCurrentWindow(), {
                        type: 'info',
                        title: 'Path does not exist',
                        message: 'The path \'' + files[f].file + '\' does not seem to exist anymore on disk.'
                    });
                continue;
            }
            _opening[files[f].file || files[f].path] = 1;
            if (!files[f].remote || files[f].remote.length === 0)
                files[f].remote = getRemoteCache(files[f].file || files[f].path);
            else if (!files[f].remoteEdit)
                setRemoteCache(files[f].file || files[f].path, files[f].remote);
            if (!files[f].remoteEdit)
                _recent.unshift({ file: files[f].file || files[f].path, remote: files[f].remote });
            else if (files[f].remoteEdit && (!files[f].file || files[f].file.length === 0)) {
                openRemote(files[f].remote);
                continue;
            }
            var p = createEditor({ file: files[f].file || files[f].path, remote: files[f].remote, open: true, source: files[f].remoteEdit ? 1 : 0 });
            if (p)
                panels.push(p);
            delete _opening[files[f].file || files[f].path];
        }
        manager.addPanels(panels, dock);
        doUpdate(25);
    }

    function setRemoteCache(file, remoteFile) {
        if (!options.cacheRemote || !remoteFile || remoteFile.length === 0) return;
        if (typeof remoteFile !== 'string') return;
        let p = path.join(parseTemplate('{data}'), 'editor');
        if (!existsSync(p))
            fs.mkdirSync(p);
        krypto = krypto || require('crypto');
        let name = krypto.createHash('md5').update(file).digest('hex');
        fs.writeFileSync(path.join(p, name), remoteFile);
    }

    function getTempDir() {
        let p = path.join(parseTemplate('{data}'), 'editor.temp');
        if (!existsSync(p))
            fs.mkdirSync(p);
        return p;
    }

    function getRemoteCache(file) {
        if (!options.cacheRemote || !file || file.length === 0) return null;
        krypto = krypto || require('crypto');
        let name = path.join(parseTemplate('{data}'), 'editor', krypto.createHash('md5').update(file).digest('hex'));
        if (!existsSync(name)) return null;
        return fs.readFileSync(name, 'utf8');
    }

    function addToRecent(file, remoteFile) {
        if (!options) loadOptions();
        if (!options.recent) options.recent = [];
        var recent = [];
        var r = options.recent.length;
        while (r--) {
            if (options.recent[r].file !== file)
                recent.unshift(options.recent[r]);
        }
        recent.unshift({ file: file, remote: remoteFile });
        if (recent.length > options.maxRecent)
            options.recent = recent.slice(0, options.maxRecent);
        else
            options.recent = recent;
        app.addRecentDocument(file);
        doUpdate(20);
    }

    function flushRecent() {
        if (!_recent.length) return;
        var r = _recent.length;
        while (r--) {
            addToRecent(_recent[r].file, _recent[r].remoteFile);
        }
        _recent = [];
        doUpdate(4);
    }

    function buildRecent() {
        var menu = [];
        var r = options.recent.length;
        while (r--) {
            menu.unshift(
                {
                    label: options.recent[r].file,
                    idx: r,
                    click: (item) => {
                        if (!existsSync(options.recent[item.idx].file)) {
                            dialog.showMessageBox(remote.getCurrentWindow(), {
                                type: 'info',
                                title: 'Path does not exist',
                                message: 'The path \'' + options.recent[item.idx].file + '\' does not seem to exist anymore on disk.'
                            });
                            options.recent.splice(item.idx, 1);
                            doUpdate(20);
                        }
                        else
                            openFile(options.recent[item.idx].file, options.recent[item.idx].remote);
                    }
                }
            );
            if (r < 10)
                menu[0].accelerator = 'CmdOrCtrl+' + (r + 1);
        }
        if (menu.length > 0) {
            menu.push({ type: 'separator' });
            menu.push({
                label: 'Clear Recently Opened',
                click: () => {
                    options.recent = [];
                    app.clearRecentDocuments();
                    doUpdate(20);
                }
            });
        }
        menubar.updateItem('file|open recent', { submenu: menu });
    }

    function saveFile(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        if (panel.editor.new)
            return saveFileAs(panel);
        try {
            panel.editor.save();
        }
        catch (err) {
            dialog.showMessageBox(
                remote.getCurrentWindow(),
                {
                    type: 'error',
                    title: 'Error saving',
                    message: err.toString(),
                    defaultId: 1
                });
            return false;
        }
        if (panel.editor.source === 1) {
            if (!connected) {
                dialog.showMessageBox(
                    remote.getCurrentWindow(),
                    {
                        type: 'error',
                        title: 'Must be logged into the mud',
                        message: 'Saving remote files requires being connected to the mud',
                        defaultId: 1
                    });
                return;
            }
            panel.editor.upload();
        }
        if (manager.active && manager.active.editor)
            manager.active.editor.focus();
        return true;
    }

    function saveAllFiles() {
        var keys = Object.keys(_editors);
        var k = keys.length;
        var p;
        while (k--) {
            p = keys[k];
            if (!_editors[p].editor.new && !_editors[p].editor.changed)
                continue;
            if (!saveFile(_editors[p]))
                return false;
        }
        return true;
    }

    function saveFileAs(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        if (panel.editor.source === 1) {
            if (!connected) {
                dialog.showMessageBox(
                    remote.getCurrentWindow(),
                    {
                        type: 'error',
                        title: 'Must be logged into the mud',
                        message: 'Saving remote files requires being connected to the mud',
                        defaultId: 1
                    });
                return;
            }
            uploadFileAs(panel, true);
            return;
        }
        var file = dialog.showSaveDialog(remote.getCurrentWindow(), {
            title: 'Save as...',
            defaultPath: panel.editor.file,
            filters: $fileFilters
        });
        if (file === undefined)
            return false;
        let old = panel.editor.file;
        if (!panel.editor.canSaveAs())
            return false;
        panel.editor.file = file;
        manager.setPanelTooltip(panel.editor.file, panel);
        manager.setPanelTitle(panel.editor.filename, panel);
        try {
            panel.editor.save();
        }
        catch (err) {
            dialog.showMessageBox(
                remote.getCurrentWindow(),
                {
                    type: 'error',
                    title: 'Error saving',
                    message: err.toString(),
                    defaultId: 1
                });
            return false;
        }
        addToRecent(file);
        delete _editors[old];
        _editors[file] = panel;
        if (manager.active && manager.active.editor) {
            manager.active.editor.focus();
            sbName.textContent = manager.active.editor.source === Source.local ? manager.active.editor.file : manager.active.editor.remote;
            sbName.title = manager.active.editor.source === Source.local ? manager.active.editor.file : manager.active.editor.remote;
        }
        return true;
    }

    function uploadFile(panel) {
        if (!connected) {
            dialog.showMessageBox(
                remote.getCurrentWindow(),
                {
                    type: 'error',
                    title: 'Must be logged into the mud',
                    message: 'Uploading requires being connected to the mud',
                    defaultId: 1
                });
            return;
        }
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        if (!panel.editor.supports('upload')) return;
        if (!panel.editor.remote || panel.editor.remote.length === 0) {
            showBrowseDialog({
                defaultFile: panel.editor.remote,
                properties: ['saveFile'],
                filters: $fileFilters,
                arguments: panel
            }, (files) => {
                if (!files || files.length === 0) return;
                $dialog.options.arguments.editor.remote = files[0];
                if (!$dialog.options.arguments.editor.new)
                    setRemoteCache($dialog.options.arguments.editor.file, $dialog.options.arguments.editor.remote);
                $dialog.options.arguments.editor.upload();
            });
        }
        else
            panel.editor.upload();
    }

    function uploadFileAs(panel, remoteEdit) {
        if (!connected) {
            dialog.showMessageBox(
                remote.getCurrentWindow(),
                {
                    type: 'error',
                    title: 'Must be logged into the mud',
                    message: 'Uploading requires being connected to the mud',
                    defaultId: 1
                });
            return;
        }
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        if (!panel.editor.supports('upload-as')) return;
        showBrowseDialog({
            defaultFile: remoteEdit ? panel.editor.remote : (options.uploadAs || panel.editor.remote),
            title: 'Save remote file as...',
            properties: ['saveFile'],
            filters: $fileFilters,
        }, (files) => {
            if (!files || files.length === 0) return;
            if (remoteEdit)
                panel.editor.remote = files[0];
            panel.editor.upload();
            options.uploadAs = files[0];
            saveOptions();
        });
    }

    function closeEditor(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        panel.editor.close();
        if (panel.tmp) {
            if (typeof panel.tmp === 'string') {
                if (existsSync(panel.tmp))
                    fs.unlinkSync(panel.tmp);
            }
            else {
                var t = panel.tmp.name;
                panel.tmp.removeCallback();
                panel.tmp = null;
                if (existsSync(t))
                    fs.unlinkSync(t);
            }
        }
        if (panel.diffFile)
            stopWatchFile(panel.diffFile);
        if (panel.editor.source)
            delete _editors['remote:' + panel.editor.remote];
        else
            delete _editors[panel.editor.file];
    }

    function revertFile(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        var choice;
        if (panel.editor.changed && panel.editor.new) {
            choice = dialog.showMessageBox(
                remote.getCurrentWindow(),
                {
                    type: 'question',
                    title: 'Revert new file?',
                    message: 'Revert ' + panel.editor.filename + ' to start and lose changes?',
                    buttons: ['Yes', 'No'],
                    defaultId: 1
                });
            if (choice === 0)
                panel.editor.revert();
        }
        else if (panel.editor.changed && !panel.editor.new) {
            choice = dialog.showMessageBox(
                remote.getCurrentWindow(),
                {
                    type: 'question',
                    title: 'Revert file?',
                    message: 'Revert ' + panel.editor.filename + ' and lose changes?',
                    buttons: ['Yes', 'No'],
                    defaultId: 1
                });
            if (choice === 0)
                panel.editor.revert();
        }
        if (manager.active && manager.active.editor)
            manager.active.editor.focus();
    }

    function revertAllFiles() {
        var keys = Object.keys(_editors);
        var k = keys.length;
        var p;
        while (k--) {
            p = keys[k];
            //not changed try next
            if (!_editors[p].editor.changed)
                continue;
            if (!revertFile(_editors[p]))
                return false;
        }
        return true;
    }

    function closeFile(panel) {
        if (!panel) {
            if (!manager.active)
                return;
            panel = manager.active;
        }
        if (panel)
            manager.removePanel(panel);
        if (manager.active && manager.active.editor)
            manager.active.editor.focus();
    }

    function closeAllFiles() {
        manager.removeAllPanels();
    }

    function confirmSave(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        var choice = dialog.showMessageBox(
            remote.getCurrentWindow(),
            {
                type: 'question',
                title: panel.editor.new ? 'Save file?' : 'Save changes?',
                message: panel.editor.new ? ('Save ' + panel.editor.filename + '?') : ('Save changes to ' + panel.editor.filename + '?'),
                buttons: ['Yes', 'No', 'Cancel'],
                defaultId: 1
            });
        //canceled
        if (choice === 2)
            return false;
        //no
        if (choice === 1)
            return true;
        //attempt to save
        return saveFile(panel);
    }

    function sortFiles(a, b, p) {
        if (fs.lstatSync(path.join(p, a)).isDirectory())
            return -1;
        if (fs.lstatSync(path.join(p, b)).isDirectory())
            return 1;
        return a.localeCompare(b);
    }

    function loadTemplates(p, root, exclude) {
        const menu = [];
        const files = fs.readdirSync(p);
        files.sort((a, b) => { return sortFiles(a, b, p); });
        const fl = files.length;
        var base = false;
        for (let f = 0; f < fl; f++) {
            if (exclude && exclude.indexOf(files[f]) !== -1)
                continue;
            if (fs.lstatSync(path.join(p, files[f])).isDirectory()) {
                menu.push({
                    label: capitalize(path.basename(files[f], path.extname(files[f])).replace(/_/g, ' ')),
                    submenu: loadTemplates(path.join(p, files[f]), path.join(root, files[f]))
                });
            }
            else {
                if (files[f] === 'base.c') {
                    base = true;
                    continue;
                }
                menu.push({
                    label: capitalize(path.basename(files[f], path.extname(files[f])).replace(/_/g, ' ')),
                    path: path.join(root, files[f]),
                    click: (item) => {
                        newFromFile(parseTemplate(path.join('{assets}', 'templates', item.path)), item.label.toLowerCase());
                    }
                });
            }
        }
        if (base) {
            if (menu.length > 0)
                menu.unshift({ type: 'separator' });
            menu.unshift(
                {
                    label: 'base',
                    newName: path.basename(p).replace(/_/g, ' ').slice(0, -1),
                    path: path.join(root, 'base.c'),
                    click: (item) => {
                        newFromFile(parseTemplate(path.join('{assets}', 'templates', item.path)), item.newName.toLowerCase());
                    }
                }
            );
        }
        return menu;
    }

    function findEditor(file) {
        if (!file || file.length === 0)
            return 0;
        return _editors[file];
    }

    function watchFile(file) {
        if (!_watched[file]) {
            _watched[file] = 1;
            watcher.add(file);
        }
        else
            _watched[file]++;
    }

    function stopWatchFile(file) {
        _watched[file]--;
        if (_watched[file] === 0) {
            watcher.unwatch(file);
            delete _watched[file];
        }
    }

    var enableAreas = false;

    function createEditor(data, add, dock, tmpObj) {//file, open, remoteFile, _new, value) {
        var p;
        if (data.source)
            p = findEditor('remote:' + data.remote);
        else
            p = findEditor(data.file);
        if (p) {
            p.editor.remote = data.remote;
            manager.switchToPanel(p);
            return null;
        }
        else {
            _loading++;
            p = manager.createPanel(data.source ? path.basename(data.remote) : path.basename(data.file), getFileIcon(data.file), data.file);
            p.tmp = tmpObj;
            data.container = p.pane;
            data.watch = (files) => {
                if (!files) return;
                for (var f = 0, fl = files.length; f < fl; f++)
                    watchFile(files[f]);
            };
            data.watchStop = (files) => {
                if (!files) return;
                for (var f = 0, fl = files.length; f < fl; f++) {
                    stopWatchFile(files[f]);
                }
            };
            if (enableAreas && path.extname(data.file) === '.area') {
                data.options = options.areaOptions;
                p.editor = new AreaEditor(data);
                p.editor.on('dialog-close', () => menubar.enabled = true);
                p.editor.on('dialog-cancel', () => menubar.enabled = true);
                p.editor.on('dialog-open', () => menubar.enabled = false);
                /*
                p.editor.on('room-dblclick', (room) => {
                    
                });
                */
                p.editor.on('map-context-menu', (e) => {
                    let temp = [];
                    temp.push({
                        label: 'Cut',
                        click: doCut,
                        accelerator: "CmdOrCtrl+C"
                    });
                    temp.push({
                        label: 'Copy',
                        click: doCopy,
                        accelerator: "CmdOrCtrl+X"
                    });
                    if (p.editor.supports('paste'))
                        temp.push({
                            label: 'Paste',
                            click: doPaste,
                            accelerator: "CmdOrCtrl+V"
                        });
                    temp.push({ type: 'separator' });
                    temp.push({
                        label: 'Delete',
                        click: () => {
                            p.editor.delete();
                            p.editor.focus();
                        },
                        accelerator: "Delete"
                    });
                    temp.push({ type: 'separator' });
                    temp.push({
                        label: 'Edit items',
                        click: () => {
                            p.editor.openItems();
                        }
                    });
                    temp.push({
                        label: 'Edit objects',
                        click: () => {
                            p.editor.openObjects();
                        }
                    });
                    temp.push({
                        label: 'Edit monsters',
                        click: () => {
                            p.editor.openMonsters();
                        }
                    });
                    temp.push({
                        label: 'Edit external exits',
                        click: () => {
                            p.editor.openExternalExits();
                        }
                    });
                    let inputMenu = Menu.buildFromTemplate(temp);
                    inputMenu.popup({ window: remote.getCurrentWindow() });
                });
            }
            else if (path.extname(data.file) === '.map' && data.source !== 1) {
                data.options = options.virtualOptions;
                p.editor = new VirtualEditor(data);
                p.editor.on('dialog-close', () => menubar.enabled = true);
                p.editor.on('dialog-cancel', () => menubar.enabled = true);
                p.editor.on('dialog-open', () => menubar.enabled = false);
                p.editor.on('room-dblclick', (room) => {
                    var f;
                    if (p.editor.maxLevel > 1)
                        f = room.x + "," + room.y + "," + room.z + ".c";
                    else
                        f = room.x + "," + room.y + ".c";
                    f = path.join(path.dirname(p.editor.file), f);
                    if (existsSync(f))
                        openFile(f);
                    else if (dialog.showMessageBox(
                        remote.getCurrentWindow(),
                        {
                            type: 'question',
                            title: 'Create room?',
                            message: 'Create new external room?',
                            buttons: ['Yes', 'No'],
                            defaultId: 1
                        }) === 0) {
                        if (p.editor.remote)
                            newFromValue(p.editor.externalCode(room), f, path.dirname(p.editor.remote) + '/' + path.basename(f));
                        else
                            newFromValue(p.editor.externalCode(room), f);
                    }
                });
                p.editor.on('map-context-menu', (e) => {
                    let temp = [];
                    temp.push({
                        label: 'Cut',
                        click: doCut,
                        accelerator: "CmdOrCtrl+C"
                    });
                    temp.push({
                        label: 'Copy',
                        click: doCopy,
                        accelerator: "CmdOrCtrl+X"
                    });
                    if (p.editor.supports('paste'))
                        temp.push({
                            label: 'Paste',
                            click: doPaste,
                            accelerator: "CmdOrCtrl+V"
                        });
                    temp.push({ type: 'separator' });
                    temp.push({
                        label: 'Delete',
                        click: () => {
                            p.editor.delete();
                            p.editor.focus();
                        },
                        accelerator: "Delete"
                    });
                    temp.push({ type: 'separator' });
                    var f;
                    if (p.editor.maxLevel > 1)
                        f = e.room.x + "," + e.room.y + "," + e.room.z + ".c";
                    else
                        f = e.room.x + "," + e.room.y + ".c";
                    f = path.join(path.dirname(p.editor.file), f);
                    if (existsSync(f)) {
                        temp.push({
                            label: 'Open external file',
                            file: f,
                            remote: p.editor.remote ? (path.dirname(p.editor.remote) + '/' + path.basename(f)) : null,
                            click: (item) => {
                                openFile(item.file, item.remote);
                            }
                        });
                    }
                    else {
                        temp.push({
                            label: 'Create external file',
                            file: f,
                            remote: p.editor.remote ? (path.dirname(p.editor.remote) + '/' + path.basename(f)) : null,
                            coords: [e.room.x, e.room.y, e.room.z],
                            click: (item) => {
                                newFromValue(p.editor.externalCode(...item.coords), item.file, item.remote);
                            }
                        });
                        temp.push({
                            label: 'Create empty external file',
                            file: f,
                            remote: p.editor.remote ? (path.dirname(p.editor.remote) + '/' + path.basename(f)) : null,
                            click: (item) => {
                                newFile(item.file, item.remote);
                            }
                        });
                        temp.push({
                            label: 'Room wizard',
                            file: f,
                            room: e.room,
                            remote: p.editor.remote ? (path.dirname(p.editor.remote) + '/' + path.basename(f)) : null,
                            click: (item) => {
                                var data = {};
                                var room = item.room;
                                data['room-wiz-file'] = item.file;
                                data['room-wiz-virtual'] = true;
                                data['room-wiz-create'] = `${room.x}, ${room.y}, ${room.z}, ${room.terrain}, ${room.item}, ${room.exits}`;
                                data['room-wiz-short'] = room.short;
                                data['room-wiz-long'] = room.long;
                                data['room-wiz-light'] = '' + (room.light || 0);
                                if (room.terrainType.length > 0 && room.terrainType !== '0')
                                    data['room-wiz-terrain'] = room.terrainType;
                                if (room.sound.length > 0 && room.sound !== '0')
                                    data['room-wiz-sounds'] = [{
                                        sound: 'default',
                                        description: room.sound
                                    }];
                                if (room.smell.length > 0 && room.smell !== '0')
                                    data['room-wiz-smells'] = [{
                                        smell: 'default',
                                        description: room.smell
                                    }];
                                data['room-wiz-items'] = room.items;
                                data['room-wiz-exits'] = room.external.map(r => {
                                    return {
                                        exit: r.exit,
                                        dest: r.dest,
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        climb: false,
                                        diff: 0,
                                    };
                                });
                                var tmp = [];
                                var x = room.x;
                                var y = room.y;
                                var z = room.z;
                                var depth = e.size.depth;
                                var f;
                                if (depth === 1)
                                    f = '(VIR+"{x},{y}.c")';
                                else
                                    f = '(VIR+"{x},{y},{z}.c")';
                                if ((room.exits & RoomExit.Up) === RoomExit.Up && z + 1 < depth) {
                                    tmp.push({
                                        exit: 'up',
                                        dest: f.replace('{x}', x).replace('{y}', y).replace('{z}', z + 1),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                if ((room.exits & RoomExit.Down) === RoomExit.Down && z > 0) {
                                    tmp.push({
                                        exit: 'down',
                                        dest: f.replace('{x}', x).replace('{y}', y).replace('{z}', z - 1),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                if ((room.exits & RoomExit.North) === RoomExit.North) {
                                    tmp.push({
                                        exit: 'north',
                                        dest: f.replace('{x}', x).replace('{y}', y - 1).replace('{z}', z),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                if ((room.exits & RoomExit.NorthEast) === RoomExit.NorthEast) {
                                    tmp.push({
                                        exit: 'northeast',
                                        dest: f.replace('{x}', x + 1).replace('{y}', y - 1).replace('{z}', z),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                if ((room.exits & RoomExit.East) === RoomExit.East) {
                                    tmp.push({
                                        exit: 'east',
                                        dest: f.replace('{x}', x + 1).replace('{y}', y).replace('{z}', z),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                if ((room.exits & RoomExit.SouthEast) === RoomExit.SouthEast) {
                                    tmp.push({
                                        exit: 'southeast',
                                        dest: f.replace('{x}', x + 1).replace('{y}', y + 1).replace('{z}', z),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                if ((room.exits & RoomExit.South) === RoomExit.South) {
                                    tmp.push({
                                        exit: 'south',
                                        dest: f.replace('{x}', x).replace('{y}', y + 1).replace('{z}', z),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                if ((room.exits & RoomExit.SouthWest) === RoomExit.SouthWest) {
                                    tmp.push({
                                        exit: 'southwest',
                                        dest: f.replace('{x}', x - 1).replace('{y}', y + 1).replace('{z}', z),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                if ((room.exits & RoomExit.West) === RoomExit.West) {
                                    tmp.push({
                                        exit: 'west',
                                        dest: f.replace('{x}', x - 1).replace('{y}', y).replace('{z}', z),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                if ((room.exits & RoomExit.NorthWest) === RoomExit.NorthWest) {
                                    tmp.push({
                                        exit: 'southwest',
                                        dest: f.replace('{x}', x - 1).replace('{y}', y - 1).replace('{z}', z),
                                        door: '',
                                        key: '',
                                        hidden: false,
                                        blocker: '',
                                        peer: '',
                                        destDoor: '',
                                        locked: false,
                                        climb: false,
                                        diff: 0,
                                    });
                                }
                                data['room-wiz-no-attack'] = (room.state & RoomStates.NoAttack) === RoomStates.NoAttack;
                                data['room-wiz-council'] = (room.state & RoomStates.Council) === RoomStates.Council;
                                data['room-wiz-no-magic'] = (room.state & RoomStates.NoMagic) === RoomStates.NoMagic;
                                data['room-wiz-indoors'] = (room.state & RoomStates.Indoors) === RoomStates.Indoors;
                                if ((room.state & RoomStates.Water) === RoomStates.Water)
                                    data['room-wiz-terrain'] = 'water';
                                data['room-wiz-create-body'] = '';
                                if ((room.state & RoomStates.Cold) === RoomStates.Cold)
                                    data['room-wiz-create-body'] += '   set_temperature(-200);\n';
                                else if ((room.state & RoomStates.Hot) === RoomStates.Hot)
                                    data['room-wiz-create-body'] += '   set_temperature(200);\n';
                                if (((room.state & RoomStates.SinkingUp) === RoomStates.SinkingUp && z + 1 < depth) || ((room.state & RoomStates.SinkingDown) === RoomStates.SinkingDown && z > 0 && depth > 1))
                                    data['room-wiz-create-body'] += '   set_living_sink(1);\n';
                                if ((room.state & RoomStates.SinkingUp) === RoomStates.SinkingUp && z + 1 < depth)
                                    data['room-wiz-create-body'] += `   set_up(VIR+"${x},${y},${z + 1}");\n`;
                                if ((room.state & RoomStates.SinkingDown) === RoomStates.SinkingDown && z > 0 && depth > 1)
                                    data['room-wiz-create-body'] += `   set_down(VIR+"${x},${y},${z - 1}");\n`;
                                data['room-wiz-exits'].push(...tmp);
                                roomWizard(data);
                            }
                        });
                    }
                    temp.push({ type: 'separator' });
                    temp.push({
                        label: 'Edit items',
                        click: () => {
                            p.editor.openItems();
                        }
                    });
                    temp.push({
                        label: 'Edit external exits',
                        click: () => {
                            p.editor.openExternalExits();
                        }
                    });
                    let inputMenu = Menu.buildFromTemplate(temp);
                    inputMenu.popup({ window: remote.getCurrentWindow() });
                });
            }
            else {
                p.editor = new MonacoCodeEditor(data);
                if (options.nativeIcons)
                    app.getFileIcon((path.extname(data.file).length !== 0 ? data.file : '.*'), { size: 'small' }, (err, icon) => {
                        if (err || !icon) return;
                        manager.setPanelIcon(icon.toDataURL(), p);
                    });
                p.editor.options = options.modelOptions;
            }
            /*
            if (!_watched[data.file]) {
                _watched[data.file] = 1;
                watcher.add(data.file);
            }
            else
                _watched[data.file]++;
            */
            p.editor.on('debug', file => {
                if (!connected) {
                    dialog.showMessageBox(
                        remote.getCurrentWindow(),
                        {
                            type: 'error',
                            title: 'Must be logged into the mud',
                            message: 'Testing can only be done when connected to the mud',
                            defaultId: 1
                        });
                    return;
                }
                if (!p.editor.remote)
                    showBrowseDialog({
                        defaultFile: p.editor.remote,
                        filters: $fileFilters,
                    }, (files) => {
                        if (!files || files.length === 0) return;
                        p.editor.remote = files[0];
                        var remoteFile = path.dirname(p.editor.remote) + '/jiMUD.' + path.basename(p.editor.remote);
                        if (p.editor.new || p.editor.changed) {
                            var t = tmp.tmpNameSync(tmpOptions);
                            p.editor.write(p.editor.value, t);
                            _ied.uploadTo(t.name, remoteFile, false, 'editor-upload:debug:' + (manager.active ? manager.active.id : 0), false);
                            showProgressDialog({
                                file: remoteFile,
                                tag: 'editor-upload:debug:' + (manager.active ? manager.active.id : 0),
                                title: 'Uploading&hellip;',
                                tmp: t
                            });
                        }
                        else {
                            setRemoteCache(file, p.editor.remote);
                            _ied.uploadTo(file, remoteFile, false, 'editor-upload:debug:' + (manager.active ? manager.active.id : 0), false);
                            showProgressDialog({
                                file: remoteFile,
                                title: 'Uploading&hellip;',
                                tag: 'editor-upload:debug:' + (manager.active ? manager.active.id : 0),
                            });
                        }
                    });
                else {
                    var remoteFile = path.dirname(p.editor.remote) + '/jiMUD.' + path.basename(p.editor.remote);
                    if (p.editor.new || p.editor.changed) {
                        var t = tmp.tmpNameSync(tmpOptions);
                        p.editor.write(p.editor.value, t);
                        _ied.uploadTo(t.name, remoteFile, false, 'editor-upload:debug:' + (manager.active ? manager.active.id : 0), false);
                        showProgressDialog({
                            file: remoteFile,
                            tag: 'editor-upload:debug:' + (manager.active ? manager.active.id : 0),
                            title: 'Uploading&hellip;',
                            tmp: t
                        });
                    }
                    else {
                        _ied.uploadTo(file, remoteFile, false, 'editor-upload:debug:' + (manager.active ? manager.active.id : 0), false);
                        showProgressDialog({
                            file: remoteFile,
                            title: 'Uploading&hellip;',
                            tag: 'editor-upload:debug:' + (manager.active ? manager.active.id : 0),
                        });
                    }
                }
            });
            p.editor.on('reload', (type, file) => {
                var choice;
                if (type === 'unlink') {
                    choice = dialog.showMessageBox(
                        remote.getCurrentWindow(),
                        {
                            type: 'question',
                            title: 'File deleted',
                            message: path.basename(file || p.editor.file) + ' has been deleted, keep open?',
                            buttons: ['Yes', 'No'],
                            defaultId: 1
                        });
                    //no
                    if ((!file || p.editor.file === file) && choice === 1)
                        closeFile(p);
                    else
                        p.editor.deleted(choice === 0, file);
                }
                else {
                    choice = dialog.showMessageBox(
                        remote.getCurrentWindow(),
                        {
                            type: 'question',
                            title: 'File changed',
                            message: path.basename((file || p.editor.file) + ' has been changed, reload?'),
                            buttons: ['Yes', 'No'],
                            defaultId: 1
                        });
                    //yes
                    if (choice === 0)
                        p.editor.revert(file);
                    //else
                    //p.editor.changed = true;
                }
            });
            p.editor.on('supports-changed', () => {
                if (p !== manager.active) return;
                doUpdate(2);
            });
            p.editor.on('changed', (length) => {
                updatePanel(p);
                if (p !== manager.active) return;
                doUpdate(2);
                if (length === -1)
                    sbSize.textContent = '';
                else
                    sbSize.textContent = 'Length: ' + length.toLocaleString();
            });
            p.editor.on('saved', () => {
                updatePanel(p);
                if (p !== manager.active) return;
                doUpdate(2);
            });
            p.editor.on('upload', files => {
                if (!files || files.length === 0) return;
                let fl = files.length;
                var t = [];
                for (let f = 0; f < fl; f++) {
                    if (files[f].local)
                        _ied.uploadTo(files[f].local, files[f].remote, false, 'editor-upload:' + (manager.active ? manager.active.id : 0) + ':' + f);
                    else if (files[f].hasOwnProperty('value')) {
                        var t2 = tmp.tmpNameSync(tmpOptions);
                        p.editor.write(files[f].value || '', t2);
                        _ied.uploadTo(t2.name, files[f].remote, false, 'editor-upload:' + (manager.active ? manager.active.id : 0) + ':' + f);
                        t.push(t2);
                    }
                }
                showProgressDialog({
                    files: files,
                    title: 'Uploading&hellip;',
                    tmp: t,
                    tag: 'editor-upload:' + (manager.active ? manager.active.id : 0) + ':'
                });
            });
            p.editor.on('reverted', () => {
                updatePanel(p);
                if (p !== manager.active) return;
                doUpdate(2);
            });
            p.editor.on('selection-changed', () => {
                if (p !== manager.active) return;
                doUpdate(2);
            });
            p.editor.on('menu-update', (menu, options) => {
                if (p !== manager.active) return;
                menubar.updateItem(menu, options);
            });
            p.editor.on('rebuild-buttons', () => {
                if (p !== manager.active) return;
                var buttons = document.getElementById("editor-buttons");
                while (buttons.firstChild) {
                    buttons.removeChild(buttons.firstChild);
                }
                if (p.editor.supports('buttons'))
                    buttons.append(...p.editor.buttons);
            });
            p.editor.on('contextmenu-diff', () => {
                var temp = [];
                if (p.editor.type === 1) {
                    temp.push({
                        label: '&Previous change',
                        click: gotoPrevChange
                    });
                    temp.push({
                        label: '&Next change',
                        click: gotoNextChange
                    });
                    temp.push({ type: 'separator' });
                }
                if (p.editor.supports('copy')) {
                    temp.push({
                        label: 'Copy',
                        click: doCopy,
                        accelerator: "CmdOrCtrl+X"
                    });
                    temp.push({ type: 'separator' });
                }
                temp.push({
                    label: 'Select all',
                    click: () => {
                        if (manager.active && manager.active.editor)
                            manager.active.editor.selectAll();
                    },
                    accelerator: "CmdOrCtrl+A"
                });
                if (p.editor.changed) {
                    temp.push({ type: 'separator' });
                    temp.push({
                        label: 'Revert',
                        click: () => { revertFile(); }
                    });
                }
                if (p.editor.supports('find') || p.editor.supports('replace'))
                    temp.push({ type: 'separator' });
                if (p.editor.supports('find'))
                    temp.push({
                        label: 'Find',
                        click: doFind
                    });
                if (p.editor.supports('replace'))
                    temp.push({
                        label: 'Replace',
                        click: doReplace
                    });

                if (p.editor.supports('menu|context')) {
                    temp.push({ type: 'separator' });
                    temp = temp.concat(p.editor.menu('context'));
                }
                let inputMenu = Menu.buildFromTemplate(temp);
                inputMenu.popup({ window: remote.getCurrentWindow() });
            });
            p.editor.on('contextmenu', () => {
                var temp = [];
                if (p.editor.supports('refresh')) {
                    temp.push({
                        label: 'Refresh',
                        click: doRefresh,
                        accelerator: "F5"
                    });
                    temp.push({ type: 'separator' });
                }
                if (p.editor.type === 1 && p.editor.diff) {
                    temp.push({
                        label: '&Previous change',
                        click: gotoPrevChange
                    });
                    temp.push({
                        label: '&Next change',
                        click: gotoNextChange
                    });
                    temp.push({ type: 'separator' });
                }
                if (p.editor.supports('undo'))
                    temp.push({
                        label: 'Undo',
                        click: doUndo,
                        accelerator: "CmdOrCtrl+Z"
                    });
                if (p.editor.supports('redo'))
                    temp.push({
                        label: 'Redo',
                        click: doRedo,
                        accelerator: "CmdOrCtrl+Y"
                    });
                if (p.editor.supports('undo') || p.editor.supports('redo'))
                    temp.push({ type: 'separator' });
                if (p.editor.supports('cut'))
                    temp.push({
                        label: 'Cut',
                        click: doCut,
                        accelerator: "CmdOrCtrl+C"
                    });
                if (p.editor.supports('copy'))
                    temp.push({
                        label: 'Copy',
                        click: doCopy,
                        accelerator: "CmdOrCtrl+X"
                    });
                if (p.editor.supports('paste'))
                    temp.push({
                        label: 'Paste',
                        click: doPaste,
                        accelerator: "CmdOrCtrl+V"
                    });
                if (p.editor.supports('copy'))
                    temp.push({
                        label: 'Paste to &Advanced Editor',
                        click: doEditor,
                        accelerator: "CmdOrCtrl+Shift+V"
                    });
                if (p.editor.supports('cut') || p.editor.supports('copy') || p.editor.supports('paste'))
                    temp.push({ type: 'separator' });
                temp.push({
                    label: 'Select all',
                    click: () => {
                        if (manager.active && manager.active.editor)
                            manager.active.editor.selectAll();
                    },
                    accelerator: "CmdOrCtrl+A"
                });
                if (p.editor.changed) {
                    temp.push({ type: 'separator' });
                    temp.push({
                        label: 'Revert',
                        click: () => { revertFile(); }
                    });
                }
                if (p.editor.supports('find') || p.editor.supports('replace'))
                    temp.push({ type: 'separator' });
                if (p.editor.supports('find'))
                    temp.push({
                        label: 'Find',
                        click: doFind
                    });
                if (p.editor.supports('replace'))
                    temp.push({
                        label: 'Replace',
                        click: doReplace
                    });

                if (p.editor.supports('menu|context')) {
                    temp.push({ type: 'separator' });
                    temp = temp.concat(p.editor.menu('context'));
                }
                let inputMenu = Menu.buildFromTemplate(temp);
                inputMenu.popup({ window: remote.getCurrentWindow() });
            });
            p.editor.on('error', () => {
                //logOutput(manager.active.editor.filename+': Indenting complete');
            });
            p.editor.on('progress-start', (type) => {
                if (type === 'indent')
                    logOutput(manager.active.editor.filename + ': Indenting started');
                else if (type === 'format')
                    logOutput(manager.active.editor.filename + ': Formatting started');
            });
            //p.editor.on('progress', (p, type) => {});
            p.editor.on('progress-complete', (type) => {
                if (type === 'indent')
                    logOutput(manager.active.editor.filename + ': Indenting finished');
                else if (type === 'format')
                    logOutput(manager.active.editor.filename + ': Formatting finished');
            });
            p.editor.on('output', (msg) => {
                logOutput(msg, true);
            });
            p.editor.on('location-changed', (x, y) => {
                if (p !== manager.active) return;
                if (p.editor.type == 1)
                    sbLocation.textContent = `Ln ${y}, Col ${x}`;
                else if (y != -1 && x != -1)
                    sbLocation.textContent = `${x}, ${y}`;
                else
                    sbLocation.textContent = '';
            });
            p.editor.on('status-message', (msg) => {
                if (p !== manager.active) return;
                sbMessage.textContent = msg;
            });
            p.editor.on('option-changed', (option, value) => {
                if (_loading) return;
                if (p.editor.type === 2) {
                    options.virtualOptions[option] = value;
                    saveOptions();
                }
            });
            p.editor.on('open-file', (file) => {
                if (existsSync(file))
                    openFile(file);
            });
            p.editor.on('browse-file', (e) => {
                showBrowseDialog({
                    defaultFile: e.file,
                    title: 'Select remote file',
                    properties: ['openFile'],
                    filters: $fileFilters,
                    arguments: e
                }, (files) => {
                    if (!files || files.length === 0) return;
                    $dialog.options.arguments.editor.value = files[0];
                    $dialog.options.arguments.editor.focus();
                });
            });
            p.editor.on('new-file', (file, value) => {
                newFromValue(value, file);
            });
            if (data.source)
                _editors['remote:' + data.remote] = p;
            else
                _editors[data.file] = p;
            p.spellCheck = options.spellCheck;
            _loading--;
        }
        if (add) {
            manager.addPanels([p], dock);
            doUpdate(1);
            p.editor.resize();
            p.editor.focus();
        }
        return p;
    }

    function doUpdate(type) {
        if (!type) return;
        _updating |= type;
        if (_updating === 0)
            return;
        window.requestAnimationFrame(() => {
            if ((_updating & 1) === 1) {
                updateUI();
                _updating &= ~1;
            }
            if ((_updating & 2) === 2) {
                updateUIChange();
                _updating &= ~2;
            }
            if ((_updating & 4) === 4) {
                buildRecent();
                _updating &= ~4;
            }
            if ((_updating & 8) === 8) {
                flushRecent();
                _updating &= ~8;
            }
            if ((_updating & 16) === 16) {
                saveOptions();
                _updating &= ~16;
            }
            if ((_updating & 32) === 32) {
                if (manager.active.editor.selectionChanged)
                    manager.active.editor.selectionChanged();
                _updating &= ~32;
            }
            if ((_updating & 64) === 64) {
                let l = manager.active.editor.location;
                sbLocation.textContent = `Ln ${l[1]}, Col ${l[0]}`;
                _updating &= ~64;
            }
            if ((_updating & 128) === 128) {
                var keys = Object.keys(_editors);
                var k = keys.length;
                var p;
                while (k--) {
                    p = keys[k];
                    if (!_editors[p]) continue;
                    _editors[p].editor.resize();
                }
                _updating &= ~128;
            }
            doUpdate(_updating);
        });
    }
    /*

.myGlyphMarginClass {
	background: red;
}
.myContentClass {
	background: lightblue;
}


var editor = monaco.editor.create(document.getElementById("container"), {
	value: jsCode,
	language: "javascript",
	glyphMargin: true
});

var decorations = editor.deltaDecorations([], [
	{
		range: new monaco.Range(3,1,3,1),
		options: {
			isWholeLine: true,
			className: 'myContentClass',
			glyphMarginClassName: 'myGlyphMarginClass'
		}
	}
]);
    */
</script>

</html>
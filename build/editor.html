<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>Advanced Editor</title>
    <link rel="shortcut icon" href="../assets/icons/png/edit.png" />
    <link href="../lib/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-select.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/editor.css" rel="stylesheet" type="text/css" />
    <script>
        if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="../lib/jquery.min.js"></script>
    <script src="../lib/bootstrap.min.js"></script>
    <script src="../lib/bootstrap-select.min.js"></script>
    <script src="../lib/tinymce/tinymce.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/smtextcolor.tinymce.js" type="text/javascript" charset="utf-8"></script>
    <script>
        //cSpell:words tinymce
        //cSpell:ignore smtextcolor, rgbcolor, noflash, dblunderline, shadowfore, shadowback, textcolor, cmdfont, editorcontent
        //cSpell:ignore hellip, selectall, strikethrough, nocolor, forecolor, hilitecolor, backcolor, splitbutton, nonbreaking, sendraw, onpostrender, insertdatetime, 
        /* global tinymce */
        const { remote, ipcRenderer, webFrame } = require('electron');
        const { nativeImage, dialog, Menu, MenuItem } = remote;
        const { stripHTML, htmlEncode } = require('./js/library');
        const { Settings } = require('./js/settings');
        const rgbcolor = require("rgbcolor");
        const fs = require('fs');
        const path = require('path');


        var spellchecker;

        var _colors, _ColorTable, options;
        var colorNames = {
            "BLACK": "Black",
            "RED": "Maroon",
            "GREEN": "Green",
            "ORANGE": "Olive",
            "BLUE": "Blue",
            "MAGENTA": "Purple",
            "WHITE": "Silver",
            "BOLD BLACK": "Dark Silver",
            "RED BOLD": "Red",
            "BOLD GREEN": "Lime",
            "YELLOW": "Yellow",
            "BOLD BLUE": "Blue",
            "BOLD MAGENTA": "Magenta",
            "BOLD CYAN": "Cyan",
            "BOLD WHITE": "White",
        };

        function clearReverse(els, c) {
            els.each(
                function (idx) {
                    if (!$(this).data('reverse'))
                        return;
                    if (c && $(this).hasClass('reverse'))
                        return;
                    var back, fore;
                    if (c) {
                        back = $(this).css('color');
                        fore = $(this).css('background-color');
                    }
                    else {
                        fore = $(this).parent().css('color');
                        back = $(this).parent().css('background-color');
                    }
                    if (back === "black")
                        back = '';
                    if (fore === "rgba(0, 0, 0, 0)")
                        fore = "black";
                    $(this).css('color', fore);
                    $(this).css('background-color', back);
                    if ($(this).children().length)
                        clearReverse($(this).children(), true);
                }
            );
        }

        function addReverse(els, c) {
            els.each(
                function (idx) {
                    if (c && $(this).hasClass('reverse'))
                        return;
                    var back, fore;
                    if (c) {
                        back = $(this).css('color');
                        fore = $(this).css('background-color');
                    }
                    else {
                        back = $(this).parent().css('color');
                        fore = $(this).parent().css('background-color');
                    }
                    if (back === "rgba(0, 0, 0, 0)")
                        back = "black";
                    if (fore === "rgba(0, 0, 0, 0)")
                        fore = "black";
                    if ($(this).children().length) {
                        clearReverse($(this).children(), true);
                        addReverse($(this).children(), true);
                    }
                    $(this).css('color', fore);
                    $(this).css('background-color', back);
                    $(this).data('reverse', true);

                }
            );
        }


        function toggleContextFormat(item) {
            var format = item.format || item.label;
            format = format.toLowerCase();
            tinymce.activeEditor.undoManager.transact(function () {
                $("#tinymce", tinymce.activeEditor.getDoc()).removeClass('animate');
                clearReverse($(".reverse", $(tinymce.activeEditor.getDoc()).contents()));
                tinymce.activeEditor.execCommand('mceToggleFormat', false, format);
                addReverse($(".reverse", $(tinymce.activeEditor.getDoc()).contents()));
                $("#tinymce", tinymce.activeEditor.getDoc()).addClass('animate');
            });
        }

        function createIcon(txt, name, fore, back, border, save) {
            if (!name) name = "image";
            var canvas = document.createElement('canvas');
            canvas.width = 16;
            canvas.height = 16;
            if (!canvas || !canvas.getContext)
                return;
            var ctx = canvas.getContext("2d");
            ctx.fillStyle = back || 'white';
            ctx.fillRect(0, 0, 16, 16);
            if (!back) {
                var image = ctx.getImageData(0, 0, 16, 16);
                var imageData = image.data, length = imageData.length;
                for (var i = 3; i < length; i += 4) {
                    imageData[i] = 0;
                }
                image.data = imageData;
                ctx.putImageData(image, 0, 0);
            }
            if (txt) {
                ctx.fillStyle = fore || '#333333';
                //ctx.font = "16px tinymce";
                ctx.font = 'bold 20px Helvetica';
                ctx.fillText(txt, 2, 15);
            }
            if (border) {
                ctx.fillStyle = "#d6d6d6";
                ctx.strokeRect(0, 0, 16, 16);
            }
            //if (save)
            //return fs.writeFileSync('C:\\Development\\jiMUD\\assets\\icons\\png\\colors\\' + name + '.png', nativeImage.createFromDataURL(canvas.toDataURL('image/png', 0.92)).toPng());

            return nativeImage.createFromDataURL(canvas.toDataURL('image/png', 0.92));
        }

        function appendFile() {
            dialog.showOpenDialog(remote.getCurrentWindow(),
                {
                    filters: [
                        { name: 'Text files (*.txt)', extensions: ['txt'] },
                        { name: 'LPC files (*.c, *.h, *.o)', extensions: ['c', 'h', 'o'] },
                        { name: 'All files (*.*)', extensions: ['*'] },
                    ]
                },
                function (fileNames) {
                    if (fileNames === undefined) {
                        return;
                    }
                    for (var f = 0, fl = fileNames.length; f < fl; f++)
                        fs.readFile(fileNames[f], 'utf8', (err, data) => {
                            if (err) {
                                dialog.showMessageBox(remote.getCurrentWindow(), {
                                    type: 'error',
                                    title: 'Error importing file',
                                    message: err
                                });
                                return;
                            }
                            data = htmlEncode(data);
                            data = data.replace(/ /g, '&nbsp;');
                            data = data.replace(/\t/g, '&nbsp;&nbsp;&nbsp;');
                            data = data.replace(/(?:\r\n|\r|\n)/g, '<br/>');
                            var content = tinymce.activeEditor.getContent({ format: 'text' });
                            if (content === '\n') {
                                tinymce.activeEditor.undoManager.transact(function () {
                                    tinymce.activeEditor.setContent(data);
                                });
                            }
                            else {
                                if (!content.endsWith('\n'))
                                    data = "<br>" + data;
                                tinymce.activeEditor.undoManager.transact(function () {
                                    tinymce.activeEditor.dom.add(tinymce.activeEditor.getBody(), 'span', {}, data);
                                });
                            }

                            //tinymce.activeEditor.insertContent(data);
                        });
                });
        }

        webFrame.setSpellCheckProvider("en-US", true, {
            spellCheck: function (text) {
                if (!spellchecker || !options.spellchecking)
                    return true;
                return !(spellchecker.isMisspelled(text));
            }
        });
        //https://www.npmjs.com/package/electron-spell-check-provider

        function buildHTMLStack(els) {
            var tag, $el, t, tl;
            var stack = [];
            for (var e = 0, el = els.length; e < el; e++) {
                $el = $(els[e]);
                tag = $el.prop("tagName");
                if (tag === "EM" || tag === "I")
                    tag = "ITALIC";
                else if (tag === "STRONG" || tag === "B")
                    tag = "BOLD";
                if (!tag)
                    stack.push('"' + $el.text() + '"');
                else if (tag === "SPAN") {
                    if (els[e].className != '') {
                        tag = els[e].className.toUpperCase().split(/\s+/g);
                        tl = tag.length;
                        for (t = 0; t < tl; t++) {
                            if (tag[t] === "NOFLASH")
                                stack.push("FLASH");
                            else if (tag[t].length > 0)
                                stack.push(tag[t]);
                        }
                        stack = stack.concat(buildHTMLStack($el.contents()));
                        for (t = 0; t < tl; t++) {
                            if (tag[t] === "NOFLASH")
                                stack.push("FLASH");
                            else if (tag[t].length > 0)
                                stack.push("/" + tag[t]);
                        }
                        continue;
                    }
                    else if ($el.css('text-decoration') === "line-through")
                        tag = "STRIKEOUT";
                    else if ($el.css('text-decoration') === "underline")
                        tag = "UNDERLINE";
                    else if ($el.data('mce-style')) {
                        tag = $el.data('mce-style').toUpperCase().split(";");
                        tl = tag.length;
                        for (t = 0; t < tl; t++) {
                            if (tag[t].endsWith("INHERIT") || tag[t].endsWith("BLACK"))
                                continue;
                            tag[t] = tag[t].trim();
                            tag[t] = tag[t].replace("BACKGROUND:", "BACKGROUND-COLOR:");
                            if (tag[t].length > 0)
                                stack.push(tag[t]);
                        }
                        stack = stack.concat(buildHTMLStack($el.contents()));
                        for (t = 0; t < tl; t++) {
                            if (tag[t].endsWith("INHERIT") || tag[t].endsWith("BLACK"))
                                continue;
                            if (tag[t].length > 0)
                                stack.push("/" + tag[t].trim());
                        }
                        continue;
                    }
                    else if ($el.css("color") || $el.css("background-color") || $el.css("background")) {
                        tag = [];
                        if ($el.css("color"))
                            tag.push("COLOR: " + new rgbcolor($el.css("color")).toHex().toUpperCase());
                        if ($el.css("background-color"))
                            tag.push("BACKGROUND-COLOR: " + new rgbcolor($el.css("background-color")).toHex().toUpperCase());
                        if ($el.css("background"))
                            tag.push("BACKGROUND-COLOR: " + new rgbcolor($el.css("background")).toHex().toUpperCase());
                        tl = tag.length;
                        for (t = 0; t < tl; t++) {
                            if (tag[t].length > 0)
                                stack.push(tag[t].trim());
                        }
                        stack = stack.concat(buildHTMLStack($el.contents()));
                        for (t = 0; t < tl; t++) {
                            if (tag[t].length > 0)
                                stack.push("/" + tag[t].trim());
                        }
                        continue;
                    }

                    stack.push(tag);
                    stack = stack.concat(buildHTMLStack($el.contents()));
                    stack.push("/" + tag);
                }
                else {
                    stack.push(tag);
                    stack = stack.concat(buildHTMLStack($el.contents()));
                    stack.push("/" + tag);
                }
            }
            return stack;
        }

        function getFormatedText() {
            var data = buildHTMLStack($("<html>" + tinymce.activeEditor.getContent({ format: 'raw' }).replace(/<\/div><div>/g, "<br>") + "</html>"));
            var buffer = [];
            var codes = [];
            var color, d, dl, rgb;
            if (options.enableDebug)
                ipcRenderer.send('debug', 'Advanced Editor Get Raw HTML: ' + tinymce.activeEditor.getContent({ format: 'raw' }));
            for (d = data.length - 1; d >= 0; d--) {
                if (!data[d].startsWith('"') && data[d] != "BR")
                    data.pop();
                else
                    break;
            }

            for (d = 0, dl = data.length; d < dl; d++) {
                switch (data[d]) {
                    case "BOLD":
                    case "ITALIC":
                    case "UNDERLINE":
                    case "STRIKEOUT":
                    case "DBLUNDERLINE":
                    case "OVERLINE":
                    case "FLASH":
                    case "REVERSE":
                        codes.push("%^" + data[d] + "%^");
                        buffer.push("%^" + data[d] + "%^");
                        break;
                    case "/DBLUNDERLINE":
                    case "/OVERLINE":
                    case "/FLASH":
                    case "/REVERSE":
                    case "/UNDERLINE":
                    case "/BOLD":
                    case "/ITALIC":
                    case "/STRIKEOUT":
                        codes.pop();
                        buffer.push("%^RESET%^");
                        if (codes.length > 0)
                            buffer.push(codes.join(''));
                        break;
                    case "SPAN":
                    case "/SPAN":
                    case "/BR":
                    case "/DIV":
                        break;
                    case "DIV":
                    case "BR":
                        if (codes.length > 0 && buffer.length > 0 && !buffer[buffer.length - 1].endsWith("%^RESET%^"))
                            buffer.push("%^RESET%^");
                        buffer.push('\n');
                        if (codes.length > 0)
                            buffer.push(codes.join(''));
                        break;
                    default:
                        if (data[d].startsWith("COLOR: #")) {
                            color = data[d].substr(8);
                            if (!_colors[color]) {
                                rgb = new rgbcolor(color);
                                color = nearestHex(rgb.toHex()).substr(1);
                            }
                            color = _colors[color];
                            codes.push("%^" + color + "%^");
                            buffer.push("%^" + color + "%^");
                        }
                        else if (data[d].startsWith("COLOR: ")) {
                            color = new rgbcolor(data[d].substr(7)).toHex().substr(1);
                            if (!_colors[color])
                                color = nearestHex("#" + color).substr(1);
                            color = _colors[color];
                            codes.push("%^" + color + "%^");
                            buffer.push("%^" + color + "%^");

                        }
                        else if (data[d].startsWith("/COLOR: ")) {
                            codes.pop();
                            buffer.push("%^RESET%^");
                            if (codes.length > 0)
                                buffer.push(codes.join(''));
                        }
                        else if (data[d].startsWith("BACKGROUND-COLOR: #")) {
                            color = data[d].substr(19);
                            if (!_colors[color]) {
                                rgb = new rgbcolor(color);
                                color = nearestHex(rgb.toHex()).substr(1);
                            }
                            if (_colors["B" + color])
                                color = _colors["B" + color];
                            else
                                color = _colors[color];
                            color = "%^B_" + color + "%^";
                            codes.push(color);
                            buffer.push(color);
                        }
                        else if (data[d].startsWith("BACKGROUND-COLOR: ")) {
                            color = new rgbcolor(data[d].substr(18)).toHex().substr(1);
                            if (!_colors[color])
                                color = nearestHex("#" + color).substr(1);
                            if (_colors["B" + color])
                                color = _colors["B" + color];
                            else
                                color = _colors[color];
                            color = "%^B_" + color + "%^";
                            codes.push("%^" + color + "%^");
                            buffer.push("%^" + color + "%^");
                        }
                        else if (data[d].startsWith("/BACKGROUND-COLOR: ")) {
                            codes.pop();
                            buffer.push("%^RESET%^");
                            if (codes.length > 0)
                                buffer.push(codes.join(''));
                        }
                        else if (data[d].startsWith('"'))
                            buffer.push(data[d].substring(1, data[d].length - 1));
                        break;
                }
            }
            return buffer.join('');
        }

        function getText() {
            return tinymce.activeEditor.getContent({ format: 'text' });
        }

        function getHTML() {
            return tinymce.activeEditor.getContent({ format: 'html' });
        }

        //{ color: 'red', hex: '#EA4235', rgb: { r: 234, g: 66, b: 53 } },
        var colorList = [];

        function nearestHex(hex) {
            //https://codereview.stackexchange.com/questions/132225/given-hexadecimal-rgb-color-find-the-closest-predefined-color
            var hexToRgb = function (hex) {
                var shortRegEx = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
                //hex = hex.replace(shortRegEx, "$1$1$2$2$3$3");
                hex = hex.replace(shortRegEx, function (full, r, g, b) {
                    return [r, r, g, g, b, b].join();
                });
                var longRegEx = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})?/i;
                var rgbArray = longRegEx.exec(hex);
                var rgbObj = rgbArray ? {
                    r: parseInt(rgbArray[1], 16),
                    g: parseInt(rgbArray[2], 16),
                    b: parseInt(rgbArray[3], 16)
                } : null;
                return rgbObj;
            };

            var closestHexFromRgb = function (rgbObj) {
                if (!rgbObj) {
                    throw new Error("The hex you provided is not formatted correctly. Please try in a format such as '#FFF' or '#DDFFDD'.");
                }

                var minDistance = Number.MAX_SAFE_INTEGER;
                var nearestHex = null;

                for (var i = 0; i < colorList.length; i++) {
                    var currentColor = colorList[i];
                    var distance = Math.sqrt(
                        Math.pow((rgbObj.r - currentColor.rgb.r), 2) +
                        Math.pow((rgbObj.g - currentColor.rgb.g), 2) +
                        Math.pow((rgbObj.b - currentColor.rgb.b), 2)
                    );
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestHex = currentColor.hex;
                    }
                }
                return nearestHex;
            };

            return closestHexFromRgb(hexToRgb(hex));

        }

        function initShadowMUD() {
            tinymce.PluginManager.add('shadowmud', function (editor, url) {

                this.applyFormat = function (format, value) {
                    editor.undoManager.transact(function () {
                        editor.focus();
                        clearReverse($(".reverse", $(editor.getDoc()).contents()));
                        if (value)
                            editor.formatter.apply(format, { value: value });
                        else
                            editor.formatter.apply(format);
                        addReverse($(".reverse", $(editor.getDoc()).contents()));
                        editor.nodeChanged();
                    });
                };

                this.removeFormat = function (format) {
                    editor.undoManager.transact(function () {
                        editor.focus();
                        clearReverse($(".reverse", $(editor.getDoc()).contents()));
                        editor.formatter.remove(format, { value: null }, null, true);
                        addReverse($(".reverse", $(editor.getDoc()).contents()));
                        editor.nodeChanged();
                    });
                };

                function buttonColorClick(evt) {
                    if (evt.color === 'transparent')
                        this.removeFormat(evt.format);
                    else
                        this.applyFormat(evt.format, evt.color);
                }

                function buttonPostRender() {
                    var btn = this;
                    editor.on('init', function () {
                        editor.formatter.formatChanged(btn.settings.format, function (state) {
                            btn.active(state);
                        });
                    });
                }

                function toggleFormat(format) {
                    if (!format || typeof format !== "string") format = this.settings.format;
                    tinymce.activeEditor.undoManager.transact(function () {
                        $("#tinymce", tinymce.activeEditor.getDoc()).removeClass('animate');
                        clearReverse($(".reverse", $(editor.getDoc()).contents()));
                        editor.execCommand('mceToggleFormat', false, format);
                        addReverse($(".reverse", $(editor.getDoc()).contents()));
                        $("#tinymce", tinymce.activeEditor.getDoc()).addClass('animate');
                    });
                }

                this.buildMenu = function () {
                    var cMenu = new Menu();
                    cMenu.append(new MenuItem({ role: 'undo', icon: path.join(__dirname, '../assets/icons/png/undo.png') }));

                    cMenu.append(new MenuItem({ role: 'redo', icon: path.join(__dirname, '../assets/icons/png/redo.png') }));
                    cMenu.append(new MenuItem({ type: 'separator' }));
                    cMenu.append(new MenuItem({ role: 'cut', icon: path.join(__dirname, '../assets/icons/png/cut.png') }));
                    cMenu.append(new MenuItem({ role: 'copy', icon: path.join(__dirname, '../assets/icons/png/copy.png') }));
                    cMenu.append(new MenuItem({ role: 'paste', icon: path.join(__dirname, '../assets/icons/png/paste.png') }));
                    cMenu.append(new MenuItem({ role: 'delete', icon: path.join(__dirname, '../assets/icons/png/delete.png') }));
                    cMenu.append(new MenuItem({ type: 'separator' }));
                    cMenu.append(new MenuItem({ role: 'selectall' }));
                    cMenu.append(new MenuItem({ type: 'separator' }));

                    cMenu.append(new MenuItem({
                        label: 'Style',
                        submenu: [
                            {
                                label: 'Bold',
                                icon: path.join(__dirname, '../assets/icons/png/bold.png'),
                                click: toggleContextFormat
                            },
                            {
                                label: 'Italic',
                                icon: path.join(__dirname, '../assets/icons/png/italic.png'),
                                click: toggleContextFormat
                            },
                            {
                                label: 'Underline',
                                icon: path.join(__dirname, '../assets/icons/png/underline.png'),
                                click: toggleContextFormat
                            },
                            {
                                label: 'Strikethrough',
                                icon: path.join(__dirname, '../assets/icons/png/strikethrough.png'),
                                click: toggleContextFormat
                            },
                            {
                                label: 'Overline',
                                icon: path.join(__dirname, '../assets/icons/png/overline.png'),
                                click: toggleContextFormat
                            },
                            {
                                label: 'Double Underline',
                                format: 'dblunderline',
                                icon: path.join(__dirname, '../assets/icons/png/dblunderline.png'),
                                click: toggleContextFormat
                            },
                            {
                                label: 'Flash',
                                icon: path.join(__dirname, '../assets/icons/png/flash.png'),
                                click: toggleContextFormat
                            },
                            {
                                label: 'Reverse',
                                icon: path.join(__dirname, '../assets/icons/png/reverse.png'),
                                click: toggleContextFormat
                            }
                        ]
                    }));

                    var fmi = [
                        {
                            label: 'No color',
                            icon: path.join(__dirname, '../assets/icons/png/nocolor.png'),
                            color: 'transparent',
                            format: 'forecolor',
                            click: buttonColorClick
                        }
                    ];
                    var bmi = [
                        {
                            label: 'No color',
                            icon: path.join(__dirname, '../assets/icons/png/nocolor.png'),
                            color: 'transparent',
                            format: 'hilitecolor',
                            click: buttonColorClick
                        }
                    ];
                    var icon;
                    for (var c = 0, cl = _ColorTable.length; c < cl; c += 2) {
                        //generate icon for the first 16 user definable colors, else use predefined icons
                        //if (c >= 64)
                        //icon = path.join(__dirname, '../assets/icons/png/colors/' + _ColorTable[c + 1].replace(/\s+/g, "-") + '.png');
                        //else
                        icon = createIcon(0, 0, 0, "#" + _ColorTable[c], true);
                        fmi.push({
                            label: _ColorTable[c + 1] + ", " + colorNames[_ColorTable[c + 1]],
                            icon: icon,
                            format: 'forecolor',
                            color: "#" + _ColorTable[c],
                            click: buttonColorClick
                        });
                        bmi.push({
                            label: _ColorTable[c + 1] + ", " + colorNames[_ColorTable[c + 1]],
                            icon: icon,
                            format: 'hilitecolor',
                            color: "#" + _ColorTable[c],
                            click: buttonColorClick
                        });
                    }
                    fmi.push({ type: 'separator' });
                    fmi.push({
                        label: 'More...',
                        icon: path.join(__dirname, '../assets/icons/png/color.png'),
                        click: function (evt) {
                            ipcRenderer.send('show-window', 'color', { type: 'forecolor', color: '', window: 'editor' });
                        }
                    });
                    bmi.push({ type: 'separator' });
                    bmi.push({
                        label: 'More...',
                        icon: path.join(__dirname, '../assets/icons/png/color.png'),
                        click: function (evt) {
                            ipcRenderer.send('show-window', 'color', { type: 'hilitecolor', color: '', window: 'editor' });
                        }
                    });
                    cMenu.append(new MenuItem({ type: 'separator' }));
                    cMenu.append(new MenuItem({ label: 'Text color', icon: path.join(__dirname, '../assets/icons/png/forecolor.png'), submenu: fmi }));
                    cMenu.append(new MenuItem({ label: 'Background color', icon: path.join(__dirname, '../assets/icons/png/backcolor.png'), submenu: bmi }));
                    return cMenu;
                };

                editor.addButton('send', {
                    type: 'splitbutton',
                    icon: 'fa-sendraw',
                    tooltip: 'Send to mud',
                    onclick: function () {
                        ipcRenderer.send('send-command', getFormatedText().replace(/(?:\r)/g, ''));
                    },
                    menu: [
                        {
                            text: 'Formatted as commands',
                            onclick: function () {
                                ipcRenderer.send('send-command', getFormatedText().replace(/(?:\r)/g, ''));
                            }
                        },
                        {
                            text: 'Text as commands',
                            onclick: function () {
                                ipcRenderer.send('send-command', getText().replace(/(?:\r)/g, ''));
                            }
                        },
                        {
                            text: 'Formatted as commands (No echo)',
                            onclick: function () {
                                ipcRenderer.send('send-background', getFormatedText().replace(/(?:\r)/g, ''));
                            }
                        },
                        {
                            text: 'Text as commands (No echo)',
                            onclick: function () {
                                ipcRenderer.send('send-background', getText().replace(/(?:\r)/g, ''));
                            }
                        },
                        {
                            text: 'Formatted verbatim (No echo)',
                            onclick: function () {
                                ipcRenderer.send('send', getFormatedText().replace(/(?:\r)/g, ''));
                            }
                        },
                        {
                            text: 'Text verbatim (No echo)',
                            onclick: function () {
                                ipcRenderer.send('send', getText().replace(/(?:\r)/g, ''));
                            }
                        },
                        {
                            text: 'Raw formatted (No echo)',
                            onclick: function () {
                                ipcRenderer.send('send-raw', getFormatedText().replace(/(?:\r)/g, ''));
                            }
                        },
                        {
                            text: 'Raw text (No echo)',
                            onclick: function () {
                                ipcRenderer.send('send-raw', getText().replace(/(?:\r)/g, ''));
                            }
                        }
                    ]
                });
                editor.addButton('append', {
                    icon: 'fa-open',
                    tooltip: 'Append file...',
                    onclick: appendFile
                });
                editor.addButton('overline', {
                    image: '../assets/icons/png/overline.png',
                    tooltip: 'Overline',
                    format: 'overline',
                    onclick: toggleFormat,
                    onpostrender: buttonPostRender
                });
                editor.addButton('dblunderline', {
                    image: '../assets/icons/png/dblunderline.png',
                    tooltip: 'Double Underline',
                    format: 'dblunderline',
                    onclick: toggleFormat,
                    onpostrender: buttonPostRender
                });
                editor.addButton('flash', {
                    tooltip: 'Flash',
                    format: 'flash',
                    image: '../assets/icons/png/flash.png',
                    onclick: toggleFormat,
                    onpostrender: buttonPostRender
                });
                editor.addButton('reverse', {
                    image: '../assets/icons/png/reverse.png',
                    tooltip: 'Reverse',
                    format: 'reverse',
                    onclick: toggleFormat,
                    onpostrender: buttonPostRender
                });

                editor.on('Change', function (e) {
                    addReverse($(".reverse", $(editor.getDoc()).contents()));
                });
                editor.addShortcut('ctrl+s', 'Strikethrough', function () {
                    toggleFormat('strikethrough');
                });
                editor.addShortcut('ctrl+o', 'Overline', function () {
                    toggleFormat('overline');
                });
                editor.addShortcut('ctrl+d', 'Double Underline', function () {
                    toggleFormat('dblunderline');
                });
                editor.addShortcut('ctrl+f', 'Flash', function () {
                    toggleFormat('flash');
                });
                editor.addShortcut('ctrl+r', 'Reverse', function () {
                    toggleFormat('reverse');
                });
            });
        }

        $(document).ready(() => {
            initShadowMUD();

            tinymce.init({
                selector: 'textarea',
                height: 500,
                menubar: false,
                browser_spellcheck: true,
                //contextmenu: false,
                resize: false,
                statusbar: false,
                nowrap: true,
                force_br_newlines: true,
                force_p_newlines: false,
                forced_root_block: "<span>",
                plugins: [
                    //contextmenu
                    "paste shadowmud insertdatetime smtextcolor nonbreaking"
                ],
                color_picker_callback: function (editor, color, format) { ipcRenderer.send('show-window', 'color', { type: format, color: color || '', window: 'editor' }); },
                color_picker_caption: 'More&hellip;',
                //contextmenu: "shadowfore shadowback | bold italic underline strikethrough overline dblunderline flash reverse",
                nonbreaking_force_tab: true,
                //textcolor_map: _ColorTable,
                //textcolor_rows: "17",
                //textcolor_cols: "16",
                textcolor_rows: "3",
                textcolor_cols: "8",
                toolbar: 'send | append | undo redo | forecolor backcolor | bold italic underline strikethrough overline dblunderline flash reverse | insertdatetime',
                content_css: 'css/editorcontent.css',
                formats: {
                    bold: { inline: 'strong', exact: true, links: true, remove_similar: true },
                    italic: { inline: 'em', exact: true, links: true, remove_similar: true },
                    overline: { inline: 'span', 'classes': 'overline', links: true, remove_similar: true },
                    dblunderline: { inline: 'span', 'classes': 'dblunderline', links: true, remove_similar: true },
                    flash: { inline: 'span', 'classes': 'flash', links: true, remove_similar: true },
                    reverse: { inline: 'span', 'classes': 'reverse', links: true, remove_similar: true },
                    underline: { inline: 'span', 'classes': 'underline', links: true, remove_similar: true },
                    strikethrough: { inline: 'span', 'classes': 'strikeout', links: true, remove_similar: true },
                    forecolor: { inline: 'span', styles: { textDecoration: 'inherit', border: 'inherit', color: '%value' }, exact: true, links: true, remove_similar: true },
                    hilitecolor: { inline: 'span', styles: { textDecoration: 'inherit', border: 'inherit', backgroundColor: '%value' }, exact: true, links: true, remove_similar: true }
                    //forecolor: { block: 'span', attributes: { 'data-color': '%value' }, styles: { textDecoration: 'inherit', border: 'inherit', color: '%value' }, exact: true, links: true, remove_similar: true },
                    //hilitecolor: { block: 'span', attributes: { 'data-backcolor': '%value' }, styles: { textDecoration: 'inherit', border: 'inherit', backgroundColor: '%value' }, exact: true, links: true, remove_similar: true }

                },
                init_instance_callback: function (editor) {
                    editor.on('PastePreProcess', function (e) {
                        if (options.enableDebug)
                            ipcRenderer.send('debug', 'Advanced Before Editor PastePreProcess: ' + e.content);
                        clearReverse($(".reverse", $(editor.getDoc()).contents()));
                        e.content = e.content.replace(/<\/p>/g, '<br>');
                        e.content = e.content.replace(/<\/h[1-6]>/g, '<br>');
                        e.content = e.content.replace(/<\/li>/g, '<br>');
                        var regex = /<pre(.*?)>((.|\s)*)<\/pre>/mgi;
                        var m;
                        while ((m = regex.exec(e.content)) !== null) {
                            if (m.index === regex.lastIndex) {
                                regex.lastIndex++;
                            }
                            e.content = e.content.substring(0, m.index) + e.content.substring(m.index, regex.lastIndex).replace(/\n/g, "<br>") + e.content.substring(regex.lastIndex);
                        }
                        if (options.enableDebug)
                            ipcRenderer.send('debug', 'Advanced After Editor PastePreProcess: ' + e.content);
                    });
                    editor.on('PastePreProcess', function (e) {
                        addReverse($(".reverse", $(editor.getDoc()).contents()));
                    });
                },
                paste_data_images: false,
                paste_word_valid_elements: 'b,strong,i,em,u,s,span,strike',
                paste_webkit_styles: "color background background-color text-decoration",
                paste_retain_style_properties: "color background background-color text-decoration font-weight",
                valid_elements: 'strong/b,em/i,u,span[style],strike/s,br',
                valid_styles: {
                    '*': 'color,background,background-color,text-decoration,font-weight'
                }
            });

            tinymce.activeEditor.on('contextmenu', function (e) {
                e.preventDefault();
                var cMenu = tinymce.activeEditor.plugins["shadowmud"].buildMenu();

                /*
                                    sel = tinymce.activeEditor.selection.getSel();
                                    if (!sel.isCollapsed) {
                
                                        // Detect if selection is backwards
                                        var range = document.createRange();
                                        range.setStart(sel.anchorNode, sel.anchorOffset);
                                        range.setEnd(sel.focusNode, sel.focusOffset);
                                        var backwards = range.collapsed;
                                        range.detach();
                
                                        // modify() works on the focus of the selection
                                        var endNode = sel.focusNode, endOffset = sel.focusOffset;
                                        sel.collapse(sel.anchorNode, sel.anchorOffset);
                
                                        var direction = [];
                                        if (backwards) {
                                            direction = ['backward', 'forward'];
                                        } else {
                                            direction = ['forward', 'backward'];
                                        }
                
                                        sel.modify("move", direction[0], "character");
                                        sel.modify("move", direction[1], "word");
                                        sel.extend(endNode, endOffset);
                                        sel.modify("extend", direction[1], "character");
                                        sel.modify("extend", direction[0], "word");
                                    }
                                    */
                var selRng = tinymce.activeEditor.selection.getRng();
                selRng.expand("word"); //expands the DOM range to the current word
                //tinymce.activeEditor.selection.setRng(selRng);
                var word = stripHTML(tinymce.activeEditor.selection.getContent());
                var ol = word.length;
                word = word.trimRight();
                var l = ol - word.length;
                ol = word.length;
                if (l > 0)
                    selRng.setEnd(selRng.endContainer, selRng.endOffset - l);
                word = word.trimLeft();
                l = ol - word.length;
                if (l > 0)
                    selRng.setStart(selRng.startContainer, selRng.startOffset - l);

                if (options.spellchecking && spellchecker && spellchecker.isMisspelled(word)) {
                    var words = spellchecker.getCorrectionsForMisspelling(word);
                    if (words.length > 0)
                        cMenu.insert(0, new MenuItem({ type: 'separator' }));
                    for (var w = words.length - 1; w >= 0; w--)
                        cMenu.insert(0, new MenuItem({
                            label: words[w],
                            click: function (item) {
                                tinymce.activeEditor.undoManager.transact(function () {
                                    tinymce.activeEditor.selection.setContent(item.label);
                                });
                            }
                        }));
                }
                cMenu.popup(remote.getCurrentWindow());
            });
            loadOptions();
        });

        function loadColors() {
            var _dColors = Settings.getColors();
            var c, color, r, g, b, idx, _bold = [], bl;
            _ColorTable = [];
            _colors = {};

            color = new rgbcolor(options.colors[0] || _dColors[0]).toHex().substr(1).toUpperCase();
            _colors[color] = "BLACK";
            _ColorTable.push(color, "BLACK");

            color = new rgbcolor(options.colors[1] || _dColors[1]).toHex().substr(1).toUpperCase();
            _colors[color] = "RED";
            _ColorTable.push(color, "RED");

            color = new rgbcolor(options.colors[2] || _dColors[2]).toHex().substr(1).toUpperCase();
            _colors[color] = "GREEN";
            _ColorTable.push(color, "GREEN");

            color = new rgbcolor(options.colors[3] || _dColors[3]).toHex().substr(1).toUpperCase();
            _colors[color] = "ORANGE";
            _ColorTable.push(color, "ORANGE");

            color = new rgbcolor(options.colors[4] || _dColors[4]).toHex().substr(1).toUpperCase();
            _colors[color] = "BLUE";
            _ColorTable.push(color, "BLUE");
            color = new rgbcolor(options.colors[5] || _dColors[5]).toHex().substr(1).toUpperCase();
            _colors[color] = "MAGENTA";
            _ColorTable.push(color, "MAGENTA");
            color = new rgbcolor(options.colors[6] || _dColors[6]).toHex().substr(1).toUpperCase();
            _colors[color] = "CYAN";
            _ColorTable.push(color, "CYAN");
            color = new rgbcolor(options.colors[7] || _dColors[7]).toHex().substr(1).toUpperCase();
            _colors[color] = "WHITE";
            _ColorTable.push(color, "WHITE");

            color = new rgbcolor(options.colors[8] || _dColors[8]).toHex().substr(1).toUpperCase();
            _colors[color] = "BOLD%^%^BLACK";
            _ColorTable.push(color, "BOLD BLACK");
            _bold.push(color);
            color = new rgbcolor(options.colors[9] || _dColors[9]).toHex().substr(1).toUpperCase();
            _colors[color] = "BOLD%^%^RED";
            _ColorTable.push(color, "BOLD RED");
            _bold.push(color);
            color = new rgbcolor(options.colors[10] || _dColors[10]).toHex().substr(1).toUpperCase();
            _colors[color] = "BOLD%^%^GREEN";
            _ColorTable.push(color, "BOLD GREEN");
            _bold.push(color);
            color = new rgbcolor(options.colors[11] || _dColors[11]).toHex().substr(1).toUpperCase();
            _colors[color] = "YELLOW";
            _ColorTable.push(color, "YELLOW");
            _bold.push(color);
            color = new rgbcolor(options.colors[12] || _dColors[12]).toHex().substr(1).toUpperCase();
            _colors[color] = "BOLD%^%^BLUE";
            _ColorTable.push(color, "BOLD BLUE");
            _bold.push(color);
            color = new rgbcolor(options.colors[13] || _dColors[13]).toHex().substr(1).toUpperCase();
            _colors[color] = "BOLD%^%^MAGENTA";
            _ColorTable.push(color, "BOLD MAGENTA");
            _bold.push(color);
            color = new rgbcolor(options.colors[14] || _dColors[14]).toHex().substr(1).toUpperCase();
            _colors[color] = "BOLD%^%^CYAN";
            _ColorTable.push(color, "BOLD CYAN");
            _bold.push(color);
            color = new rgbcolor(options.colors[15] || _dColors[15]).toHex().substr(1).toUpperCase();
            _colors[color] = "BOLD%^%^WHITE";
            _ColorTable.push(color, "BOLD WHITE");
            _bold.push(color);

            for (r = 0; r < 6; r++) {
                for (g = 0; g < 6; g++) {
                    for (b = 0; b < 6; b++) {
                        idx = `RGB${r}${g}${b}`;
                        color = '';
                        c = 0;
                        c = r * 40 + 55;
                        if (c < 16)
                            color += "0";
                        color += c.toString(16);
                        c = 0;
                        c = g * 40 + 55;
                        if (c < 16)
                            color += "0";
                        color += c.toString(16);
                        c = 0;
                        c = b * 40 + 55;
                        if (c < 16)
                            color += "0";
                        color += c.toString(16);
                        color = color.toUpperCase();
                        //_ColorTable.push(color);
                        //_ColorTable.push(idx);
                        if (!_colors[color])
                            _colors[color] = idx;
                        colorList.push({ color: idx, hex: '#' + color, rgb: { r: r * 40 + 55, g: g * 40 + 55, b: b * 40 + 55 } });
                    }
                }
            }

            for (r = 232; r <= 255; r++) {
                g = (r - 232) * 10 + 8;
                if (g < 16)
                    g = "0" + g.toString(16).toUpperCase();
                else
                    g = g.toString(16).toUpperCase();
                g = g + g + g;
                //_ColorTable.push(g);
                if (r < 242) {
                    //_ColorTable.push("mono0" + (r - 232));
                    if (!_colors[g])
                        _colors[g] = "mono0" + (r - 232);
                }
                else {
                    //_ColorTable.push("mono" + (r - 232));
                    if (!_colors[g])
                        _colors[g] = "mono" + (r - 232);
                }
            }
            for (b = 0, bl = _bold.length; b < bl; b++) {
                _colors["B" + _bold[b]] = _colors[nearestHex("#" + _bold[b]).substr(1)].toUpperCase();
            }
            tinymce.activeEditor.settings.textcolor_map = _ColorTable;
        }

        function loadOptions() {
            options = Settings.load(remote.getGlobal('settingsFile'));

            try {
                if (!spellchecker && options.spellchecking)
                    spellchecker = require('spellchecker');
            }
            catch (ex) {
                ipcRenderer.send('error', ex);
            }


            $(".mce-content-body", tinymce.activeEditor.getDoc()).css("font-size", options.cmdfontSize);
            $(".mce-content-body", tinymce.activeEditor.getDoc()).css("font-family", options.cmdfont + ", monospace");
            if (tinymce.activeEditor.formatter)
                tinymce.activeEditor.formatter.register('flash', { inline: 'span', 'classes': options.flashing ? 'flash' : 'noflash', links: true, remove_similar: true });
            else
                tinymce.activeEditor.settings.formats['flash'] = { inline: 'span', 'classes': options.flashing ? 'flash' : 'noflash', links: true, remove_similar: true };
            loadColors();
        }

        ipcRenderer.on('reload-options', (event) => {
            loadOptions();
        });

        ipcRenderer.on('set-color', (event, type, color, window) => {
            if (window != "editor") return;
            if (color === 'transparent')
                tinymce.activeEditor.plugins["shadowmud"].removeFormat(type);
            else
                tinymce.activeEditor.plugins["shadowmud"].applyFormat(type, "#" + color);
        });
    </script>
</head>

<body>
    <textarea></textarea>
</body>

</html>
<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <title>Log viewer</title>
    <link rel="shortcut icon" href="../assets/icons/win/code.ico" />
    <link href="../lib/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/bootstrap-select.min.css" rel="stylesheet" type="text/css" />
    <link href="../lib/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/main.css" rel="stylesheet" type="text/css" />
    <link href="css/ansi.css" rel="stylesheet" type="text/css" />
    <link href="css/theme.css" rel="stylesheet" type="text/css" />
    <link href="css/form.css" rel="stylesheet" type="text/css" />
    <link href="css/cm.css" rel="stylesheet" type="text/css" />
    <link href="css/log.viewer.css" rel="stylesheet" type="text/css" />
    <link href="css/datagrid.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <div id="toolbar" class="btn-toolbar" role="toolbar">
        <div class="btn-group" role="group">
            <button id="btn-open" type="button" class="btn btn-default btn-xs" title="Open..." onclick="openFile()">
                <i class="fa fa-folder-open-o"></i>
            </button>
            <button id="btn-close" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Close" onclick="closeFile()">
                <i class="fa fa-window-close"></i>
            </button>
            <button id="btn-close-all" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Close All" onclick="closeAllFiles()">
                <span class="fa-stack" style="top: -1px;width: 1em;height: 1em;line-height: 1em;font-size: 1em;">
                    <i class="fa fa-window-close fa-stack-2x" style="font-size: 1em;margin-top: -2px;margin-left: 2px;"></i>
                    <i class="fa fa-window-close fa-stack-2x" style="font-size: 1em;margin-top: 2px;margin-left: -2px;"></i>
                </span>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-copy" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Copy" onclick="doCopy()">
                <i class="fa fa-copy"></i>
            </button>
        </div>
        <div class="btn-group" role="group">
            <button id="btn-find" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Find" onclick="doFind()">
                <i class="fa fa-search"></i>
            </button>
        </div>
        <button id="btn-refresh" type="button" disabled="disabled" class="btn btn-default btn-xs" title="Refresh" onclick="doRefresh()">
            <i class="fa fa-refresh"></i>
        </button>
    </div>
    <div id="statusbar" class="statusbar">
        <span id="statusbar-file" class="left"></span>
        <span id="statusbar-message" class="center"></span>
        <span id="statusbar-size" class="right"></span>
    </div>
    <div id="display" style="display: none"></div>
</body>
<script>
    if (typeof module === 'object') { window.module = module; module = undefined; }
</script>
<script src="../lib/jquery.min.js" type="text/javascript"></script>
<script src="../lib/bootstrap.min.js" type="text/javascript"></script>
<script src="../lib/bootstrap-select.min.js" type="text/javascript"></script>
<script>
    const { DockManager } = require('./js/dockmanager');
    const { remote, ipcRenderer, clipboard } = require('electron');
    const { dialog, Menu, MenuItem, app } = remote;
    const { Menubar } = require('./js/menubar');
    const { Settings } = require('./js/settings');
    const { Display } = require('./js/display');
    const { FormatType, FontStyle } = require('./js/types');
    // eslint-disable-next-line no-unused-vars
    const { parseTemplate, existsSync, isDirSync, walkSync } = require('./js/library');

    const path = require('path');
    const fs = require('fs');
    remote.getCurrentWindow().setEnabled(false);

    var menubar, options;
    let $closeWindow = false;
    var _recent = [];
    var _viewers = [];
    var _updating = 0;
    var sbSize = document.getElementById('statusbar-size');
    var sbName = document.getElementById('statusbar-file');
    var sbMessage = document.getElementById('statusbar-message');
    var logPath = '';
    var font, fontSize;
    var display;

    var $fileFilters = [
        { name: 'Supported files (*.txt, *.htm, *.html)', extensions: ['txt', 'htm', 'html'] },
        { name: 'All files (*.*)', extensions: ['*'] },
    ];

    menubar = new Menubar([
        {
            label: '&File',
            id: 'file',
            submenu: [
                {
                    label: '&Open...',
                    accelerator: "CmdOrCtrl+O",
                    click: () => { openFile(); }
                },
                {
                    label: 'Open &Recent',
                    submenu: [],
                },
                { type: 'separator' },
                {
                    label: '&Preferences...',
                    accelerator: "CmdOrCtrl+Comma",
                    click: () => {
                        ipcRenderer.send('show-window', 'prefs');
                    }
                },                
                { type: 'separator' },
                {
                    label: '&Close',
                    click: () => { closeFile(); },
                    accelerator: "CmdOrCtrl+F4",
                    enabled: false
                },
                {
                    label: 'C&lose All',
                    click: () => { closeAllFiles(); },
                    accelerator: "CmdOrCtrl+Shift+F4",
                    enabled: false
                },
                { type: 'separator' },
                {
                    label: 'E&xit',
                    accelerator: "CmdOrCtrl+Shift+W",
                    click: () => { window.close(); }
                }
            ]
        },
        {
            label: '&Edit',
            submenu: [
                {
                    label: '&Copy',
                    accelerator: "CmdOrCtrl+C",
                    click: doCopy,
                    enabled: false,
                },
                { type: 'separator' },
                {
                    label: '&Select All',
                    accelerator: "CmdOrCtrl+A",
                    enabled: false,
                    click: () => {
                        if (manager.active && manager.active.viewer)
                            selectText(manager.active.viewer);
                    }
                },
                { type: 'separator' },
                {
                    label: '&Find',
                    accelerator: "CmdOrCtrl+F",
                    enabled: false,
                    click: doFind
                },
            ]
        },
        {
            label: '&View',
            submenu: [
                {
                    label: '&Refresh',
                    accelerator: "F5",
                    enabled: false,
                    click: doRefresh
                },
                { type: 'separator' },
                {
                    label: '&Toggle Developer Tools',
                    click: () => {
                        if (remote.getCurrentWindow().isDevToolsOpened())
                            remote.getCurrentWindow().closeDevTools();
                        else
                            remote.getCurrentWindow().openDevTools();
                    },
                    enabled: true
                },
                {
                    type: 'separator'
                },
                {
                    role: 'resetzoom',
                    enabled: true
                },
                {
                    role: 'zoomin',
                    enabled: true
                },
                {
                    role: 'zoomout',
                    enabled: true
                },
            ]
        },
    ]);
    //menubar.enabled = false;
    var manager = new DockManager();
    manager.hideTabstrip = false;
    manager.on('add', () => {
    });
    manager.on('add-pane', (idx, pane) => {
    });
    manager.on('destroy-pane', (idx) => {
    });
    manager.on('tab-moved', (e) => {
        if (e.panel && e.panel.editor)
            e.panel.editor.focus();
    });
    manager.on('remove', (e) => {
    });
    manager.on('removed', (e, pane) => {
        closeViewer(e.panel);
        doUpdate(1);
    });
    manager.on('dock-changed', (e, pane, oPane) => {
        doUpdate(1);
    });
    manager.on('resize', () => {

    });
    manager.on('activated', (e, pane) => {
        doUpdate(1);
    });
    manager.on('pane-activated', () => {
        doUpdate(1);
    });
    manager.on('deactivated', (e, pane) => {
    });
    manager.on('dragenter', (e) => {
        event.dataTransfer.dropEffect = "copy";
        event.dataTransfer.effectAllowed = "copy";
        if (e.dataTransfer.items) {
            for (var i = 0; i < e.dataTransfer.items.length; i++) {
                // If dropped items aren't files, reject them
                if (e.dataTransfer.items[i].kind === 'file') {
                    event.dataTransfer.dropEffect = "link";
                    event.dataTransfer.effectAllowed = "link";
                    event.preventDefault();
                    event.cancelBubble = true;
                    event.stopPropagation();
                    return false;
                }
            }
        }
        else if (e.dataTransfer.files && e.dataTransfer.files.length) {
            event.dataTransfer.dropEffect = "link";
            event.dataTransfer.effectAllowed = "link";
            event.preventDefault();
            event.cancelBubble = true;
            event.stopPropagation();
            return false;
        }
    });
    manager.on('dragover', (e) => {
        event.dataTransfer.dropEffect = "copy";
        event.dataTransfer.effectAllowed = "copy";
        if (e.dataTransfer.items) {
            for (var i = 0; i < e.dataTransfer.items.length; i++) {
                // If dropped items aren't files, reject them
                if (e.dataTransfer.items[i].kind === 'file') {
                    event.dataTransfer.dropEffect = "link";
                    event.dataTransfer.effectAllowed = "link";
                    event.preventDefault();
                    event.cancelBubble = true;
                    event.stopPropagation();
                    return false;
                }
            }
        }
        else if (e.dataTransfer.files && e.dataTransfer.files.length) {
            event.dataTransfer.dropEffect = "link";
            event.dataTransfer.effectAllowed = "link";
            event.preventDefault();
            event.cancelBubble = true;
            event.stopPropagation();
            return false;
        }
    });
    manager.on('drop', (e) => {
        var files = [];
        var f, fl;
        if (e.dataTransfer.items) {
            for (var i = 0; i < e.dataTransfer.items.length; i++) {
                // If dropped items aren't files, reject them
                if (e.dataTransfer.items[i].kind === 'file')
                    files.push(e.dataTransfer.items[i].getAsFile());
            }
        }
        else if (e.dataTransfer.files && e.dataTransfer.files.length) {
            for (f = 0, fl = e.dataTransfer.files.length; f < fl; f++)
                files.push(e.dataTransfer.files[f]);
        }
        if (files.length) {
            if (files.length === 0) {
                event.preventDefault();
                event.cancelBubble = true;
                event.stopPropagation();
                return;
            }
            files = files.map(f => {
                return { file: f.path };
            });
            event.preventDefault();
            event.cancelBubble = true;
            event.stopPropagation();
            openFiles(files);
        }
    });
    manager.on('tab-contextmenu', (e) => {
        var temp = [];
        temp.push({
            label: 'Refresh',
            click: () => {
                loadContents(e.panel);
            },
            accelerator: "F5"
        });
        temp.push({ type: 'separator' });
        temp.push({
            label: '&Copy path',
            click: () => {
                clipboard.writeText(e.panel.file || '');
                clipboard.writeText(e.panel.file || '', 'selection');
            }
        });
        temp.push({ type: 'separator' });
        if (temp.length)
            temp.push({ type: 'separator' });
        temp.push({
            label: '&Close',
            click: () => { closeFile(e.panel); },
            accelerator: "CmdOrCtrl+F4"
        });
        if (manager.panels.length > 1)
            temp.push({
                label: '&Close Others',
                click: () => { manager.removeAllPanels(e.panel); }
            });
        if (manager.panels.length - 1 > manager.getPanelIndex(e.panel))
            temp.push({
                label: '&Close to the Right',
                click: () => { manager.removeAllPanelsAfter(e.panel); }
            });
        let tabMenu = Menu.buildFromTemplate(temp);
        tabMenu.popup({ window: remote.getCurrentWindow() });
    });

    function updateUI() {
        var enabled = (manager.active && manager.active.viewer) ? true : false;
        if (enabled)
            document.title = 'Log viewer - ' + manager.active.tab.innerText;
        else
            document.title = 'Log viewer';
        $("#btn-close").prop('disabled', !enabled);
        $("#btn-close-all").prop('disabled', !enabled);
        menubar.updateItem('File|Close', { enabled: enabled });
        menubar.updateItem('File|Close all', { enabled: enabled });
        sbSize.textContent = enabled ? ('Length: ' + manager.active.viewer.textContent.length.toLocaleString()) : '';
        sbMessage.textContent = '';
        sbName.textContent = enabled ? manager.active.file : '';
        sbName.title = enabled ? manager.active.file : '';
        doUpdate(2);
    }

    function updateUIChange() {
        const sel = getSelection();
        var selected = false;
        if (manager.active && manager.active.viewer && !sel.isCollapsed && sel.type === 'Range' && manager.active.viewer.contains(sel.anchorNode))
            selected = true;
        $("#btn-copy").prop('disabled', (manager.active && manager.active.viewer) ? !selected : true);
        menubar.updateItem('edit|copy', { enabled: (manager.active && manager.active.viewer) ? selected : false });
        $("#btn-find").prop('disabled', (manager.active && manager.active.viewer) ? false : true);
        menubar.updateItem('edit|find', { enabled: (manager.active && manager.active.viewer) ? false : false });
        $("#btn-refresh").prop('disabled', (manager.active && manager.active.viewer) ? false : true);
        menubar.updateItem('view|refresh', { enabled: (manager.active && manager.active.viewer) ? true : false });
        menubar.updateItem('edit|select all', { enabled: (manager.active && manager.active.viewer) ? true : false });
    }

    function loadOptions(data) {
        var set = Settings.load(remote.getGlobal('settingsFile'));
        if (!data)
            options = set.extensions["log-viewer"];
        else
            options = data;
        if (!options) {
            options = {
                'opened': [],
                'browse': null,
                'recent': [],
                'reopen': true
            };
            saveOptions();
        }
        font = set.font;
        fontSize = set.fontSize;
        if (!font || font.length === 0)
            font = '\'Courier New\', Courier, monospace';
        else //fall back just incase
            font += ', monospace';
        if (!fontSize || fontSize.length === 0)
            fontSize = '1em';
        logPath = parseTemplate(set.logPath);
        if (display)
            display.updateFont(font, fontSize);

        var keys = Object.keys(_viewers);
        var k = keys.length;
        var p;
        while (k--) {
            //no editor or of not changed and new try next
            p = keys[k];
            if (!_viewers[p])
                continue;
            _viewers[p].viewer.style.fontFamily = font;
            _viewers[p].viewer.style.fontSize = fontSize;
        }
    }

    function saveOptions() {
        ipcRenderer.send('setting-changed', { type: 'extensions', name: 'log-viewer', value: options });
    }

    function closeViewer(panel) {
        if (!panel) {
            if (!manager.active)
                return false;
            panel = manager.active;
        }
        if (_viewers[panel.file].display)
            _viewers[panel.file].display.dispose();
        delete _viewers[panel.file];
    }

    function openFile(file, dock) {
        if (!file || file.length === 0) {
            dialog.showOpenDialog(remote.getCurrentWindow(),
                {
                    filters: $fileFilters,
                    properties: ['multiSelections', 'openFile'],
                    defaultPath: (manager.active && manager.active.file) ? path.dirname(manager.active.file) : (options.recent && options.recent.length ? path.dirname(options.recent[0]) : logPath)
                },
                function (fileNames) {
                    if (fileNames === undefined) {
                        return;
                    }
                    openFiles(fileNames.map((l) => { return { file: l }; }), true, dock);
                });
        }
        else {
            _recent.unshift(file);
            createViewer({ file: file, open: true }, true, dock);
            doUpdate(25);
        }
    }

    function openFiles(files, exists, dock) {
        if (files.length === 0) return;
        var panels = [];
        for (var f = 0, fl = files.length; f < fl; f++) {
            if (!existsSync(files[f])) {
                if (exists)
                    dialog.showMessageBox(remote.getCurrentWindow(), {
                        type: 'info',
                        title: 'Path does not exist',
                        message: 'The path \'' + files[f] + '\' does not seem to exist anymore on disk.'
                    });
                continue;
            }
            _recent.unshift(files[f] || files[f].path);
            var p = createViewer({ file: files[f] || files[f].path, open: true });
            if (p)
                panels.push(p);
        }
        manager.addPanels(panels, dock);
        doUpdate(25);
    }

    function addToRecent(file) {
        if (!options) loadOptions();
        if (!options.recent) options.recent = [];
        var recent = [];
        var r = options.recent.length;
        while (r--) {
            if (options.recent[r] !== file)
                recent.unshift(options.recent[r]);
        }
        recent.unshift(file);
        if (recent.length > options.maxRecent)
            options.recent = recent.slice(0, options.maxRecent);
        else
            options.recent = recent;
        app.addRecentDocument(file);
        doUpdate(20);
    }

    function flushRecent() {
        if (!_recent.length) return;
        var r = _recent.length;
        while (r--)
            addToRecent(_recent[r]);
        _recent = [];
        doUpdate(4);
    }

    function buildRecent() {
        var menu = [];
        var r = options.recent.length;
        while (r--) {
            menu.unshift(
                {
                    label: options.recent[r],
                    idx: r,
                    click: (item) => {
                        if (!existsSync(options.recent[item.idx])) {
                            dialog.showMessageBox(remote.getCurrentWindow(), {
                                type: 'info',
                                title: 'Path does not exist',
                                message: 'The path \'' + options.recent[item.idx] + '\' does not seem to exist anymore on disk.'
                            });
                            options.recent.splice(item.idx, 1);
                            doUpdate(20);
                        }
                        else
                            openFile(options.recent[item.idx]);
                    }
                }
            );
            if (r < 10)
                menu[0].accelerator = 'CmdOrCtrl+' + (r + 1);
        }
        if (menu.length > 0) {
            menu.push({ type: 'separator' });
            menu.push({
                label: 'Clear Recently Opened',
                click: () => {
                    options.recent = [];
                    app.clearRecentDocuments();
                    doUpdate(20);
                }
            });
        }
        menubar.updateItem('file|open recent', { submenu: menu });
    }

    function getSelectionText() {
        var text = "";
        if (window.getSelection) {
            text = window.getSelection().toString();
        } else if (document.selection && document.selection.type != "Control") {
            text = document.selection.createRange().text;
        }
        return text;
    }

    function selectText(node) {
        if (!node) return;
        if (typeof node === 'string')
            node = document.getElementById(node);
        if (document.body.createTextRange) {
            const range = document.body.createTextRange();
            range.moveToElementText(node);
            range.select();
        } else if (window.getSelection) {
            const selection = window.getSelection();
            const range = document.createRange();
            range.selectNodeContents(node);
            selection.removeAllRanges();
            selection.addRange(range);
        } else {
            console.warn("Could not select text in node: Unsupported browser.");
        }
    }

    function findViewer(file) {
        if (!file || file.length === 0)
            return 0;
        return _viewers[file];
    }

    function createViewer(data, add, dock) {
        var p = findViewer(data.file);
        if (p) {
            manager.switchToPanel(p);
            return null;
        }
        p = manager.createPanel(path.basename(data.file), 'fa fa-file-text-o', data.file);
        p.file = data.file;
        p.viewer = document.createElement('pre');
        p.viewer.classList.add('viewer');
        p.viewer.tabIndex = '-1';
        p.viewer.style.fontSize = fontSize;
        p.viewer.style.fontFamily = font;
        p.viewer.id = 'viewer' + p.id;
        p.pane.appendChild(p.viewer);
        p.viewer.addEventListener('contextmenu', e => {
            e.preventDefault();
            const sel = getSelection();
            let inputMenu;
            if (!sel.isCollapsed && sel.type === 'Range' && p.viewer.contains(sel.anchorNode)) {
                inputMenu = Menu.buildFromTemplate([
                    { role: 'copy' },
                    { type: 'separator' },
                    {
                        label: '&Select All',
                        accelerator: "CmdOrCtrl+A",
                        click: () => {
                            if (manager.active && manager.active.viewer)
                                selectText(manager.active.viewer);
                        }
                    }
                ]);
            }
            else
                inputMenu = Menu.buildFromTemplate([
                    {
                        label: '&Select All',
                        accelerator: "CmdOrCtrl+A",
                        click: () => {
                            if (manager.active && manager.active.viewer)
                                selectText(manager.active.viewer);
                        }
                    }
                ]);
            inputMenu.popup({ window: remote.getCurrentWindow() });
        });
        _viewers[data.file] = p;
        loadContents(p);
        if (add) {
            manager.addPanels([p], dock);
        }
        return p;
    }

    function loadContents(p) {
        if (path.extname(p.file) === '.htm' || path.extname(p.file) === '.html') {
            p.viewer.classList.add('html-viewer');
            p.viewer.innerHTML = fs.readFileSync(p.file, 'utf8');
            var style = p.viewer.querySelectorAll('style');
            var s = style.length;
            while (s--)
                p.viewer.removeChild(style[s]);
        }
        else if (path.extname(p.file) === '.txt') {
            p.viewer.classList.add('text-viewer');
            var contents = '';
            p.displayFunction = () => {
                display.removeListener('parse-done', p.displayFunction);
                display.removeListener('add-line-done', p.displayAdd);
                p.viewer.innerHTML = contents;
            };
            p.displayAdd = (data) => {
                contents += createLine(data.line, data.formats);
            };
            display.on('parse-done', p.displayFunction);
            display.on('add-line-done', p.displayAdd);
            display.append(fs.readFileSync(p.file, 'utf8'));
        }
    }

    function createLine(text, formats) {
        const parts = [];
        let offset = 0;
        let style = [];
        let fCls;
        const len = formats.length;

        for (let f = 0; f < len; f++) {
            const format = formats[f];
            let nFormat;
            let end;
            const td = [];
            //let oSize;
            //let oFont;
            if (f < len - 1) {
                nFormat = formats[f + 1];
                //skip empty blocks
                if (format.offset === nFormat.offset && nFormat.formatType === format.formatType)
                    continue;
                end = nFormat.offset;
            }
            else
                end = text.length;
            offset = format.offset;
            if (format.formatType === FormatType.Normal) {
                style = [];
                fCls = [];
                if (format.background)
                    style.push('background:', format.background, ';');
                if (format.color)
                    style.push('color:', format.color, ';');
                if (format.font)
                    style.push('font-family: ', format.font, ';');
                if (format.size)
                    style.push('font-size: ', format.size, ';');
                if (format.style !== FontStyle.None) {
                    if ((format.style & FontStyle.Bold) === FontStyle.Bold)
                        style.push('font-weight: bold;');
                    if ((format.style & FontStyle.Italic) === FontStyle.Italic)
                        style.push('font-style: italic;');
                    if ((format.style & FontStyle.Overline) === FontStyle.Overline)
                        td.push('overline ');
                    if ((format.style & FontStyle.DoubleUnderline) === FontStyle.DoubleUnderline || (format.style & FontStyle.Underline) === FontStyle.Underline)
                        td.push('underline ');
                    if ((format.style & FontStyle.DoubleUnderline) === FontStyle.DoubleUnderline)
                        style.push('border-bottom: 1px solid ', format.color, ';');
                    else
                        style.push('padding-bottom: 1px;');
                    if ((format.style & FontStyle.Rapid) === FontStyle.Rapid || (format.style & FontStyle.Slow) === FontStyle.Slow) {
                        if (this.enableFlashing)
                            fCls.push(' ansi-blink');
                        else if ((format.style & FontStyle.DoubleUnderline) !== FontStyle.DoubleUnderline && (format.style & FontStyle.Underline) !== FontStyle.Underline)
                            td.push('underline ');
                    }
                    if ((format.style & FontStyle.Strikeout) === FontStyle.Strikeout)
                        td.push('line-through ');
                    if (td.length > 0)
                        style.push('text-decoration:', td.join(''), ';');
                }
                if (format.hr)
                    parts.push('<span style="', style.join(''), '" class="ansi', fCls.join(''), '"><div class="hr" style="background-color:', format.color, '"></div></span>');
                else
                    parts.push('<span style="', style.join(''), '" class="ansi', fCls.join(''), '">', htmlEncode(text.substring(offset, end)), '</span>');
            }
            else if (format.formatType === FormatType.Link) {
                parts.push('<a draggable="false" class="URLLink" href="javascript:void(0);" title="');
                parts.push(format.href);
                parts.push('" onclick="', this.linkFunction, '(\'', format.href, '\');return false;">');
                parts.push('<span style="', style.join(''), '" class="ansi', fCls.join(''), '">');
                parts.push(htmlEncode(text.substring(offset, end)));
                parts.push('</span>');
            }
            else if (format.formatType === FormatType.LinkEnd || format.formatType === FormatType.MXPLinkEnd || format.formatType === FormatType.MXPSendEnd) {
                parts.push('</a>');
            }
            else if (format.formatType === FormatType.WordBreak)
                parts.push('<wbr>');
            else if (format.formatType === FormatType.MXPLink) {
                parts.push('<a draggable="false" class="MXPLink" href="javascript:void(0);" title="');
                parts.push(format.href);
                parts.push('"');
                parts.push('onclick="', this.mxpLinkFunction, '(this, \'', format.href, '\');return false;">');
                parts.push('<span style="', style.join(''), '" class="ansi', fCls.join(''), '">');
                parts.push(htmlEncode(text.substring(offset, end)));
                parts.push('</span>');
            }
            else if (format.formatType === FormatType.MXPSend) {
                parts.push('<a draggable="false" class="MXPLink" href="javascript:void(0);" title="');
                parts.push(format.hint);
                parts.push('"');
                parts.push(' onmouseover="', this.mxpTooltipFunction, '(this);"');
                parts.push(' onclick="', this.mxpSendFunction, '(event||window.event, this, ', format.href, ', ', format.prompt ? 1 : 0, ', ', format.tt, ');return false;">');
                parts.push('<span style="', style.join(''), '" class="ansi', fCls.join(''), '">');
                parts.push(htmlEncode(text.substring(offset, end)));
                parts.push('</span>');
            }
            else if (format.formatType === FormatType.MXPExpired) {
                parts.push('<span style="', style.join(''), '" class="ansi', fCls.join(''), '">');
                parts.push(htmlEncode(text.substring(offset, end)));
                parts.push('</span>');
            }
            //TODO add image
            //TODO once supported update parser support tag to add image
        }
        return `<span class="line">${parts.join('')}<br></span>`;
    }

    function htmlEncode(text) {
        if (!text || text.length === 0)
            return;
        return text
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }

    function closeFile(panel) {
        if (!panel) {
            if (!manager.active)
                return;
            panel = manager.active;
        }
        if (panel)
            manager.removePanel(panel);
        if (manager.active)
            manager.active.viewer.focus();
    }

    function closeAllFiles() {
        manager.removeAllPanels();
    }

    function doCopy() {
        if (manager.active && manager.active.viewer) {
            var text = getSelectionText() || '';
            clipboard.writeText(text);
            clipboard.writeText(text);
        }
        if (manager.active && manager.active.viewer) manager.active.viewer.focus();
    }

    function doFind() {
        if (manager.active && manager.active.editor && manager.active.editor.supports('find'))
            manager.active.editor.find();
    }

    function doRefresh() {
        if (manager.active && manager.active.viewer)
            loadContents(manager.active);
        if (manager.active && manager.active.viewer) manager.active.viewer.focus();
    }

    function doUpdate(type) {
        if (!type) return;
        _updating |= type;
        if (_updating === 0)
            return;
        window.requestAnimationFrame(() => {
            if ((_updating & 1) === 1) {
                updateUI();
                _updating &= ~1;
            }
            if ((_updating & 2) === 2) {
                updateUIChange();
                _updating &= ~2;
            }
            if ((_updating & 4) === 4) {
                buildRecent();
                _updating &= ~4;
            }
            if ((_updating & 8) === 8) {
                flushRecent();
                _updating &= ~8;
            }
            if ((_updating & 16) === 16) {
                saveOptions();
                _updating &= ~16;
            }
            doUpdate(_updating);
        });
    }

    function savedOpened() {
        var opened = [];

        var panes = manager.panes;
        var s = panes.length;
        while (s--) {
            var panels = manager.panes[s].panels;
            var k = panels.length;
            var p;
            opened[s] = [];
            while (k--)
                opened[s].unshift(panels[k].file);
        }
        if (!options) loadOptions();
        if (options.reopen)
            options.opened = opened;
        else
            options.opened = [];
        options.layout = manager.layout;
        saveOptions();
        return true;
    }

    // eslint-disable-next-line no-unused-vars
    function closeHidden() {
        var dialogs = document.body.getElementsByTagName("dialog");
        var e = 0, el = dialogs.length;
        for (; e < el; e++) {
            if (dialogs[e].open) {
                if (dialog.showMessageBox(
                    remote.getCurrentWindow(),
                    {
                        type: 'question',
                        title: 'Open dialog',
                        message: (dialogs[e].dataset.title || 'Dialog') + ' is open, exit?',
                        buttons: ['Yes', 'No'],
                        defaultId: 1
                    }) === 1)
                    return;
            }
        }
        if (!savedOpened())
            return;
        remote.getCurrentWindow().hide();
    }

    // eslint-disable-next-line no-unused-vars
    function closeWindow() {
        remote.getCurrentWindow().close();
    }

    window.onbeforeunload = function (evt) {
        if (!$closeWindow) {
            if (document.activeElement)
                document.activeElement.blur();
            evt.returnValue = false;
            setTimeout(() => {
                var dialogs = document.body.getElementsByTagName("dialog");
                var e = 0, el = dialogs.length;
                for (; e < el; e++) {
                    if (dialogs[e].open) {
                        if (dialog.showMessageBox(
                            remote.getCurrentWindow(),
                            {
                                type: 'question',
                                title: 'Open dialog',
                                message: (dialogs[e].dataset.title || 'Dialog') + ' is open, exit?',
                                buttons: ['Yes', 'No'],
                                defaultId: 1
                            }) === 1)
                            return 'no';
                    }
                }
                if (!savedOpened())
                    return 'no';
                //clean up
                var keys = Object.keys(_viewers);
                var p = keys.length;
                while (p--)
                    closeViewer(_viewers[keys[p]]);
                $closeWindow = true;
                remote.getCurrentWindow().close();
            });
            return 'no';
        }
        $closeWindow = true;
        remote.getCurrentWindow().close();
        return;
    };

    $(document).ready(() => {
        display = new Display(document.getElementById('display'));
        loadOptions();
        document.addEventListener("selectionchange", function () {
            doUpdate(2);
        });

        $('#toolbar').on('click', () => {
            if (manager.active && manager.active.viewer)
                manager.active.viewer.focus();
        });
        if (options.opened.length && Array.isArray(options.opened[0])) {
            manager.layout = options.layout;
            let l = options.opened.length;
            while (l--)
                openFiles(options.opened[l], false, manager.panes[l]);
        }
        else
            openFiles(options.opened);
        doUpdate(4);
        remote.getCurrentWindow().setEnabled(true);
        //menubar.enabled = true;
    });

    ipcRenderer.on('reload-options', () => {
        loadOptions();
    });
</script>

</html>